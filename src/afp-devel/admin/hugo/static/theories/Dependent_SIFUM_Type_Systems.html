<div id="Preliminaries">
<div class="head">
<h1>Theory Preliminaries</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Preliminaries
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="comment1">(* "HOL-Library.Lattice_Syntax" *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Possible modes for variables:›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> Mode <span class="main">=</span> AsmNoReadOrWrite <span class="main">|</span> AsmNoWrite <span class="main">|</span> GuarNoReadOrWrite <span class="main">|</span> GuarNoWrite

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We consider a two-element security lattice:›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> Sec <span class="main">=</span> High <span class="main">|</span> Low


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Sec</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> forms a (complete) lattice:›</span></span>
<span class="keyword1"><span class="command">instantiation</span></span> Sec <span class="main">::</span> <span class="quoted">complete_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> top_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"top <span class="main">=</span> High"</span></span>
<span class="keyword1"><span class="command">definition</span></span> sup_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"sup <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> High <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> High<span class="main">)</span> <span class="keyword1">then</span> High <span class="keyword1">else</span> Low<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> inf_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"inf <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> Low<span class="main">)</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> bot_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"bot <span class="main">=</span> Low"</span></span>
<span class="keyword1"><span class="command">definition</span></span> less_eq_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> Low<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> less_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> Low <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> High<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> Sup_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>High <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">then</span> High <span class="keyword1">else</span> Low<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> Inf_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>Low <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">using</span></span> Sec.exhaust less_Sec_def less_eq_Sec_def inf_Sec_def sup_Sec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>10<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inf_Sec_def Sec.exhaust less_eq_Sec_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inf_Sec_def Sec.exhaust less_eq_Sec_def<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> Sec.exhaust less_Sec_def less_eq_Sec_def inf_Sec_def sup_Sec_def Inf_Sec_def Sup_Sec_def top_Sec_def bot_Sec_def 
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Memories are mappings from variables to values›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> Mem <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'val</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A mode state maps modes to the set of variables for which the
  given mode is set.›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'var</span> Mds <span class="main">=</span> <span class="quoted"><span class="quoted">"Mode <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Local configurations:›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'com</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> LocalConf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'com</span> <span class="main">×</span> <span class="tfree">'var</span> Mds<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> Mem"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Global configurations:›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'com</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> GlobalConf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'com</span> <span class="main">×</span> <span class="tfree">'var</span> Mds<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> Mem"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A locale to fix various parametric components in Mantel et. al, and assumptions
  about them:›</span></span>
<span class="keyword1"><span class="command">locale</span></span> sifum_security_init <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒞_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> set"</span></span> <span class="comment1">(* classification control variables *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">some_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">INIT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval</span><span class="main">;</span> <span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc''</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">lc'</span> <span class="main">=</span> <span class="free">lc''</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_memory<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'Var</span><span class="main">)</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒞</span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="free">𝒞_vars</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 𝒞_vars_𝒞<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">⟹</span> <span class="free">𝒞_vars</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dma_𝒞_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞_vars</span> <span class="free">y</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">y</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 𝒞_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">dma</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> Low"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_security <span class="main">=</span> sifum_security_init <span class="quoted"><span class="free">dma</span></span> <span class="quoted"><span class="free">𝒞_vars</span></span> <span class="quoted"><span class="free">𝒞</span></span> <span class="quoted"><span class="free">eval</span></span> <span class="quoted"><span class="free">some_val</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>True"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒞_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> set"</span></span> <span class="comment1">(* classification control variables *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">some_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Val</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_security_init <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Preliminaries-𝒞_vars_subset_𝒞"><span class="command">lemma</span></span> 𝒞_vars_subset_𝒞<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="free">x</span> <span class="main">⊆</span> <span class="free">𝒞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_def<span class="main">)</span>

<span class="keyword1" id="Preliminaries-dma_𝒞"><span class="command">lemma</span></span> dma_𝒞<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞_vars</span> <span class="skolem">y</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_subset_𝒞 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* induction tools, moved up as far as possible *)</span>

<span class="keyword1" id="Preliminaries-my_trancl_induct"><span class="command">lemma</span></span> my_trancl_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">;</span> 
    <span class="free">P</span> <span class="free">a</span> <span class="main">;</span> 
   <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  
<span class="keyword1" id="Preliminaries-my_trancl_step_induct"><span class="command">lemma</span></span> my_trancl_step_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">;</span> 
   <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  
<span class="keyword1" id="Preliminaries-my_trancl_big_step_induct"><span class="command">lemma</span></span> my_trancl_big_step_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">;</span> 
   <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> my_trancl_step_induct3 <span class="main">=</span> 
  my_trancl_step_induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">ax</span><span class="main">,</span><span class="free">ay</span><span class="main">)</span><span class="main">,</span> <span class="free">az</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">bx</span><span class="main">,</span><span class="free">by</span><span class="main">)</span><span class="main">,</span> <span class="free">bz</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">split_format</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">,</span>
                 <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> step<span class="main">]</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> my_trancl_big_step_induct3 <span class="main">=</span> 
  my_trancl_big_step_induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">ax</span><span class="main">,</span><span class="free">ay</span><span class="main">)</span><span class="main">,</span> <span class="free">az</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">bx</span><span class="main">,</span><span class="free">by</span><span class="main">)</span><span class="main">,</span> <span class="free">bz</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">split_format</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">,</span>
                 <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Security">
<div class="head">
<h1>Theory Security</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definition of the SIFUM-Security Property›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Security
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Preliminaries.html">Preliminaries</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> adaptation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'val</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_adaptation</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">apply_adaptation</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span>
         <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">of</span>
               Some <span class="main">(</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="keyword1">then</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span>
             <span class="main">|</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apply_adaptation<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">[∥<span class="hidden">⇩</span><sub>1</sub></span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>900<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main"><span class="free">[∥<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">≡</span> apply_adaptation True <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apply_adaptation<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">[∥<span class="hidden">⇩</span><sub>2</sub></span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>900<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main"><span class="free">[∥<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">≡</span> apply_adaptation False <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">var_asm_not_written</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">var_asm_not_written</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite"</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_security_init <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation of Concurrent Programs›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eval_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">conf_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> LocalConf"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">,</span> _<span class="keyword1">,</span> _<span class="keyword1">⟩</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main"><span class="free">⟩</span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Labelled evaluation global configurations: *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">meval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">×</span> nat <span class="main">×</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> GlobalConf<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">meval_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↝⇘</span>_<span class="keyword1">⇙</span> _"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">conf</span></span></span> ↝<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">k</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">conf'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conf'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">meval</span>"</span></span> <span class="main">|</span>
  meval_intro <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cm'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cms</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">cm'</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">meval</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> meval_elim <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="free">k</span><span class="main">,</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> meval"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">neval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↝⇗</span>_<span class="keyword1">⇖</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  neval_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> ↝<span class="hidden">⇗</span><sup><span class="main">0</span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  neval_S_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> ↝<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">n</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> ↝<span class="hidden">⇗</span><sup>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> neval_ZeroE<span class="main">:</span> <span class="quoted"><span class="quoted">"neval <span class="free">x</span> <span class="main">0</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> neval_SucE<span class="main">:</span> <span class="quoted"><span class="quoted">"neval <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">y</span>"</span></span>

<span class="keyword1" id="Security-neval_det"><span class="command">lemma</span></span> neval_det<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> ↝<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> ↝<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span> <span class="free">y'</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> neval.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> neval_ZeroE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> neval_SucE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Security-neval_Suc_simp"><span class="command">lemma</span></span> neval_Suc_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"neval <span class="free">x</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">↝</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"neval <span class="free">x</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> neval <span class="free">x</span> <span class="bound">n</span> <span class="free">y</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">↝</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"neval <span class="free">x</span> <span class="skolem">n</span> <span class="free">y</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">↝</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> neval.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> neval_ZeroE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">↝</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">↝</span> <span class="free">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"neval <span class="free">x</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> neval.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">lc_set_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Val</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lc_set_var</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">meval_sched</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meval_sched</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">meval_sched</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c''</span><span class="main">.</span>  <span class="free"><span class="bound"><span class="entity">c</span></span></span> ↝<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="bound">c''</span> <span class="main">∧</span> <span class="free">meval_sched</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="bound">c''</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">meval_sched_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→⇘</span>_<span class="keyword1">⇙</span> _"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">ns</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> meval_sched <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span>"</span></span>

<span class="keyword1" id="Security-meval_sched_det"><span class="command">lemma</span></span> meval_sched_det<span class="main">:</span>
  <span class="quoted"><span class="quoted">"meval_sched <span class="free">ns</span> <span class="free">c</span> <span class="free">c'</span> <span class="main">⟹</span> meval_sched <span class="free">ns</span> <span class="free">c</span> <span class="free">c''</span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Low-equivalence and Strong Low Bisimulations›</span></span>

<span class="comment1">(* Low-equality between memory states: *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">low_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span>"</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇧</span><sup>l</sup></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>


<span class="comment1">(* Low-equality modulo a given mode state: *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">low_mds_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">=</span>ı<span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">=</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="free"><span class="hidden">⇧</span><sup>l</sup></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Security-low_eq_low_mds_eq"><span class="command">lemma</span></span> low_eq_low_mds_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_eq_def low_mds_eq_def<span class="main">)</span>

<span class="keyword1" id="Security-low_mds_eq_dma"><span class="command">lemma</span></span> low_mds_eq_dma<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_def 𝒞_Low<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Security-low_mds_eq_sym"><span class="command">lemma</span></span> low_mds_eq_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> low_mds_eq_dma<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Security-low_eq_sym"><span class="command">lemma</span></span> low_eq_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_eq_low_mds_eq low_mds_eq_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem'</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_def low_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">mds</span><span class="main">.</span> <span class="free">mem</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="bound">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def low_eq_def<span class="main">)</span>

<span class="keyword1" id="Security-High_not_in_𝒞"><span class="command">lemma</span></span> High_not_in_𝒞 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> High <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒞_Low<span class="main">)</span>

<span class="comment1">(* Closedness under globally consistent changes: *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">closed_glob_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf<span class="main">)</span> rel <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closed_glob_consistent</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">⟶</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">A</span> <span class="bound">x</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∨</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="bound">mds</span> <span class="bound">x</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="bound">mds</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="bound">mds</span> AsmNoReadOrWrite <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span><span class="main">]</span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">A</span><span class="main">]</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Strong low bisimulations modulo modes: *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">strong_low_bisim_mm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf<span class="main">)</span> rel <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strong_low_bisim_mm</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">≡</span>
  sym <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">∧</span>
  closed_glob_consistent <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">⟶</span>
   <span class="main">(</span><span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="bound">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">mds'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟩</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span> <span class="main">∧</span>
                  <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">mm_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf<span class="main">)</span> rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">mm_equiv_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> 
  <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mm_equiv_abv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">mm_equiv</span>"</span></span> <span class="main">|</span>
  mm_equiv_intro <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> strong_low_bisim_mm <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">mm_equiv</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> mm_equiv_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">low_indistinguishable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Com</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∼</span>ı _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">∼</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹SIFUM-Security›</span></span>

<span class="comment1">(* SIFUM-security for commands: *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">com_sifum_secure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">×</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">com_sifum_secure</span> <span class="free"><span class="bound"><span class="entity">cmd</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cmd</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">mds<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">c</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="bound">mds<span class="hidden">⇩</span><sub>s</sub></span></sub><span class="hidden">⇙</span> <span class="bound">c</span>"</span></span>

<span class="comment1">(* Continuous SIFUM-security 
   (where we don't care about whether the prog has any assumptions at termination *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">prog_sifum_secure_cont</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span> <span class="main">×</span> <span class="tfree">'Var</span> Mds<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prog_sifum_secure_cont</span> <span class="free"><span class="bound"><span class="entity">cmds</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">INIT</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">INIT</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">sched</span> <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cmds</span></span></span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="bound">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cmds</span></span></span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="bound">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                      map snd <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
                      length <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> length <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span>
                      <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span>
                        <span class="bound">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoReadOrWrite<span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Note that it is equivalent to the following because the 
   programming language is deterministic *)</span>
<span class="keyword1" id="Security-prog_sifum_secure_cont_def2"><span class="command">lemma</span></span> prog_sifum_secure_cont_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prog_sifum_secure_cont <span class="free">cmds</span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">INIT</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">INIT</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">sched</span> <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span>
     <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="bound">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="bound">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="bound">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">⟶</span>
                      map snd <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
                      length <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> length <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span>
                      <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span>
                        <span class="bound">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoReadOrWrite<span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_reflection<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> prog_sifum_secure_cont_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> meval_sched_det<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sound Mode Use›</span></span>


<span class="comment1">(* Suggestive notation for substitution / function application *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="keyword1">of</span>
                         None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="bound">x</span> <span class="main">|</span>
                         Some <span class="bound">v</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">subst_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">[↦</span>_<span class="keyword1">]</span>"</span> <span class="main">[</span>900<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">[↦</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">≡</span> subst <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="Security-subst_not_in_dom"><span class="command">lemma</span></span> subst_not_in_dom <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∉</span> dom <span class="free">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff subst_def<span class="main">)</span>

<span class="comment1">(* Toby: we restrict not reading to also imply not modifying a variable.
         This is done mostly to simplify part of the reasoning in the
         Compositionality theory, but also because reconciling doesnt_read_or_modify
         forcing also not reading the variable's classification in the case
         in the case where it would allow non-reading modifications proved
         to get too unwieldy *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">doesnt_read_or_modify_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doesnt_read_or_modify_vars</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">mds</span> <span class="bound">mem</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span><span class="main">.</span>
  <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">⟩</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem</span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vars_𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> set <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_𝒞</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="free">𝒞_vars</span> <span class="bound">x</span>"</span></span>

<span class="keyword1" id="Security-vars_𝒞_subset_𝒞"><span class="command">lemma</span></span> vars_𝒞_subset_𝒞<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_𝒞 <span class="free">X</span> <span class="main">⊆</span> <span class="free">𝒞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_def vars_𝒞_def<span class="main">)</span>

<span class="comment1">(* Toby: doesnt_read_or_modify now implies that the classification is not read too *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">doesnt_read_or_modify</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doesnt_read_or_modify</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> doesnt_read_or_modify_vars <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">𝒞_vars</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">doesnt_modify</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doesnt_modify</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">mds</span> <span class="bound">mem</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">⟶</span>
                        <span class="bound">mem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">mem'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>  <span class="free">dma</span> <span class="bound">mem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">dma</span> <span class="bound">mem'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Security-noread_nowrite"><span class="command">lemma</span></span> noread_nowrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> noread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> noread <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">mem</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">mem</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">mem</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> step this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem'</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">mem</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem'</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">mem</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Toby: not sure whether this implication should just be made explicit in the
         definition of doesnt_read_or_modify or not *)</span>
<span class="keyword1" id="Security-doesnt_read_or_modify_doesnt_modify"><span class="command">lemma</span></span> doesnt_read_or_modify_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="free">c</span> <span class="free">x</span> <span class="main">⟹</span> doesnt_modify <span class="free">c</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_modify_def doesnt_read_or_modify_def doesnt_read_or_modify_vars_def 
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> noread_nowrite dma_𝒞_vars<span class="main">)</span>

<span class="comment1">(* Local reachability of local configurations: *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">loc_reach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">lc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  refl <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>fst <span class="main">(</span>fst <span class="free">lc</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>fst <span class="free">lc</span><span class="main">)</span><span class="main">,</span> snd <span class="free">lc</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span>"</span></span> <span class="main">|</span>
  step <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span><span class="main">;</span>
            <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
          <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span>"</span></span> <span class="main">|</span>
  mem_diff <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> <span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span><span class="main">;</span>
                <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> var_asm_not_written <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
              <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span> <span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span>"</span></span>

<span class="keyword1" id="Security-neval_loc_reach"><span class="command">lemma</span></span> neval_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"neval <span class="free">lc'</span> <span class="free">n</span> <span class="free">lc''</span> <span class="main">⟹</span> <span class="free">lc'</span> <span class="main">∈</span> loc_reach <span class="free">lc</span> <span class="main">⟹</span> <span class="free">lc''</span> <span class="main">∈</span> loc_reach <span class="free">lc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> neval.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>neval_0 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>neval_S_n <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">n</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> loc_reach <span class="free">lc</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">↝</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> loc_reach <span class="free">lc</span>"</span></span> 
    <span class="comment1">(* TODO: can we get rid of this case_tac nonsense? *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> a b<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> c d<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> loc_reach.step<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> neval_S_n<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
    

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">locally_sound_mode_use</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_sound_mode_use</span> <span class="free"><span class="bound"><span class="entity">lc</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span><span class="main">.</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="free"><span class="bound"><span class="entity">lc</span></span></span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="bound">c'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="bound">c'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* RobS: The same property, but for an individual evaluation. Note it doesn't rely on mem! *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">respects_own_guarantees</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span> <span class="main">×</span> <span class="tfree">'Var</span> Mds<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">respects_own_guarantees</span> <span class="free"><span class="bound"><span class="entity">cm</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">)</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">)</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Security-locally_sound_mode_use_def2"><span class="command">lemma</span></span> locally_sound_mode_use_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="free">lc</span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">lc'</span> <span class="main">∈</span> loc_reach <span class="free">lc</span><span class="main">.</span> respects_own_guarantees <span class="main">(</span>fst <span class="bound">lc'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_reflection<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def respects_own_guarantees_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Security-locally_sound_respects_guarantees"><span class="command">lemma</span></span> locally_sound_respects_guarantees<span class="main">:</span>
  <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">(</span><span class="free">cm</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">⟹</span> respects_own_guarantees <span class="free">cm</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def respects_own_guarantees_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv loc_reach.refl<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">compatible_modes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span> Mds<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compatible_modes</span> <span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoReadOrWrite <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">mdss</span></span></span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> GuarNoReadOrWrite<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoWrite <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">mdss</span></span></span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> GuarNoWrite<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">reachable_mode_states</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span> Mds<span class="main">)</span> list<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">reachable_mode_states</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">≡</span>
     <span class="main">{</span><span class="bound">mdss</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">cms'</span> <span class="bound">mem'</span> <span class="bound">sched</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> →<span class="hidden">⇘</span><sub><span class="bound">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms'</span><span class="main">,</span> <span class="bound">mem'</span><span class="main">)</span> <span class="main">∧</span> map snd <span class="bound">cms'</span> <span class="main">=</span> <span class="bound">mdss</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">globally_sound_mode_use</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">globally_sound_mode_use</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound">mdss</span><span class="main">.</span> <span class="bound">mdss</span> <span class="main">∈</span> reachable_mode_states <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">⟶</span> compatible_modes <span class="bound">mdss</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> 
  <span class="entity">sound_mode_use</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sound_mode_use</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">cm</span><span class="main">.</span> locally_sound_mode_use <span class="main">(</span><span class="bound">cm</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cms</span></span></span> <span class="main">∧</span>
      globally_sound_mode_use <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* We now show that mm_equiv itself forms a strong low bisimulation modulo modes: *)</span>
<span class="keyword1" id="Security-mm_equiv_sym"><span class="command">lemma</span></span> mm_equiv_sym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> equivalent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> equivalent <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ℛ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ℛ_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="skolem">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mm_equiv.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sym <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ_bisim symE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ_bisim mm_equiv.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Security-low_indistinguishable_sym"><span class="command">lemma</span></span> low_indistinguishable_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span> <span class="free">lc'</span> <span class="main">⟹</span> <span class="free">lc'</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span> <span class="free">lc</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_indistinguishable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mm_equiv_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> low_mds_eq_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Security-mm_equiv_glob_consistent"><span class="command">lemma</span></span> mm_equiv_glob_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_glob_consistent mm_equiv"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> mm_equiv_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def closed_glob_consistent_def<span class="main">)</span>

<span class="keyword1" id="Security-mm_equiv_strong_low_bisim"><span class="command">lemma</span></span> mm_equiv_strong_low_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm mm_equiv"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_glob_consistent mm_equiv"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mm_equiv_glob_consistent<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ℛ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="skolem">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'Com</span></span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ℛ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="skolem">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mm_equiv_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="var">?lc<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span> <span class="main">∧</span> <span class="var">?lc<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def mm_equiv_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym mm_equiv"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sym_def mm_equiv_sym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Compositionality">
<div class="head">
<h1>Theory Compositionality</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Compositionality Proof for SIFUM-Security Property›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Compositionality
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Security.html">Security</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_security_init
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Set of variables that differs between two memory states: *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">differing_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">differing_vars</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">differing_vars_lists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">⇒</span> 
                           <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">×</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">differing_vars_lists</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
     <span class="main">(</span>differing_vars <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> differing_vars <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-differing_finite"><span class="command">lemma</span></span> differing_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>differing_vars <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_def Un_UNIV_left finite_Un finite_memory<span class="main">)</span>

<span class="keyword1" id="Compositionality-differing_lists_finite"><span class="command">lemma</span></span> differing_lists_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> differing_finite differing_vars_lists_def<span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">makes_compatible</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span>
   <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span>
   <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">×</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem<span class="main">)</span> list <span class="main">⇒</span>
  bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">makes_compatible</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">=</span>
  <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> differing_vars_lists <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="bound">i</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span>
             <span class="bound">x</span> <span class="main">∉</span> differing_vars_lists <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span>
                                          <span class="bound">x</span> <span class="main">∉</span> differing_vars_lists <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* This just restates the previous definition using meta-quantification. This allows
  more readable proof blocks that prove each part separately. *)</span>
<span class="keyword1" id="Compositionality-makes_compatible_intro"><span class="command">lemma</span></span> makes_compatible_intro <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">mems</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> dom <span class="bound">σ</span> <span class="main">=</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span> <span class="main">⟧</span> <span class="main">⟹</span>
          <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">⟧</span> <span class="main">⟹</span> 
          <span class="bound">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span>length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
  makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* First, some auxiliary lemmas about makes_compatible: *)</span>
<span class="keyword1" id="Compositionality-compat_low"><span class="command">lemma</span></span> compat_low<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span><span class="main">;</span>
     <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
     <span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> High <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-compat_different"><span class="command">lemma</span></span> compat_different<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span><span class="main">;</span>
     <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
     <span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Compositionality-sound_modes_no_read"><span class="command">lemma</span></span> sound_modes_no_read <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sound_mode_use <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>map snd <span class="free">cms</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> GuarNoReadOrWrite<span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms</span> <span class="main">⟧</span> <span class="main">⟹</span>
  doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cms</span> <span class="skolem">mem</span> <span class="skolem">x</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="skolem">cms</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">cms</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">(</span><span class="skolem">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sound_mode_use_def list_all_length<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>map snd <span class="skolem">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> GuarNoReadOrWrite"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="skolem">cms</span> <span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">cms</span>›</span></span> <span class="quoted"><span class="quoted">‹locally_sound_mode_use <span class="main">(</span><span class="skolem">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">)</span>›</span></span> locally_sound_respects_guarantees respects_own_guarantees_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-differing_vars_neg"><span class="command">lemma</span></span> differing_vars_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem1</span> <span class="free">mem2</span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟹</span>
  <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem1</span> <span class="free">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-differing_vars_neg_intro"><span class="command">lemma</span></span> differing_vars_neg_intro<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">;</span>
  <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-differing_vars_elim"><span class="command">lemma</span></span> differing_vars_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟹</span>
  <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-makes_compatible_dma_eq"><span class="command">lemma</span></span> makes_compatible_dma_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">σ</span> <span class="main">=</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> compat ile <span class="keyword1"><span class="command">have</span></span> notin_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> domσ<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> subst_not_in_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> notin_diff differing_vars_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-compat_different_vars"><span class="command">lemma</span></span> compat_different_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">;</span>
     <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-differing_vars_subst"><span class="command">lemma</span></span> differing_vars_subst <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">σ</span> <span class="main">⊇</span> differing_vars <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> domσ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_def differing_vars_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-mm_equiv_low_eq"><span class="command">lemma</span></span> mm_equiv_low_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mm_equiv.simps strong_low_bisim_mm_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Compositionality-globally_sound_modes_compatible"><span class="command">lemma</span></span> globally_sound_modes_compatible<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> globally_sound_mode_use <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> compatible_modes <span class="main">(</span>map snd <span class="free">cms</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> globally_sound_mode_use_def reachable_mode_states_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> meval_sched.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* map snd cms1 = map snd cms2 states that both global configurations use the same modes *)</span>
<span class="keyword1" id="Compositionality-compatible_different_no_read"><span class="command">lemma</span></span> compatible_different_no_read <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
                       <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> compat <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> compat ile x <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_low<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> compat ile x <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_different<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> compat ile x <span class="keyword1"><span class="command">have</span></span> not_in_𝒞<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_different<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword2"><span class="keyword">and</span></span> compat ile x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    jprop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="free">some_val</span> <span class="keyword1">else</span> None"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ</span> <span class="main">=</span> <span class="var">?X<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mdss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> jprop domσ <span class="keyword1"><span class="command">have</span></span> subst_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="free">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_not_in_dom<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> compat jprop domσ
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> low_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">j</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> modes_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> jprop len mm_equiv_low_eq nth_map surjective_pairing<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> jprop <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> AsmNoReadOrWrite"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">(</span><span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> AsmNoReadOrWrite"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mems_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> Low›</span></span> low_eq subst_eq
        makes_compatible_dma_eq<span class="main">[</span><span class="operator">OF</span> compat jprop<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span> domσ<span class="main">]</span>
        low_mds_eq_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_different_vars jprop<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?mdss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> GuarNoReadOrWrite"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sound_modes jprop
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compatible_modes_def globally_sound_modes_compatible
      length_map sound_mode_use.simps x ile<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sound_modes ile
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> len modes_eq sound_modes_no_read<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vars_and_𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> set <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_and_𝒞</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∪</span> vars_𝒞 <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="comment1">(* Toby: most of the complexity drops out as doesnt_read_or_modify now implies doesnt_modify *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">change_respecting</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
   <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
   <span class="tfree">'Var</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">change_respecting</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> vars_and_𝒞 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-subst_overrides"><span class="command">lemma</span></span> subst_overrides<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">σ</span> <span class="main">=</span> dom <span class="free">τ</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="free">τ</span><span class="main">]</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff option.exhaust option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_partial</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_partial</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-dom_restrict_total"><span class="command">lemma</span></span> dom_restrict_total<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>to_partial <span class="free">f</span> <span class="main">|`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> to_partial_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_UNIV_left dom_const dom_restrict<span class="main">)</span>

<span class="keyword1" id="Compositionality-change_respecting_doesnt_modify'"><span class="command">lemma</span></span> change_respecting_doesnt_modify'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">f</span><span class="main">.</span> dom <span class="bound">f</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="bound">f</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="bound">f</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"to_partial <span class="free">mem</span> <span class="main">|`</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> domf'<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="var">?f'</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> this cr <span class="keyword1"><span class="command">have</span></span> eval'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> subst_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> restrict_in to_partial_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domf' subst_def subst_not_in_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval eval' deterministic
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> x_in_dom'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dom <span class="var">?f'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x_in_dom dom_restrict_total<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">mem</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrict_in to_partial_def x_in_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_def x_in_dom'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem'_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-change_respecting_subset'"><span class="command">lemma</span></span> change_respecting_subset'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> noread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dom_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">σ</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ<span class="hidden">⇩</span><sub>X</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> dom <span class="free">σ</span> <span class="keyword1">then</span> <span class="free">σ</span> <span class="skolem">x</span> <span class="keyword1">else</span> Some <span class="main">(</span><span class="free">mem</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dom_subset <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ<span class="hidden">⇩</span><sub>X</sub>_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dom_subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def σ<span class="hidden">⇩</span><sub>X</sub>_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dom_subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def σ<span class="hidden">⇩</span><sub>X</sub>_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change_respecting_doesnt_modify'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step noread<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> noread <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1" id="Compositionality-change_respecting_subst"><span class="command">lemma</span></span> change_respecting_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="free">X</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps vars_and_𝒞_def
  <span class="keyword1"><span class="command">using</span></span> change_respecting_subset' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 
<span class="keyword1" id="Compositionality-change_respecting_intro"><span class="command">lemma</span></span> change_respecting_intro <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">⟩</span><span class="main">;</span>
     <span class="main">⋀</span> <span class="bound">f</span><span class="main">.</span> dom <span class="bound">f</span> <span class="main">=</span> vars_and_𝒞 <span class="free">X</span> <span class="main">⟹</span>
           <span class="main">(</span><span class="main">⟨</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="bound">f</span><span class="main">]</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="bound">f</span><span class="main">]</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Compositionality-vars_𝒞_mono"><span class="command">lemma</span></span> vars_𝒞_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> vars_𝒞 <span class="free">X</span> <span class="main">⊆</span> vars_𝒞 <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_𝒞_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-vars_𝒞_Un"><span class="command">lemma</span></span> vars_𝒞_Un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_𝒞 <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vars_𝒞 <span class="free">X</span> <span class="main">∪</span> vars_𝒞 <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_𝒞_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-vars_𝒞_insert"><span class="command">lemma</span></span> vars_𝒞_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_𝒞 <span class="main">(</span>insert <span class="free">x</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vars_𝒞 <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>vars_𝒞 <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> insert_is_Un<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> vars_𝒞_Un<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Compositionality-vars_𝒞_empty"><span class="command">lemma</span></span> vars_𝒞_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_𝒞 <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_𝒞_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-𝒞_vars_of_𝒞_vars_empty"><span class="command">lemma</span></span> 𝒞_vars_of_𝒞_vars_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">𝒞_vars</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 𝒞_vars_subset_𝒞<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> 𝒞_vars_𝒞<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Compositionality-vars_and_𝒞_mono"><span class="command">lemma</span></span> vars_and_𝒞_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">X'</span> <span class="main">⟹</span> vars_and_𝒞 <span class="free">X</span> <span class="main">⊆</span> vars_and_𝒞 <span class="free">X'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> vars_and_𝒞_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> Un_mono vars_𝒞_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Compositionality-𝒞_vars_finite"><span class="command">lemma</span></span> 𝒞_vars_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">𝒞_vars</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_memory<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Compositionality-finite_dom"><span class="command">lemma</span></span> finite_dom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="main">(</span><span class="free">σ</span><span class="main">::</span><span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Val</span> option<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_memory<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Compositionality-doesnt_read_or_modify_subst"><span class="command">lemma</span></span> doesnt_read_or_modify_subst<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> noread<span class="main">:</span> <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="free">c</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">𝒞_vars</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">⟩</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">X</span>›</span></span> subset 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_subset_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">𝒞_vars</span></span> <span class="free"><span class="free">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> subst <span class="skolem">σ</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> subst <span class="skolem">σ</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">X</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> subst <span class="skolem">σ</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> subst <span class="skolem">σ</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> IH<span class="hidden">⇩</span><sub>X</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> subst <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> subst <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> insert<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict inf.absorb2 subset_insertI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> σa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> <span class="main">(</span>subst <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="bound">mem</span><span class="main">)</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> subst <span class="skolem">σ</span> <span class="bound">mem</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> y<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_def σa<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">X</span>›</span></span> insert <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="main">(</span>subst <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="free">mem</span><span class="main">)</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="main">(</span>subst <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="free">mem'</span><span class="main">)</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> noread <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">𝒞_vars</span> <span class="free">x</span>›</span></span> IH<span class="hidden">⇩</span><sub>X</sub>
        <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-subst_restrict_twice"><span class="command">lemma</span></span> subst_restrict_twice<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">σ</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">⟹</span>
   <span class="free">mem</span> <span class="main">[↦</span> <span class="main">(</span><span class="free">σ</span> <span class="main">|`</span> <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="main">[↦</span> <span class="main">(</span><span class="free">σ</span> <span class="main">|`</span> <span class="free">B</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>

<span class="comment1">(* Toby: this proof is now far simpler because change_respecting is *)</span>
<span class="keyword1" id="Compositionality-noread_exists_change_respecting"><span class="command">lemma</span></span> noread_exists_change_respecting<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">X</span> <span class="main">::</span> <span class="tfree">'Var</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> noread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> doesnt_read_or_modify <span class="free">c</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?lc'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fin eval noread <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mem</span></span> <span class="quoted"><span class="free">mem'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem</span> <span class="main">[↦</span> Map.empty<span class="main">]</span> <span class="main">=</span> <span class="skolem">mem</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem'</span> <span class="main">[↦</span> Map.empty<span class="main">]</span> <span class="main">=</span> <span class="skolem">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> subst_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> empty
      <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps subst_def vars_𝒞_def vars_and_𝒞_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> insertCI insert_disjoint<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">|`</span> vars_and_𝒞 <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ<span class="hidden">⇩</span><sub>x</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">|`</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">𝒞_vars</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> vars_and_𝒞 <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> vars_and_𝒞 <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict inf_absorb2 subset_insertI vars_and_𝒞_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> domσ <span class="keyword1"><span class="command">have</span></span> domσ<span class="hidden">⇩</span><sub>x</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">𝒞_vars</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domσ vars_and_𝒞_def vars_𝒞_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> vars_and_𝒞 <span class="skolem">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">𝒞_vars</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domσ vars_and_𝒞_def vars_𝒞_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> substσ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">mem</span><span class="main">.</span> <span class="bound">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>x</sub></span><span class="main">]</span> <span class="main">=</span> <span class="bound">mem</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> subst_restrict_twice<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="free">c</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> eval<span class="hidden">⇩</span><sub>X</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> vars_and_𝒞 <span class="skolem">X</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>x</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>x</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> subset_refl domσ<span class="hidden">⇩</span><sub>x</sub> doesnt_read_or_modify_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> substσ <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Compositionality-update_nth_eq"><span class="command">lemma</span></span> update_nth_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">;</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_update_id<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This property is obvious,
  so an unreadable apply-style proof is acceptable here:›</span></span>
<span class="keyword1" id="Compositionality-mm_equiv_step"><span class="command">lemma</span></span> mm_equiv_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mm_equiv_strong_low_bisim
  <span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>

<span class="keyword1" id="Compositionality-change_respecting_doesnt_modify"><span class="command">lemma</span></span> change_respecting_doesnt_modify<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cr<span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> vars_𝒞 <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> change_respecting_doesnt_modify'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∪</span> vars_𝒞 <span class="free">X</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> eval<span class="main">]</span> cr     
        change_respecting.simps vars_and_𝒞_def x_in_dom 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Compositionality-change_respecting_doesnt_modify_dma"><span class="command">lemma</span></span> change_respecting_doesnt_modify_dma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cr<span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> vars_𝒞 <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_in_dom <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_𝒞_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">mem'</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cr eval change_respecting_doesnt_modify <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> dma_𝒞_vars<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict_total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span> <span class="comment1">(*infix "|'" 60*)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrict_total</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> to_partial <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">|`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1" id="Compositionality-differing_empty_eq"><span class="command">lemma</span></span> differing_empty_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> differing_vars <span class="free">mem</span> <span class="free">mem'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">=</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> differing_vars_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-adaptation_finite"><span class="command">lemma</span></span> adaptation_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> adaptation<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_memory<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">globally_consistent</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">globally_consistent</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span>  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="bound">x</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-globally_consistent_adapt_bisim"><span class="command">lemma</span></span> globally_consistent_adapt_bisim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> globally_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"globally_consistent <span class="free">A</span> <span class="free">mds</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">A</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mm_equiv_glob_consistent<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> closed_glob_consistent_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bisim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> globally_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> globally_consistent<span class="main">)</span>

<span class="keyword1" id="Compositionality-mm_equiv_𝒞_eq"><span class="command">lemma</span></span> mm_equiv_𝒞_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">a'</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="free">a</span> <span class="main">=</span> snd <span class="free">a'</span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="free">a'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> mm_equiv_strong_low_bisim<span class="main">[</span><span class="operator">simplified</span> strong_low_bisim_mm_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def 𝒞_Low<span class="main">)</span>

<span class="keyword1" id="Compositionality-apply_adaptation_not_in_dom"><span class="command">lemma</span></span> apply_adaptation_not_in_dom<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="free">A</span> <span class="main">⟹</span> apply_adaptation <span class="free">b</span> <span class="free">blah</span> <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> <span class="free">blah</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_adaptation_def domIff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* This is the central lemma. Unfortunately, I didn't find
   a nice partitioning into several easier lemmas: *)</span>
<span class="keyword1" id="Compositionality-makes_compatible_invariant"><span class="command">lemma</span></span> makes_compatible_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
                      <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">mems'</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
       <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
       makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="free">mems'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sound_modes compat modes_eq <span class="keyword1"><span class="command">have</span></span>
    a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?X</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span>
                                          doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compatible_different_no_read<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword1"><span class="command">have</span></span>
    b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">∧</span>
        <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[</span><span class="free">k</span> <span class="main">:=</span> <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meval_elim nth_list_update_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> modes_eq <span class="keyword1"><span class="command">have</span></span> equal_size<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mds<span class="hidden">⇩</span><sub>k</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?X</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_lists_finite<span class="main">)</span>

  <span class="comment1">(* Obtaining cms' and mem<span class="hidden">⇩</span><sub>2</sub>' is not in a proof block, since we
     need some of the following statements later: *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="var">?X</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> noread_exists_change_respecting b a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> compat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟹</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> differing_vars_subst differing_vars_lists_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_upper1 Un_subset_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span>
    eval<span class="hidden">⇩</span><sub>σ</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> change_respecting_subst<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?X</span></span></span> <span class="free"><span class="free"><span class="free">k</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> c<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> b <span class="keyword2"><span class="keyword">and</span></span> compat <span class="keyword1"><span class="command">have</span></span>
    bisim<span class="hidden">⇩</span><sub>σ</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b equal_size modes_eq nth_map<span class="main">)</span>
    
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>f</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>f</sub>'</span><span class="main">.</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>f</sub>'</span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>f</sub>'</span> <span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>f</sub>'</span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>f</sub>'</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mm_equiv_step<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> domh<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">h</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> h_prop<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span><span class="main">)</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">⟩</span> <span class="main">(</span><span class="var">?X</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a b noread_exists_change_respecting
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_lists_finite surjective_pairing<span class="main">)</span>

  <span class="comment1">― ‹The following statements are universally quantified
      since they are reused later:›</span>
  <span class="keyword1"><span class="command">with</span></span> h_prop <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting_subst<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> domh <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_overrides<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> d <span class="keyword2"><span class="keyword">and</span></span> f <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h_prop
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"to_partial <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|`</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> domσ_mem<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> domσ_mem<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword1"><span class="command">unfolding</span></span> to_partial_def subst_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">with</span></span> f domσ_mem<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mem<span class="hidden">⇩</span><sub>2</sub>'_def c<span class="hidden">⇩</span><sub>2</sub>'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[</span><span class="free">k</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">)</span><span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> i b equal_size <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meval_intro<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> equal_size <span class="keyword1"><span class="command">have</span></span> new_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cms<span class="hidden">⇩</span><sub>2</sub>'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval length_list_update meval_elim<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> modes_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cms<span class="hidden">⇩</span><sub>2</sub>'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b map_update snd_conv<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="comment1">― ‹This is the complicated part of the proof.›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mems'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">mems'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="comment1">― ‹This is used in two of the following cases, so we prove it beforehand:›</span>
    <span class="keyword1"><span class="command">have</span></span> x_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a b c change_respecting_doesnt_modify domh 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Un_upper1 contra_subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> eq_mem<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrict_in to_partial_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>›</span></span> eq_mem<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>›</span></span> domσ_mem<span class="hidden">⇩</span><sub>2</sub> domh mem<span class="hidden">⇩</span><sub>2</sub>'_def subst_overrides<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a b c change_respecting_doesnt_modify_dma domh 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span><span class="main">)</span>      
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mems'_k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mems'_k</span> <span class="skolem">x</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>
       <span class="keyword1">then</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="skolem">x</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>

    <span class="comment1">(* FIXME: see if we can reduce the number of cases *)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mems'_i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mems'_i</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High<span class="main">)</span><span class="main">)</span>
         <span class="keyword1">then</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
                  <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low<span class="main">)</span><span class="main">)</span>
              <span class="keyword1">then</span> <span class="main">(</span><span class="free">some_val</span><span class="main">,</span> <span class="free">some_val</span><span class="main">)</span>
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="keyword1">then</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">)</span>
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">,</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>
              <span class="keyword1">else</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mems'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mems'</span> <span class="main">=</span>
        map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span>
            <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">k</span>
            <span class="keyword1">then</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_k</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_k</span><span class="main">)</span>
            <span class="keyword1">else</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> mems'_k_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_k</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_simp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* Some auxiliary statements to allow reasoning about these definitions as if they were given
       by cases instead of nested if clauses. *)</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_k_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟧</span> <span class="main">⟹</span>
      fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_k_simp mems'_k_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_k_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span> <span class="main">⟧</span> <span class="main">⟹</span>
      fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_k_simp mems'_k_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    
    <span class="keyword1"><span class="command">have</span></span> mems'_k_cases<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">⟦</span>
         <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span><span class="main">;</span>
           fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span>
           snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">;</span>
         <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span><span class="main">;</span> 
           fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span><span class="main">;</span>
           snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">have</span></span> mems'_i_simp<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_i_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">⟧</span> <span class="main">⟹</span>
               fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_i_def mems'_i_simp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_i_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">⟧</span> <span class="main">⟹</span>
              fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">some_val</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">some_val</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_i_def mems'_i_simp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_i_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
                 <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">⟧</span> <span class="main">⟹</span>
              fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_i_def mems'_i_simp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_i_4 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
                 <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">;</span>
                 <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span>
              fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_i_def mems'_i_simp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_i_5 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
                 <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">;</span>
                 <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span>
              fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_i_def mems'_i_simp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="comment1">(* This may look complicated, but is actually a rather
       mechanical definition, as it merely spells out the cases
       of the definition: *)</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_i_cases<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">P</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span>
         <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
           <span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
             <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">;</span>
             fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">;</span>
      <span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
        <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span>  <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span>
        fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">some_val</span><span class="main">;</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">some_val</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">;</span>
      <span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">;</span> 
        <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span>
        fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span><span class="main">;</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">;</span>
      <span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">;</span>
        <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span><span class="main">;</span>
        fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">;</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">;</span>
      <span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">;</span>
        fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span>       <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mems'_i_1 mems'_i_2 mems'_i_3 mems'_i_4 mems'_i_5
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Sec.exhaust<span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">mems'</span> <span class="bound">i</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> len_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size length_list_update new_length<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> mm_equiv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> subst <span class="main">(</span><span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem<span class="hidden">⇩</span><sub>2</sub>'_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> g<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> dom_restrict_total<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

   <span class="keyword1"><span class="command">hence</span></span> 𝒞_subst_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="main">(</span>subst <span class="main">(</span><span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mm_equiv_𝒞_eq<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

   <span class="keyword1"><span class="command">have</span></span> low_mds_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst <span class="main">(</span><span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mm_equiv_low_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main">(</span></span><span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="main"><span class="main">!</span></span> <span class="free"><span class="free">k</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mm_equiv'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

   <span class="keyword1"><span class="command">have</span></span> 𝒞_subst_eq_idemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">⟹</span> <span class="main">(</span>subst <span class="main">(</span><span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subst_not_in_dom<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> notI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_restrict_total<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> compat b <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">from</span></span> 𝒞_subst_eq 𝒞_subst_eq_idemp
    <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> not_control<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> len_unchanged <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> compat <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span> len_unchanged new_length
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>›</span></span> compat_different<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒞_Low<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>›</span></span> 𝒞_Low <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mems'_i_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main"><span class="main">]</span></span>
                 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">mems'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size length_list_update new_length<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="skolem">mems'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> compat new_length
        <span class="keyword1"><span class="command">unfolding</span></span> mems'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
        <span class="comment1">― ‹We define another  function from this and reuse the universally quantified statements
          from the first part of the proof.›</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span>
           <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>
            <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>
                 <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="skolem">x</span>
                 <span class="keyword1">else</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
            <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">have</span></span> domσ'<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> σ'_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span> <span class="operator">metis</span> domI domIff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span> domD domσ <span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> diff_vars_impl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span> differing_vars_elim<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="comment1">(* We now show that we can reuse the earlier statements
           by showing the following equality: *)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> x_in_X'k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span>

            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ domD <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span> domσ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">from</span></span> domσ' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">σ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
             
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ' 
              <span class="keyword1"><span class="command">unfolding</span></span> subst_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ'_def <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> diff_vars_impl option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> x_in_X'k<span class="main">)</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span>

            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span> subst_not_in_dom<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> differing_vars_neg <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> σ'_def
                <span class="keyword1"><span class="command">using</span></span> domσ' domh
                <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> subst_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span><span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ' subst_not_in_dom<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span> differing_vars_neg<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span><span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="comment1">(* And the same for the second memories: *)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span>

            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domD <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span> domσ
              <span class="keyword1"><span class="command">unfolding</span></span> subst_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">σ'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ'  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ' c 
              <span class="keyword1"><span class="command">unfolding</span></span> subst_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ'_def <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> diff_vars_impl option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span><span class="main">)</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ' dom_restrict_total mem<span class="hidden">⇩</span><sub>2</sub>'_def subst_overrides<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span>

            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span> subst_not_in_dom<span class="main">)</span> 
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            
            <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>  
              <span class="comment1">(* This case can't happen so derive a contradiction *)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x_unchanged<span class="main">)</span>

              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
               
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">∨</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> differing_vars_elim <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span><span class="main">)</span>

              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span>
                                             snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> mems'_k_2 <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span><span class="main">)</span>
                
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">σ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domσ'<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_not_in_dom<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span>  mems'_k_1 <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>›</span></span><span class="main">)</span>

              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> mem<span class="hidden">⇩</span><sub>2</sub>'_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ_mem<span class="hidden">⇩</span><sub>2</sub> subst_not_in_dom <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>›</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span><span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> domσ domσ' g b <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c<span class="hidden">⇩</span><sub>2</sub>'_def cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size nth_list_update_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span>
            <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">i</span>
             <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>
                  <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="skolem">x</span>
                  <span class="keyword1">else</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
             <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> σ'_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domD domσ<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span>
                 <span class="main">(</span><span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∨</span>
                  <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">⟶</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> eq_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> clas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> clas_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> mems'_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mems'_i_4
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span> b i_le length_list_update<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> eq_mem mems'_simp
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ'_def <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def mems'_simp <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> eq_mem mems'_simp
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_neg_intro<span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> domσ mems'_simp subst_not_in_dom<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="comment1">(* FIXME: clean this up once we optimise the definition of mems'_i *)</span>
        <span class="comment1">(* Toby: try to establish something similar to o for the downgrading case *)</span>
        <span class="keyword1"><span class="command">have</span></span> o_downgrade<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span>subst <span class="skolem">σ</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∨</span>
                    subst <span class="skolem">σ</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> subst <span class="skolem">σ'</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                   <span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">)</span> <span class="main">⟶</span>
                    <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> clas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low<span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> mems'_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mems'_i_3
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span> b i_le length_list_update<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> notin <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> clas compat i_le len_unchanged
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> domσ <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_not_in_dom<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_eq<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_def differing_vars_lists_def<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">qed</span></span>
            
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> modifies_no_var_asm_not_written<span class="main">:</span>
             <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">∨</span>
                   <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">⟹</span>
              <span class="main">¬</span> var_asm_not_written <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> modified<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="main">(</span>doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span>doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> b i
            <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> modified_r<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="main">(</span>doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span>doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> doesnt_read_or_modify_doesnt_modify <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

          <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword1"><span class="command">have</span></span> loc_modes<span class="main">:</span>
            <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∧</span>
             locally_sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sound_mode_use.simps
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b equal_size list_all_length<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b equal_size modes_eq nth_map<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∈</span> loc_reach <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> loc_reach.refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> guars<span class="main">:</span>
                <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span>
                 <span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span>
                 <span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span>
                 <span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> loc_modes
            <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def <span class="quoted"><span class="quoted">‹snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl surjective_pairing<span class="main">)</span>

          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> GuarNoWrite <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> GuarNoReadOrWrite"</span></span>
            <span class="keyword1"><span class="command">using</span></span> modified modified_r loc_modes locally_sound_mode_use_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>›</span></span> b locally_sound_respects_guarantees modes_eq nth_map meval_elim respects_own_guarantees_def sifum_security_init_axioms<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compatible_modes <span class="main">(</span>map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> globally_sound_modes_compatible sound_mode_use.simps<span class="main">)</span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?thesis</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> compatible_modes_def var_asm_not_written_def
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span> i_le
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> b length_list_update length_map nth_map<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        
        <span class="keyword1"><span class="command">from</span></span> o o_downgrade <span class="keyword1"><span class="command">have</span></span>
          p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∨</span>
                      <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span><span class="main">;</span>
                     <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">)</span> <span class="main">∧</span>
                                   <span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
          <span class="main">¬</span> var_asm_not_written  <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> mems_neq<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> nin<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High<span class="main">)</span> <span class="main">∧</span>
                           <span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
            <span class="comment1">(* FIXME: clean this up *)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">∉</span></span> <span class="var"><span class="var">?X'</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low<span class="main">)</span>"</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> o_downgrade<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
              <span class="comment1">(* use o *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> o Sec.exhaust<span class="main">)</span>
             <span class="comment1">(* should follow trivially *)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> o Sec.exhaust<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_no_var_asm_not_written<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> q'<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span>
                   <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∨</span>
                   <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span><span class="main">;</span>
                   <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">⟧</span> <span class="main">⟹</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span> b compat_different_vars i_le length_list_update mems'_i_2 o<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size i_le length_list_update new_length<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> compat <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
          bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ'<span class="hidden">⇩</span><sub>k</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'<span class="hidden">⇩</span><sub>k</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="free">k</span> <span class="keyword1">then</span> Some <span class="main">(</span>undefined<span class="main">::</span><span class="tfree">'Val</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ'<span class="hidden">⇩</span><sub>k</sub></span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> σ'<span class="hidden">⇩</span><sub>k</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> compat <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'<span class="hidden">⇩</span><sub>k</sub></span> <span class="main">=</span> <span class="var">?X</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword1"><span class="command">have</span></span>
          bisim<span class="hidden">⇩</span><sub>k</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="main">[↦</span> <span class="skolem">σ'<span class="hidden">⇩</span><sub>k</sub></span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">σ'<span class="hidden">⇩</span><sub>k</sub></span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> q_downgrade<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">;</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span>
                   <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∨</span>
                   <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span><span class="main">;</span>
                   <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">⟧</span> <span class="main">⟹</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span> compat_different_vars i_le len_unchanged mems'_i_2 o_downgrade<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span>
                   <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∨</span>
                   <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span><span class="main">;</span>
                   <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">⟧</span> <span class="main">⟹</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="improper">x</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> q_downgrade<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> q'<span class="main">)</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"differing_vars <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">∪</span>
                  differing_vars <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> Δ_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?Δ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> differing_finite finite_UnI<span class="main">)</span>
        <span class="comment1">― ‹We first define the adaptation, then prove that it does the right thing.›</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span>
             <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>
              <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> High
                   <span class="keyword1">then</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span><span class="main">)</span>
                   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>
                        <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="keyword1">of</span>
                                Some <span class="bound">v</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span>
                              <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>
                        <span class="keyword1">else</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
              <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">have</span></span> domA<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">A</span> <span class="main">=</span> <span class="var">?Δ</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">A</span> <span class="main">⊆</span> <span class="var">?Δ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> A_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domD<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Δ</span> <span class="main">⊆</span> dom <span class="skolem">A</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> A_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> domIff domσ option.exhaust option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> domIff domσ option.exhaust option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="comment1">(* FIXME: clean up *)</span>
        <span class="keyword1"><span class="command">have</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> not_control<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> i_le<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> subst_not_in_dom<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domσ<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

        <span class="comment1">(* FIXME: clean up *)</span>
        <span class="keyword1"><span class="command">have</span></span> dma_eq''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command">using</span></span> compat compat i_le len_unchanged <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> subst_not_in_dom<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

        <span class="keyword1"><span class="command">have</span></span> dma_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span>subst <span class="main">(</span><span class="main">(</span>to_partial <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|`</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> compat b
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dma_𝒞 subst_not_in_dom<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> A_correct<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span>
               <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∧</span>
               <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">x</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Eq<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="var">?Eq<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> diff<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_def<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> High›</span></span> <span class="keyword1"><span class="command">have</span></span> A_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
                <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> A_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>›</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> A_simp <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?Eq<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="var"><span class="quoted"><span class="var">?Eq<span class="hidden">⇩</span><sub>2</sub></span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> A_def apply_adaptation_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domD domσ<span class="main">)</span>
                <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> subst_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Low›</span></span> <span class="keyword1"><span class="command">have</span></span> A_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
                  <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="keyword1">of</span>
                            Some <span class="bound">v</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span>
                          <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> A_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> domA <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>

              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>

                <span class="keyword1"><span class="command">hence</span></span> A_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> A_def
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Low›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                <span class="keyword1"><span class="command">from</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Low›</span></span> diff <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> dma_eq dma_eq''<span class="main">)</span>

                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
                  <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ subst_not_in_dom<span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?Δ</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA domIff<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">A</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?Δ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∧</span>
                                 <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> None›</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> differing_vars_def apply_adaptation_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">hence</span></span> adapt_eq<span class="main">:</span> 
              <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">∧</span>
               <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span> b nth_list_update_neq<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> A_correct'<span class="main">:</span> <span class="quoted"><span class="quoted">"globally_consistent <span class="skolem">A</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="comment1">(* FIXME: clean up *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> globally_consistent_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">split</span> option.split<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> allI conjI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">split</span> prod.split<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
             <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span>
             <span class="keyword3"><span class="command">assume</span></span> A_updates_x<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> A_updates_x<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span><span class="quoted"><span class="quoted">"subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span> <span class="main">∨</span> subst <span class="skolem">σ'</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v'</span>"</span></span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
             <span class="keyword1"><span class="command">hence</span></span> diff<span class="main">:</span>
               <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_def domA<span class="main">)</span>
             <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> var_asm_not_written <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
             <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High<span class="main">)</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
               <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">from</span></span> this p <span class="keyword2"><span class="keyword">and</span></span> diff <span class="keyword3"><span class="command">show</span></span> writable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> var_asm_not_written <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">next</span></span>
               <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

               <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> modifies_no_var_asm_not_written<span class="main">)</span>
             <span class="keyword1"><span class="command">qed</span></span>
                      
          <span class="keyword1"><span class="command">next</span></span>
            
            <span class="keyword1"><span class="command">have</span></span> reclas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span>
         <span class="main">¬</span> var_asm_not_written <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adapt_eq dma_eq dma_eq''<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> modifies_no_var_asm_not_written<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> equal_size modes_eq nth_map<span class="main">)</span>

            <span class="keyword1"><span class="command">hence</span></span> low_mds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mm_equiv_low_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main">(</span></span><span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> c<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main">(</span></span><span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> bisim
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b equal_size modes_eq nth_map<span class="main">)</span>

            <span class="keyword1"><span class="command">hence</span></span> low_mds_eq<span class="hidden">⇩</span><sub>k</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst <span class="skolem">σ'<span class="hidden">⇩</span><sub>k</sub></span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="main">(</span>subst <span class="skolem">σ'<span class="hidden">⇩</span><sub>k</sub></span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mm_equiv_low_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main">(</span></span><span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">!</span></span> <span class="free"><span class="free">k</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> c<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main">(</span></span><span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">!</span></span> <span class="free"><span class="free">k</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> bisim<span class="hidden">⇩</span><sub>k</sub>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> AsmNoReadOrWrite <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span>"</span></span>
            <span class="comment1">(* FIXME: clean up *)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adapt_eq dma_eq<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> dom <span class="skolem">σ</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_not_in_dom<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domσ<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> mems'_i_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span> len_unchanged<span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>

            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> low_mds_eq<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>

            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> makes_compatible_dma_eq<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> compat<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="skolem">i</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∉</span> dom <span class="skolem">σ'</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_not_in_dom<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="skolem">i</span>›</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">from</span></span> reclas eq
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span>
         <span class="main">¬</span> var_asm_not_written <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> AsmNoReadOrWrite <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>subst <span class="skolem">σ'</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> equal_size modes_eq nth_map<span class="main">)</span>

        <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A_correct'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> surjective_pairing<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> surjective_pairing<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing globally_consistent_adapt_bisim<span class="main">)</span>

        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> adapt_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span> b cms<span class="hidden">⇩</span><sub>2</sub>'_def nth_list_update_neq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> mem_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> not_control i_le<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> mem_eq'<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="free">k</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro mems'_k_1 mems'_k_2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> compat_different<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat<span class="main"><span class="main">]</span></span> b mem_eq Sec.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> x_unchanged<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mems'_i_cases<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> b i_le <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_list_update<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
              <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
            <span class="comment1">― ‹In this case, for example, the values of (mems' ! i) are not needed.›</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mem_eq<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="comment1">(* FIXME: clean this up -- there is surely a more direct route.
                      Same must be true of mems'_i definition and o, o_downgrade,
                      p etc. lemmas above that are proved with surely lots of
                      overlapping cases *)</span>
            <span class="keyword3"><span class="command">assume</span></span> case3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> 
              <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
              <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
              <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> case3 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg differing_vars_elim<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> case3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b compat compat_different i_le length_list_update<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> mem_eq <span class="keyword1"><span class="command">have</span></span> clases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mems'_i_5<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> i_le len_unchanged <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case3<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> High›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> case4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                   <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
                   <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> mem_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> case4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_def differing_vars_lists_def<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
                   <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> var_changed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mems'_k_cases<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> var_changed x_unchanged<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> b
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_zeroE<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> compat
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="free">k</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mems'_k_cases<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i_prop <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">from</span></span> i_prop <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="comment1">(* FIXME: clean up *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mems'_i_cases<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_prop<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span> differing_vars_neg
               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span><span class="main">)</span>›</span></span> differing_vars_elim <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> i_prop <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size length_list_update new_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Isar proof language provides a readable
way of specifying assumptions while also giving them names for subsequent
usage.›</span></span>
<span class="keyword1" id="Compositionality-compat_low_eq"><span class="command">lemma</span></span> compat_low_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoReadOrWrite<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> compat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span>
                    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> x_low <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> compat x_low makes_compatible_dma_eq j_prop <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">j</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> x_low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">from</span></span> domσ compat <span class="keyword2"><span class="keyword">and</span></span> j_prop <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> modes_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> j_prop length_map nth_map<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span><span class="hidden">⇘</span><sub>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> modes_eq j_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mm_equiv_low_eq prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_low x_readable j_prop <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">j</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> low_mds_eq_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_not_in_dom<span class="main">)</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> j_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_different_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-loc_reach_subset"><span class="command">lemma</span></span> loc_reach_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"loc_reach <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⊆</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c''</span> <span class="skolem">mds''</span> <span class="skolem">mem''</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl loc_reach.step surjective_pairing<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>›</span></span> surjective_pairing<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.step<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.mem_diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-locally_sound_modes_invariant"><span class="command">lemma</span></span> locally_sound_modes_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv loc_reach.refl loc_reach.step snd_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sound_modes
    <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Collect_empty_eq eval loc_reach_subset subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Compositionality-meval_sched_one"><span class="command">lemma</span></span> meval_sched_one<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="main">[</span><span class="free">k</span><span class="main">]</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Compositionality-meval_sched_ConsI"><span class="command">lemma</span></span> meval_sched_ConsI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms''</span><span class="main">,</span> <span class="free">mem''</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">k</span><span class="main">#</span><span class="free">sched</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms''</span><span class="main">,</span> <span class="free">mem''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Compositionality-reachable_modes_subset"><span class="command">lemma</span></span> reachable_modes_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable_mode_states <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="main">⊆</span> reachable_mode_states <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mdss</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mdss</span> <span class="main">∈</span> reachable_mode_states <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mdss</span> <span class="main">∈</span> reachable_mode_states <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> reachable_mode_states_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> meval_sched_ConsI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-globally_sound_modes_invariant"><span class="command">lemma</span></span> globally_sound_modes_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> globally_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"globally_sound_mode_use <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"globally_sound_mode_use <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms reachable_modes_subset
  <span class="keyword1"><span class="command">unfolding</span></span> globally_sound_mode_use_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span>

<span class="keyword1" id="Compositionality-loc_reach_mem_diff_subset"><span class="command">lemma</span></span> loc_reach_mem_diff_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> var_asm_not_written <span class="free">mds</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> refl
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv loc_reach.mem_diff loc_reach.refl mem_diff snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> step
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.step<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> mem_diff
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.mem_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-loc_reach_mem_diff_eq"><span class="command">lemma</span></span> loc_reach_mem_diff_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> var_asm_not_written <span class="free">mds</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">mem'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">=</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms loc_reach_mem_diff_subset
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>

<span class="keyword1" id="Compositionality-sound_modes_invariant"><span class="command">lemma</span></span> sound_modes_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword2"><span class="keyword">and</span></span> eval <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"globally_sound_mode_use <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> globally_sound_modes_invariant sound_mode_use.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword1"><span class="command">have</span></span> loc_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms</span><span class="main">.</span> locally_sound_mode_use <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sound_mode_use_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> list_all_length<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>k</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">cms</span> <span class="main">∧</span> <span class="free">cms'</span> <span class="main">=</span> <span class="free">cms</span> <span class="main">[</span><span class="skolem">k</span> <span class="main">:=</span> <span class="skolem">cms<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meval_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms</span> <span class="main">=</span> length <span class="free">cms'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms'</span> <span class="main">⟹</span> locally_sound_mode_use <span class="main">(</span><span class="free">cms'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> i_le ev loc_sound
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> locally_sound_modes_invariant nth_list_update surj_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">cms'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ev nth_list_update_neq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compatible_modes <span class="main">(</span>map snd <span class="free">cms</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sound_mode_use.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> globally_sound_modes_compatible<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> var_asm_not_written <span class="main">(</span>snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> GuarNoWrite <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> GuarNoReadOrWrite"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> compatible_modes_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">cms</span> <span class="main">=</span> length <span class="free">cms'</span>›</span></span> ev i_le length_map nth_map var_asm_not_written_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> var_asm_not_written <span class="main">(</span>snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ev loc_sound
        <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl surjective_pairing doesnt_read_or_modify_doesnt_modify<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ev <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> var_asm_not_written <span class="main">(</span>snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> loc_reach_mem_diff_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"loc_reach <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="main">=</span> loc_reach <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> loc_sound i_le <span class="quoted"><span class="quoted">‹length <span class="free">cms</span> <span class="main">=</span> length <span class="free">cms'</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">cms'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sound_mode_use.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> list_all_length<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-app_Cons_rewrite"><span class="command">lemma</span></span> app_Cons_rewrite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">@</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">ms</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">ns</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">ms</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Compositionality-meval_sched_app_iff"><span class="command">lemma</span></span> meval_sched_app_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">ns</span><span class="main">@</span><span class="free">ms</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">.</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">ns</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">ms</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quoted"><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> meval_sched_appD <span class="main">=</span> meval_sched_app_iff<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> meval_sched_appI <span class="main">=</span> meval_sched_app_iff<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">,</span> <span class="operator">OF</span> exI<span class="main">,</span> <span class="operator">OF</span> exI<span class="main">]</span>

<span class="keyword1" id="Compositionality-meval_sched_snocD"><span class="command">lemma</span></span> meval_sched_snocD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">ns</span><span class="main">@</span><span class="main">[</span><span class="free">n</span><span class="main">]</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">.</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">ns</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> meval_sched_appD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Compositionality-meval_sched_snocI"><span class="command">lemma</span></span> meval_sched_snocI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">ns</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">ns</span><span class="main">@</span><span class="main">[</span><span class="free">n</span><span class="main">]</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> meval_sched_appI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="Compositionality-makes_compatible_eval_sched"><span class="command">lemma</span></span> makes_compatible_eval_sched<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mems'</span><span class="main">.</span> sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                              sound_mode_use <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                              map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
                              <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                              makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="bound">mems'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">(* cms<span class="hidden">⇩</span><sub>1</sub>' and mem<span class="hidden">⇩</span><sub>1</sub>' need to be arbitrary so
     that the induction hypothesis is sufficiently general. *)</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">sched</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pair_inject meval_sched.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat meval_sched.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> modes_eq sound_modes<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> eval''<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="skolem">ns</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meval_sched_snocD prod_cases3 snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> eval'' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mems''</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span>
      <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">∧</span>
       sound_mode_use <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">)</span> <span class="main">∧</span>
       map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">=</span> map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">∧</span>
       <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="skolem">ns</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">)</span> <span class="main">∧</span>
       makes_compatible <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">)</span> <span class="skolem">mems''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mems'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
       <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">)</span> ↝<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
       makes_compatible <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">mems'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> makes_compatible_invariant
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH eval'' meval_sched_snocI sound_modes_invariant
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-differing_vars_initially_empty"><span class="command">lemma</span></span> differing_vars_initially_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>zip <span class="main">(</span>replicate <span class="free">n</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> differing_vars_lists_def differing_vars_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-compatible_refl"><span class="command">lemma</span></span> compatible_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coms_secure<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all com_sifum_secure <span class="free">cmds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> low_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
                          <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
                          <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">cmds</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cmds</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate <span class="var">?n</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mdss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cmds</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?mems</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> diff_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="var">?n</span><span class="main">.</span> <span class="var">?X</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_initially_empty ex_in_conv min.idem zip_replicate<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cmds</span> <span class="main">=</span> length <span class="free">cmds</span> <span class="main">∧</span> length <span class="free">cmds</span> <span class="main">=</span> length <span class="var">?mems</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Val</span> option"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mdss<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cmds</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span>
                  differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>
                                      <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">cmds</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">with</span></span> domσ <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def i<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> i coms_secure <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"com_sifum_secure <span class="main">(</span><span class="free">cmds</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coms_secure
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map length_replicate list_all_length map_snd_zip<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="var">?mdss<span class="hidden">⇩</span><sub>i</sub></span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
      <span class="main">(</span><span class="free">cmds</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cmds</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> com_sifum_secure_def low_indistinguishable_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff empty_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">mem</span><span class="main">.</span> <span class="bound">mem</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span> <span class="bound">mem</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> low_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="var">?mdss<span class="hidden">⇩</span><sub>i</sub></span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def low_eq_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cmds</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cmds</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cmds</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> diff_empty <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">cmds</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cmds</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diff_empty
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot_less bot_nat_def empty_iff length_zip low_eq min_0L<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sifum_compositionality_cont<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> com_secure<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all com_sifum_secure <span class="free">cmds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mem</span><span class="main">.</span> <span class="free">INIT</span> <span class="bound">mem</span> <span class="main">⟶</span> sound_mode_use <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="bound">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prog_sifum_secure_cont <span class="free">cmds</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prog_sifum_secure_cont_def
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sched</span> <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cmds</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zip <span class="main">(</span>replicate <span class="var">?n</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>replicate <span class="var">?n</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> INIT<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">INIT</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> INIT<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">INIT</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> low_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> com_secure <span class="keyword1"><span class="command">have</span></span> compat<span class="main">:</span>
    <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="var">?mems</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compatible_refl fst_conv length_replicate map_replicate snd_conv zip_eq_conv INIT<span class="hidden">⇩</span><sub>1</sub> INIT<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="skolem">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mems'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
             <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="skolem">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
             makes_compatible <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">mems'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sound_modes makes_compatible_eval_sched INIT<span class="hidden">⇩</span><sub>1</sub> INIT<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="skolem">sched</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                        map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
                        length <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> length <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span>
                        <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoReadOrWrite<span class="main">)</span><span class="main">)</span>
          <span class="main">⟶</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p compat_low_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Language">
<div class="head">
<h1>Theory Language</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Language for Instantiating the SIFUM-Security Property›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Language
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Preliminaries.html">Preliminaries</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'var</span> ModeUpd <span class="main">=</span> Acq <span class="quoted"><span class="quoted">"<span class="tfree">'var</span>"</span></span> <span class="quoted">Mode</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">+=<span class="hidden">⇩</span><sub>m</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 75<span class="main">)</span>
  <span class="main">|</span> Rel <span class="quoted"><span class="quoted">"<span class="tfree">'var</span>"</span></span> <span class="quoted">Mode</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">-=<span class="hidden">⇩</span><sub>m</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt <span class="main">=</span> Assign <span class="quoted"><span class="quoted">"<span class="tfree">'var</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'aexp</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">←</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 130<span class="main">)</span>
  <span class="main">|</span> Skip
  <span class="main">|</span> ModeDecl <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> ModeUpd"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">@[</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">]</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">]</span> 150<span class="main">)</span>
  <span class="main">|</span> Seq <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">;;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 150<span class="main">)</span>
  <span class="main">|</span> If <span class="quoted"><span class="quoted">"<span class="tfree">'bexp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span>
  <span class="main">|</span> While <span class="quoted"><span class="quoted">"<span class="tfree">'bexp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span>
  <span class="main">|</span> Await <span class="quoted"><span class="quoted">"<span class="tfree">'bexp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span>
  <span class="main">|</span> Stop

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> EvalCxt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt list"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_lang_no_dma <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">aexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Var_finite <span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'Var</span><span class="main">)</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="free">e</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e</span> <span class="main">=</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">bexp_vars</span> <span class="free">b</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">b</span> <span class="main">=</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">b</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_lang <span class="main">=</span> sifum_lang_no_dma <span class="quoted"><span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span></span> <span class="quoted"><span class="free">aexp_vars</span></span> <span class="quoted"><span class="free">bexp_vars</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span><span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_lang_no_dma
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* To make the examples look a bit nicer in the PDF. *)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  Seq <span class="main">(</span><span class="quoted">"_<span class="keyword1">;</span> _"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>Rule <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  Seq <span class="main">(</span><span class="quoted">"_ <span class="keyword1">;</span> _"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>Rule <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  If <span class="main">(</span><span class="quoted">"<span class="keyword1">if</span> _ <span class="keyword1">then</span> _ <span class="keyword1">else</span> _ <span class="keyword1">fi</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>Rule <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  While <span class="main">(</span><span class="quoted">"<span class="keyword1">while</span> _ <span class="keyword1">do</span> _ <span class="keyword1">done</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>Rule <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  Await <span class="main">(</span><span class="quoted">"<span class="keyword1">await</span> _ <span class="keyword1">do</span> _ <span class="keyword1">done</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">conf<span class="hidden">⇩</span><sub>w</sub>_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span>
  <span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> LocalConf"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">,</span> _<span class="keyword1">,</span> _<span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span>"</span> <span class="main">[</span>0<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">update_modes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Var</span> Mds"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_modes</span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">update_modes</span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">:=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">updated_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="tfree">'Var</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_var</span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_var</span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">updated_mode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> Mode"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_mode</span> <span class="main">(</span>Acq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_mode</span> <span class="main">(</span>Rel <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">×</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem<span class="main">)</span> rel"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">×</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">×</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Stop<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Skip<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Stop<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  seq_stop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Seq Stop <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  if_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  if_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">;;</span> While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> Stop<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span>

<span class="keyword1" id="Language-cond"><span class="command">lemma</span></span> cond<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>If <span class="free">b</span> <span class="free">t</span> <span class="free">e</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">t</span> <span class="keyword1">else</span> <span class="free">e</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">b</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cxt_to_stmt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> EvalCxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cxt_to_stmt</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">cxt_to_stmt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> Seq <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">(</span><span class="free">cxt_to_stmt</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Design decision: Add "normal" rule for sequential statements here as well.
  Otherwise, one would have to take care of adding some sort of normalization
  later, so that one doesn't get stuck on expressions of the form (c ;; c') ;; c''.
*)</span>
<span class="comment1">(* Normalization turned out to be more difficult, as it made the proofs of several
  helpful lemmas below quite difficult. *)</span>

<span class="keyword1" id="Language-rtrancl_mono_proof"><span class="command">lemma</span></span> rtrancl_mono_proof<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">y</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> rtranclp <span class="free">x</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟶</span> rtranclp <span class="free">y</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> rtranclp.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Language-trancl_mono_proof"><span class="command">lemma</span></span> trancl_mono_proof<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">y</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> tranclp <span class="free">x</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟶</span> tranclp <span class="free">y</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tranclp.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">no_await</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">no_await</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">no_await</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⟹</span> <span class="free">no_await</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">⟹</span> <span class="free">no_await</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">no_await</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⟹</span> <span class="free">no_await</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">⟹</span> <span class="free">no_await</span> <span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">no_await</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">no_await</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">no_await</span> Skip"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">no_await</span> Stop"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">no_await</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">no_await</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">@[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">is_final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_final</span> Stop"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_final</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">is_final</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">@[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">eval<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
                  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span>"</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span> <span class="main">|</span>
  unannotated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⟨</span>cxt_to_stmt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span>cxt_to_stmt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span> <span class="main">|</span>
  seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub>'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⟨</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span> <span class="main">|</span>
  decl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> update_modes <span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟧</span> <span class="main">⟹</span>
         <span class="main">(</span><span class="main">⟨</span>cxt_to_stmt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">(</span>ModeDecl <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span>cxt_to_stmt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span> <span class="main">|</span>
<span class="comment1">(* This is added instead of defining eval<span class="hidden">⇩</span><sub>p</sub> -- see next comment*)</span>
  await<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span> no_await <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span>
         <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">;</span>
         is_final <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
         <span class="main">(</span><span class="main">⟨</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eval<span class="hidden">⇩</span><sub>w</sub>_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
                  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup></span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ctx</span></span></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup></span></span> <span class="free"><span class="bound"><span class="entity">ctx'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ctx</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ctx'</span></span></span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantic Properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas simplify working with evaluation contexts
  in the soundness proofs for the type system(s).›</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> eval_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">)</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">)</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> stop_no_eval' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Stop<span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> assign_elim' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> skip_elim' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Skip<span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-cxt_inv"><span class="command">lemma</span></span> cxt_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span> <span class="main">;</span> <span class="main">⋀</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">c'</span> <span class="main">≠</span> Seq <span class="bound">p</span> <span class="bound">q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> neq_Nil_conv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_assign"><span class="command">lemma</span></span> cxt_inv_assign<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">←</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">←</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_skip"><span class="command">lemma</span></span> cxt_inv_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> Skip <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Skip <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_stop"><span class="command">lemma</span></span> cxt_inv_stop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> Stop <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>49<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_if"><span class="command">lemma</span></span> cxt_inv_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> If <span class="free">e</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> If <span class="free">e</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>43<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>
  
<span class="keyword1" id="Language-ctx_inv_anno"><span class="command">lemma</span></span> ctx_inv_anno<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span><span class="main">@[</span><span class="free">mu</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span><span class="main">@[</span><span class="free">mu</span><span class="main">]</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cxt_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  
<span class="keyword1" id="Language-cxt_inv_await"><span class="command">lemma</span></span> cxt_inv_await<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> Await <span class="free">e</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Await <span class="free">e</span> <span class="free">p</span>  <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>47<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_while"><span class="command">lemma</span></span> cxt_inv_while<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> While <span class="free">e</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> While <span class="free">e</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>45<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-skip_elim"><span class="command">lemma</span></span> skip_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Skip<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds</span> <span class="main">=</span> <span class="free">mds'</span> <span class="main">∧</span> <span class="free">mem</span> <span class="main">=</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> cxt_inv_skip cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> skip_elim'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>24<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>21<span class="main"><span class="main">)</span></span> cxt_inv_skip<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language-assign_elim"><span class="command">lemma</span></span> assign_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds</span> <span class="main">=</span> <span class="free">mds'</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c c'a E<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">←</span> <span class="free">e</span> <span class="main">∧</span> <span class="improper">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_inv_assign<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_inv_assign<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> cxt_inv_assign<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> cxt_inv_assign<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> cxt_inv_assign<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> if_elim' <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>If <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-if_elim"><span class="command">lemma</span></span> if_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">P</span><span class="main">.</span>
    <span class="main">⟦</span> <span class="main">⟨</span>If <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">;</span>
     <span class="main">⟦</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">p</span><span class="main">;</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">;</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">;</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">;</span>
     <span class="main">⟦</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">q</span><span class="main">;</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">;</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">;</span> <span class="main">¬</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> cxt_inv_if cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> if_elim'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>43<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>35<span class="main"><span class="main">)</span></span> cxt_inv_if<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> await_elim' <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Await <span class="free">b</span> <span class="free">p</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span><span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> while_elim' <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>While <span class="free">e</span> <span class="free">c</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-while_elim"><span class="command">lemma</span></span> while_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> cxt_inv_while cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while_elim'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>45<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>37<span class="main"><span class="main">)</span></span> cxt_inv_while<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> upd_elim' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">@[</span><span class="free">upd</span><span class="main">]</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-upd_elim"><span class="command">lemma</span></span> upd_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">@[</span><span class="free">upd</span><span class="main">]</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> update_modes <span class="free">upd</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>33<span class="main"><span class="main">)</span></span> cxt_inv upd_elim'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>34<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>33<span class="main"><span class="main">)</span></span> cxt_inv cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language-cxt_seq_elim"><span class="command">lemma</span></span> cxt_seq_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">E</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c'</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">E</span> <span class="main">=</span> <span class="bound">c'</span> <span class="main">#</span> <span class="bound">cs</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> cxt_to_stmt <span class="bound">cs</span> <span class="bound">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">E</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> seq_elim' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-stop_no_eval"><span class="command">lemma</span></span> stop_no_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_inv_stop stop_no_eval'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>49<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>41<span class="main"><span class="main">)</span></span> cxt_inv_stop<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language-seq_stop_elim"><span class="command">lemma</span></span> seq_stop_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> cxt_seq_elim cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> seq_elim' stop_no_eval'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stop_no_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.distinct<span class="main"><span class="main">(</span></span>28<span class="main"><span class="main">)</span></span> Stmt.distinct<span class="main"><span class="main">(</span></span>36<span class="main"><span class="main">)</span></span> cxt_seq_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language-cxt_stmt_seq"><span class="command">lemma</span></span> cxt_stmt_seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">;;</span> cxt_to_stmt <span class="free">E</span> <span class="free">c'</span> <span class="main">=</span> cxt_to_stmt <span class="main">(</span><span class="free">c'</span> <span class="main">#</span> <span class="free">E</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1" id="Language-seq_elim"><span class="command">lemma</span></span> seq_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">;</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">∧</span> <span class="free">c'</span> <span class="main">=</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cxt_seq_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="improper">c</span><span class="main">@[</span><span class="improper">mu</span><span class="main">]</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cxt_seq_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.distinct<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span> cxt_stmt_seq cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> cxt_seq_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Language-stop_cxt"><span class="command">lemma</span></span> stop_cxt<span class="main">:</span> <span class="quoted"><span class="quoted">"Stop <span class="main">=</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Stop"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>50<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> neq_Nil_conv<span class="main">)</span>

<span class="comment1">(* Additional helper lemmas added by TobyM and RobS *)</span>

<span class="keyword1"><span class="command">lemmas</span></span> decl_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> decl<span class="main">[</span><span class="operator">OF</span> unannotated<span class="main">,</span> <span class="operator">OF</span> skip<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> seq_stop_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> seq_stop<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> assign_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> assign<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> if_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> cond<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> if_false_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> if_false<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skip_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> skip<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> while_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> while<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="Language-decl_eval"><span class="command">lemma</span></span> decl_eval<span class="hidden">⇩</span><sub>w</sub>'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> update_modes <span class="free">upd</span> <span class="free">mds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Skip<span class="main">@[</span><span class="free">upd</span><span class="main">]</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms decl_eval<span class="hidden">⇩</span><sub>w</sub>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language-assign_eval"><span class="command">lemma</span></span> assign_eval<span class="hidden">⇩</span><sub>w</sub>'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">mds</span> <span class="main">=</span> <span class="free">mds'</span><span class="main">;</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assign_eval<span class="hidden">⇩</span><sub>w</sub>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* Following the naming convention, but we actually apply these as dest, not elim rules... *)</span>

<span class="keyword1" id="Language-seq_decl_elim"><span class="command">lemma</span></span> seq_decl_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">(</span>Skip<span class="main">@[</span><span class="free">upd</span><span class="main">]</span><span class="main">)</span> <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span>
   <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">;;</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> update_modes <span class="free">upd</span> <span class="free">mds</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> seq_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> upd_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> skip_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Language-seq_assign_elim"><span class="command">lemma</span></span> seq_assign_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span>
   <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">;;</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> seq_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> assign_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Language-no_await_trans"><span class="command">lemma</span></span> no_await_trans<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> no_await <span class="free">c</span><span class="main">;</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> no_await <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">mds</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> <span class="quoted">"no_await.induct"</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assign_elim <span class="quoted">"no_await.simps"</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c1 c2 c3 mds<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c1</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> seq_stop_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> seq_elim no_await.intros <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
       <span class="keyword1"><span class="command">using</span></span> if_elim no_await.intros <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> while_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c b<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"no_await <span class="main">(</span>While <span class="improper">b</span> <span class="improper">c</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"no_await <span class="main">(</span><span class="improper">c</span> <span class="main">;;</span> While <span class="improper">b</span> <span class="improper">c</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> no_await.intros <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> no_await.intros <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">using</span></span> no_await.intros <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> no_await.intros skip_elim <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
   <span class="keyword1"><span class="command">using</span></span> no_await.intros stop_no_eval <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">using</span></span> no_await.intros upd_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Language-no_await_no_await"><span class="command">lemma</span></span> no_await_no_await<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> no_await <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">≠</span> Await <span class="free">b</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_await.cases Stmt.distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Language-no_await_trancl_impl"><span class="command">lemma</span></span> no_await_trancl_impl<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ctx</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">ctx'</span><span class="main">⟧</span> <span class="main">⟹</span> no_await <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">ctx</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> no_await <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">ctx'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trancl.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> no_await_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> no_await_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1" id="Language-no_await_trancl"><span class="command">lemma</span></span> no_await_trancl<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ctx</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">ctx'</span><span class="main">;</span> no_await <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">ctx</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> no_await <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">ctx'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> no_await_trancl_impl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Language-await_elim"><span class="command">lemma</span></span> await_elim<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⟨</span>Await <span class="free">b</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">b</span> <span class="main">∧</span> no_await <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> is_final <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">∧</span>
    <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="quoted">"eval<span class="hidden">⇩</span><sub>w</sub>.cases"</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="improper">E</span> <span class="improper">c</span> <span class="main">=</span> Await <span class="free">b</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cxt_inv_await<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"eval<span class="hidden">⇩</span><sub>w</sub>_simple.cases"</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.distinct<span class="main"><span class="main">(</span></span>33<span class="main"><span class="main">)</span></span> cxt_inv_await<span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TypeSystem">
<div class="head">
<h1>Theory TypeSystem</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Type System for Ensuring SIFUM-Security of Commands›</span></span>

<span class="keyword1"><span class="command">theory</span></span> TypeSystem
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Compositionality.html">Compositionality</a> <a href="Language.html">Language</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing Rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Types now depend on memories. To see why, consider an assignment in which some variable
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for which we have a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AsmNoReadOrWrite</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> assumption is assigned the value in 
  variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">input</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">input</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s classification depends on some control
  variable. Then the new type of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> depends on memory. If we were to just take the 
  upper bound of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">input</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s classification, this would likely give us <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">High</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s type, but that would prevent us from treating <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Low</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  if we later learn <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">input</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s original classification. 
  
  Instead we need to make <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s type explicitly depend on memory so later on, once we
  learn <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">input</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s classification, we can resolve <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s type to a concrete
  security level.
  
  We choose to deeply embed types as sets of boolean expressions. If any expression in the
  set evaluates to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the type is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">High</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; otherwise it is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Low</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'BExp</span> Type <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We require <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to track all stable (i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AsmNoWrite</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AsmNoReadOrWrite</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), 
  non-<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">𝒞</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> variables.
  
  This differs from Mantel a bit. Mantel would exclude from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, variables
  whose classification (according to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">dma</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Low</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for which we have only
  an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AsmNoWrite</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> assumption.
  
  We decouple the requirement for inclusion in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from a variable's classification
  so that we don't need to be updating <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> each time we alter a control variable.
  Even if we tried to keep <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> up-to-date in that case, we may not be able to 
  precisely compute the new classification of each variable after the modification anyway.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'BExp</span> Type"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This records which variables are \emph{stable} in that we have an assumption
  implying that their value won't change. It duplicates a bit of info in
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> above but I haven't yet thought of a way to remove that duplication
  cleanly.
  
  The first component of the pair records variables for which we have
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AsmNoWrite</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; the second component is for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AsmNoReadOrWrite</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  
  The reason we want to distinguish the different kinds of assumptions is to know whether
  a variable should remain in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when we drop an assumption on it. If we drop
  e.g. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AsmNoWrite</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but also have <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AsmNoReadOrWrite</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then if we didn't track
  stability info this way we wouldn't know whether we had to remove the variable from
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or not.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'Var</span> Stable <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span> set <span class="main">×</span> <span class="tfree">'Var</span> set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We track a set of predicates on memories as we execute. If we evaluate a boolean expression
  all of whose variables are stable, then we enrich this set predicate with that one.
  If we assign to a stable variable, then we enrich this predicate also.
  If we release an assumption making a variable unstable, we need to remove all predicates that
  pertain to it from this set.
  
  This needs to be deeply embedded (i.e. it cannot be stored as a predicate of type
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'Var</span></span><span class="main"><span class="main">,</span></span><span class="tfree"><span class="tfree">'Val</span></span><span class="main"><span class="main">)</span></span> Mem <span class="main"><span class="main">⇒</span></span> bool"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or even <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'Var</span></span><span class="main"><span class="main">,</span></span><span class="tfree"><span class="tfree">'Val</span></span><span class="main"><span class="main">)</span></span> Mem set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), because we need to be 
  able to identify each individual predicate and for each predicate identify all of the
  variables in it, so we can discard the right predicates each time a variable becomes unstable.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'bexp</span> preds <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'bexp</span> set"</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_lang_no_dma <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">mem</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="bound">mem</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_types <span class="main">=</span>
  sifum_lang_no_dma <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span></span> <span class="quoted"><span class="free">aexp_vars</span></span> <span class="quoted"><span class="free">bexp_vars</span></span> <span class="main">+</span> sifum_security <span class="quoted"><span class="free">dma</span></span> <span class="quoted"><span class="free">𝒞_vars</span></span> <span class="quoted"><span class="free">𝒞</span></span> <span class="quoted">eval<span class="hidden">⇩</span><sub>w</sub></span> <span class="quoted">undefined</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒞_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> set"</span></span> <span class="main">+</span>
  <span class="comment1">(* we need to be able to negate predicates, when we explore the ELSE branch of an IF *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bexp_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'BExp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bexp_neg_negates<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="bound">mem</span> <span class="main">(</span><span class="free">bexp_neg</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="bound">mem</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="comment1">(* we need to be able to compute a valid postcondition after an assignment *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">assign_post</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'BExp</span> preds"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assign_post_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> pred <span class="free">P</span> <span class="bound">mem</span> <span class="main">⟹</span> pred <span class="main">(</span><span class="free">assign_post</span> <span class="free">P</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">mem</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">mem</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dma_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'BExp</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dma_correct<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">dma_type</span> <span class="free">x</span><span class="main">.</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="bound">e</span><span class="main">)</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 𝒞_vars_correct<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">bexp_vars</span> <span class="main">`</span> <span class="free">dma_type</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pred_False</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'BExp</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred_False_is_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">pred_False</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bexp_vars_pred_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="free">pred_False</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  

<span class="comment1">(* a more specialised form of the above locale useful for the examples that provides
   a brain-dead instantiation for the assignment postcondition transformer *)</span>
<span class="keyword1"><span class="command">locale</span></span> sifum_types_assign <span class="main">=</span>
  sifum_lang_no_dma <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span></span> <span class="quoted"><span class="free">aexp_vars</span></span> <span class="quoted"><span class="free">bexp_vars</span></span> <span class="main">+</span> sifum_security <span class="quoted"><span class="free">dma</span></span> <span class="quoted"><span class="free">𝒞_vars</span></span> <span class="quoted"><span class="free">𝒞</span></span> <span class="quoted">eval<span class="hidden">⇩</span><sub>w</sub></span> <span class="quoted">undefined</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒞_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> set"</span></span> <span class="main">+</span>
  <span class="comment1">(* we need to be able to negate predicates, when we explore the ELSE branch of an IF *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bexp_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'BExp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bexp_neg_negates<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="bound">mem</span> <span class="main">(</span><span class="free">bexp_neg</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="bound">mem</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dma_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'BExp</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dma_correct<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">dma_type</span> <span class="free">x</span><span class="main">.</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="bound">e</span><span class="main">)</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 𝒞_vars_correct<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">bexp_vars</span> <span class="main">`</span> <span class="free">dma_type</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pred_False</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'BExp</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred_False_is_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">pred_False</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bexp_vars_pred_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="free">pred_False</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="comment1">(* we need to be able to say "variable x has value e" when we assign (the evaluation of e) to x *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bexp_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'BExp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bexp_assign_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span> <span class="bound">e</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="bound">mem</span> <span class="main">(</span><span class="free">bexp_assign</span> <span class="bound">x</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">mem</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bexp_assign_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">bexp_vars</span> <span class="main">(</span><span class="free">bexp_assign</span> <span class="bound">x</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">aexp_vars</span> <span class="bound">e</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="comment1">(* things needed by both sifum_types_assign and sifum_types, before we prove the former a sublocale *)</span>
<span class="keyword1"><span class="command">context</span></span> sifum_lang_no_dma <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">stable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">∪</span> snd <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">add_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'BExp</span> preds"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">+⇩</span>_ _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">+⇩</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TypeSystem-add_pred_subset"><span class="command">lemma</span></span> add_pred_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">+⇩</span><span class="free">𝒮</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(* TODO: overloads the syntax for partial functions --- pick something else? *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">restrict_preds_to_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="tfree">'Var</span> set <span class="main">⇒</span> <span class="tfree">'BExp</span> preds"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">|`</span> _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">|`</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="free">bexp_vars</span> <span class="bound">e</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_types_assign <span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  the most simple assignment postcondition transformer
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">assign_post</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'BExp</span> preds"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assign_post</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> 
           <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main">(</span><span class="free">aexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">then</span> 
              <span class="main">(</span>restrict_preds_to_vars <span class="free"><span class="bound"><span class="entity">P</span></span></span>  <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span> 
            <span class="keyword1">else</span> 
              <span class="main">(</span>restrict_preds_to_vars <span class="free"><span class="bound"><span class="entity">P</span></span></span>  <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">bexp_assign</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>
 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sifum_types_assign <span class="main">⊆</span> sifum_types _ _ _ _ _ _ _ _ <span class="quoted">assign_post</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> bexp_neg_negates <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assign_post_def pred_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub>
       <span class="keyword1"><span class="command">unfolding</span></span> restrict_preds_to_vars_def
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ComplD fun_upd_other mem_Collect_eq singletonI subset_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> bexp_assign_eval
      <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ComplD fun_upd_other mem_Collect_eq singletonI subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dma_correct <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_correct pred_False_is_False bexp_vars_pred_False <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_types
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Redefined since Isabelle does not seem to be able to reuse the abbreviation from the old locale *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">mm_equiv_abv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mm_equiv_abv2</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> mm_equiv_abv <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">eval_abv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">eval_plus_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇧</span><sup>+</sup></span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↝<span class="hidden">⇧</span><sup>+</sup></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">no_eval_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span> 
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↝</span> <span class="keyword1">⊥</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="main"><span class="free">⊥</span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∉</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">low_indistinguishable_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Stmt <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∼</span>ı _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">∼</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> low_indistinguishable <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">vars_of_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> Type <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_of_type</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="main">(</span><span class="free">bexp_vars</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">type_wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> Type <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">type_wellformed</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vars_of_type <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊆</span> <span class="free">𝒞</span>"</span></span>

<span class="keyword1" id="TypeSystem-dma_type_wellformed"><span class="command">lemma</span></span> dma_type_wellformed <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"type_wellformed <span class="main">(</span><span class="free">dma_type</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_wellformed_def  𝒞_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_correct <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">to_total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'BExp</span> Type"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">to_total</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">then</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">dma_type</span> <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">types_wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">types_wellformed</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> type_wellformed <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="TypeSystem-to_total_type_wellformed"><span class="command">lemma</span></span> to_total_type_wellformed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"types_wellformed <span class="free">Γ</span> <span class="main">⟹</span>
  type_wellformed <span class="main">(</span>to_total <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def types_wellformed_def<span class="main">)</span>
  
<span class="keyword1" id="TypeSystem-Un_type_wellformed"><span class="command">lemma</span></span> Un_type_wellformed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">ts</span><span class="main">.</span> type_wellformed <span class="bound">t</span> <span class="main">⟹</span> type_wellformed <span class="main">(</span><span class="main">⋃</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_wellformed_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetCE<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">type_aexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'BExp</span> Type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> _ <span class="keyword1">∈</span> _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  type_aexpr <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>a</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="main">⋃</span> <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">aexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TypeSystem-type_aexprI"><span class="command">lemma</span></span> type_aexprI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span>  <span class="main">⋃</span> <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">aexp_vars</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> ssubst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-type_aexpr_type_wellformed"><span class="command">lemma</span></span> type_aexpr_type_wellformed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"types_wellformed <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span> <span class="main">⟹</span> type_wellformed <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> type_aexpr.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> ssubst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_type_wellformed<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> to_total_type_wellformed<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">inductive_cases</span></span> type_aexpr_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">type_bexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'BExp</span> Type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> _ <span class="keyword1">∈</span> _ "</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  type_bexpr <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="main">⋃</span> <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TypeSystem-type_bexprI"><span class="command">lemma</span></span> type_bexprI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span>  <span class="main">⋃</span> <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">bexp_vars</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> ssubst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_bexpr.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-type_bexpr_type_wellformed"><span class="command">lemma</span></span> type_bexpr_type_wellformed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"types_wellformed <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span> <span class="main">⟹</span> type_wellformed <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> type_bexpr.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> ssubst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_type_wellformed<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> to_total_type_wellformed<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">inductive_cases</span></span> type_bexpr_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Define a sufficient condition for a type to be stable, assuming the type is wellformed.
  
  We need this because there is no point tracking the fact that e.g. variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s data has
  a classification that depends on some control variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> might be
  the control variable for some other variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose value we've just assigned to
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can then go and be modified, since now the classification of
  the data in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> no longer depends on the value of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, instead it depends on
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s \emph{old} value, which has now been lost.
  
  Therefore, if a type depends on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> had better be stable.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">pred_stable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred_stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">type_stable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> Type <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">type_stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">.</span> pred_stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="TypeSystem-type_stable_is_sufficient"><span class="command">lemma</span></span> type_stable_is_sufficient<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>type_stable <span class="free">𝒮</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">mem</span> <span class="bound">mem'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> stable <span class="free">𝒮</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">mem'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="bound">mem</span><span class="main">)</span> <span class="main">`</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="bound">mem'</span><span class="main">)</span> <span class="main">`</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_wellformed_def image_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">mds_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mds_consistent</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">𝒞</span> <span class="main">∧</span> stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> pred_stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">add_anno_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∉</span> <span class="free">𝒞</span> <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="keyword1">else</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∉</span> <span class="free">𝒞</span> <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="keyword1">else</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∉</span> fst <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="keyword1">else</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∉</span> snd <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="keyword1">else</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">add_anno</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊕⇩</span>_ _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊕⇩</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">=</span> restrict_map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span>to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>add_anno_dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TypeSystem-add_anno_acq_AsmNoReadOrWrite_idemp"><span class="command">lemma</span></span> add_anno_acq_AsmNoReadOrWrite_idemp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span>Acq <span class="free">v</span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>5<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_anno_rel_AsmNoReadOrWrite_idemp"><span class="command">lemma</span></span> add_anno_rel_AsmNoReadOrWrite_idemp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">v</span> <span class="main">∉</span> dom <span class="free">Γ</span><span class="main">;</span> <span class="free">v</span> <span class="main">∉</span> fst <span class="free">𝒮</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span>Rel <span class="free">v</span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> dom <span class="free">Γ</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">v</span>
          <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="keyword1">then</span> the <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">dma_type</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> notE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_anno_acq_AsmNoReadOrWrite"><span class="command">lemma</span></span> add_anno_acq_AsmNoReadOrWrite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> notin <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> dom <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> <span class="free">𝒞</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span>Acq <span class="free">v</span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">v</span> <span class="main">↦</span> <span class="free">dma_type</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_anno_rel_AsmNoReadOrWrite"><span class="command">lemma</span></span> add_anno_rel_AsmNoReadOrWrite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> isin <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> dom <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> fst <span class="free">𝒮</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span>Rel <span class="free">v</span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">=</span> restrict_map <span class="free">Γ</span> <span class="main">(</span><span class="main">(</span>dom <span class="free">Γ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_anno_acq_AsmNoWrite_idemp"><span class="command">lemma</span></span> add_anno_acq_AsmNoWrite_idemp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span>Acq <span class="free">v</span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>5<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_anno_rel_AsmNoWrite_idemp"><span class="command">lemma</span></span> add_anno_rel_AsmNoWrite_idemp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">v</span> <span class="main">∉</span> dom <span class="free">Γ</span><span class="main">;</span> <span class="free">v</span> <span class="main">∉</span> snd <span class="free">𝒮</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span>Rel <span class="free">v</span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> dom <span class="free">Γ</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">v</span>
          <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="keyword1">then</span> the <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">dma_type</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> notE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_anno_acq_AsmNoWrite"><span class="command">lemma</span></span> add_anno_acq_AsmNoWrite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> notin <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> dom <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> <span class="free">𝒞</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span>Acq <span class="free">v</span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">v</span> <span class="main">↦</span> <span class="free">dma_type</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_anno_rel_AsmNoWrite"><span class="command">lemma</span></span> add_anno_rel_AsmNoWrite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> isin <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> dom <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> snd <span class="free">𝒮</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span>Rel <span class="free">v</span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> restrict_map <span class="free">Γ</span> <span class="main">(</span><span class="main">(</span>dom <span class="free">Γ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">add_anno_stable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="tfree">'Var</span> Stable"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_stable</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pred_entailment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">mem</span><span class="main">.</span> pred <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">mem</span> <span class="main">⟶</span> pred <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="bound">mem</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We give a predicate interpretation of subtype and then prove it has the correct
  semantic property.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subtype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> Type <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="tfree">'BExp</span> Type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≤:⇩</span>_ _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">≤:⇩</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">type_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> Type <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> Sec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">type_max</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">.</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High"</span></span>

<span class="keyword1" id="TypeSystem-type_stable_is_sufficient'"><span class="command">lemma</span></span> type_stable_is_sufficient'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>type_stable <span class="free">𝒮</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">mem</span> <span class="bound">mem'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> stable <span class="free">𝒮</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">mem'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> type_max <span class="free">t</span> <span class="bound">mem</span> <span class="main">=</span> type_max <span class="free">t</span> <span class="bound">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> type_stable_is_sufficient
  <span class="keyword1"><span class="command">unfolding</span></span> type_max_def image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub><span class="main">)</span>

<span class="keyword1" id="TypeSystem-subtype_sound"><span class="command">lemma</span></span> subtype_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">mem</span><span class="main">.</span> pred <span class="free">P</span> <span class="bound">mem</span> <span class="main">⟶</span> type_max <span class="free">t</span> <span class="bound">mem</span> <span class="main">≤</span> type_max <span class="free">t'</span> <span class="bound">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtype_def pred_entailment_def pred_def type_max_def less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-subtype_complete"><span class="command">lemma</span></span> subtype_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> pred <span class="free">P</span> <span class="bound">mem</span> <span class="main">⟹</span> type_max <span class="free">t</span> <span class="bound">mem</span> <span class="main">≤</span> type_max <span class="free">t'</span> <span class="bound">mem</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subtype_def pred_entailment_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">t'</span><span class="main">)</span> <span class="skolem">mem</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="skolem">mem</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> tmax<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="skolem">mem</span> <span class="main">≤</span> type_max <span class="free">t'</span> <span class="skolem">mem</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">t'</span> <span class="skolem">mem</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t'</span> <span class="skolem">mem</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> type_max_def pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> tmax <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="skolem">mem</span> <span class="main">≤</span> Low"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="skolem">mem</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_eq_Sec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pred <span class="free">t</span> <span class="skolem">mem</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> type_max_def pred_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-subtype_correct"><span class="command">lemma</span></span> subtype_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t'</span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">mem</span><span class="main">.</span> pred <span class="free">P</span> <span class="bound">mem</span> <span class="main">⟶</span> type_max <span class="free">t</span> <span class="bound">mem</span> <span class="main">≤</span> type_max <span class="free">t'</span> <span class="bound">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtype_sound<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtype_complete<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">type_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> Type <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="tfree">'BExp</span> Type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">=:⇩</span>_ _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">=:⇩</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≤:⇩</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">≤:⇩</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  

<span class="keyword1" id="TypeSystem-subtype_refl"><span class="command">lemma</span></span> subtype_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtype_def pred_entailment_def pred_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-type_equiv_refl"><span class="command">lemma</span></span> type_equiv_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=:⇩</span><span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_equiv_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">anno_type_stable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">anno_type_stable</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Rel <span class="bound">v</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span>
                                 <span class="main">(</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∉</span> add_anno_dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">)</span> <span class="main">⟶</span>
                                    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> <span class="bound">v</span> <span class="main">∉</span> vars_of_type <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                          <span class="main">|</span> <span class="main">(</span>Acq <span class="bound">v</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> 
                                    <span class="main">(</span><span class="bound">v</span> <span class="main">∉</span> <span class="free">𝒞</span> <span class="main">∧</span> <span class="bound">v</span><span class="main">∈</span>add_anno_dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">-</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">⟶</span>
                                      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞_vars</span> <span class="bound">v</span><span class="main">.</span> stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">anno_type_sec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span>  <span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">anno_type_sec</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Rel <span class="bound">v</span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">⇒</span>
                                <span class="main">(</span><span class="bound">v</span> <span class="main">∈</span> add_anno_dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">⟶</span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free">dma_type</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
                                          <span class="main">|</span>  <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">types_stable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">types_stable</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> type_stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">tyenv_wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tyenv_wellformed</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> 
      mds_consistent <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
      types_wellformed <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∧</span> types_stable <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span>"</span></span>

<span class="keyword1" id="TypeSystem-subset_entailment"><span class="command">lemma</span></span> subset_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-pred_entailment_refl"><span class="command">lemma</span></span> pred_entailment_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_entailment_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-pred_entailment_mono"><span class="command">lemma</span></span> pred_entailment_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">P''</span> <span class="main">⟹</span> <span class="free">P''</span> <span class="main">⊢</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>
  
<span class="keyword1" id="TypeSystem-type_equiv_subset"><span class="command">lemma</span></span> type_equiv_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"type_equiv <span class="free">t</span> <span class="free">P</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">P'</span> <span class="main">⟹</span> type_equiv <span class="free">t</span> <span class="free">P'</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_equiv_def subtype_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">context_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">=:⇩</span>_ _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">=:⇩</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">≡</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">∧</span>
                           <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main">.</span> type_equiv <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TypeSystem-context_equiv_refl"><span class="command">lemma</span></span> context_equiv_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"context_equiv <span class="free">Γ</span> <span class="free">P</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> context_equiv_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-context_equiv_subset"><span class="command">lemma</span></span> context_equiv_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"context_equiv <span class="free">Γ</span> <span class="free">P</span> <span class="free">Γ'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">P'</span> <span class="main">⟹</span> context_equiv <span class="free">Γ</span> <span class="free">P'</span> <span class="free">Γ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> context_equiv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> type_equiv_subset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-pred_entailment_trans"><span class="command">lemma</span></span> pred_entailment_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">P''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">P''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-pred_un"><span class="command">lemma</span></span> pred_un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">P'</span><span class="main">)</span> <span class="free">mem</span> <span class="main">=</span> <span class="main">(</span>pred <span class="free">P</span> <span class="free">mem</span> <span class="main">∧</span> pred <span class="free">P'</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="TypeSystem-pred_entailment_un"><span class="command">lemma</span></span> pred_entailment_un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">P''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">P'</span> <span class="main">∪</span> <span class="free">P''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> pred_entailment_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-pred_entailment_mono_un"><span class="command">lemma</span></span> pred_entailment_mono_un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">P''</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">P'</span> <span class="main">∪</span> <span class="free">P''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="TypeSystem-subtype_trans"><span class="command">lemma</span></span> subtype_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">≤:⇩</span><span class="free">P'</span> <span class="free">t''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t''</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P'</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t''</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtype_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pred_entailment_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pred_entailment_un<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pred_entailment_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_mono_un<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtype_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pred_entailment_trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pred_entailment_un<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="TypeSystem-type_equiv_trans"><span class="command">lemma</span></span> type_equiv_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"type_equiv <span class="free">t</span> <span class="free">P</span> <span class="free">t'</span> <span class="main">⟹</span> type_equiv <span class="free">t'</span> <span class="free">P'</span> <span class="free">t''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">⟹</span> type_equiv <span class="free">t</span> <span class="free">P</span> <span class="free">t''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_equiv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtype_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-context_equiv_trans"><span class="command">lemma</span></span> context_equiv_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"context_equiv <span class="free">Γ</span> <span class="free">P</span> <span class="free">Γ'</span> <span class="main">⟹</span> context_equiv <span class="free">Γ'</span> <span class="free">P'</span> <span class="free">Γ''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">⟹</span> context_equiv <span class="free">Γ</span> <span class="free">P</span> <span class="free">Γ''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> context_equiv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> type_equiv_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-un_pred_entailment_mono"><span class="command">lemma</span></span> un_pred_entailment_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">P'</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">P''</span> <span class="main">⟹</span> <span class="free">P'''</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P'''</span> <span class="main">∪</span> <span class="free">P'</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">P''</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pred_entailment_def pred_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="TypeSystem-subtype_entailment"><span class="command">lemma</span></span> subtype_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P'</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtype_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> un_pred_entailment_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="TypeSystem-type_equiv_entailment"><span class="command">lemma</span></span> type_equiv_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"type_equiv <span class="free">t</span> <span class="free">P</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">⟹</span> type_equiv <span class="free">t</span> <span class="free">P'</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_equiv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtype_entailment<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="TypeSystem-context_equiv_entailment"><span class="command">lemma</span></span> context_equiv_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"context_equiv <span class="free">Γ</span> <span class="free">P</span> <span class="free">Γ'</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">⟹</span> context_equiv <span class="free">Γ</span> <span class="free">P'</span> <span class="free">Γ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> context_equiv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> type_equiv_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  
  
<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">has_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _<span class="keyword1">,</span>_<span class="keyword1">,</span>_ <span class="keyword1">{</span>_<span class="keyword1">}</span> _<span class="keyword1">,</span>_<span class="keyword1">,</span>_"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  stop_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span>Stop<span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span> <span class="main">|</span>
  skip_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span>Skip<span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span> <span class="main">|</span>
  assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> vars_of_type <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">=</span> restrict_preds_to_vars <span class="main">(</span><span class="free">assign_post</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">v</span><span class="main">}</span><span class="main">;</span> 
    <span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∉</span> snd <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="main">(</span>to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> 
                                      <span class="main">(</span>to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">(</span><span class="free">dma_type</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span>"</span></span> <span class="main">|</span> 
  assign<span class="hidden">⇩</span><sub>1</sub> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free">𝒞</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≤:⇩</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free">dma_type</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span> 
     <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">=</span> restrict_preds_to_vars <span class="main">(</span><span class="free">assign_post</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>  <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">v</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span>"</span></span> <span class="main">|</span>
  assign<span class="hidden">⇩</span><sub>2</sub> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>  type_stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">=</span> restrict_preds_to_vars <span class="main">(</span><span class="free">assign_post</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="bound">v</span><span class="main">}</span><span class="main">;</span> 
     <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> snd <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≤:⇩</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">(</span><span class="free">dma_type</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="free">has_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span>"</span></span> <span class="main">|</span>
  if_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> 
     <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+⇩</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+⇩</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="main">(</span><span class="free">bexp_neg</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P''</span></span></span><span class="main">;</span> 
     context_equiv <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'''</span></span></span><span class="main">;</span> context_equiv <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span> <span class="free"><span class="bound"><span class="entity">P''</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'''</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">P'''</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P''</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">P'''</span></span></span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ'''</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="free"><span class="bound"><span class="entity">P'''</span></span></span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="free"><span class="bound"><span class="entity">P''</span></span></span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ'''</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="free"><span class="bound"><span class="entity">P'''</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span> If <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'''</span></span></span>"</span></span> <span class="main">|</span> 
  while_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+⇩</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span> While <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span> <span class="main">|</span>
  anno_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊕⇩</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="main">=</span> add_anno_stable <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">=</span> restrict_preds_to_vars <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="bound">v</span><span class="main">}</span><span class="main">;</span>
                 <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P''</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> Stop <span class="main">;</span>
                 <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">(</span>to_total <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                 anno_type_stable <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">;</span> anno_type_sec <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">@[</span><span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">]</span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P''</span></span></span>"</span></span> <span class="main">|</span>
  seq_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P''</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮''</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P''</span></span></span>"</span></span> <span class="main">|</span>
  sub <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">;</span> context_equiv <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">;</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub>'</span></span></span><span class="main">)</span><span class="main">;</span> context_equiv <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub>'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub>'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub>'</span></span></span>"</span></span> <span class="main">|</span>
 await_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> 
     <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+⇩</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">{</span></span> Await <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span>"</span></span>

<span class="keyword1" id="TypeSystem-sub'"><span class="command">lemma</span></span> sub'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> context_equiv <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">𝒮</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">𝒮</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">𝒮'</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">𝒮'</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span><span class="main">;</span>
    context_equiv <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">;</span>
    <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
    <span class="free">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⊢</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">;</span>
    <span class="main">⊢</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⊢</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>

<span class="keyword1" id="TypeSystem-assign"><span class="command">lemma</span></span> assign<span class="hidden">⇩</span><sub>2</sub>_helper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span><span class="main">;</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">𝒮</span> <span class="free">P'</span><span class="main">⟧</span> <span class="main">⟹</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_upd_triv<span class="main">)</span>

<span class="keyword1" id="TypeSystem-conc'"><span class="command">lemma</span></span> conc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">;</span> 
    <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="free">x</span> <span class="main">∈</span> dom <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> 
    type_equiv <span class="main">(</span>the <span class="main">(</span><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">t</span><span class="main">;</span> 
    type_wellformed <span class="free">t</span><span class="main">;</span> 
    type_stable <span class="free">𝒮</span> <span class="free">t</span>  <span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="main">⊢</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> sub<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> context_equiv_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> types_wellformed_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> types_stable_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-tyenv_wellformed_subset"><span class="command">lemma</span></span> tyenv_wellformed_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟹</span> tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-if_type'"><span class="command">lemma</span></span> if_type'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span><span class="main">;</span> 
    <span class="free">P</span> <span class="main">⊢</span> <span class="free">t</span><span class="main">;</span> 
    <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="main">(</span><span class="free">P</span> <span class="main">+⇩</span><span class="free">𝒮</span> <span class="free">e</span><span class="main">)</span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">;</span> 
    <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="main">(</span><span class="free">P</span> <span class="main">+⇩</span><span class="free">𝒮</span> <span class="main">(</span><span class="free">bexp_neg</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P''</span><span class="main">;</span> 
    <span class="free">P'''</span> <span class="main">⊆</span> <span class="free">P'</span> <span class="main">∩</span> <span class="free">P''</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> if_type<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> context_equiv_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> context_equiv_refl<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-skip_type'"><span class="command">lemma</span></span> skip_type'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ'</span><span class="main">;</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="free">𝒮'</span><span class="main">;</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span>Skip<span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> skip_type <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Some helper lemmas to discharge the assumption of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> anno_type<span class="antiquote"><span class="antiquote">}</span></span></span></span> rule.
›</span></span>
<span class="keyword1" id="TypeSystem-anno_type_helpers"><span class="command">lemma</span></span> anno_type_helpers <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="main">(</span>to_total <span class="main">(</span>add_anno <span class="free">Γ</span> <span class="free">𝒮</span> <span class="main">(</span><span class="free">buffer</span> <span class="keyword1">+=<span class="hidden">⇩</span><sub>m</sub></span> AsmNoWrite<span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="main">(</span>to_total <span class="main">(</span>add_anno <span class="free">Γ</span> <span class="free">𝒮</span> <span class="main">(</span><span class="free">buffer</span> <span class="keyword1">+=<span class="hidden">⇩</span><sub>m</sub></span> AsmNoReadOrWrite<span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def add_anno_def subtype_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing Soundness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following predicate is needed to exclude some pathological
  cases, that abuse the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Stop</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> command which is not allowed to
  occur in actual programs.›</span></span>


<span class="keyword1"><span class="command">inductive_cases</span></span> has_type_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> has_type_stop_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> Stop <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tyenv_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=</span>ı"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">=</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>type_max <span class="main">(</span>to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TypeSystem-type_max_dma_type"><span class="command">lemma</span></span> type_max_dma_type <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"type_max <span class="main">(</span><span class="free">dma_type</span> <span class="free">x</span><span class="main">)</span> <span class="free">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dma_correct <span class="keyword1"><span class="command">unfolding</span></span> type_max_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This result followed trivially for Mantel et al., but we need to know that the
  type environment is wellformed.
›</span></span>
<span class="keyword1" id="TypeSystem-tyenv_eq_sym'"><span class="command">lemma</span></span> tyenv_eq_sym'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"dom <span class="free">Γ</span> <span class="main">∩</span> <span class="free">𝒞</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> types_wellformed <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">Γ</span> <span class="main">∩</span> <span class="free">𝒞</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> a b <span class="keyword1"><span class="command">have</span></span> eq_𝒞<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def 𝒞_Low type_max_dma_type <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dma_type_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="free">Γ</span>"</span></span>
  
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Low"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="free">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this in_dom c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> types_wellformed_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars_of_type <span class="skolem">t</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_𝒞 <span class="keyword1"><span class="command">unfolding</span></span> type_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> t_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> type_max_def <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> in_dom t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_total <span class="free">Γ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> t_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"to_total <span class="free">Γ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma_type</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> dma_type_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-tyenv_eq_sym"><span class="command">lemma</span></span> tyenv_eq_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> tyenv_eq_sym'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
  
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">ℛ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">ℛ<span class="hidden">⇩</span><sub>1</sub>_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup>⇘</span>_<span class="keyword1">,</span>_<span class="keyword1">,</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Γ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">𝒮'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Stable"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">P'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> preds"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span> <span class="main">|</span>
  intro <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span> <span class="main">;</span> tyenv_wellformed <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span>
                      pred <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> pred <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> <span class="bound">x</span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> 
                    <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main"><span class="free">,</span></span><span class="free">𝒮'</span><span class="main"><span class="free">,</span></span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ℛ<span class="hidden">⇩</span><sub>3</sub>_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
                 <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
                 bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup>⇘</span>_<span class="keyword1">,</span>_<span class="keyword1">,</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">ℛ<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℛ<span class="hidden">⇩</span><sub>3</sub></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">lc<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">lc<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="free">ℛ<span class="hidden">⇩</span><sub>3</sub>_aux</span> <span class="bound">lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="bound">lc<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>1</sub> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span><span class="main">;</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">}</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
                      <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>3</sub> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span><span class="main">;</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">𝒮</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">}</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
                      <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">𝒮'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">P'</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span>"</span></span>

<span class="comment1">(* A weaker property than bisimulation to reason about the sub-relations of ℛ: *)</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">weak_bisim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel <span class="main">⇒</span>
                        <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">weak_bisim</span> <span class="free"><span class="bound"><span class="entity">𝒯<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">𝒯</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">mds'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span>
  <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">𝒯<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> 
                <span class="main">(</span><span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">𝒯</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">ℛ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">ℛ_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> Stable <span class="main">⇒</span> <span class="tfree">'BExp</span> preds <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup>⇘</span>_<span class="keyword1">,</span>_<span class="keyword1">,</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">𝒮</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Stable"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> preds"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main"><span class="free">,</span></span><span class="free">𝒮</span><span class="main"><span class="free">,</span></span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">lc</span></span></span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">lc</span></span></span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span>

<span class="comment1">(* Some eliminators for the above relations *)</span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ_elim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim' <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim' <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>
  <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> mds_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> tyenv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> low_mds_eq_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> is_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> is_readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> mds_consistent <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mds_consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> is_readable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoReadOrWrite"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       
      <span class="keyword1"><span class="command">with</span></span> in_dom leq  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> is_Low <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Sec_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> tyenv_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>         
      <span class="keyword3"><span class="command">assume</span></span> nin_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> is_Low <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> tyenv_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_dma_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_mem_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> low_mds_eq_dma<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(* ℛ meets the criteria of a "simple bisim"
   which can be used to simplify the establishment of a refinement relation *)</span>
<span class="keyword1" id="TypeSystem-bisim_simple_ℛ"><span class="command">lemma</span></span> bisim_simple_ℛ<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-bisim_simple_ℛ"><span class="command">lemma</span></span> bisim_simple_ℛ<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">lc</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="free">lc'</span> <span class="main">⟹</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">lc</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">lc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> bisim_simple_ℛ<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-bisim_simple_ℛ"><span class="command">lemma</span></span> bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">lc</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="free">lc'</span> <span class="main">⟹</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">lc</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">lc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> bisim_simple_ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(* To prove that ℛ is a bisimulation, we first show symmetry *)</span>

<span class="keyword1" id="TypeSystem-𝒞_eq_type_max_eq"><span class="command">lemma</span></span> 𝒞_eq_type_max_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"type_wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars_of_type <span class="free">t</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf 𝒞_eq <span class="keyword1"><span class="command">unfolding</span></span> type_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> type_max_def <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-vars_of_type_eq_type_max_eq"><span class="command">lemma</span></span> vars_of_type_eq_type_max_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars_of_type <span class="free">t</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> type_max_def <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>1</sub> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sym_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">mds</span> <span class="skolem">mem</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span>
  <span class="keyword3"><span class="command">assume</span></span> in_ℛ<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">𝒮</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  stuff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span><span class="skolem">c</span><span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>  <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="skolem">mem</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="skolem">mem'</span>"</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="skolem">mem</span>"</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="skolem">mem'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem</span> <span class="main">≤</span> <span class="free">dma</span> <span class="skolem">mem</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> stuff <span class="keyword1"><span class="command">have</span></span> stuff'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mem'</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="skolem">mem</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tyenv_eq_sym<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="skolem">mem'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> in_ℛ<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="skolem">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_dma_eq stuff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ</span><span class="main">.</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem</span> <span class="main">=</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"type_wellformed <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="skolem">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_ℛ<span class="hidden">⇩</span><sub>1</sub> ℛ<span class="hidden">⇩</span><sub>1</sub>_mem_eq 𝒞_Low stuff
        <span class="keyword1"><span class="command">unfolding</span></span> low_mds_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem</span> <span class="main">=</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 𝒞_eq_type_max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> stuff<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> stuff stuff'
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sym_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_sym ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub> symD<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ℛ_mds"><span class="command">lemma</span></span> ℛ_mds <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">mds</span> <span class="main">=</span> <span class="free">mds'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ_elim'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim'<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="TypeSystem-ℛ_sym"><span class="command">lemma</span></span> ℛ_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sym_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ℛ_mds <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">𝒮</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">𝒮</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_sym <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_sym <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sym_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Next, we show that the relations are closed under globally consistent changes *)</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_closed_glob_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>1</sub> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">assume</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> A_updates_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v'</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A_updates_dma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A_updates_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> R1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">𝒮</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> Γ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
                                      <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                                      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">from</span></span> Γ_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> stable_not_written<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> stable <span class="skolem">𝒮</span> <span class="bound">x</span> <span class="main">⟶</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def stable_def var_asm_not_written_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A_updates_vars <span class="keyword1"><span class="command">have</span></span> stable_unchanged<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> stable <span class="skolem">𝒮</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                           stable_unchanged<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> stable <span class="skolem">𝒮</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> stable_not_written A_updates_dma 
  <span class="keyword1"><span class="command">have</span></span> stable_unchanged_dma<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> stable <span class="skolem">𝒮</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">dma</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> tyenv_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Γ_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"var_asm_not_written <span class="skolem">mds</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def var_asm_not_written_def stable_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A_updates_vars <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> in_dom a <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> Γ<span class="hidden">⇩</span><sub>x</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="hidden">⇩</span><sub>x</sub>_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> t<span class="hidden">⇩</span><sub>x</sub>_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span>  <span class="main">=</span> type_max <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">from</span></span> Γ<span class="hidden">⇩</span><sub>x</sub> Γ_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t<span class="hidden">⇩</span><sub>x</sub>_stable<span class="main">:</span> <span class="quoted"><span class="quoted">"type_stable <span class="skolem">𝒮</span> <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="hidden">⇩</span><sub>x</sub>_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_stable_def types_wellformed_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> t<span class="hidden">⇩</span><sub>x</sub>_stable t<span class="hidden">⇩</span><sub>x</sub>_wellformed stable_unchanged<span class="hidden">⇩</span><sub>1</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> type_stable_is_sufficient'
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>x</sub>_Low' <span class="keyword1"><span class="command">have</span></span> t<span class="hidden">⇩</span><sub>x</sub>_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Γ<span class="hidden">⇩</span><sub>x</sub> Γ_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def to_total_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> nin_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> is_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> A_updates_sec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds</span> AsmNoReadOrWrite"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> nin_dom Γ_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def stable_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> sec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="main">≤</span> <span class="free">dma</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ballI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Γ_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"var_asm_not_written <span class="skolem">mds</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def var_asm_not_written_def stable_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A_updates_dma <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> in_dom <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> Γ<span class="hidden">⇩</span><sub>x</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> t<span class="hidden">⇩</span><sub>x</sub>_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span>  <span class="main">=</span> type_max <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">from</span></span> Γ<span class="hidden">⇩</span><sub>x</sub> Γ_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t<span class="hidden">⇩</span><sub>x</sub>_stable<span class="main">:</span> <span class="quoted"><span class="quoted">"type_stable <span class="skolem">𝒮</span> <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="hidden">⇩</span><sub>x</sub>_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t<span class="hidden">⇩</span><sub>x</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_stable_def types_wellformed_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> t<span class="hidden">⇩</span><sub>x</sub>_stable t<span class="hidden">⇩</span><sub>x</sub>_wellformed stable_unchanged<span class="hidden">⇩</span><sub>1</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_stable_is_sufficient'
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> Γ<span class="hidden">⇩</span><sub>x</sub> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">≤</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> "</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> in_dom readable Γ_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword1"><span class="command">from</span></span> stable_unchanged<span class="hidden">⇩</span><sub>1</sub> stable_unchanged<span class="hidden">⇩</span><sub>2</sub> Γ_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> ballI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub><span class="main"><span class="keyword3">,</span></span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def stable_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> pred <span class="skolem">P</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> pred <span class="skolem">P</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1"><span class="command">with</span></span> Γ_props tyenv_eq' sec'
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_closed_glob_consistent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">assume</span></span> in_ℛ<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A_modifies_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v'</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A_modifies_dma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A_modifies_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span>"</span></span>
  <span class="comment1">(* do a bit of massaging to get the goal state set-up nicely for the induction rule *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lc<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≡</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lc<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≡</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> lc<span class="hidden">⇩</span><sub>1</sub>_def lc<span class="hidden">⇩</span><sub>2</sub>_def in_ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc<span class="hidden">⇩</span><sub>1</sub></span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="skolem">lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this lc<span class="hidden">⇩</span><sub>1</sub>_def lc<span class="hidden">⇩</span><sub>2</sub>_def A_modifies_vars A_modifies_dma A_modifies_sec
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">mds</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="skolem">mds</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_closed_glob_consistent intro<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>3</sub> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>3</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TypeSystem-ℛ_closed_glob_consistent"><span class="command">lemma</span></span> ℛ_closed_glob_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="main">(</span>ℛ <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> ℛ_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">assume</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A_modifies_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v'</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A_modifies_dma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A_modifies_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span>"</span></span>  
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_closed_glob_consistent <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
    <span class="keyword1"><span class="command">using</span></span> R1 A_modifies_vars A_modifies_dma A_modifies_sec
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">assume</span></span> R3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A_modifies_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v'</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A_modifies_dma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="main">(</span><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="skolem">mds</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A_modifies_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒞</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">⟩</span> "</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_closed_glob_consistent <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
    <span class="keyword1"><span class="command">using</span></span> R3 A_modifies_vars A_modifies_dma A_modifies_sec
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* It now remains to show that steps of the first of two related configurations
    can be matched by the second: *)</span>

<span class="comment1">(* Some technical lemmas: *)</span>
<span class="keyword1" id="TypeSystem-mode_update_add_anno"><span class="command">lemma</span></span> mode_update_add_anno<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">⟹</span> 
   mds_consistent <span class="main">(</span>update_modes <span class="free">upd</span> <span class="free">mds</span><span class="main">)</span> 
                  <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span> 
                  <span class="main">(</span>add_anno_stable <span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span> 
                  <span class="main">(</span><span class="free">P</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="main">(</span>add_anno_stable <span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">upd</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> v m<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def mds_consistent_def stable_def restrict_preds_to_vars_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> v m<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def mds_consistent_def stable_def restrict_preds_to_vars_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_anno_acq_GuarNoReadOrWrite"><span class="command">lemma</span></span> add_anno_acq_GuarNoReadOrWrite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">+=<span class="hidden">⇩</span><sub>m</sub></span> GuarNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse prod.collapse<span class="main">)</span>

<span class="keyword1" id="TypeSystem-add_anno_rel_GuarNoReadOrWrite"><span class="command">lemma</span></span> add_anno_rel_GuarNoReadOrWrite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">-=<span class="hidden">⇩</span><sub>m</sub></span> GuarNoReadOrWrite<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse<span class="main">)</span>

<span class="keyword1" id="TypeSystem-add_anno_acq_GuarNoWrite"><span class="command">lemma</span></span> add_anno_acq_GuarNoWrite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">+=<span class="hidden">⇩</span><sub>m</sub></span> GuarNoWrite<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse prod.collapse<span class="main">)</span>

<span class="keyword1" id="TypeSystem-add_anno_rel_GuarNoWrite"><span class="command">lemma</span></span> add_anno_rel_GuarNoWrite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">-=<span class="hidden">⇩</span><sub>m</sub></span> GuarNoWrite<span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse<span class="main">)</span>

<span class="keyword1" id="TypeSystem-dom_add_anno_rel"><span class="command">lemma</span></span> dom_add_anno_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">-=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">-=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Γ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def restrict_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-types_wellformed_mode_update"><span class="command">lemma</span></span> types_wellformed_mode_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"types_wellformed <span class="free">Γ</span> <span class="main">⟹</span>
   types_wellformed <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> types_wellformed_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">upd</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> v t v' m<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v'</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">∨</span> <span class="improper">v'</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">force</span> <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v'</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">∨</span> <span class="improper">v'</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> dom_add_anno_rel<span class="main">[</span><span class="operator">THEN</span> bspec<span class="main">,</span> <span class="operator">OF</span> domI<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domI option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="comment1">(* TODO: consider putting this proof into Isar so we can explain the reasoning behind the
   anno_type_stable predicate *)</span>
<span class="keyword1" id="TypeSystem-types_stable_mode_update"><span class="command">lemma</span></span> types_stable_mode_update<span class="main">:</span>
   <span class="quoted"><span class="quoted">"types_stable <span class="free">Γ</span> <span class="free">𝒮</span> <span class="main">⟹</span> types_wellformed <span class="free">Γ</span> <span class="main">⟹</span> anno_type_stable <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">upd</span>
    <span class="main">⟹</span> types_stable <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span> <span class="main">(</span>add_anno_stable <span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> types_stable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> x c f C<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">upd</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> v m<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">∨</span> <span class="improper">v</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_correct
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  anno_type_stable_def stable_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">∨</span> <span class="improper">v</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_correct
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> anno_type_stable_def stable_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> v m<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="improper">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="improper">C</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
   <span class="keyword1"><span class="command">using</span></span> dom_add_anno_rel
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> anno_type_stable_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def types_wellformed_def type_wellformed_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_correct
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UN_I contra_subsetD domI option.sel<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def types_wellformed_def type_wellformed_def<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_correct
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UN_I contra_subsetD domI option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> anno_type_stable_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def types_wellformed_def type_wellformed_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UN_I contra_subsetD domI option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> domI option.sel snd_conv subsetD type_wellformed_def types_wellformed_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> anno_type_stable_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> domI option.sel snd_conv subsetD type_wellformed_def types_wellformed_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> domI option.sel snd_conv subsetD type_wellformed_def types_wellformed_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
     
     
<span class="keyword1" id="TypeSystem-tyenv_wellformed_mode_update"><span class="command">lemma</span></span> tyenv_wellformed_mode_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">⟹</span> anno_type_stable <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">upd</span> <span class="main">⟹</span>
   tyenv_wellformed <span class="main">(</span>update_modes <span class="free">upd</span> <span class="free">mds</span><span class="main">)</span> 
                  <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span> 
                  <span class="main">(</span>add_anno_stable <span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span> 
                  <span class="main">(</span><span class="free">P</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="main">(</span>add_anno_stable <span class="free">𝒮</span> <span class="free">upd</span><span class="main">)</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mode_update_add_anno<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> types_wellformed_mode_update<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> types_stable_mode_update<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="TypeSystem-stop_cxt"><span class="command">lemma</span></span> stop_cxt <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span> <span class="main">;</span> <span class="free">c</span> <span class="main">=</span> Stop <span class="main">⟧</span> <span class="main">⟹</span> 
  context_equiv <span class="free">Γ</span> <span class="free">P</span> <span class="free">Γ'</span> <span class="main">∧</span> <span class="free">𝒮'</span> <span class="main">=</span> <span class="free">𝒮</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">P'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ'</span> <span class="free">𝒮</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> context_equiv_trans context_equiv_entailment pred_entailment_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-tyenv_wellformed_preds_update"><span class="command">lemma</span></span> tyenv_wellformed_preds_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">=</span> <span class="free">P''</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free">𝒮</span> <span class="bound">v</span><span class="main">}</span> <span class="main">⟹</span>
  tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">⟹</span> tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def add_pred_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="TypeSystem-mds_consistent_preds_tyenv_update"><span class="command">lemma</span></span> mds_consistent_preds_tyenv_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">=</span> <span class="free">P''</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free">𝒮</span> <span class="bound">v</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">⟹</span>
  mds_consistent <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">⟹</span> mds_consistent <span class="free">mds</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">v</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">𝒮</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def add_pred_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="TypeSystem-pred_preds_update"><span class="command">lemma</span></span> pred_preds_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> P'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">=</span> <span class="main">(</span><span class="free">assign_post</span> <span class="free">P</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free">𝒮</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred_P<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred <span class="free">P'</span> <span class="free">mem'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> P'_def <span class="keyword1"><span class="command">have</span></span> P'_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊆</span> <span class="free">assign_post</span> <span class="free">P</span> <span class="free">x</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def add_pred_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="main">(</span><span class="free">assign_post</span> <span class="free">P</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_post_valid pred_P mem'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> P'_def' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-types_wellformed_update"><span class="command">lemma</span></span> types_wellformed_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"types_wellformed <span class="free">Γ</span> <span class="main">⟹</span> type_wellformed <span class="free">t</span> <span class="main">⟹</span> types_wellformed <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> types_wellformed_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-types_stable_update"><span class="command">lemma</span></span> types_stable_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"types_stable <span class="free">Γ</span> <span class="free">𝒮</span> <span class="main">⟹</span> type_stable <span class="free">𝒮</span> <span class="free">t</span> <span class="main">⟹</span> types_stable <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> types_stable_def<span class="main">)</span>
  
<span class="keyword1" id="TypeSystem-tyenv_wellformed_sub"><span class="command">lemma</span></span> tyenv_wellformed_sub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span>
  <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> tyenv_wellformed <span class="free">mds</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">𝒮</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
     tyenv_wellformed <span class="free">mds</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">𝒮</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">tyenv_sec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tyenv_sec</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> <span class="bound">x</span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1" id="TypeSystem-tyenv_sec_mode_update"><span class="command">lemma</span></span> tyenv_sec_mode_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span>  <span class="main">(</span>to_total <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="free">P''</span>  <span class="main">(</span>to_total <span class="free">Γ''</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> pred <span class="free">P''</span> <span class="free">mem</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="free">mds</span> AsmNoWrite<span class="main">,</span> <span class="free">mds</span> AsmNoReadOrWrite<span class="main">)</span> <span class="main">⟹</span>
    anno_type_sec <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="free">upd</span> <span class="main">⟹</span> <span class="free">𝒮''</span> <span class="main">=</span> add_anno_stable <span class="free">𝒮</span> <span class="free">upd</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">bexp_vars</span> <span class="bound">p</span><span class="main">.</span> stable <span class="free">𝒮</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">P''</span> <span class="main">=</span> <span class="free">P</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free">𝒮''</span> <span class="bound">v</span><span class="main">}</span> <span class="main">⟹</span>
    <span class="free">Γ''</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕⇩</span><span class="free">𝒮</span> <span class="free">upd</span> <span class="main">⟹</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="main">(</span>update_modes <span class="free">upd</span> <span class="free">mds</span><span class="main">)</span> <span class="free">Γ''</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">upd</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> v m<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> v m<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v</span> <span class="main">∈</span> <span class="free">mds</span> AsmNoWrite <span class="main">⟶</span> <span class="free">P''</span> <span class="main">=</span> <span class="free">P</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def to_total_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subtype_sound <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> anno_type_sec_def restrict_preds_to_vars_def stable_def<span class="main">)</span>


<span class="keyword1" id="TypeSystem-tyenv_sec_eq"><span class="command">lemma</span></span> tyenv_sec_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">x</span> <span class="main">⟹</span> types_wellformed <span class="free">Γ</span> <span class="main">⟹</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem</span> <span class="main">=</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> x<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> imp_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="free">Γ</span> <span class="improper">x</span><span class="main">)</span><span class="main">)</span> <span class="free">mem</span> <span class="main">=</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="free">Γ</span> <span class="improper">x</span><span class="main">)</span><span class="main">)</span> <span class="free">mem'</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> dma_𝒞 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒞_eq_type_max_eq <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> types_wellformed_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-context_equiv_tyenv_sec"><span class="command">lemma</span></span> context_equiv_tyenv_sec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"context_equiv <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span>
    pred <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> context_equiv_def type_equiv_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> x y<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="improper">x</span><span class="main">)</span><span class="main">)</span> <span class="free">mem</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subtype_sound<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-add_pred_entailment"><span class="command">lemma</span></span> add_pred_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">+⇩</span><span class="free">𝒮</span> <span class="free">p</span> <span class="main">⊢</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subset_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> add_pred_subset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="TypeSystem-preservation_no_await"><span class="command">lemma</span></span> preservation_no_await<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">;</span>
    <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span>  <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">;</span>
    no_await <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="main">∃</span> <span class="bound">Γ''</span> <span class="bound">𝒮''</span> <span class="bound">P''</span><span class="main">.</span> <span class="main">(</span><span class="main">⊢</span> <span class="bound">Γ''</span><span class="main">,</span><span class="bound">𝒮''</span><span class="main">,</span><span class="bound">P''</span> <span class="main">{</span> <span class="free">c'</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">)</span> <span class="main">∧</span> 
         <span class="main">(</span>tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">∧</span> pred <span class="free">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> 
           tyenv_wellformed <span class="free">mds'</span> <span class="bound">Γ''</span> <span class="bound">𝒮''</span> <span class="bound">P''</span> <span class="main">∧</span> 
           pred <span class="bound">P''</span> <span class="free">mem'</span> <span class="main">∧</span> 
           tyenv_sec <span class="free">mds'</span> <span class="bound">Γ''</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">mds</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main">)</span>
  
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>anno_type <span class="skolem">Γ''</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">upd</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upd_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹no_await <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">@[</span><span class="skolem">upd</span><span class="main">]</span><span class="main">)</span>›</span></span> no_await.cases <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"no_await <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> step anno_type<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'''</span></span> <span class="skolem"><span class="skolem">𝒮'''</span></span> <span class="skolem"><span class="skolem">P'''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'''</span><span class="main">,</span><span class="skolem">P'''</span> <span class="main">{</span> <span class="skolem">c'</span> <span class="main">}</span> <span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">∧</span> 
    <span class="main">(</span>tyenv_wellformed <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="main">∧</span> pred <span class="skolem">P''</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="free">mem</span> <span class="main">⟶</span>
       tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ'''</span> <span class="skolem">𝒮'''</span> <span class="skolem">P'''</span> <span class="main">∧</span> pred <span class="skolem">P'''</span> <span class="free">mem'</span> <span class="main">∧</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ'''</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tyenv_wellformed_mode_update<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P''</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> tyenv_sec <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> tyenv_sec_mode_update<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
           <span class="keyword1"><span class="command">using</span></span> anno_type pred <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
         <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> stop_type
  <span class="keyword1"><span class="command">with</span></span> stop_no_eval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> skip_type
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> skip_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">𝒮</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> upd <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> upd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upd tyenv_wellformed_preds_update assign<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>1</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>  <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tyenv_sec_eq<span class="main">[</span><span class="operator">OF</span> 𝒞_eq<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span> <span class="skolem">P</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> upd <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> tyenv_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>2<span class="main">)</span> type_aexpr_type_wellformed
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="var">?Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> types_wellformed_update <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> tyenv_wf <span class="keyword1"><span class="command">have</span></span> stable'<span class="main">:</span> <span class="quoted"><span class="quoted">"types_stable <span class="var">?Γ'</span> <span class="skolem">𝒮</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> types_stable_update
            assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tyenv_wf <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>4<span class="main">)</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds'</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mds_consistent_preds_tyenv_update<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> upd m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> wf' stable' this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>2</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟹</span> pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> pred p <span class="keyword1"><span class="command">have</span></span> pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="free">mem'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Γv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite›</span></span> upd wf <span class="keyword1"><span class="command">have</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤:⇩</span><span class="skolem">P'</span> <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> pred' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_max_dma_type subtype_correct
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Γv <span class="keyword1"><span class="command">have</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> sec upd <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite›</span></span> <span class="keyword1"><span class="command">have</span></span> f_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span> upd <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem</span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq_type_max_eq<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> Γv wf <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq<span class="main">)</span>     
      <span class="keyword1"><span class="command">from</span></span> neq Γv f_leq dma_eq f_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> ty wf p sec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">𝒮</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="comment1">(* this case follows from the same argument as assign<span class="hidden">⇩</span><sub>1</sub> *)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upd tyenv_wellformed_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">assume</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> readable'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword1"><span class="command">with</span></span> upd <span class="keyword1"><span class="command">have</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="free">mem'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="skolem">P'</span> <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> pred' Γv subtype_correct this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_max_dma_type <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v'</span><span class="main">∈</span><span class="free">𝒞_vars</span> <span class="skolem">v</span><span class="main">.</span> <span class="free">mem</span> <span class="bound">v'</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">v'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞_vars<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Γv assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf Γv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>›</span></span> upd <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem</span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars_of_type_eq_type_max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> sec Γv readable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> f_eq dma_eq Γv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">th</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">el</span> <span class="skolem">Γ''</span> <span class="skolem">P''</span> <span class="skolem">Γ'''</span> <span class="skolem">P'''</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> if_type<span class="main">(</span>13<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> if_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">th</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> if_type<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'''</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def add_pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="main">(</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span><span class="main">)</span> <span class="free">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def add_pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="free">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">el</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> if_type<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="free">bexp_neg</span> <span class="skolem">e</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="free">bexp_neg</span> <span class="skolem">e</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'''</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="free">bexp_neg</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def add_pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="main">(</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="free">bexp_neg</span> <span class="skolem">e</span><span class="main">)</span> <span class="free">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def add_pred_def bexp_neg_negates<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="free">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> while_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_type.while_type<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> stop_type<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> add_pred_entailment<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tyenv_wellformed_subset add_pred_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>seq_type <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">𝒮<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
    <span class="keyword1"><span class="command">with</span></span> seq_type <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_stop_elim<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> context_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"context_equiv <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒮<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">𝒮</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> entail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
             wf_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stop_cxt seq_type<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">𝒮<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> seq_type<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> context_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_imp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> entail<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pred_entailment_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_elim seq_type.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"no_await <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹no_await <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> no_await.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'''</span></span> <span class="skolem"><span class="skolem">𝒮'''</span></span> <span class="skolem"><span class="skolem">P'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'''</span><span class="main">,</span><span class="skolem">P'''</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">𝒮<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span>
      <span class="main">(</span>tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> 
       tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ'''</span> <span class="skolem">𝒮'''</span> <span class="skolem">P'''</span> <span class="main">∧</span> pred <span class="skolem">P'''</span> <span class="free">mem'</span> <span class="main">∧</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ'''</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step seq_type<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> seq_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">𝒮<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">𝒮<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">ultimately</span></span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ'''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">𝒮'</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="skolem"><span class="skolem">𝒮''</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="keyword2"><span class="keyword">where</span></span> stuff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span> <span class="main">{</span> <span class="skolem">c'</span> <span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span>
    <span class="main">(</span>tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span> <span class="main">⟶</span> 
     tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="main">∧</span> pred <span class="skolem">P''</span> <span class="free">mem'</span> <span class="main">∧</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ''</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem</span> <span class="main">⟹</span> 
             tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>5<span class="main">)</span> sub<span class="main">(</span>4<span class="main">)</span> tyenv_wellformed_sub <span class="keyword1"><span class="command">unfolding</span></span> pred_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> 
     <span class="keyword1"><span class="command">using</span></span> local.pred_def pred_entailment_def sub.hyps<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>3<span class="main">)</span> context_equiv_tyenv_sec <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒮''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">P''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_type.sub<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> stuff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> imp stuff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>await_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">c</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_await_no_await await_type.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TypeSystem-preservation_no_await_plus"><span class="command">lemma</span></span> preservation_no_await_plus<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">;</span>
    <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">;</span>
    no_await <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> 
     no_await <span class="free">c'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Γ''</span> <span class="bound">𝒮''</span> <span class="bound">P''</span><span class="main">.</span> <span class="main">(</span><span class="main">⊢</span> <span class="bound">Γ''</span><span class="main">,</span><span class="bound">𝒮''</span><span class="main">,</span><span class="bound">P''</span> <span class="main">{</span> <span class="free">c'</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span>tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">∧</span> pred <span class="free">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> 
     tyenv_wellformed <span class="free">mds'</span> <span class="bound">Γ''</span> <span class="bound">𝒮''</span> <span class="bound">P''</span> <span class="main">∧</span> pred <span class="bound">P''</span> <span class="free">mem'</span> <span class="main">∧</span> tyenv_sec <span class="free">mds'</span> <span class="bound">Γ''</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">𝒮</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> my_trancl_step_induct3<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> preservation_no_await no_await_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">using</span></span> preservation_no_await no_await_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="comment1">(* First we show that (roughly) typeability is preserved by evaluation steps *)</span>
<span class="keyword1" id="TypeSystem-preservation"><span class="command">lemma</span></span> preservation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span> <span class="bound">𝒮''</span> <span class="bound">P''</span><span class="main">.</span> <span class="main">(</span><span class="main">⊢</span> <span class="bound">Γ''</span><span class="main">,</span><span class="bound">𝒮''</span><span class="main">,</span><span class="bound">P''</span> <span class="main">{</span> <span class="free">c'</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">)</span> <span class="main">∧</span> 
                    <span class="main">(</span>tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">∧</span> pred <span class="free">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> 
                      tyenv_wellformed <span class="free">mds'</span> <span class="bound">Γ''</span> <span class="bound">𝒮''</span> <span class="bound">P''</span> <span class="main">∧</span> pred <span class="bound">P''</span> <span class="free">mem'</span> <span class="main">∧</span> tyenv_sec <span class="free">mds'</span> <span class="bound">Γ''</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typed eval
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">mds</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main">)</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>anno_type <span class="skolem">Γ''</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">upd</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upd_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> anno_type<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'''</span></span> <span class="skolem"><span class="skolem">𝒮'''</span></span> <span class="skolem"><span class="skolem">P'''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'''</span><span class="main">,</span><span class="skolem">P'''</span> <span class="main">{</span> <span class="skolem">c'</span> <span class="main">}</span> <span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">∧</span> 
    <span class="main">(</span>tyenv_wellformed <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="main">∧</span> pred <span class="skolem">P''</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="free">mem</span> <span class="main">⟶</span>
       tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ'''</span> <span class="skolem">𝒮'''</span> <span class="skolem">P'''</span> <span class="main">∧</span> pred <span class="skolem">P'''</span> <span class="free">mem'</span> <span class="main">∧</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ'''</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tyenv_wellformed_mode_update<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P''</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> tyenv_sec <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> tyenv_sec_mode_update<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
           <span class="keyword1"><span class="command">using</span></span> anno_type pred <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
         <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> stop_type
  <span class="keyword1"><span class="command">with</span></span> stop_no_eval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> skip_type
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> skip_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">𝒮</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> upd <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> upd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upd tyenv_wellformed_preds_update assign<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>1</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>  <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tyenv_sec_eq<span class="main">[</span><span class="operator">OF</span> 𝒞_eq<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span> <span class="skolem">P</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> upd <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> tyenv_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>2<span class="main">)</span> type_aexpr_type_wellformed
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="var">?Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> types_wellformed_update <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> tyenv_wf <span class="keyword1"><span class="command">have</span></span> stable'<span class="main">:</span> <span class="quoted"><span class="quoted">"types_stable <span class="var">?Γ'</span> <span class="skolem">𝒮</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> types_stable_update
            assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tyenv_wf <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>4<span class="main">)</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds'</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mds_consistent_preds_tyenv_update<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> upd m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> wf' stable' this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>2</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟹</span> pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> pred p <span class="keyword1"><span class="command">have</span></span> pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="free">mem'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Γv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite›</span></span> upd wf <span class="keyword1"><span class="command">have</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤:⇩</span><span class="skolem">P'</span> <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> pred' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_max_dma_type subtype_correct
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Γv <span class="keyword1"><span class="command">have</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> sec upd <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite›</span></span> <span class="keyword1"><span class="command">have</span></span> f_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span> upd <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem</span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq_type_max_eq<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> Γv wf <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq<span class="main">)</span>     
      <span class="keyword1"><span class="command">from</span></span> neq Γv f_leq dma_eq f_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> ty wf p sec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">𝒮</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="comment1">(* this case follows from the same argument as assign<span class="hidden">⇩</span><sub>1</sub> *)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upd tyenv_wellformed_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">assume</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> readable'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword1"><span class="command">with</span></span> upd <span class="keyword1"><span class="command">have</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="free">mem'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="skolem">P'</span> <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> pred' Γv subtype_sound<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_max_dma_type <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v'</span><span class="main">∈</span><span class="free">𝒞_vars</span> <span class="skolem">v</span><span class="main">.</span> <span class="free">mem</span> <span class="bound">v'</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">v'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem'</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞_vars<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Γv assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf Γv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>›</span></span> upd <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem</span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars_of_type_eq_type_max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> sec Γv readable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> f_eq dma_eq Γv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">th</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">el</span> <span class="skolem">Γ''</span> <span class="skolem">P''</span> <span class="skolem">Γ'''</span> <span class="skolem">P'''</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> if_type<span class="main">(</span>13<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> if_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">th</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> if_type<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'''</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def add_pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="main">(</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span><span class="main">)</span> <span class="free">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def add_pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="free">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">el</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> if_type<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="free">bexp_neg</span> <span class="skolem">e</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="free">bexp_neg</span> <span class="skolem">e</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'''</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="free">bexp_neg</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def add_pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟶</span> pred <span class="main">(</span><span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="free">bexp_neg</span> <span class="skolem">e</span><span class="main">)</span> <span class="free">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def add_pred_def bexp_neg_negates<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="free">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> while_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span><span class="skolem">c'</span><span class="main">}</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_type.while_type<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> stop_type<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> add_pred_entailment<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tyenv_wellformed_subset add_pred_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>seq_type <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">𝒮<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
    <span class="keyword1"><span class="command">with</span></span> seq_type <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_stop_elim<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> context_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"context_equiv <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒮<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">𝒮</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> entail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
             wf_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stop_cxt seq_type<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">𝒮<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> seq_type<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> context_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_imp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> entail<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pred_entailment_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_elim seq_type.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'''</span></span> <span class="skolem"><span class="skolem">𝒮'''</span></span> <span class="skolem"><span class="skolem">P'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'''</span><span class="main">,</span><span class="skolem">P'''</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">𝒮<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span>
      <span class="main">(</span>tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem</span> <span class="main">⟶</span> 
       tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ'''</span> <span class="skolem">𝒮'''</span> <span class="skolem">P'''</span> <span class="main">∧</span> pred <span class="skolem">P'''</span> <span class="free">mem'</span> <span class="main">∧</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ'''</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_type<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> seq_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">𝒮<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">𝒮<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">ultimately</span></span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ'''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">𝒮'</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="skolem"><span class="skolem">𝒮''</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="keyword2"><span class="keyword">where</span></span> stuff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span> <span class="main">{</span> <span class="skolem">c'</span> <span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span>
    <span class="main">(</span>tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span> <span class="main">⟶</span> 
     tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="main">∧</span> pred <span class="skolem">P''</span> <span class="free">mem'</span> <span class="main">∧</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ''</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem</span> <span class="main">⟹</span> 
             tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>5<span class="main">)</span> sub<span class="main">(</span>4<span class="main">)</span> tyenv_wellformed_sub <span class="keyword1"><span class="command">unfolding</span></span> pred_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> 
     <span class="keyword1"><span class="command">using</span></span> local.pred_def pred_entailment_def sub.hyps<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>3<span class="main">)</span> context_equiv_tyenv_sec <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒮''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">P''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_type.sub<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> stuff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> imp stuff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>await_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">c</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> await_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> preservation_no_await_plus<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">mds</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">mem</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c'</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">mds'</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">mem'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">𝒮</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">+⇩</span></span><span class="skolem"><span class="skolem">𝒮</span></span> <span class="skolem"><span class="skolem">e</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">𝒮'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟧</span> <span class="main">⟹</span> tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add_pred_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"pred_stable <span class="skolem">𝒮</span> <span class="skolem">e</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> tyenv_wellformed_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mds_consistent_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem</span> <span class="main">⟹</span> pred <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="free">mem</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add_pred_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"pred_stable <span class="skolem">𝒮</span> <span class="skolem">e</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">using</span></span> has_type.sub <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_equiv_refl pred_entailment_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> await_type_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span>Await <span class="free">b</span> <span class="free">ca</span><span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bisim_helper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bisim_helper</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"bisim_helper <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_mem_eq<span class="main">)</span>


<span class="keyword1" id="TypeSystem-ev"><span class="command">lemma</span></span> ev<span class="hidden">⇩</span><sub>A</sub>_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tyenv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> e_type<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subtype<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤:⇩</span><span class="free">P</span> <span class="main">(</span><span class="free">dma_type</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v</span> <span class="main">=</span> Low"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> in_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> subtype_sound<span class="main">[</span><span class="operator">OF</span> subtype<span class="main">]</span> pred <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> is_Low <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Sec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> e_type in_vars <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> type_aexpr.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Sec.exhaust <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tyenv_eq <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ev"><span class="command">lemma</span></span> ev<span class="hidden">⇩</span><sub>A</sub>_eq'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tyenv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> e_type<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subtype<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> in_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> subtype pred <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> Low"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def pred_entailment_def pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Sec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> e_type in_vars <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> type_aexpr.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Sec.exhaust <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tyenv_eq <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ev"><span class="command">lemma</span></span> ev<span class="hidden">⇩</span><sub>B</sub>_eq'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tyenv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> e_type<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subtype<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> in_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">bexp_vars</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> subtype pred <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> Low"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def pred_entailment_def pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"type_max <span class="free">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Sec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> e_type in_vars <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> type_bexpr.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Sec.exhaust <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tyenv_eq <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-R1_equiv_entailment"><span class="command">lemma</span></span> R1_equiv_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟹</span>  
  context_equiv <span class="free">Γ'</span> <span class="free">P'</span> <span class="free">Γ''</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">P''</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ''</span> <span class="free">𝒮'</span> <span class="free">P''</span> <span class="main">⟹</span>
   <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="free">Γ''</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sub context_equiv_refl pred_entailment_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-R3_equiv_entailment"><span class="command">lemma</span></span> R3_equiv_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟹</span> 
    context_equiv <span class="free">Γ'</span> <span class="free">P'</span> <span class="free">Γ''</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">P''</span> <span class="main">⟹</span> 
  <span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ''</span> <span class="free">𝒮'</span> <span class="free">P''</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ''</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sub context_equiv_refl tyenv_wellformed_subset subset_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sub context_equiv_refl tyenv_wellformed_subset subset_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-R_equiv_entailment"><span class="command">lemma</span></span> R_equiv_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">lc<span class="hidden">⇩</span><sub>1</sub></span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="free">lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> 
    context_equiv <span class="free">Γ'</span> <span class="free">P'</span> <span class="free">Γ''</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">P''</span> <span class="main">⟹</span> 
  <span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span> <span class="main">⟶</span> tyenv_wellformed <span class="bound">mds</span> <span class="free">Γ''</span> <span class="free">𝒮'</span> <span class="free">P''</span> <span class="main">⟹</span>
  <span class="free">lc<span class="hidden">⇩</span><sub>1</sub></span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ''</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P''</span></sub><span class="hidden">⇙</span> <span class="free">lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R1_equiv_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R3_equiv_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-context_equiv_tyenv_eq"><span class="command">lemma</span></span> context_equiv_tyenv_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tyenv_eq <span class="free">Γ</span> <span class="free">mem</span> <span class="free">mem'</span> <span class="main">⟹</span> context_equiv <span class="free">Γ</span> <span class="free">P</span> <span class="free">Γ'</span> <span class="main">⟹</span> pred <span class="free">P</span> <span class="free">mem</span> <span class="main">⟹</span> tyenv_eq <span class="free">Γ'</span> <span class="free">mem</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def to_total_def context_equiv_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_equiv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> subtype_trans subtype_sound
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI less_eq_Sec_def option.sel<span class="main">)</span>


<span class="keyword1" id="TypeSystem-ℛ_typed_step_no_await"><span class="command">lemma</span></span> ℛ_typed_step_no_await<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span> <span class="main">;</span>
  tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
        pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
     <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">;</span> no_await <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
                 <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>seq_type <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_type
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq_stop_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> seq_type <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"context_equiv <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">Γ''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒮</span> <span class="main">=</span> <span class="skolem">𝒮''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">P''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                                   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed  <span class="bound">mds</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮</span> <span class="skolem">P''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_cxt<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> seq_type<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> seq_type <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> seq_stop_eval<span class="hidden">⇩</span><sub>w</sub>  ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>1</sub>''_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹no_await <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"no_await <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_await.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> seq_type<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹no_await <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>2</sub>''_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_type.prems<span class="main">(</span>1<span class="main">)</span> seq_type.prems<span class="main">(</span>2<span class="main">)</span> seq_type.prems<span class="main">(</span>3<span class="main">)</span> seq_type.prems<span class="main">(</span>4<span class="main">)</span> seq_type.prems<span class="main">(</span>5<span class="main">)</span> c<span class="hidden">⇩</span><sub>1</sub>''_props
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub> seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub> seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> c<span class="hidden">⇩</span><sub>2</sub>''_props <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c<span class="hidden">⇩</span><sub>1</sub>''_props<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>anno_type <span class="skolem">Γ'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">upd</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>  
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ'</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> anno_type.hyps<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def pred_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> subtype_correct anno_type.hyps<span class="main">(</span>7<span class="main">)</span> a 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> less_eq_Sec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> anno_type.prems<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tyenv_wellformed_mode_update<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> 
        tyenv_sec <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> tyenv_sec_mode_update<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
           <span class="keyword1"><span class="command">using</span></span> anno_type pred <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
         <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹no_await <span class="main">(</span><span class="skolem">c</span><span class="main">@[</span><span class="skolem">upd</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"no_await <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_await.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> local.pred_def restrict_preds_to_vars_def upd_elim <span class="quoted"><span class="quoted">‹no_await <span class="skolem">c</span>›</span></span>
      <span class="comment1">(* TODO: cleanup *)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> update_modes <span class="skolem">upd</span> <span class="skolem">mds</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span><span class="main">)</span>›</span></span> mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="keyword1"><span class="command">try0</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> stop_type
  <span class="keyword1"><span class="command">with</span></span> stop_no_eval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>skip_type <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> skip_type <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> skip_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> skip_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="keyword2"><span class="keyword">and</span></span> unannotated <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted">Skip</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> E <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> old.prod.case skip_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* assign<span class="hidden">⇩</span><sub>1</sub> *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">𝒮</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> upd <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dma_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dma_𝒞 assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> is_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq_type_max_eq<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>›</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>6<span class="main">)</span> 
         <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def types_wellformed_def
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> option.sel<span class="main">)</span>
                
        <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> is_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> is_Low assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="bound">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="bound">mem</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> dma_eq <span class="keyword1"><span class="command">have</span></span> dma_v_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> is_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">using</span></span> is_Low assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ev<span class="hidden">⇩</span><sub>A</sub>_eq<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> dma_v_Low <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upd tyenv_wellformed_preds_update assign<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>1</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>1</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>  <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tyenv_sec_eq<span class="main">[</span><span class="operator">OF</span> 𝒞_eq<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ℛ'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assign<span class="hidden">⇩</span><sub>1</sub> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dma_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> ℛ' a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* assign<span class="hidden">⇩</span><sub>𝒞</sub> *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">𝒮</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> is_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> in_dom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Γv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> x_nin_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_dom Γv 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> Γv_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_dom Γv assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def types_wellformed_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel<span class="main">)</span>
        
      <span class="keyword1"><span class="command">with</span></span> x_nin_C <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars_of_type_eq_type_max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> is_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
      <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> is_Low assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> nin_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="bound">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="bound">mem</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ev<span class="hidden">⇩</span><sub>A</sub>_eq'<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> in_𝒞_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_𝒞 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> nin_dom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>7<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def stable_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> in_𝒞_vars <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊢</span> <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def pred_def pred_entailment_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> not_sym<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>8<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span>
            <span class="keyword1"><span class="command">using</span></span> dma_𝒞_vars <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="bound">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="bound">mem</span> <span class="skolem">v</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> not_sym<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>8<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>            
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upd tyenv_wellformed_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">assume</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> readable'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword1"><span class="command">with</span></span> upd <span class="keyword1"><span class="command">have</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="skolem">P'</span> <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> pred' Γv subtype_correct this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_max_dma_type <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v'</span><span class="main">∈</span><span class="free">𝒞_vars</span> <span class="skolem">v</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">v'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞_vars<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Γv assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf Γv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>›</span></span> upd <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars_of_type_eq_type_max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> sec Γv readable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> f_eq dma_eq Γv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ℛ'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> ℛ' a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* assign<span class="hidden">⇩</span><sub>2</sub> *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span> <span class="skolem">P</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_elim<span class="main">[</span><span class="operator">OF</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> x_nin_𝒞<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dma_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dma_𝒞 assign<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.assign eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
    
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> tyenv_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> is_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> to_total_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="var">?Γ'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq_type_max_eq<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>6<span class="main">)</span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> option.sel<span class="main">)</span>
           <span class="keyword1"><span class="command">using</span></span> x_nin_𝒞 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> this is_Low' neq neq<span class="main">[</span><span class="operator">THEN</span> not_sym<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> is_Low' neq
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> dma_eq <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> neq assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> t_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> wf_t<span class="main">:</span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> type_aexpr_type_wellformed assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>2<span class="main">)</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>6<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> t_Low' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> t_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 𝒞_eq_type_max_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fun_upd_other upd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">assume</span></span> in_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> t_Low in_vars assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> type_aexpr.cases<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> Sec.exhaust <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> upd <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> tyenv_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>2<span class="main">)</span> type_aexpr_type_wellformed
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="var">?Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> types_wellformed_update <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> tyenv_wf <span class="keyword1"><span class="command">have</span></span> stable'<span class="main">:</span> <span class="quoted"><span class="quoted">"types_stable <span class="var">?Γ'</span> <span class="skolem">𝒮</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> types_stable_update
            assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tyenv_wf <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>4<span class="main">)</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds'</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mds_consistent_preds_tyenv_update<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> upd m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> wf' stable' this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>2</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>2</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟹</span> pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> tyenv_sec <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> pred p <span class="keyword1"><span class="command">have</span></span> pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Γv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite›</span></span> upd wf <span class="keyword1"><span class="command">have</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤:⇩</span><span class="skolem">P'</span> <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> pred' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_max_dma_type subtype_correct
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Γv <span class="keyword1"><span class="command">have</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> sec upd <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite›</span></span> <span class="keyword1"><span class="command">have</span></span> f_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span> upd <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq_type_max_eq<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> Γv wf <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq<span class="main">)</span>     
      <span class="keyword1"><span class="command">from</span></span> neq Γv f_leq dma_eq f_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> wf assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> tyenv_eq'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> p assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>2</sub> assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">using</span></span> sec assign<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">using</span></span> upd<span class="main">(</span>2<span class="main">)</span> upd<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* if *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">th</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">el</span> <span class="skolem">Γ''</span> <span class="skolem">P''</span> <span class="skolem">Γ'''</span> <span class="skolem">P'''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="keyword1">else</span> <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="main">(</span><span class="free">bexp_neg</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>Stmt.If <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="var">?P</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> if_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">th</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> if_type<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> sub<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">el</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> if_type<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> sub<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> ev<span class="hidden">⇩</span><sub>B</sub>_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ev<span class="hidden">⇩</span><sub>B</sub>_eq'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">t</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="skolem">Γ'''</span> <span class="skolem">𝒮'</span> <span class="skolem">P'''</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Γ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ'''</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> 𝒮 <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">𝒮</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ty<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def add_pred_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>       
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def add_pred_def bexp_neg_negates<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def add_pred_def bexp_neg_negates<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> ev<span class="hidden">⇩</span><sub>B</sub>_eq if_type<span class="main">(</span>13<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">th</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.if_true eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> if_type.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">el</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> if_type.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> if_elim if_type.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* while *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span>If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> while_elim<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> while_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.while eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_type.while_type<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> stop_type<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> add_pred_entailment<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_pred_subset tyenv_wellformed_subset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ty<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> while_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">𝒮'</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">mds</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> 
             tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>5<span class="main">)</span> sub<span class="main">(</span>4<span class="main">)</span> tyenv_wellformed_sub <span class="keyword1"><span class="command">unfolding</span></span> pred_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> local.pred_def pred_entailment_def sub.hyps<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> local.pred_def pred_entailment_def sub.hyps<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>3<span class="main">)</span> context_equiv_tyenv_sec <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> tyenv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> context_equiv_tyenv_eq sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
  <span class="keyword1"><span class="command">from</span></span> imp tyenv_eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>2</sub>'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">with</span></span> R_equiv_entailment <span class="quoted"><span class="quoted">‹<span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⊢</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub>'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sub.hyps<span class="main">(</span>6<span class="main">)</span> sub.hyps<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>await_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">c</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">Γ''</span> <span class="skolem">P''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_await_no_await <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-is_final_ℛ"><span class="command">lemma</span></span> is_final_ℛ<span class="hidden">⇩</span><sub>u</sub>_is_final<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> is_final <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> is_final <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub><span class="main">)</span>

<span class="keyword1" id="TypeSystem-pred_plus_impl"><span class="command">lemma</span></span> pred_plus_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem</span> <span class="main">⟹</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span> <span class="main">⟹</span> pred <span class="free">P</span> <span class="main">+⇩</span><span class="free">S</span> <span class="free">e</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_pred_def pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="TypeSystem-my_ℛ"><span class="command">lemma</span></span> my_ℛ<span class="hidden">⇩</span><sub>3</sub>_aux_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> intro<span class="hidden">⇩</span><sub>1</sub> intro<span class="hidden">⇩</span><sub>3</sub><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">Γ</span> <span class="bound">𝒮</span> <span class="bound">P</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c</span> <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> 
     <span class="main">⟦</span><span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="bound">Γ</span><span class="main">,</span><span class="bound">𝒮</span><span class="main">,</span><span class="bound">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">;</span> 
      <span class="main">⊢</span> <span class="bound">Γ</span><span class="main">,</span><span class="bound">𝒮</span><span class="main">,</span><span class="bound">P</span> <span class="main">{</span><span class="bound">c</span><span class="main">}</span> <span class="bound">Γ'</span><span class="main">,</span><span class="bound">𝒮'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="free">Q</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;;</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">Γ</span> <span class="bound">𝒮</span> <span class="bound">P</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c</span> <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> 
     <span class="main">⟦</span><span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="bound">Γ</span><span class="main">,</span><span class="bound">𝒮</span><span class="main">,</span><span class="bound">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">;</span> 
      <span class="free">Q</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">Γ</span> <span class="bound">𝒮</span> <span class="bound">P</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> 
      <span class="main">⊢</span> <span class="bound">Γ</span><span class="main">,</span><span class="bound">𝒮</span><span class="main">,</span><span class="bound">P</span> <span class="main">{</span><span class="bound">c</span><span class="main">}</span> <span class="bound">Γ'</span><span class="main">,</span><span class="bound">𝒮'</span><span class="main">,</span><span class="bound">P'</span><span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="free">Q</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;;</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="free">Q</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mds</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mds</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    <span class="var">?x1.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
    <span class="var">?x2.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
    <span class="var">?x3.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">𝒮</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
    <span class="var">?x4.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
    <span class="var">?x5.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
    <span class="var">?P</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ctx<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">Γ</span> <span class="bound">𝒮</span> <span class="bound">P</span> <span class="bound">ctx<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">ctx<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">ctx<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">ctx<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">Γ</span> <span class="bound">𝒮</span> <span class="bound">P</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">ctx<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">ctx<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">ctx<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="TypeSystem-ℛ_typed_step_plus"><span class="command">lemma</span></span> ℛ_typed_step_plus<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">;</span> 
    <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">;</span>
    no_await <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
    tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span><span class="main">;</span> 
    <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> 
    pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
    pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> 
    tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
                 <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">𝒮</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> my_trancl_big_step_induct3<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ℛ_typed_step_no_await bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="skolem">mds''</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      rel<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rel<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="skolem"><span class="skolem">𝒮''</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span> 
      <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds'</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span></sub><span class="hidden">⇙</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
      <span class="quoted"><span class="quoted">"pred <span class="skolem">P''</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="quoted"><span class="quoted">"pred <span class="skolem">P''</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ''</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds'</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ''</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> step<span class="hidden">⇩</span><sub>2</sub>' <span class="quoted"><span class="quoted">‹no_await <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> step.hyps<span class="main">(</span>1<span class="main">)</span> step.hyps<span class="main">(</span>4<span class="main">)</span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        step<span class="hidden">⇩</span><sub>2</sub>''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        rel<span class="hidden">⇩</span><sub>2</sub>''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> no_await_trancl bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this step<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trancl_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>3</sub> step.prems step.hyps<span class="main">(</span>1<span class="main">)</span> step.hyps<span class="main">(</span>3<span class="main">)</span> step.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        step''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        rel''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> my_ℛ<span class="hidden">⇩</span><sub>3</sub>_aux_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">Γ'''</span> <span class="skolem">𝒮'''</span> <span class="skolem">P'''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γv</span></span> <span class="skolem"><span class="skolem">𝒮v</span></span> <span class="skolem"><span class="skolem">Pv</span></span> <span class="keyword2"><span class="keyword">where</span></span> pre_props<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γv</span><span class="main">,</span><span class="skolem">𝒮v</span><span class="main">,</span><span class="skolem">Pv</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span><span class="main">}</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'''</span><span class="main">,</span><span class="skolem">P'''</span>"</span></span> 
        <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds'</span> <span class="skolem">Γv</span> <span class="skolem">𝒮v</span> <span class="skolem">Pv</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γv</span></sub><span class="hidden">⇙</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
        <span class="quoted"><span class="quoted">"pred <span class="skolem">Pv</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="quoted"><span class="quoted">"pred <span class="skolem">Pv</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γv</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds'</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this intro<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> typed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γv</span><span class="main">,</span><span class="skolem">𝒮v</span><span class="main">,</span><span class="skolem">Pv</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span><span class="main">}</span> <span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> has_type.seq_type <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this pre_props <span class="quoted"><span class="quoted">‹no_await <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>›</span></span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>13<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
               step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span> <span class="main">∧</span> 
                      <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> no_await_trancl bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this intro<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_await_trancl bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span> 
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>3</sub> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">Γ'''</span> <span class="skolem">𝒮'''</span> <span class="skolem">P'''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γv</span></span> <span class="skolem"><span class="skolem">𝒮v</span></span> <span class="skolem"><span class="skolem">Pv</span></span> <span class="keyword2"><span class="keyword">where</span></span> pre_props<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γv</span><span class="main">,</span><span class="skolem">𝒮v</span><span class="main">,</span><span class="skolem">Pv</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span><span class="main">}</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'''</span><span class="main">,</span><span class="skolem">P'''</span>"</span></span> 
        <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds'</span> <span class="skolem">Γv</span> <span class="skolem">𝒮v</span> <span class="skolem">Pv</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γv</span></sub><span class="hidden">⇙</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
        <span class="quoted"><span class="quoted">"pred <span class="skolem">Pv</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="quoted"><span class="quoted">"pred <span class="skolem">Pv</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γv</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">mds'</span> AsmNoReadOrWrite <span class="main">⟶</span> type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> my_ℛ<span class="hidden">⇩</span><sub>3</sub>_aux_induct<span class="main">)</span> 
           <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> this intro<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> typed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γv</span><span class="main">,</span><span class="skolem">𝒮v</span><span class="main">,</span><span class="skolem">Pv</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span><span class="main">}</span> <span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> has_type.seq_type intro<span class="hidden">⇩</span><sub>3</sub>.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">from</span></span> this pre_props <span class="quoted"><span class="quoted">‹no_await <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>›</span></span> intro<span class="hidden">⇩</span><sub>3</sub>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span> <span class="main">∧</span> 
               <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span>"</span></span>   
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span> <span class="main">∧</span> 
                               <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="skolem">thesis</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>3</sub>.prems<span class="main">(</span>11<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> pre_props<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span>
                       <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'1</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'2</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>›</span></span>  <span class="quoted"><span class="quoted">‹no_await <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> 
                       bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub> fst_conv no_await_trancl typed<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> this intro<span class="hidden">⇩</span><sub>3</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_await_trancl bisim_simple_ℛ<span class="hidden">⇩</span><sub>u</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> step<span class="hidden">⇩</span><sub>2</sub>' trancl_trans<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This is the main part of the proof and used in ℛ<span class="hidden">⇩</span><sub>1</sub>_weak_bisim: *)</span>
<span class="keyword1" id="TypeSystem-ℛ_typed_step"><span class="command">lemma</span></span> ℛ_typed_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span> <span class="main">;</span>
  tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
        pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
     <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
                 <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>seq_type <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_type
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq_stop_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> seq_type <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"context_equiv <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">Γ''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒮</span> <span class="main">=</span> <span class="skolem">𝒮''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">P''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                                   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">mds</span><span class="main">.</span> tyenv_wellformed <span class="bound">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed  <span class="bound">mds</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮</span> <span class="skolem">P''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_cxt<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sub<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> seq_type<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> seq_type <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> seq_stop_eval<span class="hidden">⇩</span><sub>w</sub>  ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>1</sub>''_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> seq_type<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>2</sub>''_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_type.prems<span class="main">(</span>1<span class="main">)</span> seq_type.prems<span class="main">(</span>2<span class="main">)</span> seq_type.prems<span class="main">(</span>3<span class="main">)</span> seq_type.prems<span class="main">(</span>4<span class="main">)</span> seq_type.prems<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub> seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub> seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> c<span class="hidden">⇩</span><sub>2</sub>''_props <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c<span class="hidden">⇩</span><sub>1</sub>''_props<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>anno_type <span class="skolem">Γ'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">upd</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Γ''</span> <span class="skolem">𝒮''</span> <span class="skolem">P''</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>  
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ'</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> anno_type.hyps<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def pred_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> subtype_sound<span class="main">[</span><span class="operator">OF</span> anno_type.hyps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> a 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> less_eq_Sec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> anno_type.prems<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tyenv_wellformed_mode_update<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> 
        tyenv_sec <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> tyenv_sec_mode_update<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
           <span class="keyword1"><span class="command">using</span></span> anno_type pred <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
         <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> anno_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span><span class="main">,</span><span class="skolem">𝒮''</span><span class="main">,</span><span class="skolem">P''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> local.pred_def restrict_preds_to_vars_def upd_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> stop_type
  <span class="keyword1"><span class="command">with</span></span> stop_no_eval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>skip_type <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> skip_type <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> skip_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> skip_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="keyword2"><span class="keyword">and</span></span> unannotated <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted">Skip</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> E <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> old.prod.case skip_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* assign<span class="hidden">⇩</span><sub>1</sub> *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">𝒮</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> upd <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dma_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dma_𝒞 assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> is_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq_type_max_eq<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>›</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>6<span class="main">)</span> 
         <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def types_wellformed_def
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> option.sel<span class="main">)</span>
                
        <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> is_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> is_Low assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="bound">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="bound">mem</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> dma_eq <span class="keyword1"><span class="command">have</span></span> dma_v_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> is_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">using</span></span> is_Low assign<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ev<span class="hidden">⇩</span><sub>A</sub>_eq<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> dma_v_Low <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upd tyenv_wellformed_preds_update assign<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>1</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>1</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>  <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tyenv_sec_eq<span class="main">[</span><span class="operator">OF</span> 𝒞_eq<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ℛ'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assign<span class="hidden">⇩</span><sub>1</sub> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dma_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> ℛ' a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* assign<span class="hidden">⇩</span><sub>𝒞</sub> *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">𝒮</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> is_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> in_dom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Γv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> x_nin_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_dom Γv 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> Γv_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_dom Γv assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def types_wellformed_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel<span class="main">)</span>
        
      <span class="keyword1"><span class="command">with</span></span> x_nin_C <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars_of_type_eq_type_max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> is_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
      <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> is_Low assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> nin_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="bound">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="bound">mem</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> to_total_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ev<span class="hidden">⇩</span><sub>A</sub>_eq'<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> in_𝒞_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 𝒞_vars_𝒞 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> nin_dom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>7<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def stable_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> in_𝒞_vars <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊢</span> <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def pred_def pred_entailment_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> not_sym<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>8<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span>
            <span class="keyword1"><span class="command">using</span></span> dma_𝒞_vars <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">mem</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="bound">mem</span> <span class="main">=</span> <span class="free">dma</span> <span class="bound">mem</span> <span class="skolem">v</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> not_sym<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>8<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>            
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upd tyenv_wellformed_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>𝒞</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">∧</span> pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> tyenv_sec <span class="free">mds'</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">assume</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> readable'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword1"><span class="command">with</span></span> upd <span class="keyword1"><span class="command">have</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoReadOrWrite"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≤:⇩</span><span class="skolem">P'</span> <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> pred' Γv subtype_sound<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_max_dma_type <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v'</span><span class="main">∈</span><span class="free">𝒞_vars</span> <span class="skolem">v</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">v'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞_vars<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Γv assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf Γv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> vars_of_type <span class="skolem">t'</span>›</span></span> upd <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars_of_type_eq_type_max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> sec Γv readable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> f_eq dma_eq Γv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ℛ'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> ℛ' a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* assign<span class="hidden">⇩</span><sub>2</sub> *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span> <span class="skolem">P</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_elim<span class="main">[</span><span class="operator">OF</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> x_nin_𝒞<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dma_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dma_𝒞 assign<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.assign eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
    
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> tyenv_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> is_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> to_total_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_total <span class="var">?Γ'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq_type_max_eq<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>6<span class="main">)</span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> option.sel<span class="main">)</span>
           <span class="keyword1"><span class="command">using</span></span> x_nin_𝒞 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> this is_Low' neq neq<span class="main">[</span><span class="operator">THEN</span> not_sym<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> is_Low' neq
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span> <span class="main">=</span> Low"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> dma_eq <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> neq assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> is_Low' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> t_Low'<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> wf_t<span class="main">:</span> <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> type_aexpr_type_wellformed assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>2<span class="main">)</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>6<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> t_Low' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> t_Low<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 𝒞_eq_type_max_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fun_upd_other upd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">assume</span></span> in_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>to_total <span class="skolem">Γ</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> t_Low in_vars assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> type_aexpr.cases<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> Sec.exhaust <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_max_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> upd <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟶</span> tyenv_wellformed <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> tyenv_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"type_wellformed <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>2<span class="main">)</span> type_aexpr_type_wellformed
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"types_wellformed <span class="var">?Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> types_wellformed_update <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> tyenv_wf <span class="keyword1"><span class="command">have</span></span> stable'<span class="main">:</span> <span class="quoted"><span class="quoted">"types_stable <span class="var">?Γ'</span> <span class="skolem">𝒮</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> types_stable_update
            assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tyenv_wf <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>4<span class="main">)</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds'</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mds_consistent_preds_tyenv_update<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> upd m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> wf' stable' this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="skolem">𝒮</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>2</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> pred <span class="skolem">P'</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_preds_update assign<span class="hidden">⇩</span><sub>2</sub> upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">⟹</span> pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> tyenv_sec <span class="free">mds'</span> <span class="var">?Γ'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> pred p <span class="keyword1"><span class="command">have</span></span> pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"type_max <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Γv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite›</span></span> upd wf <span class="keyword1"><span class="command">have</span></span> readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> snd <span class="skolem">𝒮</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤:⇩</span><span class="skolem">P'</span> <span class="main">(</span><span class="free">dma_type</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> pred' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> type_max_dma_type subtype_sound
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Γv <span class="keyword1"><span class="command">have</span></span> Γv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> sec upd <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite›</span></span> <span class="keyword1"><span class="command">have</span></span> f_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 𝒞_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">𝒞</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf assign<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span> upd <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> dma_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">dma</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> dma_𝒞<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> type_max <span class="skolem">t'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq_type_max_eq<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> Γv wf <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def types_wellformed_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 𝒞_eq<span class="main">)</span>     
      <span class="keyword1"><span class="command">from</span></span> neq Γv f_leq dma_eq f_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="var">?Γ'</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> wf assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> tyenv_eq'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> p assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>2</sub> assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">using</span></span> sec assign<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">using</span></span> upd<span class="main">(</span>2<span class="main">)</span> upd<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* if *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">th</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span> <span class="skolem">el</span> <span class="skolem">Γ''</span> <span class="skolem">P''</span> <span class="skolem">Γ'''</span> <span class="skolem">P'''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="keyword1">else</span> <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="main">(</span><span class="free">bexp_neg</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>Stmt.If <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="var">?P</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> if_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">th</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> if_type<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> sub<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">el</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> if_type<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> sub<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> if_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> ev<span class="hidden">⇩</span><sub>B</sub>_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ev<span class="hidden">⇩</span><sub>B</sub>_eq'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">t</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="skolem">Γ'''</span> <span class="skolem">𝒮'</span> <span class="skolem">P'''</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Γ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ'''</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> 𝒮 <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">𝒮</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ty<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def add_pred_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>       
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def add_pred_def bexp_neg_negates<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def add_pred_def bexp_neg_negates<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> ev<span class="hidden">⇩</span><sub>B</sub>_eq if_type<span class="main">(</span>13<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">th</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.if_true eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> if_type.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">el</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> if_type.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ'''</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> if_elim if_type.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* while *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span>If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> while_elim<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> while_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.while eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_type.while_type<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> stop_type<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> add_pred_entailment<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_pred_subset tyenv_wellformed_subset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>1</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ty<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> while_type <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">𝒮'</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">mds</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> 
             tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">𝒮</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> pred <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> tyenv_sec <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>5<span class="main">)</span> sub<span class="main">(</span>4<span class="main">)</span> tyenv_wellformed_sub <span class="keyword1"><span class="command">unfolding</span></span> pred_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> local.pred_def pred_entailment_def sub.hyps<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> local.pred_def pred_entailment_def sub.hyps<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>3<span class="main">)</span> context_equiv_tyenv_sec <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> tyenv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> context_equiv_tyenv_eq sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
  <span class="keyword1"><span class="command">from</span></span> imp tyenv_eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>2</sub>'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">with</span></span> R_equiv_entailment <span class="quoted"><span class="quoted">‹<span class="skolem">P<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⊢</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub>'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sub.hyps<span class="main">(</span>6<span class="main">)</span> sub.hyps<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>await_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">𝒮</span> <span class="skolem">c</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> await_type.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"no_await <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"is_final <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> await_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> await_type.prems <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_plus_impl <span class="quoted"><span class="quoted">‹<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> ev<span class="hidden">⇩</span><sub>B</sub>_eq'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> await_type.prems <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add_pred_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"pred_stable <span class="skolem">𝒮</span> <span class="skolem">e</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> tyenv_wellformed_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mds_consistent_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">from</span></span> step <span class="quoted"><span class="quoted">‹is_final <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span> <span class="quoted"><span class="quoted">‹no_await <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹tyenv_wellformed <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span>›</span></span> await_type.prems <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span><span class="main">,</span><span class="skolem">𝒮'</span><span class="main">,</span><span class="skolem">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"is_final <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> ℛ_typed_step_plus await_type.hyps<span class="main">(</span>3<span class="main">)</span> is_final_ℛ<span class="hidden">⇩</span><sub>u</sub>_is_final <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">from</span></span> wellformed <span class="quoted"><span class="quoted">‹is_final <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹no_await <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹pred <span class="skolem">P</span> <span class="main">+⇩</span><span class="skolem">𝒮</span> <span class="skolem">e</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> step rel <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* We can now show that ℛ<span class="hidden">⇩</span><sub>1</sub> and ℛ<span class="hidden">⇩</span><sub>3</sub> are weak bisimulations of ℛ,: *)</span>
<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_weak_bisim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"weak_bisim <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>1</sub> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span> <span class="main">(</span>ℛ <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_bisim_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ℛ_typed_step<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="TypeSystem-ℛ_to_ℛ"><span class="command">lemma</span></span> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">;</span> <span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>3</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_weak_bisim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"weak_bisim <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span> <span class="main">(</span>ℛ <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
    <span class="keyword3"><span class="command">assume</span></span> case3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> case3 eval
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
        <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.seq_stop eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq intro<span class="hidden">⇩</span><sub>1</sub>.prems seq_stop_elim<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> intro<span class="hidden">⇩</span><sub>1</sub>.prems seq_stop_elim stop_cxt tyenv_wellformed_sub<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> intro<span class="hidden">⇩</span><sub>1</sub>.prems seq_stop_elim stop_cxt context_equiv_tyenv_eq
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>

             <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> intro<span class="hidden">⇩</span><sub>1</sub>.prems pred_entailment_def seq_stop_elim stop_cxt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> pred_entailment_def stop_cxt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
           
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> context_equiv_def intro<span class="hidden">⇩</span><sub>1</sub>.prems less_eq_Sec_def seq_stop_elim stop_cxt subtype_sound type_equiv_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>1</sub>.prems seq_stop_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
        <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>1</sub>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop›</span></span> intro<span class="hidden">⇩</span><sub>1</sub>.prems seq_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> intro<span class="hidden">⇩</span><sub>1</sub>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_weak_bisim <span class="keyword2"><span class="keyword">and</span></span> weak_bisim_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
          
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>3</sub> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">𝒮</span> <span class="skolem">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">Γ'</span> <span class="skolem">𝒮'</span> <span class="skolem">P'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intro<span class="hidden">⇩</span><sub>3</sub>.prems seq_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>›</span></span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">𝒮</span><span class="main">,</span><span class="skolem">P</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>›</span></span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> weak_bisim_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Hence ℛ is a bisimulation: *)</span>
<span class="keyword1" id="TypeSystem-ℛ_bisim"><span class="command">lemma</span></span> ℛ_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="main">(</span>ℛ <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ℛ_sym <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> ℛ_closed_glob_consistent <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="main">(</span>ℛ <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_mem_eq ℛ<span class="hidden">⇩</span><sub>3</sub>_mem_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
  <span class="keyword3"><span class="command">assume</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
                            <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ_elim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_weak_bisim ℛ<span class="hidden">⇩</span><sub>3</sub>_weak_bisim eval weak_bisim_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-Typed_in_ℛ"><span class="command">lemma</span></span> Typed_in_ℛ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typeable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tyenv_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> ℛ<span class="hidden">⇧</span><sup>u</sup><span class="hidden">⇘</span><sub><span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> typeable<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> mem_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="comment1">(* We then prove the main soundness theorem using the fact that typeable
    configurations can be related using ℛ<span class="hidden">⇩</span><sub>1</sub> *)</span>
<span class="keyword1"><span class="command">theorem</span></span> type_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_typed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span><span class="main">,</span><span class="free">𝒮</span><span class="main">,</span><span class="free">P</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_wellformed <span class="free">mds</span> <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> type_max <span class="main">(</span>to_total <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pred<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">P</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tyenv_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"tyenv_sec <span class="free">mds</span> <span class="free">Γ</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ℛ_bisim Typed_in_ℛ
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms mem_eq mm_equiv.simps well_typed<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Γ_of_mds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'BExp</span><span class="main">)</span> TyEnv"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ_of_mds</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">𝒞</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite <span class="keyword1">then</span>
                         <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite <span class="keyword1">then</span> 
                           Some <span class="main">(</span><span class="main">{</span><span class="free">pred_False</span><span class="main">}</span><span class="main">)</span> 
                         <span class="keyword1">else</span>
                           Some <span class="main">(</span><span class="free">dma_type</span> <span class="bound">x</span><span class="main">)</span> 
                       <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">𝒮_of_mds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Var</span> Stable"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒮_of_mds</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mds_yields_stable_types</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mds_yields_stable_types</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite <span class="main">⟶</span>
                                     <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">𝒞_vars</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">)</span>"</span></span>
  
<span class="comment1">(* The typing relation for lists of commands ("thread pools"). *)</span>
<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">type_global</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">×</span> <span class="tfree">'Var</span> Mds<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _"</span> <span class="main">[</span>120<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> list_all <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> <span class="main">⊢</span> <span class="main">(</span>Γ_of_mds <span class="bound">m</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>𝒮_of_mds <span class="bound">m</span><span class="main">)</span><span class="main">,</span><span class="main">{}</span> <span class="main">{</span> <span class="bound">c</span> <span class="main">}</span> <span class="bound">Γ'</span><span class="main">,</span><span class="bound">𝒮'</span><span class="main">,</span><span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> mds_yields_stable_types <span class="bound">m</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">;</span>
       <span class="main">∀</span> <span class="bound">mem</span><span class="main">.</span> sound_mode_use <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="bound">mem</span><span class="main">)</span>
    <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">type_global</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

                                     
<span class="keyword1"><span class="command">inductive_cases</span></span> type_global_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">cs</span>"</span></span>

<span class="keyword1" id="TypeSystem-of_mds_tyenv_wellformed"><span class="command">lemma</span></span> of_mds_tyenv_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_yields_stable_types <span class="free">m</span> <span class="main">⟹</span> tyenv_wellformed <span class="free">m</span> <span class="main">(</span>Γ_of_mds <span class="free">m</span><span class="main">)</span> <span class="main">(</span>𝒮_of_mds <span class="free">m</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def Γ_of_mds_def 𝒮_of_mds_def mds_consistent_def stable_def
                   types_wellformed_def types_stable_def  mds_yields_stable_types_def 
                   type_wellformed_def dma_𝒞_vars 𝒞_def bexp_vars_pred_False 𝒞_vars_correct
             <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-Γ_of_mds_tyenv_sec"><span class="command">lemma</span></span> Γ_of_mds_tyenv_sec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tyenv_sec <span class="free">m</span> <span class="main">(</span>Γ_of_mds <span class="free">m</span><span class="main">)</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Γ_of_mds_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TypeSystem-type_max_pred_False"><span class="command">lemma</span></span> type_max_pred_False <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"type_max <span class="main">{</span><span class="free">pred_False</span><span class="main">}</span> <span class="free">mem</span> <span class="main">=</span> High"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_max_def pred_False_is_False<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="TypeSystem-typed_secure"><span class="command">lemma</span></span> typed_secure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="main">(</span>Γ_of_mds <span class="free">m</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>𝒮_of_mds <span class="free">m</span><span class="main">)</span><span class="main">,</span><span class="main">{}</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">,</span><span class="free">𝒮'</span><span class="main">,</span><span class="free">P'</span><span class="main">;</span> mds_yields_stable_types <span class="free">m</span> <span class="main">⟧</span> <span class="main">⟹</span> com_sifum_secure <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> com_sifum_secure_def low_indistinguishable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> type_soundness<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> of_mds_tyenv_wellformed<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Γ_of_mds_def low_mds_eq_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def type_max_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Γ_of_mds_tyenv_sec<span class="main">)</span>

<span class="keyword1" id="TypeSystem-list_all_set"><span class="command">lemma</span></span> list_all_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> list_all <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> type_soundness_global<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typeable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prog_sifum_secure_cont <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typeable
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> type_global_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span><span class="main">.</span> com_sifum_secure <span class="bound">c</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sifum_compositionality_cont<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> list_all_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> list_all_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> c m<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">c</span><span class="main">,</span><span class="improper">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> typed_secure <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LocallySoundModeUse">
<div class="head">
<h1>Theory LocallySoundModeUse</h1>
</div>
<pre class="source"><span class="comment1">(*
TiTitle: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Type System for Ensuring Locally Sound Use of Modes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LocallySoundModeUse
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Security.html">Security</a> <a href="Language.html">Language</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing Rules›</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_modes <span class="main">=</span> 
  sifum_lang_no_dma <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span></span> <span class="quoted"><span class="free">aexp_vars</span></span> <span class="quoted"><span class="free">bexp_vars</span></span> <span class="main">+</span> sifum_security <span class="quoted"><span class="free">dma</span></span> <span class="quoted"><span class="free">𝒞_vars</span></span> <span class="quoted"><span class="free">𝒞</span></span> <span class="quoted">eval<span class="hidden">⇩</span><sub>w</sub></span> <span class="quoted">undefined</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span><span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒞_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> set"</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_modes
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">eval_abv_modes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">update_annos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd list <span class="main">⇒</span> <span class="tfree">'Var</span> Mds"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 140<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_annos</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">update_annos</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">update_annos</span> <span class="main">(</span>update_modes <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">annotate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊗</span>"</span> 140<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">annotate</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">annotate</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">annotate</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">@[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">mode_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _ <span class="keyword1">{</span> _ <span class="keyword1">}</span> _"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> Skip <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main"><span class="free">}</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoWrite <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoReadOrWrite <span class="main">;</span> <span class="free">aexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoReadOrWrite <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
             <span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">𝒞_vars</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoWrite <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoReadOrWrite<span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="free">𝒞_vars</span> <span class="bound">v</span> <span class="main">∩</span> <span class="free">aexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoReadOrWrite<span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main"><span class="free">}</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  if_<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span><span class="main">)</span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span> <span class="main">;</span>
          <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span><span class="main">)</span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span> <span class="main">;</span>
          <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoReadOrWrite <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
          <span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="free">𝒞_vars</span> <span class="bound">v</span> <span class="main">∩</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
        <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> If <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span>"</span></span> <span class="main">|</span>
  while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main">;</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> GuarNoReadOrWrite <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
            <span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="free">𝒞_vars</span> <span class="bound">v</span> <span class="main">∩</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> GuarNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> While <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span>"</span></span> <span class="main">|</span>
  seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span>"</span></span> <span class="main">|</span>
  sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>1</sub>'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of the Type System›</span></span>

<span class="comment1">(* Special case for evaluation with an empty context *)</span>
<span class="keyword1" id="LocallySoundModeUse-cxt_eval"><span class="command">lemma</span></span> cxt_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>cxt_to_stmt <span class="main">[]</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>cxt_to_stmt <span class="main">[]</span> <span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-update_preserves_le"><span class="command">lemma</span></span> update_preserves_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">annos</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"update_modes <span class="skolem">a</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> update_modes <span class="skolem">a</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Annotations do not affect doesnt_read and doesnt_modify: *)</span>
<span class="keyword1" id="LocallySoundModeUse-doesnt_read_annos"><span class="command">lemma</span></span> doesnt_read_annos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="free">c</span> <span class="free">x</span> <span class="main">⟹</span> doesnt_read_or_modify <span class="main">(</span><span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.decl upd_elim<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LocallySoundModeUse-doesnt_modify_annos"><span class="command">lemma</span></span> doesnt_modify_annos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify <span class="free">c</span> <span class="free">x</span> <span class="main">⟹</span> doesnt_modify <span class="main">(</span><span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> upd_elim<span class="main">)</span>
  
<span class="comment1">(* The following part contains some lemmas about evaluation of
   commands annotated using ⊗ and characterisations of loc_reach for
   commands. *)</span>

<span class="keyword1" id="LocallySoundModeUse-stop_loc_reach"><span class="command">lemma</span></span> stop_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stop_no_eval<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-stop_doesnt_access"><span class="command">lemma</span></span> stop_doesnt_access<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify Stop <span class="free">x</span> <span class="main">∧</span> doesnt_read_or_modify Stop <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def <span class="keyword2"><span class="keyword">and</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def
  <span class="keyword1"><span class="command">using</span></span> stop_no_eval
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-skip_eval_step"><span class="command">lemma</span></span> skip_eval_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.skip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-skip_eval_elim"><span class="command">lemma</span></span> skip_eval_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> skip_eval_step deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LocallySoundModeUse-skip_doesnt_read"><span class="command">lemma</span></span> skip_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="main">(</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_read_annos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> skip_elim skip_eval_step<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LocallySoundModeUse-skip_doesnt_write"><span class="command">lemma</span></span> skip_doesnt_write<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_modify_annos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_modify_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> skip_elim<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LocallySoundModeUse-skip_loc_reach"><span class="command">lemma</span></span> skip_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="main">(</span><span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Skip <span class="main">⊗</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> skip_eval_elim stop_no_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="LocallySoundModeUse-skip_doesnt_access"><span class="command">lemma</span></span> skip_doesnt_access<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">lc</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">;</span> <span class="free">lc</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_read_or_modify <span class="free">c'</span> <span class="free">x</span> <span class="main">∧</span> doesnt_modify <span class="free">c'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="main">(</span><span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Skip <span class="main">⊗</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def stop_no_eval<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> annotate.simps skip_doesnt_read<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doesnt_modify_def stop_no_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> annotate.simps skip_doesnt_write<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> skip_loc_reach<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-assign_doesnt_modify"><span class="command">lemma</span></span> assign_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_modify <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_modify_annos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doesnt_modify_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim fun_upd_apply dma_𝒞_vars<span class="main">)</span>
  
<span class="keyword1" id="LocallySoundModeUse-assign_annos_eval"><span class="command">lemma</span></span> assign_annos_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> annotate.simps update_annos.simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cxt_to_stmt.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-assign_annos_eval_elim"><span class="command">lemma</span></span> assign_annos_eval_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> deterministic assign_annos_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-mem_upd_commute"><span class="command">lemma</span></span> mem_upd_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_twist<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-assign_doesnt_read"><span class="command">lemma</span></span> assign_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">;</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="free">e</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="free">y</span><span class="main">;</span> <span class="free">𝒞_vars</span> <span class="free">y</span> <span class="main">∩</span> <span class="free">aexp_vars</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_read_or_modify <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_read_annos<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="free">e</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="free">y</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="free">y</span> <span class="main">∩</span> <span class="free">aexp_vars</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c' mds' mem'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="improper">v</span><span class="main">)</span> <span class="main">=</span> <span class="improper">mem</span> <span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="improper">v</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>      
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign eval_vars_det<span class="hidden">⇩</span><sub>A</sub> fun_upd_apply<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mem_upd_commute<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> va v<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">,</span> <span class="improper">va</span> <span class="main">:=</span> <span class="improper">v</span><span class="main">)</span> <span class="main">=</span> <span class="improper">mem</span> <span class="main">(</span><span class="improper">va</span> <span class="main">:=</span> <span class="improper">v</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">va</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="free">e</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign eval_vars_det<span class="hidden">⇩</span><sub>A</sub> fun_upd_apply<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mem_upd_commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LocallySoundModeUse-assign_loc_reach"><span class="command">lemma</span></span> assign_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="main">(</span><span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_annos_eval_elim stop_no_eval<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_doesnt_modify"><span class="command">lemma</span></span> if_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_modify_annos<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_modify_def<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-vars_eval"><span class="command">lemma</span></span> vars_eval<span class="hidden">⇩</span><sub>B</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">(</span><span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub> fun_upd_other<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_doesnt_read"><span class="command">lemma</span></span> if_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">𝒞_vars</span> <span class="free">x</span> <span class="main">∩</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> doesnt_read_or_modify <span class="main">(</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_read_annos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c' mds' mem' v<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="improper">mem</span> <span class="free">e</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_true<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> vars_eval<span class="hidden">⇩</span><sub>B</sub><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> vars_eval<span class="hidden">⇩</span><sub>B</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c' mds' mem' va v<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="improper">mem</span> <span class="free">e</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_true<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">va</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> vars_eval<span class="hidden">⇩</span><sub>B</sub><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">va</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> vars_eval<span class="hidden">⇩</span><sub>B</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="LocallySoundModeUse-if_eval_true"><span class="command">lemma</span></span> if_eval_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_true<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.decl update_annos.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_eval_false"><span class="command">lemma</span></span> if_eval_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.decl update_annos.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_eval_elim"><span class="command">lemma</span></span> if_eval_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> if_eval_true deterministic<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> if_eval_false deterministic
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LocallySoundModeUse-if_eval_elim'"><span class="command">lemma</span></span> if_eval_elim'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> if_eval_elim <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-loc_reach_refl'"><span class="command">lemma</span></span> loc_reach_refl'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">lc</span><span class="main">.</span> <span class="bound">lc</span> <span class="main">∈</span> loc_reach <span class="bound">lc</span> <span class="main">∧</span> <span class="bound">lc</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl fst_conv snd_conv<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_loc_reach"><span class="command">lemma</span></span> if_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> if_eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach_refl'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach_refl'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.step<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.mem_diff<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_loc_reach'"><span class="command">lemma</span></span> if_loc_reach'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> if_loc_reach <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LocallySoundModeUse-seq_loc_reach"><span class="command">lemma</span></span> seq_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">c''</span><span class="main">.</span> <span class="free">c'</span> <span class="main">=</span> <span class="bound">c''</span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">⟨</span><span class="bound">c''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">c''</span> <span class="bound">mds''</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="bound">mds''</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">∧</span> 
                      <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds''</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span>  loc_reach_refl'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> loc_reach.step loc_reach_refl' seq_elim seq_stop_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> loc_reach.mem_diff<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-seq_doesnt_read"><span class="command">lemma</span></span> seq_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> doesnt_read_or_modify <span class="free">c</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_read_or_modify <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> <span class="free">c'</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c'a mds' mem' v<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'a</span> <span class="main">=</span> <span class="free">c'</span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.seq_stop<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> seq_stop_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.seq seq_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c'a mds' mem' va v<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'a</span> <span class="main">=</span> <span class="free">c'</span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.seq_stop<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> seq_stop_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.seq seq_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="LocallySoundModeUse-seq_doesnt_modify"><span class="command">lemma</span></span> seq_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> doesnt_modify <span class="free">c</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_modify <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> <span class="free">c'</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_modify_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> seq_stop_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> seq_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> seq_stop_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> seq_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">inductive_cases</span></span> seq_stop_elim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>

<span class="keyword1" id="LocallySoundModeUse-seq_stop_elim"><span class="command">lemma</span></span> seq_stop_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟹</span>
  <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> seq_stop_elim'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated seq_stop_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq seq_stop_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>34<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>42<span class="main"><span class="main">)</span></span> cxt_seq_elim<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-seq_split"><span class="command">lemma</span></span> seq_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span> <span class="bound">mds''</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="bound">mds''</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">∧</span>
                 <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds''</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> seq_loc_reach<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>49<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-while_eval"><span class="command">lemma</span></span> while_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="main">(</span>If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop<span class="main">)</span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.while<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-while_eval'"><span class="command">lemma</span></span> while_eval'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> while_eval <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-while_eval_elim"><span class="command">lemma</span></span> while_eval_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> while_eval deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LocallySoundModeUse-while_eval_elim'"><span class="command">lemma</span></span> while_eval_elim'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> while_eval_elim <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-while_doesnt_read"><span class="command">lemma</span></span> while_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_read_or_modify <span class="main">(</span>While <span class="free">e</span> <span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def
  <span class="keyword1"><span class="command">using</span></span> while_eval while_eval_elim
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="LocallySoundModeUse-while_doesnt_modify"><span class="command">lemma</span></span> while_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span>While <span class="free">e</span> <span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def
  <span class="keyword1"><span class="command">using</span></span> while_eval_elim
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* TODO: try to find a better solution to this: *)</span>
<span class="keyword1" id="LocallySoundModeUse-disjE3"><span class="command">lemma</span></span> disjE3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">;</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-disjE5"><span class="command">lemma</span></span> disjE5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">D</span> <span class="main">∨</span> <span class="free">E</span> <span class="main">;</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">E</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-if_doesnt_read'"><span class="command">lemma</span></span> if_doesnt_read'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">𝒞_vars</span> <span class="free">x</span> <span class="main">∩</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> doesnt_read_or_modify <span class="main">(</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> if_doesnt_read <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> mode_type_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typeable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mode_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mem</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≤</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">∧</span> 
                locally_sound_mode_use <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typeable mode_le
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">mds<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="quoted"><span class="free">mem'</span></span> <span class="quoted"><span class="free">mem</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mode_type.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>skip <span class="skolem">mds</span> <span class="skolem">annos</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> skip_eval_step skip_loc_reach stop_no_eval update_preserves_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps skip_doesnt_access<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign <span class="skolem">x</span> <span class="skolem">mds</span> <span class="skolem">e</span> <span class="skolem">annos</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mem</span><span class="main">.</span> locally_sound_mode_use <span class="main">⟨</span><span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∨</span> <span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assign_loc_reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="skolem">c'</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> nin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoReadOrWrite"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> nin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds</span> GuarNoReadOrWrite"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assign.prems <span class="keyword1"><span class="command">unfolding</span></span> le_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD2 IntI assign.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assign.prems empty_iff inf_apply le_iff_inf<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nin assign.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="skolem">y</span> <span class="main">∩</span> <span class="free">aexp_vars</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nin assign.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assign_doesnt_read
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoWrite"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> nin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds</span> GuarNoWrite"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assign.prems <span class="keyword1"><span class="command">unfolding</span></span> le_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="free">𝒞_vars</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assign <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> assign_doesnt_modify <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> stop_doesnt_access <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign.prems assign_annos_eval assign_loc_reach stop_no_eval update_preserves_le<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if_ <span class="skolem">mds</span> <span class="skolem">annos</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> if_ <span class="keyword1"><span class="command">have</span></span> modes_le'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> update_preserves_le<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> if_ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> modes_le' <span class="keyword2"><span class="keyword">and</span></span> if_ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≤</span> <span class="skolem">mds''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> if_eval_false if_eval_true if_loc_reach stop_no_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c'</span> <span class="main">=</span> If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> if_loc_reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoReadOrWrite"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> nin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds</span> GuarNoReadOrWrite"</span></span>
          <span class="keyword1"><span class="command">using</span></span> if_ <span class="keyword1"><span class="command">unfolding</span></span> le_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">bexp_vars</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="skolem">mds</span> GuarNoReadOrWrite <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD2 disjoint_iff_not_equal<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> if_<span class="main">(</span>6<span class="main">)</span> nin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="skolem">x</span> <span class="main">∩</span> <span class="free">bexp_vars</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_read_or_modify <span class="main">(</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> if_doesnt_read <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoWrite"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> if_doesnt_modify <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> if_ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> locally_sound_mode_use_def modes_le'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">mdsa</span> <span class="skolem">mds</span> <span class="skolem">annos</span> <span class="skolem">c</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> update_preserves_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> while_loc_reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span> <span class="bound">mem</span><span class="main">.</span>
  <span class="main">⟨</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span> <span class="main">⟹</span>
  <span class="bound">c'</span> <span class="main">=</span> While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="bound">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∨</span>
  <span class="bound">c'</span> <span class="main">=</span> While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">∧</span> <span class="bound">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∨</span>
  <span class="bound">c'</span> <span class="main">=</span> Stmt.If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="bound">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∨</span>
  <span class="bound">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="bound">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">c''</span> <span class="bound">mem''</span> <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span>
      <span class="bound">c'</span> <span class="main">=</span> <span class="bound">c''</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">∧</span>
      <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∧</span> <span class="main">⟨</span><span class="bound">c''</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span> <span class="skolem">mem</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>›</span></span> while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while_eval_elim<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> while_eval_elim'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> if_eval_elim' loc_reach_refl'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> stop_no_eval<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c' mds' mem' c'' mds'' mem'' c''a<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c''a</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> while.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> seq_stop_elim while.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.step seq_elim<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> loc_reach.mem_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> while <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.distinct<span class="main"><span class="main">(</span></span>35<span class="main"><span class="main">)</span></span> Stmt.distinct<span class="main"><span class="main">(</span></span>43<span class="main"><span class="main">)</span></span> annotate.elims update_annos.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while.prems while_loc_reach<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword1"><span class="command">from</span></span> while <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">)</span> GuarNoReadOrWrite <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> Int_empty_right Int_left_commute <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>›</span></span> inf_fun_def le_iff_inf<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> while <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span>  <span class="free">𝒞_vars</span> <span class="bound">v</span> <span class="main">∩</span> <span class="free">bexp_vars</span> <span class="skolem">e</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∉</span> <span class="main">(</span><span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">)</span> GuarNoReadOrWrite"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>›</span></span> le_fun_def subsetCE<span class="main">)</span>    
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span> <span class="main">=</span> <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="skolem">lc</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="skolem">c'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> while_loc_reach<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE5<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="main">(</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def <span class="keyword2"><span class="keyword">and</span></span> doesnt_modify_def
          <span class="keyword1"><span class="command">using</span></span> while_eval <span class="keyword2"><span class="keyword">and</span></span> while_eval_elim
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stmt.If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="var">?c'</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> if_doesnt_read'<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> IntI <span class="quoted"><span class="quoted">‹<span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>›</span></span> empty_iff le_fun_def rev_subsetD while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI <span class="quoted"><span class="quoted">‹<span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>›</span></span> empty_iff le_fun_def rev_subsetD while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while.hyps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="var">?c'</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> if_doesnt_modify<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
                         <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> stop_doesnt_access<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c''</span> <span class="bound">mem''</span> <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span>
            <span class="skolem">c'</span> <span class="main">=</span> <span class="bound">c''</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">∧</span>
            <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∧</span>
            <span class="main">⟨</span><span class="bound">c''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span>
            <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span>
         <span class="skolem"><span class="skolem">c''</span></span> <span class="skolem"><span class="skolem">mem''</span></span> <span class="skolem"><span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c''</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seq_doesnt_read<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> while<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span>›</span></span> locally_sound_mode_use_def while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seq_doesnt_modify<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span>›</span></span> locally_sound_mode_use_def while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoReadOrWrite <span class="main">⟶</span> doesnt_read_or_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_or_modify_def doesnt_read_or_modify_vars_def <span class="keyword2"><span class="keyword">and</span></span> doesnt_modify_def
          <span class="keyword1"><span class="command">using</span></span> while_eval' <span class="keyword2"><span class="keyword">and</span></span> while_eval_elim'
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>seq <span class="skolem">mds</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mds''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≤</span> <span class="skolem">mds''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword1"><span class="command">from</span></span> seq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> seq_loc_reach<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> seq_doesnt_modify seq_doesnt_read<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="skolem">c</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> inf_absorb2 le_infI1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Example">
<div class="head">
<h1>Theory Example</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Example
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Compositionality.html">../Compositionality</a>"</span> <span class="quoted">"<a href="Language.html">../Language</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> addr <span class="main">=</span> control_var <span class="main">|</span> buffer <span class="main">|</span> high_var <span class="main">|</span> low_var <span class="main">|</span> temp
<span class="keyword1"><span class="command">type_synonym</span></span> val <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> mem <span class="main">=</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> val"</span></span>


<span class="keyword1"><span class="command">datatype</span></span> aexp <span class="main">=</span> Const <span class="quoted">val</span> <span class="main">|</span>
                Load <span class="quoted">addr</span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> aexp <span class="main">⇒</span> val"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Load <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
 

<span class="keyword1"><span class="command">datatype</span></span> bexp <span class="main">=</span> Cmp <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"addr"</span></span> <span class="main">|</span>
                Eq <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"val"</span></span> <span class="main">|</span>
                Neq <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"val"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> bexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dma_control_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> Sec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_control_var</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> addr <span class="main">⇒</span> Sec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> buffer <span class="keyword1">then</span> dma_control_var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> control_var<span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> high_var <span class="keyword1">then</span> High <span class="keyword1">else</span> Low"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">𝒞_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> buffer <span class="keyword1">then</span> <span class="main">{</span>control_var<span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mds<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Mode <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mds<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_example <span class="main">=</span>
  sifum_lang_no_dma <span class="quoted">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="quoted">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval_det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc'</span><span class="main">)</span> <span class="main">∈</span> sifum_lang_no_dma.eval<span class="hidden">⇩</span><sub>w</sub> ev<span class="hidden">⇩</span><sub>A</sub> ev<span class="hidden">⇩</span><sub>B</sub> <span class="main">⟹</span> <span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc''</span><span class="main">)</span> <span class="main">∈</span> sifum_lang_no_dma.eval<span class="hidden">⇩</span><sub>w</sub> ev<span class="hidden">⇩</span><sub>A</sub> ev<span class="hidden">⇩</span><sub>B</sub> <span class="main">⟹</span> <span class="free">lc'</span> <span class="main">=</span> <span class="free">lc''</span>"</span></span>
 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒞</span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> 𝒞_vars <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sifum_example <span class="main">⊆</span> sifum_security <span class="quoted">dma</span> <span class="quoted">𝒞_vars</span> <span class="quoted">𝒞</span> <span class="quoted">eval<span class="hidden">⇩</span><sub>w</sub></span> <span class="quoted">undefined</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_det<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Var_finite<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_vars_def dma_def 𝒞_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_example <span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">read_buffer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>addr<span class="main">,</span> aexp<span class="main">,</span> bexp<span class="main">)</span> Stmt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">read_buffer</span> <span class="main">≡</span> 
     ModeDecl Skip <span class="main">(</span>Acq buffer AsmNoWrite<span class="main">)</span> <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Acq temp AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     Assign temp <span class="main">(</span>Load buffer<span class="main">)</span> <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">(* Note: this invariant ends up tracking mode changes, plus the values of
         variables with an AsmNoWrite assumption --- in this case
         control_var. Thus it feels like it is the sort of thing a 
         flow-sensitive type system should be able to track *)</span>
<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>addr<span class="main">,</span> aexp<span class="main">,</span> bexp<span class="main">)</span> Stmt<span class="main">,</span> addr<span class="main">,</span> val<span class="main">)</span> LocalConf<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  inv<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> read_buffer<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  inv<span class="hidden">⇩</span><sub>1</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>Stop <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Acq temp AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     Assign temp <span class="main">(</span>Load buffer<span class="main">)</span> <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     buffer <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">;</span> buffer <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  inv<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>ModeDecl Skip <span class="main">(</span>Acq temp AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     Assign temp <span class="main">(</span>Load buffer<span class="main">)</span> <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     buffer <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">;</span>  buffer <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  inv<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>Stop <span class="main">;;</span> 
     Assign temp <span class="main">(</span>Load buffer<span class="main">)</span> <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     buffer <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">;</span> temp <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">;</span>  buffer <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  inv<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span> 
     Assign temp <span class="main">(</span>Load buffer<span class="main">)</span> <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     buffer <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">;</span> temp <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">;</span> buffer <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>

  inv<span class="hidden">⇩</span><sub>3</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>
     Stop <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     buffer <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">;</span> temp <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">;</span>  buffer <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  inv<span class="hidden">⇩</span><sub>4</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     buffer <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">;</span> temp <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">;</span> buffer <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  inv<span class="hidden">⇩</span><sub>5</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     buffer <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">;</span> temp <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> control_var <span class="main">=</span> <span class="main">0</span><span class="main">;</span> buffer <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  inv<span class="hidden">⇩</span><sub>6</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     buffer <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">;</span> temp <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> control_var <span class="main">≠</span> <span class="main">0</span><span class="main">;</span> buffer <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoReadOrWrite<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  inv<span class="hidden">⇩</span><sub>7</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Stop<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">inv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span>"</span></span>

<span class="comment1">(* Note: this relational invariant is tracking equalities on AsmNoRead
         variables, based on classification in formation which here we
         have encoded as ahead-of-time information about control_var but
         could be written instead as assertions about "dma buffer".
         Again it feels like something a flow-sensitive type system should
         be able to track, assuming we can accurately track changes to dma,
         which feels like it should be possible *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">rel_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>addr<span class="main">,</span> aexp<span class="main">,</span> bexp<span class="main">)</span> Stmt<span class="main">,</span> addr<span class="main">,</span> val<span class="main">)</span> LocalConf<span class="main">)</span> rel"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span> Stop <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> control_var <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> temp <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> temp<span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_inv</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span> Stop <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> control_var <span class="main">≠</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_inv</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> control_var <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> temp <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> temp<span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_inv</span>"</span></span> <span class="main">|</span>
     <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> control_var <span class="main">≠</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_inv</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> control_var <span class="main">=</span> <span class="main">0</span><span class="main">;</span> 
      <span class="free"><span class="bound"><span class="entity">mem</span></span></span> temp <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> temp<span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_inv</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> <span class="main">(</span>Stop <span class="main">;;</span> <span class="main">(</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> <span class="main">(</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_inv</span>"</span></span>

<span class="comment1">(* the bisimulation is phrased as a conjunction of a global invariant and a 
   relational invariant, defined above, plus the background requirement
   of low-equivalence modulo modes *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span>  
  <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>addr<span class="main">,</span> aexp<span class="main">,</span> bexp<span class="main">)</span> Stmt<span class="main">,</span> addr<span class="main">,</span> val<span class="main">)</span> LocalConf<span class="main">)</span> rel"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">;</span> low_mds_eq <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">;</span> inv <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">;</span>
    <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> rel_inv<span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"control_var <span class="main">∈</span> 𝒞"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒞_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">buffer</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒞_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-low_mds_eq_control_var_eq"><span class="command">lemma</span></span> low_mds_eq_control_var_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"low_mds_eq <span class="free">mds</span> <span class="free">mem</span> <span class="free">mem'</span> <span class="main">⟹</span> <span class="free">mem</span> control_var <span class="main">=</span> <span class="free">mem'</span> control_var"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def dma_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  
<span class="keyword1" id="Example-inv_low_mds_eq"><span class="command">lemma</span></span> inv_low_mds_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="main">=</span> <span class="free">c'</span><span class="main">;</span> <span class="free">mds</span> <span class="main">=</span> <span class="free">mds'</span><span class="main">;</span> low_mds_eq <span class="free">mds</span> <span class="free">mem</span> <span class="free">mem'</span><span class="main">;</span> inv <span class="main">⟨</span><span class="free">c</span><span class="main">,</span><span class="free">mds</span><span class="main">,</span><span class="free">mem</span><span class="main">⟩</span><span class="main">⟧</span>  <span class="main">⟹</span>
   inv <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span><span class="free">mds'</span><span class="main">,</span><span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> inv.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> low_mds_eq_control_var_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-rel_inv_sym"><span class="command">lemma</span></span> rel_inv_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"low_mds_eq <span class="free">mds</span> <span class="free">mem</span> <span class="free">mem'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> rel_inv <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> rel_inv"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_inv.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_control_var_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-R_sym'"><span class="command">lemma</span></span> R_sym'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> R.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> low_mds_eq_sym <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv_low_mds_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_inv_sym<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-R_sym"><span class="command">lemma</span></span> R_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sym R"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> symI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> R_sym'<span class="main">)</span>


<span class="keyword1" id="Example-inv_closed_glob_consistent"><span class="command">lemma</span></span> inv_closed_glob_consistent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free">A</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="free">mds'</span> <span class="bound">x</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> dma <span class="free">mem</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> dma <span class="free">mem</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="free">mds'</span> <span class="bound">x</span>  <span class="main">⟹</span>
       inv <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> inv.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">control_var</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">buffer</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dma_def dma_control_var_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_asm_not_written_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">control_var</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">buffer</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dma_def dma_control_var_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_asm_not_written_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-updates_to_control_var"><span class="command">lemma</span></span> updates_to_control_var<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> dma <span class="free">mem</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> dma <span class="free">mem</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="free">mds'</span> <span class="bound">x</span>  <span class="main">⟹</span>
    buffer <span class="main">∈</span> <span class="free">mds'</span> AsmNoWrite <span class="main">⟹</span>
    <span class="keyword1">case</span> <span class="free">A</span> control_var <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mem</span> control_var <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">buffer</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dma_def dma_control_var_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_asm_not_written_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-blah"><span class="command">lemma</span></span> blah<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">mem'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="free">mds'</span> <span class="bound">x</span> <span class="main">⟹</span>
    <span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="free">x</span> <span class="main">⟹</span>
    <span class="free">x</span> <span class="main">∈</span> <span class="free">mds'</span> AsmNoReadOrWrite <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">mds'</span> AsmNoWrite <span class="main">⟹</span>  <span class="free">mem</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">A</span><span class="main">]</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_asm_not_written_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-rel_inv_closed_glob_consistent"><span class="command">lemma</span></span> rel_inv_closed_glob_consistent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> rel_inv <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">x</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span>
          <span class="free">A</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">mem'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="free">mds'</span> <span class="bound">x</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> dma <span class="free">mem</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> dma <span class="free">mem</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">¬</span> var_asm_not_written <span class="free">mds'</span> <span class="bound">x</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> dma <span class="free">mem</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">mds'</span> AsmNoReadOrWrite <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> 𝒞<span class="main">)</span> <span class="main">⟶</span>
           <span class="free">mem</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">A</span><span class="main">]</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> rel_inv"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_inv.cases <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> read_buffer_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
       <span class="comment1">(* there are actually 14 goals at this point but 8 are solved at the end by auto, so
          we indent as if there were 6 *)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_inv.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> updates_to_control_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blah<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_inv.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> updates_to_control_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_inv.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> updates_to_control_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blah<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_inv.intros<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> updates_to_control_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_inv.intros<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> updates_to_control_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blah<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_inv.intros<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> updates_to_control_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>

<span class="keyword1" id="Example-R_closed_glob_consistent"><span class="command">lemma</span></span> R_closed_glob_consistent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed_glob_consistent R"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_closed_glob_consistent <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv_closed_glob_consistent<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-R_low_mds_eq"><span class="command">lemma</span></span> R_low_mds_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R <span class="main">⟹</span>
        low_mds_eq <span class="free">mds</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> R.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-decl_eval"><span class="command">lemma</span></span> decl_eval<span class="hidden">⇩</span><sub>w</sub>'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> update_modes <span class="free">upd</span> <span class="free">mds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Skip<span class="main">@[</span><span class="free">upd</span><span class="main">]</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> decl<span class="main">[</span><span class="operator">OF</span> unannotated<span class="main">,</span> <span class="operator">OF</span> skip<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemmas</span></span> decl_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> decl<span class="main">[</span><span class="operator">OF</span> unannotated<span class="main">,</span> <span class="operator">OF</span> skip<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> seq_stop_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> seq_stop<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> assign_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> assign<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> if_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> cond<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> if_false_eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">=</span> unannotated<span class="main">[</span><span class="operator">OF</span> if_false<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="Example-𝒞_simp"><span class="command">lemma</span></span> 𝒞_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒞 <span class="main">=</span> <span class="main">{</span>control_var<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_def 𝒞_vars_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-buffer_eq"><span class="command">lemma</span></span> buffer_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> control_var <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> buffer <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite <span class="main">⟹</span> low_mds_eq <span class="free">mds'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">⟹</span>
  <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> buffer <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> buffer"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> mp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dma_def dma_control_var_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-rel_inv_init"><span class="command">lemma</span></span> rel_inv_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"buffer <span class="main">∉</span> <span class="free">mds'</span> AsmNoReadOrWrite <span class="main">⟹</span> low_mds_eq <span class="free">mds'</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⟨</span>Stop <span class="main">;;</span>
      Stmt.If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>low_var <span class="main">←</span> Load temp<span class="main">)</span>
       <span class="main">(</span>high_var <span class="main">←</span> Load temp<span class="main">)</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>
     <span class="main">(</span>temp <span class="main">:=</span> ev<span class="hidden">⇩</span><sub>A</sub> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Load buffer<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span>
     <span class="main">⟨</span>Stop <span class="main">;;</span>
      Stmt.If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>low_var <span class="main">←</span> Load temp<span class="main">)</span>
       <span class="main">(</span>high_var <span class="main">←</span> Load temp<span class="main">)</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>
     <span class="main">(</span>temp <span class="main">:=</span> ev<span class="hidden">⇩</span><sub>A</sub> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>Load buffer<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
    <span class="main">∈</span> rel_inv"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> control_var <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> buffer_eq<span class="main">)</span>    
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ev<span class="hidden">⇩</span><sub>A</sub>.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example-R_inv"><span class="command">lemma</span></span> R_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> ev<span class="hidden">⇩</span><sub>A</sub>.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R <span class="main">⟹</span>
       <span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">⟹</span>
       <span class="main">∃</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span>
          <span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">∧</span>
          <span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> R.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> inv.cases<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> read_buffer_def<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> seq_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> upd_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> skip_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> decl_eval<span class="hidden">⇩</span><sub>w</sub>'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inv<span class="hidden">⇩</span><sub>1</sub>'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> seq_stop_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_stop_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> seq_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> upd_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> skip_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> decl_eval<span class="hidden">⇩</span><sub>w</sub>'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inv<span class="hidden">⇩</span><sub>2</sub>'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> seq_stop_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_stop_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> seq_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> assign_elim<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def ev<span class="hidden">⇩</span><sub>A</sub>.simps<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dma_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inv<span class="hidden">⇩</span><sub>3</sub>'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv_init<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> seq_stop_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_stop_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_inv.cases<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>    
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> if_elim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_inv.cases<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_control_var_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_false_eval<span class="hidden">⇩</span><sub>w</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inv<span class="hidden">⇩</span><sub>6</sub><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_control_var_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> assign_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_control_var_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def dma_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ev<span class="hidden">⇩</span><sub>A</sub>.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_inv.cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> assign_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign_eval<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_control_var_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def dma_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ev<span class="hidden">⇩</span><sub>A</sub>.simps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inv.intros<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> stop_no_eval <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Example-strong_low_bisim_mm_R"><span class="command">lemma</span></span> strong_low_bisim_mm_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strong_low_bisim_mm R"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym R"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> R_sym<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_glob_consistent R"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> R_closed_glob_consistent<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>  <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"low_mds_eq <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> R_low_mds_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>  <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span>
        <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub> <span class="main">∧</span>
        <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> R_inv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="Example-read_buffer_secure'"><span class="command">lemma</span></span> read_buffer_secure'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"low_mds_eq mds<span class="hidden">⇩</span><sub>s</sub> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">⟨</span>read_buffer<span class="main">,</span> mds<span class="hidden">⇩</span><sub>s</sub><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span>read_buffer<span class="main">,</span> mds<span class="hidden">⇩</span><sub>s</sub><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inv<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mds<span class="hidden">⇩</span><sub>s</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> read_buffer_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_inv.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"com_sifum_secure <span class="main">(</span>read_buffer<span class="main">,</span>mds<span class="hidden">⇩</span><sub>s</sub><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> com_sifum_secure_def low_indistinguishable_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mm_equiv_intro<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> strong_low_bisim_mm_R<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> read_buffer_secure'<span class="main">)</span>  

<span class="keyword2"><span class="keyword">end</span></span>
 
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TypeSystemTactics">
<div class="head">
<h1>Theory TypeSystemTactics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TypeSystemTactics
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Compositionality.html">../Compositionality</a>"</span>
        <span class="quoted">"<a href="TypeSystem.html">../TypeSystem</a>"</span>
        <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach_Tools.html">HOL-Eisbach.Eisbach_Tools</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Some Eisbach magic to get around Eisbach and locales not getting along *)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data</span> <span class="main">=</span> Proof_Data
<span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> morphism
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="main">_</span> <span class="main">=</span> Morphism.identity<span class="main">;</span>
<span class="main">)</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> wrap <span class="main">=</span> 
  <span class="quoted">‹<span class="entity">Method.text_closure</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">text</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">morph</span> <span class="main">=</span> Data.get <span class="entity">ctxt</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">safe_fact</span> <span class="entity">thm</span> <span class="main">=</span>
        perhaps <span class="main">(</span>try <span class="main">(</span>Morphism.thm <span class="entity">morph</span><span class="main">)</span><span class="main">)</span> <span class="entity">thm</span><span class="main">;</span>
       
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">morph'</span> <span class="main">=</span> Morphism.morphism <span class="inner_quoted">"safe"</span> 
        <span class="main">{</span>binding <span class="main">=</span> <span class="main">[</span>Morphism.binding <span class="entity">morph</span><span class="main">]</span><span class="main">,</span>
         fact <span class="main">=</span> <span class="main">[</span>map <span class="entity">safe_fact</span><span class="main">]</span><span class="main">,</span>
         term <span class="main">=</span> <span class="main">[</span>Morphism.term <span class="entity">morph</span><span class="main">]</span><span class="main">,</span>
         typ <span class="main">=</span> <span class="main">[</span>Morphism.typ <span class="entity">morph</span><span class="main">]</span><span class="main">}</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">text'</span> <span class="main">=</span> <span class="entity">Method.map_source</span> <span class="main">(</span>map <span class="main">(</span>Token.transform <span class="entity">morph'</span><span class="main">)</span><span class="main">)</span> <span class="entity">text</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Method.evaluate_runtime</span> <span class="entity">text'</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">method_setup</span></span> print_headgoal <span class="main">=</span> 
  <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
  <span class="entity">SIMPLE_METHOD</span>
    <span class="main">(</span>SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> 
    <span class="main">(</span>Output.writeln 
    <span class="main">(</span>Pretty.string_of <span class="main">(</span>Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> all_tac<span class="main">)</span><span class="main">)</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> aexpr <span class="keyword2"><span class="keyword">and</span></span> bexpr <span class="keyword2"><span class="keyword">and</span></span> prog <span class="keyword2"><span class="keyword">and</span></span> custom_if
<span class="keyword1"><span class="command">context</span></span> sifum_types_assign
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* More Eisbach magic to get around Eisbach and mutual recursion not getting along *)</span>

<span class="keyword1"><span class="command">method_setup</span></span> call_by_name <span class="main">=</span> <span class="quoted">‹Scan.lift Parse.string &gt;&gt; 
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">str</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> 
    <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>try <span class="main">(</span><span class="entity">Method.check_src</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span>Token.make_src <span class="main">(</span><span class="entity">str</span><span class="main">,</span> Position.none<span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="entity">src</span> <span class="main">=&gt;</span> <span class="entity">Method.evaluate</span> <span class="main">(</span><span class="entity">Method.Source</span> <span class="entity">src</span><span class="main">)</span> <span class="entity">ctxt</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Method.fail</span><span class="main">)</span>›</span>

<span class="comment1">(* Eisbach tactics for partially automating has_type proofs *)</span>

<span class="keyword1"><span class="command">method</span></span> seq_tac 
  <span class="keyword2"><span class="keyword">methods</span></span> tac <span class="main">=</span> 
  <span class="main">(</span><span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> seq_type›</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">tac</span><span class="main">)</span> 

<span class="keyword1"><span class="command">method</span></span> anno_tac 
  <span class="keyword2"><span class="keyword">methods</span></span> tac <span class="main">=</span> 
  <span class="main">(</span><span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> anno_type<span class="main">[</span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main">]</span><span class="keyword3">,</span> 
         <span class="operator">clarsimp</span><span class="keyword3">,</span> 
        <span class="operator">tac</span><span class="keyword3">,</span> 
       <span class="operator">simp</span><span class="keyword3">,</span> 
      <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> add_anno_def subtype_def pred_entailment_def 
                      pred_def bot_Sec_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="keyword3">,</span>
     <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> add_anno_def<span class="keyword3">,</span>
    <span class="operator">simp</span>›</span><span class="main">)</span> 


<span class="keyword1"><span class="command">method</span></span> assign<span class="hidden">⇩</span><sub>2</sub>_tac <span class="main">=</span>
     <span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>2</sub>›</span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> <span class="dynamic"><span class="dynamic">aexpr</span></span><span class="keyword3">;</span> <span class="operator">simp</span>›</span><span class="main"><span class="keyword3">,</span></span> 
      <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span>


<span class="keyword1"><span class="command">method</span></span> assign<span class="hidden">⇩</span><sub>1</sub>_tac <span class="main">=</span>
   <span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="keyword3">,</span>
        <span class="operator">simp</span><span class="keyword3">,</span>
       <span class="operator">simp</span><span class="keyword3">,</span>
      <span class="operator">solves</span> ‹<span class="operator">rule</span> <span class="dynamic"><span class="dynamic">aexpr</span></span><span class="keyword3">;</span>  <span class="operator">simp</span>›<span class="keyword3">,</span>
      <span class="operator">simp</span><span class="keyword3">,</span>
     <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main">:</span> subtype_def pred_def<span class="keyword3">,</span>
    <span class="operator">simp</span>›</span>

<span class="keyword1"><span class="command">method</span></span> assign<span class="hidden">⇩</span><sub>𝒞</sub>_tac <span class="main">=</span>
   <span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub>›</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> <span class="dynamic"><span class="dynamic">aexpr</span></span><span class="keyword3">;</span> <span class="operator">simp</span>›</span><span class="main"><span class="keyword3">,</span></span> 
       <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> 
      <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span> <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span>

<span class="keyword1"><span class="command">method</span></span> if_tac 
  <span class="keyword2"><span class="keyword">methods</span></span> tac <span class="main">=</span> 
  <span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> if_type'›</span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> <span class="dynamic"><span class="dynamic">bexpr</span></span><span class="keyword3">,</span> <span class="operator">simp</span>›</span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">solves</span> <span class="quoted">‹<span class="operator">tac</span>›</span><span class="main"><span class="keyword3">,</span></span> 
     <span class="operator">solves</span> <span class="quoted">‹<span class="operator">tac</span>›</span><span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">solves</span> <span class="quoted">‹<span class="operator">clarsimp</span><span class="keyword3">,</span> <span class="operator">fastforce</span>›</span>

<span class="keyword1"><span class="command">method</span></span> has_type_no_if_tac' 
  <span class="keyword2"><span class="keyword">declares</span></span> aexpr bexpr<span class="main">=</span> 
 <span class="main">(</span><span class="operator">seq_tac</span> <span class="quoted">‹<span class="operator">call_by_name</span> "has_type_no_if_tac'"›</span> <span class="main"><span class="keyword3">|</span></span>
   <span class="operator">anno_tac</span> <span class="quoted">‹<span class="operator">call_by_name</span> "has_type_no_if_tac'"›</span> <span class="main"><span class="keyword3">|</span></span>
   <span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> skip_type›</span> <span class="main"><span class="keyword3">|</span></span> 
   <span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> stop_type›</span> <span class="main"><span class="keyword3">|</span></span>
   <span class="operator">assign<span class="hidden">⇩</span><sub>1</sub>_tac</span><span class="main"><span class="keyword3">|</span></span> 
   <span class="operator">assign<span class="hidden">⇩</span><sub>2</sub>_tac</span> <span class="main"><span class="keyword3">|</span></span> 
   <span class="operator">assign<span class="hidden">⇩</span><sub>𝒞</sub>_tac</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>

<span class="keyword1"><span class="command">method</span></span> has_type_no_if_tac
  <span class="keyword2"><span class="keyword">uses</span></span> prog 
  <span class="keyword2"><span class="keyword">declares</span></span> aexpr bexpr <span class="main">=</span> 
  <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> <span class="dynamic"><span class="dynamic">prog</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">has_type_no_if_tac'</span><span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> has_type_tac'
  <span class="keyword2"><span class="keyword">declares</span></span> aexpr bexpr<span class="main">=</span> 
  <span class="main">(</span><span class="operator">seq_tac</span> <span class="quoted">‹<span class="operator">call_by_name</span> "has_type_tac'"›</span> <span class="main"><span class="keyword3">|</span></span>
   <span class="operator">anno_tac</span> <span class="quoted">‹<span class="operator">call_by_name</span> "has_type_tac'"›</span> <span class="main"><span class="keyword3">|</span></span>
   <span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> skip_type›</span> <span class="main"><span class="keyword3">|</span></span> 
   <span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> stop_type›</span> <span class="main"><span class="keyword3">|</span></span>
   <span class="operator">assign<span class="hidden">⇩</span><sub>2</sub>_tac</span> <span class="main"><span class="keyword3">|</span></span>
   <span class="operator">if_tac</span> <span class="quoted">‹<span class="operator">call_by_name</span> "has_type_tac'"›</span> <span class="main"><span class="keyword3">|</span></span> 
   <span class="operator">assign<span class="hidden">⇩</span><sub>1</sub>_tac</span> <span class="main"><span class="keyword3">|</span></span> 
   <span class="operator">assign<span class="hidden">⇩</span><sub>𝒞</sub>_tac</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>




<span class="keyword1"><span class="command">method</span></span> has_type_tac <span class="keyword2"><span class="keyword">uses</span></span> prog <span class="keyword2"><span class="keyword">declares</span></span> aexpr bexpr <span class="main">=</span> 
  <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> <span class="dynamic"><span class="dynamic">prog</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">has_type_tac'</span><span class="main">)</span>


<span class="keyword1"><span class="command">method</span></span> if_type_tac 
  <span class="keyword2"><span class="keyword">declares</span></span> bexpr custom_if <span class="main">=</span>
   <span class="main">(</span><span class="operator">wrap</span> <span class="quoted">‹<span class="operator">rule</span> <span class="dynamic"><span class="dynamic">custom_if</span></span><span class="keyword3">,</span> 
            <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">bexpr</span></span><span class="keyword3">,</span> 
           <span class="operator">simp</span><span class="keyword3">?</span><span class="keyword3">,</span> 
          <span class="operator">simp</span><span class="keyword3">?</span><span class="keyword3">,</span>
         <span class="operator">has_type_tac'</span><span class="keyword3">,</span> 
        <span class="operator">has_type_tac'</span><span class="keyword3">,</span> 
       (* 
        Check if this work for other cases? 
        If so just give the rest of this method a time out.
        Otherwise, remove from tac and add as explicit lemma proof *)
        (<span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main">:</span> context_equiv_def type_equiv_def subtype_def)<span class="keyword3">?</span><span class="keyword3">,</span>
       (<span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main">:</span> context_equiv_def type_equiv_def subtype_def)<span class="keyword3">?</span><span class="keyword3">,</span>
      (<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> subset_entailment)<span class="keyword3">?</span><span class="keyword3">,</span>
     (<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> subset_entailment)<span class="keyword3">?</span><span class="keyword3">,</span>
    (<span class="operator">clarsimp</span><span class="keyword3">,</span>
    (<span class="operator">subst</span> tyenv_wellformed_def) <span class="keyword3">,</span>
    (<span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main">:</span> mds_consistent_def types_wellformed_def type_wellformed_def types_stable_def)<span class="keyword3">,</span>
    (<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> tyenv_wellformed_def mds_consistent_def))<span class="keyword3">?</span><span class="keyword3">,</span>
   (<span class="operator">clarsimp</span><span class="keyword3">,</span>
   (<span class="operator">subst</span> tyenv_wellformed_def) <span class="keyword3">,</span>
   (<span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main">:</span> mds_consistent_def types_wellformed_def type_wellformed_def types_stable_def)<span class="keyword3">,</span>
   (<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> tyenv_wellformed_def mds_consistent_def))<span class="keyword3">?</span>›</span><span class="main">)</span>


<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> Context.mapping I <span class="main">(</span>Data.put <span class="entity">phi</span><span class="main">)</span>›</span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Example_TypeSystem">
<div class="head">
<h1>Theory Example_TypeSystem</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Example_TypeSystem
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="TypeSystem.html">../TypeSystem</a>"</span> 
  <a href="TypeSystemTactics.html">TypeSystemTactics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> addr <span class="main">=</span> low_var <span class="main">|</span> high_var <span class="main">|</span> control_var <span class="main">|</span> buffer <span class="main">|</span> temp
<span class="keyword1"><span class="command">type_synonym</span></span> val <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> mem <span class="main">=</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> val"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> aexp <span class="main">=</span> Load <span class="quoted"><span class="quoted">"addr"</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> aexp <span class="main">⇒</span> val"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Load <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
 
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">aexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_vars</span> <span class="main">(</span>Load <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">datatype</span></span> bexp <span class="main">=</span> Same <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"addr"</span></span> <span class="main">|</span>
                NotSame <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"addr"</span></span> <span class="main">|</span>
                Eq <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"val"</span></span> <span class="main">|</span>
                Neq <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"val"</span></span> <span class="main">|</span>
                TT <span class="main">|</span> FF

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> bexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Same <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>NotSame <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Neq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> TT <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> FF <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Neq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Same <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>NotSame <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">bexp_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> bexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_neg</span> <span class="main">(</span>Neq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_neg</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Neq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_neg</span> <span class="main">(</span>Same <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>NotSame <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_neg</span> <span class="main">(</span>NotSame <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Same <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_neg</span> TT <span class="main">=</span> FF"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_neg</span> FF <span class="main">=</span> TT"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span>
   <span class="entity">bexp_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> aexp <span class="main">⇒</span> bexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_assign</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Load <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span>Same <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
    
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dma_control_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> Sec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_control_var</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> addr <span class="main">⇒</span> Sec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> buffer <span class="keyword1">then</span> dma_control_var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> control_var<span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> high_var <span class="keyword1">then</span> High <span class="keyword1">else</span> Low"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">𝒞_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> buffer <span class="keyword1">then</span> <span class="main">{</span>control_var<span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mds<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Mode <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mds<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_example <span class="main">=</span>
  sifum_lang_no_dma <span class="quoted">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="quoted">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="quoted">aexp_vars</span> <span class="quoted">bexp_vars</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval_det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc'</span><span class="main">)</span> <span class="main">∈</span> sifum_lang_no_dma.eval<span class="hidden">⇩</span><sub>w</sub> ev<span class="hidden">⇩</span><sub>A</sub> ev<span class="hidden">⇩</span><sub>B</sub> <span class="main">⟹</span> <span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc''</span><span class="main">)</span> <span class="main">∈</span> sifum_lang_no_dma.eval<span class="hidden">⇩</span><sub>w</sub> ev<span class="hidden">⇩</span><sub>A</sub> ev<span class="hidden">⇩</span><sub>B</sub> <span class="main">⟹</span> <span class="free">lc'</span> <span class="main">=</span> <span class="free">lc''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒞</span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> 𝒞_vars <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">dma_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> bexp set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_type</span> high_var <span class="main">=</span> <span class="main">{</span>FF<span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_type</span> buffer <span class="main">=</span> <span class="main">{</span>Eq control_var <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_type</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sifum_example <span class="main">⊆</span> sifum_types_assign <span class="quoted">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="quoted">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="quoted">aexp_vars</span> <span class="quoted">bexp_vars</span> <span class="quoted">dma</span> <span class="quoted">𝒞_vars</span> <span class="quoted">𝒞</span> <span class="quoted">bexp_neg</span> <span class="quoted">dma_type</span> <span class="quoted">FF</span> <span class="quoted">bexp_assign</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_det<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Var_finite<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_vars_def dma_def 𝒞_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> mem e<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dma_def dma_control_var_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_vars_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_example <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">read_buffer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>addr<span class="main">,</span> aexp<span class="main">,</span> bexp<span class="main">)</span> Stmt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">read_buffer</span> <span class="main">≡</span> 
     ModeDecl Skip <span class="main">(</span>Acq control_var AsmNoWrite<span class="main">)</span> <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Acq temp AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     Assign temp <span class="main">(</span>Load buffer<span class="main">)</span> <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign low_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign high_var <span class="main">(</span>Load temp<span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Example_TypeSystem-𝒞_simp"><span class="command">lemma</span></span> 𝒞_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒞 <span class="main">=</span> <span class="main">{</span>control_var<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_def 𝒞_vars_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  
<span class="keyword1" id="Example_TypeSystem-type_aexpr_Load"><span class="command">lemma</span></span> type_aexpr_Load<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> dom <span class="free">Γ</span> <span class="main">⟹</span> type_aexpr <span class="free">Γ</span> <span class="main">(</span>Load <span class="free">v</span><span class="main">)</span> <span class="main">(</span>dma_type <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Load <span class="free">v</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_TypeSystem-type_aexpr_Load'"><span class="command">lemma</span></span> type_aexpr_Load'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="free">Γ</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> type_aexpr <span class="free">Γ</span> <span class="main">(</span>Load <span class="free">v</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Load <span class="free">v</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">declare</span></span> restrict_preds_to_vars_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> add_pred_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> stable_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> to_total_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> 𝒞_vars_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> anno_type_stable_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> anno_type_sec_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> assign_post_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred_entailment <span class="free">P</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> pred_entailment <span class="free">P</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FF <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> pred_entailment <span class="free">P</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>

<span class="keyword1" id="Example_TypeSystem-read_buffer_typed"><span class="command">lemma</span></span> read_buffer_typed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> read_buffer <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> read_buffer_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>    
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_bexprI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtype_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtype_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_TypeSystem-read_buffer_com_sifum_secure"><span class="command">lemma</span></span> read_buffer_com_sifum_secure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"com_sifum_secure <span class="main">(</span>read_buffer<span class="main">,</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> read_buffer_typed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> typed_secure<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Γ_of_mds_def 𝒮_of_mds_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_yields_stable_types_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">write_buffer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>addr<span class="main">,</span> aexp<span class="main">,</span> bexp<span class="main">)</span> Stmt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">write_buffer</span> <span class="main">≡</span> 
     ModeDecl Skip <span class="main">(</span>Acq control_var AsmNoWrite<span class="main">)</span> <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Acq temp AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     If <span class="main">(</span>Eq control_var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Assign temp <span class="main">(</span>Load low_var<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign temp <span class="main">(</span>Load high_var<span class="main">)</span><span class="main">)</span> <span class="main">;;</span>
     Assign buffer <span class="main">(</span>Load temp<span class="main">)</span>"</span></span>

<span class="keyword1" id="Example_TypeSystem-restrict_preds_to_vars_empty"><span class="command">lemma</span></span> restrict_preds_to_vars_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_preds_to_vars <span class="main">{}</span> <span class="free">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_TypeSystem-restrict_preds_to_vars_idemp"><span class="command">lemma</span></span> restrict_preds_to_vars_idemp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_preds_to_vars <span class="main">(</span>restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span><span class="main">)</span> <span class="free">V</span> <span class="main">=</span> 
   restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_TypeSystem-restrict_preds_to_vars_insert1"><span class="command">lemma</span></span> restrict_preds_to_vars_insert1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>bexp_vars <span class="free">a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V</span><span class="main">)</span> <span class="main">⟹</span> restrict_preds_to_vars <span class="main">(</span>insert <span class="free">a</span> <span class="free">P</span><span class="main">)</span> <span class="free">V</span> <span class="main">=</span> <span class="main">(</span>insert <span class="free">a</span> <span class="main">(</span>restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_TypeSystem-restrict_preds_to_vars_insert2"><span class="command">lemma</span></span> restrict_preds_to_vars_insert2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>bexp_vars <span class="free">a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">V</span><span class="main">)</span> <span class="main">⟹</span> restrict_preds_to_vars <span class="main">(</span>insert <span class="free">a</span> <span class="free">P</span><span class="main">)</span> <span class="free">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Eq <span class="free">a</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> Neq <span class="free">a</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> pred_entailment <span class="free">P</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">declare</span></span> restrict_preds_to_vars_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Example_TypeSystem-write_buffer_typed"><span class="command">lemma</span></span> write_buffer_typed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> write_buffer <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> write_buffer_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ'''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>temp <span class="main">↦</span> dma_type buffer<span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P'''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_bexprI<span class="main">)</span>        
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> context_equiv_def  type_equiv_def subtype_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> context_equiv_def type_equiv_def subtype_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
    <span class="comment1">(* need to be careful how we unfold here as otherwise the tactics get overwhelmed *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> tyenv_wellformed_def<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def types_wellformed_def type_wellformed_def types_stable_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> tyenv_wellformed_def<span class="main">)</span> 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def types_wellformed_def type_wellformed_def types_stable_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Example_TypeSystem-read_buffer_typed'"><span class="command">lemma</span></span> read_buffer_typed'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> read_buffer <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">has_type_tac</span> <span class="quasi_keyword">prog</span><span class="main"><span class="main">:</span></span> read_buffer_def 
       <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span>type_aexpr_Load' type_aexpr_Load 
       <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span>type_bexprI<span class="main">)</span>
 
 
<span class="keyword1" id="Example_TypeSystem-write_buffer_typed'"><span class="command">lemma</span></span> write_buffer_typed'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> write_buffer <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac</span> <span class="quasi_keyword">prog</span><span class="main"><span class="main">:</span></span> write_buffer_def <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span>type_aexpr_Load' type_aexpr_Load <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span>type_bexprI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">if_type_tac</span> <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span> type_bexprI
          <span class="quasi_keyword">custom_if</span><span class="main"><span class="main">:</span></span> if_type<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ'''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>temp <span class="main">↦</span> dma_type buffer<span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P'''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac'</span> <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span>type_aexpr_Load' type_aexpr_Load <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span>type_bexprI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Example_Swap_Add">
<div class="head">
<h1>Theory Example_Swap_Add</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: Value-Dependent SIFUM-Type-Systems
Authors: Toby Murray, Robert Sison, Edward Pierzchalski, Christine Rizkallah
(Based on the SIFUM-Type-Systems AFP entry, whose authors
 are: Sylvia Grewe, Heiko Mantel, Daniel Schoepe)
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Example_Swap_Add
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="TypeSystem.html">../TypeSystem</a>"</span> 
  <a href="TypeSystemTactics.html">TypeSystemTactics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Use upper-case variable names to avoid clashing with one-letter free variables
›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> addr <span class="main">=</span> X <span class="main">|</span> control_X <span class="main">|</span> Y <span class="main">|</span> control_Y <span class="main">|</span> Z <span class="main">|</span> control_Z
<span class="keyword1"><span class="command">type_synonym</span></span> val <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> mem <span class="main">=</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> val"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> aexp <span class="main">=</span> Load <span class="quoted"><span class="quoted">"addr"</span></span> <span class="main">|</span> Const <span class="quoted"><span class="quoted">"val"</span></span> <span class="main">|</span> Add <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"addr"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> aexp <span class="main">⇒</span> val"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Load <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Add <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
 
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">aexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_vars</span> <span class="main">(</span>Load <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_vars</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_vars</span> <span class="main">(</span>Add <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">datatype</span></span> bexp <span class="main">=</span> Same <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"aexp"</span></span> <span class="main">|</span>
                Eq <span class="quoted"><span class="quoted">"addr"</span></span> <span class="quoted"><span class="quoted">"val"</span></span> <span class="main">|</span>
                Not <span class="quoted">bexp</span> <span class="main">|</span>
                Imp <span class="quoted">bexp</span> <span class="quoted">bexp</span> <span class="main">|</span>
                And <span class="quoted">bexp</span> <span class="quoted">bexp</span> <span class="main">|</span>
                Or <span class="quoted">bexp</span> <span class="quoted">bexp</span> <span class="main">|</span> TT <span class="main">|</span> FF

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> bexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Same <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ev<span class="hidden">⇩</span><sub>A</sub> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟶</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> TT <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> FF <span class="main">=</span> False"</span></span>


<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Same <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span> <span class="main">∪</span> aexp_vars <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∪</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∪</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∪</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

  
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">bexp_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> bexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_neg</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span>
   <span class="entity">bexp_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> aexp <span class="main">⇒</span> bexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_assign</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>  <span class="main">=</span> <span class="main">(</span>Same <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dma_control_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> Sec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_control_var</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">control_var_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> addr"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">control_var_of</span> X <span class="main">=</span> control_X"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">control_var_of</span> Y <span class="main">=</span> control_Y"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">control_var_of</span> Z <span class="main">=</span> control_Z"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mem <span class="main">⇒</span> addr <span class="main">⇒</span> Sec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main">{</span>X<span class="main">,</span>Y<span class="main">,</span>Z<span class="main">}</span> <span class="keyword1">then</span> dma_control_var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>control_var_of <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Low"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">𝒞_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒞_vars</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main">{</span>X<span class="main">,</span>Y<span class="main">,</span>Z<span class="main">}</span> <span class="keyword1">then</span> <span class="main">{</span>control_var_of <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mds<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Mode <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mds<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_example <span class="main">=</span>
  sifum_lang_no_dma <span class="quoted">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="quoted">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="quoted">aexp_vars</span> <span class="quoted">bexp_vars</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval_det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc'</span><span class="main">)</span> <span class="main">∈</span> sifum_lang_no_dma.eval<span class="hidden">⇩</span><sub>w</sub> ev<span class="hidden">⇩</span><sub>A</sub> ev<span class="hidden">⇩</span><sub>B</sub> <span class="main">⟹</span> <span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc''</span><span class="main">)</span> <span class="main">∈</span> sifum_lang_no_dma.eval<span class="hidden">⇩</span><sub>w</sub> ev<span class="hidden">⇩</span><sub>A</sub> ev<span class="hidden">⇩</span><sub>B</sub> <span class="main">⟹</span> <span class="free">lc'</span> <span class="main">=</span> <span class="free">lc''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">𝒞</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒞</span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> 𝒞_vars <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">dma_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr <span class="main">⇒</span> bexp set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_type</span> X <span class="main">=</span> <span class="main">{</span>Eq control_X <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_type</span> Z <span class="main">=</span> <span class="main">{</span>Eq control_Z <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_type</span> Y <span class="main">=</span> <span class="main">{</span>Eq control_Y <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">dma_type</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sifum_example <span class="main">⊆</span> sifum_types_assign <span class="quoted">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="quoted">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="quoted">aexp_vars</span> <span class="quoted">bexp_vars</span> <span class="quoted">dma</span> <span class="quoted">𝒞_vars</span> <span class="quoted">𝒞</span> <span class="quoted">bexp_neg</span> <span class="quoted">dma_type</span> <span class="quoted">FF</span> <span class="quoted">bexp_assign</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_det<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Var_finite<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_vars_def dma_def 𝒞_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> mem e<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dma_def dma_control_var_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_vars_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒞_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_example <span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1" id="Example_Swap_Add-if_type''"><span class="command">lemma</span></span> if_type''<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>type_bexpr <span class="free">Γ</span> <span class="free">e</span> <span class="free">t</span><span class="main">;</span> pred_entailment <span class="free">P</span> <span class="free">t</span><span class="main">;</span>
    has_type  <span class="free">Γ</span> <span class="free">𝒮</span> <span class="main">(</span>add_pred <span class="free">P</span> <span class="free">𝒮</span> <span class="free">e</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'</span><span class="main">;</span>
    has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="main">(</span>add_pred <span class="free">P</span> <span class="free">𝒮</span> <span class="main">(</span>bexp_neg <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P''</span><span class="main">;</span>
    pred_entailment <span class="free">P'</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span><span class="main">;</span> pred_entailment <span class="free">P''</span> <span class="main">{</span>bexp_neg <span class="free">e</span><span class="main">}</span><span class="main">;</span>  
    <span class="free">P'''</span> <span class="main">=</span> restrict_preds_to_vars <span class="main">(</span><span class="main">(</span><span class="main">(</span>Imp <span class="free">e</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">P'</span> <span class="main">-</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span>Imp <span class="main">(</span>bexp_neg <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">P''</span> <span class="main">-</span> <span class="main">{</span>bexp_neg <span class="free">e</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> stable <span class="free">𝒮'</span> <span class="bound">v</span><span class="main">}</span><span class="main">⟧</span>
<span class="main">⟹</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> <span class="main">(</span>Stmt.If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Γ'</span> <span class="free">𝒮'</span> <span class="free">P'''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> if_type<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def image_def restrict_preds_to_vars_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def image_def restrict_preds_to_vars_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def stable_def image_def restrict_preds_to_vars_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_wellformed_def mds_consistent_def stable_def image_def restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">swap_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>addr<span class="main">,</span> aexp<span class="main">,</span> bexp<span class="main">)</span> Stmt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap_vars</span> <span class="main">≡</span> 
     ModeDecl Skip <span class="main">(</span>Acq control_X AsmNoWrite<span class="main">)</span> <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Acq control_Y AsmNoWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Acq control_Z AsmNoWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Acq X AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Acq Y AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Acq Z AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     Assign Z <span class="main">(</span>Load X<span class="main">)</span> <span class="main">;;</span>
     Assign X <span class="main">(</span>Load Y<span class="main">)</span> <span class="main">;;</span>
     Assign Y <span class="main">(</span>Load Z<span class="main">)</span> <span class="main">;;</span>
     Assign control_Z <span class="main">(</span>Load control_X<span class="main">)</span> <span class="main">;;</span>
     Assign control_X <span class="main">(</span>Load control_Y<span class="main">)</span> <span class="main">;;</span>
     Assign control_Y <span class="main">(</span>Load control_Z<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Rel X AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Rel Y AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Rel Z AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Rel control_X AsmNoWrite<span class="main">)</span> <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Rel control_Y AsmNoWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Rel control_Z AsmNoWrite<span class="main">)</span> <span class="main">;;</span>
     Skip"</span></span>

<span class="keyword1" id="Example_Swap_Add-𝒞_simp"><span class="command">lemma</span></span> 𝒞_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒞 <span class="main">=</span> <span class="main">{</span>control_X<span class="main">,</span> control_Y<span class="main">,</span> control_Z<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒞 <span class="main">=</span> control_var_of <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> X <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> Y <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> Z<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒞_def 𝒞_vars_def UNION_singleton_eq_range<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> X <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> Y <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> Z<span class="main">}</span> <span class="main">=</span> <span class="main">{</span>X<span class="main">,</span> Y<span class="main">,</span> Z<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Example_Swap_Add-type_aexpr_Load"><span class="command">lemma</span></span> type_aexpr_Load<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> dom <span class="free">Γ</span> <span class="main">⟹</span> type_aexpr <span class="free">Γ</span> <span class="main">(</span>Load <span class="free">v</span><span class="main">)</span> <span class="main">(</span>dma_type <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Load <span class="free">v</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-type_aexpr_Load'"><span class="command">lemma</span></span> type_aexpr_Load'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="free">Γ</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> type_aexpr <span class="free">Γ</span> <span class="main">(</span>Load <span class="free">v</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Load <span class="free">v</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-type_aexpr_Add"><span class="command">lemma</span></span> type_aexpr_Add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> dom <span class="free">Γ</span> <span class="main">⟹</span> 
   type_aexpr <span class="free">Γ</span> <span class="main">(</span>Add <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">{</span>dma_type <span class="free">x</span><span class="main">,</span> dma_type <span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Add <span class="free">x</span> <span class="free">y</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-type_aexpr_Add'"><span class="command">lemma</span></span> type_aexpr_Add'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   type_aexpr <span class="free">Γ</span> <span class="main">(</span>Add <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">{</span>dma_type <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Add <span class="free">x</span> <span class="free">y</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-type_aexpr_Add''"><span class="command">lemma</span></span> type_aexpr_Add''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   type_aexpr <span class="free">Γ</span> <span class="main">(</span>Add <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">{</span><span class="free">t</span><span class="main">,</span> dma_type <span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Add <span class="free">x</span> <span class="free">y</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-type_aexpr_Add'''"><span class="command">lemma</span></span> type_aexpr_Add'''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> dom <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   type_aexpr <span class="free">Γ</span> <span class="main">(</span>Add <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">{</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Add <span class="free">x</span> <span class="free">y</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Example_Swap_Add-type_aexpr_Const"><span class="command">lemma</span></span> type_aexpr_Const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"type_aexpr <span class="free">Γ</span> <span class="main">(</span>Const <span class="free">c</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> type_aexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Const <span class="free">c</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">declare</span></span> restrict_preds_to_vars_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> add_pred_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> stable_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> to_total_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> 𝒞_vars_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> anno_type_stable_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> anno_type_sec_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> assign_post_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="keyword1" id="Example_Swap_Add-control_vars_cases"><span class="command">lemma</span></span> control_vars_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"control_X <span class="main">∈</span> 𝒞_vars <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> X"</span></span>
  <span class="quoted"><span class="quoted">"control_Y <span class="main">∈</span> 𝒞_vars <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> Y"</span></span>
  <span class="quoted"><span class="quoted">"control_Z <span class="main">∈</span> 𝒞_vars <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> Z"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Example_Swap_Add-mem_is_different"><span class="command">lemma</span></span> mem_is_different<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="free">y</span> <span class="main">≠</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">¬</span> ev<span class="hidden">⇩</span><sub>B</sub>  <span class="free">mem</span> <span class="main">(</span>Same <span class="free">y</span> <span class="main">(</span>Load <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="free">y</span> <span class="main">≠</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">¬</span> ev<span class="hidden">⇩</span><sub>B</sub>  <span class="free">mem</span> <span class="main">(</span>Same <span class="free">x</span> <span class="main">(</span>Load <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Example_Swap_Add-restrict_preds_to_vars_empty"><span class="command">lemma</span></span> restrict_preds_to_vars_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_preds_to_vars <span class="main">{}</span> <span class="free">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-restrict_preds_to_vars_idemp"><span class="command">lemma</span></span> restrict_preds_to_vars_idemp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_preds_to_vars <span class="main">(</span>restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span><span class="main">)</span> <span class="free">V</span> <span class="main">=</span> 
   restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-restrict_preds_to_vars_insert1"><span class="command">lemma</span></span> restrict_preds_to_vars_insert1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>bexp_vars <span class="free">a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V</span><span class="main">)</span> <span class="main">⟹</span> restrict_preds_to_vars <span class="main">(</span>insert <span class="free">a</span> <span class="free">P</span><span class="main">)</span> <span class="free">V</span> <span class="main">=</span> <span class="main">(</span>insert <span class="free">a</span> <span class="main">(</span>restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-restrict_preds_to_vars_insert2"><span class="command">lemma</span></span> restrict_preds_to_vars_insert2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>bexp_vars <span class="free">a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">V</span><span class="main">)</span> <span class="main">⟹</span> restrict_preds_to_vars <span class="main">(</span>insert <span class="free">a</span> <span class="free">P</span><span class="main">)</span> <span class="free">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">declare</span></span> restrict_preds_to_vars_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred_entailment <span class="free">P</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> pred_entailment <span class="free">P</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FF <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> pred_entailment <span class="free">P</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>

<span class="keyword1" id="Example_Swap_Add-swap_vars_typed"><span class="command">lemma</span></span> swap_vars_typed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> swap_vars <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conc'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Z"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"dma_type Z"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conc'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Y</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"dma_type Z"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_equiv_def subtype_def pred_entailment_def pred_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_wellformed_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_equiv_def subtype_def pred_entailment_def pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_wellformed_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conc'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">X</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"dma_type X"</span></span> <span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Load<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_equiv_def subtype_def pred_entailment_def pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_wellformed_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def subtype_def pred_entailment_def pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def subtype_def pred_entailment_def pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def subtype_def pred_entailment_def pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def subtype_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_anno_def<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def subtype_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_anno_def<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def subtype_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_anno_def<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-swap_vars_sifum_secure"><span class="command">lemma</span></span> swap_vars_sifum_secure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"com_sifum_secure <span class="main">(</span>swap_vars<span class="main">,</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> swap_vars_typed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> typed_secure<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Γ_of_mds_def 𝒮_of_mds_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_yields_stable_types_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">add_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>addr<span class="main">,</span> aexp<span class="main">,</span> bexp<span class="main">)</span> Stmt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_vars</span> <span class="main">≡</span> 
     ModeDecl Skip <span class="main">(</span>Acq control_X AsmNoWrite<span class="main">)</span> <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Acq control_Y AsmNoWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Acq control_Z AsmNoWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Acq Z AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     Assign Z <span class="main">(</span>Add X Y<span class="main">)</span> <span class="main">;;</span>
     If <span class="main">(</span>Eq control_X <span class="main">0</span><span class="main">)</span>
        <span class="main">(</span>If <span class="main">(</span>Eq control_Y <span class="main">0</span><span class="main">)</span>
            <span class="main">(</span>Assign control_Z <span class="main">(</span>Const <span class="main">0</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>Assign control_Z <span class="main">(</span>Const <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>Assign control_Z <span class="main">(</span>Const <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Rel Z AsmNoReadOrWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Rel control_X AsmNoWrite<span class="main">)</span> <span class="main">;;</span> 
     ModeDecl Skip <span class="main">(</span>Rel control_Y AsmNoWrite<span class="main">)</span> <span class="main">;;</span>
     ModeDecl Skip <span class="main">(</span>Rel control_Z AsmNoWrite<span class="main">)</span> <span class="main">;;</span>
     Skip"</span></span>

<span class="keyword1" id="Example_Swap_Add-pred_entailment_singleton_by_case_distinction"><span class="command">lemma</span></span> pred_entailment_singleton_by_case_distinction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Imp <span class="free">e</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> Imp <span class="main">(</span>bexp.Not <span class="free">e</span><span class="main">)</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> pred_entailment <span class="free">P</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_entailment_def pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"ev<span class="hidden">⇩</span><sub>B</sub> <span class="improper">mem</span> <span class="free">e</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Example_Swap_Add-restrict_preds_to_vars_nest"><span class="command">lemma</span></span> restrict_preds_to_vars_nest <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_preds_to_vars <span class="main">(</span>restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span><span class="main">)</span> <span class="free">V'</span> <span class="main">=</span> restrict_preds_to_vars <span class="free">P</span> <span class="main">(</span><span class="free">V</span> <span class="main">∩</span> <span class="free">V'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-restrict_preds_to_vars_imp_image1"><span class="command">lemma</span></span> restrict_preds_to_vars_imp_image1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> bexp_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span> restrict_preds_to_vars <span class="main">(</span>Imp <span class="free">e</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="free">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Example_Swap_Add-restrict_preds_to_vars_imp_image2"><span class="command">lemma</span></span> restrict_preds_to_vars_imp_image2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bexp_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span> restrict_preds_to_vars <span class="main">(</span>Imp <span class="free">e</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="free">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Imp <span class="free">e</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>restrict_preds_to_vars <span class="free">P</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_preds_to_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  
<span class="keyword1" id="Example_Swap_Add-insert_minus1"><span class="command">lemma</span></span> insert_minus1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Example_Swap_Add-insert_minus2"><span class="command">lemma</span></span> insert_minus2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Example_Swap_Add-add_vars_typed"><span class="command">lemma</span></span> add_vars_typed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> add_vars <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> type_aexpr_Add type_aexpr_Add' type_aexpr_Add'' type_aexpr_Add'''<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_bexprI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_bexprI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_total_def<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Const<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Const<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
             
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assign<span class="hidden">⇩</span><sub>𝒞</sub><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_aexpr_Const<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_singleton_by_case_distinction <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtype_def pred_def add_anno_def pred_entailment_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
 
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtype_def pred_def add_anno_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_anno_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> seq_type<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> anno_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl HOL.refl HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> skip_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  

<span class="keyword1"><span class="command">method</span></span> post_conc_tac 
  <span class="keyword2"><span class="keyword">declares</span></span> aexpr bexpr <span class="main">=</span>
  <span class="main">(</span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_equiv_def subtype_def pred_entailment_def pred_def<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_wellformed_def<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> 
   <span class="operator">has_type_tac'</span><span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> conc_tac <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">addr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">addr</span>  <span class="main">=</span>
  <span class="main">(</span><span class="operator">rule</span> conc'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>  x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"dma_type <span class="free">y</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="Example_Swap_Add-swap_vars_typed'"><span class="command">lemma</span></span> swap_vars_typed'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> swap_vars <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac</span> <span class="quasi_keyword">prog</span><span class="main"><span class="main">:</span></span> swap_vars_def <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span> type_aexpr_Load' type_aexpr_Load <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span>type_bexprI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">conc_tac</span> <span class="quoted">Z</span> <span class="quoted">Z</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">conc_tac</span> <span class="quoted">Y</span> <span class="quoted">Z</span><span class="main">)</span>  
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac'</span> <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span>type_aexpr_Load' type_aexpr_Load <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span>type_bexprI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">post_conc_tac</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">post_conc_tac</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac'</span> <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span>type_aexpr_Load' type_aexpr_Load <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span>type_bexprI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">conc_tac</span> <span class="quoted">X</span> <span class="quoted">X</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac'</span> <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span>type_aexpr_Load' type_aexpr_Load <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span>type_bexprI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">post_conc_tac</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1" id="Example_Swap_Add-add_vars_typed'"><span class="command">lemma</span></span> add_vars_typed'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒮</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span><span class="main">.</span> has_type <span class="free">Γ</span> <span class="free">𝒮</span> <span class="free">P</span> add_vars <span class="bound">Γ'</span> <span class="bound">𝒮'</span> <span class="bound">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_no_if_tac</span>
          <span class="quasi_keyword">prog</span><span class="main"><span class="main">:</span></span> add_vars_def
          <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span> type_aexpr_Load' type_aexpr_Load type_aexpr_Add 
           type_aexpr_Add' type_aexpr_Add''  type_aexpr_Const
          <span class="quasi_keyword">bexpr</span><span class="main"><span class="main">:</span></span>type_bexprI<span class="main">)</span> 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_bexprI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> if_type''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ _ HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> type_bexprI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac'</span> <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span> type_aexpr_Const<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac'</span> <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span> type_aexpr_Const<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>     
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac'</span> <span class="quasi_keyword">aexpr</span><span class="main"><span class="main">:</span></span> type_aexpr_Const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pred_entailment_singleton_by_case_distinction <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_entailment<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">has_type_tac'</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>