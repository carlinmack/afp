<div id="CArrays">
<div class="head">
<h1>Theory CArrays</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Arrays without bounds"</span></span>
<span class="keyword1"><span class="command">theory</span></span> CArrays <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For these arrays there is no
        built-in protection against reading or writing out-of-bounds.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> cArray <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">makeCArray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> cArray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">makeCArray</span> <span class="free"><span class="bound"><span class="entity">arraySize</span></span></span> <span class="free"><span class="bound"><span class="entity">fillValue</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">==</span> 
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">arraySize</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">fillValue</span></span></span> <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">readCArray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> cArray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">readCArray</span> <span class="free"><span class="bound"><span class="entity">array</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">array</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">writeCArray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> cArray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> cArray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">writeCArray</span> <span class="free"><span class="bound"><span class="entity">array</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">array</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">value</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* ---------------------------------------------------------------*)</span>

<span class="keyword1"><span class="command">lemma</span></span> makeCArrayCorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> <span class="free">arraySize</span> <span class="main">==&gt;</span>
   readCArray <span class="main">(</span>makeCArray <span class="free">arraySize</span> <span class="free">fillValue</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> <span class="free">fillValue</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> readCArray_def makeCArray_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> writeCArrayCorrect1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"readCArray <span class="main">(</span>writeCArray <span class="free">array</span> <span class="free">index</span> <span class="free">value</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> <span class="free">value</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> readCArray_def writeCArray_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> writeCArrayCorrect2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">index1</span> <span class="main">~=</span> <span class="free">index2</span> <span class="main">==&gt;</span>
   readCArray <span class="main">(</span>writeCArray <span class="free">array</span> <span class="free">index1</span> <span class="free">value</span><span class="main">)</span> <span class="free">index2</span> <span class="main">=</span> 
   readCArray <span class="free">array</span> <span class="free">index2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> readCArray_def writeCArray_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ResizableArrays">
<div class="head">
<h1>Theory ResizableArrays</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Resizable arrays"</span></span>
<span class="keyword1"><span class="command">theory</span></span> ResizableArrays <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These arrays resize themselves, padding with fillValue.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rArray <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">*</span> <span class="main">(</span>nat <span class="main">=&gt;</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fillAndUpdate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> <span class="main">(</span>nat <span class="main">=&gt;</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="main">(</span>nat <span class="main">=&gt;</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fillAndUpdate</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span> <span class="free"><span class="bound"><span class="entity">fillValue</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">==</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">value</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">&lt;=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">fillValue</span></span></span>
     <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">raWrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rArray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> rArray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">raWrite</span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span> <span class="free"><span class="bound"><span class="entity">fillValue</span></span></span> <span class="main">==</span>    
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">len</span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">arr</span></span></span><span class="main">;</span>
        <span class="bound">f</span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">arr</span></span></span>
    <span class="keyword1">in</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="bound">len</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">len</span><span class="main">,</span><span class="bound">f</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">value</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> fillAndUpdate <span class="bound">len</span> <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span> <span class="free"><span class="bound"><span class="entity">fillValue</span></span></span><span class="main">)</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cutoff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> rArray <span class="main">=&gt;</span> <span class="tfree">'a</span> rArray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cutoff</span> <span class="free"><span class="bound"><span class="entity">fill</span></span></span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="main">==</span> 
     <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">arr</span></span></span><span class="main">,</span> 
      <span class="main">%</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="keyword1">then</span> snd <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">fill</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> raWriteSizeSame <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> fst <span class="free">arr</span> <span class="main">==&gt;</span> fst <span class="main">(</span>raWrite <span class="free">arr</span> <span class="free">i</span> <span class="free">value</span> <span class="free">fillValue</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">arr</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> raWrite_def fillAndUpdate_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> raWriteSizeGrows <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">arr</span> <span class="main">&lt;=</span> <span class="free">i</span><span class="main">)</span> <span class="main">==&gt;</span> fst <span class="main">(</span>raWrite <span class="free">arr</span> <span class="free">i</span> <span class="free">value</span> <span class="free">fillValue</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> raWrite_def fillAndUpdate_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> raWriteContentChanged <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>raWrite <span class="free">arr</span> <span class="free">i</span> <span class="free">value</span> <span class="free">fillValue</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">value</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> raWrite_def fillAndUpdate_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> raWriteContentOld <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">j</span> <span class="main">&lt;</span> fst <span class="free">arr</span><span class="main">;</span> <span class="free">i</span> <span class="main">~=</span> <span class="free">j</span> <span class="main">|]</span> <span class="main">==&gt;</span> 
                          snd <span class="main">(</span>raWrite <span class="free">arr</span> <span class="free">i</span> <span class="free">value</span> <span class="free">fillValue</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> snd <span class="free">arr</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> raWrite_def fillAndUpdate_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> raWriteContentFill <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> fst <span class="free">arr</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">|]</span> <span class="main">==&gt;</span> 
                          snd <span class="main">(</span>raWrite <span class="free">arr</span> <span class="free">i</span> <span class="free">value</span> <span class="free">fillValue</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">fillValue</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> raWrite_def fillAndUpdate_def Let_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FileRefinement">
<div class="head">
<h1>Theory FileRefinement</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Data refinement of representation of a file
    Authors:     Karen Zee &lt;kkz at mit.edu&gt; and Viktor Kuncak &lt;vkuncak at mit.edu&gt;
    Maintainer:  Karen Zee &lt;kkz at mit.edu&gt;
    License:     LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Data refinement of representation of a file"</span></span>
<span class="keyword1"><span class="command">theory</span></span> FileRefinement <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <a href="CArrays.html">CArrays</a> <a href="ResizableArrays.html">ResizableArrays</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We describe a file at
  two levels of abstraction: an abstract file, represented as a resizable array, and
  a concrete file, represented using data blocks.
  We consider the following operations:
\begin{verbatim}
makeAFS     :: AFile
afsRead     :: "AFile =&gt; nat ⇀ byte"
afsWrite    :: "AFile =&gt; nat =&gt; byte ⇀ AFile"
afsFileSize :: "AFile =&gt; nat"
\end{verbatim}
›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span>
  <span class="comment1">― ‹unit of file content›</span>
  byte
<span class="keyword1"><span class="command">consts</span></span>
  <span class="comment1">― ‹value used for padding›</span>
  fillByte <span class="main">::</span> <span class="quoted">byte</span>

<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">blockSize</span> <span class="main">::</span> <span class="quoted">nat</span>  <span class="comment1">― ‹in bytes›</span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">numBlocks</span> <span class="main">::</span> <span class="quoted">nat</span>  <span class="comment1">― ‹total number of blocks in the file system›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  nonZeroBlockSize<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">blockSize</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  nonZeroNumBlocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">numBlocks</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* ------------------------------------------------------------ *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract File›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> AFile <span class="main">=</span> <span class="quoted"><span class="quoted">"byte rArray"</span></span> <span class="comment1">― ‹abstract file is a resizable array of bytes›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">makeAF</span> <span class="main">::</span> <span class="quoted">AFile</span>
 <span class="keyword2"><span class="keyword">where</span></span>  <span class="comment1">― ‹initial file has size 0›</span>
  <span class="quoted"><span class="quoted">"<span class="free">makeAF</span> <span class="main">==</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">%</span> <span class="bound">index</span><span class="main">.</span> fillByte<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">afSize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"AFile <span class="main">=&gt;</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹file size is the length of the resizable array›</span>
  <span class="quoted"><span class="quoted">"<span class="free">afSize</span> <span class="free"><span class="bound"><span class="entity">afile</span></span></span> <span class="main">==</span> fst <span class="free"><span class="bound"><span class="entity">afile</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">afRead</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"AFile <span class="main">=&gt;</span> nat <span class="main">⇀</span> byte"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹reading from a file looks up the byte, reporting <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">None</span><span class="antiquote">}</span></span> if the index is out of file bounds›</span>
  <span class="quoted"><span class="quoted">"<span class="free">afRead</span> <span class="free"><span class="bound"><span class="entity">afile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="main">==</span> 
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">afile</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">afile</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">afWrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"AFile <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> byte <span class="main">⇀</span> AFile"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹writing to a file updates the file content and extends the file if there is enough space›</span>
  <span class="quoted"><span class="quoted">"<span class="free">afWrite</span> <span class="free"><span class="bound"><span class="entity">afile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span> <span class="main">==</span> 
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks <span class="keyword1">then</span>
     Some <span class="main">(</span>raWrite <span class="free"><span class="bound"><span class="entity">afile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span> fillByte<span class="main">)</span>
   <span class="keyword1">else</span> None"</span></span>

<span class="comment1">(* ------------------------------------------------------------ *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Concrete File›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> Block <span class="main">=</span> <span class="quoted"><span class="quoted">"byte cArray"</span></span> <span class="comment1">― ‹array of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">blockSize</span><span class="antiquote">}</span></span> bytes›</span>

<span class="keyword1"><span class="command">record</span></span> CFile <span class="main">=</span>
  fileSize      <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">― ‹in bytes›</span>
  nextFreeBlock <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">― ‹next block available for allocation›</span>
  data          <span class="main">::</span> <span class="quoted"><span class="quoted">"Block cArray"</span></span> <span class="comment1">― ‹array of up to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">numBlocks</span><span class="antiquote">}</span></span> blocks›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">makeCF</span> <span class="main">::</span> <span class="quoted">CFile</span>
 <span class="keyword2"><span class="keyword">where</span></span>  <span class="comment1">― ‹initial file has no allocated blocks›</span>
  <span class="quoted"><span class="quoted">"<span class="free">makeCF</span> <span class="main">==</span>
   <span class="main">(|</span> fileSize      <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
      nextFreeBlock <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
      data          <span class="main">=</span> makeCArray numBlocks <span class="main">(</span>makeCArray blockSize fillByte<span class="main">)</span>
   <span class="main">|)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cfSize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cfSize</span> <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="main">==</span> fileSize <span class="free"><span class="bound"><span class="entity">cfile</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cfRead</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> nat <span class="main">⇀</span> byte"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹Looks up correct data block and reads its content,
        if byteIndex is within bounds, else returns None.›</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfRead</span> <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="main">==</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="main">&lt;</span> fileSize <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="keyword1">then</span> 
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="keyword1">div</span> blockSize <span class="keyword1">in</span> 
       <span class="main">(</span><span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="keyword1">mod</span> blockSize <span class="keyword1">in</span>
         Some <span class="main">(</span>readCArray <span class="main">(</span>readCArray <span class="main">(</span>data <span class="free"><span class="bound"><span class="entity">cfile</span></span></span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Writing File›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first present some auxiliary operations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cfWriteNoExtend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> byte <span class="main">=&gt;</span> CFile"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹Writing to a file when
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">byteIndex</span></span><span class="antiquote">}</span></span> is within bounds.›</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfWriteNoExtend</span> <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span> <span class="main">==</span>
   <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="keyword1">div</span> blockSize <span class="keyword1">in</span>
     <span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="keyword1">mod</span> blockSize <span class="keyword1">in</span>
       <span class="keyword1">let</span> <span class="bound">block</span> <span class="main">=</span> readCArray <span class="main">(</span>data <span class="free"><span class="bound"><span class="entity">cfile</span></span></span><span class="main">)</span> <span class="bound">i</span> <span class="keyword1">in</span>
         <span class="free"><span class="bound"><span class="entity">cfile</span></span></span><span class="main">(|</span> data <span class="main">:=</span> 
                 writeCArray <span class="main">(</span>data <span class="free"><span class="bound"><span class="entity">cfile</span></span></span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>writeCArray <span class="bound">block</span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">value</span></span></span><span class="main">)</span> <span class="main">|)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cfExtendFile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> CFile"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹Writing to a file when
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">byteIndex</span></span><span class="antiquote">}</span></span> is out of bounds.  Involves
        allocating a new block.›</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfExtendFile</span> <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="main">==</span>
     <span class="free"><span class="bound"><span class="entity">cfile</span></span></span><span class="main">(|</span> fileSize <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span><span class="main">,</span>
             nextFreeBlock <span class="main">:=</span> Suc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="keyword1">div</span> blockSize<span class="main">)</span> <span class="main">|)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main file write operation.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cfWrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> byte <span class="main">⇀</span> CFile"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹Writes the file at byte location byteIndex, automatically extending
   the file to that byte location if byteIndex is not within bounds.›</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfWrite</span> <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span> <span class="main">==</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks <span class="keyword1">then</span>
       <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="main">&lt;</span> fileSize <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="keyword1">then</span>
         Some <span class="main">(</span>cfWriteNoExtend <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span><span class="main">)</span>
       <span class="keyword1">else</span>
         Some <span class="main">(</span>cfWriteNoExtend <span class="main">(</span>cfExtendFile <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">byteIndex</span></span></span> <span class="free"><span class="bound"><span class="entity">value</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> None"</span></span>

<span class="comment1">(* ---------------------------------------------------------------*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reachability Invariants for Concrete File›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nextFreeBlockInvariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nextFreeBlockInvariant</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">==</span>
   <span class="main">(</span>fileSize <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">+</span> blockSize <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> blockSize <span class="main">=</span> nextFreeBlock <span class="free"><span class="bound"><span class="entity">state</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unallocatedBlocksInvariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹This invariant of the implementation is needed to prove
   writeExtendCorrect. It says that any unallocated block contains
   fillByte's.›</span>
  <span class="quoted"><span class="quoted">"<span class="free">unallocatedBlocksInvariant</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">==</span>
   <span class="main">∀</span><span class="bound">blockNum</span> <span class="bound">i</span> <span class="main">.</span> 
     <span class="main">~</span> <span class="bound">blockNum</span> <span class="main">&lt;</span> nextFreeBlock <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">&amp;</span> <span class="bound">blockNum</span> <span class="main">&lt;</span> numBlocks <span class="main">&amp;</span> <span class="bound">i</span> <span class="main">&lt;</span> blockSize 
     <span class="main">--&gt;</span> data <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="bound">blockNum</span> <span class="bound">i</span> <span class="main">=</span> fillByte"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lastBlockInvariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lastBlockInvariant</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">==</span>
   <span class="main">∀</span><span class="bound">index</span> <span class="main">.</span>
     <span class="main">~</span> <span class="bound">index</span> <span class="main">&lt;</span> fileSize <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">&amp;</span> nextFreeBlock <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">=</span> <span class="bound">index</span> <span class="keyword1">div</span> blockSize <span class="main">+</span> <span class="main">1</span>
     <span class="main">--&gt;</span> data <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span><span class="bound">index</span> <span class="keyword1">div</span> blockSize<span class="main">)</span> <span class="main">(</span><span class="bound">index</span> <span class="keyword1">mod</span> blockSize<span class="main">)</span> <span class="main">=</span> fillByte"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachabilityInvariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachabilityInvariant</span> <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="main">==</span> 
      nextFreeBlockInvariant <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="main">&amp;</span>
      unallocatedBlocksInvariant <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="main">&amp;</span>
      lastBlockInvariant <span class="free"><span class="bound"><span class="entity">cfile</span></span></span>"</span></span>

<span class="comment1">(* ---------------------------------------------------------------*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Initial File Satisfies Invariants›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove each invariant individually and then summarize.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nextFreeBlockInvariant1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nextFreeBlockInvariant makeCF"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nextFreeBlockInvariant_def makeCF_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonZeroBlockSize<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> unallocatedBlocksInvariant1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unallocatedBlocksInvariant makeCF"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unallocatedBlocksInvariant_def makeCF_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> makeCArray_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lastBlockInvariant1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lastBlockInvariant makeCF"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lastBlockInvariant_def makeCF_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> makeCFpreserves<span class="main">:</span> <span class="quoted"><span class="quoted">"reachabilityInvariant makeCF"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachabilityInvariant_def
              nextFreeBlockInvariant1
              unallocatedBlocksInvariant1
              lastBlockInvariant1<span class="main">)</span>

<span class="comment1">(* ---------------------------------------------------------------*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of Concrete File Operations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cfWriteNoExtendPreservesFileSize<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span><span class="main">;</span>
      cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span> <span class="main">=</span> Some <span class="free">cfile2</span>
   <span class="main">|]</span> <span class="main">==&gt;</span> 
   fileSize <span class="free">cfile2</span> <span class="main">=</span> fileSize <span class="free">cfile1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWrite_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWriteNoExtend_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cfWriteExtendFileSize<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">~</span> <span class="free">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span><span class="main">;</span>
      cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span> <span class="main">=</span> Some <span class="free">cfile2</span>
   <span class="main">|]</span> <span class="main">==&gt;</span> fileSize <span class="free">cfile2</span> <span class="main">=</span> Suc <span class="free">index</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWrite_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWriteNoExtend_def cfExtendFile_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fileSizeIncreases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span> <span class="main">=</span> Some <span class="free">cfile2</span>
   <span class="main">==&gt;</span> fileSize <span class="free">cfile1</span> <span class="main">&lt;=</span> fileSize <span class="free">cfile2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWrite_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWriteNoExtend_def cfExtendFile_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nextFreeBlockIncreases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> nextFreeBlockInvariant <span class="free">cfile1</span><span class="main">;</span>
      cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span> <span class="main">=</span> Some <span class="free">cfile2</span>
   <span class="main">|]</span> <span class="main">==&gt;</span> nextFreeBlock <span class="free">cfile1</span> <span class="main">&lt;=</span> nextFreeBlock <span class="free">cfile2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWrite_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWriteNoExtend_def cfExtendFile_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nextFreeBlockInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"nextFreeBlock <span class="free">cfile1</span> <span class="main">=</span> 
  <span class="main">(</span>fileSize <span class="free">cfile1</span> <span class="main">+</span> blockSize <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">index</span> <span class="keyword1">div</span> blockSize<span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="free">index</span> <span class="main">+</span> blockSize<span class="main">)</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fileSize <span class="free">cfile1</span> <span class="main">+</span> blockSize <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">&lt;=</span> 
  <span class="main">(</span><span class="free">index</span> <span class="main">+</span> blockSize<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_le_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fileSize <span class="free">cfile1</span> <span class="main">+</span> blockSize <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> 
  <span class="main">(</span>fileSize <span class="free">cfile1</span> <span class="main">+</span> blockSize<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonZeroBlockSize<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(* ---------------------------------------------------------------*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Concrete File Operations Preserve Invariants›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is only one top-level concrete operation: write, and we
show that it preserves all reachability invariants.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cfWritePreservesNextFreeBlockInvariant<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">[|</span> reachabilityInvariant <span class="free">cfile1</span><span class="main">;</span>
       cfWrite <span class="free">cfile1</span> <span class="free">byteIndex</span> <span class="free">value</span> <span class="main">=</span> Some <span class="free">cfile2</span>
    <span class="main">|]</span> <span class="main">==&gt;</span> nextFreeBlockInvariant <span class="free">cfile2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachabilityInvariant_def
                 cfWrite_def
                 nextFreeBlockInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">byteIndex</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWriteNoExtend_def cfExtendFile_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonZeroBlockSize<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> modInequalityLemma<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">~=</span> <span class="free">b</span> <span class="main">&amp;</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">c</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">mod</span> <span class="free">c</span> <span class="main">==&gt;</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="main">~=</span> <span class="free">b</span> <span class="keyword1">div</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> div_mult_mod_eq <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> div_mult_mod_eq <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">b</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mod_round_lt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>nat<span class="main">)</span><span class="main">;</span>
      <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>
   <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;=</span> <span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="main">&lt;=</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">c</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> div_add_self2 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">b</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_le_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> less_Suc_eq_le <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">b</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> blockNumNELemma<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">blockNum</span> <span class="bound">i</span><span class="main">.</span>
       <span class="main">[|</span> nextFreeBlockInvariant <span class="free">cfile1</span><span class="main">;</span>
          <span class="free">cfile1</span>
          <span class="main">(|</span> data <span class="main">:=</span>
               writeCArray <span class="main">(</span>data <span class="free">cfile1</span><span class="main">)</span> <span class="main">(</span><span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize<span class="main">)</span>
                <span class="main">(</span>writeCArray
                  <span class="main">(</span>readCArray <span class="main">(</span>data <span class="free">cfile1</span><span class="main">)</span> <span class="main">(</span><span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize<span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="free">byteIndex</span> <span class="keyword1">mod</span> blockSize<span class="main">)</span> <span class="free">value</span><span class="main">)</span> <span class="main">|)</span> <span class="main">=</span>
          <span class="free">cfile2</span><span class="main">;</span>
          <span class="main">~</span> <span class="bound">blockNum</span> <span class="main">&lt;</span> nextFreeBlock <span class="free">cfile2</span><span class="main">;</span> <span class="bound">blockNum</span> <span class="main">&lt;</span> numBlocks<span class="main">;</span>
          <span class="bound">i</span> <span class="main">&lt;</span> blockSize<span class="main">;</span> <span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks<span class="main">;</span>
          <span class="free">byteIndex</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span> <span class="main">|]</span>
       <span class="main">==&gt;</span> <span class="bound">blockNum</span> <span class="main">~=</span> <span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nextFreeBlockInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> nextFreeBlock <span class="free">cfile1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"nextFreeBlock <span class="free">cfile1</span> <span class="main">=</span> 
  <span class="main">(</span>fileSize <span class="free">cfile1</span> <span class="main">+</span> blockSize <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> mod_round_lt<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cfWritePreservesUnallocatedBlocksInvariant<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">[|</span> reachabilityInvariant <span class="free">cfile1</span><span class="main">;</span>
       cfWrite <span class="free">cfile1</span> <span class="free">byteIndex</span> <span class="free">value</span> <span class="main">=</span> Some <span class="free">cfile2</span>
    <span class="main">|]</span> <span class="main">==&gt;</span> unallocatedBlocksInvariant <span class="free">cfile2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachabilityInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"nextFreeBlock <span class="free">cfile1</span> <span class="main">&lt;=</span> nextFreeBlock <span class="free">cfile2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unallocatedBlocksInvariant_def cfWrite_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">byteIndex</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWriteNoExtend_def cfExtendFile_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> writeCArray_def readCArray_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">blockNum</span> <span class="main">~=</span> <span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blockNumNELemma<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="improper">blockNum</span> <span class="main">&lt;</span> nextFreeBlock <span class="free">cfile1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">blockNum</span> <span class="main">~=</span> <span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nextFreeBlockIncreases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cfWritePreservesLastBlockInvariant<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">[|</span> reachabilityInvariant <span class="free">cfile1</span><span class="main">;</span>
       cfWrite <span class="free">cfile1</span> <span class="free">byteIndex</span> <span class="free">value</span> <span class="main">=</span> Some <span class="free">cfile2</span> <span class="main">|]</span> <span class="main">==&gt;</span> 
    lastBlockInvariant <span class="free">cfile2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachabilityInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"nextFreeBlock <span class="free">cfile1</span> <span class="main">&lt;=</span> nextFreeBlock <span class="free">cfile2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWrite_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lastBlockInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">byteIndex</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWriteNoExtend_def Let_def cfExtendFile_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> writeCArray_def readCArray_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lastBlockInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">index</span> <span class="main">~=</span> <span class="free">byteIndex</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">index</span> <span class="keyword1">div</span> blockSize <span class="main">~=</span> <span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">index</span> <span class="keyword1">mod</span> blockSize <span class="main">~=</span> <span class="free">byteIndex</span> <span class="keyword1">mod</span> blockSize"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> modInequalityLemma<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">index</span> <span class="main">~=</span> <span class="free">byteIndex</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">index</span> <span class="keyword1">div</span> blockSize <span class="main">~=</span> <span class="free">byteIndex</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">index</span> <span class="keyword1">mod</span> blockSize <span class="main">~=</span> <span class="free">byteIndex</span> <span class="keyword1">mod</span> blockSize"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"nextFreeBlock <span class="free">cfile1</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">index</span> <span class="keyword1">div</span> blockSize<span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="improper">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lastBlockInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unallocatedBlocksInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">index</span> <span class="keyword1">div</span> blockSize"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">index</span> <span class="keyword1">mod</span> blockSize"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonZeroBlockSize<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> modInequalityLemma<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nextFreeBlockIncreases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Final statement that all invariants are preserved.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> cfWritePreserves<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"<span class="main">[|</span> reachabilityInvariant <span class="free">cfile1</span><span class="main">;</span>
       cfWrite <span class="free">cfile1</span> <span class="free">byteIndex</span> <span class="free">value</span> <span class="main">=</span> Some <span class="free">cfile2</span> <span class="main">|]</span> <span class="main">==&gt;</span> 
    reachabilityInvariant <span class="free">cfile2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachabilityInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWritePreservesNextFreeBlockInvariant<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWritePreservesUnallocatedBlocksInvariant<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWritePreservesLastBlockInvariant<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* ---------------------------------------------------------------*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Commuting Diagrams for Simulation Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we show correctness of file system operations.›</span></span>

<span class="comment1">(* ---------------------------------------------------------------*)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Abstraction Function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">abstFn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile <span class="main">=&gt;</span> AFile"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abstFn</span> <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="main">==</span> <span class="main">(</span>fileSize <span class="free"><span class="bound"><span class="entity">cfile</span></span></span><span class="main">,</span> 
                    <span class="main">%</span> <span class="bound">index</span> <span class="main">.</span> <span class="keyword1">case</span> cfRead <span class="free"><span class="bound"><span class="entity">cfile</span></span></span> <span class="bound">index</span> <span class="keyword1">of</span>
                                None       <span class="main">=&gt;</span> fillByte
                              <span class="main">|</span> Some <span class="bound">value</span> <span class="main">=&gt;</span> <span class="bound">value</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">oAbstFn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CFile option <span class="main">=&gt;</span> AFile option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oAbstFn</span> None <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">oAbstFn</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>abstFn <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* ---------------------------------------------------------------*)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Creating a File›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> makeCFCorrect<span class="main">:</span> <span class="quoted"><span class="quoted">"abstFn makeCF <span class="main">=</span> makeAF"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> makeCF_def makeAF_def abstFn_def cfRead_def
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹File Size›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fileSizeCorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cfSize <span class="free">cfile</span> <span class="main">=</span> afSize <span class="main">(</span>abstFn <span class="free">cfile</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfSize_def afSize_def abstFn_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Read Operation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> readCorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cfRead <span class="free">cfile</span> <span class="main">=</span> afRead <span class="main">(</span>abstFn <span class="free">cfile</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abstFn_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfRead_def afRead_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Write Operation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> writeNoExtendCorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span><span class="main">;</span>
      Some <span class="free">cfile2</span> <span class="main">=</span> cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span>
   <span class="main">|]</span> <span class="main">==&gt;</span> Some <span class="main">(</span>abstFn <span class="free">cfile2</span><span class="main">)</span> <span class="main">=</span> afWrite <span class="main">(</span>abstFn <span class="free">cfile1</span><span class="main">)</span> <span class="free">index</span> <span class="free">value</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abstFn_def afWrite_def raWrite_def Let_def cfWrite_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWriteNoExtend_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfRead_def writeCArray_def readCArray_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="main">=</span> <span class="free">index</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">mod</span> blockSize <span class="main">=</span> <span class="free">index</span> <span class="keyword1">mod</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">div</span> blockSize <span class="main">~=</span> <span class="free">index</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> modInequalityLemma<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> writeExtendCorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> nextFreeBlockInvariant <span class="free">cfile1</span><span class="main">;</span>
      unallocatedBlocksInvariant <span class="free">cfile1</span><span class="main">;</span>
      lastBlockInvariant <span class="free">cfile1</span><span class="main">;</span>
      <span class="main">~</span> <span class="free">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span><span class="main">;</span>
      Some <span class="free">cfile2</span> <span class="main">=</span> cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span>
   <span class="main">|]</span> <span class="main">==&gt;</span> Some <span class="main">(</span>abstFn <span class="free">cfile2</span><span class="main">)</span> <span class="main">=</span> afWrite <span class="main">(</span>abstFn <span class="free">cfile1</span><span class="main">)</span> <span class="free">index</span> <span class="free">value</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> nextFreeBlockIncreases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cfile1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">index</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">value</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cfile2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abstFn_def afWrite_def raWrite_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">index</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfWrite_def cfWriteNoExtend_def cfExtendFile_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfRead_def fillAndUpdate_def Let_def writeCArrayCorrect1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="comment1">(* 2 subgoals *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="main">~=</span> <span class="free">index</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">div</span> blockSize <span class="main">=</span> <span class="free">index</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main">)</span> <span class="comment1">(* 3 subgoals *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">mod</span> blockSize <span class="main">=</span> <span class="free">index</span> <span class="keyword1">mod</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> modInequalityLemma<span class="main">)</span> <span class="comment1">(* 3 subgoals *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> writeCArrayCorrect1 writeCArrayCorrect2<span class="main">)</span> <span class="comment1">(* 1 subgoal *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="main">&lt;</span> <span class="free">index</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">div</span> blockSize <span class="main">=</span> <span class="free">index</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main">)</span> <span class="comment1">(* 2 subgoals *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">mod</span> blockSize <span class="main">=</span> <span class="free">index</span> <span class="keyword1">mod</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> modInequalityLemma<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> readCArray_def writeCArray_def lastBlockInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">indexa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"nextFreeBlock <span class="free">cfile1</span> <span class="main">=</span> nextFreeBlock <span class="free">cfile2</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unallocatedBlocksInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="improper">indexa</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> nextFreeBlock <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">mod</span> blockSize <span class="main">&lt;</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> nonZeroBlockSize<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="comment1">(* 1 subgoal *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unallocatedBlocksInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="improper">indexa</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> nextFreeBlock <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> 
  <span class="comment1">(* 2 subgoals *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">indexa</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;=</span> <span class="free">index</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_le_mono<span class="main">)</span> <span class="comment1">(* 1 subgoal *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"nextFreeBlock <span class="free">cfile1</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">indexa</span> <span class="keyword1">div</span> blockSize<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nextFreeBlockInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"nextFreeBlock <span class="free">cfile1</span> <span class="main">=</span> 
  <span class="main">(</span>fileSize <span class="free">cfile1</span> <span class="main">+</span> blockSize <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fileSize <span class="free">cfile1</span> <span class="main">+</span> blockSize <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;=</span>
  Suc <span class="main">(</span><span class="improper">indexa</span> <span class="keyword1">div</span> blockSize<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="improper">indexa</span> <span class="keyword1">div</span> blockSize<span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="improper">indexa</span> <span class="main">+</span> blockSize<span class="main">)</span> <span class="keyword1">div</span> blockSize"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> div_le_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_diff_conv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> writeSucceedCorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> nextFreeBlockInvariant <span class="free">cfile1</span><span class="main">;</span>
      unallocatedBlocksInvariant <span class="free">cfile1</span><span class="main">;</span>
      lastBlockInvariant <span class="free">cfile1</span><span class="main">;</span>
      Some <span class="free">cfile2</span> <span class="main">=</span> cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span>
   <span class="main">|]</span> <span class="main">==&gt;</span> Some <span class="main">(</span>abstFn <span class="free">cfile2</span><span class="main">)</span> <span class="main">=</span> afWrite <span class="main">(</span>abstFn <span class="free">cfile1</span><span class="main">)</span> <span class="free">index</span> <span class="free">value</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> writeExtendCorrect writeNoExtendCorrect<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> writeFailCorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span> <span class="main">=</span> None <span class="main">==&gt;</span> 
   afWrite <span class="main">(</span>abstFn <span class="free">cfile1</span><span class="main">)</span> <span class="free">index</span> <span class="free">value</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abstFn_def cfWrite_def afWrite_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="keyword1">div</span> blockSize <span class="main">&lt;</span> numBlocks"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> fileSize <span class="free">cfile1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> writeCorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reachabilityInvariant <span class="free">cfile1</span> <span class="main">==&gt;</span>
   oAbstFn <span class="main">(</span>cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span><span class="main">)</span> <span class="main">=</span> afWrite <span class="main">(</span>abstFn <span class="free">cfile1</span><span class="main">)</span> <span class="free">index</span> <span class="free">value</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachabilityInvariant_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"cfWrite <span class="free">cfile1</span> <span class="free">index</span> <span class="free">value</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> writeFailCorrect<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> writeSucceedCorrect<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>