<div id="Lexer">
<div class="head">
<h1>Theory Lexer</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       POSIX Lexing with Derivatives of Regular Expressions
    Authors:     Fahad Ausaf &lt;fahad.ausaf at icloud.com&gt;, 2016
                 Roy Dyckhoff &lt;roy.dyckhoff at st-andrews.ac.uk&gt;, 2016
                 Christian Urban &lt;christian.urban at kcl.ac.uk&gt;, 2016
    Maintainer:  Christian Urban &lt;christian.urban at kcl.ac.uk&gt;
*)</span> 

<span class="keyword1"><span class="command">theory</span></span> Lexer
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Regular-Sets/Derivatives.html">Regular-Sets.Derivatives</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Values›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> val <span class="main">=</span> 
  Void
<span class="main">|</span> Atm <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="main">|</span> Seq <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> val"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> val"</span></span>
<span class="main">|</span> Right <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> val"</span></span>
<span class="main">|</span> Left <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> val"</span></span>
<span class="main">|</span> Stars <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> val<span class="main">)</span> list"</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The string behind a value›</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">flat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> val <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flat</span> <span class="main">(</span>Void<span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flat</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flat</span> <span class="main">(</span>Left <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">flat</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flat</span> <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">flat</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flat</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">flat</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">flat</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flat</span> <span class="main">(</span>Stars <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flat</span> <span class="main">(</span>Stars <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">flat</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">flat</span> <span class="main">(</span>Stars <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> flat_Stars <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"flat <span class="main">(</span>Stars <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map flat <span class="free">vs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relation between values and regular expressions›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">Prf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> val <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> Seq <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main"><span class="free">:</span></span> Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> Left <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main"><span class="free">:</span></span> Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> Right <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main"><span class="free">:</span></span> Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> Void <span class="main"><span class="free">:</span></span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> Atm <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">:</span></span> Atom <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> Stars <span class="main">[]</span> <span class="main"><span class="free">:</span></span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="main"><span class="free">⊢</span></span> Stars <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main"><span class="free">:</span></span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> Stars <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> Prf_elims<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> Zero"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> Times <span class="free">r1</span> <span class="free">r2</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> Plus <span class="free">r1</span> <span class="free">r2</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> One"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> Atom <span class="free">c</span>"</span></span>
<span class="comment1">(*  "⊢ vs : Star r"*)</span>

<span class="keyword1"><span class="command">lemma</span></span> Prf_flat_lang<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flat <span class="free">v</span> <span class="main">∈</span> lang <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Prf.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Prf_Stars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="free">vs</span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">:</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> Stars <span class="free">vs</span> <span class="main">:</span> Star <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Prf.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Star_string<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> star <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> concat <span class="bound">ss</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="bound">ss</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_star_iff_concat subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Star_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">ss</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> flat <span class="bound">v</span> <span class="main">∧</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">:</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">vs</span><span class="main">.</span> concat <span class="main">(</span>map flat <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> concat <span class="free">ss</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="bound">vs</span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">:</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> concat.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> set_ConsD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> L_flat_Prf1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flat <span class="free">v</span> <span class="main">∈</span> lang <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> L_flat_Prf2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> lang <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">:</span> <span class="free">r</span> <span class="main">∧</span> flat <span class="bound">v</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Prf.intros<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> Prf.intros<span class="main">(</span>2<span class="main">)</span> flat.simps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">using</span></span> Prf.intros<span class="main">(</span>3<span class="main">)</span> flat.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Prf.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> concE flat.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">vs</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> val<span class="main">)</span> list<span class="main">.</span> concat <span class="main">(</span>map flat <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> <span class="improper">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="bound">vs</span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">:</span> <span class="improper">r</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Stars <span class="improper">vs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Prf_Stars<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Star_string<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Star_val<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> L_flat_Prf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> <span class="main">{</span>flat <span class="bound">v</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">:</span> <span class="free">r</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> L_flat_Prf1 L_flat_Prf2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sulzmann and Lu functions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">mkeps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> val"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkeps</span><span class="main">(</span>One<span class="main">)</span> <span class="main">=</span> Void"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mkeps</span><span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> Seq <span class="main">(</span><span class="free">mkeps</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">mkeps</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mkeps</span><span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> nullable<span class="main">(</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Left <span class="main">(</span><span class="free">mkeps</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Right <span class="main">(</span><span class="free">mkeps</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mkeps</span><span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Stars <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">injval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> val <span class="main">⇒</span> <span class="tfree">'a</span> val"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">injval</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> Void <span class="main">=</span> Atm <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">injval</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Left <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">=</span> Left<span class="main">(</span><span class="free">injval</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">injval</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> Right<span class="main">(</span><span class="free">injval</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">injval</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> Seq <span class="main">(</span><span class="free">injval</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">injval</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Left <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Seq <span class="main">(</span><span class="free">injval</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">injval</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> Seq <span class="main">(</span>mkeps <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">injval</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">injval</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Stars <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Stars <span class="main">(</span><span class="main">(</span><span class="free">injval</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span> 


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Mkeps, injval›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mkeps_nullable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nullable <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> mkeps <span class="free">r</span> <span class="main">:</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Prf.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mkeps_flat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nullable <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flat <span class="main">(</span>mkeps <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> Prf_injval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> deriv <span class="free">c</span> <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="main">(</span>injval <span class="free">r</span> <span class="free">c</span> <span class="free">v</span><span class="main">)</span> <span class="main">:</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rexp.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Prf.intros mkeps_nullable <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Prf_elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="comment1">(* Star *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> Prf.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>7<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Prf.intros<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Prf.intros<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Prf.intros<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Prf_injval_flat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> deriv <span class="free">c</span> <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flat <span class="main">(</span>injval <span class="free">r</span> <span class="free">c</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">#</span> <span class="main">(</span>flat <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Prf_elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> mkeps_flat<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> Prf.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>7<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* HERE *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Our Alternative Posix definition›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">Posix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> val <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∈</span> _ <span class="keyword1">→</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">,</span> 100<span class="main">]</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  Posix_One<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main"><span class="free">∈</span></span> One <span class="main"><span class="free">→</span></span> Void"</span></span>
<span class="main">|</span> Posix_Atom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span> <span class="main"><span class="free">∈</span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Posix_Plus1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Left <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Posix_Plus2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∉</span> lang <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Posix_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∈</span> lang <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main"><span class="free">∈</span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Posix_Star1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main"><span class="free">∈</span></span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="free">→</span></span> Stars <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">;</span> flat <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∈</span> lang <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main"><span class="free">∈</span></span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="free">→</span></span> Stars <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Posix_Star2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main"><span class="free">∈</span></span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="free">→</span></span> Stars <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> Posix_elims<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Zero <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> One <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Atom <span class="free">c</span> <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Plus <span class="free">r1</span> <span class="free">r2</span> <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Times <span class="free">r1</span> <span class="free">r2</span> <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Star <span class="free">r</span> <span class="main">→</span> <span class="free">v</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Posix1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> lang <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"flat <span class="free">v</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Posix.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> Posix1a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Posix.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Prf.intros<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> Posix_mkeps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nullable <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> mkeps <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Posix.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> append.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Posix.intros<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> Posix_determ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="free">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Posix.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Posix_One <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> One <span class="main">→</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Void <span class="main">=</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Posix_Atom <span class="skolem">c</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">∈</span> Atom <span class="skolem">c</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Atm <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Posix_Plus1 <span class="skolem">s</span> <span class="skolem">r1</span> <span class="skolem">v</span> <span class="skolem">r2</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> lang <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix1<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> Left <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v2</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="bound">v2</span> <span class="main">⟹</span> <span class="skolem">v</span> <span class="main">=</span> <span class="bound">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Left <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Posix_Plus2 <span class="skolem">s</span> <span class="skolem">r2</span> <span class="skolem">v</span> <span class="skolem">r1</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> lang <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> Right <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix1<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v2</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="bound">v2</span> <span class="main">⟹</span> <span class="skolem">v</span> <span class="main">=</span> <span class="bound">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Right <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Posix_Times <span class="skolem">s1</span> <span class="skolem">r1</span> <span class="skolem">v1</span> <span class="skolem">s2</span> <span class="skolem">r2</span> <span class="skolem">v2</span> <span class="skolem">v'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v'</span>"</span></span> 
       <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="skolem">r1</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1'</span></span> <span class="skolem"><span class="skolem">v2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> Seq <span class="skolem">v1'</span> <span class="skolem">v2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v2'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Posix1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> IHs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v1'</span><span class="main">.</span> <span class="skolem">s1</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="bound">v1'</span> <span class="main">⟹</span> <span class="skolem">v1</span> <span class="main">=</span> <span class="bound">v1'</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v2'</span><span class="main">.</span> <span class="skolem">s2</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="bound">v2'</span> <span class="main">⟹</span> <span class="skolem">v2</span> <span class="main">=</span> <span class="bound">v2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Seq <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Posix_Star1 <span class="skolem">s1</span> <span class="skolem">r</span> <span class="skolem">v</span> <span class="skolem">s2</span> <span class="skolem">vs</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> Star <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span> 
       <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> Star <span class="skolem">r</span> <span class="main">→</span> Stars <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"flat <span class="skolem">v</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="skolem">r</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">vs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> Stars <span class="main">(</span><span class="skolem">v'</span> <span class="main">#</span> <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Stars <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Posix1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Posix1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Posix_Star1.hyps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> append_Nil append_Nil2<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Posix1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> IHs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v2</span><span class="main">.</span> <span class="skolem">s1</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">→</span> <span class="bound">v2</span> <span class="main">⟹</span> <span class="skolem">v</span> <span class="main">=</span> <span class="bound">v2</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v2</span><span class="main">.</span> <span class="skolem">s2</span> <span class="main">∈</span> Star <span class="skolem">r</span> <span class="main">→</span> <span class="bound">v2</span> <span class="main">⟹</span> Stars <span class="skolem">vs</span> <span class="main">=</span> <span class="bound">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Stars <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Posix_Star2 <span class="skolem">r</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> Star <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Stars <span class="main">[]</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> Posix_injval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">(</span>deriv <span class="free">c</span> <span class="free">r</span><span class="main">)</span> <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="main">(</span>injval <span class="free">r</span> <span class="free">c</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rexp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Zero
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> Zero <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Zero <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Zero <span class="main">→</span> <span class="main">(</span>injval Zero <span class="free">c</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> One
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> One <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Zero <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> One <span class="main">→</span> <span class="main">(</span>injval One <span class="free">c</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Atom <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span> <span class="main">|</span> <span class="main">(</span>ineq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Atom <span class="skolem">d</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>injval <span class="main">(</span>Atom <span class="skolem">d</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> eq
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="main">(</span>Atom <span class="skolem">d</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> One <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> Void"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Atom <span class="skolem">d</span> <span class="main">→</span> injval <span class="main">(</span>Atom <span class="skolem">d</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq eqs 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Posix.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ineq
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="main">(</span>Atom <span class="skolem">d</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Zero <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ineq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Atom <span class="skolem">d</span> <span class="main">→</span> injval <span class="main">(</span>Atom <span class="skolem">d</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> injval <span class="skolem">r1</span> <span class="free">c</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="skolem">r2</span> <span class="free">c</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>left<span class="main">)</span> <span class="skolem">v'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Left <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v'</span>"</span></span> 
              <span class="main">|</span> <span class="main">(</span>right<span class="main">)</span> <span class="skolem">v'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Right <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v'</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> left
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> injval <span class="skolem">r1</span> <span class="free">c</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>Left <span class="skolem">v'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Posix.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> left <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> right
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span> <span class="main">∉</span> lang <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="skolem">r2</span> <span class="free">c</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>Right <span class="skolem">v'</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Posix.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> right <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> injval <span class="skolem">r1</span> <span class="free">c</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="skolem">r2</span> <span class="free">c</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> 
        <span class="main">(</span>left_nullable<span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Left <span class="main">(</span>Seq <span class="skolem">v1</span> <span class="skolem">v2</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span> <span class="quoted"><span class="quoted">"nullable <span class="skolem">r1</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>right_nullable<span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Right <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span>"</span></span>  
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"nullable <span class="skolem">r1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span> <span class="main">∉</span> lang <span class="main">(</span>Times <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>not_nullable<span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Seq <span class="skolem">v1</span> <span class="skolem">v2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>nullable <span class="skolem">r1</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Posix_elims <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def<span class="main">)</span>   
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> left_nullable
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> injval <span class="skolem">r1</span> <span class="free">c</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="skolem">r1</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> Seq <span class="main">(</span>injval <span class="skolem">r1</span> <span class="free">c</span> <span class="skolem">v1</span><span class="main">)</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> left_nullable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Posix.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> left_nullable <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right_nullable
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nullable <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="main">(</span>mkeps <span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Posix_mkeps<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="main">(</span>injval <span class="skolem">r2</span> <span class="free">c</span> <span class="skolem">v1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span> <span class="main">∉</span> lang <span class="main">(</span>Times <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="main">[]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="skolem">r1</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> right_nullable 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def append_eq_Cons_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> concI mem_Collect_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> Seq <span class="main">(</span>mkeps <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>injval <span class="skolem">r2</span> <span class="free">c</span> <span class="skolem">v1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Posix.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> right_nullable <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> not_nullable
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> injval <span class="skolem">r1</span> <span class="free">c</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="skolem">r1</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> Seq <span class="main">(</span>injval <span class="skolem">r1</span> <span class="free">c</span> <span class="skolem">v1</span><span class="main">)</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_nullable 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Posix.intros<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> injval <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_nullable <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">→</span> injval <span class="skolem">r</span> <span class="free">c</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="main">(</span>cons<span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">vs</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Seq <span class="skolem">v1</span> <span class="main">(</span>Stars <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Stars <span class="skolem">vs</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Posix_elims<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Posix.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rotate_tac</span> 3<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> Posix_elims<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix.intros<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Posix.intros<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Star <span class="skolem">r</span> <span class="main">→</span> injval <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> cons
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> deriv <span class="free">c</span> <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">→</span> injval <span class="skolem">r</span> <span class="free">c</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> Star <span class="skolem">r</span> <span class="main">→</span> Stars <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">moreover</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">→</span> injval <span class="skolem">r</span> <span class="free">c</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flat <span class="main">(</span>injval <span class="skolem">r</span> <span class="free">c</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Posix1<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flat <span class="main">(</span>injval <span class="skolem">r</span> <span class="free">c</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="skolem">r</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> Star <span class="skolem">r</span> <span class="main">→</span> Stars <span class="main">(</span>injval <span class="skolem">r</span> <span class="free">c</span> <span class="skolem">v1</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Posix.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Star <span class="skolem">r</span> <span class="main">→</span> injval <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Lexer by Sulzmann and Lu›</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">lexer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> val<span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lexer</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Some<span class="main">(</span>mkeps <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lexer</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">lexer</span> <span class="main">(</span>deriv <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span>  
                    None <span class="main">⇒</span> None
                  <span class="main">|</span> Some<span class="main">(</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> Some<span class="main">(</span>injval <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> lexer_correct_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∉</span> lang <span class="free">r</span> <span class="main">⟷</span> lexer <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"deriv <span class="improper">a</span> <span class="improper">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexer_correct_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> lang <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> lexer <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix_mkeps nullable_iff<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"deriv <span class="improper">a</span> <span class="improper">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv Deriv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Posix_injval <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 

<span class="keyword1"><span class="command">lemma</span></span> lexer_correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lexer <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>lexer <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> lexer_correct_None lexer_correct_Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">using</span></span> Posix1<span class="main">(</span>1<span class="main">)</span> Posix_determ lexer_correct_Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">using</span></span> Posix1<span class="main">(</span>1<span class="main">)</span> lexer_correct_None <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">using</span></span> lexer_correct_None lexer_correct_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Simplifying">
<div class="head">
<h1>Theory Simplifying</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       POSIX Lexing with Derivatives of Regular Expressions
    Authors:     Fahad Ausaf &lt;fahad.ausaf at icloud.com&gt;, 2016
                 Roy Dyckhoff &lt;roy.dyckhoff at st-andrews.ac.uk&gt;, 2016
                 Christian Urban &lt;christian.urban at kcl.ac.uk&gt;, 2016
    Maintainer:  Christian Urban &lt;christian.urban at kcl.ac.uk&gt;
*)</span> 

<span class="keyword1"><span class="command">theory</span></span> Simplifying
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lexer.html">Lexer</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lexer including simplifications›</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">F_RIGHT</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_RIGHT</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Right <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">F_LEFT</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_LEFT</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Left <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">F_Plus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_Plus</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> Right <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">F_Plus</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span>Left <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> Left <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>  
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">F_Plus</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">F_Times1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_Times1</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Seq <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> Void<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">F_Times2</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">F_Times2</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Seq <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> Void<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">F_Times</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">F_Times</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Seq <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">F_Times</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">simp_Plus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simp_Plus</span> <span class="main">(</span>Zero<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> F_RIGHT <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">simp_Plus</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Zero<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> F_LEFT <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">simp_Plus</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> F_Plus <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">simp_Times</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simp_Times</span> <span class="main">(</span>One<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> F_Times1 <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">simp_Times</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span>One<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> F_Times2 <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">simp_Times</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> F_Times <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>  
 
<span class="keyword1"><span class="command">lemma</span></span> simp_Times_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"simp_Times <span class="free">p1</span> <span class="free">p2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>fst <span class="free">p1</span> <span class="main">=</span> One<span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="free">p2</span><span class="main">,</span> F_Times1 <span class="main">(</span>snd <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">p2</span><span class="main">)</span><span class="main">)</span>
                    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>fst <span class="free">p2</span> <span class="main">=</span> One<span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="free">p1</span><span class="main">,</span> F_Times2 <span class="main">(</span>snd <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">p2</span><span class="main">)</span><span class="main">)</span>
                    <span class="keyword1">else</span> <span class="main">(</span>Times <span class="main">(</span>fst <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">p2</span><span class="main">)</span><span class="main">,</span> F_Times <span class="main">(</span>snd <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">p2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">p2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> simp_Times.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> simp_Plus_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"simp_Plus <span class="free">p1</span> <span class="free">p2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>fst <span class="free">p1</span> <span class="main">=</span> Zero<span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="free">p2</span><span class="main">,</span> F_RIGHT <span class="main">(</span>snd <span class="free">p2</span><span class="main">)</span><span class="main">)</span>
                    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>fst <span class="free">p2</span> <span class="main">=</span> Zero<span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="free">p1</span><span class="main">,</span> F_LEFT <span class="main">(</span>snd <span class="free">p1</span><span class="main">)</span><span class="main">)</span>
                    <span class="keyword1">else</span> <span class="main">(</span>Plus <span class="main">(</span>fst <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">p2</span><span class="main">)</span><span class="main">,</span> F_Plus <span class="main">(</span>snd <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">p2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">p2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> simp_Plus.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">simp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">*</span> <span class="main">(</span><span class="tfree">'a</span> val <span class="main">⇒</span> <span class="tfree">'a</span> val<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simp</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> simp_Plus <span class="main">(</span><span class="free">simp</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">simp</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">simp</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> simp_Times <span class="main">(</span><span class="free">simp</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">simp</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">simp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> id<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">slexer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> val<span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">slexer</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Some<span class="main">(</span>mkeps <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">slexer</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="bound">fr</span><span class="main">)</span> <span class="main">=</span> simp <span class="main">(</span>deriv <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
                         <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">slexer</span> <span class="bound">rs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span>  
                            None <span class="main">⇒</span> None
                          <span class="main">|</span> Some<span class="main">(</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> Some<span class="main">(</span>injval <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">fr</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> slexer_better_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"slexer <span class="free">r</span> <span class="main">(</span><span class="free">c</span><span class="main">#</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>slexer <span class="main">(</span>fst <span class="main">(</span>simp <span class="main">(</span>deriv <span class="free">c</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">of</span>  
                            None <span class="main">⇒</span> None
                          <span class="main">|</span> Some<span class="main">(</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> Some<span class="main">(</span>injval <span class="free">r</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>simp <span class="main">(</span>deriv <span class="free">c</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split option.split<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> L_fst_simp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="main">(</span>fst <span class="main">(</span>simp <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Posix_simp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">(</span>simp <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">→</span> <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>simp <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rexp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="skolem">s</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>Zero_Zero<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">=</span> Zero"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> Zero"</span></span>
         <span class="main">|</span> <span class="main">(</span>Zero_NZero<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">=</span> Zero"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">≠</span> Zero"</span></span>
         <span class="main">|</span> <span class="main">(</span>NZero_Zero<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">≠</span> Zero"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> Zero"</span></span>
         <span class="main">|</span> <span class="main">(</span>NZero_NZero<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">≠</span> Zero"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">≠</span> Zero"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Zero_Zero<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Zero <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Posix_elims<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Zero_NZero<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> IH2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> Zero_NZero <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">=</span> Zero"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_fst_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> lang <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> Right <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Posix_Plus2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Zero_NZero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>NZero_Zero<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> IH1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> Left <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Posix_Plus1<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NZero_Zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>NZero_NZero<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>Left<span class="main">)</span> <span class="skolem">v1</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Left <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span>
                  <span class="main">|</span> <span class="main">(</span>Right<span class="main">)</span> <span class="skolem">v2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Right <span class="skolem">v2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> lang <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> Posix_elims<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Left<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Left <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NZero_NZero
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix_Plus1<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span> 
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Right<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Right <span class="skolem">v2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">v2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> lang <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH2 L_fst_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Plus <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NZero_NZero
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix_Plus2<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="skolem">s</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>One_One<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">=</span> One"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
         <span class="main">|</span> <span class="main">(</span>One_NOne<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">=</span> One"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">≠</span> One"</span></span>
         <span class="main">|</span> <span class="main">(</span>NOne_One<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">≠</span> One"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
         <span class="main">|</span> <span class="main">(</span>NOne_NOne<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">≠</span> One"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">≠</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>One_One<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> One <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH1 One_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Void"</span></span> <span class="keyword1"><span class="command">using</span></span> Posix_elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> One <span class="main">→</span> Void"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix_One<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> Void"</span></span> <span class="keyword1"><span class="command">using</span></span> One_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> Void"</span></span> <span class="keyword1"><span class="command">using</span></span> IH2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> Seq <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> Void<span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> Void<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Posix_Times <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c One_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>One_NOne<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH2 One_NOne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> One <span class="main">→</span> Void"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix_One<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">→</span> Void"</span></span> <span class="keyword1"><span class="command">using</span></span> One_NOne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> Void"</span></span> <span class="keyword1"><span class="command">using</span></span> IH1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> One_NOne<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r1</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_fst_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> Seq <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> Void<span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule_tac</span> Posix_Times<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> One_NOne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>NOne_One<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> IH1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> One <span class="main">→</span> Void"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Posix_One<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="main">→</span> Void"</span></span> <span class="keyword1"><span class="command">using</span></span> NOne_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> Void"</span></span> <span class="keyword1"><span class="command">using</span></span> IH2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> Seq <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> Void<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule_tac</span> Posix_Times<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NOne_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>NOne_NOne<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Times <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> eqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Seq <span class="skolem">v1</span> <span class="skolem">v2</span>"</span></span>
                     <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span>
                     <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s1</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∈</span> lang <span class="skolem">r1</span> <span class="main">∧</span> <span class="bound">s<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∈</span> lang <span class="skolem">r2</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> Posix_elims<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_fst_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> <span class="skolem">r1</span> <span class="main">→</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="skolem">r2</span> <span class="main">→</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">v2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH1 IH2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>             
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Times <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="main">→</span> snd <span class="main">(</span>simp <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eqs NOne_NOne
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Posix_Times<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> slexer_correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"slexer <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> lexer <span class="free">r</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"slexer <span class="skolem">r</span> <span class="main">[]</span> <span class="main">=</span> lexer <span class="skolem">r</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> slexer <span class="bound">r</span> <span class="skolem">s</span> <span class="main">=</span> lexer <span class="bound">r</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"slexer <span class="skolem">r</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> lexer <span class="skolem">r</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> lang <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> True
       <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> lang <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword">where</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"lexer <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="skolem">c</span> <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">v1</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> lexer_correct_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">from</span></span> a1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> lang <span class="main">(</span>fst <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_fst_simp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"lexer <span class="main">(</span>fst <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">v2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">v2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lexer_correct_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"slexer <span class="main">(</span>fst <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">from</span></span> a3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> deriv <span class="skolem">c</span> <span class="skolem">r</span> <span class="main">→</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Posix_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">with</span></span> a2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Posix_determ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">with</span></span> a2<span class="main">(</span>1<span class="main">)</span> a4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"slexer <span class="skolem">r</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> lexer <span class="skolem">r</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
     <span class="keyword1"><span class="command">next</span></span> 
     <span class="keyword3"><span class="command">case</span></span> False
       <span class="keyword3"><span class="command">assume</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> lang <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexer <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> lexer_correct_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span>
       <span class="keyword1"><span class="command">from</span></span> b1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> lang <span class="main">(</span>fst <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_fst_simp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexer <span class="main">(</span>fst <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> lexer_correct_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"slexer <span class="main">(</span>fst <span class="main">(</span>simp <span class="main">(</span>deriv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"slexer <span class="skolem">r</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> lexer <span class="skolem">r</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> slexer.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slexer_better_simp<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>