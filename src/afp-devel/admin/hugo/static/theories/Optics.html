<div id="Interp">
<div class="head">
<h1>Theory Interp</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************)</span>
<span class="comment1">(* Project: The Isabelle/UTP Proof System                                     *)</span>
<span class="comment1">(* File: Interp.thy                                                           *)</span>
<span class="comment1">(* Authors: Simon Foster and Frank Zeyda                                      *)</span>
<span class="comment1">(* Emails: simon.foster@york.ac.uk frank.zeyda@york.ac.uk                     *)</span>
<span class="comment1">(******************************************************************************)</span>
<span class="comment1">(* LAST REVIEWED: 7/12/2016 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Interpretation Tools›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Interp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interpretation Locale›</span></span>

<span class="keyword1"><span class="command">locale</span></span> interp <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> f_inj <span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> meta_interp_law<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">Q</span> <span class="bound">P</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equal_intr_rule<span class="main">)</span>
    <span class="comment1">― ‹Subgoal 1›</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">P</span> <span class="keyword1">o</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
    <span class="comment1">― ‹Subgoal 2›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">P</span> <span class="keyword1">o</span> inv <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_inj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_interp_law<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="comment1">― ‹Subgoal 1›</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">P</span> <span class="keyword1">o</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
    <span class="comment1">― ‹Subgoal 2›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">P</span> <span class="keyword1">o</span> inv <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_inj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_interp_law<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="comment1">― ‹Subgoal 1›</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">P</span> <span class="keyword1">o</span> inv <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_inj<span class="main">)</span>
    <span class="comment1">― ‹Subgoal 2›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">P</span> <span class="keyword1">o</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Two">
<div class="head">
<h1>Theory Two</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Types of Cardinality 2 or Greater›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Two
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Real.html">HOL.Real</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The two class states that a type's carrier is either infinite, or else it has a finite 
  cardinality of at least 2. It is needed when we depend on having at least two distinguishable
  elements.›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> two <span class="main">=</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> card_two<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∨</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> two_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> infinite_arbitrarily_large<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="tfree">'a</span> set"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> that
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> card_two that
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_bool card_UNIV_bool card_image card_le_inj finite.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_insert finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> One_nat_def Suc_1 UNIV_eq_I card.empty card.insert finite.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insertCI nat.inject nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> bool <span class="main">::</span> <span class="quoted">two</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> nat <span class="main">::</span> <span class="quoted">two</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> int <span class="main">::</span> <span class="quoted">two</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_UNIV_int<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> rat <span class="main">::</span> <span class="quoted">two</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_UNIV_char_0<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> real <span class="main">::</span> <span class="quoted">two</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_UNIV_char_0<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> list <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">two</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_UNIV_listI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lens_Laws">
<div class="head">
<h1>Theory Lens_Laws</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Core Lens Laws›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lens_Laws
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Two.html">Two</a> <a href="Interp.html">Interp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lens Signature›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory introduces the signature of lenses and indentifies the core algebraic hierarchy of lens 
  classes, including laws for well-behaved, very well-behaved, and bijective lenses~\cite{Foster07,Fischer2015,Gibbons17}.›</span></span>
  
<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> lens <span class="main">=</span>
  lens_get <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">get</span>ı"</span><span class="main">)</span>
  lens_put <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">put</span>ı"</span><span class="main">)</span>

<span class="keyword1"><span class="command">type_notation</span></span>
  lens <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⟹</span>"</span> 0<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Alternative parameters ordering, inspired by Back and von Wright's refinement 
  calculus~\cite{Back1998}, which similarly uses two functions to characterise updates to variables. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">lens_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">lset</span>ı"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lens_set</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">X</span> <span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  \begin{figure}
  \begin{center}
    \includegraphics[width=6cm]{figures/Lens}
  \end{center}
  \vspace{-5ex}
  \caption{Visualisation of a simple lens}
  \label{fig:Lens}
  \end{figure}

  A lens $X : \view \lto \src$, for source type $\src$ and view type $\view$, identifies
  $\view$ with a subregion of $\src$~\cite{Foster07,Foster09}, as illustrated in Figure~\ref{fig:Lens}. The arrow denotes
  $X$ and the hatched area denotes the subregion $\view$ it characterises. Transformations on
  $\view$ can be performed without affecting the parts of $\src$ outside the hatched area. The lens
  signature consists of a pair of functions $\lget_X : \src \Rightarrow \view$ that extracts a view
  from a source, and $\lput_X : \src \Rightarrow \view \Rightarrow \src$ that updates a view within
  a given source. ›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> lens_defs

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">lens_source</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> gives the set of constructible sources; that is those that can be built
  by putting a value into an arbitrary source. ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_source</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒮</span>ı"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lens_source</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s'</span> <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">some_source</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">src</span>ı"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">some_source</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_create</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">create</span>ı"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">create</span></span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">src</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Function $\lcreate_X~v$ creates an instance of the source type of $X$ by injecting $v$
  as the view, and leaving the remaining context arbitrary. ›</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">update</span>ı"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lens_update</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The update function is analogous to the record update function which lifts a function
  on a view type to one on the source type. ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_obs_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≃</span>ı"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≃</span></span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ This relation states that two sources are equivalent outside of the region characterised
  by lens $X$. ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_override</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">◃</span>ı"</span> 95<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">◃</span></span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">lens_override'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> _ <span class="keyword1">on</span> _"</span> <span class="main">[</span>95<span class="main">,</span>0<span class="main">,</span>96<span class="main">]</span> 95<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">⊕<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">◃</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens override uses a lens to replace part of a source type with a given value for the
  corresponding view.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak Lenses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Weak lenses are the least constrained class of lenses in our algebraic hierarchy. They
  simply require that the PutGet law~\cite{Foster09,Fischer2015} is satisfied, meaning that
  $\lget$ is the inverse of $\lput$. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> weak_lens <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> put_get<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span> <span class="main">(</span><span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> source_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="keyword1">𝒮</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_source_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> put_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span> <span class="main">∈</span> <span class="keyword1">𝒮</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_source_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> create_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">create</span> <span class="free">v</span> <span class="main">∈</span> <span class="keyword1">𝒮</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_create_def put_closure<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> src_source <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">src</span> <span class="main">∈</span> <span class="keyword1">𝒮</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> some_in_eq source_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> create_get<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span> <span class="main">(</span><span class="keyword1">create</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_create_def put_get<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> create_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="keyword1">create</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> create_get injI<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> get_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span> <span class="main">(</span><span class="keyword1">update</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="keyword1">get</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> put_get lens_update_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> view_determination<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="free">ρ</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms put_get<span class="main">)</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> put_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="keyword1">put</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> injI view_determination<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> weak_lens.put_get <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> weak_lens.create_get <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-behaved Lenses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Well-behaved lenses add to weak lenses that requirement that the GetPut law~\cite{Foster09,Fischer2015}
  is satisfied, meaning that $\lput$ is the inverse of $\lget$. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> wb_lens <span class="main">=</span> weak_lens <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> get_put<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="main">(</span><span class="keyword1">get</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> put_twice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="main">(</span><span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> get_put put_get<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> put_surjectivity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ρ</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">put</span> <span class="bound">ρ</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_put <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">lemma</span></span> source_stability<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">put</span> <span class="free">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_put <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> source_UNIV <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_eq_I put_closure wb_lens.source_stability wb_lens_axioms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> wb_lens.get_put <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> wb_lens_weak <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wb_lens <span class="free">x</span> <span class="main">⟹</span> weak_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wb_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Mainly Well-behaved Lenses ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Mainly well-behaved lenses extend weak lenses with the PutPut law that shows how one put
  override a previous one. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> mwb_lens <span class="main">=</span> weak_lens <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> put_put<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="main">(</span><span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="free">σ</span> <span class="free">u</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> update_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">update</span> <span class="free">f</span> <span class="main">(</span><span class="keyword1">update</span> <span class="free">g</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">update</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> put_get put_put lens_update_def<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Mainly well-behaved lenses give rise to a weakened version of the $get-put$ law, 
    where the source must be within the set of constructible sources. ›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> weak_get_put<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> <span class="keyword1">𝒮</span> <span class="main">⟹</span> <span class="keyword1">put</span> <span class="free">σ</span> <span class="main">(</span><span class="keyword1">get</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_source_def put_get put_put<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> weak_source_determination<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> <span class="keyword1">𝒮</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> <span class="keyword1">𝒮</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span> <span class="free">σ</span> <span class="main">=</span> <span class="keyword1">get</span> <span class="free">ρ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="free">ρ</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms put_put weak_get_put<span class="main">)</span>

   <span class="keyword1"><span class="command">lemma</span></span> weak_put_eq<span class="main">:</span>
     <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> <span class="keyword1">𝒮</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="free">ρ</span> <span class="free">v</span>"</span></span>
     <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">ρ</span> <span class="free">k</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms put_put weak_get_put<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Provides $s$ is constructible, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="keyword1"><span class="quoted"><span class="keyword1">get</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be uniquely determined from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="keyword1"><span class="quoted"><span class="keyword1">put</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> ›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> weak_get_via_put<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="keyword1">𝒮</span> <span class="main">⟹</span> <span class="keyword1">get</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">put</span> <span class="free">s</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> the_equality weak_get_put<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> put_get<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">partial_lens</span> <span class="main">≡</span> mwb_lens"</span></span>

<span class="keyword1"><span class="command">declare</span></span> mwb_lens.put_put <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> mwb_lens.weak_get_put <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> mwb_lens_weak <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mwb_lens <span class="free">x</span> <span class="main">⟹</span> weak_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mwb_lens.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Very Well-behaved Lenses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Very well-behaved lenses combine all three laws, as in the literature~\cite{Foster09,Fischer2015}.
  The same set of axioms can be found in Back and von Wright's refinement calculus~\cite{Back1998}, 
  though with different names for the functions. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> vwb_lens <span class="main">=</span> wb_lens <span class="main">+</span> mwb_lens
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> source_determination<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span> <span class="free">σ</span> <span class="main">=</span> <span class="keyword1">get</span> <span class="free">ρ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="free">ρ</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms get_put put_put<span class="main">)</span>
    
 <span class="keyword1"><span class="command">lemma</span></span> put_eq<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="free">ρ</span> <span class="free">v</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">ρ</span> <span class="free">k</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms weak_put_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="keyword1"><span class="quoted"><span class="keyword1">get</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be uniquely determined from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="keyword1"><span class="quoted"><span class="keyword1">put</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> ›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> get_via_put<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">put</span> <span class="free">s</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_get_via_put<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> get_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="keyword1">get</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> put_get surjI<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Observation equivalence is an equivalence relation. ›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> lens_obs_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp <span class="main">(≃</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equivpI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reflp <span class="main">(≃</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reflpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_obs_eq_def get_put<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(≃</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sympI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_obs_eq_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> get_put put_put<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transp <span class="main">(≃</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_obs_eq_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> put_put<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">total_lens</span> <span class="main">≡</span> vwb_lens"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vwb_lens_wb <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">x</span> <span class="main">⟹</span> wb_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vwb_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vwb_lens_mwb <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">x</span> <span class="main">⟹</span> mwb_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vwb_lens_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mwb_UNIV_src_is_vwb_lens<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> UNIV <span class="main">⟧</span> <span class="main">⟹</span> vwb_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vwb_lens_def wb_lens_axioms_def wb_lens_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Alternative characterisation: a very well-behaved (i.e. total) lens is a mainly well-behaved
  (i.e. partial) lens whose source is the universe set. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vwb_lens_iff_mwb_UNIV_src<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span>mwb_lens <span class="free">X</span> <span class="main">∧</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mwb_UNIV_src_is_vwb_lens vwb_lens_def wb_lens.source_UNIV<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Ineffectual Lenses ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Ineffectual lenses can have no effect on the view type -- application of the $\lput$ function
  always yields the same source. They are thus, trivially, very well-behaved lenses.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ief_lens <span class="main">=</span> weak_lens <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> put_inef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vwb_lens
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">v</span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="skolem">σ</span> <span class="main">(</span><span class="keyword1">get</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> put_inef<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="main">(</span><span class="keyword1">put</span> <span class="skolem">σ</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="skolem">σ</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> put_inef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ineffectual_const_get<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span>  <span class="main">∀</span> <span class="bound">σ</span><span class="main">∈</span><span class="keyword1">𝒮</span><span class="main">.</span> <span class="keyword1">get</span> <span class="bound">σ</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> put_get put_inef <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">eff_lens</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">(</span>weak_lens <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> ief_lens <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Partially Bijective Lenses ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> pbij_lens <span class="main">=</span> weak_lens <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> put_det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="free">ρ</span> <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> mwb_lens
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">v</span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="main">(</span><span class="keyword1">put</span> <span class="skolem">σ</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="skolem">σ</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> put_det <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> put_is_create<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">create</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_create_def put_det<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> partial_get_put<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> <span class="keyword1">𝒮</span> <span class="main">⟹</span> <span class="keyword1">put</span> <span class="free">σ</span> <span class="main">(</span><span class="keyword1">get</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> put_det weak_get_put<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pbij_lens_weak <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pbij_lens <span class="free">x</span> <span class="main">⟹</span> weak_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbij_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pbij_lens_mwb <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pbij_lens <span class="free">x</span> <span class="main">⟹</span> mwb_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mwb_lens_axioms.intro mwb_lens_def pbij_lens.put_is_create<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pbij_alt_intro<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> weak_lens <span class="free">X</span><span class="main">;</span> <span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⟹</span> <span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> pbij_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pbij_lens_axioms_def pbij_lens_def weak_lens.put_closure weak_lens.put_get<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Bijective Lenses ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Bijective lenses characterise the situation where the source and view type are equivalent:
  in other words the view type full characterises the whole source type. It is often useful
  when the view type and source type are syntactically different, but nevertheless correspond
  precisely in terms of what they observe. Bijective lenses are formulates using
  the strong GetPut law~\cite{Foster09,Fischer2015}.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> bij_lens <span class="main">=</span> weak_lens <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> strong_get_put<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="free">σ</span> <span class="main">(</span><span class="keyword1">get</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> pbij_lens
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">v</span> <span class="skolem">ρ</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="skolem">σ</span> <span class="skolem">v</span> <span class="main">=</span> <span class="keyword1">put</span> <span class="skolem">ρ</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> put_get strong_get_put<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vwb_lens
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">v</span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span> <span class="skolem">σ</span> <span class="main">(</span><span class="keyword1">get</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strong_get_put<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> put_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="keyword1">put</span> <span class="free">σ</span><span class="main">)</span> UNIV UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bijI put_inj strong_get_put surj_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> get_create<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">create</span> <span class="main">(</span><span class="keyword1">get</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_create_def strong_get_put<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> bij_lens.strong_get_put <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> bij_lens.get_create <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_lens_weak <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_lens <span class="free">x</span> <span class="main">⟹</span> weak_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_lens_pbij <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_lens <span class="free">x</span> <span class="main">⟹</span> pbij_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_lens.get_create bij_lens_def pbij_lens_axioms.intro pbij_lens_def weak_lens.put_get<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_lens_vwb <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij_lens <span class="free">x</span> <span class="main">⟹</span> vwb_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_lens.strong_get_put bij_lens_weak mwb_lens.intro mwb_lens_axioms.intro vwb_lens_def wb_lens.intro wb_lens_axioms.intro weak_lens.put_get<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Alternative characterisation: a bijective lens is a partial bijective lens that is also
  very well-behaved (i.e. total). ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pbij_vwb_is_bij_lens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pbij_lens <span class="free">X</span><span class="main">;</span> vwb_lens <span class="free">X</span> <span class="main">⟧</span> <span class="main">⟹</span> bij_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> pbij_lens.put_det vwb_lens.put_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_lens_iff_pbij_vwb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_lens <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span>pbij_lens <span class="free">X</span> <span class="main">∧</span> vwb_lens <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pbij_vwb_is_bij_lens <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lens Independence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ 
  \begin{figure}
  \begin{center}
    \includegraphics[width=6cm]{figures/Independence}
  \end{center}
  \vspace{-5ex}
  \caption{Lens Independence}
  \label{fig:Indep}
  \end{figure}

  Lens independence shows when two lenses $X$ and $Y$ characterise disjoint regions of the
  source type, as illustrated in Figure~\ref{fig:Indep}. We specify this by requiring that the $\lput$ 
  functions of the two lenses commute, and that the $\lget$ function of each lens is unaffected by 
  application of $\lput$ from the corresponding lens. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> lens_indep <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lens_put_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">u</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lens_put_irr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lens_put_irr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> lens_indep <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⨝</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indepI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">u</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">v</span><span class="main">;</span>
     <span class="main">⋀</span> <span class="bound">v</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span><span class="main">;</span>
     <span class="main">⋀</span> <span class="bound">u</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens independence is symmetric.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_sym<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⨝</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span> <span class="main">⟹</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">u</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_get <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lens_indep_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Characterisation of independence for two very well-behaved lenses ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_vwb_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">u</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">u</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_comm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">u</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">v</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">v</span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">from</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">σ</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">σ</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">σ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> vwb_lens.put_eq vwb_lens_wb wb_lens_def weak_lens.put_get<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">σ</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vwb_lens.put_eq vwb_lens_wb wb_lens_def weak_lens.put_get<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Lens Compatibility ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lens compatibility is a weaker notion than independence. It allows that two lenses can overlap
  so long as they manipulate the source in the same way in that region. It is most easily defined
  in terms of a function for copying a region from one source to another using a lens. ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_compat</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lens_compat</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">◃</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">◃</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">◃</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">◃</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_compat_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_compat_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_compat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def lens_compat_def lens_indep_comm<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lens_Algebra">
<div class="head">
<h1>Theory Lens_Algebra</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lens Algebraic Operators›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lens_Algebra
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lens_Laws.html">Lens_Laws</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lens Composition, Plus, Unit, and Identity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  \begin{figure}
  \begin{center}
    \includegraphics[width=7cm]{figures/Composition}
  \end{center}
  \vspace{-5ex}
  \caption{Lens Composition}
  \label{fig:Comp}
  \end{figure}
  We introduce the algebraic lens operators; for more information please see our paper~\cite{Foster16a}.
  Lens composition, illustrated in Figure~\ref{fig:Comp}, constructs a lens by composing the source 
  of one lens with the view of another.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lens_comp</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">∘</span> lens_get <span class="free"><span class="bound"><span class="entity">X</span></span></span>
                              <span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">.</span> lens_put <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">σ</span> <span class="main">(</span>lens_put <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">(</span>lens_get <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">σ</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  \begin{figure}
  \begin{center}
    \includegraphics[width=7cm]{figures/Sum}
  \end{center}
  \vspace{-5ex}
  \caption{Lens Sum}
  \label{fig:Sum}
  \end{figure}
  Lens plus, as illustrated in Figure~\ref{fig:Sum} parallel composes two independent lenses, 
  resulting in a lens whose view is the product of the two underlying lens views.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">+<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">(</span>lens_get <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">σ</span><span class="main">,</span> lens_get <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> lens_put <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>lens_put <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The product functor lens similarly parallel composes two lenses, but in this case the lenses
  have different sources and so the resulting source is also a product.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span>"</span> 85<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lens_prod</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> map_prod <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span>
                              <span class="main">,</span> lens_put <span class="main">=</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">u</span> <span class="bound">x</span><span class="main">,</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">v</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The $\lfst$ and $\lsnd$ lenses project the first and second elements, respectively, of a
  product source type.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fst_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fst<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> fst<span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">snd_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">snd<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> snd<span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> get_fst_lens <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_snd_lens <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The swap lens is a bijective lens which swaps over the elements of the product source type.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">swap_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">swap<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">swap<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">≡</span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The zero lens is an ineffectual lens whose view is a unit type. This means the zero lens
  cannot distinguish or change the source type.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">zero_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⟹</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">0<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The identity lens is a bijective lens where the source and view type are the same.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">id_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">1<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> id<span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> id<span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The quotient operator $X \lquot Y$ shortens lens $X$ by cutting off $Y$ from the end. It is
  thus the dual of the composition operator.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_quotient</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">'/<span class="hidden">⇩</span><sub>L</sub></span>"</span> 90<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">/<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span><span class="main">)</span>
                       <span class="main">,</span> lens_put <span class="main">=</span> <span class="main">λ</span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens inverse take a bijective lens and swaps the source and view types.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">inv<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lens_inv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇙</span></span><span class="main">,</span> lens_put <span class="main">=</span> <span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure Poperties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that the core lenses combinators defined above are closed under the key lens classes.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> id_wb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"wb_lens <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> source_id_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_lens_def lens_source_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unit_wb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"wb_lens <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> source_zero_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def lens_source_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_weak_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> weak_lens <span class="free">x</span><span class="main">;</span> weak_lens <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> weak_lens <span class="main">(</span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_wb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wb_lens <span class="free">x</span><span class="main">;</span> wb_lens <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> wb_lens <span class="main">(</span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def wb_lens_def weak_lens.put_closure<span class="main">)</span>
   
<span class="keyword1"><span class="command">lemma</span></span> comp_mwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">x</span><span class="main">;</span> mwb_lens <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> mwb_lens <span class="main">(</span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def mwb_lens_def weak_lens.put_closure<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> source_lens_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">x</span><span class="main">;</span> mwb_lens <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s</span> <span class="main">∈</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def lens_source_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> mwb_lens.put_put mwb_lens_def weak_lens.put_get<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> id_vwb_lens <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unit_vwb_lens <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_vwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">x</span><span class="main">;</span> vwb_lens <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> vwb_lens <span class="main">(</span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def weak_lens.put_closure<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unit_ief_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"ief_lens <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens plus requires that the lenses be independent to show closure.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> plus_mwb_lens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="main">(</span><span class="free">x</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def prod.case_eq_if lens_indep_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_comm<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_wb_lens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wb_lens <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"wb_lens <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wb_lens <span class="main">(</span><span class="free">x</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym prod.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_vwb_lens <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="main">(</span><span class="free">x</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_comm prod.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> source_plus_lens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">∩</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">y</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_source_def lens_plus_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lens_indep_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mwb_lens.weak_get_put mwb_lens_weak weak_lens.put_closure<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_mwb_lens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> mwb_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> mwb_lens <span class="main">(</span><span class="free">X</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_wb_lens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wb_lens <span class="free">X</span><span class="main">;</span> wb_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> wb_lens <span class="main">(</span><span class="free">X</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_vwb_lens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">X</span><span class="main">;</span> vwb_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> vwb_lens <span class="main">(</span><span class="free">X</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_bij_lens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij_lens <span class="free">X</span><span class="main">;</span> bij_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> bij_lens <span class="main">(</span><span class="free">X</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_vwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_lens_def prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> snd_vwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd_lens_def prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> id_bij_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_lens <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_id_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_inv_def id_lens_def lens_create_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_inv_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_lens <span class="free">X</span> <span class="main">⟹</span> <span class="keyword1">inv<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">inv<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> bij_lens.strong_get_put bij_lens_def select_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> weak_lens.put_get<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_inv_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_lens <span class="free">X</span> <span class="main">⟹</span> bij_lens <span class="main">(</span><span class="keyword1">inv<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_inv_def lens_create_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_bij_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_lens <span class="keyword1">swap<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def prod.case_eq_if fst_lens_def snd_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition Laws›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens composition is monoidal, with unit <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, as the following theorems demonstrate. 
  It also has <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as a right annihilator. ›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lens_comp_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">Y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_comp_left_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_lens_def lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_comp_right_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_lens_def lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_comp_anhil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def lens_comp_def comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_comp_anhil_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def lens_comp_def comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Independence Laws›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The zero lens <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is independent of any lens. This is because nothing can be observed
  or changed using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> zero_lens_indep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⨝</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def lens_indep_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_lens_indep' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⨝</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def lens_indep_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens independence is irreflexive, but only for effectual lenses as otherwise nothing can
  be observed.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_indep_quasi_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wb_lens <span class="free">x</span><span class="main">;</span> eff_lens <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">x</span> <span class="main">⨝</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_def ief_lens_def ief_lens_axioms_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> wb_lens.get_put<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens independence is a congruence with respect to composition, as the following properties demonstrate.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_indep_left_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">z</span><span class="main">;</span> <span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">z</span><span class="main">)</span> <span class="main">⨝</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_indepI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_right_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⨝</span> <span class="free">z</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">⨝</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lens_indepI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> lens_indep_comm lens_indep_sym <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_left_ext <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⨝</span> <span class="free">z</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">⨝</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lens_indepI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_right_ext <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⨝</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_left_ext lens_indep_sym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_comp_indep_cong_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">Z</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_indepI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> u v σ<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Z</span><span class="main"><span class="hidden">⇙</span></span> <span class="improper">σ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> lens_indep_comm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> mwb_lens_weak weak_lens.view_determination<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v σ<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Z</span><span class="main"><span class="hidden">⇙</span></span> <span class="improper">σ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> lens_indep_get<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> lens_indep_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> u σ<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Z</span><span class="main"><span class="hidden">⇙</span></span> <span class="improper">σ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> lens_indep_get<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_comp_indep_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mwb_lens <span class="free">Z</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">)</span> <span class="main">⨝</span> <span class="main">(</span><span class="free">Y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lens_comp_indep_cong_left lens_indep_left_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first and second lenses are independent since the view different parts of a product source.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> fst_snd_lens_indep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⨝</span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_def fst_lens_def snd_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> snd_fst_lens_indep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⨝</span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_def fst_lens_def snd_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_prod_lens_indep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span><span class="main">)</span> <span class="main">⨝</span> <span class="main">(</span><span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fst_snd_lens_indep lens_indep_left_comp vwb_lens_mwb <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens independence is preserved by summation.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> plus_pres_lens_indep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Z</span><span class="main">;</span> <span class="free">Y</span> <span class="main">⨝</span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="main">⨝</span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_indepI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def prod.case_eq_if<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_pres_lens_indep' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lens_indep_sym plus_pres_lens_indep<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens independence is preserved by product.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_indep_prod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⨝</span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⨝</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⨝</span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_indepI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def prod.case_eq_if lens_indep_comm map_prod_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Compatibility Laws ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_lens_compat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_lens_def lens_override_def lens_compat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> id_lens_compat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_lens_def lens_override_def lens_compat_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Algebraic Laws›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lens plus distributes to the right through composition.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> plus_lens_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">Z</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">Y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def lens_plus_def comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first lens projects the first part of a summation.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> fst_lens_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wb_lens <span class="free">y</span> <span class="main">⟹</span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_lens_def lens_plus_def lens_comp_def comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The second law requires independence as we have to apply x first, before y›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snd_lens_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wb_lens <span class="free">x</span><span class="main">;</span> <span class="free">x</span> <span class="main">⨝</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd_lens_def lens_plus_def lens_comp_def comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lens_indep_comm<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The swap lens switches over a summation.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lens_plus_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="keyword1">swap<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def fst_lens_def snd_lens_def id_lens_def lens_comp_def lens_indep_comm<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first, second, and swap lenses are all closely related.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> fst_snd_id_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def fst_lens_def snd_lens_def id_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_lens_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">swap<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">swap<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_snd_id_lens lens_indep_sym lens_plus_swap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_lens_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">swap<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_lens_plus fst_vwb_lens<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_lens_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">swap<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym snd_lens_plus snd_vwb_lens<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The product lens can be rewritten as a sum lens.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> prod_as_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def fst_lens_def snd_lens_def lens_comp_def lens_plus_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_lens_id_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def id_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_lens_comp_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⨝</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def lens_plus_def lens_prod_def prod.case_eq_if fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following laws about quotient are similar to their arithmetic analogues. Lens quotient 
  reverse the effect of a composition.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_comp_quotient<span class="main">:</span>
  <span class="quoted"><span class="quoted">"weak_lens <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_quotient_def lens_comp_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_quotient_id<span class="main">:</span> <span class="quoted"><span class="quoted">"weak_lens <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_quotient_def id_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_quotient_id_denom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_quotient_def id_lens_def lens_create_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_quotient_unit<span class="main">:</span> <span class="quoted"><span class="quoted">"weak_lens <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_quotient_def zero_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_obs_eq_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_obs_eq_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_obs_eq_as_override<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> vwb_lens.put_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lens_Order">
<div class="head">
<h1>Theory Lens_Order</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Order and Equivalence on Lenses›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lens_Order
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lens_Algebra.html">Lens_Algebra</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-lens Relation›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A lens $X$ is a sub-lens of $Y$ if there is a well-behaved lens $Z$ such that $X = Z \lcomp Y$,
  or in other words if $X$ can be expressed purely in terms of $Y$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sublens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sublens</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Z</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> lens<span class="main">.</span> vwb_lens <span class="bound">Z</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="bound">Z</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Various lens classes are downward closed under the sublens relation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_pres_mwb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> mwb_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_pres_wb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> wb_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_pres_vwb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> vwb_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sublens is a preorder as the following two theorems show.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> sublens_refl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> id_vwb_lens sublens_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def lens_comp_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Z<span class="hidden">⇩</span><sub>1</sub> Z<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Z<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="improper">Z<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> comp_vwb_lens <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sublens has a least element -- <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"0<span class="hidden">⇩</span><sub>L</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- and a greatest element -- <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"1<span class="hidden">⇩</span><sub>L</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
  Intuitively, this shows that sublens orders how large a portion of the source type a particular
  lens views, with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"0<span class="hidden">⇩</span><sub>L</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> observing the least, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"1<span class="hidden">⇩</span><sub>L</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> observing the most.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> sublens_least<span class="main">:</span> <span class="quoted"><span class="quoted">"wb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sublens_def unit_vwb_lens <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_greatest<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If $Y$ is a sublens of $X$ then any put using $X$ will necessarily erase any put using $Y$.
  Similarly, any two source types are observationally equivalent by $Y$ when performed
  following a put using $X$.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> sublens_put_put<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_obs_get<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="main">⟧</span> <span class="main">⟹</span>  <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">ρ</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def lens_comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sublens preserves independence; in other words if $Y$ is independent of $Z$, then also
  any $X$ smaller than $Y$ is independent of $Z$.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> sublens_pres_indep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="main">⨝</span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>lens_indepI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def lens_comp_def lens_indep_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_pres_indep'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Z</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Z</span> <span class="main">⨝</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lens_indep_sym sublens_pres_indep<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">X</span><span class="main">;</span> vwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lens_compat_def lens_override_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sublens_obs_get sublens_put_put vwb_lens_mwb vwb_lens_wb wb_lens.get_put<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Well-behavedness of lens quotient has sublens as a proviso. This is because we can only
  remove $X$ from $Y$ if $X$ is smaller than $Y$. ›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lens_quotient_mwb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> mwb_lens <span class="main">(</span><span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_quotient_def lens_create_def sublens_def lens_comp_def comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lens Equivalence›</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using our preorder, we can also derive an equivalence on lenses as follows. It should be
  noted that this equality, like sublens, is heterogeneously typed -- it can compare lenses whose
  view types are different, so long as the source types are the same. We show that it is reflexive, 
  symmetric, and transitive. ›</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span>"</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lens_equiv</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equivI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_refl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def sublens_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sublens_trans <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_pres_indep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="main">⨝</span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lens_equiv_def sublens_pres_indep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_pres_indep'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Z</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Z</span> <span class="main">⨝</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lens_equiv_def sublens_pres_indep' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_comp_cong_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lens_equiv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> lens_comp_assoc sublens_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Further Algebraic Laws›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This law explains the behaviour of lens quotient.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_quotient_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> weak_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_quotient_def lens_comp_def comp_def sublens_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Plus distributes through quotient.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_quotient_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">Z</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">Y</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_quotient_def lens_plus_def sublens_def lens_comp_def comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There follows a number of laws relating sublens and summation. Firstly, sublens is preserved
  by summation. ›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> plus_pred_sublens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">Z</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span><span class="main">;</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Z<span class="hidden">⇩</span><sub>1</sub> Z<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Z<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="improper">Z<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> plus_wb_lens<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_indep_cong_left plus_vwb_lens<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_lens_distr<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intuitively, lens plus is associative. However we cannot prove this using HOL equality due
  to monomorphic typing of this operator. But since sublens and lens equivalence are both heterogeneous
  we can now prove this in the following three lemmas.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lens_plus_sub_assoc_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> plus_vwb_lens<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_vwb_lens fst_vwb_lens<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> plus_vwb_lens<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_vwb_lens fst_vwb_lens snd_vwb_lens<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd_vwb_lens<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_left_ext<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_indep_sym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> plus_pres_lens_indep<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fst_snd_lens_indep fst_vwb_lens lens_indep_left_comp lens_indep_sym vwb_lens_mwb <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">using</span></span> fst_snd_lens_indep lens_indep_left_ext lens_indep_sym <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def lens_comp_def fst_lens_def snd_lens_def prod.case_eq_if split_beta'<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_sub_assoc_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> plus_vwb_lens<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> plus_vwb_lens<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_vwb_lens<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_vwb_lens fst_vwb_lens snd_vwb_lens<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_indep_sym<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_indep_left_ext<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> fst_snd_lens_indep lens_indep_sym <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> comp_vwb_lens <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd_vwb_lens<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> plus_pres_lens_indep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_left_ext lens_indep_sym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd_vwb_lens<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def lens_comp_def fst_lens_def snd_lens_def prod.case_eq_if split_beta'<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equivI lens_plus_sub_assoc_1 lens_plus_sub_assoc_2<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can similarly show that it is commutative.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_plus_sub_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_vwb_lens lens_indep_sym plus_vwb_lens snd_vwb_lens<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_sym lens_plus_swap<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equivI lens_indep_sym lens_plus_sub_comm<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any composite lens is larger than an element of the lens, as demonstrated by the following
  four laws.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_plus_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"wb_lens <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_lens_plus fst_vwb_lens sublens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_right_sublens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="main">⨝</span> <span class="free">Z</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Z'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Z'</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> comp_vwb_lens snd_vwb_lens <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lens_comp_assoc snd_lens_plus vwb_lens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_plus_mono_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Y</span> <span class="main">⨝</span> <span class="free">Z</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Z'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Z'</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> prod_lens_comp_plus<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> id_vwb_lens prod_vwb_lens <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_plus_mono_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Z</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_lens_comp_plus prod_vwb_lens sublens_def sublens_refl<span class="main">)</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If we compose a lens $X$ with lens $Y$ then naturally the resulting lens must be smaller
  than $Y$, as $X$ views a part of $Y$. ›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lens_comp_lb <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms sublens_def sublens_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can now also show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"0<span class="hidden">⇩</span><sub>L</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the unit of lens plus›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_unit_plus_sublens_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lens_comp_lb snd_lens_plus snd_vwb_lens zero_lens_indep unit_wb_lens<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_unit_prod_sublens_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_def zero_lens_def lens_comp_def id_lens_def prod.case_eq_if comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_left_unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equivI lens_unit_plus_sublens_1 lens_unit_prod_sublens_2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_right_unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lens_equiv_trans lens_indep_sym lens_plus_comm lens_plus_left_unit zero_lens_indep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also show that both sublens and equivalence are congruences with respect to lens plus
  and lens product.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_plus_subcong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⨝</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> <span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_lens_comp_plus prod_vwb_lens sublens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_eq_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Z</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lens_equiv_def lens_plus_mono_left sublens_pres_indep<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_eq_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lens_equiv_def lens_indep_sym lens_plus_mono_right sublens_pres_indep<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⨝</span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lens_plus_eq_left<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> lens_equiv_def lens_plus_eq_right sublens_pres_indep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lens_equiv_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_lens_sublens_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Z<span class="hidden">⇩</span><sub>1</sub> Z<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Z<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="improper">Z<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> prod_vwb_lens <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def lens_comp_def prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def lens_comp_def prod.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_lens_equiv_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def prod_lens_sublens_cong<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also have the following "exchange" law that allows us to switch over a lens product and plus.›</span></span> 
    
<span class="keyword1"><span class="command">lemma</span></span> lens_plus_prod_exchange<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lens_equivI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="main">(</span><span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> plus_vwb_lens comp_vwb_lens fst_vwb_lens snd_vwb_lens lens_indep_right_comp<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lens_indepI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def lens_plus_def fst_lens_def snd_lens_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def lens_plus_def lens_comp_def fst_lens_def snd_lens_def prod.case_eq_if comp_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="main">(</span><span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">fst<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">snd<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> plus_vwb_lens comp_vwb_lens fst_vwb_lens snd_vwb_lens lens_indep_right_comp<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lens_indepI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def lens_plus_def fst_lens_def snd_lens_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def lens_plus_def lens_comp_def fst_lens_def snd_lens_def prod.case_eq_if comp_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_prod_def prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_get_put_quasi_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s</span><span class="main">)</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">la</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">l</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">la</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">la</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="bound">b</span><span class="main">::</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">l</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">la</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">::</span><span class="tfree">'c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">la</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">l</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">la</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">l</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="bound">b</span><span class="main">::</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">::</span><span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">la</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">l</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="bound">c</span> <span class="main">∨</span> <span class="main">¬</span> weak_lens <span class="bound">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lens_quotient_comp vwb_lens_wb wb_lens_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lens_put_of_quotient<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s</span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">l</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="bound">b</span><span class="main">::</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="bound">l</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">∨</span> <span class="main">¬</span> vwb_lens <span class="bound">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_get_put_quasi_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">b</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_put_put<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f4 f3 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mwb_lens.put_put mwb_lens_def vwb_lens_mwb weak_lens.put_get<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bijective Lens Equivalences›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A bijective lens, like a bijective function, is its own inverse. Thus, if we compose its inverse
  with itself we get <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> bij_lens_inv_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_lens <span class="free">X</span> <span class="main">⟹</span> <span class="keyword1">inv<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_inv_def lens_comp_def lens_create_def comp_def id_lens_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_lens_inv_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_lens <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">inv<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">X</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_inv_def lens_comp_def comp_def id_lens_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following important results shows that bijective lenses are precisely those that are 
  equivalent to identity. In other words, a bijective lens views all of the source type.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bij_lens_equiv_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_lens <span class="free">X</span> <span class="main">⟷</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_equivI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"lens_inv <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_lens_inv_left lens_inv_bij<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def sublens_def id_lens_def lens_comp_def comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> vwb_lens_wb wb_lens_weak weak_lens.put_get<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For this reason, by transitivity, any two bijective lenses with the same source type must be equivalent.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> bij_lens_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij_lens <span class="free">X</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> bij_lens <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_lens_equiv_id lens_equiv_def sublens_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_lens_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟹</span> bij_lens <span class="free">X</span> <span class="main">=</span> bij_lens <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_lens_equiv lens_equiv_sym<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also show that the identity lens <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is unique. That is to say it is the only
  lens which when compose with $Y$ will yield $Y$.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lens_id_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"weak_lens <span class="free">Y</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def comp_def id_lens_def fun_eq_iff<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> weak_lens.create_get<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> select_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> weak_lens.put_get<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consequently, if composition of two lenses $X$ and $Y$ yields <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"1<span class="hidden">⇩</span><sub>L</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then both
  of the composed lenses must be bijective.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> bij_lens_via_comp_id_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wb_lens <span class="free">X</span><span class="main">;</span> wb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> bij_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def comp_def id_lens_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> vwb_lens_wb wb_lens_weak weak_lens.put_get <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> select_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wb_lens_weak weak_lens.put_get<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bij_lens_via_comp_id_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wb_lens <span class="free">X</span><span class="main">;</span> wb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> bij_lens <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_def comp_def id_lens_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> vwb_lens_wb wb_lens_weak weak_lens.put_get <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> select_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wb_lens_weak weak_lens.put_get<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Importantly, an equivalence between two lenses can be demonstrated by showing that one lens
  can be converted to the other by application of a suitable bijective lens $Z$. This $Z$ lens
  converts the view type of one to the view type of the other.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_via_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_lens <span class="free">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">Z</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def sublens_def<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> bij_lens_vwb <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"lens_inv <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_comp_assoc bij_lens_inv_left<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> bij_lens_vwb lens_inv_bij <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Indeed, we actually have a stronger result than this -- the equivalent lenses are precisely
  those than can be converted to one another through a suitable bijective lens. Bijective lenses
  can thus be seen as a special class of "adapter" lens.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_iff_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"weak_lens <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Z</span><span class="main">.</span> bij_lens <span class="bound">Z</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">Z</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def sublens_def lens_id_unique<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Z<span class="hidden">⇩</span><sub>1</sub> Z<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Z<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">Z<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="improper">Z<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> bij_lens_via_comp_id_right vwb_lens_wb<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms lens_comp_assoc lens_id_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lens_equiv_via_bij <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pbij_plus_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">⨝</span> <span class="free">b</span><span class="main">;</span> mwb_lens <span class="free">a</span><span class="main">;</span> mwb_lens <span class="free">b</span><span class="main">;</span> pbij_lens <span class="main">(</span><span class="free">b</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> pbij_lens <span class="main">(</span><span class="free">a</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">lens_defs</span></span> lens_indep_sym prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lens_indep.lens_put_comm pbij_lens.put_det <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lens Override Laws›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following laws are analogus to the equivalent laws for functions.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lens_override_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def id_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_unit <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def zero_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_overshadow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">Y</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def sublens_put_put<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_irr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_overshadow_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_overshadow_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span>  <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_comm lens_override_def lens_plus_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_mwb_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> <span class="free">S</span> <span class="main">∈</span> <span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_put_right_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">A</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">A</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">A</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def lens_get_put_quasi_commute lens_put_of_quotient<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_override_put_right_out<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">A</span><span class="main">;</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def  lens_indep.lens_put_irr2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_overrideI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mwb_lens_def vwb_lens_mwb weak_lens.put_get<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lens_override_def lens_override_idem mwb_lens_def vwb_lens_mwb weak_lens.put_get<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mwb_lens_weak vwb_lens_mwb vwb_lens_wb wb_lens.get_put weak_lens.put_get<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_override_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lens_indep_comm lens_indep_overrideI lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Alternative characterisation of very-well behaved lenses: override is idempotent. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> override_idem_implies_vwb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> <span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> vwb_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Alternative Sublens Characterisation ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The following definition is equivalent to the above when the two lenses are very well behaved. ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sublens'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>''</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sublens'</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We next prove some characteristic properties of our alternative definition of sublens. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sublens'_prop1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublens'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> lens_override_def mwb_lens_def vwb_lens_mwb weak_lens.put_get<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens'_prop2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sublens'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lens_override_def vwb_lens_wb wb_lens_axioms_def wb_lens_def weak_lens.put_get<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens'_prop3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">ρ</span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">σ</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mwb_lens_def sublens'_prop1 vwb_lens.put_eq vwb_lens_mwb weak_lens.put_get<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Finally we show our two definitions of sublens are equivalent, assuming very well behaved lenses. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sublens'_implies_sublens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="main">(</span><span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span>
       <span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms lens_quotient_def lens_comp_def lens_create_def sublens'_prop1 sublens'_prop2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lens_create_def sublens'_prop2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">create</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lens_create_def sublens'_prop3<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_quotient_def lens_comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sublens_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_implies_sublens'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms lens_override_def lens_override_put_right_in sublens'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_iff_sublens'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟷</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sublens'_implies_sublens sublens_implies_sublens' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Alternative Equivalence Characterisation ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_equiv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub>''</span>"</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lens_equiv'</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_iff_lens_equiv'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟷</span> <span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_def sublens_iff_sublens' assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mwb_lens.put_put vwb_lens_mwb vwb_lens_wb wb_lens.get_put<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lens_Symmetric">
<div class="head">
<h1>Theory Lens_Symmetric</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Symmetric Lenses ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lens_Symmetric
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lens_Order.html">Lens_Order</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A characterisation of Hofmann's ``Symmetric Lenses''~\cite{Hofmann2011}, where
  a lens is accompanied by its complement. ›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> slens <span class="main">=</span> 
  view   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'s</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱</span>ı"</span><span class="main">)</span> <span class="comment1">― ‹ The region characterised ›</span>
  coview <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'s</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒞</span>ı"</span><span class="main">)</span> <span class="comment1">― ‹ The complement of the region ›</span>

<span class="keyword1"><span class="command">type_notation</span></span>
  slens <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;</span>_<span class="keyword1">,</span> _<span class="keyword1">&gt;</span> <span class="keyword1">⟺</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 0<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> slens.defs <span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">slens_compl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">&lt;</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">&gt;</span> <span class="main">⟺</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">&lt;</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">&gt;</span> <span class="main">⟺</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">-<span class="hidden">⇩</span><sub>L</sub></span> _"</span> <span class="main">[</span>81<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">slens_compl</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">⦇</span> view <span class="main">=</span> coview <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> coview <span class="main">=</span> view <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> view_slens_compl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">-<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">a</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span>  <span class="keyword1">𝒞</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">a</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slens_compl_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coview_slens_compl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒞</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">-<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">a</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span>  <span class="keyword1">𝒱</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">a</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slens_compl_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Partial Symmetric Lenses ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> psym_lens <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">&gt;</span> <span class="main">⟺</span> <span class="tfree">'s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    mwb_region <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mwb_lens <span class="keyword1">𝒱</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    mwb_coregion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mwb_lens <span class="keyword1">𝒞</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    indep_region_coregion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱</span> <span class="main">⨝</span> <span class="keyword1">𝒞</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pbij_region_coregion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pbij_lens <span class="main">(</span><span class="keyword1">𝒱</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">𝒞</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> psym_lens.mwb_region <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> psym_lens.mwb_coregion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> psym_lens.indep_region_coregion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> psym_lens_compl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"psym_lens <span class="free">a</span> <span class="main">⟹</span> psym_lens <span class="main">(</span><span class="keyword1">-<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slens_compl_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> psym_lens.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lens_indep_sym psym_lens.indep_region_coregion <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> lens_indep_sym pbij_plus_commute psym_lens_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Symmetric Lenses ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> sym_lens <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">&gt;</span> <span class="main">⟺</span> <span class="tfree">'s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    vwb_region<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="keyword1">𝒱</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    vwb_coregion<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="keyword1">𝒞</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    indep_region_coregion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱</span> <span class="main">⨝</span> <span class="keyword1">𝒞</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bij_region_coregion<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_lens <span class="main">(</span><span class="keyword1">𝒱</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">𝒞</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> psym_lens
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> psym_lens.intro<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="keyword1">𝒱</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vwb_region<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mwb_lens <span class="keyword1">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vwb_coregion<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱</span> <span class="main">⨝</span> <span class="keyword1">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> indep_region_coregion <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pbij_lens <span class="main">(</span><span class="keyword1">𝒱</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">𝒞</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_region_coregion<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> put_region_coregion_cover<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒱</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒞</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒞</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒱</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒱</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒞</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒞</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒱</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒱</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">𝒞</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">𝒱</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">𝒞</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_region_coregion<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> sym_lens.vwb_region <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> sym_lens.vwb_coregion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> sym_lens.indep_region_coregion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> sym_lens_psym <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sym_lens <span class="free">x</span> <span class="main">⟹</span> psym_lens <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psym_lens_def sym_lens.bij_region_coregion<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sym_lens_compl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sym_lens <span class="free">a</span> <span class="main">⟹</span> sym_lens <span class="main">(</span><span class="keyword1">-<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slens_compl_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym_lens.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lens_indep_sym sym_lens.indep_region_coregion <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> bij_lens_equiv lens_plus_comm sym_lens_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lens_Instances">
<div class="head">
<h1>Theory Lens_Instances</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lens Instances›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lens_Instances
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lens_Order.html">Lens_Order</a> <a href="Lens_Symmetric.html">Lens_Symmetric</a> <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
  <span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"alphabet"</span> <span class="main">::</span> <span class="quoted">"thy_defn"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we define a number of concrete instantiations of the lens locales, including
  functions lenses, list lenses, and record lenses.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function Lens›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A function lens views the valuation associated with a particular domain element <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      We require that range type of a lens function has cardinality of at least 2; this ensures
      that properties of independence are provable.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>two <span class="main">⟹</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_lens</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_vwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"vwb_lens <span class="main">(</span>fun_lens <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two function lenses are independent if and only if the domain elements are different.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> fun_lens_indep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fun_lens <span class="free">x</span> <span class="main">⨝</span> fun_lens <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>two"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> two_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_lens_def lens_indep_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function Range Lens›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function range lens allows us to focus on a particular region of a function's range.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_ran_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⟹</span> <span class="tfree">'α</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⟹</span> <span class="tfree">'α</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_ran_lens</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">∘</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s</span>
                                 <span class="main">,</span> lens_put <span class="main">=</span> <span class="main">λ</span> <span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">v</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_ran_mwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> mwb_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> mwb_lens <span class="main">(</span>fun_ran_lens <span class="free">X</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_ran_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_ran_wb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wb_lens <span class="free">X</span><span class="main">;</span> wb_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> wb_lens <span class="main">(</span>fun_ran_lens <span class="free">X</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_ran_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_ran_vwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">X</span><span class="main">;</span> vwb_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> vwb_lens <span class="main">(</span>fun_ran_lens <span class="free">X</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_ran_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map Lens›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The map lens allows us to focus on a particular region of a partial function's range. It
  is only a mainly well-behaved lens because it does not satisfy the PutGet law when the view
  is not in the domain.›</span></span> 
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⟹</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">map_lens</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_mwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"mwb_lens <span class="main">(</span>map_lens <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> source_map_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>map_lens <span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> dom<span class="main">(</span><span class="bound">f</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_lens_def lens_source_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List Lens›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The list lens allows us to view a particular element of a list. In order to show it is mainly
  well-behaved we need to define to additional list functions. The following function adds 
  a number undefined elements to the end of a list.›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_pad_out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">list_pad_out</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> replicate <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> undefined"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function is like <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"list_update"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but it adds additional elements to the
  list if the list isn't long enough first.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_augment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">list_augment</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span>list_pad_out <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function is like <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">nth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but it expressly returns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">undefined</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when
  the list isn't long enough.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nth'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nth'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can prove some additional laws about list update and append.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_update_append_lemma1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_update_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_update_append_lemma2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">+</span> length <span class="free">xs</span> <span class="main">:=</span> <span class="free">v</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_update_append<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also prove some laws about our new operators.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> nth'_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nth' <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth'_Suc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nth' <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> nth' <span class="free">xs</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_augment_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_augment <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">0</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_augment_Suc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_augment <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> list_augment <span class="free">xs</span> <span class="free">n</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_augment_twice<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_augment <span class="main">(</span>list_augment <span class="free">xs</span> <span class="free">i</span> <span class="free">u</span><span class="main">)</span> <span class="free">j</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span>list_pad_out <span class="free">xs</span> <span class="main">(</span>max <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">u</span><span class="main">,</span> <span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def list_update_append_lemma1 replicate_add<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> max_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_le_mono add.commute diff_diff_add diff_le_mono le_add_diff_inverse2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_augment_last <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_augment <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">z</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_augment_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> list_augment <span class="free">xs</span> <span class="free">i</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can now prove that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">list_augment</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is commutative for different (arbitrary) indices.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> list_augment_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> list_augment <span class="main">(</span>list_augment <span class="free">σ</span> <span class="free">j</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">u</span> <span class="main">=</span> list_augment <span class="main">(</span>list_augment <span class="free">σ</span> <span class="free">i</span> <span class="free">u</span><span class="main">)</span> <span class="free">j</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_twice list_update_swap max.commute<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also prove that we can always retrieve an element we have added to the list, since
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">list_augment</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> extends the list when necessary. This isn't true of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">list_update</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> nth_list_augment<span class="main">:</span> <span class="quoted"><span class="quoted">"list_augment <span class="free">xs</span> <span class="free">k</span> <span class="free">v</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> nth'_list_augment<span class="main">:</span> <span class="quoted"><span class="quoted">"nth' <span class="main">(</span>list_augment <span class="free">xs</span> <span class="free">k</span> <span class="free">v</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth'_def nth_list_augment list_augment_def list_pad_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The length is expanded if not already long enough, or otherwise left as it is. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_list_augment_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span>list_augment <span class="free">xs</span> <span class="free">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_list_augment_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span>list_augment <span class="free">xs</span> <span class="free">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also have it that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">list_augment</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> cancels itself.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> list_augment_same_twice<span class="main">:</span> <span class="quoted"><span class="quoted">"list_augment <span class="main">(</span>list_augment <span class="free">xs</span> <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span> <span class="free">v</span> <span class="main">=</span> list_augment <span class="free">xs</span> <span class="free">k</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth'_list_augment_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> nth' <span class="main">(</span>list_augment <span class="free">σ</span> <span class="free">i</span> <span class="free">v</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> nth' <span class="free">σ</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_augment_def list_pad_out_def nth_append nth'_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we can create the list lenses, of which there are three varieties. One that allows
  us to view an index, one that allows us to view the head, and one that allows us to view the tail.
  They are all mainly well-behaved lenses.›</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>two <span class="main">⟹</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">list_lens</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> nth' <span class="bound">xs</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
                            <span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> list_augment <span class="bound">xs</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">hd_lens</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">hd<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hd_lens</span> <span class="main">≡</span> list_lens <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tl_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⟹</span> <span class="tfree">'a</span> list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">tl<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tl_lens</span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> tl <span class="bound">xs</span><span class="main">)</span>
                        <span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span> <span class="bound">xs'</span><span class="main">.</span> hd <span class="bound">xs</span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_mwb_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"mwb_lens <span class="main">(</span>list_lens <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_lens_def nth'_list_augment list_augment_same_twice<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The set of constructible sources is precisely those where the length is greater than the
  given index. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> source_list_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>list_lens <span class="free">i</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_source_def list_lens_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> length_list_augment_1 length_list_augment_2 lessI not_less<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list_augment_idem<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> tail_lens_mwb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mwb_lens <span class="keyword1">tl<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_lens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> source_tail_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">tl<span class="hidden">⇩</span><sub>L</sub></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list.exhaust_sel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_lens_def lens_source_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Independence of list lenses follows when the two indices are different.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> list_lens_indep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> list_lens <span class="free">i</span> <span class="main">⨝</span> list_lens <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_lens_def lens_indep_def list_augment_commute nth'_list_augment_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_tl_lens_indep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">hd<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">⨝</span> <span class="keyword1">tl<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lens_indepI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_lens_def tl_lens_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> hd_conv_nth hd_def length_greater_0_conv list.case<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nth'_def nth'_list_augment<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> hd_conv_nth hd_def length_greater_0_conv list.case<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nth'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def diff_Suc_Suc diff_zero length_0_conv length_list_augment_1 length_tl linorder_not_less list.exhaust list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_augment_0 not_less_zero<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> hd_tl_lens_pbij<span class="main">:</span> <span class="quoted"><span class="quoted">"pbij_lens <span class="main">(</span><span class="keyword1">hd<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">tl<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Record Field Lenses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also add support for record lenses. Every record created can yield a lens for each field.
  These cannot be created generically and thus must be defined case by case as new records are
  created. We thus create a new Isabelle outer syntax command \textbf{alphabet} which enables this. 
  We first create syntax that allows us to obtain a lens from a given field using the internal
  record syntax translations.›</span></span>
  
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">fld_put</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span> <span class="bound">u</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span> 
  <span class="quoted">"_FLDLENS"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> logic"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">FLDLENS</span> _"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> 
  <span class="quoted">"<span class="keyword1">FLDLENS</span> x"</span> <span class="main">=&gt;</span> <span class="quoted">"<span class="main">⦇</span> lens_get <span class="main">=</span> <span class="free">x</span><span class="main">,</span> lens_put <span class="main">=</span> <span class="keyword1">CONST</span> fld_put <span class="main">(</span>_update_name <span class="free">x</span><span class="main">)</span> <span class="main">⦈</span>"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We also allow the extraction of the "base lens", which characterises all the fields added
  by a record without the extension. ›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_BASELENS"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> logic"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">BASELENS</span> _"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">base_lens</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> lens_put <span class="main">=</span> <span class="main">λ</span> <span class="bound">s</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">v</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">baselens_tr</span> <span class="main">[</span>Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">".extend"</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">truncate</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">".truncate"</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">more</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">".more"</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> "base_lens"<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">truncate</span> $ <span class="entity">extend</span> $ <span class="entity">more</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">baselens_tr</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹<span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_BASELENS"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">baselens_tr</span><span class="main">)</span><span class="main">]</span>›</span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also introduce the \textbf{alphabet} command that creates a record with lenses for each field.
  For each field a lens is created together with a proof that it is very well-behaved, and for each 
  pair of lenses an independence theorem is generated. Alphabets can also be extended which yields 
  sublens proofs between the extension field lens and record extension lenses. ›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹Lens_Record.ML›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theorem attribute stores splitting theorems for alphabet types which which is useful
  for proof automation.›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> alpha_splits

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Definition Lens›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Every type defined by a <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">❙</span></span>‹typedef›</span></span> command induces a partial bijective lens constructed
  using the abstraction and representation functions. ›</span></span>

<span class="keyword1"><span class="command">context</span></span> type_definition
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">typedef_lens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⟹</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">typedef<span class="hidden">⇩</span><sub>L</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">typedef<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">=</span> <span class="main">⦇</span> lens_get <span class="main">=</span> <span class="free">Abs</span><span class="main">,</span> lens_put <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">Rep</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pbij_typedef_lens <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pbij_lens <span class="keyword1">typedef<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span> Rep_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> source_typedef_lens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">typedef<span class="hidden">⇩</span><sub>L</sub></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Rep_cases <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_source_def <span class="dynamic"><span class="dynamic">lens_defs</span></span> Rep<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_typedef_lens_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> UNIV <span class="main">⟹</span> bij_lens <span class="keyword1">typedef<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pbij_vwb_is_bij_lens <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mwb_UNIV_src_is_vwb_lens source_typedef_lens<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Mapper Lenses›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lmap_lens</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'α</span> <span class="main">⇒</span> <span class="tfree">'β</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'γ</span> <span class="main">⇒</span> <span class="tfree">'δ</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> 
   <span class="main">(</span><span class="main">(</span><span class="tfree">'β</span> <span class="main">⇒</span> <span class="tfree">'α</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'δ</span> <span class="main">⇒</span> <span class="tfree">'γ</span><span class="main">)</span> <span class="main">⇒</span> 
   <span class="main">(</span><span class="tfree">'γ</span> <span class="main">⇒</span> <span class="tfree">'α</span><span class="main">)</span> <span class="main">⇒</span> 
   <span class="main">(</span><span class="tfree">'β</span> <span class="main">⟹</span> <span class="tfree">'α</span><span class="main">)</span> <span class="main">⇒</span> 
   <span class="main">(</span><span class="tfree">'δ</span> <span class="main">⟹</span> <span class="tfree">'γ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">lmap_lens</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">⦇</span>
  lens_get <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span><span class="main">,</span>
  lens_put <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">o</span> <span class="main">(</span><span class="keyword1">put</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⦈</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The parse translation below yields a heterogeneous mapping lens for any
  record type. This achieved through the utility function above that
  constructs a functorial lens. This takes as input a heterogeneous mapping
  function that lifts a function on a record's extension type to an update
  on the entire record, and also the record's ``more'' function. The first input
  is given twice as it has different polymorphic types, being effectively
  a type functor construction which are not explicitly supported by HOL. We note 
  that the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>more_update›</span></span></span></span> function does something similar to the extension lifting, 
  but is not precisely suitable here since it only considers homogeneous functions, 
  namely of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a ⇒ 'a›</span></span></span></span> rather than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a ⇒ 'b›</span></span></span></span>.
›</span></span>
  
<span class="keyword1"><span class="command">syntax</span></span> 
  <span class="quoted">"_lmap"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> logic"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">lmap[</span>_<span class="keyword1">]</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lmap_tr</span> <span class="main">[</span>Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">".extend"</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">truncate</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">".truncate"</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">more</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">".more"</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">map_ext</span> <span class="main">=</span> Abs <span class="main">(</span><span class="inner_quoted">"f"</span><span class="main">,</span> dummyT<span class="main">,</span>
                    Abs <span class="main">(</span><span class="inner_quoted">"r"</span><span class="main">,</span> dummyT<span class="main">,</span>
                      <span class="entity">extend</span> $ <span class="main">(</span><span class="entity">truncate</span> $ Bound <span class="inner_numeral">0</span><span class="main">)</span> $ <span class="main">(</span>Bound <span class="inner_numeral">1</span> $ <span class="main">(</span><span class="entity">more</span> $ <span class="main">(</span>Bound <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> "lmap_lens"<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">map_ext</span> $ <span class="entity">map_ext</span> $ <span class="entity">more</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">lmap_tr</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹<span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_lmap"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">lmap_tr</span><span class="main">)</span><span class="main">]</span>›</span>  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lens Interpretation›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> lens_interp_laws

<span class="keyword1"><span class="command">locale</span></span> lens_interp <span class="main">=</span> interp
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">declare</span></span> meta_interp_law <span class="main">[</span><span class="operator">lens_interp_laws</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> all_interp_law <span class="main">[</span><span class="operator">lens_interp_laws</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> exists_interp_law <span class="main">[</span><span class="operator">lens_interp_laws</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Tactic ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A simple tactic for simplifying lens expressions ›</span></span>

<span class="keyword1"><span class="command">declare</span></span> split_paired_all <span class="main">[</span><span class="operator">alpha_splits</span><span class="main">]</span>

<span class="keyword1"><span class="command">method</span></span> lens_simp <span class="main">=</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">alpha_splits</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span> prod.case_eq_if<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/Lens_Record.ML">
<div class="head">
<h1>File ‹Lens_Record.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">LENS_UTILS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> add_alphabet_cmd <span class="main">:</span> <span class="main">{</span>overloaded<span class="main">:</span> bool<span class="main">}</span> <span class="main">-&gt;</span>
     <span class="main">(</span>string * string option<span class="main">)</span> list * binding <span class="main">-&gt;</span>
       string option <span class="main">-&gt;</span> <span class="main">(</span>binding * string * mixfix<span class="main">)</span> list <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Lens_Utils</span> <span class="main">:</span> <span class="entity">LENS_UTILS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(* We set up the following syntactic entities that correspond to various parts of Isabelle syntax
  and names that we depend on. These code would need to be updated if the names of the Isabelle
  and lens theories and/or theorems change. *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">FLDLENS</span> <span class="main">=</span> <span class="inner_quoted">"FLDLENS"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">BASELENS</span> <span class="main">=</span> <span class="inner_quoted">"BASELENS"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">base_lensN</span> <span class="main">=</span> <span class="inner_quoted">"base<span class="hidden">⇩</span><sub>L</sub>"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">child_lensN</span> <span class="main">=</span> <span class="inner_quoted">"more<span class="hidden">⇩</span><sub>L</sub>"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_lensN</span> <span class="main">=</span> <span class="inner_quoted">"all<span class="hidden">⇩</span><sub>L</sub>"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">base_moreN</span> <span class="main">=</span> <span class="inner_quoted">"base_more"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bij_lens_suffix</span> <span class="main">=</span> <span class="inner_quoted">"_bij_lens"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vwb_lens_suffix</span> <span class="main">=</span> <span class="inner_quoted">"_vwb_lens"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sym_lens_suffix</span> <span class="main">=</span> <span class="inner_quoted">"_sym_lens"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">indepsN</span> <span class="main">=</span> <span class="inner_quoted">"indeps"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sublensN</span> <span class="main">=</span> <span class="inner_quoted">"sublenses"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">quotientN</span> <span class="main">=</span> <span class="inner_quoted">"quotients"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">compositionN</span> <span class="main">=</span> <span class="inner_quoted">"compositions"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Trueprop</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Trueprop<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">HOLeq</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> HOL.eq<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bij_lens</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> bij_lens<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vwb_lens</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> vwb_lens<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sym_lens</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> sym_lens<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lens_indep</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> lens_indep<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lens_plus</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> lens_plus<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lens_quotient</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> lens_quotient<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lens_comp</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> lens_comp<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_lens</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> id_lens<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sublens</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> sublens<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lens_equiv</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> lens_equiv<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lens_suffix</span> <span class="main">=</span> <span class="inner_quoted">"<span class="hidden">⇩</span><sub>v</sub>"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lens_defsN</span> <span class="main">=</span> <span class="inner_quoted">"lens_defs"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lens_defs</span> <span class="main">=</span> <span class="main">(</span>Binding.empty<span class="main">,</span> <span class="main">[</span>Token.make_src <span class="main">(</span><span class="entity">lens_defsN</span><span class="main">,</span> Position.none<span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alpha_splitsN</span> <span class="main">=</span> <span class="inner_quoted">"alpha_splits"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alpha_splits</span> <span class="main">=</span> <span class="main">[</span>Token.make_src <span class="main">(</span><span class="entity">alpha_splitsN</span><span class="main">,</span> Position.none<span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">equivN</span> <span class="main">=</span> <span class="inner_quoted">"equivs"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">splits_suffix</span> <span class="main">=</span> <span class="inner_quoted">".splits"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">defs_suffix</span> <span class="main">=</span> <span class="inner_quoted">".defs"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prod_case_eq_ifN</span> <span class="main">=</span> <span class="inner_quoted">"prod.case_eq_if"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">slens_view</span> <span class="main">=</span> <span class="inner_quoted">"view"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">slens_coview</span> <span class="main">=</span> <span class="inner_quoted">"coview"</span>

<span class="comment1">(* The following code is adapted from the record package. We generate a record, but also create
   lenses for each field and prove properties about them. *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_parent</span> NONE <span class="entity">ctxt</span> <span class="main">=</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">read_parent</span> <span class="main">(</span>SOME <span class="entity">raw_T</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Proof_Context.read_typ_abbrev <span class="entity">ctxt</span> <span class="entity">raw_T</span> <span class="keyword2"><span class="keyword">of</span></span>
        Type <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">Ts</span><span class="main">,</span> <span class="entity">name</span><span class="main">)</span><span class="main">,</span> fold Variable.declare_typ <span class="entity">Ts</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">T</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Bad parent record specification: "</span> ^ Syntax.string_of_typ <span class="entity">ctxt</span> <span class="entity">T</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_fields</span> <span class="entity">raw_fields</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Ts</span> <span class="main">=</span> Syntax.read_typs <span class="entity">ctxt</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">raw_T</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">raw_T</span><span class="main">)</span> <span class="entity">raw_fields</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fields</span> <span class="main">=</span> map2 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">mx</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">T</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">mx</span><span class="main">)</span><span class="main">)</span> <span class="entity">raw_fields</span> <span class="entity">Ts</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt'</span> <span class="main">=</span> fold Variable.declare_typ <span class="entity">Ts</span> <span class="entity">ctxt</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">fields</span><span class="main">,</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_record_cmd</span> <span class="entity">overloaded</span> <span class="main">(</span><span class="entity">raw_params</span><span class="main">,</span> <span class="entity">binding</span><span class="main">)</span> <span class="entity">raw_parent</span> <span class="entity">raw_fields</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">params</span> <span class="main">=</span> map <span class="main">(</span>apsnd <span class="main">(</span><span class="entity">Typedecl.read_constraint</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">raw_params</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt1</span> <span class="main">=</span> fold <span class="main">(</span>Variable.declare_typ o TFree<span class="main">)</span> <span class="entity">params</span> <span class="entity">ctxt</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">parent</span><span class="main">,</span> <span class="entity">ctxt2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">read_parent</span> <span class="entity">raw_parent</span> <span class="entity">ctxt1</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">fields</span><span class="main">,</span> <span class="entity">ctxt3</span><span class="main">)</span> <span class="main">=</span> <span class="entity">read_fields</span> <span class="entity">raw_fields</span> <span class="entity">ctxt2</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">params'</span> <span class="main">=</span> map <span class="main">(</span>Proof_Context.check_tfree <span class="entity">ctxt3</span><span class="main">)</span> <span class="entity">params</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">thy</span> |&gt; <span class="entity">Record.add_record</span> <span class="entity">overloaded</span> <span class="main">(</span><span class="entity">params'</span><span class="main">,</span> <span class="entity">binding</span><span class="main">)</span> <span class="entity">parent</span> <span class="entity">fields</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* Construct a theorem and proof that a given field lens is very well-behaved *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lens_proof</span> <span class="entity">tname</span> <span class="entity">x</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
      Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span>Const <span class="main">(</span><span class="entity">vwb_lens</span><span class="main">,</span> dummyT<span class="main">)</span> $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">x</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">context</span><span class="main">,</span> prems <span class="main">=</span> <span class="main">_</span><span class="main">}</span>
                           <span class="main">=&gt;</span> EVERY <span class="main">[</span> <span class="entity">Locale.intro_locales_tac</span> <span class="main">{</span>strict <span class="main">=</span> true<span class="main">,</span> eager <span class="main">=</span> true<span class="main">}</span> <span class="entity">context</span> <span class="main">[</span><span class="main">]</span>
                                    <span class="main">,</span> <span class="entity">PARALLEL_ALLGOALS</span> <span class="main">(</span><span class="entity">asm_simp_tac</span> 
                                                          <span class="main">(</span>fold <span class="entity">add_simp</span> <span class="main">(</span>get_thm <span class="entity">thy</span> <span class="main">(</span><span class="entity">x</span> ^ <span class="inner_quoted">"_def"</span><span class="main">)</span> :: get_thms <span class="entity">thy</span> <span class="main">(</span><span class="entity">tname</span> ^ <span class="inner_quoted">".defs"</span><span class="main">)</span><span class="main">)</span>
                                                                         <span class="entity">context</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lens_sym_proof</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
      Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span>Const <span class="main">(</span><span class="entity">sym_lens</span><span class="main">,</span> dummyT<span class="main">)</span> $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">all_lensN</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">context</span><span class="main">,</span> prems <span class="main">=</span> <span class="main">_</span><span class="main">}</span>
                           <span class="main">=&gt;</span> EVERY <span class="main">[</span> <span class="entity">Classical.rule_tac</span> <span class="entity">context</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sym_lens.intro<span class="antiquote">}</span></span></span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="inner_numeral">1</span>
                                    <span class="main">,</span> <span class="entity">PARALLEL_ALLGOALS</span> <span class="main">(</span><span class="entity">asm_simp_tac</span> 
                                                          <span class="main">(</span>fold <span class="entity">add_simp</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> slens.defs<span class="antiquote">}</span></span></span> @ get_thms <span class="entity">thy</span> <span class="main">(</span><span class="entity">tname</span> ^ <span class="inner_quoted">".defs"</span><span class="main">)</span><span class="main">)</span>
                                                                         <span class="entity">context</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_lens_goal</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="entity">ctx</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">auto_tac</span> <span class="main">(</span>fold <span class="entity">add_simp</span> <span class="main">(</span>get_thms <span class="entity">thy</span> <span class="entity">lens_defsN</span> @ 
                           get_thms <span class="entity">thy</span> <span class="main">(</span><span class="entity">tname</span> ^ <span class="entity">splits_suffix</span><span class="main">)</span> @ 
                           <span class="main">[</span>get_thm <span class="entity">thy</span> <span class="entity">prod_case_eq_ifN</span><span class="main">]</span><span class="main">)</span> <span class="entity">ctx</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_indep</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">context</span><span class="main">,</span> prems <span class="main">=</span> <span class="main">_</span><span class="main">}</span> <span class="main">=&gt;</span>
          EVERY <span class="main">[</span><span class="entity">auto_tac</span> <span class="main">(</span><span class="entity">add_simp</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> lens_indep_vwb_iff<span class="antiquote">}</span></span></span> <span class="entity">context</span><span class="main">)</span>
                <span class="main">,</span><span class="entity">prove_lens_goal</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="entity">context</span><span class="main">]</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_sublens</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">context</span><span class="main">,</span> prems <span class="main">=</span> <span class="main">_</span><span class="main">}</span> <span class="main">=&gt;</span>
          EVERY <span class="main">[</span><span class="entity">auto_tac</span> <span class="main">(</span><span class="entity">add_simp</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sublens_iff_sublens'<span class="antiquote">}</span></span></span> <span class="entity">context</span><span class="main">)</span>
                <span class="main">,</span><span class="entity">prove_lens_goal</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="entity">context</span><span class="main">]</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_quotient</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">context</span><span class="main">,</span> prems <span class="main">=</span> <span class="main">_</span><span class="main">}</span> <span class="main">=&gt;</span>
          EVERY <span class="main">[</span><span class="entity">prove_lens_goal</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="entity">context</span><span class="main">]</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_equiv</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">context</span><span class="main">,</span> prems <span class="main">=</span> <span class="main">_</span><span class="main">}</span> <span class="main">=&gt;</span>
          EVERY <span class="main">[</span><span class="entity">auto_tac</span> <span class="main">(</span><span class="entity">add_simp</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> lens_equiv_iff_lens_equiv'<span class="antiquote">}</span></span></span> <span class="entity">context</span><span class="main">)</span>
                <span class="main">,</span><span class="entity">prove_lens_goal</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="entity">context</span><span class="main">]</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
 
<span class="comment1">(* Constrct a proof that base + more is a bijective lens *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lens_bij_proof</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
      Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span>Const <span class="main">(</span><span class="entity">bij_lens</span><span class="main">,</span> dummyT<span class="main">)</span> $ 
                <span class="main">(</span>Const <span class="main">(</span><span class="entity">lens_plus</span><span class="main">,</span> dummyT<span class="main">)</span> $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">base_lensN</span><span class="main">,</span> dummyT<span class="main">)</span>
                                           $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">child_lensN</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">context</span><span class="main">,</span> prems <span class="main">=</span> <span class="main">_</span><span class="main">}</span>
                           <span class="main">=&gt;</span> EVERY <span class="main">[</span> <span class="entity">Locale.intro_locales_tac</span> <span class="main">{</span>strict <span class="main">=</span> true<span class="main">,</span> eager <span class="main">=</span> true<span class="main">}</span> <span class="entity">context</span> <span class="main">[</span><span class="main">]</span>
                                    <span class="main">,</span> <span class="entity">auto_tac</span> <span class="main">(</span>fold <span class="entity">add_simp</span> <span class="main">(</span>get_thms <span class="entity">thy</span> <span class="entity">lens_defsN</span> @ <span class="main">[</span>get_thm <span class="entity">thy</span> <span class="entity">prod_case_eq_ifN</span><span class="main">]</span><span class="main">)</span>
                                                                         <span class="entity">context</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Construct a theorem and proof that two lenses, x and y, are independent. Since some lenses exist
   both with the source type as the record extension, and in the context of the extended record
   we need two versions of this function. The first shows it for the lenses on the extension, and
   thus uses an "intro_locales" as a means to discharge the individual lens laws of the vwb_lens
   locale. *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">indep_proof</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
  Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span> Const <span class="main">(</span><span class="entity">lens_indep</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">x</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">y</span><span class="main">,</span> dummyT<span class="main">)</span>
                <span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">prove_indep</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">equiv_more_proof</span> <span class="entity">tname</span> <span class="entity">pname</span> <span class="entity">thy</span> <span class="entity">fs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Context<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Term <span class="keyword2"><span class="keyword">in</span></span>
  Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span> Const <span class="main">(</span><span class="entity">lens_equiv</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ Const <span class="main">(</span><span class="entity">pname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">child_lensN</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ foldr1 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> Const <span class="main">(</span><span class="entity">lens_plus</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">y</span><span class="main">)</span> 
                         <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> Const <span class="main">(</span>theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">n</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">fs</span> @ <span class="main">[</span><span class="entity">child_lensN</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                <span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">prove_equiv</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">equiv_base_proof</span> <span class="entity">tname</span> <span class="entity">parent</span> <span class="entity">thy</span> <span class="entity">fs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Context<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Term <span class="keyword2"><span class="keyword">in</span></span>
  Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span> Const <span class="main">(</span><span class="entity">lens_equiv</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ Const <span class="main">(</span>theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">base_lensN</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ foldr1 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> Const <span class="main">(</span><span class="entity">lens_plus</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">y</span><span class="main">)</span> 
                         <span class="main">(</span><span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">parent</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span> <span class="main">|</span> SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">pname</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span>Const <span class="main">(</span><span class="entity">pname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">base_lensN</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">]</span><span class="main">)</span> @ 
                          map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> Const <span class="main">(</span>theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">n</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span> <span class="entity">fs</span><span class="main">)</span>
                <span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">prove_equiv</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">equiv_partition_proof</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Context<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Term <span class="keyword2"><span class="keyword">in</span></span>
  Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span> Const <span class="main">(</span><span class="entity">lens_equiv</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ <span class="main">(</span> Const <span class="main">(</span><span class="entity">lens_plus</span><span class="main">,</span> dummyT<span class="main">)</span> 
                  $ Const <span class="main">(</span>theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">base_lensN</span><span class="main">,</span> dummyT<span class="main">)</span>
                  $ Const <span class="main">(</span>theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">child_lensN</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span>
                $ Const <span class="main">(</span><span class="entity">id_lens</span><span class="main">,</span> dummyT<span class="main">)</span>
                <span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">prove_equiv</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Prove a theorem that every child lens is a sublens of the parent. *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sublens_proof</span> <span class="entity">tname</span> <span class="entity">pname</span> <span class="entity">thy</span> <span class="entity">y</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
      Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span> Const <span class="main">(</span><span class="entity">sublens</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">x</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ Const <span class="main">(</span><span class="entity">pname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">y</span><span class="main">,</span> dummyT<span class="main">)</span>
                <span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">prove_sublens</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">quotient_proof</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
      Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span> Const <span class="main">(</span><span class="entity">HOLeq</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ <span class="main">(</span>Const <span class="main">(</span><span class="entity">lens_quotient</span><span class="main">,</span> dummyT<span class="main">)</span> 
                   $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">x</span><span class="main">,</span> dummyT<span class="main">)</span>
                   $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">base_lensN</span><span class="main">,</span> dummyT<span class="main">)</span>
                  <span class="main">)</span>
                $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">x</span><span class="main">,</span> dummyT<span class="main">)</span>
                <span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">prove_quotient</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">composition_proof</span> <span class="entity">tname</span> <span class="entity">thy</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory <span class="keyword2"><span class="keyword">in</span></span>
      Goal.prove_global <span class="entity">thy</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">(</span>hd <span class="main">(</span>Type_Infer_Context.infer_types
              <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
              <span class="main">[</span> Const <span class="main">(</span><span class="entity">Trueprop</span><span class="main">,</span> dummyT<span class="main">)</span>
              $ <span class="main">(</span> Const <span class="main">(</span><span class="entity">HOLeq</span><span class="main">,</span> dummyT<span class="main">)</span>
                $ <span class="main">(</span>Const <span class="main">(</span><span class="entity">lens_comp</span><span class="main">,</span> dummyT<span class="main">)</span> 
                   $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">x</span><span class="main">,</span> dummyT<span class="main">)</span>
                   $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">base_lensN</span><span class="main">,</span> dummyT<span class="main">)</span>
                  <span class="main">)</span>
                $ Const <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">x</span><span class="main">,</span> dummyT<span class="main">)</span>
                <span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">prove_quotient</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pairWith</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">pairWith</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">y</span> :: <span class="entity">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">]</span> @ <span class="entity">pairWith</span> <span class="entity">x</span> <span class="entity">ys</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pairings</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">pairings</span> <span class="main">(</span><span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pairWith</span> <span class="entity">x</span> <span class="entity">xs</span> @ <span class="entity">pairings</span> <span class="entity">xs</span><span class="main">;</span>

<span class="comment1">(* Finally we have the function that actually constructs the record, lenses for each field,
   independence proofs, and also sublens proofs. *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_alphabet_cmd</span> <span class="main">_</span> <span class="main">(</span><span class="entity">raw_params</span><span class="main">,</span> <span class="entity">binding</span><span class="main">)</span> <span class="entity">raw_parent</span> <span class="entity">raw_fields</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword3"><span class="keyword">open</span></span> Simplifier<span class="main">;</span> <span class="keyword3"><span class="keyword">open</span></span> Global_Theory
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tname</span> <span class="main">=</span> Binding.name_of <span class="entity">binding</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fields</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">,</span> <span class="entity">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>Binding.suffix_name <span class="entity">lens_suffix</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">,</span> <span class="entity">z</span><span class="main">)</span><span class="main">)</span> <span class="entity">raw_fields</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lnames</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> Binding.name_of <span class="entity">x</span><span class="main">)</span> <span class="entity">raw_fields</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">parent</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">read_parent</span> <span class="entity">raw_parent</span> <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ldef</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">x</span> ^ <span class="inner_quoted">" = "</span> ^ <span class="entity">FLDLENS</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">x</span> ^ <span class="entity">lens_suffix</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pname</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">parent</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="inner_quoted">""</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">plchild</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">parent</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">child_lensN</span> <span class="main">|</span>
        NONE <span class="main">=&gt;</span> <span class="inner_quoted">""</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bldef</span> <span class="main">=</span> <span class="main">(</span><span class="entity">base_lensN</span><span class="main">,</span> <span class="entity">base_lensN</span> ^ <span class="inner_quoted">" = "</span> ^ <span class="entity">BASELENS</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">tname</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mldef</span> <span class="main">=</span> <span class="main">(</span><span class="entity">child_lensN</span><span class="main">,</span> <span class="entity">child_lensN</span> ^ <span class="inner_quoted">" = "</span> ^ <span class="entity">FLDLENS</span> ^ <span class="inner_quoted">" more"</span><span class="main">)</span><span class="main">;</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sldef</span> <span class="main">=</span> <span class="main">(</span><span class="entity">all_lensN</span><span class="main">,</span> <span class="entity">all_lensN</span> ^ <span class="inner_quoted">" ≡ ⦇ "</span> ^ <span class="entity">slens_view</span> ^ <span class="inner_quoted">" = "</span> ^ <span class="entity">base_lensN</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">slens_coview</span> ^ <span class="inner_quoted">" = "</span> ^ <span class="entity">child_lensN</span> ^ <span class="inner_quoted">" ⦈"</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">plnames</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">raw_parent</span> <span class="main">=</span> NONE<span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">lnames</span>  @ <span class="main">[</span><span class="entity">child_lensN</span><span class="main">]</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pindeps</span> <span class="entity">thy</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sublens_pres_indep<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>get_thms <span class="entity">thy</span> <span class="entity">sublensN</span><span class="main">)</span>
                    @ map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sublens_pres_indep'<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>get_thms <span class="entity">thy</span> <span class="entity">sublensN</span><span class="main">)</span>
 <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">thy</span>     <span class="comment1">(* Add a new record for the new alphabet lenses *)</span>
         |&gt; <span class="entity">add_record_cmd</span> <span class="main">{</span>overloaded <span class="main">=</span> false<span class="main">}</span> <span class="main">(</span><span class="entity">raw_params</span><span class="main">,</span> <span class="entity">binding</span><span class="main">)</span> <span class="entity">raw_parent</span> <span class="entity">fields</span>
            <span class="comment1">(* Add the record definition theorems to lens_defs *)</span>
         |&gt; <span class="entity">Named_Target.theory_map</span> <span class="main">(</span>snd o <span class="entity">Specification.theorems_cmd</span> <span class="inner_quoted">""</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span>Binding.empty<span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span>Facts.named <span class="main">(</span><span class="entity">tname</span> ^ <span class="entity">defs_suffix</span><span class="main">)</span><span class="main">,</span> snd <span class="entity">lens_defs</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> false<span class="main">)</span>
            <span class="comment1">(* Add the record splitting theorems to the alpha_splits set for proof automation *)</span>
         |&gt; <span class="entity">Named_Target.theory_map</span> <span class="main">(</span>snd o <span class="entity">Specification.theorems_cmd</span> <span class="inner_quoted">""</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span>Binding.empty<span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span>Facts.named <span class="main">(</span><span class="entity">tname</span> ^ <span class="entity">splits_suffix</span><span class="main">)</span><span class="main">,</span> <span class="entity">alpha_splits</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> false<span class="main">)</span>
            <span class="comment1">(* Add definitions for each of the lenses corresponding to each record field in-situ *)</span>
         |&gt; Sign.qualified_path false <span class="entity">binding</span>
         |&gt; <span class="entity">Named_Target.theory_map</span>
              <span class="main">(</span>fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">d</span><span class="main">)</span> <span class="main">=&gt;</span> snd o <span class="entity">Specification.definition_cmd</span> <span class="main">(</span>SOME <span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">n</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> NONE<span class="main">,</span> NoSyn<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="entity">lens_defs</span><span class="main">,</span> <span class="entity">d</span><span class="main">)</span> true<span class="main">)</span> <span class="main">(</span>map <span class="entity">ldef</span> <span class="entity">lnames</span> @ <span class="main">[</span><span class="entity">bldef</span><span class="main">,</span> <span class="entity">mldef</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
            <span class="comment1">(* Add definition of the underlying symmetric lens *)</span>
         |&gt; <span class="entity">Named_Target.theory_map</span>
              <span class="main">(</span>fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">d</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Specification.abbreviation_cmd</span> Syntax.mode_default <span class="main">(</span>SOME <span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">n</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> NONE<span class="main">,</span> NoSyn<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="entity">d</span> true<span class="main">)</span> <span class="main">[</span><span class="entity">sldef</span><span class="main">]</span><span class="main">)</span>
            <span class="comment1">(* Add a vwb lens proof for each field lens *)</span>
         |&gt; fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> snd <span class="main">(</span>add_thm <span class="main">(</span><span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">x</span> ^ <span class="entity">vwb_lens_suffix</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> <span class="entity">lens_proof</span> <span class="entity">tname</span> <span class="entity">x</span> <span class="entity">thy</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">Simplifier.simp_add</span><span class="main">]</span><span class="main">)</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">lnames</span> @ <span class="main">[</span><span class="entity">base_lensN</span><span class="main">,</span> <span class="entity">child_lensN</span><span class="main">]</span><span class="main">)</span>
            <span class="comment1">(* Add a bij lens proof for the base and more lenses *)</span>
         |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> snd <span class="main">(</span>add_thm <span class="main">(</span><span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">base_moreN</span> ^ <span class="entity">bij_lens_suffix</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> <span class="entity">lens_bij_proof</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">Simplifier.simp_add</span><span class="main">]</span><span class="main">)</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
            <span class="comment1">(* Add sublens proofs *)</span>
         |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> snd <span class="main">(</span>add_thmss <span class="main">[</span><span class="main">(</span><span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">sublensN</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="entity">sublens_proof</span> <span class="entity">tname</span> <span class="entity">pname</span> <span class="entity">thy</span> <span class="entity">plchild</span><span class="main">)</span> <span class="entity">plnames</span> @ map <span class="main">(</span><span class="entity">sublens_proof</span> <span class="entity">tname</span> <span class="main">(</span>Context.theory_name <span class="entity">thy</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">tname</span><span class="main">)</span> <span class="entity">thy</span> <span class="entity">base_lensN</span><span class="main">)</span> <span class="entity">lnames</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">Simplifier.simp_add</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
            <span class="comment1">(* Add quotient proofs *)</span>
         |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> snd <span class="main">(</span>add_thmss <span class="main">[</span><span class="main">(</span><span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">quotientN</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="entity">quotient_proof</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">lnames</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">Simplifier.simp_add</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
            <span class="comment1">(* Add composition proofs *)</span>
         |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> snd <span class="main">(</span>add_thmss <span class="main">[</span><span class="main">(</span><span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">compositionN</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="entity">composition_proof</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">lnames</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">Simplifier.simp_add</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
            <span class="comment1">(* Add independence proofs for each pairing of lenses *)</span>
         |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> snd <span class="main">(</span>add_thmss
              <span class="main">[</span><span class="main">(</span><span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">indepsN</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="entity">indep_proof</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">(</span><span class="entity">pairings</span> <span class="main">(</span><span class="entity">lnames</span> @ <span class="main">[</span><span class="entity">child_lensN</span><span class="main">]</span><span class="main">)</span> @ <span class="entity">pairings</span> <span class="main">[</span><span class="entity">base_lensN</span><span class="main">,</span> <span class="entity">child_lensN</span><span class="main">]</span><span class="main">)</span> <span class="comment1">(*@ map (parent_indep_proof_1 tname pname thy plchild) plnames @ map (parent_indep_proof_2 tname pname thy plchild) plnames *)</span> @ <span class="entity">pindeps</span> <span class="entity">thy</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">Simplifier.simp_add</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
            <span class="comment1">(* Add equivalence properties *)</span>
         |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> snd <span class="main">(</span>add_thmss
              <span class="main">[</span><span class="main">(</span><span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">equivN</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">raw_parent</span> <span class="main">=</span> NONE<span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="entity">equiv_more_proof</span> <span class="entity">tname</span> <span class="entity">pname</span> <span class="entity">thy</span> <span class="entity">lnames</span><span class="main">]</span><span class="main">)</span> @ <span class="main">[</span><span class="entity">equiv_base_proof</span> <span class="entity">tname</span> <span class="entity">parent</span> <span class="entity">thy</span> <span class="entity">lnames</span><span class="main">,</span> <span class="entity">equiv_partition_proof</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">Simplifier.simp_add</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
            <span class="comment1">(* Add a symmetric lens proof for the base and more lenses *)</span>
         |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> snd <span class="main">(</span>add_thm <span class="main">(</span><span class="main">(</span>Binding.make <span class="main">(</span><span class="entity">all_lensN</span> ^ <span class="entity">sym_lens_suffix</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> <span class="entity">lens_sym_proof</span> <span class="entity">tname</span> <span class="entity">thy</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">Simplifier.simp_add</span><span class="main">]</span><span class="main">)</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> 
         |&gt; Sign.parent_path
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">alphabet</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"define record with lenses"</span>
    <span class="main">(</span><span class="entity">Parse_Spec.overloaded</span> -- <span class="main">(</span>Parse.type_args_constrained -- Parse.binding<span class="main">)</span> --
      <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">=</span>"<span class="antiquote">}</span></span></span> |-- Scan.option <span class="main">(</span>Parse.typ --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">+</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> --
        Scan.repeat1 Parse.const_binding<span class="main">)</span>
    &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">overloaded</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">Toplevel.theory</span> <span class="main">(</span><span class="entity">add_alphabet_cmd</span> <span class="main">{</span>overloaded <span class="main">=</span> <span class="entity">overloaded</span><span class="main">}</span> <span class="entity">x</span> <span class="entity">y</span> <span class="entity">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lenses">
<div class="head">
<h1>Theory Lenses</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lenses›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lenses
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Lens_Laws.html">Lens_Laws</a>
    <a href="Lens_Algebra.html">Lens_Algebra</a>
    <a href="Lens_Order.html">Lens_Order</a>
    <a href="Lens_Symmetric.html">Lens_Symmetric</a>
    <a href="Lens_Instances.html">Lens_Instances</a>
<span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Prisms">
<div class="head">
<h1>Theory Prisms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Prisms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Prisms
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prisms are like lenses, but they act on sum types rather than product types. For now
  we do not support many properties about them. See \url{https://hackage.haskell.org/package/lens-4.15.2/docs/Control-Lens-Prism.html}
  for more information.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> prism <span class="main">=</span>
  prism_match <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'v</span> option"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">match</span>ı"</span><span class="main">)</span>
  prism_build <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">build</span>ı"</span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> wb_prism <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> prism"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match_build<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">match</span> <span class="main">(</span><span class="keyword1">build</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> build_match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">match</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="keyword1">build</span> <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> build_match_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">match</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">=</span> <span class="keyword1">build</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> build_match match_build <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">lemma</span></span> range_build<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="keyword1">build</span> <span class="main">=</span> dom <span class="keyword1">match</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> build_match match_build <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prism_suml</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> prism"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">prism_suml</span> <span class="main">=</span> <span class="main">⦇</span> prism_match <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> Some <span class="bound">x</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span><span class="main">,</span> prism_build <span class="main">=</span> Inl <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wb_prim_suml<span class="main">:</span> <span class="quoted"><span class="quoted">"wb_prism prism_suml"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prism_suml_def sum.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.inject option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sum.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prism_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> prism <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> prism <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∇</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">prism_diff</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span>range <span class="keyword1">build</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">∩</span> range <span class="keyword1">build</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prism_diff_build<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∇</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="keyword1">build</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">X</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">build</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">Y</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_iff_not_equal prism_diff_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prism_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> prism <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> prism <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> prism"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">+<span class="hidden">⇩</span><sub>P</sub></span>"</span> 85<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">+<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">⦇</span> prism_match <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">case</span> <span class="main">(</span><span class="keyword1">match</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s</span><span class="main">,</span> <span class="keyword1">match</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">of</span>
                                 <span class="main">(</span>Some <span class="bound">u</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>Inl <span class="bound">u</span><span class="main">)</span> <span class="main">|</span>
                                 <span class="main">(</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>Inr <span class="bound">v</span><span class="main">)</span> <span class="main">|</span>
                                 <span class="main">(</span>None<span class="main">,</span> None<span class="main">)</span> <span class="main">⇒</span> None<span class="main">)</span><span class="main">,</span>
           prism_build <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> <span class="keyword1">build</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">x</span> <span class="main">|</span> Inr <span class="bound">y</span> <span class="main">⇒</span> <span class="keyword1">build</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Scenes">
<div class="head">
<h1>Theory Scenes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Scenes ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Scenes
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lens_Instances.html">Lens_Instances</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Like lenses, scenes characterise a region of a source type. However, unlike lenses, scenes
  do not explicitly assign a view type to this region, and consequently they have just one type
  parameter. This means they can be more flexibly composed, and in particular it is possible to
  show they form nice algebraic structures in Isabelle/HOL. They are mainly of use in characterising
  sets of variables, where, of course, we do not care about the types of those variables and
  therefore representing them as lenses is inconvenient. ›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Overriding Functions ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Overriding functions provide an abstract way of replacing a region of an existing source
  with the corresponding region of another source. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> overrider <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1">▹</span></span>"</span> 65<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    ovr_overshadow_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">▹</span></span> <span class="free">y</span> <span class="main"><span class="free">▹</span></span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main"><span class="free">▹</span></span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ovr_overshadow_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span><span class="free">y</span> <span class="main"><span class="free">▹</span></span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main"><span class="free">▹</span></span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> ovr_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span><span class="free">y</span> <span class="main"><span class="free">▹</span></span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main"><span class="free">▹</span></span> <span class="free">y</span> <span class="main"><span class="free">▹</span></span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ovr_overshadow_left ovr_overshadow_right<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> idem_overrider <span class="main">=</span> overrider <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ovr_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">▹</span></span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> overrider.ovr_overshadow_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> overrider.ovr_overshadow_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> idem_overrider.ovr_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Scene Type ›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'s</span> scene <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">F</span> <span class="main">::</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">.</span> overrider <span class="bound">F</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_scene

<span class="keyword1"><span class="command">lift_definition</span></span> idem_scene <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">idem_overrider</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> region <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> rel"</span></span> 
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">F</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">F</span> <span class="bound">s</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">F</span> <span class="bound">s</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> coregion <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> rel"</span></span> 
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">F</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">F</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">F</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> equiv_region<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">(</span>region <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equivI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl_onI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> symI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> equiv_coregion<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">(</span>coregion <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equivI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl_onI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> symI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> region_coregion_Id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"idem_scene <span class="free">X</span> <span class="main">⟹</span> region <span class="free">X</span> <span class="main">∩</span> coregion <span class="free">X</span> <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> idem_overrider.ovr_idem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> state_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> region <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> coregion <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntE IntI pair_in_Id_conv region_coregion_Id<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> scene_override <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> scene<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> _ <span class="keyword1">on</span> _"</span> <span class="main">[</span>95<span class="main">,</span>0<span class="main">,</span>96<span class="main">]</span> 95<span class="main">)</span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">F</span><span class="main">.</span> <span class="bound">F</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scene_override_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">X</span> <span class="main">⟹</span> <span class="free">s</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">s</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_override_overshadow_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_override_overshadow_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">scene_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> scene<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≈<span class="hidden">⇩</span><sub>S</sub></span> _ <span class="keyword1">on</span> _"</span> <span class="main">[</span>65<span class="main">,</span>0<span class="main">,</span>66<span class="main">]</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>S</sub></span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scene_equiv_region<span class="main">:</span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">X</span> <span class="main">⟹</span> region <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> idem_overrider.ovr_idem<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> overrider.ovr_overshadow_right<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> scene_indep <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> scene <span class="main">⇒</span> <span class="tfree">'a</span> scene <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">F</span> <span class="bound">G</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span> <span class="bound">G</span> <span class="main">(</span><span class="bound">F</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="bound">F</span> <span class="main">(</span><span class="bound">G</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scene_indep_override<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_indep_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Compatibility is a weaker notion than independence; the scenes can overlap but they must
  agree when they do. ›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> scene_compat <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> scene <span class="main">⇒</span> <span class="tfree">'a</span> scene <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">F</span> <span class="bound">G</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">G</span> <span class="main">(</span><span class="bound">F</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">F</span> <span class="main">(</span><span class="bound">G</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scene_indep_compat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_compat_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_compat_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_override_commute_indep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> scene <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>bot<span class="main">,</span> top<span class="main">,</span> uminus<span class="main">,</span> sup<span class="main">,</span> inf<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">bot_scene</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">top_scene</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">uminus_scene</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">F</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">F</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Scene union requires that the two scenes are at least compatible. If they are not, the
        result is the bottom scene. ›</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">sup_scene</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene"</span></span> 
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">F</span> <span class="bound">G</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">G</span> <span class="main">(</span><span class="bound">F</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">F</span> <span class="main">(</span><span class="bound">G</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">G</span> <span class="main">(</span><span class="bound">F</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> overrider.ovr_overshadow_right<span class="main">)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">inf_scene</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inf_scene</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span>sup <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">union_scene</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">union_scene</span> <span class="main">≡</span> sup"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">inter_scene</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene <span class="main">⇒</span> <span class="tfree">'s</span> scene"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊓<span class="hidden">⇩</span><sub>S</sub></span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inter_scene</span> <span class="main">≡</span> inf"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">top_scene</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">top_scene</span> <span class="main">≡</span> top"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bot_scene</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> scene"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bot_scene</span> <span class="main">≡</span> bot"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_scene_twice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">::</span> <span class="tfree">'s</span> scene<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_override_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_override_unit <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_override_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_incompat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_override_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_annhil<span class="main">:</span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">=</span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_pres_compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">B</span><span class="main">;</span> <span class="free">A</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">C</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_indep_self_compl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">-</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_assoc<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">Y</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_inter_indep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊓<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> idem_overrider.ovr_idem overrider.ovr_assoc overrider.ovr_overshadow_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> idem_overrider.ovr_idem overrider.ovr_overshadow_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_compl<span class="main">:</span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">-</span> <span class="free">X</span> <span class="main">=</span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_inter_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊓<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">=</span> <span class="free">Y</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> scene_inter_compl<span class="main">:</span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊓<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">-</span> <span class="free">X</span> <span class="main">=</span> <span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_demorgan1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="free">X</span> <span class="keyword1">⊓<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">-</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_demorgan2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="free">X</span> <span class="keyword1">⊓<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">-</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_compat_top<span class="main">:</span> <span class="quoted"><span class="quoted">"idem_scene <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> scene <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ $X$ is a subscene of $Y$ provided that overriding with first $Y$ and then $X$ can
         be rewritten using the complement of $X$. ›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_scene</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> scene <span class="main">⇒</span> <span class="tfree">'a</span> scene <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">less_eq_scene</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_scene</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> scene <span class="main">⇒</span> <span class="tfree">'a</span> scene <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">less_scene</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subscene</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> scene <span class="main">⇒</span> <span class="tfree">'a</span> scene <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊆<span class="hidden">⇩</span><sub>S</sub></span>"</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subscene</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subscene_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_scene_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subscene_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> idem_scene <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> idem_overrider.ovr_idem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subscene_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> idem_scene <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">X</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> idem_overrider.ovr_idem overrider.ovr_overshadow_left<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> subscene_eliminate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> idem_scene <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="main">≤</span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_scene_def scene_override_overshadow_left scene_override_idem<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> scene_bot_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">≤</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_scene_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_top_greatest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_scene_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_union_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> idem_scene <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">≤</span> <span class="main">(</span><span class="free">X</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> idem_overrider.ovr_idem overrider.ovr_overshadow_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scene_le_then_compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> idem_scene <span class="free">X</span><span class="main">;</span> idem_scene <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="main">≤</span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_scene_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> idem_overrider.ovr_idem overrider_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> indep_then_compl_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≤</span> <span class="main">-</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_scene_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Linking Scenes and Lenses ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The following function extracts a scene from a very well behaved lens ›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> lens_scene <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⟹</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> scene"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟦</span>_<span class="keyword1">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span>
<span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">X</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>mwb_lens <span class="bound">X</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vwb_impl_idem_scene <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span> <span class="main">⟹</span> idem_scene <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_overshadow_left lens_override_overshadow_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> idem_scene_impl_vwb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> idem_scene <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> vwb_lens <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mwb_lens <span class="free">X</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> idem_overrider_def overrider_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> idem_overrider_axioms_def override_idem_implies_vwb<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_compat_scene<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mwb_lens <span class="free">X</span><span class="main">;</span> mwb_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟷</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_scene.rep_eq scene_compat.rep_eq <span class="dynamic"><span class="dynamic">lens_defs</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Next we show some important congruence properties ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_lens_scene<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">0<span class="hidden">⇩</span><sub>L</sub></span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">=</span> <span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_lens_scene<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">=</span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_scene_override<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mwb_lens <span class="free">X</span> <span class="main">⟹</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_scene<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scene_indep_override<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_override_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_indep_impl_scene_indep <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_indep_comm lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_plus_scene<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">X</span><span class="main">;</span> vwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="main">⨝</span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟦</span><span class="free">X</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">=</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_plus lens_indep_override_def lens_indep_overrideI plus_vwb_lens<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subscene_implies_sublens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">X</span><span class="main">;</span> vwb_lens <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">≤</span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">⟷</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span> less_eq_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens'_implies_subscene<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vwb_lens <span class="free">X</span><span class="main">;</span> vwb_lens <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">≤</span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span> less_eq_scene_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_override_def lens_scene_override<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublens_iff_subscene<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟷</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">≤</span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sublens_iff_sublens' subscene_implies_sublens'<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Equality on scenes is sound and complete with respect to lens equivalence. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_equiv_scene<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"vwb_lens <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span> <span class="main">⟷</span> <span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">=</span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">=</span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> a assms lens_equiv_def sublens_iff_subscene subscene_antisym vwb_impl_idem_scene<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span> <span class="main">=</span> <span class="main">⟦</span><span class="free">Y</span><span class="main">⟧<span class="hidden">⇩</span><sub>∼</sub></span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms b lens_equiv_def sublens_iff_subscene subscene_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Membership operations. These have slightly hacky definitions at the moment in order to
  cater for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">mwb_lens</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. See if they can be generalised? ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lens_member</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> scene <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∈<span class="hidden">⇩</span><sub>S</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">lens_defs</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">lens_member</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span>
                      <span class="main">(</span><span class="main">∀</span> <span class="bound">b</span> <span class="bound">b'</span><span class="main">.</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="bound">b</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="bound">b'</span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lens_member_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_member_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lens_not_member</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> scene <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∉<span class="hidden">⇩</span><sub>S</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">∉<span class="hidden">⇩</span><sub>S</sub></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> lens_member_get_override <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">a</span> <span class="main">⟹</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">b'</span> <span class="keyword1">on</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">b'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_member_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lens_not_member_get_override <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">a</span> <span class="main">⟹</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">b'</span> <span class="keyword1">on</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">get</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="free">x</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_member_def scene_override_commute<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Function Domain Scene ›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> fun_dom_scene <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> scene"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fds</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span>
<span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">A</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> override_on <span class="bound">f</span> <span class="bound">g</span> <span class="bound">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_dom_scene_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fds</span><span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">⊥<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_dom_scene_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fds</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fds</span><span class="main">(</span><span class="free">A</span><span class="main">)</span> <span class="keyword1">⊔<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1">fds</span><span class="main">(</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff override_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_dom_scene_compl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fds</span><span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="keyword1">fds</span><span class="main">(</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff override_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_dom_scene_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fds</span><span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fds</span><span class="main">(</span><span class="free">A</span><span class="main">)</span> <span class="keyword1">⊓<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1">fds</span><span class="main">(</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_scene_def fun_dom_scene_union<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> fun_dom_scene_compl<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_dom_scene_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fds</span><span class="main">(</span>UNIV<span class="main">)</span> <span class="main">=</span> <span class="keyword1">⊤<span class="hidden">⇩</span><sub>S</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff override_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_dom_scene_always_compat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fds</span><span class="main">(</span><span class="free">A</span><span class="main">)</span> <span class="keyword1">##<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1">fds</span><span class="main">(</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Hide implementation details for scenes ›</span></span>  

<span class="keyword1"><span class="command">lifting_update</span></span> scene.lifting
<span class="keyword1"><span class="command">lifting_forget</span></span> scene.lifting

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Optics">
<div class="head">
<h1>Theory Optics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Optics Meta-Theory›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Optics
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lenses.html">Lenses</a> <a href="Prisms.html">Prisms</a> <a href="Scenes.html">Scenes</a>
<span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lens_Record_Example">
<div class="head">
<h1>Theory Lens_Record_Example</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Lens_Record_Example
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Optics.html">Optics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The alphabet command supports syntax illustrated in the following comments.›</span></span>

<span class="keyword1"><span class="command">alphabet</span></span> mylens <span class="main">=</span>
  x <span class="main">::</span> <span class="quoted">nat</span>
  y <span class="main">::</span> <span class="quoted">string</span>

<span class="keyword1"><span class="command">thm</span></span> base_more_bij_lens
<span class="keyword1"><span class="command">thm</span></span> indeps
<span class="keyword1"><span class="command">thm</span></span> equivs
<span class="keyword1"><span class="command">thm</span></span> sublenses
<span class="keyword1"><span class="command">thm</span></span> quotients
<span class="keyword1"><span class="command">thm</span></span> compositions

<span class="keyword1"><span class="command">lemma</span></span> mylens_composition<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"x <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> y <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> more<span class="hidden">⇩</span><sub>L</sub> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> base<span class="hidden">⇩</span><sub>L</sub> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> more<span class="hidden">⇩</span><sub>L</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_equiv_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span>x <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> y<span class="main">)</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> more<span class="hidden">⇩</span><sub>L</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_eq_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>L</sub></span> x <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> y <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> more<span class="hidden">⇩</span><sub>L</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_plus_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lens_equiv_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mylens_bij_lens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_lens <span class="main">(</span>x <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> y <span class="keyword1">+<span class="hidden">⇩</span><sub>L</sub></span> more<span class="hidden">⇩</span><sub>L</sub><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_lens_equiv_id mylens_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">alphabet</span></span> mylens_2 <span class="main">=</span> <span class="quoted"><span class="quoted">mylens</span></span> <span class="main">+</span>
  z <span class="main">::</span> <span class="quoted">int</span>
  k <span class="main">::</span> <span class="quoted"><span class="quoted">"string list"</span></span>

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">lens_defs</span></span>

<span class="keyword1"><span class="command">thm</span></span> base_more_bij_lens
<span class="keyword1"><span class="command">thm</span></span> indeps
<span class="keyword1"><span class="command">thm</span></span> equivs
<span class="keyword1"><span class="command">thm</span></span> sublenses

<span class="keyword1"><span class="command">alphabet</span></span> mylens_3 <span class="main">=</span> <span class="quoted"><span class="quoted">mylens_2</span></span> <span class="main">+</span>
  n <span class="main">::</span> <span class="quoted">real</span>
  h <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">thm</span></span> base_more_bij_lens
<span class="keyword1"><span class="command">thm</span></span> indeps
<span class="keyword1"><span class="command">thm</span></span> equivs
<span class="keyword1"><span class="command">thm</span></span> sublenses

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lens_State">
<div class="head">
<h1>Theory Lens_State</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹State and Lens integration›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lens_State
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/State_Monad.html">HOL-Library.State_Monad</a>"</span>
  <a href="Lens_Algebra.html">Lens_Algebra</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inspired by Haskell's lens package›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">zoom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">zoom</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> State <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">case</span> run_state <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>lens_get <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> lens_put <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">use</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">use</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> zoom <span class="free"><span class="bound"><span class="entity">l</span></span></span> State_Monad.get"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">modify</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">modify</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> zoom <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>State_Monad.update <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⟹</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">assign</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> zoom <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>State_Monad.set <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> modify <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> modify <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mul</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> modify <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">inc</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> add <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> sub <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">1</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">bundle</span></span> lens_state_notation <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">notation</span></span> zoom <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊳</span>"</span> 80<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> modify <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">%=</span>"</span> 80<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> assign <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">.=</span>"</span> 80<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> Lens_State.add <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">+=</span>"</span> 80<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> Lens_State.sub <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">-=</span>"</span> 80<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> Lens_State.mul <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">*=</span>"</span> 80<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> Lens_State.inc <span class="main">(</span><span class="quoted">"_ <span class="keyword1">++</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> Lens_State.dec <span class="main">(</span><span class="quoted">"_ <span class="keyword1">--</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lens_state_notation <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zoom_comp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">⊳</span> <span class="free">l2</span> <span class="main">⊳</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">l2</span> <span class="keyword1">;<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">l1</span><span class="main">)</span> <span class="main">⊳</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> zoom_def lens_comp_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zoom_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zero_lens <span class="main">⊳</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> zoom_def zero_lens_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zoom_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"id_lens <span class="main">⊳</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> zoom_def id_lens_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mwb_lens<span class="main">)</span> zoom_comp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zoom <span class="free">x</span> <span class="free">m</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> zoom <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> zoom <span class="free">x</span> <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> zoom_def State_Monad.bind_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> put_get put_put<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wb_lens<span class="main">)</span> use_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"use <span class="free">x</span> <span class="main">=</span> map_state <span class="main">(</span>lens_get <span class="free">x</span><span class="main">)</span> State_Monad.get"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> State_Monad.get_def use_def zoom_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def get_put<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wb_lens<span class="main">)</span> modify_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"modify <span class="free">x</span> <span class="free">f</span> <span class="main">=</span> State_Monad.update <span class="main">(</span><span class="keyword1">update</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> modify_def zoom_def lens_update_def State_Monad.update_def State_Monad.get_def State_Monad.set_def State_Monad.bind_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
 
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wb_lens<span class="main">)</span> modify_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"modify <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> State_Monad.return <span class="main">()</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lens_update_def modify_alt_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_put<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mwb_lens<span class="main">)</span> modify_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>modify <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> modify <span class="free">x</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> modify <span class="free">x</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> modify_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>