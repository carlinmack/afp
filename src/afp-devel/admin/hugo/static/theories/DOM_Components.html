<div id="Core_DOM_Components">
<div class="head">
<h1>Theory Core_DOM_Components</h1>
</div>
<pre class="source"><span class="comment1">(***********************************************************************************
 * Copyright (c) 2016-2020 The University of Sheffield, UK
 *               2019-2020 University of Exeter, UK
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * SPDX-License-Identifier: BSD-2-Clause
 ***********************************************************************************)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹DOM Components›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Core_DOM_Components
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Core_DOM/Core_DOM.html">Core_DOM.Core_DOM</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">locale</span></span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_defs <span class="main">=</span>
  l_get_root_node_defs <span class="quoted"><span class="free">get_root_node</span></span> <span class="quoted"><span class="free">get_root_node_locs</span></span> <span class="main">+</span>
  l_to_tree_order_defs <span class="quoted"><span class="free">to_tree_order</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">get_root_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">to_tree_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">a_get_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(_,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> dom_prog"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a_get_component</span> <span class="free"><span class="bound"><span class="entity">ptr</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">root</span> <span class="main">←</span> <span class="free">get_root_node</span> <span class="free"><span class="bound"><span class="entity">ptr</span></span></span><span class="main">;</span>
      <span class="free">to_tree_order</span> <span class="bound">root</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">a_is_strongly_dom_component_safe</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a_is_strongly_dom_component_safe</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>t</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">removed_pointers</span> <span class="main">=</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">-</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">added_pointers</span> <span class="main">=</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="main">-</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">arg_components</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span></span></span><span class="main">.</span> set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="main">∩</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">.</span>
        set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">arg_components'</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span></span></span><span class="main">.</span> set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="main">∩</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">.</span>
        set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="bound">removed_pointers</span> <span class="main">⊆</span> <span class="bound">arg_components</span> <span class="main">∧</span>
      <span class="bound">added_pointers</span> <span class="main">⊆</span> <span class="bound">arg_components'</span> <span class="main">∧</span>
      <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>t</sub></span></span></span> <span class="main">⊆</span> <span class="bound">arg_components'</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">outside_ptr</span> <span class="main">∈</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">∩</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span></span></span><span class="main">.</span> set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h</span></span></span>  <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span><span class="main">.</span> preserved <span class="main">(</span>get_M <span class="bound">outside_ptr</span> id<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">a_is_weakly_dom_component_safe</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a_is_weakly_dom_component_safe</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>t</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">removed_pointers</span> <span class="main">=</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">-</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">added_pointers</span> <span class="main">=</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="main">-</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">arg_components</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span></span></span><span class="main">.</span> set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="main">∩</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">.</span>
        set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">arg_components'</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span></span></span><span class="main">.</span> set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="main">∩</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">.</span>
        set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="bound">removed_pointers</span> <span class="main">⊆</span> <span class="bound">arg_components</span> <span class="main">∧</span>
      <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>t</sub></span></span></span> <span class="main">⊆</span> <span class="bound">arg_components'</span> <span class="main">∪</span> <span class="bound">added_pointers</span>  <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">outside_ptr</span> <span class="main">∈</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">∩</span> fset <span class="main">(</span>object_ptr_kinds <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">⋃</span><span class="bound">ptr</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span></span></span><span class="main">.</span> set <span class="main">|</span><span class="free"><span class="bound"><span class="entity">h</span></span></span>  <span class="main">⊢</span> a_get_component <span class="bound">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span><span class="main">.</span> preserved <span class="main">(</span>get_M <span class="bound">outside_ptr</span> id<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"a_is_strongly_dom_component_safe <span class="free">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">h</span> <span class="free">h'</span> <span class="main">⟹</span> a_is_weakly_dom_component_safe <span class="free">S<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_is_strongly_dom_component_safe_def a_is_weakly_dom_component_safe_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_document_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_document_component</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> is_document_ptr_kind <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_disconnected_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_disconnected_component</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> is_node_ptr_kind <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_defs <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">to_tree_order</span>
  <span class="keyword2"><span class="keyword">defines</span></span> get_component <span class="main">=</span> <span class="quoted">a_get_component</span>
    <span class="keyword2"><span class="keyword">and</span></span> is_strongly_dom_component_safe <span class="main">=</span> <span class="quoted">a_is_strongly_dom_component_safe</span>
    <span class="keyword2"><span class="keyword">and</span></span> is_weakly_dom_component_safe <span class="main">=</span> <span class="quoted">a_is_weakly_dom_component_safe</span>
  <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">locale</span></span> l_get_component_defs <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">get_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(_,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> dom_prog"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">is_strongly_dom_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">is_weakly_dom_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_to_tree_order_wf <span class="main">+</span>
  l_get_component_defs <span class="main">+</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_defs <span class="main">+</span>
  l_get_ancestors <span class="main">+</span>
  l_get_ancestors_wf <span class="main">+</span>
  l_get_root_node <span class="main">+</span>
  l_get_root_node_wf<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_parent <span class="main">+</span>
  l_get_parent_wf <span class="main">+</span>
  l_get_element_by <span class="main">+</span>
  l_to_tree_order_wf_get_root_node_wf <span class="main">+</span>
  <span class="comment1">(* l_to_tree_order_wf<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> _ _ _ get_child_nodes +
  l_get_root_node_wf<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> _ _ get_child_nodes+
  l_get_element_by<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> _ _ "l_to_tree_order<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>.a_to_tree_order get_child_nodes"
  for get_child_nodes :: "(_::linorder) object_ptr ⇒ (_, (_) node_ptr list) dom_prog" *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> get_component_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">get_component</span> <span class="main">=</span> a_get_component"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_strongly_dom_component_safe_impl<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">is_strongly_dom_component_safe</span> <span class="main">=</span> a_is_strongly_dom_component_safe"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_weakly_dom_component_safe_impl<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">is_weakly_dom_component_safe</span> <span class="main">=</span> a_is_weakly_dom_component_safe"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> get_component_def <span class="main">=</span> a_get_component_def<span class="main">[</span><span class="operator">folded</span> get_component_impl<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> is_strongly_dom_component_safe_def <span class="main">=</span>
  a_is_strongly_dom_component_safe_def<span class="main">[</span><span class="operator">folded</span> is_strongly_dom_component_safe_impl<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> is_weakly_dom_component_safe_def <span class="main">=</span>
  a_is_weakly_dom_component_safe_def<span class="main">[</span><span class="operator">folded</span> is_weakly_dom_component_safe_impl<span class="main">]</span>

<span class="keyword1" id="Core_DOM_Components-get_dom_component_ptr_in_heap"><span class="command">lemma</span></span> get_dom_component_ptr_in_heap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="keyword1">ok</span> <span class="main">(</span><span class="free">get_component</span> <span class="free">ptr</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms get_root_node_ptr_in_heap
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def<span class="main">)</span>

<span class="keyword1" id="Core_DOM_Components-get_component_ok"><span class="command">lemma</span></span> get_component_ok<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="keyword1">ok</span> <span class="main">(</span><span class="free">get_component</span> <span class="free">ptr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def a_get_root_node_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_is_OK_pure_I<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> get_root_node_ok  to_tree_order_ok get_root_node_ptr_in_heap
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.get_root_node_root_in_heap local.to_tree_order_ok<span class="main">)</span>

<span class="keyword1" id="Core_DOM_Components-get_dom_component_ptr"><span class="command">lemma</span></span> get_dom_component_ptr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">ptr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> heap_wellformed_induct_rev <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">child</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_node_ptr_kind <span class="skolem">child</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">node_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      node_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">node_ptr</span> <span class="main">=</span> <span class="skolem">child</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_node_ptr_kind <span class="skolem">child</span>›</span></span> node_ptr_casts_commute3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">child</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="skolem">child</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>›</span></span> get_dom_component_ptr_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> node_ptr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">node_ptr</span> <span class="main">|∈|</span> node_ptr_kinds <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">parent_opt</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      parent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">parent_opt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> get_parent_ok <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">parent_opt</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="skolem">node_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> cast <span class="skolem">node_ptr</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.get_root_node_no_parent<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span> node_ptr step<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def a_get_root_node_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> to_tree_order_ptr_in_result returns_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">parent_ptr</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="skolem">parent_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span> node_ptr <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="free">h</span>›</span></span>
          get_root_node_parent_same
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_returns_result_I<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">parent_ptr</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step node_ptr Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="free">h</span>›</span></span> step<span class="main">(</span>2<span class="main">)</span> node_ptr Some
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> to_tree_order_parent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span> step<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_result_I local.get_root_node_not_node_same
          local.get_root_node_ptr_in_heap local.to_tree_order_ptr_in_result returns_result_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-get_component_parent_inside"><span class="command">lemma</span></span> get_component_parent_inside<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">node_ptr</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">parent</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">parent</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">parent</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> get_parent_parent_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span> root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> bind_returns_result_E2 get_component_def get_root_node_pure<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">node_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> to_tree_order_same_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">parent</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span>  get_root_node_parent_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">parent</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c get_component_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-get_component_subset"><span class="command">lemma</span></span> get_component_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">ptr'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> heap_wellformed_induct_rev <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">child</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_node_ptr_kind <span class="skolem">child</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">node_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      node_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">node_ptr</span> <span class="main">=</span> <span class="skolem">child</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_node_ptr_kind <span class="skolem">child</span>›</span></span> node_ptr_casts_commute3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">child</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> to_tree_order_ptrs_in_heap assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> step<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> get_component_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_returns_result_E2 get_root_node_pure<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> node_ptr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">node_ptr</span> <span class="main">|∈|</span> node_ptr_kinds <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">parent_opt</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      parent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">parent_opt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> get_parent_ok <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">parent_opt</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="skolem">child</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">child</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> get_root_node_no_parent node_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span> node_ptr step<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> bind_pure_returns_result_I2 bind_returns_result_E2 get_component_def
            get_root_node_pure is_OK_returns_result_I returns_result_eq to_tree_order_same_root<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">parent_ptr</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="skolem">parent_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step get_component_parent_inside assms node_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Some node_ptr
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_pure_returns_result_I <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_returns_result_I<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> get_root_node_parent_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">child</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> step<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bind_returns_result_E2 get_root_node_pure
          get_component_def to_tree_order_ptrs_in_heap<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="skolem">child</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">child</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> False get_root_node_not_node_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> step.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">child</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> bind_pure_returns_result_I2
          bind_returns_result_E2 get_component_def get_root_node_ok get_root_node_pure returns_result_eq
          to_tree_order_node_ptrs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-get_component_to_tree_order_subset"><span class="command">lemma</span></span> get_component_to_tree_order_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">nodes</span> <span class="main">⊆</span> set <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> to_tree_order_subset  assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> contra_subsetD get_dom_component_ptr<span class="main">)</span>

<span class="keyword1" id="Core_DOM_Components-get_component_to_tree_order"><span class="command">lemma</span></span> get_component_to_tree_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">to</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">∈</span> set <span class="free">to</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span>
      get_component_ok get_component_subset get_component_to_tree_order_subset is_OK_returns_result_E
      local.to_tree_order_ptr_in_result local.to_tree_order_ptrs_in_heap select_result_I2 subsetCE<span class="main">)</span>

<span class="keyword1" id="Core_DOM_Components-get_component_root_node_same"><span class="command">lemma</span></span> get_component_root_node_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">root_ptr</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">root_ptr</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> heap_wellformed_induct_rev <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">child</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_node_ptr_kind <span class="skolem">child</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">node_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      node_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">node_ptr</span> <span class="main">=</span> <span class="skolem">child</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_node_ptr_kind <span class="skolem">child</span>›</span></span> node_ptr_casts_commute3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">child</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> to_tree_order_ptrs_in_heap assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> step<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> get_component_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_returns_result_E2 get_root_node_pure<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> node_ptr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">node_ptr</span> <span class="main">|∈|</span> node_ptr_kinds <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">parent_opt</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      parent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">parent_opt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> get_parent_ok <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">parent_opt</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="skolem">child</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">child</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> get_root_node_no_parent  node_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span> node_ptr step<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">child</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> bind_pure_returns_result_I
            get_component_def get_dom_component_ptr get_component_subset get_root_node_pure is_OK_returns_result_E
            returns_result_eq to_tree_order_ok to_tree_order_same_root<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">parent_ptr</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="skolem">parent_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step get_component_parent_inside assms node_ptr
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> get_component_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Some node_ptr
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> get_root_node_parent_same
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="skolem">parent_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr
          step.hyps
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">child</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> step<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bind_returns_result_E2 get_root_node_pure
          get_component_def to_tree_order_ptrs_in_heap<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="skolem">child</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">child</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> False get_root_node_not_node_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> step.prems assms<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> bind_returns_result_E2 get_component_def get_root_node_pure
          returns_result_eq to_tree_order_same_root<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Core_DOM_Components-get_dom_component_no_overlap"><span class="command">lemma</span></span> get_dom_component_no_overlap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">c</span> <span class="main">∩</span> set <span class="free">c'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">c'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span> root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> get_component_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_is_OK_E is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr'</span></span> <span class="keyword2"><span class="keyword">where</span></span> root_ptr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> get_component_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_is_OK_E is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">root_ptr</span> <span class="main">≠</span> <span class="skolem">root_ptr'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 assms
    <span class="keyword1"><span class="command">unfolding</span></span> get_component_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_returns_result_E3 get_root_node_pure returns_result_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="skolem">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 root_ptr get_component_root_node_same assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="skolem">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3 root_ptr' get_component_root_node_same assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> select_result_I2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-get_component_separates_tree_order"><span class="command">lemma</span></span> get_component_separates_tree_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">to</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∉</span> set <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">to</span> <span class="main">∩</span> set <span class="free">c'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms get_dom_component_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">c</span> <span class="main">∩</span> set <span class="free">c'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms get_dom_component_no_overlap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">to</span> <span class="main">⊆</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms get_component_to_tree_order_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-get_component_separates_tree_order_general"><span class="command">lemma</span></span> get_component_separates_tree_order_general<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr''</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">to''</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr''</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∉</span> set <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">to''</span> <span class="main">∩</span> set <span class="free">c'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span> root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bind_is_OK_E get_component_def is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> get_component_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_returns_result_E3<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> root_ptr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms get_component_separates_tree_order get_component_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component<span class="main">?</span><span class="main">:</span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms_def get_component_def
      is_strongly_dom_component_safe_def is_weakly_dom_component_safe_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_child\_nodes›</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_get_child_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_element_by<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-get_dom_component_get_child_nodes"><span class="command">lemma</span></span> get_dom_component_get_child_nodes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">children</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">child</span> <span class="main">∈</span> set <span class="free">children</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">child</span> <span class="main">∈</span> set <span class="free">c</span> <span class="main">⟷</span> <span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"cast <span class="free">child</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_is_OK_E get_component_def is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">child</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_root_node_same root_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> local.child_parent_dual
      local.get_root_node_parent_same
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> local.child_parent_dual
      local.get_component_parent_inside local.get_component_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_is_OK_E get_component_def is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_root_node_same root_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">child</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> local.child_parent_dual local.get_root_node_parent_same
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> local.child_parent_dual
      local.get_component_parent_inside local.get_component_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">child</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">child</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> disjoint_iff_not_equal is_OK_returns_result_E is_OK_returns_result_I
        l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>.get_dom_component_no_overlap local.child_parent_dual local.get_component_ok
        local.get_component_parent_inside local.get_dom_component_ptr local.get_root_node_ptr_in_heap
        local.l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Core_DOM_Components-get_child_nodes_get_component"><span class="command">lemma</span></span> get_child_nodes_get_component<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">children</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cast <span class="main">`</span> set <span class="free">children</span> <span class="main">⊆</span> set <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms get_dom_component_get_child_nodes
  <span class="keyword1"><span class="command">using</span></span> local.get_dom_component_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="Core_DOM_Components-get_child_nodes_strongly_dom_component_safe"><span class="command">lemma</span></span> get_child_nodes_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">children</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_strongly_dom_component_safe</span> <span class="main">{</span><span class="free">ptr</span><span class="main">}</span> <span class="main">(</span>cast <span class="main">`</span> set <span class="free">children</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> local.get_child_nodes_pure pure_returns_heap_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_strongly_dom_component_safe_def Let_def preserved_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> IntI finite_set_in get_dom_component_get_child_nodes is_OK_returns_result_E
        is_OK_returns_result_I local.get_child_nodes_ptr_in_heap local.get_component_impl
        local.get_component_ok local.get_dom_component_ptr select_result_I2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_get_child_nodes<span class="main">?</span><span class="main">:</span> l_get_component_get_child_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">first_in_tree_order</span> <span class="quoted">get_attribute</span> <span class="quoted">get_attribute_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_get_child_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_get_child_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_parent›</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_get_parent<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_parent<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_element_by<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-get_parent_is_strongly_dom_component_safe_step"><span class="command">lemma</span></span> get_parent_is_strongly_dom_component_safe_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">parent</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">parent</span> <span class="main">∈</span> set <span class="free">c</span> <span class="main">⟷</span> cast <span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> is_OK_returns_result_E
      l_to_tree_order_wf.to_tree_order_parent local.get_component_parent_inside local.get_component_subset
      local.get_component_to_tree_order_subset local.get_parent_parent_in_heap local.l_to_tree_order_wf_axioms
      local.to_tree_order_ok local.to_tree_order_ptr_in_result subsetCE<span class="main">)</span>


<span class="keyword1" id="Core_DOM_Components-get_parent_is_strongly_dom_component_safe"><span class="command">lemma</span></span> get_parent_is_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">parent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_strongly_dom_component_safe</span> <span class="main">{</span>cast <span class="free">node_ptr</span><span class="main">}</span> <span class="main">{</span><span class="free">parent</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> local.get_parent_pure pure_returns_heap_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_strongly_dom_component_safe_def Let_def preserved_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_dom_component_get_child_nodes local.get_component_impl local.get_dom_component_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Int_iff finite_set_in get_parent_is_strongly_dom_component_safe_step
        local.get_component_ok local.get_parent_parent_in_heap local.to_tree_order_ok local.to_tree_order_parent
        local.to_tree_order_ptr_in_result local.to_tree_order_ptrs_in_heap returns_result_select_result<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_get_parent<span class="main">?</span><span class="main">:</span> l_get_component_get_parent<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">first_in_tree_order</span> <span class="quoted">get_attribute</span> <span class="quoted">get_attribute_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_get_parent<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_get_parent<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_root\_node›</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_get_root_node<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_root_node<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_element_by<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-get_root_node_is_strongly_dom_component_safe_step"><span class="command">lemma</span></span> get_root_node_is_strongly_dom_component_safe_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">root</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">∈</span> set <span class="free">c</span> <span class="main">⟷</span> <span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_is_OK_E get_component_def is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">root</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_root_node_same root_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> calculation assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span>
        is_OK_returns_result_E local.get_root_node_root_in_heap local.to_tree_order_ok
        local.to_tree_order_ptr_in_result local.to_tree_order_same_root select_result_I2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"1"</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_pure_returns_result_I bind_returns_result_E3
        local.get_component_def local.get_component_subset local.get_root_node_pure<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_is_OK_E get_component_def is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_root_node_same root_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">root</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> is_OK_returns_result_E local.get_root_node_root_in_heap
        local.to_tree_order_ok local.to_tree_order_ptr_in_result local.to_tree_order_same_root returns_result_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> local.get_component_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> bind_returns_result_E3 local.get_component_def local.to_tree_order_ptr_in_result
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-get_root_node_is_strongly_dom_component_safe"><span class="command">lemma</span></span> get_root_node_is_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">root</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_strongly_dom_component_safe</span> <span class="main">{</span><span class="free">ptr</span><span class="main">}</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> local.get_root_node_pure pure_returns_heap_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_strongly_dom_component_safe_def Let_def preserved_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> IntI get_root_node_is_strongly_dom_component_safe_step is_OK_returns_result_I
        local.get_component_impl local.get_component_ok local.get_dom_component_ptr
        local.get_root_node_ptr_in_heap notin_fset returns_result_select_result<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_get_root_node<span class="main">?</span><span class="main">:</span> l_get_component_get_root_node<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">first_in_tree_order</span> <span class="quoted">get_attribute</span> <span class="quoted">get_attribute_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_get_root_node<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_get_root_node<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_element\_by\_id›</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_get_element_by_id<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_first_in_tree_order<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_to_tree_order<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_element_by<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-get_element_by_id_is_strongly_dom_component_safe_step"><span class="command">lemma</span></span> get_element_by_id_is_strongly_dom_component_safe_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_element_by_id</span> <span class="free">ptr'</span> <span class="free">idd</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">result</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span> <span class="main">⟷</span> <span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_is_OK_E get_component_def is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def bind_returns_result_E3<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_element_by_id</span> <span class="free">ptr'</span> <span class="free">idd</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">result</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_element_by_id_def first_in_tree_order_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_is_OK_E is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_element_by_id</span> <span class="free">ptr'</span> <span class="free">idd</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">result</span>›</span></span> get_element_by_id_result_in_tree_order
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">result</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_root_node_same root_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_dom_component_ptr get_component_root_node_same
      get_component_subset get_component_to_tree_order
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_component_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation get_dom_component_ptr_in_heap
        get_component_subset is_OK_returns_result_E is_OK_returns_result_I to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">to'</span> <span class="main">⊆</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_subset get_component_to_tree_order_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> get_element_by_id_result_in_tree_order to' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Core_DOM_Components-get_element_by_id_is_strongly_dom_component_safe"><span class="command">lemma</span></span> get_element_by_id_is_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_element_by_id</span> <span class="free">ptr</span> <span class="free">idd</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">result</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_element_by_id</span> <span class="free">ptr</span> <span class="free">idd</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_strongly_dom_component_safe</span> <span class="main">{</span><span class="free">ptr</span><span class="main">}</span> <span class="main">{</span>cast <span class="free">result</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preserved_def get_element_by_id_def first_in_tree_order_def
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure bind_pure_I <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_element_by_id_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bind_is_OK_E is_OK_returns_result_I
        local.first_in_tree_order_def local.to_tree_order_ptr_in_result local.to_tree_order_ptrs_in_heap<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span> to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_OK_returns_result_E
        local.to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> local.get_element_by_id_result_in_tree_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> a_get_component <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> local.get_component_impl
      local.get_component_ok
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_strongly_dom_component_safe_def Let_def preserved_def get_element_by_id_def
        first_in_tree_order_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure bind_pure_I
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_iff <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> finite_set_in
        get_element_by_id_is_strongly_dom_component_safe_step local.get_component_impl local.get_dom_component_ptr
        select_result_I2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_get_element_by_id<span class="main">?</span><span class="main">:</span> l_get_component_get_element_by_id<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">first_in_tree_order</span> <span class="quoted">get_attribute</span> <span class="quoted">get_attribute_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_get_element_by_id<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_get_element_by_id<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_elements\_by\_class\_name›</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_get_elements_by_class_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_first_in_tree_order<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_to_tree_order<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_element_by<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-get_elements_by_class_name_result_in_tree_order"><span class="command">lemma</span></span> get_elements_by_class_name_result_in_tree_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_class_name</span> <span class="free">ptr</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">to</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">∈</span> set <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">to</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_elements_by_class_name_def first_in_tree_order_def
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure_E<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">result</span></span><span class="main"><span class="main">]</span></span>  bind_returns_result_E2
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E3<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure map_M_pure_I bind_pure_I
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits if_splits<span class="main">)</span>

<span class="keyword1" id="Core_DOM_Components-get_elements_by_class_name_is_strongly_dom_component_safe_step"><span class="command">lemma</span></span> get_elements_by_class_name_is_strongly_dom_component_safe_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_class_name</span> <span class="free">ptr'</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">∈</span> set <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span> <span class="main">⟷</span> <span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_is_OK_E get_component_def is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def bind_returns_result_E3<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_class_name</span> <span class="free">ptr'</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">results</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_elements_by_class_name_def first_in_tree_order_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_is_OK_E is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_elements_by_class_name_result_in_tree_order assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">result</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_root_node_same root_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_dom_component_ptr get_component_root_node_same
      get_component_subset get_component_to_tree_order
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_component_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation get_dom_component_ptr_in_heap
        get_component_subset is_OK_returns_result_E is_OK_returns_result_I to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">to'</span> <span class="main">⊆</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_subset get_component_to_tree_order_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms get_elements_by_class_name_result_in_tree_order to' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-get_elements_by_class_name_pure"><span class="command">lemma</span></span> get_elements_by_class_name_pure <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pure <span class="main">(</span><span class="free">get_elements_by_class_name</span> <span class="free">ptr</span> <span class="free">name</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_elements_by_class_name_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_I map_filter_M_pure
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Core_DOM_Components-get_elements_by_class_name_is_strongly_dom_component_safe"><span class="command">lemma</span></span> get_elements_by_class_name_is_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_class_name</span> <span class="free">ptr</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_class_name</span> <span class="free">ptr</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_strongly_dom_component_safe</span> <span class="main">{</span><span class="free">ptr</span><span class="main">}</span> <span class="main">(</span>cast <span class="main">`</span> set <span class="free">results</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> get_elements_by_class_name_pure pure_returns_heap_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_elements_by_class_name_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bind_is_OK_E is_OK_returns_result_I
        local.first_in_tree_order_def local.to_tree_order_ptr_in_result local.to_tree_order_ptrs_in_heap<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span> to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_OK_returns_result_E
        local.to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="main">`</span> set <span class="free">results</span> <span class="main">⊆</span> set <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> local.get_elements_by_class_name_result_in_tree_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> a_get_component <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> local.get_component_impl local.get_component_ok
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_strongly_dom_component_safe_def Let_def preserved_def
        get_elements_by_class_name_def first_in_tree_order_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure bind_pure_I <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_iff <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> finite_set_in
        get_elements_by_class_name_is_strongly_dom_component_safe_step local.get_component_impl
        local.get_dom_component_ptr select_result_I2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_get_elements_by_class_name<span class="main">?</span><span class="main">:</span> l_get_component_get_elements_by_class_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">first_in_tree_order</span> <span class="quoted">get_attribute</span> <span class="quoted">get_attribute_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_get_elements_by_class_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_get_elements_by_class_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_elements\_by\_tag\_name›</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_get_elements_by_tag_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_first_in_tree_order<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_to_tree_order<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_element_by<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-get_elements_by_tag_name_result_in_tree_order"><span class="command">lemma</span></span> get_elements_by_tag_name_result_in_tree_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_tag_name</span> <span class="free">ptr</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">to</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">∈</span> set <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">to</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_elements_by_tag_name_def first_in_tree_order_def
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure_E<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">result</span></span><span class="main"><span class="main">]</span></span>  bind_returns_result_E2
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E3<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure map_M_pure_I bind_pure_I
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits if_splits<span class="main">)</span>

<span class="keyword1" id="Core_DOM_Components-get_elements_by_tag_name_is_strongly_dom_component_safe_step"><span class="command">lemma</span></span> get_elements_by_tag_name_is_strongly_dom_component_safe_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_tag_name</span> <span class="free">ptr'</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">∈</span> set <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span> <span class="main">⟷</span> <span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_is_OK_E get_component_def is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_component_def bind_returns_result_E3<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_tag_name</span> <span class="free">ptr'</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">results</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_elements_by_tag_name_def first_in_tree_order_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_is_OK_E is_OK_returns_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_elements_by_tag_name_result_in_tree_order assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">result</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_root_node_same root_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_dom_component_ptr get_component_root_node_same
      get_component_subset get_component_to_tree_order
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">c</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_component_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation get_dom_component_ptr_in_heap
        get_component_subset is_OK_returns_result_E is_OK_returns_result_I to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">to'</span> <span class="main">⊆</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_component_subset get_component_to_tree_order_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms get_elements_by_tag_name_result_in_tree_order to' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-get_elements_by_tag_name_is_strongly_dom_component_safe"><span class="command">lemma</span></span> get_elements_by_tag_name_is_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_tag_name</span> <span class="free">ptr</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">results</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_elements_by_tag_name</span> <span class="free">ptr</span> <span class="free">name</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_strongly_dom_component_safe</span> <span class="main">{</span><span class="free">ptr</span><span class="main">}</span> <span class="main">(</span>cast <span class="main">`</span> set <span class="free">results</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> get_elements_by_tag_name_pure pure_returns_heap_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_elements_by_tag_name_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bind_is_OK_E is_OK_returns_result_I
        local.first_in_tree_order_def local.to_tree_order_ptr_in_result local.to_tree_order_ptrs_in_heap<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span> to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_OK_returns_result_E
        local.to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="main">`</span> set <span class="free">results</span> <span class="main">⊆</span> set <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> local.get_elements_by_tag_name_result_in_tree_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> a_get_component <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> local.get_component_impl local.get_component_ok
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_strongly_dom_component_safe_def Let_def preserved_def
        get_elements_by_class_name_def first_in_tree_order_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure bind_pure_I <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> IntI <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> finite_set_in
        get_elements_by_tag_name_is_strongly_dom_component_safe_step local.get_component_impl
        local.get_dom_component_ptr select_result_I2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_get_elements_by_tag_name<span class="main">?</span><span class="main">:</span> l_get_component_get_elements_by_tag_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">first_in_tree_order</span> <span class="quoted">get_attribute</span> <span class="quoted">get_attribute_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_get_elements_by_tag_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_get_elements_by_tag_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹remove\_child›</span></span>

<span class="keyword1" id="Core_DOM_Components-remove_child_not_strongly_dom_component_safe"><span class="command">lemma</span></span> remove_child_not_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">child</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> remove_child <span class="free">ptr</span> <span class="free">child</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">{</span> <span class="free">ptr</span><span class="main">,</span> cast <span class="free">child</span><span class="main">}</span> <span class="main">{}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
      <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
      append_child <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e2</span><span class="main">)</span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">e1</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> child<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹adopt\_node›</span></span>

<span class="keyword1" id="Core_DOM_Components-adopt_node_not_strongly_dom_component_safe"><span class="command">lemma</span></span> adopt_node_not_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">document_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">child</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> adopt_node <span class="free">document_ptr</span> <span class="free">child</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">{</span>cast <span class="free">document_ptr</span><span class="main">,</span> cast <span class="free">child</span><span class="main">}</span> <span class="main">{}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
      <span class="bound">document_ptr2</span> <span class="main">←</span> create_document<span class="main">;</span>
      <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
      adopt_node <span class="bound">document_ptr2</span> <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">document_ptr</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?document_ptr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> document_ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?document_ptr</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> child<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹create\_element›</span></span>

<span class="keyword1" id="Core_DOM_Components-create_element_not_strongly_component_safe"><span class="command">lemma</span></span> create_element_not_strongly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">document_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">new_element_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">tag</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> create_element <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">new_element_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">{</span>cast <span class="free">document_ptr</span><span class="main">}</span> <span class="main">{</span>cast <span class="free">new_element_ptr</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"create_document"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?document_ptr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> document_ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?document_ptr</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">locale</span></span> l_get_component_create_element<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">heap_is_wellformed</span></span> <span class="quoted"><span class="free">parent_child_rel</span></span> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">known_ptr</span></span> <span class="quoted"><span class="free">known_ptrs</span></span> <span class="quoted"><span class="free">to_tree_order</span></span>
  <span class="quoted"><span class="free">get_parent</span></span> <span class="quoted"><span class="free">get_parent_locs</span></span> <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span> <span class="quoted"><span class="free">get_component</span></span>
  <span class="quoted"><span class="free">is_strongly_dom_component_safe</span></span> <span class="quoted"><span class="free">is_weakly_dom_component_safe</span></span> <span class="quoted"><span class="free">get_root_node</span></span> <span class="quoted"><span class="free">get_root_node_locs</span></span>
  <span class="quoted"><span class="free">get_ancestors</span></span> <span class="quoted"><span class="free">get_ancestors_locs</span></span> <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">get_element_by_id</span></span>
  <span class="quoted"><span class="free">get_elements_by_class_name</span></span> <span class="quoted"><span class="free">get_elements_by_tag_name</span></span> <span class="main">+</span>
  l_create_element<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">set_disconnected_nodes</span></span>
  <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">set_tag_name</span></span> <span class="quoted"><span class="free">set_tag_name_locs</span></span> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">create_element</span></span> <span class="quoted"><span class="free">known_ptr</span></span> <span class="main">+</span>
  l_get_disconnected_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="main">+</span>
  l_set_disconnected_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_disconnected_nodes</span></span> <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span> <span class="main">+</span>
  l_set_tag_name<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_tag_name</span></span> <span class="quoted"><span class="free">set_tag_name_locs</span></span> <span class="main">+</span>
  l_new_element_get_child_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">known_ptr</span></span> <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span> <span class="main">+</span>
  l_new_element_get_disconnected_nodes <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="main">+</span>
  l_set_tag_name_get_child_nodes <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_tag_name</span></span> <span class="quoted"><span class="free">set_tag_name_locs</span></span> <span class="quoted"><span class="free">known_ptr</span></span>
  <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span> <span class="main">+</span>
  l_set_tag_name_get_disconnected_nodes <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_tag_name</span></span> <span class="quoted"><span class="free">set_tag_name_locs</span></span>
  <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="main">+</span>
  l_set_disconnected_nodes <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_disconnected_nodes</span></span> <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span> <span class="main">+</span>
  l_set_disconnected_nodes_get_child_nodes <span class="quoted"><span class="free">set_disconnected_nodes</span></span> <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span>
  <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span> <span class="main">+</span>
  l_set_disconnected_nodes_get_disconnected_nodes  <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">get_disconnected_nodes</span></span>
  <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">set_disconnected_nodes</span></span> <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span> <span class="main">+</span>
  l_new_element <span class="quoted"><span class="free">type_wf</span></span> <span class="main">+</span>
  l_create_element_wf<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>  <span class="quoted"><span class="free">known_ptr</span></span> <span class="quoted"><span class="free">known_ptrs</span></span> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span>
  <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">heap_is_wellformed</span></span> <span class="quoted"><span class="free">parent_child_rel</span></span> <span class="quoted"><span class="free">set_tag_name</span></span>
  <span class="quoted"><span class="free">set_tag_name_locs</span></span> <span class="quoted"><span class="free">set_disconnected_nodes</span></span> <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span>
  <span class="quoted"><span class="free">create_element</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">known_ptr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_::</span>linorder<span class="main">)</span> object_ptr <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_is_wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">parent_child_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> object_ptr <span class="main">×</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">type_wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">known_ptrs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">to_tree_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_parent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> node_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_parent_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_child_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> node_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_child_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_strongly_dom_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_weakly_dom_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_ancestors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_ancestors_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_element_by_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_elements_by_class_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_elements_by_tag_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_disconnected_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> node_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_disconnected_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_disconnected_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(_)</span> node_ptr list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_disconnected_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_tag_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_tag_name_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">create_element</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr<span class="main">)</span> prog"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-create_element_is_weakly_dom_component_safe_step"><span class="command">lemma</span></span> create_element_is_weakly_dom_component_safe_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">≠</span> cast <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">new_element_ptr</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">h3</span></span> <span class="skolem"><span class="skolem">disc_nodes</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    new_element_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new_element <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new_element <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span><span class="free">set_tag_name</span> <span class="skolem">new_element_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    disc_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">disc_nodes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">set_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="main">(</span>cast <span class="skolem">new_element_ptr</span> <span class="main">#</span> <span class="skolem">disc_nodes</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_element_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
        bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_disconnected_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_element_ptr h2 h3 disc_nodes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_element_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_I
        bind_pure_returns_result_I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_disconnected_nodes_pure<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_I is_OK_returns_result_E old.unit.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_I is_OK_returns_result_E old.unit.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h2 new_element_ptr
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> new_element_get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> new_element_ptr assms<span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h2</span> <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_tag_name_writes h3
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_tag_name_locs_impl a_set_tag_name_locs_def all_args_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span>
        get_M_Element_preserved8 select_result_I2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> create_element_document_in_heap
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">≠</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> local.get_component_ok local.get_dom_component_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h3</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_disconnected_nodes_writes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_disconnected_nodes_locs_def all_args_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">≠</span> cast<span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">document_ptr</span>›</span></span> get_M_Mdocument_preserved3<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h2</span> <span class="skolem">h3</span>›</span></span>
      <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h3</span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preserved_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Core_DOM_Components-create_element_is_weakly_dom_component_safe"><span class="command">lemma</span></span> create_element_is_weakly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">result</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_weakly_dom_component_safe</span> <span class="main">{</span>cast <span class="free">document_ptr</span><span class="main">}</span> <span class="main">{</span>cast <span class="free">result</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">new_element_ptr</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">h3</span></span> <span class="skolem"><span class="skolem">disc_nodes_h3</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    new_element_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new_element <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new_element <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">set_tag_name</span> <span class="skolem">new_element_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    disc_nodes_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">disc_nodes_h3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">set_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="main">(</span>cast <span class="skolem">new_element_ptr</span> <span class="main">#</span> <span class="skolem">disc_nodes_h3</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_element_def returns_result_heap_def
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
        bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_disconnected_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_element_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_I<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_I is_OK_returns_result_E old.unit.exhaust<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_E is_OK_returns_result_I local.get_disconnected_nodes_pure
        pure_returns_heap_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_I is_OK_returns_result_E old.unit.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> returns_result_heap_def<span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">new_element_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> element_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_element_ptr ElementMonad.ptr_kinds_ptr_kinds_M h2
    <span class="keyword1"><span class="command">using</span></span> new_element_ptr_not_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="skolem">new_element_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> node_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="skolem">new_element_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> object_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> object_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span>cast <span class="skolem">new_element_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_element_new_ptr h2 new_element_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> node_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span>cast <span class="skolem">new_element_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> element_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"element_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> element_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span><span class="skolem">new_element_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> element_ptr_kinds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> character_data_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"character_data_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> character_data_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def character_data_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> writes_small_big<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">h</span></span> <span class="bound"><span class="bound">h'</span></span><span class="main"><span class="main">.</span></span> object_ptr_kinds <span class="bound"><span class="bound">h'</span></span> <span class="main"><span class="main">=</span></span> object_ptr_kinds <span class="bound"><span class="bound">h</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> set_tag_name_writes h3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> set_tag_name_pointers_preserved
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> document_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> node_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="free">h'</span> <span class="main">=</span> object_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> writes_small_big<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">h</span></span> <span class="bound"><span class="bound">h'</span></span><span class="main"><span class="main">.</span></span> object_ptr_kinds <span class="bound"><span class="bound">h'</span></span> <span class="main"><span class="main">=</span></span> object_ptr_kinds <span class="bound"><span class="bound">h</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> set_disconnected_nodes_writes h'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> set_disconnected_nodes_pointers_preserved
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="free">h'</span> <span class="main">=</span> document_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="free">h'</span> <span class="main">=</span> node_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h3
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptr</span> <span class="main">(</span>cast <span class="skolem">new_element_ptr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>›</span></span> local.create_element_known_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> known_ptrs_new_ptr object_ptr_kinds_eq_h <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h</span>›</span></span> h2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> known_ptrs_preserved object_ptr_kinds_eq_h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> known_ptrs_preserved object_ptr_kinds_eq_h3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disc_nodes_h3 document_ptr_kinds_eq_h object_ptr_kinds_eq_h2
      get_disconnected_nodes_ptr_in_heap <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> document_ptr_kinds_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_result_I<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> children_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">ptr'</span><span class="main">::</span><span class="main">(_)</span> object_ptr<span class="main">)</span> <span class="bound">children</span><span class="main">.</span> <span class="bound">ptr'</span> <span class="main">≠</span> cast <span class="skolem">new_element_ptr</span>
              <span class="main">⟹</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span> <span class="main">=</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_child_nodes_reads h2 get_child_nodes_new_element<span class="main">[</span><span class="operator">rotated</span><span class="main">,</span> <span class="operator">OF</span> new_element_ptr h2<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reads_def reflp_def transp_def preserved_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> children_eq2_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span><span class="main">.</span> <span class="bound">ptr'</span> <span class="main">≠</span> cast <span class="skolem">new_element_ptr</span>
                                    <span class="main">⟹</span> <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">new_element_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_element_ptr h2 new_element_ptr_in_heap<span class="main">[</span><span class="operator">OF</span> h2 new_element_ptr<span class="main">]</span>
      new_element_is_element_ptr<span class="main">[</span><span class="operator">OF</span> new_element_ptr<span class="main">]</span> new_element_no_child_nodes
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span> <span class="bound">disc_nodes</span><span class="main">.</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>
                                             <span class="main">=</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_disconnected_nodes_reads h2 get_disconnected_nodes_new_element<span class="main">[</span><span class="operator">OF</span> new_element_ptr h2<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reads_def reflp_def transp_def preserved_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq2_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span><span class="main">.</span> <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> children_eq_h2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span> <span class="bound">children</span><span class="main">.</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span> <span class="main">=</span> <span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_child_nodes_reads set_tag_name_writes h3
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_tag_name_get_child_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> children_eq2_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span><span class="main">.</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq_h2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span> <span class="bound">disc_nodes</span><span class="main">.</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>
                                               <span class="main">=</span> <span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_disconnected_nodes_reads set_tag_name_writes h3
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_tag_name_get_disconnected_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq2_h2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span><span class="main">.</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> new_element_types_preserved h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> writes_small_big<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="free">type_wf</span> <span class="bound">h</span> <span class="main">⟶</span> <span class="free">type_wf</span> <span class="bound">h'</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> set_tag_name_writes h3<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span>  set_tag_name_types_preserved
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> writes_small_big<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="free">type_wf</span> <span class="bound">h</span> <span class="main">⟶</span> <span class="free">type_wf</span> <span class="bound">h'</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> set_disconnected_nodes_writes h'<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span>  set_disconnected_nodes_types_preserved
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> children_eq_h3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span> <span class="bound">children</span><span class="main">.</span> <span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span> <span class="main">=</span> <span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_child_nodes_reads set_disconnected_nodes_writes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_disconnected_nodes_get_child_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> children_eq2_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span><span class="main">.</span> <span class="main">|</span><span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq_h3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span> <span class="bound">disc_nodes</span><span class="main">.</span> <span class="free">document_ptr</span> <span class="main">≠</span> <span class="bound">doc_ptr</span>
       <span class="main">⟹</span> <span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>
                                               <span class="main">=</span> <span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_disconnected_nodes_reads set_disconnected_nodes_writes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_disconnected_nodes_get_disconnected_nodes_different_pointers<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq2_h3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span><span class="main">.</span> <span class="free">document_ptr</span> <span class="main">≠</span> <span class="bound">doc_ptr</span>
                <span class="main">⟹</span> <span class="main">|</span><span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> disc_nodes_document_ptr_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">disc_nodes_h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disconnected_nodes_eq_h2 disc_nodes_h3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disc_nodes_document_ptr_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">disc_nodes_h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disconnected_nodes_eq_h <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="skolem">new_element_ptr</span> <span class="main">∉</span> set <span class="skolem">disc_nodes_h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="free">h</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_element_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> node_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span>
      a_all_ptrs_in_heap_def heap_is_wellformed_def
    <span class="keyword1"><span class="command">using</span></span> NodeMonad.ptr_kinds_ptr_kinds_M local.heap_is_wellformed_disc_nodes_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">parent_child_rel</span> <span class="free">h</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="free">h'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">parent_child_rel</span> <span class="free">h</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parent_child_rel_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> object_ptr_kinds_eq_h<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ObjectMonad.ptr_kinds_ptr_kinds_M
            <span class="quoted"><span class="quoted">‹cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_element_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> object_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span> children_eq2_h<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_element_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_element_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>›</span></span>
            children_eq2_h empty_iff empty_set image_eqI select_result_I2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="skolem">h3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parent_child_rel_def object_ptr_kinds_eq_h2 children_eq2_h2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="free">h'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parent_child_rel_def object_ptr_kinds_eq_h3 children_eq2_h3<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> cast <span class="free">document_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>›</span></span> local.get_root_node_not_node_same<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> root'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> cast <span class="free">document_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>›</span></span> document_ptr_kinds_eq_h
        local.get_root_node_not_node_same object_ptr_kinds_eq_h2 object_ptr_kinds_eq_h3<span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> create_element_preserves_wellformedness assms returns_result_heap_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">|∉|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast <span class="skolem">new_element_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> object_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span> returns_result_heap_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> ObjectMonad.ptr_kinds_ptr_kinds_M
        <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> returns_result_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span> to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        document_ptr_kinds_commutes is_OK_returns_result_E local.to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> a_get_component <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> root
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_get_component_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="free">h'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h'</span>›</span></span> is_OK_returns_result_E
        local.get_root_node_root_in_heap local.to_tree_order_ok root'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">⊢</span> a_get_component <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> root'
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_get_component_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">child</span><span class="main">.</span> <span class="bound">child</span> <span class="main">∈</span> set <span class="skolem">to</span> <span class="main">⟷</span> <span class="bound">child</span> <span class="main">∈</span> set <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="free">h'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">parent_child_rel</span> <span class="free">h</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="free">h'</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.to_tree_order_parent_child_rel to to'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> local.a_get_component <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> set <span class="main">|</span><span class="free">h'</span> <span class="main">⊢</span> local.a_get_component <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_get_component_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weakly_dom_component_safe_def Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_element_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        children_eq_h local.get_child_nodes_ok local.get_child_nodes_ptr_in_heap local.known_ptrs_known_ptr
        object_ptr_kinds_eq_h2 object_ptr_kinds_eq_h3 returns_result_select_result<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span>
        element_ptr_kinds_commutes h2 new_element_ptr new_element_ptr_in_heap node_ptr_kinds_eq_h2
        node_ptr_kinds_eq_h3 returns_result_eq returns_result_heap_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">result</span> <span class="main">|∉|</span> object_ptr_kinds <span class="free">h</span>›</span></span> element_ptr_kinds_commutes
      node_ptr_kinds_commutes <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> create_element_is_weakly_dom_component_safe_step<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.get_component_impl<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_element_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> object_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_element</span> <span class="free">document_ptr</span> <span class="free">tag</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_element_ptr</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_create_element<span class="main">?</span><span class="main">:</span> l_get_component_create_element<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">known_ptr</span> <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span> <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">get_disconnected_nodes</span>
  <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">set_disconnected_nodes</span> <span class="quoted">set_disconnected_nodes_locs</span> <span class="quoted">set_tag_name</span>
  <span class="quoted">set_tag_name_locs</span> <span class="quoted">create_element</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_create_element<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_create_element<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹create\_character\_data›</span></span>

<span class="keyword1" id="Core_DOM_Components-create_character_data_not_strongly_component_safe"><span class="command">lemma</span></span> create_character_data_not_strongly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">document_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">new_character_data_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">val</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> create_character_data <span class="free">document_ptr</span> <span class="free">val</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">new_character_data_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">{</span>cast <span class="free">document_ptr</span><span class="main">}</span> <span class="main">{</span>cast <span class="free">new_character_data_ptr</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"create_document"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?document_ptr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> document_ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?document_ptr</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_create_character_data<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">heap_is_wellformed</span></span> <span class="quoted"><span class="free">parent_child_rel</span></span> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">known_ptr</span></span> <span class="quoted"><span class="free">known_ptrs</span></span> <span class="quoted"><span class="free">to_tree_order</span></span>
  <span class="quoted"><span class="free">get_parent</span></span> <span class="quoted"><span class="free">get_parent_locs</span></span> <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span> <span class="quoted"><span class="free">get_component</span></span>
  <span class="quoted"><span class="free">is_strongly_dom_component_safe</span></span> <span class="quoted"><span class="free">is_weakly_dom_component_safe</span></span> <span class="quoted"><span class="free">get_root_node</span></span> <span class="quoted"><span class="free">get_root_node_locs</span></span>
  <span class="quoted"><span class="free">get_ancestors</span></span> <span class="quoted"><span class="free">get_ancestors_locs</span></span> <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">get_element_by_id</span></span>
  <span class="quoted"><span class="free">get_elements_by_class_name</span></span> <span class="quoted"><span class="free">get_elements_by_tag_name</span></span> <span class="main">+</span>
  l_create_character_data<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">set_disconnected_nodes</span></span>
  <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">set_val</span></span> <span class="quoted"><span class="free">set_val_locs</span></span>  <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">create_character_data</span></span> <span class="quoted"><span class="free">known_ptr</span></span> <span class="main">+</span>
  l_get_disconnected_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="main">+</span>
  l_set_disconnected_nodes<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_disconnected_nodes</span></span> <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span> <span class="main">+</span>
  l_set_val<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_val</span></span> <span class="quoted"><span class="free">set_val_locs</span></span> <span class="main">+</span>
  l_create_character_data_wf<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">known_ptr</span></span> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span>
  <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">heap_is_wellformed</span></span> <span class="quoted"><span class="free">parent_child_rel</span></span> <span class="quoted"><span class="free">set_val</span></span>
  <span class="quoted"><span class="free">set_val_locs</span></span> <span class="quoted"><span class="free">set_disconnected_nodes</span></span> <span class="quoted"><span class="free">set_disconnected_nodes_locs</span></span>
  <span class="quoted"><span class="free">create_character_data</span></span> <span class="quoted"><span class="free">known_ptrs</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">known_ptr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_::</span>linorder<span class="main">)</span> object_ptr <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_is_wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">parent_child_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> object_ptr <span class="main">×</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">type_wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">known_ptrs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">to_tree_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_parent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> node_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_parent_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_child_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> node_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_child_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_strongly_dom_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_weakly_dom_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_ancestors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_ancestors_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_element_by_id</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_elements_by_class_name</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_elements_by_tag_name</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> character_data_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_val_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> character_data_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_disconnected_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> node_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_disconnected_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_disconnected_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(_)</span> node_ptr list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_disconnected_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">create_character_data</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> character_data_ptr<span class="main">)</span> prog"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-create_character_data_is_weakly_dom_component_safe_step"><span class="command">lemma</span></span> create_character_data_is_weakly_dom_component_safe_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">≠</span> cast <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">new_character_data_ptr</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">h3</span></span> <span class="skolem"><span class="skolem">disc_nodes</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    new_character_data_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new_character_data <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new_character_data <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">set_val</span> <span class="skolem">new_character_data_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    disc_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">disc_nodes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">set_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="main">(</span>cast <span class="skolem">new_character_data_ptr</span> <span class="main">#</span> <span class="skolem">disc_nodes</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_character_data_def
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_disconnected_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_character_data_ptr h2 h3 disc_nodes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_character_data_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_I bind_pure_returns_result_I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_disconnected_nodes_pure<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_I is_OK_returns_result_E old.unit.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_I is_OK_returns_result_E old.unit.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h2 new_character_data_ptr
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> new_character_data_get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> new_character_data_ptr assms<span class="main">(</span>6<span class="main">)</span>
      <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h2</span> <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_val_writes h3
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_val_locs_impl a_set_val_locs_def all_args_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> CharacterData_simp11
        <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span>
        is_OK_returns_heap_I is_OK_returns_result_E returns_result_eq select_result_I2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> create_character_data_document_in_heap
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">≠</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> local.get_component_ok local.get_dom_component_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h3</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_disconnected_nodes_writes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_disconnected_nodes_locs_def all_args_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">≠</span> cast<span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">document_ptr</span>›</span></span> get_M_Mdocument_preserved3<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h2</span> <span class="skolem">h3</span>›</span></span>
      <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h3</span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preserved_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Core_DOM_Components-create_character_data_is_weakly_dom_component_safe"><span class="command">lemma</span></span> create_character_data_is_weakly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">result</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_weakly_dom_component_safe</span> <span class="main">{</span>cast <span class="free">document_ptr</span><span class="main">}</span> <span class="main">{</span>cast <span class="free">result</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">new_character_data_ptr</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">h3</span></span> <span class="skolem"><span class="skolem">disc_nodes_h3</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    new_character_data_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new_character_data <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new_character_data <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">set_val</span> <span class="skolem">new_character_data_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    disc_nodes_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">disc_nodes_h3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">set_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="main">(</span>cast <span class="skolem">new_character_data_ptr</span> <span class="main">#</span> <span class="skolem">disc_nodes_h3</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_character_data_def
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
        bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_disconnected_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_character_data_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_I<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_I is_OK_returns_result_E old.unit.exhaust<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_E is_OK_returns_result_I local.get_disconnected_nodes_pure
        pure_returns_heap_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_heap_I is_OK_returns_result_E old.unit.exhaust<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> character_data_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_character_data_ptr CharacterDataMonad.ptr_kinds_ptr_kinds_M h2
    <span class="keyword1"><span class="command">using</span></span> new_character_data_ptr_not_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> node_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> object_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>



  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> object_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span>cast <span class="skolem">new_character_data_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_character_data_new_ptr h2 new_character_data_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> node_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span>cast <span class="skolem">new_character_data_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> character_data_ptr_kinds_eq_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"character_data_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> character_data_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span><span class="skolem">new_character_data_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> character_data_ptr_kinds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> element_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"element_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> element_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def element_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> writes_small_big<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">h</span></span> <span class="bound"><span class="bound">h'</span></span><span class="main"><span class="main">.</span></span> object_ptr_kinds <span class="bound"><span class="bound">h'</span></span> <span class="main"><span class="main">=</span></span> object_ptr_kinds <span class="bound"><span class="bound">h</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> set_val_writes h3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> set_val_pointers_preserved
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> document_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> node_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="free">h'</span> <span class="main">=</span> object_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> writes_small_big<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">h</span></span> <span class="bound"><span class="bound">h'</span></span><span class="main"><span class="main">.</span></span> object_ptr_kinds <span class="bound"><span class="bound">h'</span></span> <span class="main"><span class="main">=</span></span> object_ptr_kinds <span class="bound"><span class="bound">h</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> set_disconnected_nodes_writes h'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> set_disconnected_nodes_pointers_preserved
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="free">h'</span> <span class="main">=</span> document_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="free">h'</span> <span class="main">=</span> node_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h3
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disc_nodes_h3 document_ptr_kinds_eq_h object_ptr_kinds_eq_h2
      get_disconnected_nodes_ptr_in_heap <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> document_ptr_kinds_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_result_I<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> children_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">ptr'</span><span class="main">::</span><span class="main">(_)</span> object_ptr<span class="main">)</span> <span class="bound">children</span><span class="main">.</span> <span class="bound">ptr'</span> <span class="main">≠</span> cast <span class="skolem">new_character_data_ptr</span>
                  <span class="main">⟹</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span> <span class="main">=</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_child_nodes_reads h2 get_child_nodes_new_character_data<span class="main">[</span><span class="operator">rotated</span><span class="main">,</span> <span class="operator">OF</span> new_character_data_ptr h2<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reads_def reflp_def transp_def preserved_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> children_eq2_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span><span class="main">.</span> <span class="bound">ptr'</span> <span class="main">≠</span> cast <span class="skolem">new_character_data_ptr</span>
      <span class="main">⟹</span> <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> object_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span>cast <span class="skolem">new_character_data_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_character_data_new_ptr h2 new_character_data_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> node_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span>cast <span class="skolem">new_character_data_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> character_data_ptr_kinds_eq_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"character_data_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> character_data_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span><span class="skolem">new_character_data_ptr</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> character_data_ptr_kinds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> element_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"element_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> element_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def element_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="skolem">h2</span> <span class="main">=</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> writes_small_big<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">h</span></span> <span class="bound"><span class="bound">h'</span></span><span class="main"><span class="main">.</span></span> object_ptr_kinds <span class="bound"><span class="bound">h'</span></span> <span class="main"><span class="main">=</span></span> object_ptr_kinds <span class="bound"><span class="bound">h</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> set_val_writes h3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> set_val_pointers_preserved
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> document_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="skolem">h3</span> <span class="main">=</span> node_ptr_kinds <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> object_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="free">h'</span> <span class="main">=</span> object_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> writes_small_big<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">h</span></span> <span class="bound"><span class="bound">h'</span></span><span class="main"><span class="main">.</span></span> object_ptr_kinds <span class="bound"><span class="bound">h'</span></span> <span class="main"><span class="main">=</span></span> object_ptr_kinds <span class="bound"><span class="bound">h</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> set_disconnected_nodes_writes h'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> set_disconnected_nodes_pointers_preserved
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> document_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"document_ptr_kinds <span class="free">h'</span> <span class="main">=</span> document_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> document_ptr_kinds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> node_ptr_kinds_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"node_ptr_kinds <span class="free">h'</span> <span class="main">=</span> node_ptr_kinds <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h3
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_ptr_kinds_def<span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disc_nodes_h3 document_ptr_kinds_eq_h object_ptr_kinds_eq_h2
      get_disconnected_nodes_ptr_in_heap <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> document_ptr_kinds_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_OK_returns_result_I<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> children_eq_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">ptr'</span><span class="main">::</span><span class="main">(_)</span> object_ptr<span class="main">)</span> <span class="bound">children</span><span class="main">.</span> <span class="bound">ptr'</span> <span class="main">≠</span> cast <span class="skolem">new_character_data_ptr</span>
                <span class="main">⟹</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span> <span class="main">=</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_child_nodes_reads h2
      get_child_nodes_new_character_data<span class="main">[</span><span class="operator">rotated</span><span class="main">,</span> <span class="operator">OF</span> new_character_data_ptr h2<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reads_def reflp_def transp_def preserved_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> children_eq2_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span><span class="main">.</span> <span class="bound">ptr'</span> <span class="main">≠</span> cast <span class="skolem">new_character_data_ptr</span>
                                 <span class="main">⟹</span> <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">new_character_data_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_character_data_ptr h2 new_character_data_ptr_in_heap<span class="main">[</span><span class="operator">OF</span> h2 new_character_data_ptr<span class="main">]</span>
      new_character_data_is_character_data_ptr<span class="main">[</span><span class="operator">OF</span> new_character_data_ptr<span class="main">]</span>
      new_character_data_no_child_nodes
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span> <span class="bound">disc_nodes</span><span class="main">.</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>
                                             <span class="main">=</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_disconnected_nodes_reads h2
      get_disconnected_nodes_new_character_data<span class="main">[</span><span class="operator">OF</span> new_character_data_ptr h2<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reads_def reflp_def transp_def preserved_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq2_h<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span><span class="main">.</span> <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> children_eq_h2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span> <span class="bound">children</span><span class="main">.</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span> <span class="main">=</span> <span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_child_nodes_reads set_val_writes h3
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_val_get_child_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> children_eq2_h2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span><span class="main">.</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq_h2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span> <span class="bound">disc_nodes</span><span class="main">.</span> <span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>
                                              <span class="main">=</span> <span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_disconnected_nodes_reads set_val_writes h3
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_val_get_disconnected_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq2_h2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span><span class="main">.</span> <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h</span>›</span></span> new_character_data_types_preserved h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> writes_small_big<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="free">type_wf</span> <span class="bound">h</span> <span class="main">⟶</span> <span class="free">type_wf</span> <span class="bound">h'</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> set_val_writes h3<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span>  set_val_types_preserved
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> writes_small_big<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="free">type_wf</span> <span class="bound">h</span> <span class="main">⟶</span> <span class="free">type_wf</span> <span class="bound">h'</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> set_disconnected_nodes_writes h'<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span>  set_disconnected_nodes_types_preserved
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def transp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> children_eq_h3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ptr'</span> <span class="bound">children</span><span class="main">.</span> <span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span> <span class="main">=</span> <span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">children</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_child_nodes_reads set_disconnected_nodes_writes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_disconnected_nodes_get_child_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> children_eq2_h3<span class="main">:</span>
    <span class="quoted"><span class="quoted">" <span class="main">⋀</span><span class="bound">ptr'</span><span class="main">.</span> <span class="main">|</span><span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="bound">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span> <span class="bound">disc_nodes</span><span class="main">.</span> <span class="free">document_ptr</span> <span class="main">≠</span> <span class="bound">doc_ptr</span>
    <span class="main">⟹</span> <span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>
                            <span class="main">=</span> <span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">disc_nodes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_disconnected_nodes_reads set_disconnected_nodes_writes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_disconnected_nodes_get_disconnected_nodes_different_pointers<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disconnected_nodes_eq2_h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">doc_ptr</span><span class="main">.</span> <span class="free">document_ptr</span> <span class="main">≠</span> <span class="bound">doc_ptr</span>
             <span class="main">⟹</span> <span class="main">|</span><span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">|</span><span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="bound">doc_ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select_result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> disc_nodes_document_ptr_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">disc_nodes_h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disconnected_nodes_eq_h2 disc_nodes_h3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disc_nodes_document_ptr_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_disconnected_nodes</span> <span class="free">document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">disc_nodes_h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disconnected_nodes_eq_h <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="skolem">disc_nodes_h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="free">h</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast <span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> node_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span>
      a_all_ptrs_in_heap_def heap_is_wellformed_def
    <span class="keyword1"><span class="command">using</span></span> NodeMonad.ptr_kinds_ptr_kinds_M local.heap_is_wellformed_disc_nodes_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">parent_child_rel</span> <span class="free">h</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="free">h'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">parent_child_rel</span> <span class="free">h</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parent_child_rel_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> object_ptr_kinds_eq_h<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ObjectMonad.ptr_kinds_ptr_kinds_M
            <span class="quoted"><span class="quoted">‹cast <span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> object_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span> children_eq2_h<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> object_ptr_kinds_eq_h <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">new_character_data_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> object_ptr_kinds <span class="skolem">h2</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="skolem">a</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">new_character_data_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>›</span></span>
            children_eq2_h empty_iff empty_set image_eqI select_result_I2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="skolem">h3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parent_child_rel_def object_ptr_kinds_eq_h2 children_eq2_h2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="free">h'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parent_child_rel_def object_ptr_kinds_eq_h3 children_eq2_h3<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> cast <span class="free">document_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>›</span></span> local.get_root_node_not_node_same<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> root'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> cast <span class="free">document_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>›</span></span> document_ptr_kinds_eq_h
        local.get_root_node_not_node_same object_ptr_kinds_eq_h2 object_ptr_kinds_eq_h3<span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> create_character_data_preserves_wellformedness assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">result</span> <span class="main">|∉|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast <span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> object_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> ObjectMonad.ptr_kinds_ptr_kinds_M
        <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> returns_result_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span> to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">document_ptr</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        document_ptr_kinds_commutes is_OK_returns_result_E local.to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> a_get_component <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> root
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_get_component_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="free">h'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h'</span>›</span></span> is_OK_returns_result_E
        local.get_root_node_root_in_heap local.to_tree_order_ok root'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">⊢</span> a_get_component <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> root'
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_get_component_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">child</span><span class="main">.</span> <span class="bound">child</span> <span class="main">∈</span> set <span class="skolem">to</span> <span class="main">⟷</span> <span class="bound">child</span> <span class="main">∈</span> set <span class="skolem">to'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="free">h'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="free">h'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">parent_child_rel</span> <span class="free">h</span> <span class="main">=</span> <span class="free">parent_child_rel</span> <span class="free">h'</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="free">h'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.to_tree_order_parent_child_rel to to'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> local.a_get_component <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span>
set <span class="main">|</span><span class="free">h'</span> <span class="main">⊢</span> local.a_get_component <span class="main">(</span>cast <span class="free">document_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_get_component_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weakly_dom_component_safe_def Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span>  assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> children_eq_h local.get_child_nodes_ok local.get_child_nodes_ptr_in_heap
      local.known_ptrs_known_ptr object_ptr_kinds_eq_h2 object_ptr_kinds_eq_h3 returns_result_select_result
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_character_data_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>›</span></span>
        is_OK_returns_result_I<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span>
        character_data_ptr_kinds_commutes h2 new_character_data_ptr new_character_data_ptr_in_heap
        node_ptr_kinds_eq_h2 node_ptr_kinds_eq_h3 returns_result_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> character_data_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span> returns_result_eq
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">using</span></span>  assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> children_eq_h local.get_child_nodes_ok local.get_child_nodes_ptr_in_heap
      local.known_ptrs_known_ptr object_ptr_kinds_eq_h2 object_ptr_kinds_eq_h3 returns_result_select_result
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> ObjectMonad.ptr_kinds_ptr_kinds_M
        <span class="quoted"><span class="quoted">‹cast<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_character_data_ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> object_ptr_kinds_M<span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_character_data</span> <span class="free">document_ptr</span> <span class="free">text</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_character_data_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span>
        create_character_data_is_weakly_dom_component_safe_step local.get_component_impl select_result_I2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_create_character_data<span class="main">?</span><span class="main">:</span> l_get_component_create_character_data<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">known_ptr</span> <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span> <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">set_val</span> <span class="quoted">set_val_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">set_disconnected_nodes</span> <span class="quoted">set_disconnected_nodes_locs</span>
  <span class="quoted">create_character_data</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_create_character_data<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_create_character_data<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹create\_document›</span></span>

<span class="keyword1" id="Core_DOM_Components-create_document_not_strongly_component_safe"><span class="command">lemma</span></span> create_document_not_strongly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">new_document_ptr</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> create_document <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">new_document_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">{}</span> <span class="main">{</span>cast <span class="free">new_document_ptr</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"create_document"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?document_ptr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_create_document<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">heap_is_wellformed</span></span> <span class="quoted"><span class="free">parent_child_rel</span></span> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">known_ptr</span></span> <span class="quoted"><span class="free">known_ptrs</span></span> <span class="quoted"><span class="free">to_tree_order</span></span>
  <span class="quoted"><span class="free">get_parent</span></span> <span class="quoted"><span class="free">get_parent_locs</span></span> <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span> <span class="quoted"><span class="free">get_component</span></span> <span class="quoted"><span class="free">is_strongly_dom_component_safe</span></span>
  <span class="quoted"><span class="free">is_weakly_dom_component_safe</span></span> <span class="quoted"><span class="free">get_root_node</span></span> <span class="quoted"><span class="free">get_root_node_locs</span></span> <span class="quoted"><span class="free">get_ancestors</span></span> <span class="quoted"><span class="free">get_ancestors_locs</span></span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted"><span class="free">get_element_by_id</span></span> <span class="quoted"><span class="free">get_elements_by_class_name</span></span>
  <span class="quoted"><span class="free">get_elements_by_tag_name</span></span> <span class="main">+</span>
  l_create_document<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">create_document</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">known_ptr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_::</span>linorder<span class="main">)</span> object_ptr <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_is_wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">parent_child_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> object_ptr <span class="main">×</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">type_wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">known_ptrs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">to_tree_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_parent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> node_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_parent_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_child_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> node_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_child_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_strongly_dom_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_weakly_dom_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_ancestors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_ancestors_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_element_by_id</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_elements_by_class_name</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_elements_by_tag_name</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">create_document</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> document_ptr<span class="main">)</span> prog"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Core_DOM_Components-create_document_is_weakly_component_safe_step"><span class="command">lemma</span></span> create_document_is_weakly_component_safe_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_document</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">≠</span> cast <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">create_document</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub> <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_document_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> is_OK_returns_heap_I local.create_document_def new_document_get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub>
      select_result_I<span class="main">)</span>

<span class="keyword1" id="Core_DOM_Components-create_document_is_weakly_component_safe"><span class="command">lemma</span></span> create_document_is_weakly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_document</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">result</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">create_document</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_weakly_dom_component_safe</span> <span class="main">{}</span> <span class="main">{</span>cast <span class="free">result</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"object_ptr_kinds <span class="free">h'</span> <span class="main">=</span> object_ptr_kinds <span class="free">h</span> <span class="main">|∪|</span> <span class="main">{|</span>cast <span class="free">result</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> local.create_document_def new_document_new_ptr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">|∉|</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> local.create_document_def new_document_ptr_not_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weakly_dom_component_safe_def Let_def local.create_document_def
        new_document_ptr_not_in_heap<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">result</span> <span class="main">|∉|</span> document_ptr_kinds <span class="free">h</span>›</span></span> document_ptr_kinds_commutes new_document_get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_create_document<span class="main">?</span><span class="main">:</span> l_get_component_create_document<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">known_ptr</span> <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span> <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">create_document</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_create_document<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_create_document<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹insert\_before›</span></span>

<span class="keyword1" id="Core_DOM_Components-insert_before_not_strongly_dom_component_safe"><span class="command">lemma</span></span> insert_before_not_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">child</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ref</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> insert_before <span class="free">ptr</span> <span class="free">child</span> <span class="free">ref</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">(</span><span class="main">{</span><span class="free">ptr</span><span class="main">,</span> cast <span class="free">child</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>cast <span class="main">`</span> set_option <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
      <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">e1</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>
          child<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e2</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ref<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">None</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Core_DOM_Components-append_child_not_strongly_dom_component_safe"><span class="command">lemma</span></span> append_child_not_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">child</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> append_child <span class="free">ptr</span> <span class="free">child</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">{</span><span class="free">ptr</span><span class="main">,</span> cast <span class="free">child</span><span class="main">}</span> <span class="main">{}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
      <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">e1</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> child<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_owner\_document›</span></span>

<span class="keyword1" id="Core_DOM_Components-get_owner_document_not_strongly_dom_component_safe"><span class="command">lemma</span></span> get_owner_document_not_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">owner_document</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> get_owner_document <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">owner_document</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">{</span><span class="free">ptr</span><span class="main">}</span> <span class="main">{</span>cast <span class="free">owner_document</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">doc</span> <span class="main">←</span> create_document<span class="main">;</span>
    create_element <span class="bound">doc</span> <span class="inner_quoted">''div''</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Shadow_DOM_Components">
<div class="head">
<h1>Theory Shadow_DOM_Components</h1>
</div>
<pre class="source"><span class="comment1">(***********************************************************************************
 * Copyright (c) 2016-2020 The University of Sheffield, UK
 *               2019-2020 University of Exeter, UK
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * SPDX-License-Identifier: BSD-2-Clause
 ***********************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Shadow Root Components›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Shadow_DOM_Components
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Shadow_DOM/Shadow_DOM.html">Shadow_DOM.Shadow_DOM</a>
    <a href="Core_DOM_Components.html">Core_DOM_Components</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_component›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_defs <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">to_tree_order</span>
  <span class="keyword2"><span class="keyword">defines</span></span> get_component <span class="main">=</span> <span class="quoted">a_get_component</span>
    <span class="keyword2"><span class="keyword">and</span></span> is_strongly_dom_component_safe <span class="main">=</span> <span class="quoted">a_is_strongly_dom_component_safe</span>
    <span class="keyword2"><span class="keyword">and</span></span> is_weakly_dom_component_safe <span class="main">=</span> <span class="quoted">a_is_weakly_dom_component_safe</span>
  <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component<span class="main">?</span><span class="main">:</span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms_def get_component_def
      is_strongly_dom_component_safe_def is_weakly_dom_component_safe_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹attach\_shadow\_root›</span></span>

<span class="keyword1" id="Shadow_DOM_Components-attach_shadow_root_not_strongly_component_safe"><span class="command">lemma</span></span> attach_shadow_root_not_strongly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'ShadowRoot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">h'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">host</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">new_shadow_root_ptr</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> attach_shadow_root <span class="free">host</span> <span class="free">m</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">new_shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_strongly_dom_component_safe <span class="main">{</span>cast <span class="free">host</span><span class="main">}</span> <span class="main">{</span>cast <span class="free">new_shadow_root_ptr</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'ShadowRoot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">doc</span> <span class="main">←</span> create_document<span class="main">;</span>
    create_element <span class="bound">doc</span> <span class="inner_quoted">''div''</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> host<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?e1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_dom_component_attach_shadow_root<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">heap_is_wellformed</span></span> <span class="quoted"><span class="free">parent_child_rel</span></span> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">known_ptr</span></span> <span class="quoted"><span class="free">known_ptrs</span></span> <span class="quoted"><span class="free">to_tree_order</span></span>
  <span class="quoted"><span class="free">get_parent</span></span> <span class="quoted"><span class="free">get_parent_locs</span></span> <span class="quoted"><span class="free">get_child_nodes</span></span> <span class="quoted"><span class="free">get_child_nodes_locs</span></span> <span class="quoted"><span class="free">get_dom_component</span></span>
  <span class="quoted"><span class="free">is_strongly_component_safe</span></span> <span class="quoted"><span class="free">is_weakly_component_safe</span></span> <span class="quoted"><span class="free">get_root_node</span></span> <span class="quoted"><span class="free">get_root_node_locs</span></span> <span class="quoted"><span class="free">get_ancestors</span></span>
  <span class="quoted"><span class="free">get_ancestors_locs</span></span> <span class="quoted"><span class="free">get_disconnected_nodes</span></span> <span class="quoted"><span class="free">get_disconnected_nodes_locs</span></span> <span class="quoted"><span class="free">get_element_by_id</span></span>
  <span class="quoted"><span class="free">get_elements_by_class_name</span></span> <span class="quoted"><span class="free">get_elements_by_tag_name</span></span> <span class="main">+</span>
  l_attach_shadow_root<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">known_ptr</span></span> <span class="quoted"><span class="free">set_shadow_root</span></span> <span class="quoted"><span class="free">set_shadow_root_locs</span></span> <span class="quoted"><span class="free">set_mode</span></span> <span class="quoted"><span class="free">set_mode_locs</span></span>
  <span class="quoted"><span class="free">attach_shadow_root</span></span> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">get_tag_name</span></span> <span class="quoted"><span class="free">get_tag_name_locs</span></span> <span class="quoted"><span class="free">get_shadow_root</span></span> <span class="quoted"><span class="free">get_shadow_root_locs</span></span> <span class="main">+</span>
  l_set_mode<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_mode</span></span> <span class="quoted"><span class="free">set_mode_locs</span></span> <span class="main">+</span>
  l_set_shadow_root<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quoted"><span class="free">type_wf</span></span> <span class="quoted"><span class="free">set_shadow_root</span></span> <span class="quoted"><span class="free">set_shadow_root_locs</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">known_ptr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_::</span>linorder<span class="main">)</span> object_ptr <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_is_wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">parent_child_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> object_ptr <span class="main">×</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">type_wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">known_ptrs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">to_tree_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_parent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> node_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_parent_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_child_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> node_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_child_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_dom_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_root_node_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_ancestors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> object_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_ancestors_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_element_by_id</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_elements_by_class_name</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_elements_by_tag_name</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr <span class="main">⇒</span> char list <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> element_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_shadow_root</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> <span class="main">(_)</span> shadow_root_ptr option <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_shadow_root_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_mode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> shadow_root_ptr <span class="main">⇒</span> shadow_root_mode <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_mode_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> shadow_root_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> unit<span class="main">)</span> prog set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">attach_shadow_root</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> shadow_root_mode <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> shadow_root_ptr<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_disconnected_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> node_ptr list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_disconnected_nodes_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> document_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_strongly_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_weakly_component_safe</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> object_ptr set <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_tag_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> char list<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_tag_name_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_shadow_root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap<span class="main">,</span> exception<span class="main">,</span> <span class="main">(_)</span> shadow_root_ptr option<span class="main">)</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">get_shadow_root_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> element_ptr <span class="main">⇒</span> <span class="main">(</span><span class="main">(_)</span> heap <span class="main">⇒</span> <span class="main">(_)</span> heap <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Shadow_DOM_Components-attach_shadow_root_is_weakly_dom_component_safe"><span class="command">lemma</span></span> attach_shadow_root_is_weakly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">attach_shadow_root</span> <span class="free">element_ptr</span> <span class="free">shadow_root_mode</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">≠</span> cast <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">attach_shadow_root</span> <span class="free">element_ptr</span> <span class="free">shadow_root_mode</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_dom_component</span> <span class="main">(</span>cast <span class="free">element_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub> <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">h3</span></span> <span class="skolem"><span class="skolem">new_shadow_root_ptr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>R</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub>_M <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    new_shadow_root_ptr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> new<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>R</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub>_M <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_shadow_root_ptr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">set_mode</span> <span class="skolem">new_shadow_root_ptr</span> <span class="free">shadow_root_mode</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">⊢</span> <span class="free">set_shadow_root</span> <span class="free">element_ptr</span> <span class="main">(</span>Some <span class="skolem">new_shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_shadow_root_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  bind_returns_heap_E
        bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_tag_name_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
        bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_shadow_root_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">attach_shadow_root</span> <span class="free">element_ptr</span> <span class="free">shadow_root_mode</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_shadow_root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_shadow_root_ptr h2 h3 h'
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_shadow_root_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_I
        bind_pure_returns_result_I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_tag_name_pure<span class="main"><span class="main">]</span></span> bind_pure_returns_result_I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_shadow_root_pure<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_tag_name_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
        bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_shadow_root_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub> <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h2 new_shadow_root_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span>
        <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">attach_shadow_root</span> <span class="free">element_ptr</span> <span class="free">shadow_root_mode</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_shadow_root_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span>
        new_shadow_root_get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub> select_result_I2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">≠</span> cast <span class="skolem">new_shadow_root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">attach_shadow_root</span> <span class="free">element_ptr</span> <span class="free">shadow_root_mode</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_shadow_root_ptr</span>›</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub> <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h2</span> <span class="skolem">h3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_mode_writes h3
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_mode_locs_def all_args_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">≠</span> cast<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">new_shadow_root_ptr</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> get_M_Mshadow_root_preserved3<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">element_ptr</span> <span class="main">|∈|</span> element_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">attach_shadow_root</span> <span class="free">element_ptr</span> <span class="free">shadow_root_mode</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">new_shadow_root_ptr</span>›</span></span>
      attach_shadow_root_element_ptr_in_heap
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">≠</span> cast <span class="free">element_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">element_ptr</span> <span class="main">|∈|</span> element_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> element_ptr_kinds_commutes is_OK_returns_result_E get_component_ok local.get_dom_component_ptr
        node_ptr_kinds_commutes select_result_I2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserved <span class="main">(</span>get_M<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub> <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h3</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_shadow_root_writes h'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_preserved2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_shadow_root_locs_def all_args_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">≠</span> cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">element_ptr</span>›</span></span> get_M_Element_preserved8<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="free">h</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h2</span> <span class="skolem">h3</span>›</span></span>
      <span class="quoted"><span class="quoted">‹preserved <span class="main">(</span>get_M <span class="free">ptr</span> <span class="free">getter</span><span class="main">)</span> <span class="skolem">h3</span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preserved_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_dom_component_attach_shadow_root<span class="main">?</span><span class="main">:</span> l_get_dom_component_attach_shadow_root<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">known_ptr</span> <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">type_wf</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_component</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span>
  <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span> <span class="quoted">get_elements_by_tag_name</span>
  <span class="quoted">set_shadow_root</span> <span class="quoted">set_shadow_root_locs</span> <span class="quoted">set_mode</span> <span class="quoted">set_mode_locs</span> <span class="quoted">attach_shadow_root</span> <span class="quoted">get_disconnected_nodes</span>
  <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">is_strongly_dom_component_safe</span> <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_tag_name</span>
  <span class="quoted">get_tag_name_locs</span> <span class="quoted">get_shadow_root</span> <span class="quoted">get_shadow_root_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_dom_component_attach_shadow_root<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_dom_component_attach_shadow_root<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_shadow\_root›</span></span>

<span class="keyword1" id="Shadow_DOM_Components-get_shadow_root_not_weakly_component_safe"><span class="command">lemma</span></span> get_shadow_root_not_weakly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">element_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">shadow_root_ptr_opt</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> get_shadow_root <span class="free">element_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">shadow_root_ptr_opt</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_weakly_dom_component_safe <span class="main">{</span>cast <span class="free">element_ptr</span><span class="main">}</span> <span class="main">(</span>cast <span class="main">`</span> set_option <span class="free">shadow_root_ptr_opt</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
        <span class="bound">html</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''html''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">document_ptr</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">head</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''head''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">head</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">body</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''body''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e2</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e2</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s1</span> <span class="main">←</span> attach_shadow_root <span class="bound">e1</span> Open<span class="main">;</span>
        <span class="bound">e3</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''slot''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e3</span><span class="main">)</span><span class="main">;</span>
        return <span class="bound">e1</span>
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> element_ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?e1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_shadow_root_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_shadow_root <span class="main">+</span>
  l_heap_is_wellformed<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_root_node<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_root_node_wf<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_remove_shadow_root_get_child_nodes
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Shadow_DOM_Components-get_shadow_root_is_component_unsafe"><span class="command">lemma</span></span> get_shadow_root_is_component_unsafe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="free">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">shadow_root_ptr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">host</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∩</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">shadow_root_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">host</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> get_shadow_root_ptr_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">host_c</span></span> <span class="keyword2"><span class="keyword">where</span></span> host_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">host</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">host_c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span>  assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> get_component_ok is_OK_returns_result_E<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">host_root</span></span> <span class="keyword2"><span class="keyword">where</span></span> host_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">host</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">host_root</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bind_returns_heap_E get_component_def host_c is_OK_returns_result_I
        pure_def pure_eq_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">shadow_root_ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_shadow_root_shadow_root_ptr_in_heap assms shadow_root_ptr_kinds_commutes
    <span class="keyword1"><span class="command">using</span></span> document_ptr_kinds_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">shadow_root_ptr_c</span></span> <span class="keyword2"><span class="keyword">where</span></span> shadow_root_ptr_c<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">shadow_root_ptr_c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span>  assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> get_component_ok is_OK_returns_result_E<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast <span class="free">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> cast <span class="free">shadow_root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cast <span class="free">shadow_root_ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_root_node_def get_ancestors_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_returns_result_I
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">host_root</span> <span class="main">≠</span> cast <span class="free">shadow_root_ptr</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">host_root</span> <span class="main">=</span> cast<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">shadow_root_ptr</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cast <span class="free">shadow_root_ptr</span><span class="main">,</span> <span class="skolem">host_root</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">parent_child_rel</span> <span class="free">h</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">host_root</span> <span class="main">=</span> cast<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">shadow_root_ptr</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">host_root</span><span class="main">,</span> cast <span class="free">host</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">parent_child_rel</span> <span class="free">h</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> get_root_node_parent_child_rel host_root assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cast <span class="free">host</span><span class="main">,</span> cast <span class="free">shadow_root_ptr</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>a_host_shadow_root_rel <span class="free">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_host_shadow_root_rel_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> get_shadow_root_ptr_in_heap image_eqI is_OK_returns_result_I
          mem_Collect_eq prod.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> select_result_I2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" acyclic <span class="main">(</span><span class="free">parent_child_rel</span> <span class="free">h</span> <span class="main">∪</span> local.a_host_shadow_root_rel <span class="free">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> heap_is_wellformed_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> local.parent_child_rel_node_ptr
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_iff <span class="quoted"><span class="quoted">‹<span class="skolem">host_root</span> <span class="main">=</span> cast<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">shadow_root_ptr</span>›</span></span>
          acyclic_def in_rtrancl_UnI rtrancl_into_trancl1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">host_c</span> <span class="main">≠</span> <span class="skolem">shadow_root_ptr_c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> cast<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>
<span class="free">shadow_root_ptr</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> get_dom_component_ptr get_component_root_node_same
        host_c host_root local.get_root_node_parent_child_rel local.get_root_node_same_no_parent_parent_child_rel
        rtranclE shadow_root_ptr_c<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">host_c</span> <span class="main">∩</span> set <span class="skolem">shadow_root_ptr_c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms get_dom_component_no_overlap Shadow_DOM.a_heap_is_wellformed_def host_c
      shadow_root_ptr_c
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> host_c shadow_root_ptr_c
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_shadow_root_component<span class="main">?</span><span class="main">:</span> l_get_shadow_root_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">type_wf</span> <span class="quoted">get_shadow_root</span> <span class="quoted">get_shadow_root_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_tag_name</span> <span class="quoted">get_tag_name_locs</span> <span class="quoted">known_ptr</span>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">heap_is_wellformed<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="quoted">get_host</span> <span class="quoted">get_host_locs</span>
  <span class="quoted">get_disconnected_document</span> <span class="quoted">get_disconnected_document_locs</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span>
  <span class="quoted">get_parent_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span> <span class="quoted">is_weakly_dom_component_safe</span>
  <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span> <span class="quoted">get_element_by_id</span>
  <span class="quoted">get_elements_by_class_name</span> <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">remove_shadow_root</span> <span class="quoted">remove_shadow_root_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_shadow_root_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_shadow_root_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_host›</span></span>

<span class="keyword1" id="Shadow_DOM_Components-get_host_not_weakly_component_safe"><span class="command">lemma</span></span> get_host_not_weakly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">shadow_root_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">host</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> get_host <span class="free">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_weakly_dom_component_safe <span class="main">{</span>cast <span class="free">shadow_root_ptr</span><span class="main">}</span> <span class="main">{</span>cast <span class="free">host</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
        <span class="bound">html</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''html''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">document_ptr</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">head</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''head''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">head</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">body</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''body''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e2</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e2</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s1</span> <span class="main">←</span> attach_shadow_root <span class="bound">e1</span> Open<span class="main">;</span>
        <span class="bound">e3</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''slot''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e3</span><span class="main">)</span><span class="main">;</span>
        return <span class="bound">s1</span>
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> shadow_root_ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?s1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_host_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_heap_is_wellformed<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_host <span class="main">+</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>  <span class="main">+</span>
  l_get_shadow_root_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Shadow_DOM_Components-get_host_is_component_unsafe"><span class="command">lemma</span></span> get_host_is_component_unsafe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_host</span> <span class="free">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">host</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">host</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∩</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">shadow_root_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="free">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">shadow_root_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> local.shadow_root_host_dual <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> local.get_shadow_root_is_component_unsafe <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_host_component<span class="main">?</span><span class="main">:</span> l_get_host_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span> <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span>
  <span class="quoted">get_shadow_root</span> <span class="quoted">get_shadow_root_locs</span> <span class="quoted">get_tag_name</span> <span class="quoted">get_tag_name_locs</span> <span class="quoted">known_ptr</span> <span class="quoted">type_wf</span> <span class="quoted">heap_is_wellformed</span>
  <span class="quoted">parent_child_rel</span> <span class="quoted">heap_is_wellformed<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="quoted">get_host</span> <span class="quoted">get_host_locs</span> <span class="quoted">get_disconnected_document</span>
  <span class="quoted">get_disconnected_document_locs</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_parent</span> <span class="quoted">get_parent_locs</span> <span class="quoted">get_component</span>
  <span class="quoted">is_strongly_dom_component_safe</span> <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span>
  <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span> <span class="quoted">get_elements_by_tag_name</span>
  <span class="quoted">remove_shadow_root</span> <span class="quoted">remove_shadow_root_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_host_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_host_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_root\_node\_si›</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_component_get_root_node_si<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_root_node_si_wf<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Shadow_DOM_Components-get_root_node_si_is_component_unsafe"><span class="command">lemma</span></span> get_root_node_si_is_component_unsafe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node_si</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">root</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">root</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∨</span>
set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∩</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">root</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr'</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_ancestors_si_ptr_in_heap assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_root_node_si_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.get_component_ok select_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> get_ancestors_si_ptr assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_root_node_si_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> empty_iff empty_set
        get_ancestors_si_ptrs_in_heap last_in_set<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">root</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.get_component_ok select_result_I<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.get_dom_component_no_overlap
        select_result_I2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> i_get_component_get_root_node_si<span class="main">?</span><span class="main">:</span> l_get_component_get_root_node_si<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">type_wf</span> <span class="quoted">known_ptr</span> <span class="quoted">known_ptrs</span> <span class="quoted">get_parent</span> <span class="quoted">get_parent_locs</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span>
  <span class="quoted">get_host</span> <span class="quoted">get_host_locs</span> <span class="quoted">get_ancestors_si</span> <span class="quoted">get_ancestors_si_locs</span> <span class="quoted">get_root_node_si</span> <span class="quoted">get_root_node_si_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_shadow_root</span> <span class="quoted">get_shadow_root_locs</span> <span class="quoted">get_tag_name</span>
  <span class="quoted">get_tag_name_locs</span> <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">heap_is_wellformed<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="quoted">get_disconnected_document</span>
  <span class="quoted">get_disconnected_document_locs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span>
  <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span>
  <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span> <span class="quoted">get_elements_by_tag_name</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_component_get_root_node_si<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_component_get_root_node_si<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹get\_assigned\_nodes›</span></span>

<span class="keyword1" id="Shadow_DOM_Components-assigned_nodes_not_weakly_component_safe"><span class="command">lemma</span></span> assigned_nodes_not_weakly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">node_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nodes</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> assigned_nodes <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_weakly_dom_component_safe <span class="main">{</span>cast <span class="free">node_ptr</span><span class="main">}</span> <span class="main">(</span>cast <span class="main">`</span> set <span class="free">nodes</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
        <span class="bound">html</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''html''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">document_ptr</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">head</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''head''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">head</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">body</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''body''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e2</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e2</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s1</span> <span class="main">←</span> attach_shadow_root <span class="bound">e1</span> Closed<span class="main">;</span>
        <span class="bound">e3</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''slot''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e3</span><span class="main">)</span><span class="main">;</span>
        return <span class="bound">e3</span>
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> node_ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?e3</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Shadow_DOM_Components-get_composed_root_node_not_weakly_component_safe"><span class="command">lemma</span></span> get_composed_root_node_not_weakly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">root</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> get_root_node_si <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">root</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_weakly_dom_component_safe <span class="main">{</span><span class="free">ptr</span><span class="main">}</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
        <span class="bound">html</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''html''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">document_ptr</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">head</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''head''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">head</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">body</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''body''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e2</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e2</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s1</span> <span class="main">←</span> attach_shadow_root <span class="bound">e1</span> Closed<span class="main">;</span>
        <span class="bound">e3</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''slot''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e3</span><span class="main">)</span><span class="main">;</span>
        return <span class="bound">e3</span>
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e3</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Shadow_DOM_Components-assigned_slot_not_weakly_component_safe"><span class="command">lemma</span></span> assigned_slot_not_weakly_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">node_ptr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">slot_opt</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"heap_is_wellformed <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"type_wf <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"known_ptrs <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> assigned_slot <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">slot_opt</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_weakly_dom_component_safe <span class="main">{</span>cast <span class="free">node_ptr</span><span class="main">}</span> <span class="main">(</span>cast <span class="main">`</span> set_option <span class="free">slot_opt</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Heap fmempty <span class="main">::</span><span class="main">(</span><span class="tfree">'object_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'node_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'element_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'character_data_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'document_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'shadow_root_ptr</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Object</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Node</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Element</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'CharacterData</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'Document</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span>
<span class="tfree">'Shadowroot</span><span class="main">::</span><span class="main">{</span>equal<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> heap"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">document_ptr</span> <span class="main">←</span> create_document<span class="main">;</span>
        <span class="bound">html</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''html''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">document_ptr</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">head</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''head''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">head</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">body</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''body''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">html</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e1</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">body</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e2</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''div''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e2</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s1</span> <span class="main">←</span> attach_shadow_root <span class="bound">e1</span> Open<span class="main">;</span>
        <span class="bound">e3</span> <span class="main">←</span> create_element <span class="bound">document_ptr</span> <span class="inner_quoted">''slot''</span><span class="main">;</span>
        append_child <span class="main">(</span>cast <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span>cast <span class="bound">e3</span><span class="main">)</span><span class="main">;</span>
        return <span class="bound">e2</span>
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="var">?h0</span> <span class="main">⊢</span> <span class="var">?P</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> node_ptr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="var"><span class="var">?e2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_assigned_nodes_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_tag_name <span class="main">+</span>
  l_get_child_nodes <span class="main">+</span>
  l_heap_is_wellformed<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_find_slot<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_assigned_nodes<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_assigned_nodes_wf<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_adopt_node<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_remove_child<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_remove_child_wf2 <span class="main">+</span>
  l_insert_before_wf <span class="main">+</span>
  l_insert_before_wf2 <span class="main">+</span>
  l_insert_before<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> _ _ _ _ _ _ <span class="quoted">get_ancestors_si</span> <span class="quoted">get_ancestors_si_locs</span> <span class="main">+</span>
  l_append_child<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_append_child_wf<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>  _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ <span class="quoted">get_ancestors_si</span> <span class="quoted">get_ancestors_si_locs</span> <span class="main">+</span>
  l_set_disconnected_nodes_get_tag_name <span class="main">+</span>
  l_set_shadow_root_get_child_nodes <span class="main">+</span>
  l_set_child_nodes_get_tag_name <span class="main">+</span>
  l_get_shadow_root_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_remove_shadow_root<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_remove_shadow_root_get_tag_name <span class="main">+</span>
  l_set_disconnected_nodes_get_shadow_root <span class="main">+</span>
  l_set_child_nodes_get_shadow_root <span class="main">+</span>
  l_remove_shadow_root_wf<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Shadow_DOM_Components-find_slot_is_component_unsafe"><span class="command">lemma</span></span> find_slot_is_component_unsafe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">find_slot</span> <span class="free">open_flag</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">slot</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">node_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∩</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">host</span></span> <span class="skolem"><span class="skolem">shadow_root_ptr</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">shadow_root_ptr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="main">(</span>cast <span class="skolem">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"cast <span class="free">slot</span> <span class="main">∈</span> set <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_slot_def first_in_tree_order_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2
        map_filter_M_pure_E<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">slot</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits list.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M_pure bind_pure_I<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> element_ptr_casts_commute3<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">node_ptr</span> <span class="main">|∈|</span> node_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> find_slot_ptr_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">node_ptr_c</span></span> <span class="keyword2"><span class="keyword">where</span></span> node_ptr_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">node_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">node_ptr_c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_component_ok is_OK_returns_result_E
      node_ptr_kinds_commutes<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="skolem">host</span> <span class="main">∈</span> set <span class="skolem">node_ptr_c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span>›</span></span> get_component_parent_inside assms<span class="main">(</span>1<span class="main">)</span>
      assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">node_ptr_c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span>›</span></span> get_component_subset a_heap_is_wellformed_def
      assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> node_ptr_c
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">slot</span> <span class="main">|∈|</span> element_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> find_slot_slot_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">slot_c</span></span> <span class="keyword2"><span class="keyword">where</span></span> slot_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">slot_c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_heap_is_wellformed_def assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_component_ok is_OK_returns_result_E
      node_ptr_kinds_commutes<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> element_ptr_kinds_commutes<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="skolem">shadow_root_ptr</span> <span class="main">∈</span> set <span class="skolem">slot_c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="main">(</span>cast <span class="skolem">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>›</span></span> <span class="quoted"><span class="quoted">‹cast <span class="free">slot</span> <span class="main">∈</span> set <span class="skolem">to</span>›</span></span>
      get_component_to_tree_order assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> get_dom_component_ptr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="skolem">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">slot_c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">shadow_root_ptr</span>›</span></span> get_component_subset assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
      assms<span class="main">(</span>3<span class="main">)</span> slot_c
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> get_shadow_root_is_component_unsafe assms <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">shadow_root_ptr</span>›</span></span>
      node_ptr_c slot_c
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Shadow_DOM_Components-assigned_slot_pure"><span class="command">lemma</span></span> assigned_slot_pure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pure <span class="main">(</span><span class="free">assigned_slot</span> <span class="free">node_ptr</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assigned_slot_def a_find_slot_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_I  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> first_in_tree_order_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_I map_filter_M_pure <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1" id="Shadow_DOM_Components-assigned_slot_is_strongly_dom_component_safe"><span class="command">lemma</span></span> assigned_slot_is_strongly_dom_component_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">assigned_slot</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">slot_opt</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">shadow_root_ptr</span> <span class="main">∈</span> fset <span class="main">(</span>shadow_root_ptr_kinds <span class="free">h</span><span class="main">)</span><span class="main">.</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">get_mode</span> <span class="bound">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Closed"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_strongly_dom_component_safe</span> <span class="main">{</span>cast <span class="free">node_ptr</span><span class="main">}</span> <span class="main">(</span>cast <span class="main">`</span> set_option <span class="free">slot_opt</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assigned_slot_pure
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> pure_returns_heap_eq returns_result_heap_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">parent_opt</span></span> <span class="keyword2"><span class="keyword">where</span></span> parent_opt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">parent_opt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assigned_slot_def a_find_slot_def returns_result_heap_def
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">slot_opt</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">parent_opt</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assigned_slot_def a_find_slot_def returns_result_heap_def
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> returns_result_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">parent</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_element_ptr_kind <span class="skolem">parent</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">host</span></span> <span class="keyword2"><span class="keyword">where</span></span> host<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">parent</span> <span class="main">=</span> cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_optionE element_ptr_casts_commute3 node_ptr_casts_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">host</span> <span class="main">|∈|</span> element_ptr_kinds <span class="free">h</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Some.prems element_ptr_kinds_commutes host local.get_parent_parent_in_heap
          node_ptr_kinds_commutes
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">shadow_root_opt</span></span> <span class="keyword2"><span class="keyword">where</span></span> shadow_root_opt<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">shadow_root_opt</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> get_shadow_root_ok
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_OK_returns_result_E<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">shadow_root_opt</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> returns_result_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">parent</span>›</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assigned_slot_def a_find_slot_def returns_result_heap_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> host select_result_I2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">shadow_root_ptr</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">shadow_root_ptr</span> <span class="main">|∈|</span> shadow_root_ptr_kinds <span class="free">h</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Some.prems assms<span class="main">(</span>1<span class="main">)</span> local.get_shadow_root_shadow_root_ptr_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_mode</span> <span class="skolem">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Closed"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_mode</span> <span class="skolem">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Open"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_mode</span> <span class="skolem">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Open"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Open <span class="main">=</span> Closed"</span></span>
            <span class="keyword1"><span class="command">using</span></span> returns_result_eq  <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_mode</span> <span class="skolem">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Closed›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> Some parent_opt host
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> returns_result_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">parent</span>›</span></span><span class="main"><span class="main">]</span></span>
              returns_result_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">shadow_root_ptr</span>›</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assigned_slot_def a_find_slot_def returns_result_heap_def
              <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> returns_result_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">parent</span>›</span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assigned_slot_def a_find_slot_def returns_result_heap_def
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_strongly_dom_component_safe_def preserved_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Shadow_DOM_Components-assigned_nodes_is_component_unsafe"><span class="command">lemma</span></span> assigned_nodes_is_component_unsafe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">assigned_nodes</span> <span class="free">element_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">node_ptr</span> <span class="main">∈</span> set <span class="free">nodes</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">element_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∩</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">node_ptr</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">find_slot</span> False <span class="free">node_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="free">element_ptr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assigned_nodes_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_M_holds_for_result<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">node_ptr</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_I <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms find_slot_is_component_unsafe
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Shadow_DOM_Components-flatten_dom_assigned_nodes_become_children"><span class="command">lemma</span></span> flatten_dom_assigned_nodes_become_children<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">flatten_dom</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">assigned_nodes</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tups</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">element_ptrs</span></span> <span class="skolem"><span class="skolem">shadow_root_ptrs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> element_ptr_kinds_M <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">element_ptrs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    tups<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> map_filter_M2 <span class="main">(</span><span class="main">λ</span><span class="bound">element_ptr</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">tag</span> <span class="main">←</span> <span class="free">get_tag_name</span> <span class="bound">element_ptr</span><span class="main">;</span>
      <span class="bound">assigned_nodes</span> <span class="main">←</span> <span class="free">assigned_nodes</span> <span class="bound">element_ptr</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">tag</span> <span class="main">=</span> <span class="inner_quoted">''slot''</span> <span class="main">∧</span> <span class="bound">assigned_nodes</span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> return <span class="main">(</span>Some <span class="main">(</span><span class="bound">element_ptr</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1">else</span> return None<span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">element_ptrs</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">tups</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> map_filter_M2 <span class="var">?f</span> <span class="skolem">element_ptrs</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">tups</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="bound">slot</span><span class="main">)</span> <span class="main">⤜</span> forall_M <span class="free">remove</span><span class="main">;</span>
      forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast <span class="bound">slot</span><span class="main">)</span><span class="main">)</span> <span class="bound">assigned_nodes</span>
    <span class="main">}</span><span class="main">)</span> <span class="skolem">tups</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> shadow_root_ptr_kinds_M <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">shadow_root_ptrs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="main">λ</span><span class="bound">shadow_root_ptr</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">host</span> <span class="main">←</span> <span class="free">get_host</span> <span class="bound">shadow_root_ptr</span><span class="main">;</span>
      <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="bound">host</span><span class="main">)</span> <span class="main">⤜</span> forall_M <span class="free">remove</span><span class="main">;</span>
      <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="bound">shadow_root_ptr</span><span class="main">)</span> <span class="main">⤜</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast <span class="bound">host</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="free">remove_shadow_root</span> <span class="bound">host</span>
    <span class="main">}</span><span class="main">)</span> <span class="skolem">shadow_root_ptrs</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> <span class="free">flatten_dom</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flatten_dom_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
        bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ElementMonad.ptr_kinds_M_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
        bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ShadowRootMonad.ptr_kinds_M_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> pure_returns_heap_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M2_pure bind_pure_I<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> all_tups_slot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">assigned_nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span>
<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="bound">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tups
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">element_ptrs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">tups</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M2_pure bind_pure_I<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">element_ptrs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> element_ptr_kinds_M <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">element_ptrs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">tups</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tups
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">element_ptrs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">tups</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M2_pure bind_pure_I
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_filter_pure_foo<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">slot</span> <span class="main">∈</span> set <span class="skolem">element_ptrs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assigned_nodes_ptr_in_heap <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">⊢</span> element_ptr_kinds_M <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">element_ptrs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> map_filter_M2_in_result<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tups<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_I<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> bind_pure_returns_result_I<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms assigned_nodes_slot_is_slot
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pure_returns_result_I<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">assigned_nodes</span> <span class="bound">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">nodes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tups
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">element_ptrs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">tups</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_result_E2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_filter_M2_pure bind_pure_I <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> elementwise_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">slot'</span> <span class="bound">nodes</span> <span class="bound">nodes'</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span>
<span class="main">(</span><span class="bound">slot'</span><span class="main">,</span> <span class="bound">nodes'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span> <span class="bound">slot</span> <span class="main">=</span> <span class="bound">slot'</span> <span class="main">⟹</span> <span class="bound">nodes</span> <span class="main">=</span> <span class="bound">nodes'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> returns_result_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span> distinct <span class="bound">nodes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">assigned_nodes</span> <span class="bound">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">nodes</span>›</span></span>
      assigned_nodes_distinct
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">slot'</span> <span class="bound">nodes</span> <span class="bound">nodes'</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">slot'</span><span class="main">,</span> <span class="bound">nodes'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span>
<span class="bound">slot</span> <span class="main">≠</span> <span class="bound">slot'</span> <span class="main">⟹</span> set <span class="bound">nodes</span> <span class="main">∩</span> set <span class="bound">nodes'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">assigned_nodes</span> <span class="bound">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">nodes</span>›</span></span>
      assigned_nodes_different_ptr assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span>›</span></span> all_tups_slot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h2
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">tups</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xc</span></span> <span class="skolem"><span class="skolem">ha</span></span> <span class="skolem"><span class="skolem">hb</span></span> <span class="skolem"><span class="skolem">slot'</span></span> <span class="skolem"><span class="skolem">nodes'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot'</span><span class="main">,</span> <span class="skolem">nodes'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot'</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">xc</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">xc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">ha</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      hb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ha</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      remainder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span><span class="main">.</span> Heap_Error_Monad.bind
<span class="main">(</span><span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">slot</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Heap_Error_Monad.bind <span class="main">(</span>forall_M <span class="free">remove</span> <span class="bound">x</span><span class="main">)</span>
<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">slot</span><span class="main">)</span><span class="main">)</span> <span class="bound">assigned_nodes</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_child_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> bind_returns_result_E
          bind_returns_result_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_child_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ha</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>›</span></span> ha
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xc</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">yc</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hb1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        hb1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        hba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hb1</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">yc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">ha</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hb1</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>›</span></span> hb1
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_child_locs_def set_child_nodes_get_tag_name
            set_disconnected_nodes_get_tag_name
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_tag_name_reads remove_writes<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> hba Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hb
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">nodes'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ha</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">nodes'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ha1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        ha1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ha</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot'</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">ha1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        hb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ha1</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ha1</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ha</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>›</span></span> ha1
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def insert_before_locs_def adopt_node_locs_def
            adopt_node_locs_def remove_child_locs_def set_child_nodes_get_tag_name
            set_disconnected_nodes_get_tag_name
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_tag_name_reads insert_before_writes<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ha1 hb Cons<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> remainder <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span> <span class="main">∧</span> <span class="free">heap_is_wellformed</span> <span class="skolem">h2</span> <span class="main">∧</span> <span class="free">type_wf</span> <span class="skolem">h2</span> <span class="main">∧</span> <span class="free">known_ptrs</span> <span class="skolem">h2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> h2 assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">tups</span>›</span></span> all_tups_slot elementwise_eq
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">slot'</span> <span class="bound">assigned_nodes</span> <span class="bound">nodes'</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span>
<span class="main">(</span><span class="bound">slot'</span><span class="main">,</span> <span class="bound">nodes'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span> <span class="bound">slot</span> <span class="main">≠</span> <span class="bound">slot'</span> <span class="main">⟹</span> set <span class="bound">assigned_nodes</span> <span class="main">∩</span> set <span class="bound">nodes'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">assigned_nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span> distinct <span class="bound">assigned_nodes</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">tups</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xc</span></span> <span class="skolem"><span class="skolem">ha</span></span> <span class="skolem"><span class="skolem">hb</span></span> <span class="skolem"><span class="skolem">slot'</span></span> <span class="skolem"><span class="skolem">nodes'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot'</span><span class="main">,</span> <span class="skolem">nodes'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot'</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">xc</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">xc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">ha</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      hb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ha</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      remainder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span><span class="main">.</span> Heap_Error_Monad.bind
<span class="main">(</span><span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">slot</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Heap_Error_Monad.bind <span class="main">(</span>forall_M <span class="free">remove</span> <span class="bound">x</span><span class="main">)</span>
<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">slot</span><span class="main">)</span><span class="main">)</span> <span class="bound">assigned_nodes</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_child_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> bind_returns_result_E
          bind_returns_result_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_child_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">assigned_nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> <span class="skolem">h</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="bound">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">ha</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">ha</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">ha</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span> Cons<span class="main">(</span>5<span class="main">)</span> Cons<span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">xc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">ha</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xc</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> local.remove_child_heap_is_wellformed_preserved local.remove_child_preserves_known_ptrs
          local.remove_child_preserves_type_wf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> local.remove_child_heap_is_wellformed_preserved local.remove_child_preserves_known_ptrs
          local.remove_child_preserves_type_wf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
        remove_child_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">hb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">hb</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ha</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">nodes'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ha</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
          insert_before_preserves_known_ptrs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
          insert_before_preserves_known_ptrs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
          insert_before_preserves_known_ptrs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">slot</span> <span class="skolem">assigned_nodes</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">slot</span><span class="main">,</span> <span class="skolem">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="skolem">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">assigned_nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span>
<span class="skolem">h</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="bound">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ha</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="skolem">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">xc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">ha</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xc</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_child_locs_def set_child_nodes_get_tag_name
            set_disconnected_nodes_get_tag_name
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_tag_name_reads remove_writes<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="skolem">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ha</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">nodes'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ha</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def insert_before_locs_def adopt_node_locs_def adopt_node_locs_def
            remove_child_locs_def set_child_nodes_get_tag_name set_disconnected_nodes_get_tag_name
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_tag_name_reads insert_before_writes<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> tag_names_same <span class="main">=</span> this

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">slot'</span> <span class="main">=</span> <span class="free">slot</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nodes'</span> <span class="main">=</span> <span class="free">nodes</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> Cons.prems<span class="main">(</span>8<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot'</span><span class="main">,</span> <span class="skolem">nodes'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>6<span class="main">)</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot'</span><span class="main">,</span> <span class="skolem">nodes'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ha</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> remove_for_all_empty_children Cons.prems<span class="main">(</span>3<span class="main">)</span> Cons.prems<span class="main">(</span>4<span class="main">)</span> Cons.prems<span class="main">(</span>5<span class="main">)</span> True
          <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">xc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">ha</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot'</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">xc</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  append_child_for_all_on_no_children<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span><span class="main">]</span>
          True <span class="quoted"><span class="quoted">‹<span class="skolem">nodes'</span> <span class="main">=</span> <span class="free">nodes</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ha</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">assigned_nodes</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tups</span> <span class="main">⟹</span>
distinct <span class="bound">assigned_nodes</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">ha</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">ha</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">ha</span>›</span></span>
          local.append_child_for_all_on_no_children
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">xs</span>›</span></span> remainder
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">slot'</span> <span class="bound">assigned_nodes</span> <span class="bound">nodes'</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="bound">slot'</span><span class="main">,</span> <span class="bound">nodes'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">slot</span> <span class="main">=</span> <span class="bound">slot'</span> <span class="main">⟹</span> <span class="bound">assigned_nodes</span> <span class="main">=</span> <span class="bound">nodes'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">slot</span> <span class="bound">slot'</span> <span class="bound">assigned_nodes</span> <span class="bound">nodes'</span><span class="main">.</span> <span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="bound">slot'</span><span class="main">,</span> <span class="bound">nodes'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">slot</span> <span class="main">≠</span> <span class="bound">slot'</span> <span class="main">⟹</span> set <span class="bound">assigned_nodes</span> <span class="main">∩</span> set <span class="bound">nodes'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">hb</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yc</span></span> <span class="skolem"><span class="skolem">hba</span></span> <span class="skolem"><span class="skolem">hbb</span></span> <span class="skolem"><span class="skolem">slot''</span></span> <span class="skolem"><span class="skolem">nodes''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot''</span><span class="main">,</span> <span class="skolem">nodes''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot''</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">yc</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">yc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">hba</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes''</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hbb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          remainder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hbb</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">slot</span><span class="main">,</span> <span class="bound">assigned_nodes</span><span class="main">)</span><span class="main">.</span> Heap_Error_Monad.bind
<span class="main">(</span><span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">slot</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Heap_Error_Monad.bind <span class="main">(</span>forall_M <span class="free">remove</span> <span class="bound">x</span><span class="main">)</span>
<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">slot</span><span class="main">)</span><span class="main">)</span> <span class="bound">assigned_nodes</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>7<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
              bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_child_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">slot</span> <span class="main">≠</span> <span class="skolem">slot''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot''</span><span class="main">,</span> <span class="skolem">nodes''</span><span class="main">)</span>›</span></span>
              list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">nodes</span> <span class="main">∩</span> set <span class="skolem">nodes''</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot''</span><span class="main">,</span> <span class="skolem">nodes''</span><span class="main">)</span>›</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span> <span class="main">∧</span>
<span class="free">heap_is_wellformed</span> <span class="skolem">hba</span> <span class="main">∧</span> <span class="free">type_wf</span> <span class="skolem">hba</span> <span class="main">∧</span> <span class="free">known_ptrs</span> <span class="skolem">hba</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hb</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">yc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot''</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">yc</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">yc</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">hb</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">yc</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hb1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            hb1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            hba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hb1</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">yc</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> Cons.prems<span class="main">(</span>4<span class="main">)</span> Cons.prems<span class="main">(</span>5<span class="main">)</span> Cons.prems<span class="main">(</span>6<span class="main">)</span> local.child_parent_dual
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">hb1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">hb1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">hb1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb1</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
                bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
              remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
              remove_child_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
              remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
              remove_child_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb1</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
                bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
              remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
              remove_child_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
              remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
              remove_child_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hb1</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
                bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
              remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
              remove_child_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
              remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
              remove_child_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hb1</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot''</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">yc</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot''</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">yc</span>›</span></span> hb1
            <span class="keyword1"><span class="command">using</span></span> remove_removes_child <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hb1</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> hb1 set_child_nodes_get_child_nodes_different_pointers
              <span class="quoted"><span class="quoted">‹<span class="skolem">hb</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">slot</span> <span class="main">≠</span> <span class="skolem">slot''</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_child_locs_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_child_nodes_reads remove_writes<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hb1</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="main">(</span><span class="skolem">yc</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba</span>›</span></span> Cons
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>


        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hbb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span> <span class="main">∧</span>
<span class="free">heap_is_wellformed</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">type_wf</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">known_ptrs</span> <span class="skolem">hbb</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes''</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hbb</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">nodes</span> <span class="main">∩</span> set <span class="skolem">nodes''</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">nodes''</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">hba</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">nodes''</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">hba</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">hba</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">hba</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hba1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            hba1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">hba1</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes''</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hbb</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">hba1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">hba1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">hba1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba1</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hba</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hba</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hba</span>›</span></span>
              insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
              insert_before_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba1</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hba</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hba</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hba</span>›</span></span>
              insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
              insert_before_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba1</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hba</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hba</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hba</span>›</span></span>
              insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
              insert_before_preserves_known_ptrs
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="free">nodes</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">nodes</span> <span class="main">∩</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">nodes''</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">parent_opt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">parent_opt</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> insert_before_child_in_heap hba1 get_parent_ok <span class="keyword1"><span class="command">unfolding</span></span> append_child_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_OK_returns_heap_I is_OK_returns_result_E<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hba1</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">parent_opt</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> None
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba1</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">slot</span> <span class="main">≠</span> <span class="skolem">slot''</span>›</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def insert_before_locs_def adopt_node_locs_def
                  adopt_node_locs_def remove_child_locs_def
                  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_child_nodes_reads insert_before_writes<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject
                  set_child_nodes_get_child_nodes_different_pointers<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">parent</span><span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">parent</span> <span class="main">≠</span> cast <span class="free">slot</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> get_parent_child_dual<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">parent</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> set <span class="free">nodes</span>›</span></span> returns_result_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> reads_writes_separate_forwards<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fact</span> get_child_nodes_reads<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fact</span> insert_before_writes<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fact</span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">slot''</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hba1</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> append_child_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fact</span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>›</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hba</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">parent</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">parent</span> <span class="main">≠</span> cast <span class="free">slot</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">slot</span> <span class="main">≠</span> <span class="skolem">slot''</span>›</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_before_locs_def adopt_node_locs_def adopt_node_locs_def
                  remove_child_locs_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_child_nodes_get_child_nodes_different_pointers
                  set_disconnected_nodes_get_child_nodes<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject
                  set_child_nodes_get_child_nodes_different_pointers<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">nodes</span> <span class="main">∩</span> set <span class="skolem">nodes''</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons.hyps  <span class="quoted"><span class="quoted">‹<span class="skolem">hba1</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">slot''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nodes''</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">hbb</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hbb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span> <span class="main">∧</span>
<span class="free">heap_is_wellformed</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">type_wf</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">known_ptrs</span> <span class="skolem">hbb</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hbb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span> <span class="main">∧</span>
<span class="free">heap_is_wellformed</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">type_wf</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">known_ptrs</span> <span class="skolem">hbb</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hbb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span> <span class="main">∧</span>
<span class="free">heap_is_wellformed</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">type_wf</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">known_ptrs</span> <span class="skolem">hbb</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">hbb</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span> <span class="main">∧</span>
<span class="free">heap_is_wellformed</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">type_wf</span> <span class="skolem">hbb</span> <span class="main">∧</span> <span class="free">known_ptrs</span> <span class="skolem">hbb</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remainder<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">nodes'</span> <span class="main">=</span> <span class="free">nodes</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot'</span><span class="main">,</span> <span class="skolem">nodes'</span><span class="main">)</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> insert_iff list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nodes'</span> <span class="main">≠</span> <span class="free">nodes</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> Cons.prems<span class="main">(</span>9<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot'</span><span class="main">,</span> <span class="skolem">nodes'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> inf.idem list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_empty2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">slot'</span><span class="main">,</span> <span class="skolem">nodes'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">slot</span><span class="main">,</span> <span class="free">nodes</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span>›</span></span> remainder
            <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">hb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">hb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">hb</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>6<span class="main">)</span> tag_names_same  Cons.prems<span class="main">(</span>8<span class="main">)</span> Cons.prems<span class="main">(</span>9<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Cons.prems<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> h' <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">shadow_root_ptrs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">shadow_root_ptr</span> <span class="skolem">shadow_root_ptrs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">h2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">host</span></span> <span class="skolem"><span class="skolem">h2a</span></span> <span class="skolem"><span class="skolem">h2b</span></span> <span class="skolem"><span class="skolem">h2c</span></span> <span class="skolem"><span class="skolem">host_children</span></span> <span class="skolem"><span class="skolem">shadow_root_children</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_host</span> <span class="skolem">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">host</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">host_children</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      h2a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">host_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">shadow_root_children</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      h2b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2a</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span><span class="main">)</span> <span class="skolem">shadow_root_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">h2b</span> <span class="main">⊢</span> <span class="free">remove_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      remainder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2c</span> <span class="main">⊢</span> forall_M<span class="main">(</span><span class="main">λ</span><span class="bound">shadow_root_ptr</span><span class="main">.</span> Heap_Error_Monad.bind <span class="main">(</span><span class="free">get_host</span> <span class="bound">shadow_root_ptr</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">host</span><span class="main">.</span> Heap_Error_Monad.bind <span class="main">(</span><span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">host</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Heap_Error_Monad.bind <span class="main">(</span>forall_M <span class="free">remove</span> <span class="bound">x</span><span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Heap_Error_Monad.bind <span class="main">(</span><span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">shadow_root_ptr</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Heap_Error_Monad.bind <span class="main">(</span>forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="bound">host</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>
                           <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">remove_shadow_root</span> <span class="bound">host</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="skolem">shadow_root_ptrs</span>
       <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">h'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_host_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_child_nodes_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">shadow_root_ptr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_host</span> <span class="skolem">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">host</span>›</span></span> shadow_root_host_dual
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">shadow_root_ptr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">host_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">host_children</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_disconnected_nodes_get_shadow_root set_child_nodes_get_shadow_root
          remove_child_locs_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_shadow_root_reads remove_writes<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2b</span> <span class="main">⊢</span> <span class="free">get_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="skolem">shadow_root_ptr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span><span class="main">)</span> <span class="skolem">shadow_root_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2b</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">shadow_root_children</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_disconnected_nodes_get_shadow_root set_child_nodes_get_shadow_root
          append_child_def insert_before_locs_def adopt_node_locs_def adopt_node_locs_def remove_child_locs_def
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_shadow_root_reads insert_before_writes<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">host</span> <span class="main">≠</span> <span class="free">slot</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">host</span> <span class="main">=</span> <span class="free">slot</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> get_host_valid_tag_name<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_host</span> <span class="skolem">shadow_root_ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">host</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">host</span> <span class="main">=</span> <span class="free">slot</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">h2a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h2a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">h2a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">host_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">host_children</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
        remove_child_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
        remove_child_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
          bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
        remove_child_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">h2b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h2b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">h2b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span><span class="main">)</span> <span class="skolem">shadow_root_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2b</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">shadow_root_children</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
        insert_before_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
        insert_before_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
        insert_before_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">h2c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h2c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">h2c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> remove_shadow_root_preserves <span class="quoted"><span class="quoted">‹<span class="skolem">h2b</span> <span class="main">⊢</span> <span class="free">remove_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2c</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">host_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">host_children</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">host_children</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">host_children</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h21</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h21</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">h21</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">host_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">h21</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h21</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">h21</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h21</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
            bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
          remove_child_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h21</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
            bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
          remove_child_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h21</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E
            bind_returns_heap_E2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> get_parent_pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> remove_child_heap_is_wellformed_preserved remove_child_preserves_type_wf
          remove_child_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">host_children</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2</span>›</span></span> child_parent_dual
        <span class="keyword1"><span class="command">using</span></span> heap_is_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h21</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">host</span> <span class="main">≠</span> <span class="free">slot</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h21</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_child_locs_def set_disconnected_nodes_get_child_nodes
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_preserved<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_child_nodes_reads remove_writes<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject
            set_child_nodes_get_child_nodes_different_pointers<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h21</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">host_children</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h21</span>›</span></span>  remove_removes_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">host_children</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h21</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h21</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h21</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">h21</span> <span class="main">⊢</span> forall_M <span class="free">remove</span> <span class="skolem">host_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a</span>›</span></span> Cons<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> Cons.prems<span class="main">(</span>4<span class="main">)</span> Cons.prems<span class="main">(</span>5<span class="main">)</span> Cons.prems<span class="main">(</span>6<span class="main">)</span> heap_is_wellformed_def
          <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">remove</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h21</span>›</span></span> remove_removes_child
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2b</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast <span class="skolem">host</span><span class="main">)</span><span class="main">)</span> <span class="skolem">shadow_root_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2b</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">shadow_root_children</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2a</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">shadow_root_children</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">shadow_root_children</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h2a1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">h2a1</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">shadow_root_children</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="skolem">h2a1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="skolem">h2a1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="skolem">h2a1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2a</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2a</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2a</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a1</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
          insert_before_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2a</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2a</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2a</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a1</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
          insert_before_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2a</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2a</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2a</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a1</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_before_heap_is_wellformed_preserved insert_before_preserves_type_wf
          insert_before_preserves_known_ptrs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2a1</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">shadow_root_children</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="skolem">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">shadow_root_children</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_before_removes_child
          <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a1</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> append_child_def<span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2a</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> cast_document_ptr_not_node_ptr<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> cast_shadow_root_ptr_not_node_ptr<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_parent</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> Some <span class="main">(</span>cast <span class="skolem">shadow_root_ptr</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">shadow_root_ptr</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">shadow_root_children</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_is_wellformed</span> <span class="skolem">h2a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">type_wf</span> <span class="skolem">h2a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">known_ptrs</span> <span class="skolem">h2a</span>›</span></span> child_parent_dual
        <span class="keyword1"><span class="command">using</span></span> heap_is_wellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2a1</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2a1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">host</span> <span class="main">≠</span> <span class="free">slot</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  set_disconnected_nodes_get_child_nodes append_child_def
            insert_before_locs_def adopt_node_locs_def adopt_node_locs_def remove_child_locs_def
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_preserved<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_child_nodes_reads
              insert_before_writes<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> set_child_nodes_get_child_nodes_different_pointers cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject
          cast<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub>_inject cast_document_ptr_not_node_ptr<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cast_shadow_root_ptr_not_node_ptr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2a1</span> <span class="main">⊢</span> forall_M <span class="main">(</span><span class="free">append_child</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="skolem">host</span><span class="main">)</span><span class="main">)</span> <span class="skolem">shadow_root_children</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2b</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2c</span> <span class="main">⊢</span> <span class="free">get_child_nodes</span> <span class="main">(</span>cast<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>j</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">slot</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">nodes</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2b</span> <span class="main">⊢</span> <span class="free">remove_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2c</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_shadow_root_get_child_nodes_different_pointers
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_child_nodes_reads remove_shadow_root_writes<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> cast_shadow_root_ptr_not_node_ptr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
          local.remove_shadow_root_get_child_nodes_different_pointers<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2a</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h2a <span class="quoted"><span class="quoted">‹<span class="skolem">h2</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">host_children</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_child_locs_def set_disconnected_nodes_get_tag_name
          set_child_nodes_get_tag_name <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_tag_name_reads remove_writes<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2b</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h2b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">shadow_root_children</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">h2a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_child_def insert_before_locs_def adopt_node_locs_def adopt_node_locs_def
          remove_child_locs_def set_disconnected_nodes_get_tag_name set_child_nodes_get_tag_name
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_tag_name_reads insert_before_writes<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_returns_heap_E <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2c</span> <span class="main">⊢</span> <span class="free">get_tag_name</span> <span class="free">slot</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="inner_quoted">''slot''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h2b</span> <span class="main">⊢</span> <span class="free">remove_shadow_root</span> <span class="skolem">host</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">h2c</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_shadow_root_get_tag_name
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reads_writes_separate_forwards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> get_tag_name_reads remove_shadow_root_writes<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> remainder
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> i_assigned_nodes_component<span class="main">?</span><span class="main">:</span> l_assigned_nodes_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">type_wf</span> <span class="quoted">get_tag_name</span> <span class="quoted">get_tag_name_locs</span> <span class="quoted">known_ptr</span> <span class="quoted">get_child_nodes</span> <span class="quoted">get_child_nodes_locs</span>
  <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">get_shadow_root</span> <span class="quoted">get_shadow_root_locs</span>
  <span class="quoted">heap_is_wellformed</span> <span class="quoted">parent_child_rel</span> <span class="quoted">heap_is_wellformed<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="quoted">get_host</span> <span class="quoted">get_host_locs</span>
  <span class="quoted">get_disconnected_document</span> <span class="quoted">get_disconnected_document_locs</span> <span class="quoted">get_parent</span> <span class="quoted">get_parent_locs</span>
  <span class="quoted">get_mode</span> <span class="quoted">get_mode_locs</span> <span class="quoted">get_attribute</span> <span class="quoted">get_attribute_locs</span> <span class="quoted">first_in_tree_order</span> <span class="quoted">find_slot</span>
  <span class="quoted">assigned_slot</span> <span class="quoted">known_ptrs</span> <span class="quoted">to_tree_order</span> <span class="quoted">assigned_nodes</span> <span class="quoted">assigned_nodes_flatten</span> <span class="quoted">flatten_dom</span>
  <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span> <span class="quoted">remove</span> <span class="quoted">insert_before</span> <span class="quoted">insert_before_locs</span> <span class="quoted">append_child</span>
  <span class="quoted">remove_shadow_root</span> <span class="quoted">remove_shadow_root_locs</span> <span class="quoted">set_shadow_root</span> <span class="quoted">set_shadow_root_locs</span> <span class="quoted">remove_child</span>
  <span class="quoted">remove_child_locs</span> <span class="quoted">get_component</span> <span class="quoted">is_strongly_dom_component_safe</span> <span class="quoted">is_weakly_dom_component_safe</span>
  <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span> <span class="quoted">get_owner_document</span> <span class="quoted">set_disconnected_nodes</span> <span class="quoted">set_disconnected_nodes_locs</span>
  <span class="quoted">adopt_node</span> <span class="quoted">adopt_node_locs</span> <span class="quoted">set_child_nodes</span> <span class="quoted">set_child_nodes_locs</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_assigned_nodes_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_assigned_nodes_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹get\_owner\_document›</span></span>

<span class="keyword1"><span class="command">locale</span></span> l_get_owner_document_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">=</span>
  l_get_owner_document_wf<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">+</span>
  l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Shadow_DOM_Components-get_owner_document_is_component_unsafe"><span class="command">lemma</span></span> get_owner_document_is_component_unsafe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_is_wellformed</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_wf</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">known_ptrs</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_owner_document</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">owner_document</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_document_ptr_kind <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∩</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">owner_document</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">owner_document</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> get_owner_document_owner_document_in_heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> is_OK_returns_result_I local.get_owner_document_ptr_in_heap<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">root</span></span> <span class="keyword2"><span class="keyword">where</span></span> root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">get_root_node</span> <span class="free">ptr</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">root</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> is_OK_returns_result_I
        local.get_owner_document_ptr_in_heap local.get_root_node_ok returns_result_select_result<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span> to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊢</span> <span class="free">to_tree_order</span> <span class="skolem">root</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">to</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_OK_returns_result_E local.get_root_node_root_in_heap
        local.to_tree_order_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">to</span><span class="main">.</span> <span class="main">¬</span>is_document_ptr_kind <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> document_ptr_casts_commute3
        local.to_tree_order_node_ptrs node_ptr_no_document_ptr_cast root select_result_I2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cast <span class="free">owner_document</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> document_ptr_document_ptr_cast
        is_OK_returns_result_I l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>.get_component_ok local.get_component_root_node_same
        local.get_root_node_not_node_same local.get_root_node_ptr_in_heap local.l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms
        node_ptr_no_document_ptr_cast returns_result_select_result root select_result_I2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="free">ptr</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">≠</span> <span class="main">|</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">get_component</span> <span class="main">(</span>cast <span class="free">owner_document</span><span class="main">)</span><span class="keyword1">|<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">owner_document</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        document_ptr_kinds_commutes l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>.get_component_ok local.get_dom_component_ptr
        local.l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms returns_result_select_result<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">owner_document</span> <span class="main">|∈|</span> document_ptr_kinds <span class="free">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ptr</span> <span class="main">|∈|</span> object_ptr_kinds <span class="free">h</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> document_ptr_kinds_commutes l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>.get_dom_component_no_overlap
        l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>.get_component_ok local.l_get_component<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms returns_result_select_result<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> i_get_owner_document_component<span class="main">?</span><span class="main">:</span> l_get_owner_document_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="quoted">type_wf</span> <span class="quoted">get_disconnected_nodes</span> <span class="quoted">get_disconnected_nodes_locs</span> <span class="quoted">known_ptr</span> <span class="quoted">get_child_nodes</span>
  <span class="quoted">get_child_nodes_locs</span> <span class="quoted">DocumentClass.known_ptr</span> <span class="quoted">get_parent</span> <span class="quoted">get_parent_locs</span> <span class="quoted">get_root_node_si</span>
  <span class="quoted">get_root_node_si_locs</span> <span class="quoted">CD.a_get_owner_document</span> <span class="quoted">get_host</span> <span class="quoted">get_host_locs</span> <span class="quoted">get_owner_document</span>
  <span class="quoted">get_shadow_root</span> <span class="quoted">get_shadow_root_locs</span> <span class="quoted">get_tag_name</span> <span class="quoted">get_tag_name_locs</span> <span class="quoted">heap_is_wellformed</span>
  <span class="quoted">parent_child_rel</span> <span class="quoted">heap_is_wellformed<span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="quoted">get_disconnected_document</span> <span class="quoted">get_disconnected_document_locs</span>
  <span class="quoted">known_ptrs</span> <span class="quoted">get_ancestors_si</span> <span class="quoted">get_ancestors_si_locs</span> <span class="quoted">to_tree_order</span> <span class="quoted">get_component</span>
  <span class="quoted">is_strongly_dom_component_safe</span> <span class="quoted">is_weakly_dom_component_safe</span> <span class="quoted">get_root_node</span> <span class="quoted">get_root_node_locs</span>
  <span class="quoted">get_ancestors</span> <span class="quoted">get_ancestors_locs</span> <span class="quoted">get_element_by_id</span> <span class="quoted">get_elements_by_class_name</span>
  <span class="quoted">get_elements_by_tag_name</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_get_owner_document_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="dynamic"><span class="dynamic">instances</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> l_get_owner_document_component<span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>M</sub>_axioms <span class="main">[</span><span class="operator">instances</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_shadow_root_component</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(_)</span> object_ptr list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_shadow_root_component</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> is_shadow_root_ptr_kind <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="fancy_tabs">
<div class="head">
<h1>Theory fancy_tabs</h1>
</div>
<pre class="source"><span class="comment1">(***********************************************************************************
 * Copyright (c) 2016-2020 The University of Sheffield, UK
 *               2019-2020 University of Exeter, UK
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * SPDX-License-Identifier: BSD-2-Clause
 ***********************************************************************************)</span>

<span class="comment1">(* This file is automatically generated, please do not modify! *)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Testing fancy\_tabs›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory contains the test cases for fancy\_tabs.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> fancy_tabs
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../Shadow_DOM/Shadow_DOM.html">Shadow_DOM.Shadow_DOM</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fancy_tabs_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fancy_tabs_heap</span> <span class="main">=</span> create_heap <span class="main">[</span><span class="main">(</span>cast <span class="main">(</span>document_ptr.Ref <span class="main">1</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_document_obj html <span class="main">(</span>Some <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="main">1</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''html''</span> <span class="main">[</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">4</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''head''</span> <span class="main">[</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">3</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">3</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''title''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="main">1</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="main">1</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Global%20News''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">4</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''body''</span> <span class="main">[</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">5</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">6</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">7</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">8</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">9</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">10</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">30</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">5</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''h1''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Global%20News''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">6</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">3</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">3</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Search''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">7</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">4</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">4</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Sign%20In''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">8</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''br''</span> <span class="main">[]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">9</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''br''</span> <span class="main">[]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">10</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''fancy-tabs''</span> <span class="main">[</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">11</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">12</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">13</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">15</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">22</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''background''</span><span class="main">,</span> <span class="inner_quoted">''''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>cast <span class="main">(</span>shadow_root_ptr.Ref <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">11</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">5</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''slot''</span><span class="main">,</span> <span class="inner_quoted">''title''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">5</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Politics''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">12</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''slot''</span><span class="main">,</span> <span class="inner_quoted">''title''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''selected''</span><span class="main">,</span> <span class="inner_quoted">''''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">6</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Sports''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">13</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">7</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''slot''</span><span class="main">,</span> <span class="inner_quoted">''title''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">7</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Culture''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''section''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">8</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">8</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''content%20panel%201''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">15</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''ul''</span> <span class="main">[</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">16</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">18</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">16</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''li''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">9</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">17</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">9</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''News%20Item%201''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">17</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">10</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Share''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">18</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''li''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">11</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">19</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">11</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''News%20Item%202''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">19</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">12</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">12</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Share''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">20</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''li''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">13</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">21</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">13</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''News%20Item%203''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">21</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">14</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Share''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">22</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''section''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">15</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">15</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''content%20panel%203''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>shadow_root_ptr.Ref <span class="main">1</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_shadow_root_obj Open <span class="main">[</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">23</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">24</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">26</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">28</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>element_ptr.Ref <span class="numeral">29</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">23</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''style''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">16</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">16</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''---shortened---''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">24</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''div''</span> <span class="main">[</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">25</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''id''</span><span class="main">,</span> <span class="inner_quoted">''tabs''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">25</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''slot''</span> <span class="main">[]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''id''</span><span class="main">,</span> <span class="inner_quoted">''tabsSlot''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''name''</span><span class="main">,</span> <span class="inner_quoted">''title''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">26</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''div''</span> <span class="main">[</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">27</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''id''</span><span class="main">,</span> <span class="inner_quoted">''panels''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">27</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''slot''</span> <span class="main">[]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''id''</span><span class="main">,</span> <span class="inner_quoted">''panelsSlot''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">28</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">17</span><span class="main">)</span><span class="main">]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">17</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Previous%20Tab''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">29</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''button''</span> <span class="main">[</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">18</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''style''</span><span class="main">,</span> <span class="inner_quoted">''float:right''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>character_data_ptr.Ref <span class="numeral">18</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_character_data_obj <span class="inner_quoted">''Next%20Tab''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>cast <span class="main">(</span>element_ptr.Ref <span class="numeral">30</span><span class="main">)</span><span class="main">,</span> cast <span class="main">(</span>create_element_obj <span class="inner_quoted">''script''</span> <span class="main">[]</span> fmempty None<span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fancy_tabs_document</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> unit<span class="main">,</span> unit<span class="main">,</span> unit<span class="main">,</span> unit<span class="main">,</span> unit<span class="main">)</span> object_ptr option"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fancy_tabs_document</span> <span class="main">=</span> Some <span class="main">(</span>cast <span class="main">(</span>document_ptr.Ref <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>