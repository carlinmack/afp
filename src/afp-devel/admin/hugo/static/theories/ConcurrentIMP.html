<div id="CIMP_pred">
<div class="head">
<h1>Theory CIMP_pred</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Copyright 2015, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> CIMP_pred
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Extra HOL *)</span>

<span class="keyword1" id="CIMP_pred-triv"><span class="command">lemma</span></span> triv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CIMP_pred-always_eventually_pigeonhole"><span class="command">lemma</span></span> always_eventually_pigeonhole<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">k</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 8 0<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> le_SucI <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> le_Suc_eq nat_le_linear order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ Point-free notation ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:cimp-lifted-predicates}

Typically we define predicates as functions of a state. The following
provide a somewhat comfortable point-free imitation of Isabelle/HOL's
operators.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_not</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>¬</b></span> _"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>¬</b></span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∧</b></span>"</span> 35<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>∧</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_disj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∨</b></span>"</span> 30<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>∨</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_implies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⟶</b></span>"</span> 25<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>⟶</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_iff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⟷</b></span>"</span> 25<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>⟷</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>=</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>=</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_member</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∈</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>∈</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_neq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≠</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≠</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_If</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">If</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">Then</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">Else</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">If</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">Then</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">Else</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>&lt;</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≤</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>plus<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>+</b></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>+</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_minus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>minus<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>-</b></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>-</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">fun_fanout</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⨝</b></span>"</span> 35<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>⨝</b></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∀</b></span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>∀</b></span></span><span class="bound">x</span><span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∃</b></span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>∃</b></span></span><span class="bound">x</span><span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_app</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>$</b></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>$</b></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_subseteq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⊆</b></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>⊆</b></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∪</b></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>∪</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∩</b></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>∩</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

More application specific.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_conjoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred_conjoin</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(<span class="hidden">❙</span><b>∧</b>)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_disjoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred_disjoin</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(<span class="hidden">❙</span><b>∨</b>)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_is_none</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">NULL</span> _"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">NULL</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">EMPTY</span> _"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">EMPTY</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_list_null</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">LIST'_NULL</span> _"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">LIST_NULL</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_list_append</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>@</b></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>@</b></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">s</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⊗</b></span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>⊗</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_singleton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred_singleton</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">s</span><span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Infinite_Sequences">
<div class="head">
<h1>Theory Infinite_Sequences</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Infinite_Sequences
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CIMP_pred.html">CIMP_pred</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ Infinite Sequences \label{sec:infinite_sequences}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Infinite sequences and some operations on them.

We use the customary function-based representation.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> seq <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> seq_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">suffix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> seq"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1"><span class="free">|<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">stake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> seq <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stake</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">stake</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">0</span> <span class="main">#</span> <span class="free">stake</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> seq <span class="main">⇒</span> <span class="tfree">'a</span> seq"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">‹<span class="keyword1">@-</span>›</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|</span> Suc <span class="bound">i</span> <span class="main">⇒</span> <span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="comment1">(* FIXME misleading: this is σ(i, i+j). Use a bundle for this notation. FIXME move *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">interval_syn</span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">'(</span>_ <span class="keyword1">→</span> _<span class="keyword1">')</span>"</span> <span class="main">[</span>69<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">(* FIXME priorities *)</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main"><span class="free">(</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">)</span></span> <span class="main">≡</span> stake <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-suffix_eval"><span class="command">lemma</span></span> suffix_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Infinite_Sequences-suffix_plus"><span class="command">lemma</span></span> suffix_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">n</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">m</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-suffix_commute"><span class="command">lemma</span></span> suffix_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suffix_plus add.commute<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-suffix_plus_com"><span class="command">lemma</span></span> suffix_plus_com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">m</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">n</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">m</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> suffix_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">m</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suffix_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Infinite_Sequences-suffix_zero"><span class="command">lemma</span></span> suffix_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">0</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Infinite_Sequences-comp_suffix"><span class="command">lemma</span></span> comp_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∘</span> <span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> suffix_def comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> suffix_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  comp_suffix
  suffix_eval
  suffix_plus_com
  suffix_zero

<span class="keyword1" id="Infinite_Sequences-length_stake"><span class="command">lemma</span></span> length_stake<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>stake <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Infinite_Sequences-shift_simps"><span class="command">lemma</span></span> shift_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">σ</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">σ</span> <span class="main">0</span> <span class="keyword1">else</span> hd <span class="free">xs</span><span class="main">)</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> Suc <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> Suc <span class="main">0</span> <span class="keyword1">else</span> tl <span class="free">xs</span> <span class="main">@-</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Infinite_Sequences-stake_nil"><span class="command">lemma</span></span> stake_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"stake <span class="free">i</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-stake_shift"><span class="command">lemma</span></span> stake_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stake <span class="free">i</span> <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">w</span> <span class="main">@</span> stake <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">w</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-shift_snth_less"><span class="command">lemma</span></span> shift_snth_less<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">σ</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth nth_tl<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-shift_snth_ge"><span class="command">lemma</span></span> shift_snth_ge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">σ</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Infinite_Sequences-shift_snth"><span class="command">lemma</span></span> shift_snth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">σ</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="keyword1">else</span> <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Infinite_Sequences-suffix_shift"><span class="command">lemma</span></span> suffix_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span> <span class="main">=</span> drop <span class="free">i</span> <span class="free">xs</span> <span class="main">@-</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Infinite_Sequences-stake_nth"><span class="command">lemma</span></span> stake_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">j</span> <span class="free">s</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">s</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons'<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-stake_suffix_id"><span class="command">lemma</span></span> stake_suffix_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stake <span class="free">i</span> <span class="free">σ</span> <span class="main">@-</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff shift_snth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-id_stake_snth_suffix"><span class="command">lemma</span></span> id_stake_snth_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="main">(</span>stake <span class="free">i</span> <span class="free">σ</span> <span class="main">@</span> <span class="main">[</span><span class="free">σ</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> Suc <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> stake_suffix_id
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_le append_Nil2 diff_is_0_eq length_stake lessI nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_le_linear shift_snth stake_nil stake_shift take_Suc_conv_app_nth<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Infinite_Sequences-stake_add"><span class="command">lemma</span></span> stake_add<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"stake <span class="free">i</span> <span class="free">σ</span> <span class="main">@</span> stake <span class="free">j</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> stake <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def plus_1_eq_Suc suffix_plus_com<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Infinite_Sequences-stake_append"><span class="command">lemma</span></span> stake_append<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>min <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="free">u</span> <span class="main">@</span> stake <span class="main">(</span><span class="free">n</span> <span class="main">-</span> length <span class="free">u</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Infinite_Sequences-stake_shift_stake_shift"><span class="command">lemma</span></span> stake_shift_stake_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stake <span class="free">i</span> <span class="free">σ</span> <span class="main">@-</span> stake <span class="free">j</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span> <span class="main">@-</span> <span class="free">β</span> <span class="main">=</span> stake <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="free">σ</span> <span class="main">@-</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def plus_1_eq_Suc suffix_plus_com<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Infinite_Sequences-stake_suffix_drop"><span class="command">lemma</span></span> stake_suffix_drop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stake <span class="free">i</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">j</span> <span class="main">(</span>stake <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj length_stake semiring_normalization_rules<span class="main"><span class="main">(</span></span>24<span class="main"><span class="main">)</span></span> stake_add<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-stake_suffix"><span class="command">lemma</span></span> stake_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">j</span> <span class="free">σ</span> <span class="main">@-</span> <span class="free">u</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span> <span class="main">=</span> <span class="free">σ</span><span class="main">(</span><span class="free">i</span> <span class="main">→</span> <span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">@-</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms stake_suffix_drop suffix_shift<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Decomposing safety and liveness \label{sec:infinite_sequences-safety-liveness}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Famously properties on infinite sequences can be decomposed into
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span> ‹safety›<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span> ‹liveness›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
properties <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "AlpernSchneider:1985" <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> "Schneider:1987"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. See
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "Kindler:1994"<span class="antiquote"><span class="antiquote">}</span></span></span></span> for an overview.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safety</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safety</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">¬</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">β</span><span class="main">.</span> <span class="main">¬</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>stake <span class="bound">i</span> <span class="bound">σ</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-safety_def2"><span class="command">lemma</span></span> safety_def2<span class="main">:</span> <span class="comment1">― ‹Contraposition gives the customary prefix-closure definition›</span>
  <span class="quoted"><span class="quoted">"safety <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>stake <span class="bound">i</span> <span class="bound">σ</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> safety_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">liveness</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liveness</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">α</span> <span class="main">@-</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> safetyI <span class="main">=</span> iffD2<span class="main">[</span><span class="operator">OF</span> safety_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> safetyI2 <span class="main">=</span> iffD2<span class="main">[</span><span class="operator">OF</span> safety_def2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> livenessI <span class="main">=</span> iffD2<span class="main">[</span><span class="operator">OF</span> liveness_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="Infinite_Sequences-safety_False"><span class="command">lemma</span></span> safety_False<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safetyI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Infinite_Sequences-safety_True"><span class="command">lemma</span></span> safety_True<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safetyI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Infinite_Sequences-safety_state_prop"><span class="command">lemma</span></span> safety_state_prop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safetyI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Infinite_Sequences-safety_invariant"><span class="command">lemma</span></span> safety_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> safetyI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> length_stake lessI shift_snth_less stake_nth<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Infinite_Sequences-safety_transition_relation"><span class="command">lemma</span></span> safety_transition_relation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> safetyI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc_eq_plus1 add.left_neutral add_Suc_right add_diff_cancel_left' le_add1 list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> shift_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> stake.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stake_suffix suffix_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Infinite_Sequences-safety_conj"><span class="command">lemma</span></span> safety_conj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> safety_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Infinite_Sequences-safety_always_eventually"><span class="command">lemma</span></span> safety_always_eventually<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="main">0</span> <span class="main">→</span> <span class="bound">j</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> safety_def2
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="improper">j</span> <span class="free">σ</span> <span class="main">@-</span> <span class="improper">β</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift_stake_shift stake_suffix<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Infinite_Sequences-safety_disj"><span class="command">lemma</span></span> safety_disj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> safety_def2 <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> safety_always_eventually add_diff_cancel_right' diff_le_self le_add_same_cancel2<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The decomposition is given by a form of closure.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">M<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>stake <span class="bound">i</span> <span class="bound">σ</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Safe</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> M<span class="hidden">⇩</span><sub>p</sub> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Live</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Live</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span>M<span class="hidden">⇩</span><sub>p</sub> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-decomp"><span class="command">lemma</span></span> decomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span>Safe <span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> Live <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Safe_def Live_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Infinite_Sequences-safe"><span class="command">lemma</span></span> safe<span class="main">:</span>
  <span class="quoted"><span class="quoted">"safety <span class="main">(</span>Safe <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Safe_def safety_def M<span class="hidden">⇩</span><sub>p</sub>_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Infinite_Sequences-live"><span class="command">lemma</span></span> live<span class="main">:</span>
  <span class="quoted"><span class="quoted">"liveness <span class="main">(</span>Live <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> livenessI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">α</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">γ</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> length <span class="skolem">α</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">γ</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="main">(</span>stake <span class="bound">i</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">γ</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="main">(</span>stake <span class="bound">i</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">γ</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span>stake <span class="bound">i</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">γ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> Live <span class="free">P</span> <span class="main">(</span><span class="skolem">α</span> <span class="main">@-</span> <span class="bound">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Live_def M<span class="hidden">⇩</span><sub>p</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Sistla:1994"<span class="antiquote"><span class="antiquote">}</span></span></span></span> proceeds to give a topological analysis of fairness. An <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹absolute›</span></span>
liveness property is a liveness property whose complement is stable.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">absolute_liveness</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">― ‹ closed under prepending any finite sequence ›</span>
  <span class="quoted"><span class="quoted">"<span class="free">absolute_liveness</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span> <span class="bound">α</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">α</span> <span class="main">@-</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">― ‹ closed under suffixes ›</span>
  <span class="quoted"><span class="quoted">"<span class="free">stable</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-absolute_liveness_liveness"><span class="command">lemma</span></span> absolute_liveness_liveness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"absolute_liveness <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"liveness <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> absolute_liveness_def liveness_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Infinite_Sequences-stable_absolute_liveness"><span class="command">lemma</span></span> stable_absolute_liveness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">P</span> <span class="free">σ'</span>"</span></span> <span class="comment1">―‹ extra hypothesis ›</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stable <span class="free">P</span> <span class="main">⟷</span> absolute_liveness <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stable_def absolute_liveness_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cancel_comm_monoid_add_class.diff_cancel drop_eq_Nil order_refl shift.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> suffix_shift suffix_zero<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> stake_suffix_id<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*
text‹

Fairness ala Sistla. Unmotivated.

FIXME safety properties are insensitive to fairness.
FIXME typically we prove ‹sys ⟶ safety›. The result below doesn't appear strong enough.
FIXME observe fairness is a special liveness property.

›
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fairness</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fairness</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> stable <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> absolute_liveness <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-fairness_safety"><span class="command">lemma</span></span> fairness_safety<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fairness <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">F</span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">unfolding</span></span> safety_def fairness_def stable_def absolute_liveness_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="LTL">
<div class="head">
<h1>Theory LTL</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> LTL
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CIMP_pred.html">CIMP_pred</a>
  <a href="Infinite_Sequences.html">Infinite_Sequences</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ Linear Temporal Logic \label{sec:ltl}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To talk about liveness we need to consider infinitary behaviour on
sequences. Traditionally future-time linear temporal logic (LTL) is used to do
this <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "MannaPnueli:1991" <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> "OwickiLamport:1982"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The following is a straightforward shallow embedding of the
now-traditional anchored semantics of LTL <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "MannaPnueli:1988"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Some of it is adapted
from the sophisticated TLA development in the AFP due to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "TLA-AFP"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Unlike <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "Lamport:2002"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, include the
next operator, which is convenient for stating rules. Sometimes it allows us to
ignore the system, i.e. to state rules as temporally valid
(LTL-valid) rather than just temporally program valid (LTL-cimp-), in Jackson's terminology.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_prop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span>_<span class="keyword1">⌉</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌈</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⌉</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">σ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">○</span>_"</span> <span class="main">[</span>80<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">○</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">always</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">□</span>_"</span> <span class="main">[</span>80<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">□</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">until</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">𝒰</span>"</span> 30<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">(* FIXME priority, binds tighter than <span class="hidden">❙</span><b>⟶</b> *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">𝒰</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eventually</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">◇</span>_"</span> <span class="main">[</span>80<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">(* FIXME priority, consider making an abbreviation *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">◇</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>True<span class="main">⟩</span> <span class="keyword1">𝒰</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">release</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">ℛ</span>"</span> 30<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">(* FIXME priority, dual of Until *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">ℛ</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">𝒰</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unless</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">𝒲</span>"</span> 30<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">(* FIXME priority, aka weak until *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">𝒲</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">𝒰</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">□</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_always_imp_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>↪</b></span>"</span> 25<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>↪</b></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">□</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> defs <span class="main">=</span>
  state_prop_def
  always_def
  eventually_def
  next_def
  release_def
  unless_def
  until_def

<span class="keyword1" id="LTL-suffix_state_prop"><span class="command">lemma</span></span> suffix_state_prop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL-alwaysI"><span class="command">lemma</span></span> alwaysI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-alwaysD"><span class="command">lemma</span></span> alwaysD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-alwaysE"><span class="command">lemma</span></span> alwaysE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-always_induct"><span class="command">lemma</span></span> always_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">○</span><span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> alwaysI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL-seq_comp"><span class="command">lemma</span></span> seq_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> seq_pred"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">□</span><span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">◇</span><span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">𝒲</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="LTL-nextI"><span class="command">lemma</span></span> nextI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">○</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL-untilI"><span class="command">lemma</span></span> untilI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-untilE"><span class="command">lemma</span></span> untilE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> until_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-eventuallyI"><span class="command">lemma</span></span> eventuallyI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eventually_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-eventuallyE"><span class="command">lemma</span></span> eventuallyE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> untilE<span class="main">)</span>

<span class="keyword1" id="LTL-unless_alwaysI"><span class="command">lemma</span></span> unless_alwaysI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span> <span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-unless_untilI"><span class="command">lemma</span></span> unless_untilI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-always_imp_refl"><span class="command">lemma</span></span> always_imp_refl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-always_imp_trans"><span class="command">lemma</span></span> always_imp_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-always_imp_mp"><span class="command">lemma</span></span> always_imp_mp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> suffix_zero<span class="main">)</span>

<span class="keyword1" id="LTL-always_imp_mp_suffix"><span class="command">lemma</span></span> always_imp_mp_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Some basic facts and equivalences, mostly sanity.

›</span></span>

<span class="keyword1" id="LTL-necessitation"><span class="command">lemma</span></span> necessitation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-cong"><span class="command">lemma</span></span> cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">P'</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">P'</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">P'</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span><span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">P'</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">◇</span><span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">P'</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">○</span><span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">○</span><span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">P'</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">Q'</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P'</span> <span class="keyword1">𝒰</span> <span class="free">Q'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">P'</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">Q'</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P'</span> <span class="keyword1">𝒲</span> <span class="free">Q'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-norm"><span class="command">lemma</span></span> norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">⟨</span>False<span class="main">⟩</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="main">⌈</span><span class="free">p</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">p</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">p</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">⌈</span><span class="free">q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">q</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">p</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">⌈</span><span class="free">q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">q</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">p</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">⌈</span><span class="free">q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free">q</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">p</span><span class="main">⌉</span> <span class="free">σ</span> <span class="main">∧</span> <span class="main">⌈</span><span class="free">q</span><span class="main">⌉</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">q</span><span class="main">⌉</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">p</span><span class="main">⌉</span> <span class="free">σ</span> <span class="main">∨</span> <span class="main">⌈</span><span class="free">q</span><span class="main">⌉</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">q</span><span class="main">⌉</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">p</span><span class="main">⌉</span> <span class="free">σ</span> <span class="main">⟶</span> <span class="main">⌈</span><span class="free">q</span><span class="main">⌉</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free">q</span><span class="main">⌉</span> <span class="free">σ</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">○</span><span class="main">⟨</span>False<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">○</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="main">⟨</span>False<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="main">□</span> <span class="free">P</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">◇</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="main">□</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span> <span class="free">P</span><span class="main">)</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">⟨</span>False<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="main">◇</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">◇</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">◇</span> <span class="free">P</span><span class="main">)</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="main">⟨</span>False<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span> <span class="free">P</span><span class="main">)</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">P</span> <span class="keyword1">ℛ</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>False<span class="main">⟩</span> <span class="keyword1">𝒰</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="main">⟨</span>False<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="main">⟨</span>True<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>True<span class="main">⟩</span> <span class="keyword1">𝒰</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">◇</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="main">(</span><span class="free">P</span> <span class="keyword1">ℛ</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>False<span class="main">⟩</span> <span class="keyword1">ℛ</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">ℛ</span> <span class="main">⟨</span>False<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>True<span class="main">⟩</span> <span class="keyword1">ℛ</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">ℛ</span> <span class="main">⟨</span>True<span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>
<span class="comment1">(*
  "(P 𝒰 (P 𝒰 Q)) σ = (P 𝒰 Q) σ" FIXME for Release
*)</span>
<span class="keyword1"><span class="command">unfolding</span></span> defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> suffix_plus suffix_zero<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> suffix_plus suffix_zero<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_inverse_nat less_diff_conv2 not_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral not_less0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-always_conj_distrib"><span class="command">lemma</span></span> always_conj_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">□</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-eventually_disj_distrib"><span class="command">lemma</span></span> eventually_disj_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">◇</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">◇</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-always_eventually"><span class="command">lemma</span></span> always_eventually<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-eventually_imp_conv_disj"><span class="command">lemma</span></span> eventually_imp_conv_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">◇</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">P</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">◇</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-eventually_imp_distrib"><span class="command">lemma</span></span> eventually_imp_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">◇</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-unfold"><span class="command">lemma</span></span> unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span> <span class="free">P</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">○</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span> <span class="free">P</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">○</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">○</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">○</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">ℛ</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">○</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">ℛ</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.commute add_diff_inverse_nat less_one suffix_plus suffix_zero<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> One_nat_def add.right_neutral add_Suc_right lessI less_Suc_eq_0_disj suffix_plus suffix_zero<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> gr0_conv_Suc nat_neq_iff not_less_eq suffix_zero<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> suffix_zero<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> less_Suc_eq_0_disj <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> gr0_conv_Suc nat_neq_iff not_less0 suffix_zero<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> less_Suc_eq_0_disj <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> less_Suc_eq_0_disj <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-mono"><span class="command">lemma</span></span> mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟹</span>  <span class="free">P'</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">□</span><span class="free">P'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟹</span>  <span class="free">P'</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">◇</span><span class="free">P'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P'</span> <span class="keyword1">𝒰</span> <span class="free">Q'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P'</span> <span class="keyword1">𝒲</span> <span class="free">Q'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL-always_imp_mono"><span class="command">lemma</span></span> always_imp_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P'</span><span class="main">)</span> <span class="free">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">□</span><span class="free">P'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P'</span><span class="main">)</span> <span class="free">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">◇</span><span class="free">P'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P'</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q'</span><span class="main">)</span> <span class="free">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P'</span> <span class="keyword1">𝒰</span> <span class="free">Q'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P'</span><span class="main">)</span> <span class="free">σ</span><span class="main">;</span> <span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q'</span><span class="main">)</span> <span class="free">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P'</span> <span class="keyword1">𝒲</span> <span class="free">Q'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL-next_conj_distrib"><span class="command">lemma</span></span> next_conj_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">○</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">○</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">○</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-next_disj_distrib"><span class="command">lemma</span></span> next_disj_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">○</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">○</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">○</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-until_next_distrib"><span class="command">lemma</span></span> until_next_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">○</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">○</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="main">○</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="LTL-until_imp_eventually"><span class="command">lemma</span></span> until_imp_eventually<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">◇</span><span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-until_until_disj"><span class="command">lemma</span></span> until_until_disj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add_diff_inverse_nat nat_add_left_cancel_less<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-unless_unless_disj"><span class="command">lemma</span></span> unless_unless_disj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span> <span class="keyword1">𝒲</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">𝒲</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_inverse_nat leI less_diff_conv2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse_nat<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-until_conj_distrib"><span class="command">lemma</span></span> until_conj_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans nat_neq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-until_disj_distrib"><span class="command">lemma</span></span> until_disj_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="LTL-eventually_until"><span class="command">lemma</span></span> eventually_until<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="improper">x</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ex_least_nat_less<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-eventually_until_eventually"><span class="command">lemma</span></span> eventually_until_eventually<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">◇</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="LTL-eventually_unless_until"><span class="command">lemma</span></span> eventually_unless_until<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">◇</span><span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="LTL-eventually_always_imp_always_eventually"><span class="command">lemma</span></span> eventually_always_imp_always_eventually<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> suffix_commute<span class="main">)</span>

<span class="keyword1" id="LTL-eventually_always_next_stable"><span class="command">lemma</span></span> eventually_always_next_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> eventuallyI alwaysD always_induct eventuallyE norm<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LTL-next_stable_imp_eventually_always"><span class="command">lemma</span></span> next_stable_imp_eventually_always<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">◇</span><span class="main">□</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms eventually_always_next_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-always_eventually_always"><span class="command">lemma</span></span> always_eventually_always<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">◇</span><span class="main">□</span><span class="main">◇</span><span class="free">P</span> <span class="main">=</span> <span class="main">□</span><span class="main">◇</span><span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> add.left_commute semiring_normalization_rules<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* FIXME define "stable", develop more rules for it *)</span>
<span class="keyword1" id="LTL-stable_unless"><span class="command">lemma</span></span> stable_unless<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ex_least_nat_less<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">¬</span></span><span class="free"><span class="free">P</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span> <span class="keyword1"><span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right le_less less_Suc_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-unless_induct"><span class="command">lemma</span></span> unless_induct<span class="main">:</span> <span class="comment1">―‹ Rule \texttt{WAIT} from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">cite</span> [cite_macro=citet] ‹Fig~3.3› "MannaPnueli:1995"<span class="antiquote">}</span></span>›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="main">(</span><span class="free">I</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">I</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q</span> <span class="keyword1">𝒲</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> alwaysI impI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> alwaysD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> always_imp_mono<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> alwaysD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> stable_unless<span class="main"><span class="main">[</span></span><span class="operator">OF</span> I<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q alwaysD<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹ Leads-to and leads-to-via \label{sec:leads-to} ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Most of our assertions will be of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>⟶</b></span></span> <span class="main"><span class="main">◇</span></span><span class="free"><span class="free">C</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (pronounced ``<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> leads to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span>'')
or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>⟶</b></span></span> <span class="free"><span class="free">B</span></span> <span class="keyword1"><span class="keyword1">𝒰</span></span> <span class="free"><span class="free">C</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (``<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> leads to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> via <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B›</span></span></span></span>'').

Most of these rules are due to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"Jackson:1998"<span class="antiquote"><span class="antiquote">}</span></span></span></span> who used leads-to-via in a sequential setting. Others
are due to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "MannaPnueli:1991"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The leads-to-via connective is similar to the ``ensures'' modality of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] ‹\S3.4.4› "ChandyMisra:1989"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">leads_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>↝</b></span>"</span> 25<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">(* FIXME priority *)</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>↝</b></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">◇</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1" id="LTL-leads_to_refl"><span class="command">lemma</span></span> leads_to_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> necessitation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> unfold<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LTL-leads_to_trans"><span class="command">lemma</span></span> leads_to_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LTL-leads_to_eventuallyE"><span class="command">lemma</span></span> leads_to_eventuallyE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL-leads_to_mono"><span class="command">lemma</span></span> leads_to_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P'</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P'</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">Q'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-leads_to_eventually"><span class="command">lemma</span></span> leads_to_eventually<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">◇</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">◇</span><span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alwaysI unfold<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LTL-leads_to_disj"><span class="command">lemma</span></span> leads_to_disj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL-leads_to_leads_to_viaE"><span class="command">lemma</span></span> leads_to_leads_to_viaE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">Q</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-leads_to_via_concl_weaken"><span class="command">lemma</span></span> leads_to_via_concl_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">R'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q</span> <span class="keyword1">𝒰</span> <span class="free">R'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LTL.defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="LTL-leads_to_via_trans"><span class="command">lemma</span></span> leads_to_via_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">B</span> <span class="keyword1">𝒰</span> <span class="free">C</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">D</span> <span class="keyword1">𝒰</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">(</span><span class="free">B</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">D</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> alwaysI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">D</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="free">E</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alwaysE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> untilE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> <span class="comment1">(* suffix *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> always_imp_mp_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> untilE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> <span class="comment1">(* suffix *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ia</span> <span class="main">+</span> <span class="improper">iaa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> untilI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.assoc leI le_Suc_ex nat_add_left_cancel_less<span class="main">)</span> <span class="comment1">(* arithmetic *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL-leads_to_via_disj"><span class="command">lemma</span></span> leads_to_via_disj<span class="main">:</span> <span class="comment1">― ‹ useful for case distinctions ›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P'</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">Q'</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">P'</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">(</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q'</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="free">R</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 10 0<span class="main">)</span>

<span class="keyword1" id="LTL-leads_to_via_disj'"><span class="command">lemma</span></span> leads_to_via_disj'<span class="main">:</span> <span class="comment1">― ‹ more like a chaining rule ›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">B</span> <span class="keyword1">𝒰</span> <span class="free">C</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">D</span> <span class="keyword1">𝒰</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">C</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">(</span><span class="free">B</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">D</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> alwaysI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">D</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="free">E</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alwaysE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> untilE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> <span class="comment1">(* suffix *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> always_imp_mp_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> untilE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> <span class="comment1">(* suffix *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ia</span> <span class="main">+</span> <span class="improper">iaa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> untilI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.assoc leI le_Suc_ex nat_add_left_cancel_less<span class="main">)</span> <span class="comment1">(* arithmetic *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">D</span><span class="main">)</span> <span class="keyword1">𝒰</span> <span class="free">E</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alwaysE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL-leads_to_via_stable_augmentation"><span class="command">lemma</span></span> leads_to_via_stable_augmentation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> stable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P</span> <span class="keyword1">𝒰</span> <span class="free">C</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">P</span> <span class="keyword1">𝒰</span> <span class="main">(</span><span class="free">C</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> alwaysI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> AP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that stable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> U AP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒰</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">C</span> <span class="bound">σ</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL-leads_to_via_wf"><span class="command">lemma</span></span> leads_to_via_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> indhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">⌈</span><span class="free">δ</span> <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="bound">t</span><span class="main">⟩</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">B</span> <span class="keyword1">𝒰</span> <span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">⌈</span><span class="free">δ</span> <span class="main"><span class="hidden">❙</span><b>⊗</b></span> <span class="main">⟨</span><span class="bound">t</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∈</b></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">B</span> <span class="keyword1">𝒰</span> <span class="free">C</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> alwaysI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="keyword1">𝒰</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> indhyp<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alwaysD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> untilE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> j<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> untilE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> j k<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">+</span> <span class="improper">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> untilI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.assoc add.commute add_diff_inverse_nat less_diff_conv2 not_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The well-founded response rule due to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] ‹Fig~1.23: \texttt{WELL} (well-founded response)›"MannaPnueli:2010"<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
generalised to an arbitrary set of assertions and sequence predicates.
<span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>W1›</span></span></span></span> generalised to be contingent.
<span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>W2›</span></span></span></span> is a well-founded set of assertions that by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>W1›</span></span></span></span> includes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>

›</span></span>

<span class="comment1">(* FIXME: Does ‹Is› need to be consistent? *)</span>
<span class="keyword1" id="LTL-leads_to_wf"><span class="command">lemma</span></span> leads_to_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> seq_pred <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">R</span> <span class="main">::</span> <span class="tfree">'b</span> rel<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> W1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>∃</b></span><span class="bound">φ</span><span class="main">.</span> <span class="main">⌈</span><span class="main">⟨</span><span class="bound">φ</span><span class="main">∈</span>fst <span class="main">`</span> <span class="free">Is</span><span class="main">⟩</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> W2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">δ</span><span class="main">)</span><span class="main">∈</span><span class="free">Is</span><span class="main">.</span> <span class="main">∃</span><span class="main">(</span><span class="bound">φ'</span><span class="main">,</span> <span class="bound">δ'</span><span class="main">)</span><span class="main">∈</span>insert <span class="main">(</span><span class="free">Q</span><span class="main">,</span> <span class="free">δ0</span><span class="main">)</span> <span class="free">Is</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">⌈</span><span class="bound">δ</span> <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="bound">t</span><span class="main">⟩</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="bound">φ'</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">⌈</span><span class="bound">δ'</span> <span class="main"><span class="hidden">❙</span><b>⊗</b></span> <span class="main">⟨</span><span class="bound">t</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∈</b></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="main">⌉</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">⌈</span><span class="skolem">δ</span> <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="skolem">t</span><span class="main">⟩</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">Q</span><span class="main">)</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Is</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span> <span class="skolem">δ</span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span> that W2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">δ</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> LTL.defs split_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> ab_semigroup_add_class.add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_eqD snd_conv surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> W1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alwaysI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> alwaysE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">using</span></span> alwaysD suffix_state_prop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Fairness›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A few renderings of weak fairness. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "vanGlabbeekHofner:2019"<span class="antiquote"><span class="antiquote">}</span></span></span></span> call this
"response to insistence" as a generalisation of weak fairness.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weakly_fair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weakly_fair</span> <span class="free"><span class="bound"><span class="entity">enabled</span></span></span> <span class="free"><span class="bound"><span class="entity">taken</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span><span class="free"><span class="bound"><span class="entity">enabled</span></span></span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">◇</span><span class="free"><span class="bound"><span class="entity">taken</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LTL-weakly_fair_def2"><span class="command">lemma</span></span> weakly_fair_def2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weakly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="main">=</span> <span class="main">□</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="main">□</span><span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">taken</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> weakly_fair_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> always_conj_distrib norm<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LTL-weakly_fair_def3"><span class="command">lemma</span></span> weakly_fair_def3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weakly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="main">=</span> <span class="main">(</span><span class="main">◇</span><span class="main">□</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">□</span><span class="main">◇</span><span class="free">taken</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> weakly_fair_def2
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="comment1">(* True, but can we get there deductively? *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.left_commute semiring_normalization_rules<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-weakly_fair_def4"><span class="command">lemma</span></span> weakly_fair_def4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weakly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="main">=</span> <span class="main">□</span><span class="main">◇</span><span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free">taken</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> weakly_fair_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="LTL-mp_weakly_fair"><span class="command">lemma</span></span> mp_weakly_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"weakly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="free">enabled</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">◇</span><span class="free">taken</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> weakly_fair_def <span class="keyword1"><span class="command">using</span></span> always_imp_mp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-always_weakly_fair"><span class="command">lemma</span></span> always_weakly_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">□</span><span class="main">(</span>weakly_fair <span class="free">enabled</span> <span class="free">taken</span><span class="main">)</span> <span class="main">=</span> weakly_fair <span class="free">enabled</span> <span class="free">taken</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> weakly_fair_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL-eventually_weakly_fair"><span class="command">lemma</span></span> eventually_weakly_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span><span class="main">(</span>weakly_fair <span class="free">enabled</span> <span class="free">taken</span><span class="main">)</span> <span class="main">=</span> weakly_fair <span class="free">enabled</span> <span class="free">taken</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> weakly_fair_def2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_eventually_always<span class="main">)</span>

<span class="keyword1" id="LTL-weakly_fair_weaken"><span class="command">lemma</span></span> weakly_fair_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">enabled'</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">enabled</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">taken</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">taken'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>weakly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span>  weakly_fair <span class="free">enabled'</span> <span class="free">taken'</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> weakly_fair_def defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>

<span class="keyword1" id="LTL-weakly_fair_unless_until"><span class="command">lemma</span></span> weakly_fair_unless_until<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>weakly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">enabled</span> <span class="keyword1">𝒲</span> <span class="free">taken</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">enabled</span> <span class="keyword1">𝒰</span> <span class="free">taken</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs weakly_fair_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-stable_leads_to_eventually"><span class="command">lemma</span></span> stable_leads_to_eventually<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">taken</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">(</span><span class="main">□</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main">◇</span><span class="free">taken</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ex_least_nat_less<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">¬</span></span> <span class="free"><span class="free">enabled</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span> <span class="keyword1"><span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right leI less_irrefl_nat<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-weakly_fair_stable_leads_to"><span class="command">lemma</span></span> weakly_fair_stable_leads_to<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>weakly_fair <span class="free">enabled</span> <span class="free">taken</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">taken</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>↝</b></span> <span class="free">taken</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> stable_leads_to_eventually<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> defs weakly_fair_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="LTL-weakly_fair_stable_leads_to_via"><span class="command">lemma</span></span> weakly_fair_stable_leads_to_via<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>weakly_fair <span class="free">enabled</span> <span class="free">taken</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">taken</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="free">enabled</span> <span class="keyword1">𝒰</span> <span class="free">taken</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> stable_unless<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> weakly_fair_unless_until<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Similarly for strong fairness. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "vanGlabbeekHofner:2019"<span class="antiquote"><span class="antiquote">}</span></span></span></span> call this
"response to persistence" as a generalisation of strong fairness.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strongly_fair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred <span class="main">⇒</span> <span class="tfree">'a</span> seq_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strongly_fair</span> <span class="free"><span class="bound"><span class="entity">enabled</span></span></span> <span class="free"><span class="bound"><span class="entity">taken</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span><span class="main">◇</span><span class="free"><span class="bound"><span class="entity">enabled</span></span></span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">◇</span><span class="free"><span class="bound"><span class="entity">taken</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LTL-strongly_fair_def2"><span class="command">lemma</span></span> strongly_fair_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strongly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="main">=</span> <span class="main">□</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="main">□</span><span class="main">(</span><span class="main">◇</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span><span class="free">taken</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> strongly_fair_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> weakly_fair_def weakly_fair_def2<span class="main">)</span>

<span class="keyword1" id="LTL-strongly_fair_def3"><span class="command">lemma</span></span> strongly_fair_def3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strongly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="main">=</span> <span class="main">(</span><span class="main">□</span><span class="main">◇</span><span class="free">enabled</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">□</span><span class="main">◇</span><span class="free">taken</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> strongly_fair_def2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> always_eventually_always weakly_fair_def2 weakly_fair_def3<span class="main">)</span>

<span class="keyword1" id="LTL-always_strongly_fair"><span class="command">lemma</span></span> always_strongly_fair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">□</span><span class="main">(</span>strongly_fair <span class="free">enabled</span> <span class="free">taken</span><span class="main">)</span> <span class="main">=</span> strongly_fair <span class="free">enabled</span> <span class="free">taken</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> strongly_fair_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL-eventually_strongly_fair"><span class="command">lemma</span></span> eventually_strongly_fair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">◇</span><span class="main">(</span>strongly_fair <span class="free">enabled</span> <span class="free">taken</span><span class="main">)</span> <span class="main">=</span> strongly_fair <span class="free">enabled</span> <span class="free">taken</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> strongly_fair_def2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_eventually_always<span class="main">)</span>

<span class="keyword1" id="LTL-strongly_fair_disj_distrib"><span class="command">lemma</span></span> strongly_fair_disj_distrib<span class="main">:</span> <span class="comment1">― ‹not true for <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>weakly_fair›</span></span>›</span>
  <span class="quoted"><span class="quoted">"strongly_fair <span class="main">(</span><span class="free">enabled1</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">enabled2</span><span class="main">)</span> <span class="free">taken</span> <span class="main">=</span> <span class="main">(</span>strongly_fair <span class="free">enabled1</span> <span class="free">taken</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> strongly_fair <span class="free">enabled2</span> <span class="free">taken</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> strongly_fair_def defs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-strongly_fair_imp_weakly_fair"><span class="command">lemma</span></span> strongly_fair_imp_weakly_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strongly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weakly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> strongly_fair_def3 weakly_fair_def3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_always_imp_always_eventually<span class="main">)</span>

<span class="keyword1" id="LTL-always_enabled_weakly_fair_strongly_fair"><span class="command">lemma</span></span> always_enabled_weakly_fair_strongly_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span><span class="free">enabled</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weakly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="free">σ</span> <span class="main">=</span> strongly_fair <span class="free">enabled</span> <span class="free">taken</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> strongly_fair_def3 strongly_fair_imp_weakly_fair unfold<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> weakly_fair_def3<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Safety and liveness \label{sec:ltl-safety-liveness}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "Sistla:1994"<span class="antiquote"><span class="antiquote">}</span></span></span></span> shows some characterisations
of LTL formulas in terms of safety and liveness. Note his <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(𝒰)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is actually <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(𝒲)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

See also <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "ChangMannaPnueli:1992"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1" id="LTL-safety_state_prop"><span class="command">lemma</span></span> safety_state_prop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safety_state_prop<span class="main">)</span>

<span class="keyword1" id="LTL-safety_Next"><span class="command">lemma</span></span> safety_Next<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="main">○</span><span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> defs safety_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> One_nat_def list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stake.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-safety_unless"><span class="command">lemma</span></span> safety_unless<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> safetyI2<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>stake <span class="skolem">i</span> <span class="skolem">σ</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∃</span><span class="bound">β</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="bound">i</span> <span class="main">→</span> <span class="bound">j</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹safety <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> safety_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unless_alwaysI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">β</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">k</span> <span class="main">→</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">β</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">u</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="main">¬</span><span class="free">P</span> <span class="main">(</span><span class="main">(</span>stake <span class="bound">i</span> <span class="skolem">σ</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_add stake_shift_stake_shift stake_suffix_drop suffix_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">u</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>stake <span class="bound">i</span> <span class="skolem">σ</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="main">(</span>stake <span class="bound">i</span> <span class="skolem">σ</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">p</span></span><span class="main">&lt;</span><span class="bound">m</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span>stake <span class="bound">i</span> <span class="skolem">σ</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">using</span></span> leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">u</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>stake <span class="bound">i</span> <span class="skolem">σ</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="bound">m</span> <span class="main">→</span> <span class="bound">i</span> <span class="main">-</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">p</span></span><span class="main">&lt;</span><span class="bound">m</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="bound">p</span> <span class="main">→</span> <span class="bound">i</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stake_suffix add_leE nat_less_le order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="bound">m</span> <span class="main">→</span> <span class="bound">n</span> <span class="main">-</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">p</span></span><span class="main">&lt;</span><span class="bound">m</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="bound">p</span> <span class="main">→</span> <span class="bound">n</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="bound">m</span> <span class="main">→</span> <span class="bound">n</span> <span class="main">-</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">p</span></span><span class="main">&lt;</span><span class="bound">m</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="bound">p</span> <span class="main">→</span> <span class="bound">n</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">@-</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_eventually_pigeonhole<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹safety <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹safety <span class="free">Q</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">𝒲</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.le_diff_conv2 add_leE safety_always_eventually<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL-safety_always"><span class="command">lemma</span></span> safety_always<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safety <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safety <span class="main">(</span><span class="main">□</span><span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> norm<span class="main"><span class="main">(</span></span>20<span class="main"><span class="main">)</span></span> safety_def safety_unless<span class="main">)</span>

<span class="keyword1" id="LTL-absolute_liveness_eventually"><span class="command">lemma</span></span> absolute_liveness_eventually<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"absolute_liveness <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">=</span> <span class="main">◇</span><span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> absolute_liveness_def defs
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cancel_comm_monoid_add_class.diff_cancel drop_eq_Nil order_refl shift.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> stake_suffix_id suffix_shift suffix_zero<span class="main">)</span>

<span class="keyword1" id="LTL-stable_always"><span class="command">lemma</span></span> stable_always<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stable <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">=</span> <span class="main">□</span><span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> stable_def defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> suffix_zero<span class="main">)</span>

<span class="comment1">(* FIXME Sistla's examples of stable properties are boring and follow directly from this lemma.
   FIXME the fairness "type of formulas" follow from the above and the fairness def. *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ‹weakly_fair›<span class="antiquote"><span class="antiquote">}</span></span></span></span> is a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ‹fairness›<span class="antiquote"><span class="antiquote">}</span></span></span></span> property requires some constraints on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>enabled›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>taken›</span></span></span></span>:
<span class="antiquoted"><span class="antiquoted">▪</span></span> it is reasonable to assume they are state formulas
<span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>taken›</span></span></span></span> must be satisfiable

›</span></span>

<span class="keyword1" id="LTL-fairness_weakly_fair"><span class="command">lemma</span></span> fairness_weakly_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">taken</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fairness <span class="main">(</span>weakly_fair <span class="main">⌈</span><span class="free">enabled</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">taken</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fairness_def stable_def absolute_liveness_def weakly_fair_def
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">.</span><span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alwaysD<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">.</span><span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> absolute_liveness_def absolute_liveness_eventually eventually_weakly_fair weakly_fair_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL-fairness_strongly_fair"><span class="command">lemma</span></span> fairness_strongly_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">taken</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fairness <span class="main">(</span>strongly_fair <span class="main">⌈</span><span class="free">enabled</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">taken</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fairness_def stable_def absolute_liveness_def strongly_fair_def
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">.</span><span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alwaysD<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">.</span><span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> absolute_liveness_def absolute_liveness_eventually eventually_weakly_fair weakly_fair_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="CIMP_lang">
<div class="head">
<h1>Theory CIMP_lang</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Copyright 2015, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> CIMP_lang
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CIMP_pred.html">CIMP_pred</a>
  <a href="LTL.html">LTL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹CIMP syntax and semantics \label{sec:cimp-syntax-semantics}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We define a small sequential programming language with synchronous
message passing primitives for describing the individual
processes. This has the advantage over raw transition systems in that
it is programmer-readable, includes sequential composition, supports a
program logic and VCG (\S\ref{sec:cimp-vcg}), etc. These processes are
composed in parallel at the top-level.

CIMP is inspired by IMP, as presented by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"Winskel:1993"<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"ConcreteSemantics:2014"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and the classical process algebras CCS
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citep] "Milner:1980" <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> "Milner:1989"<span class="antiquote"><span class="antiquote">}</span></span></span></span> and CSP
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citep] "Hoare:1985"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note that the algebraic
properties of this language have not been developed.

As we operate in a concurrent setting, we need to provide a small-step
semantics (\S\ref{sec:cimp-semantics}), which we give in the style of
\emph{structural operational semantics} (SOS) as popularised by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span>
[cite_macro=citet] "DBLP:journals/jlp/Plotkin04"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. The semantics of a
complete system (\S\ref{sec:cimp-system-steps}) is presently taken
simply to be the states reachable by interleaving the enabled steps of
the individual processes, subject to message passing rendezvous. We
leave a trace or branching semantics to future work.

This theory contains all the trusted definitions. The soundness of the other
theories supervenes upon this one.

›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Programs are represented using an explicit (deep embedding) of their
syntax, as the semantics needs to track the progress of multiple
threads of control. Each (atomic) \emph{basic command}
(\S\ref{sec:cimp-decompose}) is annotated with a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'location</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
which we use in our assertions (\S\ref{sec:cimp-control-predicates}).
These locations need not be unique, though in practice they likely
will be.

Processes maintain \emph{local states} of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'state</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. These
can be updated with arbitrary relations of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'state</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'state</span></span>
set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LocalOp›</span></span></span></span>, and conditions of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span>
bool"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are similarly shallowly embedded. This arrangement allows the
end-user to select their own level of atomicity.

The sequential composition operator and control constructs are
standard. We add the infinite looping construct <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Loop›</span></span></span></span> so we
can construct single-state reactive systems; this has implications for
fairness assertions.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> bexp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
  <span class="main">=</span> Request  <span class="quoted"><span class="quoted">"<span class="tfree">'location</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'question</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'answer</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span>        <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦃</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦄</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">Request</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ _"</span>  <span class="main">[</span>0<span class="main">,</span> 70<span class="main">,</span> 70<span class="main">]</span> 71<span class="main">)</span>
  <span class="main">|</span> Response <span class="quoted"><span class="quoted">"<span class="tfree">'location</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'question</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'answer</span><span class="main">)</span> set"</span></span>               <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦃</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦄</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">Response</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span>  <span class="main">[</span>0<span class="main">,</span> 70<span class="main">]</span> 71<span class="main">)</span>
  <span class="main">|</span> LocalOp  <span class="quoted"><span class="quoted">"<span class="tfree">'location</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span>                                       <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦃</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦄</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">LocalOp</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>0<span class="main">,</span> 70<span class="main">]</span> 71<span class="main">)</span>
  <span class="main">|</span> Cond1    <span class="quoted"><span class="quoted">"<span class="tfree">'location</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> bexp"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦃</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦄</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">IF</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">FI</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 71<span class="main">)</span>
  <span class="main">|</span> Cond2    <span class="quoted"><span class="quoted">"<span class="tfree">'location</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> bexp"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span>
                           <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span>             <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦃</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦄</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">IF</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">ELSE</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">FI</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 71<span class="main">)</span>
  <span class="main">|</span> Loop     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span>                           <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">LOOP</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">DO</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">OD</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span>  <span class="main">[</span>0<span class="main">]</span> 71<span class="main">)</span>
  <span class="main">|</span> While    <span class="quoted"><span class="quoted">"<span class="tfree">'location</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> bexp"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦃</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⦄</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">WHILE</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">DO</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">OD</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 71<span class="main">)</span>
  <span class="main">|</span> Seq      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span>                           <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">;;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 69<span class="main">)</span>
  <span class="main">|</span> Choose   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span>                           <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊕</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 68<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We provide a one-armed conditional as it is the common form and avoids
the need to discover a label for an internal <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SKIP›</span></span></span></span> and/or
trickier proofs about the VCG.

In contrast to classical process algebras, we have local state and
distinct request and response actions. These provide an interface to
Isabelle/HOL's datatypes that avoids the need for binding (ala the
$\pi$-calculus of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "Milner:1989"<span class="antiquote"><span class="antiquote">}</span></span></span></span>) or large
non-deterministic sums (ala CCS <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citep] ‹\S2.8›
"Milner:1980"<span class="antiquote"><span class="antiquote">}</span></span></span></span>). Intuitively the requester poses a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'question</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with
a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Request›</span></span></span></span> command, which upon rendezvous with a
responder's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Response›</span></span></span></span> command receives an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span>
<span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'answer</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'question</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a deterministic function of the
requester's local state, whereas responses can be
non-deterministic. Note that CIMP does not provide a notion of
channel; these can be modelled by a judicious choice of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span>
<span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'question</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We also provide a binary external choice operator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">‹Choose›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (infix <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">‹<span class="main"><span class="main">(⊕)</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
Internal choice can be recovered in combination with local operations
(see <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] ‹\S2.3› "Milner:1980"<span class="antiquote"><span class="antiquote">}</span></span></span></span>).

We abbreviate some common commands: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SKIP›</span></span></span></span> is a local
operation that does nothing, and the floor brackets simplify
deterministic <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LocalOp›</span></span></span></span>s. We also adopt some syntax magic from
Makarius's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Hoare›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Multiquote›</span></span></span></span> theories in the Isabelle/HOL
distribution.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SKIP_syn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span><span class="keyword1">SKIP</span>"</span> <span class="main">[</span>0<span class="main">]</span> 71<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="keyword1"><span class="free">SKIP</span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">DetLocalOp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span>
                                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span> <span class="keyword1">⌊</span>_<span class="keyword1">⌋</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">]</span> 71<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main"><span class="free">⌊</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⌋</span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_quote"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">«</span>_<span class="keyword1">»</span>"</span> <span class="main">[</span>0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="quoted">"_antiquote"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">´</span>_"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span>
  <span class="quoted">"_Assign"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> <span class="main">⇒</span> idt <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span> <span class="keyword1">´</span>_ <span class="keyword1">:=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 70<span class="main">]</span> 71<span class="main">)</span>
  <span class="quoted">"_NonDetAssign"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> <span class="main">⇒</span> idt <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span> <span class="keyword1">´</span>_ <span class="keyword1">:∈</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 70<span class="main">]</span> 71<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">NonDetAssign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'val</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'val</span> set<span class="main">)</span>
                                   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NonDetAssign</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">⟨</span><span class="bound">e</span><span class="main">⟩</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="bound">s</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="main">´</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span>"</span> <span class="main">=&gt;</span> <span class="quoted">"<span class="keyword1">CONST</span> DetLocalOp <span class="free">l</span> <span class="main">«</span><span class="main">´</span><span class="main">(</span>_update_name <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="main">_</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">»</span>"</span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="main">´</span><span class="free">x</span> <span class="main">:∈</span> <span class="free">es</span>"</span> <span class="main">=&gt;</span> <span class="quoted">"<span class="keyword1">CONST</span> NonDetAssign <span class="free">l</span> <span class="main">(</span>_update_name <span class="free">x</span><span class="main">)</span> <span class="main">«</span><span class="free">es</span><span class="main">»</span>"</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">antiquote_tr</span> <span class="entity">i</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_antiquote"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
          <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_antiquote"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">skip_antiquote_tr</span> <span class="entity">i</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">antiquote_tr</span> <span class="entity">i</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_antiquote"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">antiquote_tr</span> <span class="entity">i</span> <span class="entity">t</span> $ Bound <span class="entity">i</span>
      <span class="main">|</span> <span class="entity">antiquote_tr</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="entity">antiquote_tr</span> <span class="entity">i</span> <span class="entity">t</span> $ <span class="entity">antiquote_tr</span> <span class="entity">i</span> <span class="entity">u</span>
      <span class="main">|</span> <span class="entity">antiquote_tr</span> <span class="entity">i</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">antiquote_tr</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">t</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">antiquote_tr</span> <span class="main">_</span> <span class="entity">a</span> <span class="main">=</span> <span class="entity">a</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">skip_antiquote_tr</span> <span class="entity">i</span> <span class="main">(</span><span class="main">(</span><span class="entity">c</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_antiquote"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">c</span> $ <span class="entity">skip_antiquote_tr</span> <span class="entity">i</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">skip_antiquote_tr</span> <span class="entity">i</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">antiquote_tr</span> <span class="entity">i</span> <span class="entity">t</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">quote_tr</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span> <span class="main">=</span> Abs <span class="main">(</span><span class="inner_quoted">"s"</span><span class="main">,</span> dummyT<span class="main">,</span> <span class="entity">antiquote_tr</span> <span class="inner_numeral">0</span> <span class="main">(</span>Term.incr_boundvars <span class="inner_numeral">1</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">quote_tr</span> <span class="entity">ts</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"quote_tr"</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_quote"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">quote_tr</span><span class="main">)</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Process semantics \label{sec:cimp-semantics} ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Here we define the semantics of a single process's program. We begin
by defining the type of externally-visible behaviour:

›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">)</span> seq_label
  <span class="main">=</span> sl_Internal <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">τ</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
  <span class="main">|</span> sl_Send <span class="tfree"><span class="quoted"><span class="tfree">'question</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'answer</span></span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">«</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">»</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
  <span class="main">|</span> sl_Receive <span class="tfree"><span class="quoted"><span class="tfree">'question</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'answer</span></span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">»</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">«</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We define a \emph{labelled transition system} (an LTS) using an
execution-stack style of semantics that avoids special treatment of
the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SKIP›</span></span></span></span>s introduced by a traditional small step
semantics (such as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] ‹Chapter~14›
"Winskel:1993"<span class="antiquote"><span class="antiquote">}</span></span></span></span>) when a basic command is executed. This was suggested
by Thomas Sewell; <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "PittsAM:opespe"<span class="antiquote"><span class="antiquote">}</span></span></span></span> gave a
semantics to an ML-like language using this approach.

We record the location of the command that was executed to support
fairness constraints.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com list <span class="main">×</span> <span class="tfree">'location</span> option <span class="main">×</span> <span class="tfree">'state</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">small_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state
               <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">)</span> seq_label
               <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→⇘</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>55<span class="main">,</span> 0<span class="main">,</span> 56<span class="main">]</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Request</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="main">«</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">»</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="main">»</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">«</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">FI</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">FI</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">FI</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">FI</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> Choose1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Choose2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The following projections operate on local states. These should not
appear to the end-user.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cPGM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cPGM</span> <span class="main">≡</span> fst"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cTKN</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="tfree">'location</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cTKN</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cLST</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cLST</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹System steps \label{sec:cimp-system-steps}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A global state maps process names to process' local states. One might
hope to allow processes to have distinct types of local state, but
there remains no good solution yet in a simply-typed setting; see
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "DBLP:journals/entcs/SchirmerW09"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> global_state
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_states
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

An execution step of the overall system is either any enabled internal
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">τ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> step of any process, or a communication rendezvous between
two processes. For the latter to occur, a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "Request"<span class="antiquote"><span class="antiquote">}</span></span></span></span> action
must be enabled in process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "Response"<span class="antiquote"><span class="antiquote">}</span></span></span></span>
action in (distinct) process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where the request/response
labels <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">α</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">β</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (semantically) match.

We also track global communication history here to support assertional
reasoning (see \S\ref{sec:cimp-invariants}).

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">)</span> event <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'question</span> <span class="main">×</span> <span class="tfree">'answer</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">)</span> history <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">)</span> event list"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state <span class="main">=</span>
  GST <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> global_state"</span></span>
  HST <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">)</span> history"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="comment1">―‹ This is a predicate of the current state, so the successor state comes first. ›</span>
  <span class="entity">system_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> set
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state
              <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  LocalStep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> GST <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">ls'</span></span></span><span class="main">;</span> GST <span class="free"><span class="bound"><span class="entity">sh'</span></span></span> <span class="main">=</span> <span class="main">(</span>GST <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">ls'</span></span></span><span class="main">)</span><span class="main">;</span> HST <span class="free"><span class="bound"><span class="entity">sh'</span></span></span> <span class="main">=</span> HST <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">system_step</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">sh'</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>"</span></span>
<span class="main">|</span> CommunicationStep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> GST <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> →<span class="hidden">⇘</span><sub><span class="main">«</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">»</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">ls1'</span></span></span><span class="main">;</span> GST <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> →<span class="hidden">⇘</span><sub><span class="main">»</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">«</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">ls2'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">;</span>
                        GST <span class="free"><span class="bound"><span class="entity">sh'</span></span></span> <span class="main">=</span> <span class="main">(</span>GST <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">ls1'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">ls2'</span></span></span><span class="main">)</span><span class="main">;</span> HST <span class="free"><span class="bound"><span class="entity">sh'</span></span></span> <span class="main">=</span> HST <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">system_step</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">sh'</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

In classical process algebras matching communication actions yield
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ›</span></span></span></span> steps, which aids nested parallel composition
and the restriction operation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citep]
‹\S2.2› "Milner:1980"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. As CIMP does not provide either
we do not need to hide communication labels. In CCS/CSP it is not
clear how one reasons about the communication history, and it seems
that assertional reasoning about these languages is not well
developed.

›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We define predicates over communication histories and system states. These are uncurried to ease composition.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LST›</span></span></span></span> operator (written as a postfix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>↓›</span></span></span></span>) projects
the local states of the processes from a <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'answer</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'location</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'proc</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'question</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'state</span></span><span class="main"><span class="main">)</span></span> system_state›</span></span></span></span>, i.e. it
discards control location information.

Conversely the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LSTP›</span></span></span></span> operator lifts predicates over
local states into predicates over <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'answer</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'location</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'proc</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'question</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'state</span></span><span class="main"><span class="main">)</span></span> system_state›</span></span></span></span>.

Predicates that do not depend on control locations were termed <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span>
‹universal assertions›<span class="antiquote"><span class="antiquote">}</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
‹\S3.6› "DBLP:journals/acta/LevinG81"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state_pred
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_states <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LST</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state
                 <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_states"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">↓</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">↓</span></span> <span class="main">=</span> cLST <span class="main">∘</span> GST <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">LSTP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state_pred
                            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LSTP</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span><span class="main">↓</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Control predicates \label{sec:cimp-control-predicates}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Following <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"DBLP:journals/acta/Lamport80"<span class="antiquote"><span class="antiquote">}</span></span></span></span>\footnote{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"MannaPnueli:1995"<span class="antiquote"><span class="antiquote">}</span></span></span></span> also develop a theory of locations. I think
Lamport attributes control predicates to Owicki in her PhD thesis
(under Gries). I did not find a treatment of procedures. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span>
[cite_macro=citet] "MannaPnueli:1991"<span class="antiquote"><span class="antiquote">}</span></span></span></span> observe that a notation for
making assertions over sets of locations reduces clutter
significantly.}, we define the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>at›</span></span></span></span> predicate, which
holds of a process when control resides at that location. Due to
non-determinism processes can be <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>at›</span></span></span></span> a set of locations;
it is more like ``a statement with this location is enabled'', which
incidentally handles non-unique locations. Lamport's language is
deterministic, so he doesn't have this problem. This also allows him
to develop a stronger theory about his control predicates.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'location</span> label <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> set"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">atC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com <span class="main">⇒</span> <span class="tfree">'location</span> label"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Request</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">THEN</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">THEN</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">ELSE</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">DO</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="main">=</span> <span class="free">atC</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">atC</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atC</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">atC</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∪</span> <span class="free">atC</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">atCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com list <span class="main">⇒</span> <span class="tfree">'location</span> label"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atCs</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atCs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> atC <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We provide the following definitions to the end-user.

<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>AT›</span></span></span></span> maps process names to a predicate that is true of
locations where control for that process resides, and the abbreviation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>at›</span></span></span></span> provides a conventional
way to use it. The constant <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>atS›</span></span></span></span> specifies that control for process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> resides at one of
the given locations. This stands in for, and generalises, the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>in›</span></span></span></span> predicate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"DBLP:journals/acta/Lamport80"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'location</span> label"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">AT</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> atCs <span class="main">(</span>cPGM <span class="main">(</span>GST <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'location</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">at</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> AT <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'location</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atS</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">.</span> at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* FIXME rename, document, rules. Identifies a process's control state label precisely as one element of a set. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atLs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'location</span> label set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atLs</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">labels</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>AT <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">labels</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* FIXME rename, document. Identifies a process's control state label precisely. Relate atL to at/atS, ex/ *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">atL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'location</span> label <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atL</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">label</span></span></span> <span class="main">≡</span> atLs <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">label</span></span></span><span class="main">}</span>"</span></span>

<span class="comment1">(* FIXME rename, document. Processes are at the given labels. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atPLs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span> <span class="main">×</span> <span class="tfree">'location</span> label<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atPLs</span> <span class="free"><span class="bound"><span class="entity">pls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>∀</b></span><span class="bound">p</span> <span class="bound">label</span><span class="main">.</span> <span class="main">⟨</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">label</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">pls</span></span></span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> atL <span class="bound">p</span> <span class="bound">label</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The constant <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>taken›</span></span></span></span> provides a way of identifying which transition was taken. It is somewhat like
Lamport's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>after›</span></span></span></span>, but not quite due to the presence of non-determinism here. This does not work well
for invariants or preconditions.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">taken</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'location</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">taken</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> cTKN <span class="main">(</span>GST <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:cimp-termination}

A process is terminated if it not at any control location.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">terminated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">terminated</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> atL <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A complete system consists of one program per process, and a (global)
constraint on their initial local states. From these we can construct
the set of initial global states and all those reachable by system
steps (\S\ref{sec:cimp-system-steps}).

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> programs
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> pre_system <span class="main">=</span>
  PGMs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> programs"</span></span>
  INIT <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state_pred"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">initial_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'ext</span><span class="main">)</span> pre_system_ext
                   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> global_state
                   <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initial_state</span> <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> cPGM <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>PGMs <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> cTKN <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span> INIT <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="main">(</span>cLST <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We construct infinite runs of a system by allowing stuttering, i.e., arbitrary repetitions of states
following <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] ‹Chapter~8›"Lamport:2002"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, by taking the reflexive
closure of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> system_step<span class="antiquote"><span class="antiquote">}</span></span></span></span> relation. Therefore terminated
programs infinitely repeat their final state (but note our definition
of terminated processes in \S\ref{sec:cimp-termination}).

Some accounts define stuttering as the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span> ‹finite›<span class="antiquote"><span class="antiquote">}</span></span></span></span> repetition of states. With or without this constraint
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>prerun›</span></span></span></span> contains <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span> ‹junk›<span class="antiquote"><span class="antiquote">}</span></span></span></span> in the form of unfair runs, where particular processes do not progress.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">system_step_reflclp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state seq_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">system_step_reflclp</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">sh</span> <span class="bound">sh'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">pls</span><span class="main">.</span> system_step <span class="bound">pls</span> <span class="bound">sh'</span> <span class="bound">sh</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">prerun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'ext</span><span class="main">)</span> pre_system_ext
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state seq_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prerun</span> <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> initial_state <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="main">(</span>GST <span class="main">(</span><span class="bound">σ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> HST <span class="main">(</span><span class="bound">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">□</span>system_step_reflclp<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="comment1">―‹ state-based invariants only ›</span>
  <span class="entity">prerun_valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'ext</span><span class="main">)</span> pre_system_ext
                   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span></span> _"</span> <span class="main">[</span>11<span class="main">,</span> 0<span class="main">]</span> 11<span class="main">)</span> <span class="comment1">(* FIXME priorities *)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sys</span></span></span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> prerun <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">□</span><span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">⌉</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>run›</span></span></span></span> of a system is a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ‹prerun›<span class="antiquote"><span class="antiquote">}</span></span></span></span> that satisfies the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FAIR›</span></span></span></span> requirement.
Typically this would include <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span> ‹weak fairness›<span class="antiquote"><span class="antiquote">}</span></span></span></span> for every transition of every process.

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> pre_system"</span></span>
<span class="main">+</span> FAIR <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state seq_pred"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system
       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state seq_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="main">=</span> <span class="main">(</span>prerun <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> FAIR <span class="free"><span class="bound"><span class="entity">sys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system
                   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> system_state seq_pred <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊨</span> _"</span> <span class="main">[</span>11<span class="main">,</span> 0<span class="main">]</span> 11<span class="main">)</span> <span class="comment1">(* FIXME priorities *)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> run <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="CIMP_vcg">
<div class="head">
<h1>Theory CIMP_vcg</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Copyright 2015, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> CIMP_vcg
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CIMP_lang.html">CIMP_lang</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ State-based invariants \label{sec:cimp-invariants} ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We provide a simple-minded verification condition generator (VCG) for this language, providing
support for establishing state-based invariants. It is just one way of reasoning about CIMP programs
and is proven sound wrt to the CIMP semantics.

Our approach follows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"DBLP:journals/acta/Lamport80" <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> "DBLP:journals/toplas/LamportS84"<span class="antiquote"><span class="antiquote">}</span></span></span></span>
(and the later <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "Lamport:2002"<span class="antiquote"><span class="antiquote">}</span></span></span></span>) and closely
related work by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "AptFrancezDeRoever:1980"<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "CousotCousot:1980"<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span>
[cite_macro=citet] "DBLP:journals/acta/LevinG81"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, who suggest the
incorporation of a history variable. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"CousotCousot:1980"<span class="antiquote"><span class="antiquote">}</span></span></span></span> apparently contains a completeness proof.
Lamport mentions that this technique was well-known in the mid-80s
when he proposed the use of prophecy variables\footnote{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span>
"https://lamport.azurewebsites.net/pubs/pubs.html"<span class="antiquote"><span class="antiquote">}</span></span></span></span>}. See also <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span>
[cite_macro=citet] "deRoeverEtAl:2001"<span class="antiquote"><span class="antiquote">}</span></span></span></span> for an extended discussion of
some of this.

›</span></span>

<span class="keyword1"><span class="command">declare</span></span> small_step.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> small_step_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">Request</span> <span class="free">action</span> <span class="free">val</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="free">action</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="free">R</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">FI</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span> <span class="keyword1">FI</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>

<span class="keyword1" id="CIMP_vcg-small_step_stuck"><span class="command">lemma</span></span> small_step_stuck<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> small_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> system_step.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

By default we ask the simplifier to rewrite <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "atS"<span class="antiquote"><span class="antiquote">}</span></span></span></span> using
ambient <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "AT"<span class="antiquote"><span class="antiquote">}</span></span></span></span> information.

›</span></span>

<span class="keyword1" id="CIMP_vcg-atS_state_weak_cong"><span class="command">lemma</span></span> atS_state_weak_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"AT <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> AT <span class="free">s'</span> <span class="free">p</span> <span class="main">⟹</span> atS <span class="free">p</span> <span class="free">ls</span> <span class="free">s</span> <span class="main">⟷</span> atS <span class="free">p</span> <span class="free">ls</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atS_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We provide an incomplete set of basic rules for label sets.

›</span></span>

<span class="keyword1" id="CIMP_vcg-atS_simps"><span class="command">lemma</span></span> atS_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>atS <span class="free">p</span> <span class="main">{}</span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"atS <span class="free">p</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span> <span class="free">s</span> <span class="main">⟷</span> at <span class="free">p</span> <span class="free">l</span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>at <span class="free">p</span> <span class="free">l</span> <span class="free">s</span><span class="main">;</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">ls</span><span class="main">⟧</span> <span class="main">⟹</span> atS <span class="free">p</span> <span class="free">ls</span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">.</span> at <span class="free">p</span> <span class="bound">l</span> <span class="free">s</span> <span class="main">⟶</span> <span class="bound">l</span> <span class="main">∉</span> <span class="free">ls</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>atS <span class="free">p</span> <span class="free">ls</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atS_def<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-atS_mono"><span class="command">lemma</span></span> atS_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>atS <span class="free">p</span> <span class="free">ls</span> <span class="free">s</span><span class="main">;</span> <span class="free">ls</span> <span class="main">⊆</span> <span class="free">ls'</span><span class="main">⟧</span> <span class="main">⟹</span> atS <span class="free">p</span> <span class="free">ls'</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atS_def<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-atS_un"><span class="command">lemma</span></span> atS_un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atS <span class="free">p</span> <span class="main">(</span><span class="free">l</span> <span class="main">∪</span> <span class="free">l'</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟷</span> atS <span class="free">p</span> <span class="free">l</span> <span class="free">s</span> <span class="main">∨</span> atS <span class="free">p</span> <span class="free">l'</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atS_def<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-atLs_disj_union"><span class="command">lemma</span></span> atLs_disj_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>atLs <span class="free">p</span> <span class="free">label0</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> atLs <span class="free">p</span> <span class="free">label1</span><span class="main">)</span> <span class="main">=</span> atLs <span class="free">p</span> <span class="main">(</span><span class="free">label0</span> <span class="main">∪</span> <span class="free">label1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> atLs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CIMP_vcg-atLs_insert_disj"><span class="command">lemma</span></span> atLs_insert_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atLs <span class="free">p</span> <span class="main">(</span>insert <span class="free">l</span> <span class="free">label0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>atL <span class="free">p</span> <span class="free">l</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> atLs <span class="free">p</span> <span class="free">label0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CIMP_vcg-small_step_terminated"><span class="command">lemma</span></span> small_step_terminated<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> →<span class="hidden">⇘</span><sub><span class="free">x</span></sub><span class="hidden">⇙</span> <span class="free">s'</span> <span class="main">⟹</span> atCs <span class="main">(</span>fst <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> atCs <span class="main">(</span>fst <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> small_step<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CIMP_vcg-atC_not_empty"><span class="command">lemma</span></span> atC_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atC <span class="free">c</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CIMP_vcg-atCs_empty"><span class="command">lemma</span></span> atCs_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atCs <span class="free">cs</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atC_not_empty<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-terminated_no_commands"><span class="command">lemma</span></span> terminated_no_commands<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminated <span class="free">p</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> GST <span class="free">sh</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> atLs_def AT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atCs_empty prod.collapse singletonD<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-terminated_GST_stable"><span class="command">lemma</span></span> terminated_GST_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"system_step <span class="free">q</span> <span class="free">sh'</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminated <span class="free">p</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GST <span class="free">sh</span> <span class="free">p</span> <span class="main">=</span> GST <span class="free">sh'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> terminated_no_commands <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> small_step_stuck <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> system_step.cases<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-terminated_stable"><span class="command">lemma</span></span> terminated_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"system_step <span class="free">q</span> <span class="free">sh'</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminated <span class="free">p</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminated <span class="free">p</span> <span class="free">sh'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> atLs_def AT_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits
               <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> small_step_terminated
              <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> system_step.cases<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-system_step_pls_nonempty"><span class="command">lemma</span></span> system_step_pls_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"system_step <span class="free">pls</span> <span class="free">sh'</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">pls</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>

<span class="keyword1" id="CIMP_vcg-system_step_no_change"><span class="command">lemma</span></span> system_step_no_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"system_step <span class="free">ps</span> <span class="free">sh'</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GST <span class="free">sh'</span> <span class="free">p</span> <span class="main">=</span> GST <span class="free">sh</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>

<span class="keyword1" id="CIMP_vcg-initial_stateD"><span class="command">lemma</span></span> initial_stateD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"initial_state <span class="free">sys</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"AT <span class="main">(</span><span class="main">⦇</span>GST <span class="main">=</span> <span class="free">s</span><span class="main">,</span> HST <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> atC <span class="main">∘</span> PGMs <span class="free">sys</span> <span class="main">∧</span> INIT <span class="free">sys</span> <span class="main">(</span><span class="main">⦇</span>GST <span class="main">=</span> <span class="free">s</span><span class="main">,</span> HST <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span><span class="main">)</span><span class="main">↓</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">l</span><span class="main">.</span> <span class="main">¬</span>taken <span class="bound">p</span> <span class="bound">l</span> <span class="main">⦇</span>GST <span class="main">=</span> <span class="free">s</span><span class="main">,</span> HST <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> initial_state_def split_def o_def LST_def AT_def taken_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CIMP_vcg-initial_states_initial"><span class="command">lemma</span></span> initial_states_initial<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"initial_state <span class="free">sys</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"at <span class="free">p</span> <span class="free">l</span> <span class="main">(</span><span class="main">⦇</span>GST <span class="main">=</span> <span class="free">s</span><span class="main">,</span> HST <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">l</span> <span class="main">∈</span> atC <span class="main">(</span>PGMs <span class="free">sys</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> initial_state_def split_def AT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">reachable_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'ext</span><span class="main">)</span> pre_system_ext
                    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable_state</span> <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span> <span class="bound">i</span><span class="main">.</span> prerun <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="bound">σ</span> <span class="main">∧</span> <span class="bound">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CIMP_vcg-reachable_stateE"><span class="command">lemma</span></span> reachable_stateE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable_state <span class="free">sys</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">i</span><span class="main">.</span> prerun <span class="free">sys</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">σ</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">sh</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> reachable_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CIMP_vcg-prerun_reachable_state"><span class="command">lemma</span></span> prerun_reachable_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prerun <span class="free">sys</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable_state <span class="free">sys</span> <span class="main">(</span><span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prerun_def LTL.defs system_step_reflclp_def reachable_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CIMP_vcg-reachable_state_induct"><span class="command">lemma</span></span> reachable_state_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> init LocalStep CommunicationStep<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> reachable_state<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable_state <span class="free">sys</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> initial_state <span class="free">sys</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⦇</span>GST <span class="main">=</span> <span class="bound">s</span><span class="main">,</span> HST <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sh</span> <span class="bound">ls'</span> <span class="bound">p</span><span class="main">.</span> <span class="main">⟦</span>reachable_state <span class="free">sys</span> <span class="bound">sh</span><span class="main">;</span> <span class="free">P</span> <span class="bound">sh</span><span class="main">;</span> GST <span class="bound">sh</span> <span class="bound">p</span> →<span class="hidden">⇘</span><sub><span class="keyword1">τ</span></sub><span class="hidden">⇙</span> <span class="bound">ls'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⦇</span>GST <span class="main">=</span> <span class="main">(</span>GST <span class="bound">sh</span><span class="main">)</span><span class="main">(</span><span class="bound">p</span> <span class="main">:=</span> <span class="bound">ls'</span><span class="main">)</span><span class="main">,</span> HST <span class="main">=</span> HST <span class="bound">sh</span><span class="main">⦈</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sh</span> <span class="bound">ls1'</span> <span class="bound">ls2'</span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">α</span> <span class="bound">β</span><span class="main">.</span>
                 <span class="main">⟦</span>reachable_state <span class="free">sys</span> <span class="bound">sh</span><span class="main">;</span> <span class="free">P</span> <span class="bound">sh</span><span class="main">;</span>
                 GST <span class="bound">sh</span> <span class="bound">p1</span> →<span class="hidden">⇘</span><sub><span class="main">«</span><span class="bound">α</span><span class="main">,</span> <span class="bound">β</span><span class="main">»</span></sub><span class="hidden">⇙</span> <span class="bound">ls1'</span><span class="main">;</span> GST <span class="bound">sh</span> <span class="bound">p2</span> →<span class="hidden">⇘</span><sub><span class="main">»</span><span class="bound">α</span><span class="main">,</span> <span class="bound">β</span><span class="main">«</span></sub><span class="hidden">⇙</span> <span class="bound">ls2'</span><span class="main">;</span> <span class="bound">p1</span> <span class="main">≠</span> <span class="bound">p2</span> <span class="main">⟧</span>
                    <span class="main">⟹</span> <span class="free">P</span> <span class="main">⦇</span>GST <span class="main">=</span> <span class="main">(</span>GST <span class="bound">sh</span><span class="main">)</span><span class="main">(</span><span class="bound">p1</span> <span class="main">:=</span> <span class="bound">ls1'</span><span class="main">,</span> <span class="bound">p2</span> <span class="main">:=</span> <span class="bound">ls2'</span><span class="main">)</span><span class="main">,</span> HST <span class="main">=</span> HST <span class="bound">sh</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">α</span><span class="main">,</span> <span class="bound">β</span><span class="main">)</span><span class="main">]</span><span class="main">⦈</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">sh</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> r
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> reachable_stateE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prerun <span class="free">sys</span> <span class="skolem">σ</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹prerun <span class="free">sys</span> <span class="skolem">σ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> prerun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> i old.unit.exhaust system_state.surjective<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹prerun <span class="free">sys</span> <span class="skolem">σ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prerun_def LTL.defs system_step_reflclp_def reachable_state_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> system_step.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹prerun <span class="free">sys</span> <span class="skolem">σ</span>›</span></span> l old.unit.exhaust prerun_reachable_state system_state.surjective<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹prerun <span class="free">sys</span> <span class="skolem">σ</span>›</span></span> c old.unit.exhaust prerun_reachable_state system_state.surjective<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CIMP_vcg-prerun_valid_TrueI"><span class="command">lemma</span></span> prerun_valid_TrueI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prerun_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CIMP_vcg-prerun_valid_conjI"><span class="command">lemma</span></span> prerun_valid_conjI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prerun_valid_def always_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CIMP_vcg-valid_prerun_lift"><span class="command">lemma</span></span> valid_prerun_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> <span class="main">⊨</span> <span class="main">□</span><span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prerun_valid_def valid_def run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CIMP_vcg-prerun_valid_induct"><span class="command">lemma</span></span> prerun_valid_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> prerun <span class="free">sys</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> prerun <span class="free">sys</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">(</span><span class="main">○</span><span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prerun_valid_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_induct<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-prerun_validI"><span class="command">lemma</span></span> prerun_validI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> reachable_state <span class="free">sys</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prerun_valid_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alwaysI prerun_reachable_state<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-prerun_validE"><span class="command">lemma</span></span> prerun_validE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable_state <span class="free">sys</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prerun_valid_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alwaysE reachable_stateE suffix_state_prop<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Relating reachable states to the initial programs \label{sec:cimp-decompose-small-step}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To usefully reason about the control locations presumably embedded in
the single global invariant, we need to link the programs we have in
reachable state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> to the programs in the initial states. The
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fragments›</span></span></span></span> function decomposes the program into statements
that can be directly executed (\S\ref{sec:cimp-decompose}). We also
compute the locations we could be at after executing that statement as
a function of the process's local state.

Eliding the bodies of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>IF›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>WHILE›</span></span></span></span> statements
yields smaller (but equivalent) proof obligations.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>  <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'location</span> set"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lconst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lconst</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lcond</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> set <span class="main">⇒</span> <span class="tfree">'location</span> set <span class="main">⇒</span> <span class="tfree">'state</span> bexp
                   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lcond</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">lp'</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">lp'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CIMP_vcg-lcond_split"><span class="command">lemma</span></span> lcond_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span>lcond <span class="free">lp</span> <span class="free">lp'</span> <span class="free">b</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">b</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="free">lp</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="free">b</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="free">lp'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lcond_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-lcond_split_asm"><span class="command">lemma</span></span> lcond_split_asm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span>lcond <span class="free">lp</span> <span class="free">lp'</span> <span class="free">b</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">Q</span> <span class="free">lp</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span><span class="free">b</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">Q</span> <span class="free">lp'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lcond_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> lcond_splits <span class="main">=</span> lcond_split lcond_split_asm

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">fragments</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
              <span class="main">⇒</span> <span class="tfree">'location</span> set
              <span class="main">⇒</span> <span class="main">(</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
               <span class="main">×</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp <span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fragments</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>
       <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="bound">c'</span> <span class="keyword1">FI</span><span class="main">,</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">|</span><span class="bound">c'</span><span class="main">.</span> True <span class="main">}</span>
        <span class="main">∪</span> <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fragments</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>
       <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="bound">c1'</span> <span class="keyword1">ELSE</span> <span class="bound">c2'</span> <span class="keyword1">FI</span><span class="main">,</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">|</span><span class="bound">c1'</span> <span class="bound">c2'</span><span class="main">.</span> True <span class="main">}</span>
        <span class="main">∪</span> <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">∪</span> <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fragments</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fragments</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>
       <span class="main">=</span>  <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="bound">c'</span> <span class="keyword1">OD</span><span class="main">,</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">|</span><span class="bound">c'</span><span class="main">.</span> True <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fragments</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fragments</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">∪</span> <span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fragments</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> lconst <span class="free"><span class="bound"><span class="entity">aft</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">fragmentsL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com list
               <span class="main">⇒</span> <span class="main">(</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                 <span class="main">×</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp <span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fragmentsL</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fragmentsL</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span> <span class="main">=</span> fragments <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fragmentsL</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> fragments <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="free">fragmentsL</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">fragmentsLS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state
               <span class="main">⇒</span> <span class="main">(</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                 <span class="main">×</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp <span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fragmentsLS</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> fragmentsL <span class="main">(</span>cPGM <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We show that taking system steps preserves fragments.

›</span></span>

<span class="keyword1" id="CIMP_vcg-small_step_fragmentsLS"><span class="command">lemma</span></span> small_step_fragmentsLS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fragmentsLS <span class="free">s'</span> <span class="main">⊆</span> fragmentsLS <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">cs</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-reachable_state_fragmentsLS"><span class="command">lemma</span></span> reachable_state_fragmentsLS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable_state <span class="free">sys</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fragmentsLS <span class="main">(</span>GST <span class="free">sh</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> fragments <span class="main">(</span>PGMs <span class="free">sys</span> <span class="free">p</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reachable_state_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> initial_state_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> small_step_fragmentsLS<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">basic_com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basic_com</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Request</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_com</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_com</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_com</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">FI</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_com</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">FI</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_com</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CIMP_vcg-fragments_basic_com"><span class="command">lemma</span></span> fragments_basic_com<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">aft'</span><span class="main">)</span> <span class="main">∈</span> fragments <span class="free">c</span> <span class="free">aft</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"basic_com <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">aft</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> basic_com.intros<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-fragmentsL_basic_com"><span class="command">lemma</span></span> fragmentsL_basic_com<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">aft'</span><span class="main">)</span> <span class="main">∈</span> fragmentsL <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"basic_com <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">cs</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fragments_basic_com<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To reason about system transitions we need to identify which basic
statement gets executed next. To that end we factor out the recursive
cases of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"small_step"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> semantics into \emph{contexts},
which isolate the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>basic_com›</span></span></span></span> commands with immediate
externally-visible behaviour. Note that non-determinism means that
more than one <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>basic_com›</span></span></span></span> can be enabled at a time.

The representation of evaluation contexts follows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span>
[cite_macro=citet] "DBLP:journals/jar/Berghofer12"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. This style of
operational semantics was originated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"FelleisenHieb:1992"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ctxt
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com<span class="main">)</span>
   <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ctxt set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  C_Hole<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id<span class="main">,</span> <span class="main">⟨</span><span class="main">[]</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_Loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fctxt</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c1</span><span class="main">.</span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">c1</span> <span class="keyword1">OD</span><span class="main">,</span> <span class="main">λ</span><span class="bound">c1</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">fctxt</span></span></span> <span class="bound">c1</span> <span class="main">@</span> <span class="main">[</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">c1</span> <span class="keyword1">OD</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_Seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fctxt</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c1</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">c1</span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="main">λ</span><span class="bound">c1</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">fctxt</span></span></span> <span class="bound">c1</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_Choose1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fctxt</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c1</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">c1</span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fctxt</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_Choose2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fctxt</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c2</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">c2</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fctxt</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can decompose a small step into a context and a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "basic_com"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">decompose_com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                      <span class="main">⇒</span> <span class="main">(</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                        <span class="main">×</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ctxt <span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decompose_com</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="bound">ictxt</span> <span class="bound">t</span> <span class="keyword1">OD</span><span class="main">,</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">fctxt</span> <span class="bound">t</span> <span class="main">@</span> <span class="main">[</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="bound">ictxt</span> <span class="bound">t</span> <span class="keyword1">OD</span><span class="main">]</span><span class="main">)</span> <span class="main">|</span><span class="bound">c</span> <span class="bound">fctxt</span> <span class="bound">ictxt</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">ictxt</span><span class="main">,</span> <span class="bound">fctxt</span><span class="main">)</span> <span class="main">∈</span> <span class="free">decompose_com</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose_com</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">ictxt</span> <span class="bound">t</span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">fctxt</span> <span class="bound">t</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">|</span><span class="bound">c</span> <span class="bound">fctxt</span> <span class="bound">ictxt</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">ictxt</span><span class="main">,</span> <span class="bound">fctxt</span><span class="main">)</span> <span class="main">∈</span> <span class="free">decompose_com</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose_com</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">ictxt</span> <span class="bound">t</span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="bound">fctxt</span><span class="main">)</span> <span class="main">|</span><span class="bound">c</span> <span class="bound">fctxt</span> <span class="bound">ictxt</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">ictxt</span><span class="main">,</span> <span class="bound">fctxt</span><span class="main">)</span> <span class="main">∈</span> <span class="free">decompose_com</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">}</span>
                           <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="bound">ictxt</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">fctxt</span><span class="main">)</span> <span class="main">|</span><span class="bound">c</span> <span class="bound">fctxt</span> <span class="bound">ictxt</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">ictxt</span><span class="main">,</span> <span class="bound">fctxt</span><span class="main">)</span> <span class="main">∈</span> <span class="free">decompose_com</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose_com</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> id<span class="main">,</span> <span class="main">⟨</span><span class="main">[]</span><span class="main">⟩</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">decomposeLS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> local_state
               <span class="main">⇒</span> <span class="main">(</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                 <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com<span class="main">)</span>
                 <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com list<span class="main">)</span> <span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decomposeLS</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> cPGM <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> <span class="bound">c</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> decompose_com <span class="bound">c</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CIMP_vcg-ctxt_inj"><span class="command">lemma</span></span> ctxt_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">fctxt</span><span class="main">)</span> <span class="main">∈</span> ctxt"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free">x</span> <span class="main">=</span> <span class="free">E</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> ctxt<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CIMP_vcg-decompose_com_non_empty"><span class="command">lemma</span></span> decompose_com_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose_com <span class="free">c</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CIMP_vcg-decompose_com_basic_com"><span class="command">lemma</span></span> decompose_com_basic_com<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">ctxts</span><span class="main">)</span> <span class="main">∈</span> decompose_com <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"basic_com <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">ctxts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> basic_com.intros<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-decomposeLS_basic_com"><span class="command">lemma</span></span> decomposeLS_basic_com<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">ctxts</span><span class="main">)</span> <span class="main">∈</span> decomposeLS <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"basic_com <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> decomposeLS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decompose_com_basic_com <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-decompose_com_ctxt"><span class="command">lemma</span></span> decompose_com_ctxt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">ctxts</span><span class="main">)</span> <span class="main">∈</span> decompose_com <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ctxts</span> <span class="main">∈</span> ctxt"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">ctxts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ctxt.intros<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-decompose_com_ictxt"><span class="command">lemma</span></span> decompose_com_ictxt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">ictxt</span><span class="main">,</span> <span class="free">fctxt</span><span class="main">)</span> <span class="main">∈</span> decompose_com <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ictxt</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">ictxt</span></span> <span class="quoted"><span class="free">fctxt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CIMP_vcg-decompose_com_small_step"><span class="command">lemma</span></span> decompose_com_small_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span> <span class="main">#</span> <span class="free">fctxt</span> <span class="free">c'</span> <span class="main">@</span> <span class="free">cs</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">ictxt</span><span class="main">,</span> <span class="free">fctxt</span><span class="main">)</span> <span class="main">∈</span> decompose_com <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> decompose_com_ctxt<span class="main">[</span><span class="operator">OF</span> ds<span class="main">]</span> as decompose_com_ictxt<span class="main">[</span><span class="operator">OF</span> ds<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ictxt</span></span> <span class="quoted"><span class="free">fctxt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ctxt_inj<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> context_decompose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">s'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">ictxt</span><span class="main">,</span> <span class="bound">fctxt</span><span class="main">)</span> <span class="main">∈</span> decomposeLS <span class="free">s</span><span class="main">.</span>
                     cPGM <span class="free">s</span> <span class="main">=</span> <span class="bound">ictxt</span> <span class="bound">c</span> <span class="main">#</span> tl <span class="main">(</span>cPGM <span class="free">s</span><span class="main">)</span>
                   <span class="main">∧</span> <span class="main">(</span><span class="bound">c</span> <span class="main">#</span> <span class="bound">fctxt</span> <span class="bound">c</span> <span class="main">@</span> tl <span class="main">(</span>cPGM <span class="free">s</span><span class="main">)</span><span class="main">,</span> cTKN <span class="free">s</span><span class="main">,</span> cLST <span class="free">s</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">s'</span>
                   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>atC <span class="bound">c</span><span class="main">.</span> cTKN <span class="free">s'</span> <span class="main">=</span> Some <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> decomposeLS_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_step.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Choose1 <span class="skolem">c1</span> <span class="skolem">cs</span> <span class="skolem">s</span> <span class="skolem">α</span> <span class="skolem">cs'</span> <span class="skolem">s'</span> <span class="skolem">c2</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c ictxt fctxt<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="improper">ictxt</span> <span class="bound">t</span> <span class="main">⊕</span> <span class="skolem">c2</span><span class="main">,</span> <span class="improper">fctxt</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Choose2 <span class="skolem">c2</span> <span class="skolem">cs</span> <span class="skolem">s</span> <span class="skolem">α</span> <span class="skolem">cs'</span> <span class="skolem">s'</span> <span class="skolem">c1</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c ictxt fctxt<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">c1</span> <span class="main">⊕</span> <span class="improper">ictxt</span> <span class="bound">t</span><span class="main">,</span> <span class="improper">fctxt</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> decomposeLS_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decompose_com_small_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

While we only use this result left-to-right (to decompose a small step
into a basic one), this equivalence shows that we lose no information
in doing so.

Decomposing a compound command preserves <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ‹fragments›<span class="antiquote"><span class="antiquote">}</span></span></span></span> too.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">loc_compC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com list
                            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">loc_compC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>atCs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loc_compC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loc_compC</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> lconst <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loc_compC</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>atCs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loc_compC</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> lconst <span class="main">(</span>atCs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CIMP_vcg-decompose_fragments"><span class="command">lemma</span></span> decompose_fragments<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">ictxt</span><span class="main">,</span> <span class="free">fctxt</span><span class="main">)</span> <span class="main">∈</span> decompose_com <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> loc_compC <span class="free">c</span> <span class="main">(</span><span class="free">fctxt</span> <span class="free">c</span> <span class="main">@</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> fragments <span class="free">c0</span> <span class="main">(</span>atCs <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c0</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">ictxt</span></span> <span class="quoted"><span class="free">fctxt</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Loop <span class="skolem">c01</span> <span class="skolem">c</span> <span class="skolem">ictxt</span> <span class="skolem">fctxt</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Loop.prems Loop.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">ictxt</span> <span class="skolem">c</span> <span class="main">#</span> <span class="skolem">cs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decompose_com_ictxt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">c01</span> <span class="skolem">c02</span> <span class="skolem">c</span> <span class="skolem">ictxt</span> <span class="skolem">fctxt</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Seq.prems Seq.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">c02</span> <span class="main">#</span> <span class="skolem">cs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CIMP_vcg-at_decompose"><span class="command">lemma</span></span> at_decompose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">ictxt</span><span class="main">,</span> <span class="free">fctxt</span><span class="main">)</span> <span class="main">∈</span> decompose_com <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atC <span class="free">c</span> <span class="main">⊆</span> atC <span class="free">c0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c0</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">ictxt</span></span> <span class="quoted"><span class="free">fctxt</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-at_decomposeLS"><span class="command">lemma</span></span> at_decomposeLS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">ictxt</span><span class="main">,</span> <span class="free">fctxt</span><span class="main">)</span> <span class="main">∈</span> decomposeLS <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atC <span class="free">c</span> <span class="main">⊆</span> atCs <span class="main">(</span>cPGM <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> decomposeLS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> at_decompose <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-decomposeLS_fragmentsLS"><span class="command">lemma</span></span> decomposeLS_fragmentsLS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">ictxt</span><span class="main">,</span> <span class="free">fctxt</span><span class="main">)</span> <span class="main">∈</span> decomposeLS <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> loc_compC <span class="free">c</span> <span class="main">(</span><span class="free">fctxt</span> <span class="free">c</span> <span class="main">@</span> tl <span class="main">(</span>cPGM <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> fragmentsLS <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cPGM <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms decompose_fragments<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">ds</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ds</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decomposeLS_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decomposeLS_def<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-small_step_loc_compC"><span class="command">lemma</span></span> small_step_loc_compC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"basic_com <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">ls'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"loc_compC <span class="free">c</span> <span class="free">cs</span> <span class="main">(</span>snd <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> atCs <span class="main">(</span>cPGM <span class="free">ls'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> basic_com.cases <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> small_step_inv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> lcond_splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The headline result allows us to constrain the initial and final states
of a given small step in terms of the original programs, provided the
initial state is reachable.

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> decompose_small_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GST <span class="free">sh</span> <span class="free">p</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">ps'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable_state <span class="free">sys</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="free">cs</span> <span class="free">aft</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">aft</span><span class="main">)</span> <span class="main">∈</span> fragments <span class="main">(</span>PGMs <span class="free">sys</span> <span class="free">p</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atC <span class="free">c</span> <span class="main">⊆</span> atCs <span class="main">(</span>cPGM <span class="main">(</span>GST <span class="free">sh</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">aft</span> <span class="main">(</span>cLST <span class="main">(</span>GST <span class="free">sh</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> atCs <span class="main">(</span>cPGM <span class="free">ps'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">cs</span><span class="main">,</span> cTKN <span class="main">(</span>GST <span class="free">sh</span> <span class="free">p</span><span class="main">)</span><span class="main">,</span> cLST <span class="main">(</span>GST <span class="free">sh</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> →<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">ps'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>atC <span class="free">c</span><span class="main">.</span> cTKN <span class="free">ps'</span> <span class="main">=</span> Some <span class="bound">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> context_decompose<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> decomposeLS_fragmentsLS<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> at_decomposeLS<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> reachable_state_fragmentsLS<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> decomposeLS_basic_com<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> small_step_loc_compC<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Reasoning by induction over the reachable states
with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] "decompose_small_step"<span class="antiquote"><span class="antiquote">}</span></span></span></span> is quite tedious. We
provide a very simple VCG that generates friendlier local proof
obligations in \S\ref{sec:vcg}.

›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Simple-minded Hoare Logic/VCG for CIMP \label{sec:vcg}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:cimp-vcg}

We do not develop a proper Hoare logic or full VCG for CIMP: this
machinery merely packages up the subgoals that arise from induction
over the reachable states (\S\ref{sec:cimp-invariants}). This is
somewhat in the spirit of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "Ridge:2009"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Note that this approach is not compositional: it consults the original
system to find matching communicating pairs, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>aft›</span></span></span></span>
tracks the labels of possible successor statements. More serious Hoare
logics are provided by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"DBLP:journals/acta/Lamport80" <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> "DBLP:journals/toplas/LamportS84"
<span class="quasi_keyword"><span class="quasi_keyword">and</span></span> "CousotCousot89-IC"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Intuitively we need to discharge a proof obligation for either <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span>
"Request"<span class="antiquote"><span class="antiquote">}</span></span></span></span>s or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "Response"<span class="antiquote"><span class="antiquote">}</span></span></span></span>s but not both. Here we choose to
focus on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "Request"<span class="antiquote"><span class="antiquote">}</span></span></span></span>s as we expect to have more local
information available about these.

›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">vcg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> programs
        <span class="main">⇒</span> <span class="tfree">'proc</span>
        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp
        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred
        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred
        <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span> _<span class="keyword1">,</span> _ <span class="keyword1">⊢</span><span class="keyword3">/ </span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_<span class="keyword3">/ </span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span> <span class="main">[</span>11<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 11<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">aft'</span> <span class="bound">action'</span> <span class="bound">s</span> <span class="bound">ps'</span> <span class="bound">p's'</span> <span class="bound">l'</span> <span class="bound">β</span> <span class="bound">s'</span> <span class="bound">p'</span><span class="main">.</span>
      <span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="bound">s</span><span class="main">;</span> <span class="main">(</span><span class="main">⦃</span><span class="bound">l'</span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="bound">action'</span><span class="main">,</span> <span class="bound">aft'</span><span class="main">)</span> <span class="main">∈</span> fragments <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coms</span></span></span> <span class="bound">p'</span><span class="main">)</span> <span class="main">{}</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> <span class="bound">p'</span><span class="main">;</span>
        <span class="bound">ps'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="bound">β</span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">p's'</span><span class="main">,</span> <span class="bound">β</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">action'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="bound">p'</span><span class="main">)</span><span class="main">;</span>
        at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s</span><span class="main">;</span> at <span class="bound">p'</span> <span class="bound">l'</span> <span class="bound">s</span><span class="main">;</span>
        AT <span class="bound">s'</span> <span class="main">=</span> <span class="main">(</span>AT <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">p'</span> <span class="main">:=</span> <span class="bound">aft'</span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s'</span><span class="main">↓</span> <span class="main">=</span> <span class="bound">s</span><span class="main">↓</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="bound">ps'</span><span class="main">,</span> <span class="bound">p'</span> <span class="main">:=</span> <span class="bound">p's'</span><span class="main">)</span><span class="main">;</span>
        taken <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s'</span><span class="main">;</span>
        HST <span class="bound">s'</span> <span class="main">=</span> HST <span class="bound">s</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">β</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>
        <span class="main">∀</span><span class="bound">p''</span><span class="main">∈</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="bound">p'</span><span class="main">}</span><span class="main">.</span> GST <span class="bound">s'</span> <span class="bound">p''</span> <span class="main">=</span> GST <span class="bound">s</span> <span class="bound">p''</span>
      <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span> <span class="bound">s'</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Request</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span> <span class="bound">ps'</span> <span class="bound">s'</span><span class="main">.</span>
      <span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="bound">s</span><span class="main">;</span> <span class="bound">ps'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
        at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s</span><span class="main">;</span>
        AT <span class="bound">s'</span> <span class="main">=</span> <span class="main">(</span>AT <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s'</span><span class="main">↓</span> <span class="main">=</span> <span class="bound">s</span><span class="main">↓</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="bound">ps'</span><span class="main">)</span><span class="main">;</span>
        taken <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s'</span><span class="main">;</span>
        HST <span class="bound">s'</span> <span class="main">=</span> HST <span class="bound">s</span><span class="main">;</span>
        <span class="main">∀</span><span class="bound">p''</span><span class="main">∈</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">.</span> GST <span class="bound">s'</span> <span class="bound">p''</span> <span class="main">=</span> GST <span class="bound">s</span> <span class="bound">p''</span>
      <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span> <span class="bound">s'</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
      <span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="bound">s</span><span class="main">;</span>
        at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s</span><span class="main">;</span>
        AT <span class="bound">s'</span> <span class="main">=</span> <span class="main">(</span>AT <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s'</span><span class="main">↓</span> <span class="main">=</span> <span class="bound">s</span><span class="main">↓</span><span class="main">;</span>
        taken <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s'</span><span class="main">;</span>
        HST <span class="bound">s'</span> <span class="main">=</span> HST <span class="bound">s</span><span class="main">;</span>
        <span class="main">∀</span><span class="bound">p''</span><span class="main">∈</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">.</span> GST <span class="bound">s'</span> <span class="bound">p''</span> <span class="main">=</span> GST <span class="bound">s</span> <span class="bound">p''</span>
      <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span> <span class="bound">s'</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">FI</span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
      <span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="bound">s</span><span class="main">;</span>
        at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s</span><span class="main">;</span>
        AT <span class="bound">s'</span> <span class="main">=</span> <span class="main">(</span>AT <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s'</span><span class="main">↓</span> <span class="main">=</span> <span class="bound">s</span><span class="main">↓</span><span class="main">;</span>
        taken <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s'</span><span class="main">;</span>
        HST <span class="bound">s'</span> <span class="main">=</span> HST <span class="bound">s</span><span class="main">;</span>
        <span class="main">∀</span><span class="bound">p''</span><span class="main">∈</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">.</span> GST <span class="bound">s'</span> <span class="bound">p''</span> <span class="main">=</span> GST <span class="bound">s</span> <span class="bound">p''</span>
      <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span> <span class="bound">s'</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">FI</span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
      <span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="bound">s</span><span class="main">;</span>
        at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s</span><span class="main">;</span>
        AT <span class="bound">s'</span> <span class="main">=</span> <span class="main">(</span>AT <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s'</span><span class="main">↓</span> <span class="main">=</span> <span class="bound">s</span><span class="main">↓</span><span class="main">;</span>
        taken <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">s'</span><span class="main">;</span>
        HST <span class="bound">s'</span> <span class="main">=</span> HST <span class="bound">s</span><span class="main">;</span>
        <span class="main">∀</span><span class="bound">p''</span><span class="main">∈</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">.</span> GST <span class="bound">s'</span> <span class="bound">p''</span> <span class="main">=</span> GST <span class="bound">s</span> <span class="bound">p''</span>
      <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span> <span class="bound">s'</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>
<span class="comment1">― ‹There are no proof obligations for the following commands, but including them makes some basic rules hold (\S\ref{sec:cimp:vcg_rules}):›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">⦄</span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We abbreviate invariance with one-sided validity syntax.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">valid_inv</span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span> _<span class="keyword1">,</span> _ <span class="keyword1">⊢</span><span class="keyword3">/ </span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>11<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 11<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">coms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">⦄</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">⦄</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> vcg_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">Request</span> <span class="free">action</span> <span class="free">val</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="free">f</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">t</span> <span class="keyword1">FI</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">t</span> <span class="keyword1">ELSE</span> <span class="free">e</span> <span class="keyword1">FI</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="main">⦃</span><span class="free">l</span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="free">action</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> Choose <span class="free">c1</span> <span class="free">c2</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We tweak <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "fragments"<span class="antiquote"><span class="antiquote">}</span></span></span></span> by omitting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "Response"<span class="antiquote"><span class="antiquote">}</span></span></span></span>s,
yielding fewer obligations

›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">vcg_fragments'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
               <span class="main">⇒</span> <span class="tfree">'location</span> set
               <span class="main">⇒</span> <span class="main">(</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                 <span class="main">×</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp <span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments'</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments'</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>
       <span class="main">=</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>
       <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="bound">c'</span> <span class="keyword1">FI</span><span class="main">,</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">|</span><span class="bound">c'</span><span class="main">.</span> True <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments'</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>
       <span class="main">=</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">∪</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>
       <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="bound">c1'</span> <span class="keyword1">ELSE</span> <span class="bound">c2'</span> <span class="keyword1">FI</span><span class="main">,</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">|</span><span class="bound">c1'</span> <span class="bound">c2'</span><span class="main">.</span> True <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments'</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments'</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">OD</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>
       <span class="main">=</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="bound">c'</span> <span class="keyword1">OD</span><span class="main">,</span> lcond <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">|</span><span class="bound">c'</span><span class="main">.</span> True <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">∪</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">(</span>atC <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">∪</span> <span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">aft</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> lconst <span class="free"><span class="bound"><span class="entity">aft</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">vcg_fragments</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                  <span class="main">⇒</span> <span class="main">(</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
                    <span class="main">×</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp <span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vcg_fragments</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> vcg_fragments' <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">isResponse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isResponse</span> <span class="main">(</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="free"><span class="bound"><span class="entity">action</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">isResponse</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1" id="CIMP_vcg-fragments_vcg_fragments'"><span class="command">lemma</span></span> fragments_vcg_fragments'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">aft</span><span class="main">)</span> <span class="main">∈</span> fragments <span class="free">c'</span> <span class="free">aft'</span><span class="main">;</span> <span class="main">¬</span>isResponse <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">aft</span><span class="main">)</span> <span class="main">∈</span> vcg_fragments' <span class="free">c'</span> <span class="free">aft'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">aft'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CIMP_vcg-vcg_fragments'_fragments"><span class="command">lemma</span></span> vcg_fragments'_fragments<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vcg_fragments' <span class="free">c'</span> <span class="free">aft'</span> <span class="main">⊆</span> fragments <span class="free">c'</span> <span class="free">aft'</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">aft'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 10 0<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg-VCG_step"><span class="command">lemma</span></span> VCG_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">aft</span><span class="main">)</span> <span class="main">∈</span> vcg_fragments <span class="main">(</span>PGMs <span class="free">sys</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> PGMs <span class="free">sys</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">pre</span><span class="main">⦄</span> <span class="bound">c</span> <span class="main">⦃</span><span class="free">post</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"system_step <span class="free">p</span> <span class="free">sh'</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable_state <span class="free">sys</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="free">sh'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> S
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> LocalStep <span class="keyword1"><span class="command">with</span></span> P <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> decompose_small_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ R<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> fragments_basic_com<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> basic_com.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fragments_vcg_fragments' V<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span>
                      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> small_step_inv
                      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LST_def AT_def taken_def fun_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> CommunicationStep <span class="keyword1"><span class="command">with</span></span> P <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> decompose_small_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ R<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> decompose_small_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ R<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> c cs aft c' cs' aft'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> fragments_basic_com<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> fragments_basic_com<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> basic_com.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> small_step_inv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fragments_vcg_fragments'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> V<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span>
                      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> small_step_inv
                      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LST_def AT_def taken_def fun_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The user sees the conclusion of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span> for each element of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ‹vcg_fragments›<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1" id="CIMP_vcg-VCG_step_inv_stable"><span class="command">lemma</span></span> VCG_step_inv_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">aft</span><span class="main">)</span> <span class="main">∈</span> vcg_fragments <span class="main">(</span>PGMs <span class="free">sys</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> PGMs <span class="free">sys</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">I</span><span class="main">⦄</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prerun <span class="free">sys</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>↪</b></span> <span class="main">○</span><span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alwaysI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nextI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> prerun_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> alwaysE<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> system_step_reflclp_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> VCG_step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">I</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> post<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">I</span></span><span class="main">]</span> V assms<span class="main">(</span>2<span class="main">)</span> prerun_reachable_state
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_vcg-VCG"><span class="command">lemma</span></span> VCG<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> initial_state <span class="free">sys</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">(</span><span class="main">⦇</span>GST <span class="main">=</span> <span class="bound">s</span><span class="main">,</span> HST <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">aft</span><span class="main">)</span> <span class="main">∈</span> vcg_fragments <span class="main">(</span>PGMs <span class="free">sys</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> PGMs <span class="free">sys</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free">I</span><span class="main">⦄</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sys</span> ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prerun_valid_induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prerun_def state_prop_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> I old.unit.exhaust system_state.surjective<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> VCG_step_inv_stable<span class="main">[</span><span class="operator">OF</span> V<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> VCG_valid <span class="main">=</span> valid_prerun_lift<span class="main">[</span><span class="operator">OF</span> VCG<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">sys</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">sys</span> <span class="free">I</span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="CIMP_vcg_rules">
<div class="head">
<h1>Theory CIMP_vcg_rules</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Copyright 2015, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> CIMP_vcg_rules
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CIMP_vcg.html">CIMP_vcg</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹ VCG rules \label{sec:cimp:vcg_rules} ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can develop some (but not all) of the familiar Hoare rules; see
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet] "DBLP:journals/acta/Lamport80"<span class="antiquote"><span class="antiquote">}</span></span></span></span> and the
seL4/l4.verified lemma buckets for inspiration. We avoid many of the
issues Lamport mentions as we only treat basic (atomic) commands.

›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">coms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> programs"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">aft</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> loc_comp"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">valid_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_syn</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="free">coms</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">aft</span> <span class="main">⊢</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⦄</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> valid_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_<span class="keyword3">/ </span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">valid_inv_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> state_pred
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'answer</span><span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'question</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_inv_syn</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⦄</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> valid_inv_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_"</span><span class="main">)</span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_True"><span class="command">lemma</span></span> vcg_True<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_conj"><span class="command">lemma</span></span> vcg_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⦃</span><span class="free">I</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span><span class="main">;</span> <span class="main">⦃</span><span class="free">I</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">R</span><span class="main">⦄</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">I</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">R</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_pre_imp"><span class="command">lemma</span></span> vcg_pre_imp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">;</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">R</span><span class="main">⦄</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">R</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> vcg_pre <span class="main">=</span> vcg_pre_imp<span class="main">[</span><span class="operator">rotated</span><span class="main">]</span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_post_imp"><span class="command">lemma</span></span> vcg_post_imp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">s</span><span class="main">;</span> <span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">R</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_prop"><span class="command">lemma</span></span> vcg_prop<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">⟨</span><span class="free">P</span><span class="main">⟩</span><span class="main">⦄</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_drop_imp"><span class="command">lemma</span></span> vcg_drop_imp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">R</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free">Q</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_conj_lift"><span class="command">lemma</span></span> vcg_conj_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P'</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q'</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>      <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">P'</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="free">Q'</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_conj<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_pre<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_pre<span class="main"><span class="main">[</span></span><span class="operator">OF</span> y<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_disj_lift"><span class="command">lemma</span></span> vcg_disj_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span>  <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P'</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q'</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>      <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">P'</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q'</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_imp_lift"><span class="command">lemma</span></span> vcg_imp_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P'</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">P</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Q'</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P'</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">Q'</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">P</span> <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="free">Q</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> imp_conv_disj vcg_disj_lift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_ex_lift"><span class="command">lemma</span></span> vcg_ex_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⦃</span><span class="free">P</span> <span class="bound">x</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span> <span class="bound">x</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_all_lift"><span class="command">lemma</span></span> vcg_all_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⦃</span><span class="free">P</span> <span class="bound">x</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span> <span class="bound">x</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_name_pre_state"><span class="command">lemma</span></span> vcg_name_pre_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="main">(=)</span> <span class="bound">s</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vcg_inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vcg.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CIMP_vcg_rules-vcg_lift_comp"><span class="command">lemma</span></span> vcg_lift_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> type<span class="main">)</span><span class="main">⦄</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⦃</span><span class="free">Q</span> <span class="bound">x</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">P</span> <span class="bound">x</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_name_pre_state<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_pre<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_post_imp<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_conj_lift<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> P<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">fs</span><span class="main">.</span> <span class="bound">fs</span> <span class="main">=</span> <span class="free">f</span> <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> f<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Cheap non-interference rules›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

These rules magically construct VCG lifting rules from the easier to
prove <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>eq_imp›</span></span></span></span> facts. We don't actually use these in the GC,
but we do derive <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "fun_upd"<span class="antiquote"><span class="antiquote">}</span></span></span></span> equations using the same
mechanism. Thanks to Thomas Sewell for the requisite syntax magic.

As these <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>eq_imp›</span></span></span></span> facts do not usefully compose, we make the
definition asymmetric (i.e., <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> does not get a bundle of
parameters).

Note that these are effectively parametricity rules.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_imp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_imp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CIMP_vcg_rules-eq_impD"><span class="command">lemma</span></span> eq_impD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> eq_imp <span class="free">f</span> <span class="free">g</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">s</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> <span class="free">g</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_imp_def<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg_rules-eq_imp_vcg"><span class="command">lemma</span></span> eq_imp_vcg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_imp <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">P</span> <span class="main">∘</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">⦄</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span> <span class="main">∘</span> <span class="free">g</span><span class="main">⦄</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_name_pre_state<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_pre<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_post_imp<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_all_lift<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="tfree"><span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">fs</span><span class="main">.</span> <span class="bound">fs</span> <span class="main">=</span> <span class="free">f</span> <span class="improper">x</span> <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> f<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> eq_impD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> g<span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_vcg_rules-eq_imp_vcg_LST"><span class="command">lemma</span></span> eq_imp_vcg_LST<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_imp <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">P</span> <span class="main">∘</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> LST<span class="main">⦄</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">∘</span> LST<span class="main">⦄</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_name_pre_state<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_pre<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_post_imp<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg_all_lift<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="tfree"><span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">fs</span><span class="main">.</span> <span class="bound">fs</span> <span class="main">=</span> <span class="free">f</span> <span class="improper">x</span> <span class="improper">s</span><span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> f<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> eq_impD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> g<span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_vcg_rules-eq_imp_fun_upd"><span class="command">lemma</span></span> eq_imp_fun_upd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_imp <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">fld</span> <span class="main">:=</span> <span class="free">val</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">fld</span> <span class="main">:=</span> <span class="free">val</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_impD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> f<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_vcg_rules-curry_forall_eq"><span class="command">lemma</span></span> curry_forall_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="free">P</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>case_prod <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_curry<span class="main">)</span>

<span class="keyword1" id="CIMP_vcg_rules-pres_tuple_vcg"><span class="command">lemma</span></span> pres_tuple_vcg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">P</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">,</span> <span class="free">g</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="free">c</span><span class="main">)</span>
    <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">P</span> <span class="main">∘</span> <span class="free">f</span><span class="main">⦄</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">P</span> <span class="main">∘</span> <span class="free">g</span><span class="main">⦄</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curry_forall_eq o_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">fs</span> <span class="bound">s</span><span class="main">.</span> <span class="improper">P</span> <span class="bound">fs</span> <span class="main">(</span><span class="free">g</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> vcg_lift_comp<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_vcg_rules-pres_tuple_vcg_LST"><span class="command">lemma</span></span> pres_tuple_vcg_LST<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">P</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">,</span> <span class="free">g</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> LST<span class="main">⦄</span> <span class="free">c</span><span class="main">)</span>
    <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">P</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> LST<span class="main">⦄</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">P</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">∘</span> LST<span class="main">⦄</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curry_forall_eq o_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span><span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">fs</span> <span class="bound">s</span><span class="main">.</span> <span class="improper">P</span> <span class="bound">fs</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">g</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> vcg_lift_comp<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">no_notation</span></span> valid_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_<span class="keyword3">/ </span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="CIMP">
<div class="head">
<h1>Theory CIMP</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Copyright 2015, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> CIMP
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CIMP_pred.html">CIMP_pred</a>
  <a href="CIMP_lang.html">CIMP_lang</a>
  <a href="CIMP_vcg.html">CIMP_vcg</a>
  <a href="CIMP_vcg_rules.html">CIMP_vcg_rules</a>
<span class="keyword2"><span class="keyword">keywords</span></span>
      <span class="quoted">"locset_definition"</span> <span class="main">::</span> thy_defn
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"intern_com"</span> <span class="main">::</span> thy_decl
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Infrastructure for reasoning about CIMP programs. See AFP entry <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>ConcurrentGC›</span></span> for examples
of use.

›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> locset_cache <span class="quoted">"Location set membership cache"</span>

<span class="keyword1"><span class="command">lemmas</span></span> cleanup_simps <span class="main">=</span>
  atomize_eq
  simp_thms

<span class="keyword1"><span class="command">ML_file</span></span><span class="quoted">‹cimp.ML›</span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="files/cimp.ML">
<div class="head">
<h1>File ‹cimp.ML›</h1>
</div>
<pre class="source"><span class="comment1">(* Pollutes the global namespace, but we use them everywhere *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ss_only</span> <span class="entity">thms</span> <span class="entity">ctxt</span> <span class="main">=</span> clear_simpset <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span><span class="main">)</span> addsimps <span class="entity">thms</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">HOL_ss_only</span> <span class="entity">thms</span> <span class="entity">ctxt</span> <span class="main">=</span> clear_simpset <span class="main">(</span>put_simpset <span class="entity">HOL_ss</span> <span class="entity">ctxt</span><span class="main">)</span> addsimps <span class="entity">thms</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">CIMP</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> com_locs_fold <span class="main">:</span> <span class="main">(</span>term * 'b <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> term <span class="main">-&gt;</span> 'b
    <span class="keyword1"><span class="keyword">val</span></span> com_locs_map <span class="main">:</span> <span class="main">(</span>term <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> 'b list
    <span class="keyword1"><span class="keyword">val</span></span> com_locs_fold_no_response <span class="main">:</span> <span class="main">(</span>term * 'b <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> term <span class="main">-&gt;</span> 'b
    <span class="keyword1"><span class="keyword">val</span></span> com_locs_map_no_response <span class="main">:</span> <span class="main">(</span>term <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> 'b list
    <span class="keyword1"><span class="keyword">val</span></span> intern_com <span class="main">:</span> Facts.ref <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> local_theory
    <span class="keyword1"><span class="keyword">val</span></span> def_locset <span class="main">:</span> thm <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> local_theory
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Cimp</span> <span class="main">:</span> <span class="entity">CIMP</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Request<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">)</span>    <span class="main">=</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Response<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span><span class="main">)</span>        <span class="main">=</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> LocalOp<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span><span class="main">)</span>         <span class="main">=</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Cond1<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span> $ <span class="entity">c</span><span class="main">)</span>       <span class="main">=</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">c</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Cond2<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span> $ <span class="entity">c1</span> $ <span class="entity">c2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">c1</span><span class="main">)</span> <span class="entity">c2</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Loop<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">c</span><span class="main">)</span>                <span class="main">=</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> While<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span> $ <span class="entity">c</span><span class="main">)</span>       <span class="main">=</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">c</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Seq<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">c1</span> $ <span class="entity">c2</span><span class="main">)</span>           <span class="main">=</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c1</span><span class="main">)</span> <span class="entity">c2</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Choose<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">c1</span> $ <span class="entity">c2</span><span class="main">)</span>        <span class="main">=</span> <span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">com_locs_fold</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c1</span><span class="main">)</span> <span class="entity">c2</span>
  <span class="main">|</span> <span class="entity">com_locs_fold</span> <span class="main">_</span> <span class="entity">x</span> <span class="main">_</span> <span class="main">=</span> <span class="entity">x</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">com_locs_map</span> <span class="entity">f</span> <span class="entity">com</span> <span class="main">=</span> <span class="entity">com_locs_fold</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">l</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="entity">com</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Request<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">)</span>    <span class="main">=</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="main">_</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Response<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span><span class="main">)</span>        <span class="main">=</span> <span class="entity">x</span> <span class="comment1">(* can often ignore ‹Response› *)</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> LocalOp<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span><span class="main">)</span>         <span class="main">=</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Cond1<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span> $ <span class="entity">c</span><span class="main">)</span>       <span class="main">=</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">c</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Cond2<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span> $ <span class="entity">c1</span> $ <span class="entity">c2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">c1</span><span class="main">)</span> <span class="entity">c2</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Loop<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">c</span><span class="main">)</span>                <span class="main">=</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> While<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l</span> $ <span class="main">_</span> $ <span class="entity">c</span><span class="main">)</span>       <span class="main">=</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">c</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Seq<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">c1</span> $ <span class="entity">c2</span><span class="main">)</span>           <span class="main">=</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c1</span><span class="main">)</span> <span class="entity">c2</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Choose<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">c1</span> $ <span class="entity">c2</span><span class="main">)</span>        <span class="main">=</span> <span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">com_locs_fold_no_response</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c1</span><span class="main">)</span> <span class="entity">c2</span>
  <span class="main">|</span> <span class="entity">com_locs_fold_no_response</span> <span class="main">_</span> <span class="entity">x</span> <span class="main">_</span> <span class="main">=</span> <span class="entity">x</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">com_locs_map_no_response</span> <span class="entity">f</span> <span class="entity">com</span> <span class="main">=</span> <span class="entity">com_locs_fold_no_response</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">l</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="entity">com</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cprop_of_equality</span> <span class="entity">ctxt</span> <span class="main">:</span> thm <span class="main">-&gt;</span> cterm <span class="main">=</span>
  Local_Defs.meta_rewrite_rule <span class="entity">ctxt</span> <span class="comment1">(* handle `=` or `≡` *)</span>
  #&gt; Thm.cprop_of

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">equality_lhs</span> <span class="entity">ctxt</span> <span class="main">:</span> thm <span class="main">-&gt;</span> term <span class="main">=</span>
  <span class="entity">cprop_of_equality</span> <span class="entity">ctxt</span> #&gt; Thm.dest_equals_lhs #&gt; Thm.term_of

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">equality_rhs</span> <span class="entity">ctxt</span> <span class="main">:</span> thm <span class="main">-&gt;</span> term <span class="main">=</span>
  <span class="entity">cprop_of_equality</span> <span class="entity">ctxt</span> #&gt; Thm.dest_equals_rhs #&gt; Thm.term_of

<span class="comment1">(* Intern all labels mentioned in CIMP programs ‹facts›

FIXME can only use ‹com_intern› once per locale
FIXME forces all labels to be unique and distinct from other constants in the locale.
FIXME assumes the labels are character strings
*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">intern_com</span> <span class="entity">facts</span> <span class="entity">ctxt</span> <span class="main">:</span> local_theory <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> Proof_Context.get_fact <span class="entity">ctxt</span> <span class="entity">facts</span>
    <span class="comment1">(* Define constants with defs of the form loc.XXX_def: "XXX ≡ ''XXX''. *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">attrs</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_literal_def</span> <span class="main">(</span><span class="entity">literal</span><span class="main">,</span> <span class="main">(</span><span class="entity">loc_defs</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> thm list * local_theory <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">literal_name</span> <span class="main">=</span> <span class="entity">HOLogic.dest_string</span> <span class="entity">literal</span> <span class="comment1">(* FIXME might not be a nice name, but the error is readable so shrug. FIXME generalise to other label types *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">literal_def_binding</span> <span class="main">=</span> Binding.empty <span class="comment1">(* Binding.qualify true "loc" (Binding.name (Thm.def_name literal_name)) No need to name individual defs *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">loc_def</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> Local_Theory.define <span class="main">(</span><span class="main">(</span>Binding.name <span class="entity">literal_name</span><span class="main">,</span> Mixfix.NoSyn<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="entity">literal_def_binding</span><span class="main">,</span> <span class="entity">attrs</span><span class="main">)</span><span class="main">,</span> <span class="entity">literal</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="entity">loc_def</span> :: <span class="entity">loc_defs</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">loc_defs</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> List.foldl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">com</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">com_locs_fold</span> <span class="entity">add_literal_def</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">equality_rhs</span> <span class="entity">ctxt</span> <span class="entity">com</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thms</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">coms_interned</span> <span class="main">=</span> List.map <span class="main">(</span>Local_Defs.fold <span class="entity">ctxt</span> <span class="entity">loc_defs</span><span class="main">)</span> <span class="entity">thms</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">attrs</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> Local_Theory.note <span class="main">(</span><span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "loc_defs"<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="entity">attrs</span><span class="main">)</span><span class="main">,</span> <span class="entity">loc_defs</span><span class="main">)</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> Local_Theory.note <span class="main">(</span><span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "com_interned"<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="entity">attrs</span><span class="main">)</span><span class="main">,</span> <span class="entity">coms_interned</span><span class="main">)</span> <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* Cache location set membership facts.

Decide membership in the given set for each label in the CIMP programs
in the Named_Theorems "com".

If the label set and com types differ, we probably get a nasty error.

*)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">def_locset</span> <span class="entity">thm</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">set_name</span> <span class="main">=</span> <span class="entity">equality_lhs</span> <span class="entity">ctxt</span> <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">set_name_str</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">set_name</span> <span class="keyword2"><span class="keyword">of</span></span> Const <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">|</span> Free <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Not an equation of the form x = set: "</span> ^ Thm.string_of_thm <span class="entity">ctxt</span> <span class="entity">thm</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">memb_thm_name</span> <span class="main">=</span> Binding.qualify true <span class="entity">set_name_str</span> <span class="main">(</span>Binding.name <span class="inner_quoted">"memb"</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_memb</span> <span class="entity">l</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">HOLogic.mk_mem</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">set_name</span><span class="main">)</span><span class="main">)</span>
<span class="comment1">(*
1. solve atomic membership yielding ‹''label'' ∈ set› or ‹''label'' ∉ set›.
2. fold ‹loc_defs›
3. cleanup with the existing ‹locset_cache›.
FIXME trim simpsets: 1: sets 2: not much 3: not much
*)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">loc_defs</span> <span class="main">=</span> Proof_Context.get_fact <span class="entity">ctxt</span> <span class="main">(</span>Facts.named <span class="inner_quoted">"loc_defs"</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">membership_ctxt</span> <span class="main">=</span> <span class="entity">ctxt</span> addsimps <span class="main">(</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span> @ <span class="entity">loc_defs</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cleanup_ctxt</span> <span class="main">=</span> <span class="entity">HOL_ss_only</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> cleanup_simps<span class="antiquote">}</span></span></span> @ <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span>‹locset_cache›</span><span class="main">)</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rewrite_tac</span> <span class="main">=</span>
          <span class="entity">Simplifier.rewrite</span> <span class="entity">membership_ctxt</span>
          #&gt; Local_Defs.fold <span class="entity">ctxt</span> <span class="entity">loc_defs</span>
          #&gt; <span class="entity">Simplifier.simplify</span> <span class="entity">cleanup_ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">coms</span> <span class="main">=</span> Proof_Context.get_fact <span class="entity">ctxt</span> <span class="main">(</span>Facts.named <span class="inner_quoted">"com_interned"</span><span class="main">)</span>
<span class="comment1">(* Parallel *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_thms</span> <span class="entity">coms</span> <span class="main">:</span> thm list <span class="main">=</span> Par_List.map <span class="entity">rewrite_tac</span> <span class="main">(</span>maps <span class="main">(</span><span class="entity">equality_rhs</span> <span class="entity">ctxt</span> #&gt; <span class="entity">com_locs_map_no_response</span> <span class="entity">mk_memb</span><span class="main">)</span> <span class="entity">coms</span><span class="main">)</span>
<span class="comment1">(* Sequential *)</span>
<span class="comment1">(*    fun mk_thms coms = List.foldl (fn (c, thms) =&gt; com_locs_fold (fn l =&gt; fn thms =&gt; rewrite_tac (mk_memb l) :: thms) thms c) [] coms *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">attrs</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ctxt</span> |&gt; Local_Theory.note <span class="main">(</span><span class="main">(</span><span class="entity">memb_thm_name</span><span class="main">,</span> <span class="entity">attrs</span><span class="main">)</span><span class="main">,</span> <span class="entity">mk_thms</span> <span class="entity">coms</span><span class="main">)</span>
<span class="comment1">(* Add ‹memb_thms› to the global (and inherited by locales) ‹locset_cache› *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">memb_thm_full_name</span> <span class="main">=</span> Local_Theory.full_name <span class="entity">ctxt</span> <span class="entity">memb_thm_name</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">finish</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Target_Context.switch_named_cmd</span> <span class="main">(</span>SOME <span class="main">(</span><span class="inner_quoted">"-"</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> <span class="comment1">(* switch to the "root" local theory *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">memb_thms</span> <span class="main">=</span> Proof_Context.get_fact <span class="entity">ctxt</span> <span class="main">(</span>Facts.named <span class="entity">memb_thm_full_name</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">attrs</span> <span class="main">=</span> <span class="main">[</span><span class="entity">Attrib.internal</span> <span class="main">(</span>K <span class="main">(</span><span class="entity">Named_Theorems.add</span> <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span>‹locset_cache›</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ctxt</span> |&gt; Local_Theory.note <span class="main">(</span><span class="main">(</span>Binding.empty<span class="main">,</span> <span class="entity">attrs</span><span class="main">)</span><span class="main">,</span> <span class="entity">memb_thms</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">finish</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">of</span></span> Context.Proof <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">ctxt</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="inner_quoted">"Context.generic failure"</span> <span class="comment1">(* Return to the locale we were in *)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">intern_com</span>›</span></span> <span class="inner_quoted">"intern labels in CIMP commands"</span>
    <span class="main">(</span>Parse.thms1 &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">facts</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> List.foldl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Cimp.intern_com</span> <span class="entity">f</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">facts</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory'</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">locset_definition</span>›</span></span> <span class="inner_quoted">"constant definition for sets of locations"</span>
    <span class="main">(</span>Scan.option <span class="entity">Parse_Spec.constdecl</span> -- <span class="main">(</span><span class="entity">Parse_Spec.opt_thm_name</span> <span class="inner_quoted">":"</span> -- Parse.prop<span class="main">)</span> --
      <span class="entity">Parse_Spec.if_assumes</span> -- Parse.for_fixes &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">decl</span><span class="main">,</span> <span class="entity">spec</span><span class="main">)</span><span class="main">,</span> <span class="entity">prems</span><span class="main">)</span><span class="main">,</span> <span class="entity">params</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">b</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span>
        <span class="entity">Specification.definition_cmd</span> <span class="entity">decl</span> <span class="entity">params</span> <span class="entity">prems</span> <span class="entity">spec</span> <span class="entity">b</span> <span class="entity">lthy</span>
        |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">thm</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span> |&gt; uncurry <span class="entity">Cimp.def_locset</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
</pre>
</div><div id="CIMP_locales">
<div class="head">
<h1>Theory CIMP_locales</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> CIMP_locales
<span class="keyword2"><span class="keyword">imports</span></span>
 <span class="quoted">"<a href="CIMP.html">../CIMP</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ One locale per process ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A sketch of what we're doing in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ConcurrentGC›</span></span></span></span>, for quicker testing.

FIXME write some lemmas that further exercise the generated thms.

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> P1
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> string<span class="main">,</span> unit<span class="main">,</span> nat<span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">com</span> <span class="main">=</span> <span class="main">⦃</span><span class="inner_quoted">''A''</span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="main">(</span><span class="main">(&lt;)</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">DO</span> <span class="main">⦃</span><span class="inner_quoted">''B''</span><span class="main">⦄</span> <span class="main">⌊</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">⌋</span> <span class="keyword1">OD</span>"</span></span>

<span class="keyword1"><span class="command">intern_com</span></span> com_def
<span class="keyword1"><span class="command">print_theorems</span></span> <span class="comment1">(* P1.com_interned, P1.loc_defs *)</span>

<span class="keyword1"><span class="command">locset_definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">loop</span> <span class="main">=</span> <span class="main">{</span>B<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">print_theorems</span></span> <span class="comment1">(* P1.loop.memb, P1.loop_def *)</span>
<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">locset_cache</span></span> <span class="comment1">(* the two facts in P1.loop.memb *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assertion</span> <span class="main">=</span> atS False loop"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">locset_cache</span></span> <span class="comment1">(* the two facts in P1.loop.memb *)</span>

<span class="keyword1"><span class="command">locale</span></span> P2
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">locset_cache</span></span> <span class="comment1">(* the two facts in P1.loop.memb *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> string<span class="main">,</span> unit<span class="main">,</span> nat<span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">com</span> <span class="main">=</span> <span class="main">⦃</span><span class="inner_quoted">''C''</span><span class="main">⦄</span> <span class="keyword1">WHILE</span> <span class="main">(</span><span class="main">(&lt;)</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">DO</span> <span class="main">⦃</span><span class="inner_quoted">''A''</span><span class="main">⦄</span> <span class="main">⌊</span>Suc<span class="main">⌋</span> <span class="keyword1">OD</span>"</span></span>

<span class="keyword1"><span class="command">intern_com</span></span> com_def
<span class="keyword1"><span class="command">locset_definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">loop</span> <span class="main">=</span> <span class="main">{</span>A<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">print_theorems</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">locset_cache</span></span> <span class="comment1">(* four facts: P1.loop.memb, P2.loop.memb *)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="entity">coms</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted"><span class="quoted">"bool <span class="main"><span class="main">⇒</span></span> <span class="main"><span class="main">(</span></span>unit<span class="main"><span class="main">,</span></span> string<span class="main"><span class="main">,</span></span> unit<span class="main"><span class="main">,</span></span> nat<span class="main"><span class="main">)</span></span> com"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">coms</span></span> False <span class="main"><span class="main">=</span></span> P1.com"</span></span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">coms</span></span> True <span class="main"><span class="main">=</span></span> P2.com"</span></span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="CIMP_one_place_buffer">
<div class="head">
<h1>Theory CIMP_one_place_buffer</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Copyright 2015, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> CIMP_one_place_buffer
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="CIMP.html">../CIMP</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Example: a one-place buffer \label{sec:one_place_buffer}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To demonstrate the CIMP reasoning infrastructure, we treat the trivial
one-place buffer example of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
‹\S3.3› "DBLP:journals/toplas/LamportS84"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note that the
semantics for our language is different to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span>
[cite_macro=citeauthor] "DBLP:journals/toplas/LamportS84"<span class="antiquote"><span class="antiquote">}</span></span></span></span>'s, who
treated a historical variant of CSP (i.e., not the one in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span>
"Hoare:1985"<span class="antiquote"><span class="antiquote">}</span></span></span></span>).

We introduce some syntax for fixed-topology (static channel-based)
scenarios.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">rcv_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> <span class="main">⇒</span> <span class="tfree">'channel</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'val</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span>
           <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'channel</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_<span class="keyword1">▹</span>_"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>81<span class="main">]</span> 81<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span><span class="main"><span class="free">▹</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> fst <span class="bound">q</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>snd <span class="bound">q</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">snd_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> <span class="main">⇒</span> <span class="tfree">'channel</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span>
          <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'channel</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_<span class="keyword1">◃</span>_"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>81<span class="main">]</span> 81<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span><span class="main"><span class="free">◃</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Request</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ch</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ans</span> <span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

These definitions largely follow <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citet]
"DBLP:journals/toplas/LamportS84"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. We have three processes
communicating over two channels. We enumerate program locations.

›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ex_chname <span class="main">=</span> ξ12 <span class="main">|</span> ξ23
<span class="keyword1"><span class="command">type_synonym</span></span> ex_val <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_ch <span class="main">=</span> <span class="quoted"><span class="quoted">"ex_chname <span class="main">×</span> ex_val"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ex_loc <span class="main">=</span> r12 <span class="main">|</span> r23 <span class="main">|</span> s23 <span class="main">|</span> s12
<span class="keyword1"><span class="command">datatype</span></span> ex_proc <span class="main">=</span> p1 <span class="main">|</span> p2 <span class="main">|</span> p3

<span class="keyword1"><span class="command">type_synonym</span></span> ex_pgm <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> ex_loc<span class="main">,</span> ex_ch<span class="main">,</span> ex_val<span class="main">)</span> com"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> ex_loc<span class="main">,</span> ex_proc<span class="main">,</span> ex_ch<span class="main">,</span> ex_val<span class="main">)</span> state_pred"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> ex_loc<span class="main">,</span> ex_proc<span class="main">,</span> ex_ch<span class="main">,</span> ex_val<span class="main">)</span> system_state"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_sys <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> ex_loc<span class="main">,</span> ex_proc<span class="main">,</span> ex_ch<span class="main">,</span> ex_val<span class="main">)</span> system"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_history <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ex_ch <span class="main">×</span> unit<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We further specialise these for our particular example.

›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">ex_coms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ex_proc <span class="main">⇒</span> ex_pgm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ex_coms</span> p1 <span class="main">=</span> <span class="main">⦃</span>s12<span class="main">⦄</span> ξ12<span class="main">◃</span>id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ex_coms</span> p2 <span class="main">=</span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="main">⦃</span>r12<span class="main">⦄</span> ξ12<span class="main">▹</span><span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">v</span><span class="main">)</span> <span class="main">;;</span> <span class="main">⦃</span>s23<span class="main">⦄</span> ξ23<span class="main">◃</span>id <span class="keyword1">OD</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ex_coms</span> p3 <span class="main">=</span> <span class="main">⦃</span>r23<span class="main">⦄</span> ξ23<span class="main">▹</span><span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Each process starts with an arbitrary initial local state.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ex_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ex_proc <span class="main">⇒</span> ex_val<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ex_init</span> <span class="main">≡</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sys</span> <span class="main">::</span> <span class="quoted">ex_sys</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sys</span> <span class="main">≡</span> <span class="main">⦇</span>PGMs <span class="main">=</span> ex_coms<span class="main">,</span> INIT <span class="main">=</span> ex_init<span class="main">,</span> FAIR <span class="main">=</span> <span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦈</span>"</span></span> <span class="comment1">(* FIXME add fairness hypotheses *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The following adapts Kai Engelhardt's, from his notes titled
\emph{Proving an Asynchronous Message Passing Program Correct},
2011. The history variable tracks the causality of the system, which I
feel is missing in Lamport's treatment. We tack on Lamport's invariant
so we can establish <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Etern_pred›</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">filter_on_channel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ex_chname <span class="main">⇒</span> ex_state <span class="main">⇒</span> ex_val list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⇂</span>_"</span> <span class="main">[</span>100<span class="main">]</span> 101<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⇂</span></span><span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="main">≡</span> map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="main">∘</span> filter <span class="main">(</span><span class="main">(=)</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="main">∘</span> fst <span class="main">∘</span> fst<span class="main">)</span> <span class="main">∘</span> HST"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IL</span> <span class="main">::</span> <span class="quoted">ex_pred</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IL</span> <span class="main">=</span> pred_conjoin <span class="main">[</span>
       at p1 s12 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="keyword1">LIST_NULL</span> <span class="main">⇂</span>ξ12
     <span class="main">,</span> terminated p1 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">⇂</span>ξ12 <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">[</span><span class="bound">s</span><span class="main">↓</span> p1<span class="main">]</span><span class="main">)</span>
     <span class="main">,</span> at p2 r12 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">⇂</span>ξ12 <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⇂</span>ξ23
     <span class="main">,</span> at p2 s23 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">⇂</span>ξ12 <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⇂</span>ξ23 <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">[</span><span class="bound">s</span><span class="main">↓</span> p2<span class="main">]</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">↓</span> p1 <span class="main">=</span> <span class="bound">s</span><span class="main">↓</span> p2<span class="main">)</span>
     <span class="main">,</span> at p3 r23 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="keyword1">LIST_NULL</span> <span class="main">⇂</span>ξ23
     <span class="main">,</span> terminated p3 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">⇂</span>ξ23 <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">[</span><span class="bound">s</span><span class="main">↓</span> p2<span class="main">]</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">↓</span> p1 <span class="main">=</span> <span class="bound">s</span><span class="main">↓</span> p3<span class="main">)</span>
     <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> p3<span class="antiquote"><span class="antiquote">}</span></span></span></span> terminates, then it has <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> p1<span class="antiquote"><span class="antiquote">}</span></span></span></span>'s value. This is
stronger than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> [cite_macro=citeauthor]
"DBLP:journals/toplas/LamportS84"<span class="antiquote"><span class="antiquote">}</span></span></span></span>'s as we don't ask that the first
process has also terminated.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Etern_pred</span> <span class="main">::</span> <span class="quoted">ex_pred</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Etern_pred</span> <span class="main">=</span> <span class="main">(</span>terminated p3 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">↓</span> p1 <span class="main">=</span> <span class="bound">s</span><span class="main">↓</span> p3<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Proofs from here down.

›</span></span>

<span class="keyword1" id="CIMP_one_place_buffer-correct_system"><span class="command">lemma</span></span> correct_system<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IL <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Etern_pred <span class="free">sh</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Etern_pred_def IL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CIMP_one_place_buffer-IL_p1"><span class="command">lemma</span></span> IL_p1<span class="main">:</span> <span class="quoted"><span class="quoted">"ex_coms<span class="main">,</span> p1<span class="main">,</span> lconst <span class="main">{}</span> <span class="main">⊢</span> <span class="main">⦃</span>IL<span class="main">⦄</span> <span class="main">⦃</span>s12<span class="main">⦄</span> ξ12<span class="main">◃</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg.intros<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IL_def atLs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_one_place_buffer-IL_p2"><span class="command">lemma</span></span> IL_p2<span class="main">:</span> <span class="quoted"><span class="quoted">"ex_coms<span class="main">,</span> p2<span class="main">,</span> lconst <span class="main">{</span>r12<span class="main">}</span> <span class="main">⊢</span> <span class="main">⦃</span>IL<span class="main">⦄</span> <span class="main">⦃</span>s23<span class="main">⦄</span> ξ23<span class="main">◃</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg.intros<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IL_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_one_place_buffer-IL"><span class="command">lemma</span></span> IL<span class="main">:</span> <span class="quoted"><span class="quoted">"sys ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> IL"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> VCG<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IL_def atLs_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> initial_stateD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IL_p1 IL_p2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_one_place_buffer-IL_valid"><span class="command">lemma</span></span> IL_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"sys <span class="main">⊨</span> <span class="main">□</span><span class="main">⌈</span>IL<span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valid_prerun_lift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IL<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="CIMP_unbounded_buffer">
<div class="head">
<h1>Theory CIMP_unbounded_buffer</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Copyright 2015, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> CIMP_unbounded_buffer
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="CIMP.html">../CIMP</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Prefix_Order.html">HOL-Library.Prefix_Order</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">Receive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> <span class="main">⇒</span> <span class="tfree">'channel</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'val</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span>
             <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'channel</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_<span class="keyword1">▹</span>_"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>81<span class="main">]</span> 81<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span><span class="main"><span class="free">▹</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Response</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> fst <span class="bound">q</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>snd <span class="bound">q</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">Send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'location</span> <span class="main">⇒</span> <span class="tfree">'channel</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span>
          <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">,</span> <span class="tfree">'location</span><span class="main">,</span> <span class="tfree">'channel</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> com"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_<span class="keyword1">◃</span>_"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>81<span class="main">]</span> 81<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span><span class="main"><span class="free">◃</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="keyword1">Request</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ch</span></span></span><span class="main">,</span> fst <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ans</span> <span class="bound">s</span><span class="main">.</span> <span class="main">{</span>snd <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Example: an unbounded buffer \label{sec:unbounded_buffer}›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This is more literally Kai Engelhardt's example from his notes titled
\emph{Proving an Asynchronous Message Passing Program Correct}, 2011.

›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ex_chname <span class="main">=</span> ξ12 <span class="main">|</span> ξ23
<span class="keyword1"><span class="command">type_synonym</span></span> ex_val <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_ls <span class="main">=</span> <span class="quoted"><span class="quoted">"ex_val list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_ch <span class="main">=</span> <span class="quoted"><span class="quoted">"ex_chname <span class="main">×</span> ex_val"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ex_loc <span class="main">=</span> c1 <span class="main">|</span> r12 <span class="main">|</span> r23 <span class="main">|</span> s23 <span class="main">|</span> s12
<span class="keyword1"><span class="command">datatype</span></span> ex_proc <span class="main">=</span> p1 <span class="main">|</span> p2 <span class="main">|</span> p3

<span class="keyword1"><span class="command">type_synonym</span></span> ex_pgm <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> ex_loc<span class="main">,</span> ex_ch<span class="main">,</span> ex_ls<span class="main">)</span> com"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> ex_loc<span class="main">,</span> ex_proc<span class="main">,</span> ex_ch<span class="main">,</span> ex_ls<span class="main">)</span> state_pred"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> ex_loc<span class="main">,</span> ex_proc<span class="main">,</span> ex_ch<span class="main">,</span> ex_ls<span class="main">)</span> system_state"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_sys <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> ex_loc<span class="main">,</span> ex_proc<span class="main">,</span> ex_ch<span class="main">,</span> ex_ls<span class="main">)</span> system"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ex_history <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ex_ch <span class="main">×</span> unit<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The local state for the producer process contains all values produced; consider that ghost state.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">snoc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">snoc</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ex_coms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ex_proc <span class="main">⇒</span> ex_pgm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ex_coms</span> p1 <span class="main">=</span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="main">⦃</span>c1<span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="main">{</span>snoc <span class="bound">x</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span> <span class="main">;;</span> <span class="main">⦃</span>s12<span class="main">⦄</span> ξ12<span class="main">◃</span><span class="main">(</span>last<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">OD</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ex_coms</span> p2 <span class="main">=</span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="main">⦃</span>r12<span class="main">⦄</span> ξ12<span class="main">▹</span>snoc
                      <span class="main">⊕</span> <span class="main">⦃</span>c1<span class="main">⦄</span> <span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> length <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">⦃</span>s23<span class="main">⦄</span> ξ12<span class="main">◃</span><span class="main">(</span>hd<span class="main">,</span> tl<span class="main">)</span> <span class="keyword1">FI</span>
                     <span class="keyword1">OD</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ex_coms</span> p3 <span class="main">=</span> <span class="keyword1">LOOP</span> <span class="keyword1">DO</span> <span class="main">⦃</span>r23<span class="main">⦄</span> ξ23<span class="main">▹</span>snoc <span class="keyword1">OD</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ex_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ex_proc <span class="main">⇒</span> ex_ls<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ex_init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sys</span> <span class="main">::</span> <span class="quoted">ex_sys</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sys</span> <span class="main">≡</span> <span class="main">⦇</span>PGMs <span class="main">=</span> ex_coms<span class="main">,</span> INIT <span class="main">=</span> ex_init<span class="main">,</span> FAIR <span class="main">=</span> <span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦈</span>"</span></span> <span class="comment1">(* FIXME add fairness hypotheses *)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">filter_on_channel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ex_chname <span class="main">⇒</span> ex_state <span class="main">⇒</span> ex_val list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⇂</span>_"</span> <span class="main">[</span>100<span class="main">]</span> 101<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⇂</span></span><span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="main">≡</span> map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="main">∘</span> filter <span class="main">(</span><span class="main">(=)</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="main">∘</span> fst <span class="main">∘</span> fst<span class="main">)</span> <span class="main">∘</span> HST"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">I_pred</span> <span class="main">::</span> <span class="quoted">ex_pred</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">I_pred</span> <span class="main">=</span> pred_conjoin <span class="main">[</span>
       at p1 c1 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">⇂</span>ξ12 <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">↓</span> p1<span class="main">)</span>
     <span class="main">,</span> at p1 s12 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> length <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> p1<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> butlast <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> p1<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⇂</span>ξ12<span class="main">)</span> <span class="bound">s</span><span class="main">)</span>
     <span class="main">,</span> <span class="main">⇂</span>ξ12 <span class="main"><span class="hidden">❙</span><b>≤</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">↓</span> p1<span class="main">)</span>
     <span class="main">,</span> <span class="main">⇂</span>ξ12 <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⇂</span>ξ23 <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">↓</span> p2<span class="main">)</span>
     <span class="main">,</span> at p2 s23 <span class="main"><span class="hidden">❙</span><b>⟶</b></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> length <span class="main">(</span><span class="bound">s</span><span class="main">↓</span> p2<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>
     <span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">↓</span> p3<span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⇂</span>ξ23
     <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The local state of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "p3"<span class="antiquote"><span class="antiquote">}</span></span></span></span> is some prefix of the local state of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "p1"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Etern_pred</span> <span class="main">::</span> <span class="quoted">ex_pred</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Etern_pred</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">↓</span> p3 <span class="main">≤</span> <span class="bound">s</span><span class="main">↓</span> p1"</span></span>

<span class="keyword1" id="CIMP_unbounded_buffer-correct_system"><span class="command">lemma</span></span> correct_system<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"I_pred <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Etern_pred <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Etern_pred_def I_pred_def less_eq_list_def prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>

<span class="keyword1" id="CIMP_unbounded_buffer-p1_c1"><span class="command">lemma</span></span> p1_c1<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ex_coms<span class="main">,</span> p1<span class="main">,</span> lconst <span class="main">{</span>s12<span class="main">}</span> <span class="main">⊢</span> <span class="main">⦃</span>I_pred<span class="main">⦄</span> <span class="main">⦃</span>c1<span class="main">⦄</span> <span class="keyword1">LocalOp</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="main">{</span> snoc <span class="bound">x</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> True <span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg.intros<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I_pred_def atS_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_unbounded_buffer-p1_s12"><span class="command">lemma</span></span> p1_s12<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ex_coms<span class="main">,</span> p1<span class="main">,</span> lconst <span class="main">{</span>c1<span class="main">}</span> <span class="main">⊢</span> <span class="main">⦃</span>I_pred<span class="main">⦄</span> <span class="main">⦃</span>s12<span class="main">⦄</span> ξ12<span class="main">◃</span><span class="main">(</span>last<span class="main">,</span> id<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg.intros<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I_pred_def atS_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Prefix_Order.prefix_snoc append.assoc append_butlast_last_id<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_unbounded_buffer-p2_s23"><span class="command">lemma</span></span> p2_s23<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ex_coms<span class="main">,</span> p2<span class="main">,</span> lconst <span class="main">{</span>c1<span class="main">,</span> r12<span class="main">}</span> <span class="main">⊢</span> <span class="main">⦃</span>I_pred<span class="main">⦄</span> <span class="main">⦃</span>s23<span class="main">⦄</span> ξ12<span class="main">◃</span><span class="main">(</span>hd<span class="main">,</span> tl<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg.intros<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_unbounded_buffer-p2_pi4"><span class="command">lemma</span></span> p2_pi4<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ex_coms<span class="main">,</span> p2<span class="main">,</span> lcond <span class="main">{</span>s23<span class="main">}</span> <span class="main">{</span>c1<span class="main">,</span> r12<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">⦃</span>I_pred<span class="main">⦄</span> <span class="main">⦃</span>c1<span class="main">⦄</span> <span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="free">c'</span> <span class="keyword1">FI</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vcg.intros<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I_pred_def atS_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> lcond_splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_unbounded_buffer-I"><span class="command">lemma</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"sys ⊨<span class="hidden">⇘</span><sub>pre</sub><span class="hidden">⇙</span> I_pred"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> VCG<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> initial_stateD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I_pred_def atS_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CIMP_unbounded_buffer-I_valid"><span class="command">lemma</span></span> I_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"sys <span class="main">⊨</span> <span class="main">□</span><span class="main">⌈</span>I_pred<span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valid_prerun_lift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> I<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>