<div id="Cancelation">
<div class="head">
<h1>Theory Cancelation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Cancelation of words of generators and their inverses›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Cancelation
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Proofs-Lambda/Commutation.html">HOL-Proofs-Lambda.Commutation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines cancelation via relations. The one-step relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">cancels_to_1</span></span> <span class="free"><span class="free">a</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is obtained from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by removing
exactly one pair of generators, while <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cancels_to</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the reflexive
transitive hull of that relation. Due to confluence, this relation has a normal
form, allowing for the definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">normalize</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary results›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some lemmas that would be useful in a more general setting are
collected beforehand.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary results about relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
These were helpfully provided by Andreas Lochbihler.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lconfluent_confluent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wfP <span class="main">(</span><span class="free">R</span><span class="main">^--1</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">R</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">a</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="free">R</span><span class="main">^**</span> <span class="bound">b</span> <span class="bound">d</span> <span class="main">∧</span> <span class="free">R</span><span class="main">^**</span> <span class="bound">c</span> <span class="bound">d</span>  <span class="main">⟧</span> <span class="main">⟹</span> confluent <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diamond_def commute_def square_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> newman<span class="main">)</span>

<span class="keyword1" id="Cancelation-confluentD"><span class="command">lemma</span></span> confluentD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> confluent <span class="free">R</span><span class="main">;</span> <span class="free">R</span><span class="main">^**</span> <span class="free">a</span> <span class="free">b</span><span class="main">;</span> <span class="free">R</span><span class="main">^**</span> <span class="free">a</span> <span class="free">c</span>  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="free">R</span><span class="main">^**</span> <span class="free">b</span> <span class="bound">d</span> <span class="main">∧</span> <span class="free">R</span><span class="main">^**</span> <span class="free">c</span> <span class="bound">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> commute_def diamond_def square_def<span class="main">)</span>

<span class="keyword1" id="Cancelation-tranclp_DomainP"><span class="command">lemma</span></span> tranclp_DomainP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">^++</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> Domainp <span class="free">R</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_tranclpE<span class="main">)</span>

<span class="keyword1" id="Cancelation-confluent_unique_normal_form"><span class="command">lemma</span></span> confluent_unique_normal_form<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> confluent <span class="free">R</span><span class="main">;</span> <span class="free">R</span><span class="main">^**</span> <span class="free">a</span> <span class="free">b</span><span class="main">;</span> <span class="free">R</span><span class="main">^**</span> <span class="free">a</span> <span class="free">c</span><span class="main">;</span> <span class="main">¬</span> Domainp <span class="free">R</span> <span class="free">b</span><span class="main">;</span> <span class="main">¬</span> Domainp <span class="free">R</span> <span class="free">c</span>  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> confluentD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tranclp_DomainP rtranclpD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> rtranclpD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">canceling</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> relation›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> <span class="quoted">"g_i"</span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="comment1">(* A generator or its inverse *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> <span class="quoted">"word_g_i"</span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> g_i list"</span></span> <span class="comment1">(* A word in the generators or their inverses *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
These type aliases encode the notion of a ``generator or its inverse''
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> g_i"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) and the notion of a ``word in generators and their inverses''
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> word_g_i"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), which form the building blocks of Free Groups.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">canceling</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> g_i <span class="main">⇒</span> <span class="tfree">'a</span> g_i <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">canceling</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simple results about canceling›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A generators cancels with its inverse, either way. The relation is symmetic.
›</span></span>

<span class="keyword1" id="Cancelation-cancel_cancel"><span class="command">lemma</span></span> cancel_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> canceling <span class="free">a</span> <span class="free">b</span><span class="main">;</span> canceling <span class="free">b</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def<span class="main">)</span>

<span class="keyword1" id="Cancelation-cancel_sym"><span class="command">lemma</span></span> cancel_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"canceling <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> canceling <span class="free">b</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def<span class="main">)</span>

<span class="keyword1" id="Cancelation-cancel_sym_neg"><span class="command">lemma</span></span> cancel_sym_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>canceling <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">¬</span>canceling <span class="free">b</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">cancels_to</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
First, we define the function that removes the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>th and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(i+1)›</span></span></span></span>st
element from a word of generators, together with basic properties.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cancel_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> word_g_i <span class="main">⇒</span> <span class="tfree">'a</span> word_g_i"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cancel_at</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> drop <span class="main">(</span><span class="numeral">2</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1" id="Cancelation-cancel_at_length"><span class="command">lemma</span></span> cancel_at_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">+</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> length <span class="main">(</span>cancel_at <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancel_at_def<span class="main">)</span>

<span class="keyword1" id="Cancelation-cancel_at_nth1"><span class="command">lemma</span></span> cancel_at_nth1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">;</span> <span class="main">1</span><span class="main">+</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>cancel_at <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancel_at_def nth_append<span class="main">)</span>

<span class="keyword1" id="Cancelation-cancel_at_nth2"><span class="command">lemma</span></span> cancel_at_nth2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cancel_at <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> min <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cancel_at <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancel_at_def nth_append nth_via_drop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Then we can define the relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">cancels_to_1_at</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">a</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which specifies
that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be obtained by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by canceling the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>th and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(i+1)›</span></span></span></span>st position.

Based on that, we existentially quantify over the position <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> to obtain
the relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cancels_to_1›</span></span></span></span>, of which <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cancels_to›</span></span></span></span> is the
reflexive and transitive closure.

A word is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>canceled›</span></span></span></span> if it can not be canceled any futher.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cancels_to_1_at</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> word_g_i <span class="main">⇒</span> <span class="tfree">'a</span> word_g_i <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">cancels_to_1_at</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">l1</span></span></span>
                              <span class="main">∧</span> canceling <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
                              <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> cancel_at <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cancels_to_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word_g_i <span class="main">⇒</span> <span class="tfree">'a</span> word_g_i <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cancels_to_1</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cancels_to_1_at <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cancels_to</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word_g_i <span class="main">⇒</span> <span class="tfree">'a</span> word_g_i <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cancels_to</span> <span class="main">=</span> cancels_to_1<span class="main">^**</span>"</span></span>

<span class="keyword1" id="Cancelation-cancels_to_trans"><span class="command">lemma</span></span> cancels_to_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> cancels_to <span class="free">a</span> <span class="free">b</span><span class="main">;</span> cancels_to <span class="free">b</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> cancels_to <span class="free">a</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">canceled</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word_g_i <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">canceled</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> Domainp cancels_to_1 <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Alternative view on cancelation, sometimes easier to work with *)</span>
<span class="keyword1" id="Cancelation-cancels_to_1_unfold"><span class="command">lemma</span></span> cancels_to_1_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs1</span> <span class="free">x1</span> <span class="free">x2</span> <span class="free">xs2</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">xs1</span> <span class="main">@</span> <span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> <span class="main">#</span> <span class="free">xs2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceling <span class="free">x1</span> <span class="free">x2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">xs1</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">xs2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">x</span> <span class="main">=</span> <span class="bound">xs1</span> <span class="main">@</span> <span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2</span> <span class="main">#</span> <span class="bound">xs2</span><span class="main">;</span> <span class="free">y</span> <span class="main">=</span> <span class="bound">xs1</span> <span class="main">@</span> <span class="bound">xs2</span><span class="main">;</span> canceling <span class="bound">x1</span> <span class="bound">x2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1 <span class="free">x</span> <span class="free">y</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">i</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">x</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span>take <span class="skolem">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span>take <span class="skolem">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">@</span> <span class="free">x</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">#</span> <span class="free">x</span> <span class="main">!</span> Suc <span class="skolem">i</span> <span class="main">#</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cancel_at_def <span class="keyword2"><span class="keyword">and</span></span> cancels_to_1_at_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* And the reverse direction *)</span>
<span class="keyword1" id="Cancelation-cancels_to_1_fold"><span class="command">lemma</span></span> cancels_to_1_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canceling <span class="free">x1</span> <span class="free">x2</span> <span class="main">⟹</span> cancels_to_1 <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> <span class="main">#</span> <span class="free">xs2</span><span class="main">)</span> <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cancels_to_1_def <span class="keyword2"><span class="keyword">and</span></span> cancels_to_1_at_def <span class="keyword2"><span class="keyword">and</span></span> cancel_at_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">xs1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Existence of the normal form›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
One of two steps to show that we have a normal form is the following lemma,
guaranteeing that by canceling, we always end up at a fully canceled word.
›</span></span>

<span class="keyword1" id="Cancelation-canceling_terminates"><span class="command">lemma</span></span> canceling_terminates<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>cancels_to_1<span class="main">^--1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure length<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> cancels_to_1 <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> measure length"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_def cancel_at_def cancels_to_1_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> cancels_to_1 <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wfP_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The next two lemmas prepare for the proof of confluence. It does not matter in
which order we cancel, we can obtain the same result.
›</span></span>

<span class="keyword1" id="Cancelation-canceling_neighbor"><span class="command">lemma</span></span> canceling_neighbor<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="free">i</span> <span class="free">l</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">l</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="free">i</span> <span class="free">l</span> <span class="free">a</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_at_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">l</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_at_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancel_cancel<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">l</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">l</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_at_def cancel_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">l</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="free">i</span> <span class="free">l</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_at_def cancel_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cancelation-canceling_indep"><span class="command">lemma</span></span> canceling_indep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="free">i</span> <span class="free">l</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="free">j</span> <span class="free">l</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> Suc <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="free">i</span> <span class="free">b</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="free">i</span> <span class="free">l</span> <span class="free">a</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> cancel_at <span class="free">i</span> <span class="free">l</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="free">j</span> <span class="free">l</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="free">j</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> cancel_at <span class="free">j</span> <span class="free">l</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cancel_at <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&gt;</span> Suc <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹min <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&gt;</span> Suc <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>cancel_at <span class="free">i</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>cancel_at <span class="free">i</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancel_at_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nth_append<span class="main">)</span>
  
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="free">i</span> <span class="free">l</span> <span class="free">a</span>›</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="free">j</span> <span class="free">l</span> <span class="free">b</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">!</span> Suc <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&gt;</span> Suc <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">a</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span> <span class="var">?c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_at_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">b</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&gt;</span> Suc <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">=</span> cancel_at <span class="free">j</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&gt;</span> Suc <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancel_at_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">b</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&gt;</span> Suc <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">=</span> cancel_at <span class="free">i</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">=</span> cancel_at <span class="free">j</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>Suc <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancel_at <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> cancel_at <span class="free">i</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancel_at_def take_drop<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="free">i</span> <span class="free">b</span> <span class="main">(</span>cancel_at <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span> <span class="var">?c</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> cancels_to_1_at <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">a</span> <span class="bound">c</span> <span class="main">∧</span> cancels_to_1_at <span class="free">i</span> <span class="free">b</span> <span class="bound">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the confluence lemma›</span></span>
<span class="keyword1" id="Cancelation-confluent_cancels_to_1"><span class="command">lemma</span></span> confluent_cancels_to_1<span class="main">:</span> <span class="quoted"><span class="quoted">"confluent cancels_to_1"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lconfluent_confluent<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wfP cancels_to_1<span class="main">¯¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> canceling_terminates<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_def<span class="main">)</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="skolem">a</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_def<span class="main">)</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="bound">d</span> <span class="main">∧</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="bound">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">b</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> cancel_at <span class="skolem">i</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">=</span><span class="skolem">j</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> cancel_at <span class="skolem">j</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">c</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="bound">d</span> <span class="main">∧</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">c</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> canceling_neighbor<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="bound">d</span> <span class="main">∧</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">c</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> canceling_neighbor<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="skolem">b</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="bound">d</span> <span class="main">∧</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> Suc <span class="skolem">j</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≠</span> Suc <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">c</span>›</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">b</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">i</span> <span class="skolem">c</span> <span class="skolem">d</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> canceling_indep<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="skolem">b</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="skolem">c</span> <span class="skolem">d</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="bound">d</span> <span class="main">∧</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≠</span> Suc <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> Suc <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1_at <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">c</span>›</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">j</span> <span class="skolem">b</span> <span class="skolem">d</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">erule</span> canceling_indep<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="skolem">b</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="skolem">c</span> <span class="skolem">d</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span> <span class="bound">d</span> <span class="main">∧</span> cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
And finally, we show that there exists a unique normal form for each word.
›</span></span>

<span class="comment1">(*
lemma inv_rtrcl: "R^**^--1 = R^--1^**" (* Did I overlook this in the standard libs? *)
by (auto simp add:fun_eq_iff intro: dest:rtranclp_converseD intro:rtranclp_converseI)
*)</span>
<span class="keyword1" id="Cancelation-norm_form_uniq"><span class="command">lemma</span></span> norm_form_uniq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">a</span> <span class="free">c</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceled <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceled <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"confluent cancels_to_1"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> confluent_cancels_to_1<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main">^**</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">a</span> <span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main">^**</span> <span class="free">a</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Domainp cancels_to_1 <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceled_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Domainp cancels_to_1 <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceled_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> confluent_unique_normal_form<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Some properties of cancelation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Distributivity rules of cancelation and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>append›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="Cancelation-cancel_to_1_append"><span class="command">lemma</span></span> cancel_to_1_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">a</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">b</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1 <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">i</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_def<span class="main">)</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="main">(</span>length <span class="free">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">a</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">b</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def nth_append cancel_at_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">a</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">b</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cancelation-cancel_to_append"><span class="command">lemma</span></span> cancel_to_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">a</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">b</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> cancels_to_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1 <span class="skolem">b</span> <span class="skolem">c</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">@</span> <span class="free">l'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="skolem">c</span> <span class="main">@</span> <span class="free">l'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancel_to_1_append<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1<span class="main">^**</span> <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">@</span> <span class="free">l'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">@</span> <span class="free">l'</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cancelation-cancels_to_append2"><span class="command">lemma</span></span> cancels_to_append2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">a</span> <span class="free">a'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">b</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">a'</span><span class="main">@</span><span class="free">b'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">a</span> <span class="free">a'</span>›</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cancels_to_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">b</span> <span class="free">b'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">@</span><span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b'</span><span class="main">@</span><span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancel_to_append<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">ba</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1 <span class="skolem">ba</span> <span class="skolem">c</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span><span class="main">[]</span><span class="main">@</span><span class="skolem">ba</span><span class="main">@</span><span class="free">b'</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">@</span><span class="skolem">c</span><span class="main">@</span><span class="free">b'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cancel_to_1_append<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1<span class="main">^**</span> <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ba</span> <span class="main">@</span> <span class="free">b'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The empty list is canceled, a one letter word is canceled and a word is
trivially cancled from itself.
›</span></span>

<span class="keyword1" id="Cancelation-empty_canceled"><span class="command">lemma</span></span> empty_canceled<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"canceled <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceled_def cancels_to_1_def cancels_to_1_at_def<span class="main">)</span>

<span class="keyword1" id="Cancelation-singleton_canceled"><span class="command">lemma</span></span> singleton_canceled<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"canceled <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceled_def cancels_to_1_def cancels_to_1_at_def<span class="main">)</span>

<span class="keyword1" id="Cancelation-cons_canceled"><span class="command">lemma</span></span> cons_canceled<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"canceled <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> canceled <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Domainp cancels_to_1 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceled_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="free">x</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs1</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">xs2</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">xs1</span> <span class="main">@</span> <span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">x2</span> <span class="main">#</span> <span class="skolem">xs2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"canceling <span class="skolem">x1</span> <span class="skolem">x2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancels_to_1_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="skolem">xs1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">x2</span> <span class="main">#</span> <span class="skolem">xs2</span><span class="main">)</span> <span class="main">(</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="skolem">xs1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cancels_to_1_fold <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>append_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="skolem">xs1</span> <span class="main">@</span> <span class="skolem">xs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> canceled <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceled_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cancelation-cancels_to_self"><span class="command">lemma</span></span> cancels_to_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of normalization›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Using the THE construct, we can define the normalization function
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>normalize›</span></span></span></span> as the unique fully cancled word that the argument cancels
to.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word_g_i <span class="main">⇒</span> <span class="tfree">'a</span> word_g_i"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normalize</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">l'</span><span class="main">.</span> cancels_to <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">l'</span> <span class="main">∧</span> canceled <span class="bound">l'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Some obvious properties of the normalize function, and other useful lemmas.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> normalized_canceled<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   normalized_cancels_to<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">l'</span><span class="main">.</span> cancels_to_1<span class="main">^**</span> <span class="free">l</span> <span class="bound">l'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP cancels_to_1<span class="main">^--1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> canceling_terminates<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">∈</span><span class="bound">Q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> cancels_to_1 <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wfP_eq_minimal<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?Q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">∈</span><span class="var">?Q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> cancels_to_1 <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="var">?Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> minimal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> cancels_to_1 <span class="skolem">l'</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∉</span> <span class="var">?Q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> <span class="var">?Q</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceled <span class="skolem">l'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> canceled <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Domainp cancels_to_1 <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceled_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="skolem">l'</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1 <span class="skolem">l'</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> minimal<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> cancels_to_1<span class="main">^**</span> <span class="free">l</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> cancels_to <span class="free">l</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l</span> <span class="skolem">l'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="skolem">l'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="skolem">l'</span> <span class="main">∧</span> canceled <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span> <span class="main">∧</span> canceled <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalize_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> theI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="skolem">l'a</span> <span class="main">∧</span> canceled <span class="skolem">l'a</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'a</span> <span class="main">=</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l</span> <span class="skolem">l'</span> <span class="main">∧</span> canceled <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>norm_form_uniq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cancelation-normalize_discover"><span class="command">lemma</span></span> normalize_discover<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"canceled <span class="free">l'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize <span class="free">l</span> <span class="main">=</span> <span class="free">l'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="free">l'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l</span> <span class="free">l'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="free">l'</span> <span class="main">∧</span> canceled <span class="free">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> normalize_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>norm_form_uniq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Words, related by cancelation, have the same normal form.›</span></span>

<span class="keyword1" id="Cancelation-normalize_canceled"><span class="command">lemma</span></span> normalize_canceled<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"normalize <span class="free">l</span> <span class="main">=</span> normalize <span class="free">l'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> normalize_discover<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>normalize <span class="free">l'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalized_canceled<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l'</span> <span class="main">(</span>normalize <span class="free">l'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalized_cancels_to<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l</span> <span class="free">l'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="main">(</span>normalize <span class="free">l'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancels_to_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Normalization is idempotent.›</span></span>

<span class="keyword1" id="Cancelation-normalize_idemp"><span class="command">lemma</span></span> normalize_idemp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"canceled <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize <span class="free">l</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> normalize_discover<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> cancels_to_self<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This lemma lifts the distributivity results from above to the normalize
function.
›</span></span>

<span class="keyword1" id="Cancelation-normalize_append_cancel_to"><span class="command">lemma</span></span> normalize_append_cancel_to<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l1</span> <span class="free">l1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"cancels_to <span class="free">l2</span> <span class="free">l2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="free">l1</span> <span class="main">@</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> normalize <span class="main">(</span><span class="free">l1'</span> <span class="main">@</span> <span class="free">l2'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> normalize_discover<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>normalize <span class="main">(</span><span class="free">l1'</span> <span class="main">@</span> <span class="free">l2'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalized_canceled<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l1</span> <span class="free">l1'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l2</span> <span class="free">l2'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="free">l1</span> <span class="main">@</span> <span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="free">l1'</span> <span class="main">@</span> <span class="free">l2'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancels_to_append2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="free">l1'</span> <span class="main">@</span> <span class="free">l2'</span><span class="main">)</span> <span class="main">(</span>normalize <span class="main">(</span><span class="free">l1'</span> <span class="main">@</span> <span class="free">l2'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalized_cancels_to<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="free">l1</span> <span class="main">@</span> <span class="free">l2</span><span class="main">)</span> <span class="main">(</span>normalize <span class="main">(</span><span class="free">l1'</span> <span class="main">@</span> <span class="free">l2'</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Normalization preserves generators›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Somewhat obvious, but still required to formalize Free Groups, is the fact that
canceling a word of generators of a specific set (and their inverses) results
in a word in generators from that set.
›</span></span>

<span class="keyword1" id="Cancelation-cancels_to_1_preserves_generators"><span class="command">lemma</span></span> cancels_to_1_preserves_generators<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="free">l</span> <span class="free">l'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> cancel_at <span class="skolem">i</span> <span class="free">l</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_1_def <span class="keyword2"><span class="keyword">and</span></span> cancels_to_1_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="free">l</span> <span class="main">@</span> drop <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cancel_at_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="free">l'</span> <span class="main">=</span> set <span class="main">(</span>take <span class="skolem">i</span> <span class="free">l</span> <span class="main">@</span> drop <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">(</span>take <span class="skolem">i</span> <span class="free">l</span> <span class="main">@</span> drop <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> set <span class="main">(</span>take <span class="skolem">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>drop <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> set <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_takeD in_set_dropD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">l'</span> <span class="main">⊆</span> set <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cancelation-cancels_to_preserves_generators"><span class="command">lemma</span></span> cancels_to_preserves_generators<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="free">l'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cancels_to_1_preserves_generators<span class="main">)</span>

<span class="keyword1" id="Cancelation-normalize_preserves_generators"><span class="command">lemma</span></span> normalize_preserves_generators<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize <span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cancels_to_preserves_generators<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Two simplification lemmas about lists.
›</span></span>

<span class="keyword1" id="Cancelation-empty_in_lists"><span class="command">lemma</span></span> empty_in_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Cancelation-lists_empty"><span class="command">lemma</span></span> lists_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lists <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Normalization and renaming generators›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Renaming the generators, i.e. mapping them through an injective function, commutes
with normalization. Similarly, replacing generators by their inverses and
vica-versa commutes with normalization. Both operations are similar enough to be
handled at once here.
›</span></span>

<span class="keyword1" id="Cancelation-rename_gens_cancel_at"><span class="command">lemma</span></span> rename_gens_cancel_at<span class="main">:</span> <span class="quoted"><span class="quoted">"cancel_at <span class="free">i</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>cancel_at <span class="free">i</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted">"cancel_at_def"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>take_map drop_map<span class="main">)</span>

<span class="keyword1" id="Cancelation-rename_gens_cancels_to_1"><span class="command">lemma</span></span> rename_gens_cancels_to_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="free">l</span> <span class="free">l'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1 <span class="free">l</span> <span class="free">l'</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls1</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="skolem"><span class="skolem">ls2</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="skolem">ls1</span> <span class="main">@</span> <span class="skolem">l1</span> <span class="main">#</span> <span class="skolem">l2</span> <span class="main">#</span> <span class="skolem">ls2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> <span class="skolem">ls1</span> <span class="main">@</span> <span class="skolem">ls2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceling <span class="skolem">l1</span> <span class="skolem">l2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancels_to_1_unfold<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹canceling <span class="skolem">l1</span> <span class="skolem">l2</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">l1</span> <span class="main">≠</span> fst <span class="skolem">l2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">l1</span> <span class="main">=</span> snd <span class="skolem">l2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> canceling_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">l1</span> <span class="main">≠</span> fst <span class="skolem">l2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹inj <span class="free">f</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>fst <span class="skolem">l1</span><span class="main">)</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">(</span>fst <span class="skolem">l2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>inj_on_contraD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span> <span class="skolem">l1</span><span class="main">)</span> <span class="main">≠</span> fst <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">l1</span> <span class="main">=</span> snd <span class="skolem">l2</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span> <span class="skolem">l1</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> canceling_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">ls1</span> <span class="main">@</span> map_prod <span class="free">f</span> <span class="free">g</span> <span class="skolem">l1</span> <span class="main">#</span> map_prod <span class="free">f</span> <span class="free">g</span> <span class="skolem">l2</span> <span class="main">#</span> map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">ls2</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">ls1</span> <span class="main">@</span> map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">ls2</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cancels_to_1_fold<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">=</span> <span class="skolem">ls1</span> <span class="main">@</span> <span class="skolem">l1</span> <span class="main">#</span> <span class="skolem">l2</span> <span class="main">#</span> <span class="skolem">ls2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l'</span> <span class="main">=</span> <span class="skolem">ls1</span> <span class="main">@</span> <span class="skolem">ls2</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l'</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cancelation-rename_gens_cancels_to"><span class="command">lemma</span></span> rename_gens_cancels_to<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">l</span> <span class="free">l'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cancels_to <span class="free">l</span> <span class="free">l'</span>›</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cancels_to_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1 <span class="skolem">x</span> <span class="skolem">z</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹inj <span class="free">f</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> rename_gens_cancels_to_1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1<span class="main">^**</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cancels_to_1<span class="main">^**</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

   
<span class="keyword1" id="Cancelation-rename_gens_canceled"><span class="command">lemma</span></span> rename_gens_canceled<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> <span class="main">(</span>snd<span class="main">`</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceled <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> canceled_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="comment1">(* This statement is needed explicitly later in this proof *)</span>
  <span class="keyword1"><span class="command">have</span></span> different_images<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">f</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Domainp cancels_to_1 <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_def cancels_to_1_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> fst <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">erule</span> different_images<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">g</span> <span class="main">(</span>image snd <span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> canceling_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">i</span> <span class="free">l</span> <span class="main">(</span>cancel_at <span class="skolem">i</span> <span class="free">l</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_1_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="free">l</span> <span class="main">(</span>cancel_at <span class="skolem">i</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>canceled <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> canceled_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="free">l</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cancelation-rename_gens_normalize"><span class="command">lemma</span></span> rename_gens_normalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> <span class="main">(</span>snd <span class="main">`</span> set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> normalize_discover<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">g</span> <span class="main">(</span>image snd <span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> <span class="main">(</span>image snd <span class="main">(</span>set <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subset_inj_on<span class="main">)</span>
    
    <span class="keyword1"><span class="command">have</span></span> UNIV_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> UNIV <span class="main">×</span> snd <span class="main">`</span> <span class="bound">A</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span><span class="main">×</span><span class="tfree">'d</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span>snd <span class="skolem">x</span><span class="main">)</span><span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">×</span> snd <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">×</span> snd <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> snd <span class="main">`</span> set <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lists_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> UNIV_snd<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"set <span class="free"><span class="free"><span class="free">l</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"normalize <span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> snd <span class="main">`</span> set <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalize_preserves_generators<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="main"><span class="main"><span class="main">`</span></span></span> set <span class="free"><span class="free"><span class="free">l</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="main">`</span> set <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lists_eq_set<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rename_gens_canceled<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹inj <span class="free">f</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>normalize <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rename_gens_cancels_to<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Generators">
<div class="head">
<h1>Theory Generators</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generators›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Generators"</span>
<span class="keyword2"><span class="keyword">imports</span></span>
   <span class="quoted">"<a href="../../HOL/HOL-Algebra/Group.html">HOL-Algebra.Group</a>"</span>
   <span class="quoted">"<a href="../../HOL/HOL-Algebra/Lattice.html">HOL-Algebra.Lattice</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory is not specific to Free Groups and could be moved to a more 
general place. It defines the subgroup generated by a set of generators and
that homomorphisms agree on the generated subgroup if they agree on the
generators.›</span></span>

<span class="keyword1"><span class="command">notation</span></span> subgroup <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≤</span>"</span> 80<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The subgroup generated by a set›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The span of a set of subgroup generators, i.e. the generated subgroup, can
be defined inductively or as the intersection of all subgroups containing the
generators. Here, we define it inductively and proof the equivalence›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">gen_span</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> monoid_scheme <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>ı"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">G</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">gens</span>
<span class="keyword2"><span class="keyword">where</span></span> gen_one <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">gens</span><span class="main"><span class="free">⟩</span></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="main">|</span> gen_gens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">gens</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">gens</span><span class="main"><span class="free">⟩</span></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="main">|</span> gen_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">gens</span><span class="main"><span class="free">⟩</span></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="keyword1">inv</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">gens</span><span class="main"><span class="free">⟩</span></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="main">|</span> gen_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">gens</span><span class="main"><span class="free">⟩</span></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">gens</span><span class="main"><span class="free">⟩</span></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⟧</span> <span class="main">⟹</span>  <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">gens</span><span class="main"><span class="free">⟩</span></span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> gen_span_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="comment1">(* How can I do this in one "by" line? *)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>gen_span.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> gen_subgroup_is_subgroup<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">≤</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> subgroupI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_span.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>gen_span_closed<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> gen_subgroup_is_smallest_containing<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span><span class="main">{</span><span class="bound">H</span><span class="main">.</span> <span class="bound">H</span> <span class="main">≤</span> <span class="free">G</span> <span class="main">∧</span> <span class="free">gens</span> <span class="main">⊆</span> <span class="bound">H</span><span class="main">}</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> <span class="main">⋂</span><span class="main">{</span><span class="bound">H</span><span class="main">.</span> <span class="bound">H</span> <span class="main">≤</span> <span class="free">G</span> <span class="main">∧</span> <span class="free">gens</span> <span class="main">⊆</span> <span class="bound">H</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">H</span><span class="main">.</span> <span class="bound">H</span> <span class="main">≤</span> <span class="free">G</span> <span class="main">∧</span> <span class="free">gens</span> <span class="main">⊆</span> <span class="bound">H</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">≤</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gens</span> <span class="main">⊆</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> <span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">≤</span> <span class="free">G</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">gens</span> <span class="main">⊆</span> <span class="skolem">H</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">H</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> subgroup_def
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>gen_span.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">≤</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gen_subgroup_is_subgroup<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gens</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_span.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span><span class="main">{</span><span class="bound">H</span><span class="main">.</span> <span class="bound">H</span> <span class="main">≤</span> <span class="free">G</span> <span class="main">∧</span> <span class="free">gens</span> <span class="main">⊆</span> <span class="bound">H</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Inter_lower<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generators and homomorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two homorphisms agreeing on some elements agree on the span of those elements.›</span></span>

<span class="keyword1" id="Generators-hom_unique_on_span"><span class="command">lemma</span></span> hom_unique_on_span<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"group <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"group <span class="free">H</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> hom <span class="free">G</span> <span class="free">H</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">∈</span> hom <span class="free">G</span> <span class="free">H</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> <span class="free">gens</span><span class="main">.</span> <span class="free">h</span> <span class="bound">g</span> <span class="main">=</span> <span class="free">h'</span> <span class="bound">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">h'</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> group <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> group <span class="quoted"><span class="free">H</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> h<span class="main">:</span> group_hom <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">h</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> h'<span class="main">:</span> group_hom <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">h'</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G.gen_span_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>gen_span.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gen_mult <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            hx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h'</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">h'</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">h'</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sets of generators›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is no definition for ``<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>gens›</span></span></span></span> is a generating set of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>G›</span></span></span></span>''. This is easily expressed by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟨gens⟩ = carrier G›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is an application of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>hom_unique_on_span›</span></span></span></span> on a
generating set of the whole group.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> hom_unique_by_gens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"group <span class="free">H</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> gens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">=</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> hom <span class="free">G</span> <span class="free">H</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="main">∈</span> hom <span class="free">G</span> <span class="free">H</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> <span class="free">gens</span><span class="main">.</span> <span class="free">h</span> <span class="bound">g</span> <span class="main">=</span> <span class="free">h'</span> <span class="bound">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> carrier <span class="free">G</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">h'</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>

  <span class="keyword1"><span class="command">from</span></span> gens <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_span.gen_gens<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> group_axioms <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">h'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">erule</span> hom_unique_on_span<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> gens <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">G</span> <span class="main">⟹</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group_hom<span class="main">)</span> hom_span<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">`</span> <span class="main">(</span><span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">h</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Set.set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G.gen_span_closed<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">h</span> <span class="main">`</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">h</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gen_inv <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">h</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> carrier <span class="free">G</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_span.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gen_mult <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">h</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">h</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> carrier <span class="free">G</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_span.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_span.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">h</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">h</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">h</span> <span class="main">`</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>gen_span.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gen_inv <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span>  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>G.gen_span_closed<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>hom_inv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> rev_image_eqI gen_span.gen_inv <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>group_hom.hom_inv hom_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gen_mult <span class="skolem">y</span> <span class="skolem">y'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span>  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">x'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">gens</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">gens</span> <span class="main">⊆</span> carrier <span class="free">G</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>G.gen_span_closed<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>hom_mult<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> rev_image_eqI gen_span.gen_mult <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>group_hom.hom_mult hom_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>rev_image_eqI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_span.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product of a list of group elements›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Not strictly related to generators of groups, this is still a general
group concept and not related to Free Groups.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid<span class="main">)</span> <span class="entity">m_concat</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m_concat</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> foldr <span class="main">(⊗</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">𝟭</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid<span class="main">)</span> m_concat_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"set <span class="free">l</span> <span class="main">⊆</span> carrier <span class="free">G</span> <span class="main">⟹</span> m_concat <span class="free">l</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid<span class="main">)</span> m_concat_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">a</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">b</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"m_concat <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> m_concat <span class="free">a</span> <span class="main">⊗</span> m_concat <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid<span class="main">)</span> m_concat_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> carrier <span class="free">G</span> <span class="main">;</span> set <span class="free">xs</span> <span class="main">⊆</span> carrier <span class="free">G</span> <span class="main">⟧</span> <span class="main">⟹</span> m_concat <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊗</span> m_concat <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_assoc<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid<span class="main">)</span> nat_pow_mult1l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> Suc <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>nat_pow_mult <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>One_nat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid<span class="main">)</span> m_concat_power<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="free">G</span> <span class="main">⟹</span> m_concat <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nat_pow_mult1l<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Isomorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A nicer way of proving that something is a group homomorphism or
isomorphism.›</span></span>

<span class="keyword1" id="Generators-group_homI"><span class="command">lemma</span></span> group_homI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">`</span> <span class="main">(</span>carrier <span class="free">g1</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="free">g2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="free">g1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>carrier <span class="free">g1</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="bound">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">g1</span></sub><span class="hidden">⇙</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">g2</span></sub><span class="hidden">⇙</span> <span class="free">h</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> hom <span class="free">g1</span> <span class="free">g2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> carrier <span class="free">g1</span> <span class="main">→</span> carrier <span class="free">g2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> range  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> hom <span class="free">g1</span> <span class="free">g2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hom <span class="keyword1"><span class="command">unfolding</span></span> hom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group_hom<span class="main">)</span> hom_injI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="free">G</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">h</span> <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>carrier <span class="free">G</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>carrier <span class="free">G</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⊗</span> <span class="keyword1">inv</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊗</span> <span class="keyword1">inv</span> <span class="skolem">y</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊗</span> <span class="keyword1">inv</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword2"><span class="keyword">and</span></span> y 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> G.inv_equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group_hom<span class="main">)</span> group_hom_isoI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inj1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="free">G</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> surj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">`</span> <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">=</span> carrier <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> iso <span class="free">G</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inj1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">h</span> <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hom_injI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">h</span> <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> surj  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> iso_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generators-group_isoI"><span class="command">lemma</span></span> group_isoI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"group <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"group <span class="free">H</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inj1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="free">G</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> surj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">`</span> <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">=</span> carrier <span class="free">H</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="free">G</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>carrier <span class="free">G</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="bound">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="free">h</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> iso <span class="free">G</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> surj
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> carrier <span class="free">G</span> <span class="main">→</span> carrier <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> group_hom <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">h</span></span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword2"><span class="keyword">and</span></span> hom
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> group_hom.intro group_hom_axioms.intro<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> hom_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> group_hom_isoI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FreeGroups">
<div class="head">
<h1>Theory FreeGroups</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Free Group›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"FreeGroups"</span>
<span class="keyword2"><span class="keyword">imports</span></span>
   <span class="quoted">"<a href="../../HOL/HOL-Algebra/Group.html">HOL-Algebra.Group</a>"</span>
   <a href="Cancelation.html">Cancelation</a>
   <a href="Generators.html">Generators</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Based on the work in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> "<a href="Cancelation.html"></a><a href="Cancelation.html">Free-Groups.Cancelation</a>"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, the free group is now easily defined
over the set of fully canceled words with the corresponding operations.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inversion›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
To define the inverse of a word, we first create a helper function that inverts
a single generator, and show that it is self-inverse.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> g_i <span class="main">⇒</span> <span class="tfree">'a</span> g_i"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv1</span> <span class="main">=</span> apfst Not"</span></span>

<span class="keyword1" id="FreeGroups-inv1_inv1"><span class="command">lemma</span></span> inv1_inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv1 <span class="main">∘</span> inv1 <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff comp_def inv1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> inv1_inv1_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> inv1_inv1<span class="main">[</span><span class="operator">unfolded</span> id_def<span class="main">]</span>

<span class="keyword1" id="FreeGroups-snd_inv1"><span class="command">lemma</span></span> snd_inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> inv1 <span class="main">=</span> snd"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff comp_def inv1_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The inverse of a word is obtained by reversing the order of the generators and
inverting each generator using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">inv1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Some properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">inv_fg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
are noted.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_fg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word_g_i <span class="main">⇒</span> <span class="tfree">'a</span> word_g_i"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_fg</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> rev <span class="main">(</span>map inv1 <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FreeGroups-cancelling_inf"><span class="command">lemma</span></span> cancelling_inf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span>inv1 <span class="free">a</span><span class="main">)</span> <span class="main">(</span>inv1 <span class="free">b</span><span class="main">)</span> <span class="main">=</span> canceling <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceling_def inv1_def<span class="main">)</span>

<span class="keyword1" id="FreeGroups-inv_idemp"><span class="command">lemma</span></span> inv_idemp<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_fg <span class="main">(</span>inv_fg <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inv_fg_def rev_map<span class="main">)</span>

<span class="keyword1" id="FreeGroups-inv_fg_cancel"><span class="command">lemma</span></span> inv_fg_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="free">l</span> <span class="main">@</span> inv_fg <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_fg_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="skolem">x</span> <span class="main">(</span>inv1 <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inv1_def canceling_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="var">?i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_fg <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>inv1 <span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> inv_fg <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inv_fg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="var">?i</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>inv_fg <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> inv_fg <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def cancel_at_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>inv_fg <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> inv_fg <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cancels_to_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>inv_fg <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> inv_fg <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹normalize <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">(</span>inv_fg <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>inv_fg <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FreeGroups-inv_fg_cancel2"><span class="command">lemma</span></span> inv_fg_cancel2<span class="main">:</span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span>inv_fg <span class="free">l</span> <span class="main">@</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span>inv_fg <span class="free">l</span> <span class="main">@</span> inv_fg <span class="main">(</span>inv_fg <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_fg_cancel<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span>inv_fg <span class="free">l</span> <span class="main">@</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_idemp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FreeGroups-canceled_rev"><span class="command">lemma</span></span> canceled_rev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"canceled <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>canceled <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Domainp cancels_to_1 <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceled_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">i</span> <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span>rev <span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="var">?x</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">=</span> Suc<span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="var">?x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth map_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹canceling <span class="main">(</span>rev <span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">l</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="var">?x</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="var">?x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="var">?x</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="var">?x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancel_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="var">?x</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> Suc <span class="var">?x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="var">?x</span> <span class="free">l</span> <span class="main">(</span>cancel_at <span class="var">?x</span> <span class="free">l</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="free">l</span> <span class="main">(</span>cancel_at <span class="var">?x</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>canceled <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceled_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="free">l</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FreeGroups-inv_fg_closure1"><span class="command">lemma</span></span> inv_fg_closure1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"canceled <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>inv_fg <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inv_fg_def <span class="keyword2"><span class="keyword">and</span></span> inv1_def <span class="keyword2"><span class="keyword">and</span></span> apfst_def
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj Not"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>injI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on id <span class="main">(</span>snd <span class="main">`</span> set <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>map <span class="main">(</span>map_prod Not id<span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="free">l</span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> rename_gens_canceled<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"canceled <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span>map_prod Not id<span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> canceled_rev<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FreeGroups-inv_fg_closure2"><span class="command">lemma</span></span> inv_fg_closure2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span> <span class="main">⟹</span> inv_fg <span class="free">l</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inv1_def inv_fg_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Finally, we can define the Free Group over a set of generators, and show that it
is indeed a group.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">free_group</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span>bool <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> list<span class="main">)</span> monoid"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℱ</span>ı"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℱ</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">gens</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="main">⦇</span>
     carrier <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span><span class="main">∈</span>lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">gens</span></span></span><span class="main">)</span><span class="main">.</span> canceled <span class="bound">l</span> <span class="main">}</span><span class="main">,</span>
     mult <span class="main">=</span> <span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> normalize <span class="main">(</span><span class="bound">x</span> <span class="main">@</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span>
     one <span class="main">=</span> <span class="main">[]</span>
  <span class="main">⦈</span>"</span></span>


<span class="keyword1" id="FreeGroups-occuring_gens_in_element"><span class="command">lemma</span></span> occuring_gens_in_element<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> free_group_is_group<span class="main">:</span> <span class="quoted"><span class="quoted">"group <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span>
    <span class="main">(</span><span class="operator">rule</span> occuring_gens_in_element<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span>
    <span class="main">(</span><span class="operator">rule</span> occuring_gens_in_element<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword2"><span class="keyword">and</span></span> y
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> normalize_preserves_generators <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def append_in_lists_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">y</span><span class="main">::</span><span class="tfree">'a</span> word_g_i<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="skolem">z</span> <span class="main">(</span><span class="skolem">z</span><span class="main">::</span><span class="tfree">'a</span> word_g_i<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span>normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> normalize <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalize_append_cancel_to<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">@</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="skolem">y</span> <span class="main">@</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>normalize <span class="main">(</span><span class="skolem">y</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">z</span><span class="main">::</span><span class="tfree">'a</span> word_g_i<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="skolem">x</span> <span class="main">(</span><span class="skolem">x</span><span class="main">::</span><span class="tfree">'a</span> word_g_i<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">@</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> normalize <span class="main">(</span><span class="skolem">y</span> <span class="main">@</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> normalize_append_cancel_to<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">z</span> <span class="main">=</span>
        <span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> Units <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def Units_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word_g_i"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_fg <span class="skolem">x</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens</span><span class="main">)</span><span class="main">.</span> canceled <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x'</span> <span class="main">∈</span> lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens</span><span class="main">)</span> <span class="main">∧</span> canceled <span class="var">?x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>inv_fg_closure1 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inv_fg_closure2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="var">?x'</span> <span class="main">@</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="var">?x'</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inv_fg_cancel inv_fg_cancel2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span> <span class="main">∧</span>
                  canceled <span class="bound">y</span> <span class="main">∧</span>
                  normalize <span class="main">(</span><span class="bound">y</span> <span class="main">@</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens</span><span class="main">)</span><span class="main">.</span> canceled <span class="bound">y</span><span class="main">}</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span><span class="main">.</span>  canceled <span class="bound">y</span>  <span class="main">∧</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span> <span class="main">∧</span>
                  canceled <span class="bound">x</span> <span class="main">∧</span>
                  normalize <span class="main">(</span><span class="bound">x</span> <span class="main">@</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> normalize <span class="main">(</span><span class="bound">y</span> <span class="main">@</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FreeGroups-inv_is_inv_fg"><span class="command">lemma</span></span> inv_is_inv_fg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="keyword1">inv</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="free">x</span> <span class="main">=</span> inv_fg <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> group.inv_equality<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_is_group<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_group_def inv_fg_cancel inv_fg_cancel2 inv_fg_closure1 inv_fg_closure2<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The universal property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Free Groups are important due to their universal property: Every map of
the set of generators to another group can be extended uniquely to an
homomorphism from the Free Group.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ι</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ι</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="FreeGroups-insert_closed"><span class="command">lemma</span></span> insert_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">gens</span> <span class="main">⟹</span> <span class="keyword1">ι</span> <span class="free">g</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_def free_group_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> <span class="entity">lift_gi</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_gi</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gi</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">gi</span></span></span> <span class="keyword1">then</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">gi</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">gi</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> lift_gi_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">gens</span> <span class="main">→</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">gi</span> <span class="main">∈</span> <span class="free">gens</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift_gi <span class="free">f</span> <span class="free">gi</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_gi_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> <span class="entity">lift</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> m_concat <span class="main">(</span>map <span class="main">(</span>lift_gi <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> lift_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> lift_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">gens</span> <span class="main">→</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>lift_gi <span class="free">f</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_gi_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> lift_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">gens</span> <span class="main">→</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> lift <span class="free">f</span> <span class="free">x</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map snd <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">gens</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>lift_gi <span class="free">f</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_gi_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map snd <span class="free">y</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">gens</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>lift_gi <span class="free">f</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_gi_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> lift <span class="free">f</span> <span class="free">x</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_def m_assoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>set_map foldr_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> lift_cancels_to<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">gens</span> <span class="main">→</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> lift <span class="free">f</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> cancels_to_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="skolem">y</span>›</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> cancels_to_preserves_generators<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancels_to_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> lift <span class="free">f</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cancels_to_1 <span class="skolem">y</span> <span class="skolem">z</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys1</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="skolem"><span class="skolem">ys2</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">ys1</span> <span class="main">@</span> <span class="skolem">y1</span> <span class="main">#</span> <span class="skolem">y2</span> <span class="main">#</span> <span class="skolem">ys2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">ys1</span> <span class="main">@</span> <span class="skolem">ys2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"canceling <span class="skolem">y1</span> <span class="skolem">y2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cancels_to_1_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="skolem">y</span>  <span class="main">=</span> lift <span class="free">f</span> <span class="main">(</span><span class="skolem">ys1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y2</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> y <span class="keyword2"><span class="keyword">and</span></span> cl <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">(</span><span class="skolem">ys1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y2</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys2</span><span class="main">)</span>
        <span class="main">=</span> lift <span class="free">f</span> <span class="skolem">ys1</span> <span class="main">⊗</span> <span class="main">(</span>lift <span class="free">f</span> <span class="main">[</span><span class="skolem">y1</span><span class="main">]</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="main">[</span><span class="skolem">y2</span><span class="main">]</span><span class="main">)</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="skolem">ys2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lift_append<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_Cons <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>m_assoc <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> cl<span class="main">[</span><span class="operator">THEN</span> funcset_image<span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> y <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹canceling <span class="skolem">y1</span> <span class="skolem">y2</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lift <span class="free">f</span> <span class="main">[</span><span class="skolem">y1</span><span class="main">]</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="main">[</span><span class="skolem">y2</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_def lift_gi_def canceling_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="skolem">ys1</span> <span class="main">⊗</span> <span class="main">(</span>lift <span class="free">f</span> <span class="main">[</span><span class="skolem">y1</span><span class="main">]</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="main">[</span><span class="skolem">y2</span><span class="main">]</span><span class="main">)</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="skolem">ys2</span>
           <span class="main">=</span> lift <span class="free">f</span> <span class="skolem">ys1</span> <span class="main">⊗</span> <span class="main">𝟭</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="skolem">ys2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> y <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> cl
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="skolem">ys1</span> <span class="main">⊗</span> <span class="main">𝟭</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="skolem">ys2</span> <span class="main">=</span> lift <span class="free">f</span> <span class="main">(</span><span class="skolem">ys1</span> <span class="main">@</span> <span class="skolem">ys2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lift_append <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">ys1</span> <span class="main">@</span> <span class="skolem">ys2</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">(</span><span class="skolem">ys1</span> <span class="main">@</span> <span class="skolem">ys2</span><span class="main">)</span> <span class="main">=</span> lift <span class="free">f</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> lift <span class="free">f</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> lift_is_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">gens</span> <span class="main">→</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">∈</span> hom <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> free_group_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lift_def lift_gi_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cancels_to <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> lift_cancels_to<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹cancels_to <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>normalize <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> cl
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> lift <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">gens</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cl
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> lift <span class="free">f</span> <span class="skolem">x</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> lift <span class="free">f</span> <span class="skolem">x</span> <span class="main">⊗</span> lift <span class="free">f</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">∈</span> hom <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FreeGroups-gens_span_free_group"><span class="command">lemma</span></span> gens_span_free_group<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">=</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> group <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_group_is_group<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">⊆</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> gen_span_closed<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_def free_group_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>  <span class="main">⊆</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"one <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cons_canceled <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span> <span class="main">∈</span> <span class="free">gens</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> isa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ι</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_gens<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">ι</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_def<span class="main">)</span>
           <span class="keyword1"><span class="command">with</span></span> isa <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">a</span> <span class="main">∈</span> <span class="free">gens</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ι</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def insert_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> True
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">inv</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">ι</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_def inv_fg_def inv1_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> isa
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">ι</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_inv<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mult <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> lift_is_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"group <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">gens</span> <span class="main">→</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> hom <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">gens</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="keyword1">ι</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">=</span> lift <span class="free">f</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> gens_span_free_group<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> hom_unique_on_span<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℱ</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="free">gens</span></span></sub><span class="hidden">⇙</span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"group <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_group_is_group<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"group <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span> <span class="main">⊆</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>insert_closed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> hom <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">f</span> <span class="main">∈</span> hom <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens</span></sub><span class="hidden">⇙</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lift_is_hom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cl<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span> <span class="free">gens</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="keyword1">ι</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">g</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">[</span><span class="operator">THEN</span> funcset_image<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span> <span class="keyword1">ι</span> <span class="main">`</span> <span class="free">gens</span><span class="main">.</span> <span class="free">h</span> <span class="bound">g</span> <span class="main">=</span> lift <span class="free">f</span> <span class="bound">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_def lift_def lift_gi_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="UnitGroup">
<div class="head">
<h1>Theory UnitGroup</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Unit Group›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"UnitGroup"</span>
<span class="keyword2"><span class="keyword">imports</span></span>
   <span class="quoted">"<a href="../../HOL/HOL-Algebra/Group.html">HOL-Algebra.Group</a>"</span>
   <a href="Generators.html">Generators</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is, up to isomorphisms, only one group with one element.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unit_group</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit monoid"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">unit_group</span> <span class="main">≡</span> <span class="main">⦇</span>
     carrier <span class="main">=</span> UNIV<span class="main">,</span>
     mult <span class="main">=</span> <span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">()</span><span class="main">,</span>
     one <span class="main">=</span> <span class="main">()</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> unit_group_is_group<span class="main">:</span> <span class="quoted"><span class="quoted">"group unit_group"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> groupI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>unit_group_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> unit_group_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> iso <span class="free">G</span> unit_group"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">G</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> card_eq_SucD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">()</span><span class="main">)</span> <span class="main">∈</span> iso <span class="free">G</span> unit_group"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> group_isoI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>unit_group_is_group is_group<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>unit_group_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="C2">
<div class="head">
<h1>Theory C2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> C2
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Algebra/Group.html">HOL-Algebra.Group</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The group C2›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The two-element group is defined over the set of boolean values. This allows to 
use the equality of boolean values as the group operation.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">C2</span>"</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C2</span> <span class="main">=</span> <span class="main">⦇</span> carrier <span class="main">=</span> UNIV<span class="main">,</span> mult <span class="main">=</span> <span class="main">(=)</span><span class="main">,</span> one <span class="main">=</span> True <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(⊗</span><span class="hidden">⇘</span><sub>C2</sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> C2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub>C2</sub><span class="hidden">⇙</span> <span class="main">=</span> True"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> C2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier C2 <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> C2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="C2-C2_is_group"><span class="command">lemma</span></span> C2_is_group<span class="main">:</span> <span class="quoted"><span class="quoted">"group C2"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> C2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> groupI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Units_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Isomorphisms">
<div class="head">
<h1>Theory Isomorphisms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Isomorphisms of Free Groups›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Isomorphisms"</span>
<span class="keyword2"><span class="keyword">imports</span></span>
   <a href="UnitGroup.html">UnitGroup</a>
   <span class="quoted">"<a href="../../HOL/HOL-Algebra/IntRing.html">HOL-Algebra.IntRing</a>"</span>
   <a href="FreeGroups.html">FreeGroups</a>
   <a href="C2.html">C2</a>
   <span class="quoted">"<a href="../../HOL/HOL-Cardinals/Cardinal_Order_Relation.html">HOL-Cardinals.Cardinal_Order_Relation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Free Group over the empty set›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Free Group over an empty set of generators is isomorphic to the trivial
group.›</span></span>

<span class="keyword1" id="Isomorphisms-free_group_over_empty_set"><span class="command">lemma</span></span> free_group_over_empty_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> iso <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{}</span></sub><span class="hidden">⇙</span> unit_group"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> group.unit_group_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"group <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{}</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_group_is_group<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{}</span><span class="main">::</span><span class="tfree">'a</span> set</sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{}</span><span class="main">::</span><span class="tfree">'a</span> set</sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Free Group over one generator›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Free Group over one generator is isomorphic to the free abelian group
over one element, also known as the integers.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted">"<span class="entity">int_group</span>"</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">int_group</span> <span class="main">≡</span> <span class="main">⦇</span> carrier <span class="main">=</span> carrier <span class="keyword1">𝒵</span><span class="main">,</span> monoid.mult <span class="main">=</span> <span class="main">(+)</span><span class="main">,</span> one <span class="main">=</span> <span class="main">0</span><span class="main">::</span>int <span class="main">⦈</span>"</span></span>

<span class="keyword1" id="Isomorphisms-replicate_set_eq"><span class="command">lemma</span></span> replicate_set_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span><span class="operator">auto</span>

<span class="keyword1" id="Isomorphisms-int_group_gen_by_one"><span class="command">lemma</span></span> int_group_gen_by_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">=</span> carrier int_group"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">⊆</span> carrier int_group"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier int_group <span class="main">⊆</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> int<span class="main">:</span> group <span class="quoted">int_group</span>
      <span class="keyword1"><span class="command">using</span></span> int.a_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> plus1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_span.gen_gens<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gen_span.gen_inv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">=</span> <span class="keyword1">inv</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> int.inv_equality<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> minus1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">::</span>int<span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span> <span class="comment1">(*
    It does not work directly, unfortunately:
    apply(induct x rule:int_induct[of _ "0::int"])
    apply (auto simp add: int_arith_rules intro:gen_span.intros[of int_group])
    *)</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>int_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>int"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">::</span>int<span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gen_span.gen_one<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step1 <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> plus1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gen_span.gen_mult<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step2 <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> minus1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">-</span><span class="main">1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gen_span.gen_mult<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Isomorphisms-free_group_over_one_gen"><span class="command">lemma</span></span> free_group_over_one_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> iso <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span> int_group"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> int<span class="main">:</span> group <span class="quoted">int_group</span> 
    <span class="keyword1"><span class="command">using</span></span> int.a_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="main">{</span><span class="main">()</span><span class="main">}</span> <span class="main">→</span> carrier int_group"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int.lift <span class="skolem">f</span> <span class="main">∈</span> hom <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span> int_group"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> int.lift_is_hom<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> hom<span class="main">:</span> group_hom <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span>"</span></span> <span class="quoted">int_group</span> <span class="quoted"><span class="quoted">"int.lift <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> group_hom_def group_hom_axioms_def
    <span class="keyword1"><span class="command">using</span></span> int.a_group <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> free_group_is_group<span class="main">)</span>
    
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* This shows injectiveness of the given map *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"canceled <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"int.lift <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≥</span> length <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_length_takeWhile<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> fst <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">!</span> Suc <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> takeWhile_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>set_takeWhileD<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> canceling_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1_at <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">(</span>cancel_at <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> length <span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_1_at_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>length_takeWhile_le<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="skolem">x</span> <span class="main">(</span>cancel_at <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cancels_to_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> canceled <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> canceled_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>le_antisym <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>length_takeWhile_le<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> takeWhile_eq_take<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_takeWhileD<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int.lift <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> int.lift <span class="skolem">f</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> pow int_group <span class="main">(</span>int.lift_gi <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> local.int.nat_pow_Suc local.int.nat_pow_0
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> int.lift_def <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>int.lift_gi <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> int <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> local.int.nat_pow_Suc local.int.nat_pow_0
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> int_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹int.lift <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>abs <span class="main">(</span>group.lift_gi int_group <span class="skolem">f</span> <span class="skolem">a</span> <span class="main">*</span> int <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>abs <span class="main">(</span>group.lift_gi int_group <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> length <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>abs <span class="main">(</span>group.lift_gi int_group <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">1</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> int.inv_equality <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>group.lift_gi int_group <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> int.is_group
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> group.lift_gi_def f_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span><span class="main">.</span> int.lift <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟨</span>insert<span class="main">`</span><span class="main">{</span><span class="main">()</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gens_span_free_group<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier int_group <span class="main">=</span> <span class="main">⟨</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> int_group_gen_by_one<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int.lift <span class="skolem">f</span> <span class="main">`</span> insert <span class="main">`</span> <span class="main">{</span><span class="main">()</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int.lift_def <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> insert_def f_def int.lift_gi_def <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"int.lift <span class="skolem">f</span> <span class="main">`</span> <span class="main">⟨</span>insert<span class="main">`</span><span class="main">{</span><span class="main">()</span><span class="main">}</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟨</span>int.lift <span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span>insert <span class="main">`</span><span class="main">{</span><span class="main">()</span><span class="main">}</span><span class="main">)</span><span class="main">⟩</span><span class="hidden">⇘</span><sub>int_group</sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hom.hom_span<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>insert_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int.lift <span class="skolem">f</span> <span class="main">`</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span> <span class="main">=</span> carrier int_group"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int.lift <span class="skolem">f</span> <span class="main">∈</span> iso <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span> int_group"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹int.lift <span class="skolem">f</span> <span class="main">∈</span> hom <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="main">{</span><span class="main">()</span><span class="main">}</span></sub><span class="hidden">⇙</span> int_group›</span></span>
    <span class="keyword1"><span class="command">using</span></span> hom.hom_mult int.is_group
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>group_isoI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_group_is_group<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Free Groups over isomorphic sets of generators›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Free Groups are isomorphic if their set of generators are isomorphic.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_generator_function</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>bool <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>bool <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_generator_function</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> isomorphic_free_groups<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">gens1</span> <span class="free">gens2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift_generator_function <span class="free">f</span> <span class="main">∈</span> iso <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span> <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens2</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lift_generator_function_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> group_isoI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span><span class="main">.</span>
       map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens2</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bij_betw <span class="free">f</span> <span class="free">gens1</span> <span class="free">gens2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">gens1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>bij_betw_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="main">`</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span> <span class="main">=</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens2</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Set.set_eqI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bij_betw <span class="free">f</span> <span class="free">gens1</span> <span class="free">gens2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">gens1</span> <span class="main">=</span> <span class="free">gens2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>bij_betw_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> image <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceled <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens1</span><span class="main">)</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">y</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹image <span class="free">f</span> <span class="free">gens1</span> <span class="main">=</span> <span class="free">gens2</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">y</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens1</span><span class="main">)</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="skolem">y</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">gens1</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceled <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rename_gens_canceled subset_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">gens1</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens2</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens2</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"canceled <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> free_group_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="main">(</span>the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span>
          map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="main">(</span>the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>y_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="free">f</span> <span class="main">∘</span> map_prod id <span class="main">(</span>the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map id <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> map_ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> <span class="tfree">'b</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> set <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens2</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map snd <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">gens2</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="skolem">x</span> <span class="main">⊆</span> <span class="free">gens2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_map<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xa</span> <span class="main">∈</span> set <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">xa</span> <span class="main">∈</span> <span class="free">gens2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹bij_betw <span class="free">f</span> <span class="free">gens1</span> <span class="free">gens2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">xa</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">gens1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_prod id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xa</span>
            <span class="main">=</span> map_prod id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">xa</span><span class="main">,</span> snd <span class="skolem">xa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">xa</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span>the_inv_into <span class="free">gens1</span> <span class="free">f</span> <span class="main">(</span>snd <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">xa</span> <span class="main">∈</span> image <span class="free">f</span> <span class="free">gens1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">gens1</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">xa</span><span class="main">,</span> snd <span class="skolem">xa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>f_the_inv_into_f <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> id <span class="skolem">xa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_prod id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> id <span class="skolem">xa</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bij_betw <span class="free">f</span> <span class="free">gens1</span> <span class="free">gens2</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span> <span class="free">gens2</span> <span class="free">gens1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_the_inv_into<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span> <span class="free">gens2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_imp_inj_on<span class="main">)</span>

      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹canceled <span class="skolem">x</span>›</span></span>      
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> lists <span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens2</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canceled <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rename_gens_canceled<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_inj_on<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>y_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bij_betw <span class="main">(</span>the_inv_into <span class="free">gens1</span> <span class="free">f</span><span class="main">)</span> <span class="free">gens2</span> <span class="free">gens1</span>›</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span>lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens2</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword2"><span class="keyword">and</span></span> bij_betw_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>subsetD<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="main">`</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bij_betw <span class="free">f</span> <span class="free">gens1</span> <span class="free">gens2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">gens1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>bij_betw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>occuring_gens_in_element<span class="main">)</span>
<span class="comment1">(*  hence "occuring_generators (x@y) ⊆ gens1"
    by(auto simp add:occuring_generators_def)
  with `inj_on f gens1` have "inj_on f (occuring_generators (x@y))"
    by (rule subset_inj_on) *)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span><span class="main">)</span>
       <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="main">(</span>normalize <span class="main">(</span><span class="skolem">x</span><span class="main">@</span><span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="comment1">(* from `inj_on f (occuring_generators (x@y))` *)</span>
       <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens1</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> lists<span class="main">(</span>UNIV<span class="main">×</span><span class="free">gens1</span><span class="main">)</span>›</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">gens1</span>›</span></span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> normalize <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">@</span><span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> rename_gens_normalize<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
              <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subset_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">gens1</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>lists_eq_set<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> normalize <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">@</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens2</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span>
                map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens2</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="skolem">y</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span><span class="main">.</span>
       <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span><span class="main">.</span>
          map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens1</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span>
          map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">gens2</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span> map <span class="main">(</span>map_prod id <span class="free">f</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> free_group_is_group<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bases of isomorphic free groups›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Isomorphic free groups have bases of same cardinality. The proof is very different
for infinite bases and for finite bases.

The proof for the finite case uses the set of of homomorphisms from the free
group to the group with two elements, as suggested by Christian Sievers. The
definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">hom</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not suitable for proofs about the cardinality of that
set, as its definition does not require extensionality. This is amended by the
following definition:
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">homr</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">homr</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> hom <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">∈</span> extensional <span class="main">(</span>carrier <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group_hom<span class="main">)</span> restrict_hom<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">h</span> <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">∈</span> homr <span class="free">G</span> <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> homr_def <span class="keyword2"><span class="keyword">and</span></span> hom_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Isomorphisms-hom_F_C2_Powerset"><span class="command">lemma</span></span> hom_F_C2_Powerset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> bij_betw <span class="bound">f</span> <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span> <span class="main">(</span>homr <span class="main">(</span><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">)</span> C2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> F<span class="main">:</span> group <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_group_is_group<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> C2<span class="main">:</span> group <span class="quoted">C2</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C2_is_group<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">S</span> <span class="main">.</span> restrict <span class="main">(</span>C2.lift <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span> <span class="main">.</span> <span class="free">X</span> <span class="main">∩</span> Collect<span class="main">(</span><span class="bound">h</span> <span class="main">∘</span> insert<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span> <span class="main">(</span>homr <span class="main">(</span><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">)</span> C2<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bij_betwI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> Pow <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">interpret</span></span> h<span class="main">:</span> group_hom <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span>"</span></span> <span class="quoted">C2</span> <span class="quoted"><span class="quoted">"C2.lift <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> C2.lift_is_hom<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">S</span> <span class="main">∈</span> homr <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span> C2"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> h.restrict_hom<span class="main">)</span>
     <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">S</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Set.set_eqI<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_def C2.lift_def C2.lift_gi_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">h</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> hom <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span> C2"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> extn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> extensional <span class="main">(</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> homr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span> <span class="main">.</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">=</span> group.lift C2 <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">&amp;</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">∘</span> FreeGroups.insert<span class="main">)</span> <span class="bound">z</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C2.lift_is_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C2_is_group _ hom<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">z</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">z</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="free"><span class="free"><span class="free">X</span></span></span> <span class="main"><span class="main"><span class="main">&amp;</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">h</span></span></span> <span class="main"><span class="main"><span class="main">∘</span></span></span> FreeGroups.insert<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="bound"><span class="bound"><span class="bound">z</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> extensionalityI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> restrict_extensional extn<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Isomorphisms-group_iso_betw_hom"><span class="command">lemma</span></span> group_iso_betw_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"group <span class="free">G1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"group <span class="free">G2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> iso <span class="free">G1</span> <span class="free">G2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f</span> <span class="main">.</span> bij_betw <span class="bound">f</span> <span class="main">(</span>homr <span class="free">G2</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>homr <span class="free">G1</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> G2<span class="main">:</span> group <span class="quoted"><span class="free">G2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹group <span class="free">G2</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span>inv_into <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">G2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_into <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="free">i</span> <span class="main">∈</span> iso <span class="free">G2</span> <span class="free">G1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹group <span class="free">G1</span>›</span></span> group.iso_set_sym iso<span class="main">)</span>    
  <span class="keyword1"><span class="command">hence</span></span> iso'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">∈</span> iso <span class="free">G2</span> <span class="free">G1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Group.iso_def hom_def G2.m_closed<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bij_betwI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">h</span></span><span class="main"><span class="main">.</span></span> compose <span class="main"><span class="main">(</span></span>carrier <span class="free"><span class="free">G1</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">h</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">h</span></span><span class="main"><span class="main">.</span></span> compose <span class="main"><span class="main">(</span></span>carrier <span class="free"><span class="free">G2</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">h</span></span> <span class="var"><span class="var">?i'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> homr <span class="free">G2</span> <span class="free">H</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"compose <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="skolem">h</span> <span class="free">i</span> <span class="main">∈</span> hom <span class="free">G1</span> <span class="free">H</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> iso
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> group.hom_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹group <span class="free">G1</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">G2</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Group.iso_def homr_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"compose <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="skolem">h</span> <span class="free">i</span> <span class="main">∈</span> homr <span class="free">G1</span> <span class="free">H</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> homr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> homr <span class="free">G1</span> <span class="free">H</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"compose <span class="main">(</span>carrier <span class="free">G2</span><span class="main">)</span> <span class="skolem">h</span> <span class="var">?i'</span> <span class="main">∈</span> hom <span class="free">G2</span> <span class="free">H</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> iso'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> group.hom_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹group <span class="free">G2</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">G1</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Group.iso_def homr_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"compose <span class="main">(</span>carrier <span class="free">G2</span><span class="main">)</span> <span class="skolem">h</span> <span class="var">?i'</span> <span class="main">∈</span> homr <span class="free">G2</span> <span class="free">H</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> homr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"compose <span class="main">(</span>carrier <span class="free">G2</span><span class="main">)</span> <span class="main">(</span>compose <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="skolem">x</span> <span class="free">i</span><span class="main">)</span> <span class="var">?i'</span>
          <span class="main">=</span> compose <span class="main">(</span>carrier <span class="free">G2</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span>compose <span class="main">(</span>carrier <span class="free">G2</span><span class="main">)</span> <span class="free">i</span> <span class="var">?i'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> iso iso'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> compose_assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Group.iso_def hom_def homr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> compose <span class="main">(</span>carrier <span class="free">G2</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">∈</span>carrier <span class="free">G2</span><span class="main">.</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> iso
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> compose_id_inv_into<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Group.iso_def hom_def bij_betw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>compose_Id <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>homr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"compose <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="main">(</span>compose <span class="main">(</span>carrier <span class="free">G2</span><span class="main">)</span> <span class="skolem">y</span> <span class="var">?i'</span><span class="main">)</span> <span class="free">i</span>
          <span class="main">=</span> compose <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>compose <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="var">?i'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> iso iso'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> compose_assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Group.iso_def hom_def homr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> compose <span class="main">(</span>carrier <span class="free">G1</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="free">G1</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> iso
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> compose_inv_into_id<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Group.iso_def hom_def bij_betw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>compose_Id <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>homr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Isomorphisms-isomorphic_free_groups_bases_finite"><span class="command">lemma</span></span> isomorphic_free_groups_bases_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> iso <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span> <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">Y</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij_betw <span class="bound">f</span> <span class="free">X</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">(</span>homr <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">Y</span></sub><span class="hidden">⇙</span> C2<span class="main">)</span> <span class="main">(</span>homr <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span> C2<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group_iso_betw_hom<span class="main">[</span><span class="operator">OF</span> free_group_is_group free_group_is_group iso<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">g'</span> <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span> <span class="main">(</span>homr <span class="main">(</span><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">)</span> C2<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hom_F_C2_Powerset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">g</span> <span class="main">(</span>homr <span class="main">(</span><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">)</span> C2<span class="main">)</span> <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bij_betw_inv_into<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="main">(</span>Pow <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>homr <span class="main">(</span><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">Y</span></sub><span class="hidden">⇙</span><span class="main">)</span> C2<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hom_F_C2_Powerset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="skolem">g</span> <span class="main">∘</span> <span class="skolem">f</span> <span class="main">∘</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bij_betw_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> eq_card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Pow <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> finite
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Pow <span class="free">Y</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> card_ge_0_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>card_Pow<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> finite'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">with</span></span> eq_card finite
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">X</span> <span class="main">=</span> card <span class="free">Y</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>card_Pow<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> finite finite'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_same_card_bij<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The proof for the infinite case is trivial once the fact that the free group
over an infinite set has the same cardinality is established.
›</span></span>

<span class="keyword1" id="Isomorphisms-free_group_card_infinite"><span class="command">lemma</span></span> free_group_card_infinite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="keyword1">=o</span> <span class="main">|</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">|</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on insert <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">`</span> <span class="free">X</span> <span class="main">⊆</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insert_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> inj_on <span class="bound">f</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">`</span> <span class="free">X</span> <span class="main">⊆</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_of_ordLeq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">|</span> <span class="keyword1">≤o</span> <span class="main">|</span>lists <span class="main">(</span><span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span><span class="main">×</span><span class="free">X</span><span class="main">)</span><span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>card_of_mono1 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>lists <span class="main">(</span><span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span><span class="main">×</span><span class="free">X</span><span class="main">)</span><span class="main">|</span> <span class="keyword1">=o</span> <span class="main">|</span><span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span><span class="main">×</span><span class="free">X</span><span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> finite <span class="free">X</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>card_of_lists_infinite <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>finite_cartesian_productD2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span><span class="main">×</span><span class="free">X</span><span class="main">|</span> <span class="keyword1">=o</span> <span class="main">|</span><span class="free">X</span><span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> finite <span class="free">X</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_of_Times_infinite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ ordLess_imp_ordLeq<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_ordLess_infinite2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="keyword1">=o</span> <span class="main">|</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ordIso_iff_ordLeq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ord_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> isomorphic_free_groups_bases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> iso <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span> <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">Y</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij_betw <span class="bound">f</span> <span class="free">X</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> iso <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> isomorphic_free_groups_bases_finite<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> iso <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> iso <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">Y</span></sub><span class="hidden">⇙</span> <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> free_group_is_group group.iso_set_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">Y</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij_betw <span class="bound">f</span> <span class="free">Y</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> isomorphic_free_groups_bases_finite<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij_betw <span class="bound">f</span> <span class="free">X</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bij_betw_the_inv_into<span class="main">)</span> <span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> finite <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="keyword1">=o</span> <span class="main">|</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">|</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_group_card_infinite<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> finite <span class="free">Y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">Y</span><span class="main">|</span> <span class="keyword1">=o</span> <span class="main">|</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">Y</span></sub><span class="hidden">⇙</span><span class="main">|</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_group_card_infinite<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> iso <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">X</span></sub><span class="hidden">⇙</span><span class="main">|</span> <span class="keyword1">=o</span> <span class="main">|</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">Y</span></sub><span class="hidden">⇙</span><span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Group.iso_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>card_of_ordIso<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="keyword1">=o</span> <span class="main">|</span><span class="free">Y</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ordIso_equivalence<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_of_ordIso<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PingPongLemma">
<div class="head">
<h1>Theory PingPongLemma</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Ping Pong lemma›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"PingPongLemma"</span>
<span class="keyword2"><span class="keyword">imports</span></span>
   <span class="quoted">"<a href="../../HOL/HOL-Algebra/Bij.html">HOL-Algebra.Bij</a>"</span>
   <a href="FreeGroups.html">FreeGroups</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The Ping Pong Lemma is a way to recognice a Free Group by its action on
a set (often a topological space or a graph). The name stems from the way that
elements of the set are passed forth and back between the subsets given there.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We start with two auxiliary lemmas, one about the identity of the group of
bijections, and one about sets of cardinality larger than one.
›</span></span>

<span class="keyword1" id="PingPongLemma-Bij_one"><span class="command">lemma</span></span> Bij_one<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub>BijGroup <span class="free">X</span></sub><span class="hidden">⇙</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BijGroup_def<span class="main">)</span>

<span class="keyword1" id="PingPongLemma-other_member"><span class="command">lemma</span></span> other_member<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
   <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">∈</span><span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≠</span><span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="free">I</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">∈</span><span class="free">I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1_left card_Diff_subset_Int card_Suc_Diff1 diff_add_inverse2 diff_self_eq_0 empty_Diff finite.emptyI inf_bot_left minus_nat.diff_0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_empty finite.emptyI finite_Diff_insert<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
And now we can attempt the lemma. The gencount condition is a weaker variant
of ``x has to lie outside all subsets'' that is only required if the set of
generators is one. Otherwise, we will be able to find a suitable x to start
with in the proof.
›</span></span>

<span class="keyword1" id="PingPongLemma-ping_pong_lemma"><span class="command">lemma</span></span> ping_pong_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"group <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">∈</span> hom <span class="free">G</span> <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="main">(</span><span class="free">I</span> <span class="main">→</span> carrier <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">g</span> <span class="main">`</span> <span class="free">I</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">=</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sub1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">Xout</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sub2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">Xin</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> disj1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">Xout</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">Xout</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> disj2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">Xin</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">Xin</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> disj3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">Xin</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">Xout</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> gencount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">.</span> <span class="free">I</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">x</span> <span class="main">∉</span> <span class="free">Xout</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">Xin</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ping<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">act</span> <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">Xout</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Xin</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">act</span> <span class="main">(</span><span class="keyword1">inv</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">Xin</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Xout</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"group.lift <span class="free">G</span> <span class="free">g</span> <span class="main">∈</span> iso <span class="main">(</span><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> F<span class="main">:</span> group <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_group_is_group<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> group <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> B<span class="main">:</span> group <span class="quoted"><span class="quoted">"BijGroup <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> group_BijGroup <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> act<span class="main">:</span> group_hom <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"BijGroup <span class="free">X</span>"</span></span> <span class="quoted"><span class="free">act</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> h<span class="main">:</span> group_hom <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span>"</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"G.lift <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> F.is_group G.is_group G.lift_is_hom assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> group_hom.intro group_hom_axioms.intro<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> h.group_hom_isoI<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Injectivity is the hard part of the proof.›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span><span class="main">.</span> G.lift <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
       <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

         <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We lift the Xout and Xin sets to generators and their inveres, and
         create variants of the disj-conditions:›</span></span>
         <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Xout'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Xout'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">::</span><span class="tfree">'d</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">Xin</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">Xout</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
         <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Xin'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Xin'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">::</span><span class="tfree">'d</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">Xout</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">Xin</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

         <span class="keyword1"><span class="command">have</span></span> disj1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>UNIV <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">(</span>UNIV <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="skolem">Xout'</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">Xout'</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> disj1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> disj2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> disj3<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Xout'_def Xin'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">have</span></span> disj2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>UNIV <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">(</span>UNIV <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="skolem">Xin'</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">Xin'</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> disj1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> disj2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> disj3<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Xout'_def Xin'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">have</span></span> disj3'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>UNIV <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">(</span>UNIV <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> canceling <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="skolem">Xin'</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">Xout'</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> disj1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> disj2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> disj3<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def Xout'_def Xin'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

         <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We need to pick a suitable element of the set to play ping pong
         with. In particular, it needs to be outside of the Xout-set of the last
         generator in the list, and outside the in-set of the first element. This
         part of the proof is surprisingly tedious, because there are several
         cases, some similar but not the same.
›</span></span>

         <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
         <span class="keyword3"><span class="command">assume</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span>"</span></span>

         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="main">(</span>last <span class="skolem">w</span><span class="main">)</span>"</span></span> 
           <span class="keyword2"><span class="keyword">and</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Xin'</span> <span class="main">(</span>hd <span class="skolem">w</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
           <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">∈</span><span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">moreover</span></span>
           <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span><span class="main">=</span><span class="main">{</span><span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> card_eq_SucD<span class="main">)</span>
             <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">≠</span><span class="main">[]</span>"</span></span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>hd <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> w <span class="quoted"><span class="quoted">‹<span class="free">I</span><span class="main">=</span><span class="main">{</span><span class="skolem">i</span><span class="main">}</span>›</span></span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_exhaust<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gencount<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span><span class="main">=</span><span class="main">{</span><span class="skolem">i</span><span class="main">}</span>›</span></span><span class="main">]</span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">∈</span><span class="free">X</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span><span class="main">≠</span><span class="main">[]</span>›</span></span>
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"last <span class="skolem">w</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">w</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Xout'_def Xin'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>
           <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">moreover</span></span>
           <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>

             <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> w
             <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> hd<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="free">I</span>"</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
             <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> w
             <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> last<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span><span class="main">∈</span><span class="free">I</span>"</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_exhaust<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>

             <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹What follows are two very similar cases, but the correct
             choice of variables depends on where we find x.›</span></span>
             <span class="keyword1"><span class="command">{</span></span>
             <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b''</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">¬</span> canceling <span class="main">(</span><span class="skolem">b''</span><span class="main">,</span> <span class="skolem">i''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
               <span class="quoted"><span class="quoted">"<span class="skolem">i''</span><span class="main">∈</span><span class="free">I</span>"</span></span>
             <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">i'</span>"</span></span><span class="main">)</span>
               <span class="keyword3"><span class="command">case</span></span> True
               <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">∈</span><span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≠</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹card <span class="free">I</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="free">I</span>›</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> other_member<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
               <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def<span class="main">)</span>
             <span class="keyword1"><span class="command">next</span></span>
               <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="free">I</span>›</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
             <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span>"</span></span>

             <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">Xout'</span> <span class="main">(</span>last <span class="skolem">w</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="var">?g</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> disj1'<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="var">?g</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>›</span></span><span class="main">]</span>
                   <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span><span class="main">∈</span><span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span><span class="main">∈</span><span class="free">I</span>›</span></span> hd last
               <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift_gi <span class="free">g</span> <span class="var">?g</span><span class="main">)</span> <span class="free">x</span> <span class="main">∈</span> <span class="skolem">Xin'</span> <span class="var">?g</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span>
               ping<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">∈</span> <span class="free">I</span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>
               pong<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">∈</span> <span class="free">I</span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>G.lift_def G.lift_gi_def Xout'_def Xin'_def<span class="main">)</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="main">(</span>last <span class="skolem">w</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?x</span> <span class="main">∉</span> <span class="skolem">Xin'</span> <span class="main">(</span>hd <span class="skolem">w</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> 
                 disj3'<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="main">¬</span> canceling <span class="main">(</span><span class="skolem">b''</span><span class="main">,</span> <span class="skolem">i''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>›</span></span><span class="main">]</span>
                 disj2'<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ _  <span class="quoted"><span class="quoted">‹<span class="var">?g</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span>
                 <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span><span class="main">∈</span><span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span><span class="main">∈</span><span class="free">I</span>›</span></span> hd last
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceling_def<span class="main">)</span> 
             <span class="keyword1"><span class="command">moreover</span></span>
             <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">∈</span> <span class="free">I</span>›</span></span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">i''</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="main">∈</span> <span class="main">(</span><span class="free">I</span> <span class="main">→</span> carrier <span class="free">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"G.lift_gi <span class="free">g</span> <span class="var">?g</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>G.lift_gi_def inv1_def<span class="main">)</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift_gi <span class="free">g</span> <span class="var">?g</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">act</span> <span class="main">∈</span> hom <span class="free">G</span> <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">∈</span><span class="free">X</span>›</span></span> 
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def Bij_def bij_betw_def<span class="main">)</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">moreover</span></span>
             <span class="keyword1"><span class="command">{</span></span>
             <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b''</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">¬</span> canceling <span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">¬</span> canceling <span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
               <span class="quoted"><span class="quoted">"<span class="skolem">i''</span><span class="main">∈</span><span class="free">I</span>"</span></span>
             <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">i'</span>"</span></span><span class="main">)</span>
               <span class="keyword3"><span class="command">case</span></span> True
               <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">∈</span><span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≠</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹card <span class="free">I</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="free">I</span>›</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> other_member<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
               <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def<span class="main">)</span>
             <span class="keyword1"><span class="command">next</span></span>
               <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="free">I</span>›</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>canceling_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
             <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span>"</span></span> 
             <span class="keyword1"><span class="command">note</span></span> cancel_sym_neg<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> canceling <span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span>
             <span class="keyword1"><span class="command">note</span></span> cancel_sym_neg<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> canceling <span class="main">(</span><span class="skolem">b''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>›</span></span><span class="main">]</span>

             <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">Xin'</span> <span class="main">(</span>hd <span class="skolem">w</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="var">?g</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> disj3'<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="main">¬</span> canceling <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="var">?g</span>›</span></span><span class="main">]</span>
                   <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span><span class="main">∈</span><span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span><span class="main">∈</span><span class="free">I</span>›</span></span> hd last
               <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift_gi <span class="free">g</span> <span class="var">?g</span><span class="main">)</span> <span class="free">x</span> <span class="main">∈</span> <span class="skolem">Xin'</span> <span class="var">?g</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span>
               ping<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">∈</span> <span class="free">I</span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>
               pong<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">∈</span> <span class="free">I</span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>G.lift_def G.lift_gi_def Xout'_def Xin'_def<span class="main">)</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="main">(</span>last <span class="skolem">w</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?x</span> <span class="main">∉</span> <span class="skolem">Xin'</span> <span class="main">(</span>hd <span class="skolem">w</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> 
                 disj3'<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="main">¬</span> canceling <span class="var">?g</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>›</span></span><span class="main">]</span>
                 disj2'<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ _  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?g</span>›</span></span><span class="main">]</span>
                 <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span><span class="main">∈</span><span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span><span class="main">∈</span><span class="free">I</span>›</span></span> hd last
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canceling_def<span class="main">)</span> 
             <span class="keyword1"><span class="command">moreover</span></span>
             <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">∈</span> <span class="free">I</span>›</span></span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">i''</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="main">∈</span> <span class="main">(</span><span class="free">I</span> <span class="main">→</span> carrier <span class="free">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"G.lift_gi <span class="free">g</span> <span class="var">?g</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>G.lift_gi_def<span class="main">)</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift_gi <span class="free">g</span> <span class="var">?g</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">act</span> <span class="main">∈</span> hom <span class="free">G</span> <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">∈</span><span class="free">X</span>›</span></span> 
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def Bij_def bij_betw_def<span class="main">)</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
           <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">∈</span> <span class="free">X</span>›</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">qed</span></span>
    
         <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The proof works by induction over the length of the word. Each
         inductive step is one ping as in ping pong. At the end, we land in one
         of the subsets of X, so the word cannot be the identity.›</span></span>
         <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword2"><span class="keyword">and</span></span> w
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Xin'</span> <span class="main">(</span>hd <span class="skolem">w</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span>
           <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">w</span> <span class="skolem">ws</span><span class="main">)</span>
           <span class="keyword1"><span class="command">note</span></span> C <span class="main">=</span> Cons

           <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas establish all ``obvious'' element relations that will be required during the proof.›</span></span>
           <span class="keyword1"><span class="command">note</span></span> calculation <span class="main">=</span> Cons<span class="main">(</span>3<span class="main">)</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">w</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span> 
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="main">(</span><span class="free">I</span> <span class="main">→</span> carrier <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span>snd <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cons_canceled <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.lift <span class="free">g</span> <span class="skolem">ws</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_group_def<span class="main">)</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>"</span></span>
                     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>"</span></span>
                     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>"</span></span>
                     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span>snd <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span>snd <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Bij <span class="free">X</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def<span class="main">)</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x2</span> <span class="main">∈</span> <span class="free">X</span>"</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def Bij_def bij_betw_def<span class="main">)</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="var">?x2</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def Bij_def bij_betw_def<span class="main">)</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def Bij_def bij_betw_def<span class="main">)</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> mems <span class="main">=</span> calculation
          
           <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="skolem">w</span>"</span></span>
           <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">)</span>
             <span class="keyword3"><span class="command">case</span></span> Nil             
               <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> Nil
                 <span class="keyword1"><span class="command">unfolding</span></span> Xout'_def <span class="keyword1"><span class="command">using</span></span> mems
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>
               <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="skolem">w</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> mems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ww</span> <span class="skolem">wws</span><span class="main">)</span>
             <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Xin'</span> <span class="main">(</span>hd <span class="skolem">ws</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> C mems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Xin'</span> <span class="main">(</span>hd <span class="skolem">ws</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">Xout'</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
             <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> canceling <span class="main">(</span>hd <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"canceling <span class="main">(</span>hd <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>
                 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cancels_to_1 <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span> <span class="skolem">wws</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons
                    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cancel_sym cancels_to_1_def cancels_to_1_at_def cancel_at_def<span class="main">)</span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span>›</span></span>
                    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def canceled_def<span class="main">)</span>
               <span class="keyword1"><span class="command">qed</span></span>  

               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> UNIV <span class="main">×</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">ws</span> <span class="main">∈</span> UNIV <span class="main">×</span> <span class="free">I</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">w</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> mems Cons
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">ws</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
               <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                 <span class="keyword1"><span class="command">by</span></span><span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> disj3'<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="main">¬</span> canceling <span class="main">(</span>hd <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">w</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
             <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">qed</span></span>
           <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
           <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">(</span><span class="main">[</span><span class="skolem">w</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> 
               <span class="keyword1"><span class="command">using</span></span> mems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> G.lift_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def<span class="main">)</span>
             <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub>BijGroup <span class="free">X</span></sub><span class="hidden">⇙</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> mems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>act.hom_mult free_group_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>G.lift_closed<span class="main">)</span>
             <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> mems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def compose_def<span class="main">)</span>
             <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∉</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Xout'</span> <span class="skolem">w</span>"</span></span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> inj_on_eq_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">act</span></span> <span class="main"><span class="main">(</span></span>G.lift <span class="free"><span class="free">g</span></span> <span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">w</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command">using</span></span> mems <span class="quoted"><span class="quoted">‹<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Xout'</span> <span class="skolem">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">Xout</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">Xin</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> 
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def Bij_def bij_betw_def free_group_def Xout'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
             <span class="keyword1"><span class="command">finally</span></span>            
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Xin'</span> <span class="skolem">w</span>"</span></span>
             <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
               <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Xout'</span> <span class="skolem">w</span>"</span></span>
               <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Xout'</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> mems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span> <span class="main">-</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Xout'</span> <span class="skolem">w</span>"</span></span>
                     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="main">(</span>BijGroup <span class="free">X</span><span class="main">)</span>›</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>BijGroup_def Bij_def bij_betw_def<span class="main">)</span>
               <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">act</span> <span class="main">(</span>G.lift <span class="free">g</span> <span class="main">[</span><span class="skolem">w</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="skolem">Xout'</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_diff_subset<span class="main">)</span>
               <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="skolem">Xin'</span> <span class="skolem">w</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">w</span>"</span></span><span class="main">)</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fst <span class="skolem">w</span>"</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                   <span class="keyword1"><span class="command">using</span></span> mems
                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ping<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Xout'_def Xin'_def G.lift_def G.lift_gi_def free_group_def<span class="main">)</span> 
               <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">w</span>"</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                   <span class="keyword1"><span class="command">using</span></span> mems
                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pong<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_def inv_BijGroup Xout'_def Xin'_def G.lift_def G.lift_gi_def free_group_def<span class="main">)</span> 
               <span class="keyword1"><span class="command">qed</span></span>
               <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
             <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command">qed</span></span>
         <span class="keyword1"><span class="command">qed</span></span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"G.lift <span class="free">g</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span><span class="free">X</span>›</span></span> Cons<span class="main">(</span>1<span class="main">)</span> x2 <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">∈</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span>›</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>free_group_def Xin'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>       
       <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Surjectivity is relatively simple, and often not even mentioned in
    human proofs.›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.lift <span class="free">g</span> <span class="main">`</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span> <span class="main">=</span>
          G.lift <span class="free">g</span> <span class="main">`</span> <span class="main">⟨</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">I</span><span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gens_span_free_group<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⟨</span>G.lift <span class="free">g</span> <span class="main">`</span> <span class="main">(</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>h.hom_span <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">g</span> <span class="main">`</span> <span class="free">I</span> <span class="main">⟩</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
       <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> G.lift <span class="free">g</span> <span class="main">(</span><span class="keyword1">ι</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">i</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="main">∈</span> <span class="main">(</span><span class="free">I</span> <span class="main">→</span> carrier <span class="free">G</span><span class="main">)</span>›</span></span>         
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_def G.lift_def G.lift_gi_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>G.r_one<span class="main">)</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G.lift <span class="free">g</span> <span class="main">`</span> <span class="main">(</span><span class="keyword1">ι</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">I</span> "</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"G.lift <span class="free">g</span> <span class="main">`</span> carrier <span class="keyword1">ℱ</span><span class="hidden">⇘</span><sub><span class="free">I</span></sub><span class="hidden">⇙</span> <span class="main">=</span> carrier <span class="free">G</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>