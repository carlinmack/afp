<div id="FOL_Harrison">
<div class="head">
<h1>Theory FOL_Harrison</h1>
</div>
<pre class="source"><span class="comment1">(*
  FOL-Harrison - First-Order Logic According to Harrison

  Authors: Alexander Birch Jensen, Anders Schlichtkrull, Jørgen Villadsen

  Acknowledgement: The SML code is based on the OCaml code accompanying John Harrison's
  Handbook of Practical Logic and Automated Reasoning, Cambridge University Press, 2009
*)</span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹FOL-Harrison›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FOL_Harrison
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Module Proven›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax of first-order logic›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> id <span class="main">=</span> <span class="quoted">String.literal</span>

<span class="keyword1"><span class="command">datatype</span></span> tm <span class="main">=</span> Var <span class="quoted">id</span> <span class="main">|</span> Fn <span class="quoted">id</span> <span class="quoted"><span class="quoted">"tm list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> fm <span class="main">=</span> Truth <span class="main">|</span> Falsity <span class="main">|</span> Atom <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Imp <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="main">|</span> Iff <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="main">|</span>
    And <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="main">|</span> Or <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="main">|</span> Not <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="main">|</span> Exists <span class="quoted">id</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span> <span class="main">|</span> Forall <span class="quoted">id</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fm"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> fol <span class="main">=</span> Rl <span class="quoted">id</span> <span class="quoted"><span class="quoted">"tm list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"thm"</span> <span class="main">=</span> Thm <span class="main">(</span><span class="free"><span class="entity">concl</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"fol fm"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of rules and axioms›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">fail_thm</span> <span class="main">≡</span> Thm Truth"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fol_equal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fol_equal</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">zip_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tm list <span class="main">⇒</span> tm list <span class="main">⇒</span> fol fm list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zip_eq</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">.</span> Atom <span class="main">(</span>Rl <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''=''</span><span class="main">)</span> <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="bound">t'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">occurs_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">occurs_in_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> tm list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">occurs_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">occurs_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Fn <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">occurs_in_list</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">occurs_in_list</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">occurs_in_list</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">occurs_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∨</span> <span class="free">occurs_in_list</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">free_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> fol fm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Truth <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Falsity <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> Rl <span class="main"><span class="bound">_</span></span> <span class="bound">l</span> <span class="main">⇒</span> occurs_in_list <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> <span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Iff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> <span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> <span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> <span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free">free_in</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">equal_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tm list <span class="main">⇒</span> tm list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">equal_length</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">equal_length</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> False <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="bound">l'</span> <span class="main">⇒</span> <span class="free">equal_length</span> <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">modusponens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thm <span class="main">⇒</span> thm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">modusponens</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> concl <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Imp <span class="bound">p</span> <span class="bound">q</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="bound">p'</span> <span class="main">=</span> concl <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> fol_equal <span class="bound">p</span> <span class="bound">p'</span> <span class="keyword1">then</span> Thm <span class="bound">q</span> <span class="keyword1">else</span> fail_thm <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> fail_thm"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> thm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>concl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_addimp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_addimp</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_distribimp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_distribimp</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_doubleneg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_doubleneg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> Falsity<span class="main">)</span> Falsity<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_allimp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_allimp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Imp <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_impall</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_impall</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="main">¬</span> free_in <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Thm <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> fail_thm"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_existseq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> tm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_existseq</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="main">¬</span> occurs_in <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
      <span class="keyword1">then</span> Thm <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''=''</span><span class="main">)</span> <span class="main">[</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> fail_thm"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_eqrefl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_eqrefl</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''=''</span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_funcong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> tm list <span class="main">⇒</span> tm list <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_funcong</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> equal_length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span>
      <span class="keyword1">then</span> Thm <span class="main">(</span>foldr Imp <span class="main">(</span>zip_eq <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''=''</span><span class="main">)</span> <span class="main">[</span>Fn <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> Fn <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> fail_thm"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_predcong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> tm list <span class="main">⇒</span> tm list <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_predcong</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> equal_length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span>
      <span class="keyword1">then</span> Thm <span class="main">(</span>foldr Imp <span class="main">(</span>zip_eq <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> fail_thm"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_iffimp1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_iffimp1</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Imp <span class="main">(</span>Iff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_iffimp2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_iffimp2</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Imp <span class="main">(</span>Iff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_impiff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_impiff</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Iff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_true</span> <span class="main">≡</span> Thm <span class="main">(</span>Iff Truth <span class="main">(</span>Imp Falsity Falsity<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_not</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_not</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Iff <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> Falsity<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_and</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_and</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Iff <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">q</span></span></span> Falsity<span class="main">)</span><span class="main">)</span> Falsity<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_or</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_or</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Iff <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>Not <span class="main">(</span>And <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axiom_exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id <span class="main">⇒</span> fol fm <span class="main">⇒</span> thm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axiom_exists</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> Thm <span class="main">(</span>Iff <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Not <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code generation for rules and axioms›</span></span>

<span class="comment1">(* The following export_code's are only for inspection purposes *)</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">modusponens</span></span> <span class="quoted"><span class="quoted">gen</span></span> <span class="quoted"><span class="quoted">axiom_addimp</span></span> <span class="quoted"><span class="quoted">axiom_distribimp</span></span> <span class="quoted"><span class="quoted">axiom_doubleneg</span></span> <span class="quoted"><span class="quoted">axiom_allimp</span></span> <span class="quoted"><span class="quoted">axiom_impall</span></span>
  <span class="quoted"><span class="quoted">axiom_existseq</span></span> <span class="quoted"><span class="quoted">axiom_eqrefl</span></span> <span class="quoted"><span class="quoted">axiom_funcong</span></span> <span class="quoted"><span class="quoted">axiom_predcong</span></span> <span class="quoted"><span class="quoted">axiom_iffimp1</span></span> <span class="quoted"><span class="quoted">axiom_iffimp2</span></span>
  <span class="quoted"><span class="quoted">axiom_impiff</span></span> <span class="quoted"><span class="quoted">axiom_true</span></span> <span class="quoted"><span class="quoted">axiom_not</span></span> <span class="quoted"><span class="quoted">axiom_and</span></span> <span class="quoted"><span class="quoted">axiom_or</span></span> <span class="quoted"><span class="quoted">axiom_exists</span></span> <span class="quoted"><span class="quoted">concl</span></span>
<span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> Proven

<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">fol_equal</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"_ = _"</span> <span class="comment1">― ‹More efficient›</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">modusponens</span></span> <span class="quoted"><span class="quoted">gen</span></span> <span class="quoted"><span class="quoted">axiom_addimp</span></span> <span class="quoted"><span class="quoted">axiom_distribimp</span></span> <span class="quoted"><span class="quoted">axiom_doubleneg</span></span> <span class="quoted"><span class="quoted">axiom_allimp</span></span> <span class="quoted"><span class="quoted">axiom_impall</span></span>
  <span class="quoted"><span class="quoted">axiom_existseq</span></span> <span class="quoted"><span class="quoted">axiom_eqrefl</span></span> <span class="quoted"><span class="quoted">axiom_funcong</span></span> <span class="quoted"><span class="quoted">axiom_predcong</span></span> <span class="quoted"><span class="quoted">axiom_iffimp1</span></span> <span class="quoted"><span class="quoted">axiom_iffimp2</span></span>
  <span class="quoted"><span class="quoted">axiom_impiff</span></span> <span class="quoted"><span class="quoted">axiom_true</span></span> <span class="quoted"><span class="quoted">axiom_not</span></span> <span class="quoted"><span class="quoted">axiom_and</span></span> <span class="quoted"><span class="quoted">axiom_or</span></span> <span class="quoted"><span class="quoted">axiom_exists</span></span> <span class="quoted"><span class="quoted">concl</span></span>
<span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> Proven

<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">fol_equal</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="comment1">― ‹Delete›</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">modusponens</span></span> <span class="quoted"><span class="quoted">gen</span></span> <span class="quoted"><span class="quoted">axiom_addimp</span></span> <span class="quoted"><span class="quoted">axiom_distribimp</span></span> <span class="quoted"><span class="quoted">axiom_doubleneg</span></span> <span class="quoted"><span class="quoted">axiom_allimp</span></span> <span class="quoted"><span class="quoted">axiom_impall</span></span>
  <span class="quoted"><span class="quoted">axiom_existseq</span></span> <span class="quoted"><span class="quoted">axiom_eqrefl</span></span> <span class="quoted"><span class="quoted">axiom_funcong</span></span> <span class="quoted"><span class="quoted">axiom_predcong</span></span> <span class="quoted"><span class="quoted">axiom_iffimp1</span></span> <span class="quoted"><span class="quoted">axiom_iffimp2</span></span>
  <span class="quoted"><span class="quoted">axiom_impiff</span></span> <span class="quoted"><span class="quoted">axiom_true</span></span> <span class="quoted"><span class="quoted">axiom_not</span></span> <span class="quoted"><span class="quoted">axiom_and</span></span> <span class="quoted"><span class="quoted">axiom_or</span></span> <span class="quoted"><span class="quoted">axiom_exists</span></span> <span class="quoted"><span class="quoted">concl</span></span>
<span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> Proven

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics of first-order logic›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">length2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tm list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">length2</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="comment1">― ‹Semantics of terms›</span>
  <span class="entity">semantics_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>id <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> tm <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">semantics_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>id <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> tm list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics_term</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics_term</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free">semantics_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics_list</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">semantics_term</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free">semantics_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="comment1">― ‹Semantics of formulas›</span>
  <span class="entity">semantics</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>id <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>id <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> fol fm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Truth <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Falsity <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> Rl <span class="bound">i</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''=''</span> <span class="main">∧</span> length2 <span class="bound">l</span>
      <span class="keyword1">then</span> <span class="main">(</span>semantics_term <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>hd <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> semantics_term <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>hd <span class="main">(</span>tl <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">i</span> <span class="main">(</span>semantics_list <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟶</span> <span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Iff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> <span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">semantics</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="free">semantics</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of proof system›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">OK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fol fm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _"</span> 0<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  modusponens<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> concl <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>modusponens <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  gen<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>gen <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_addimp<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_addimp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_distribimp<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_distribimp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_doubleneg<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_doubleneg <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_allimp<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_allimp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_impall<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_impall <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_existseq<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_existseq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_eqrefl<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_eqrefl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_funcong<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_funcong <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_predcong<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_predcong <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_iffimp1<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_iffimp1 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_iffimp2<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_iffimp2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_impiff<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_impiff <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_true<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl axiom_true"</span></span> <span class="main">|</span>
  axiom_not<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_not <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_and<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_and <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_or<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_or <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  axiom_exists<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> concl <span class="main">(</span>axiom_exists <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Example *)</span>

<span class="keyword1"><span class="command">proposition</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> Imp <span class="free">p</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> concl <span class="main">(</span>Thm <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free">p</span> <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free">p</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free">p</span> <span class="main">(</span>Imp <span class="free">p</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp <span class="free">p</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> axiom_distribimp
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_distribimp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> concl <span class="main">(</span>Thm <span class="main">(</span>Imp <span class="free">p</span> <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free">p</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> axiom_addimp
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_addimp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> concl <span class="main">(</span>Thm <span class="main">(</span>Imp <span class="main">(</span>Imp <span class="free">p</span> <span class="main">(</span>Imp <span class="free">p</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp <span class="free">p</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 1 2 modusponens
  <span class="keyword1"><span class="command">unfolding</span></span> modusponens_def fol_equal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> concl <span class="main">(</span>Thm <span class="main">(</span>Imp <span class="free">p</span> <span class="main">(</span>Imp <span class="free">p</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> axiom_addimp
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_addimp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> concl <span class="main">(</span>Thm <span class="main">(</span>Imp <span class="free">p</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 3 4 modusponens
  <span class="keyword1"><span class="command">unfolding</span></span> modusponens_def fol_equal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> 5
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of proof system›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> occurs_in <span class="free">x</span> <span class="free">t</span> <span class="main">⟹</span> semantics_term <span class="free">e</span> <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> semantics_term <span class="main">(</span><span class="free">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> occurs_in_list <span class="free">x</span> <span class="free">l</span> <span class="main">⟹</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> semantics_list <span class="main">(</span><span class="free">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> semantics_term.induct semantics_list.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="free">p</span> <span class="main">⟹</span> semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="free">p</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="free">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> Truth <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> Truth <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> Truth"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> Falsity <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> Falsity <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> Falsity"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="main">=</span> Rl <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">⟹</span>
        semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Rl <span class="skolem">i</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> occurs_in_list <span class="free">x</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''=''</span> <span class="main">∧</span> length2 <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="skolem">i</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
            semantics_term <span class="skolem">e</span> <span class="free">f</span> <span class="main">(</span>hd <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> semantics_term <span class="skolem">e</span> <span class="free">f</span> <span class="main">(</span>hd <span class="main">(</span>tl <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span>
            semantics_term <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span>hd <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> semantics_term <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span>hd <span class="main">(</span>tl <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> map'<span class="main">(</span>1<span class="main">)</span> fresh occurs_in_list.simps<span class="main">(</span>2<span class="main">)</span> eq list.case_eq_if list.collapse
        <span class="keyword1"><span class="command">unfolding</span></span> length2_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> eq assm<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''=''</span> <span class="main">∧</span> length2 <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="skolem">i</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">g</span> <span class="skolem">i</span> <span class="main">(</span>semantics_list <span class="skolem">e</span> <span class="free">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">iprover</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="free">g</span> <span class="skolem">i</span> <span class="main">(</span>semantics_list <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> map'<span class="main">(</span>2<span class="main">)</span> fresh
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> not_eq assm<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">iprover</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p1</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p1</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p2</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p2</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Imp <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">⟹</span>
      semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Imp <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Imp <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assm1 assm2
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p1</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p1</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p2</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p2</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Iff <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">⟹</span>
      semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Iff <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Iff <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assm1 assm2
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p1</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p1</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p2</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p2</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>And <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">⟹</span>
      semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>And <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>And <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assm1 assm2
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p1</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p1</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p2</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p2</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Or <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">⟹</span>
      semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Or <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Or <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assm1 assm2
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Not <span class="skolem">p</span><span class="main">)</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Not <span class="skolem">p</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Not <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span> <span class="skolem">p</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Exists <span class="skolem">x1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⟹</span>
      semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Exists <span class="skolem">x1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Exists <span class="skolem">x1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> fun_upd_twist fun_upd_upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span> <span class="skolem">p</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="skolem">p</span> <span class="main">⟹</span> semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> free_in <span class="free">x</span> <span class="main">(</span>Forall <span class="skolem">x1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⟹</span>
      semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Forall <span class="skolem">x1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⟷</span> semantics <span class="main">(</span><span class="skolem">e</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Forall <span class="skolem">x1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> fun_upd_twist fun_upd_upd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length2_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length2 <span class="free">l</span> <span class="main">⟷</span> <span class="main">[</span>hd <span class="free">l</span><span class="main">,</span> hd <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length2 <span class="free">l</span> <span class="main">⟹</span> <span class="main">[</span>hd <span class="free">l</span><span class="main">,</span> hd <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> length2_def
  <span class="keyword1"><span class="command">using</span></span> list.case_eq_if list.exhaust_sel
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> length2_def
  <span class="keyword1"><span class="command">using</span></span> list.case list.case_eq_if
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> equal_length_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span> <span class="main">⟹</span> equal_length <span class="free">l'</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"equal_length <span class="skolem">l</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"equal_length <span class="main">[]</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> equal_length.simps list.case_eq_if
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">l'</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> sym<span class="main">:</span> <span class="quoted"><span class="quoted">"equal_length <span class="skolem">l</span> <span class="skolem">l'</span> <span class="main">⟹</span> equal_length <span class="skolem">l'</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"equal_length <span class="skolem">l</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"equal_length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l'</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> equal_length.simps list.case_eq_if list.collapse list.inject sym
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> equal_length2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span> <span class="main">⟹</span> length2 <span class="free">l</span> <span class="main">⟷</span> length2 <span class="free">l'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">]</span> <span class="main">⟹</span> length2 <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">t'</span>
  <span class="keyword1"><span class="command">unfolding</span></span> length2_def
  <span class="keyword1"><span class="command">using</span></span> equal_length.simps list.case_eq_if
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equal_length <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">]</span> <span class="free">l'</span> <span class="main">⟹</span> length2 <span class="free">l'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">t'</span>
  <span class="keyword1"><span class="command">unfolding</span></span> length2_def
  <span class="keyword1"><span class="command">using</span></span> equal_length.simps list.case_eq_if equal_length_sym
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assm length2_equiv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> imp_chain_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>foldr Imp <span class="free">l</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> imp_conjL
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> imp_chain_zip_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span> <span class="main">⟹</span>
      semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>foldr Imp <span class="main">(</span>zip_eq <span class="free">l</span> <span class="free">l'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span>
      semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l'</span> <span class="main">⟶</span> semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span>zip_eq <span class="free">l</span> <span class="free">l'</span><span class="main">)</span><span class="main">.</span> semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟷</span>
      semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> zip_eq_def
  <span class="keyword1"><span class="command">using</span></span> length2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> imp_chain_equiv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> funcong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span> <span class="main">⟹</span>
      semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>foldr Imp <span class="main">(</span>zip_eq <span class="free">l</span> <span class="free">l'</span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''=''</span><span class="main">)</span> <span class="main">[</span>Fn <span class="free">i</span> <span class="free">l</span><span class="main">,</span> Fn <span class="free">i</span> <span class="free">l'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''=''</span><span class="main">)</span> <span class="main">[</span>Fn <span class="free">i</span> <span class="free">l</span><span class="main">,</span> Fn <span class="free">i</span> <span class="free">l'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> imp_chain_equiv
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">≠</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assm imp_chain_zip_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> predcong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span> <span class="main">⟹</span>
      semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>foldr Imp <span class="main">(</span>zip_eq <span class="free">l</span> <span class="free">l'</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="free">i</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="free">i</span> <span class="free">l'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"equal_length <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''=''</span> <span class="main">∧</span> length2 <span class="free">l</span> <span class="main">∧</span> length2 <span class="free">l'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"semantics_list <span class="free">e</span> <span class="free">f</span> <span class="main">[</span>hd <span class="free">l</span><span class="main">,</span> hd <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="main">[</span>hd <span class="free">l'</span><span class="main">,</span> hd <span class="main">(</span>tl <span class="free">l'</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq length2_equiv
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Imp <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''=''</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''=''</span><span class="main">)</span> <span class="free">l'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eq imp_chain_equiv
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">≠</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assm imp_chain_zip_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''=''</span> <span class="main">∧</span> length2 <span class="free">l</span> <span class="main">∧</span> length2 <span class="free">l'</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Imp <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="free">i</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">(</span>Rl <span class="free">i</span> <span class="free">l'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm not_eq equal_length2
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">iprover</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> imp_chain_equiv
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l</span> <span class="main">≠</span> semantics_list <span class="free">e</span> <span class="free">f</span> <span class="free">l'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assm imp_chain_zip_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> soundness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">p</span> <span class="main">⟹</span> semantics <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> OK.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>modusponens <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> modusponens_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Thm <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>concl <span class="skolem">s</span><span class="main">)</span> <span class="keyword1">of</span> Imp <span class="bound">p</span> <span class="bound">q</span> <span class="main">⇒</span>
        <span class="keyword1">let</span> <span class="bound">p'</span> <span class="main">=</span> concl <span class="skolem">s'</span> <span class="keyword1">in</span> <span class="keyword1">if</span> fol_equal <span class="bound">p</span> <span class="bound">p'</span> <span class="keyword1">then</span> Thm <span class="bound">q</span> <span class="keyword1">else</span> fail_thm <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> fail_thm<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fol_equal_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>gen <span class="skolem">x</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_addimp <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_addimp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_distribimp <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_distribimp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">g</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="skolem">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_doubleneg <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_doubleneg_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_allimp <span class="skolem">x</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_allimp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_impall <span class="skolem">x</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_impall_def
  <span class="keyword1"><span class="command">using</span></span> map
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">iprover</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_existseq <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_existseq_def
  <span class="keyword1"><span class="command">using</span></span> map'<span class="main">(</span>1<span class="main">)</span> length2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">iprover</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_eqrefl <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_eqrefl_def
  <span class="keyword1"><span class="command">using</span></span> length2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">i</span> <span class="skolem">l</span> <span class="skolem">l'</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_funcong <span class="skolem">i</span> <span class="skolem">l</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_funcong_def
  <span class="keyword1"><span class="command">using</span></span> funcong
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">standard</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">i</span> <span class="skolem">l</span> <span class="skolem">l'</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_predcong <span class="skolem">i</span> <span class="skolem">l</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_predcong_def
  <span class="keyword1"><span class="command">using</span></span> predcong
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">standard</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_iffimp1 <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_iffimp1_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_iffimp2 <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_iffimp2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_impiff <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_impiff_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_true<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_true_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_not <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_not_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_and <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_and_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_or <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_or_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="skolem">e</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>concl <span class="main">(</span>axiom_exists <span class="skolem">x</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> axiom_exists_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">⊢</span> Falsity<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> soundness
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ML Code Reflection›</span></span>

<span class="keyword1"><span class="command">code_reflect</span></span>
  Proven
<span class="keyword2"><span class="keyword">datatypes</span></span>
  fm <span class="main">=</span> <span class="quoted">Falsity</span> <span class="main">|</span> <span class="quoted">Truth</span> <span class="main">|</span> <span class="quoted">Atom</span> <span class="main">|</span> <span class="quoted">Imp</span> <span class="main">|</span> <span class="quoted">Iff</span> <span class="main">|</span> <span class="quoted">And</span> <span class="main">|</span> <span class="quoted">Or</span> <span class="main">|</span> <span class="quoted">Not</span> <span class="main">|</span> <span class="quoted">Exists</span> <span class="main">|</span> <span class="quoted">Forall</span>
<span class="keyword2"><span class="keyword">and</span></span>
  tm <span class="main">=</span> <span class="quoted">Var</span> <span class="main">|</span> <span class="quoted">Fn</span>
<span class="keyword2"><span class="keyword">and</span></span>
  fol <span class="main">=</span> <span class="quoted">Rl</span>
<span class="keyword2"><span class="keyword">functions</span></span>
  modusponens gen axiom_addimp axiom_distribimp axiom_doubleneg axiom_allimp axiom_impall
  axiom_existseq axiom_eqrefl axiom_funcong axiom_predcong axiom_iffimp1 axiom_iffimp2
  axiom_impiff axiom_true axiom_not axiom_and axiom_or axiom_exists concl

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword3"><span class="keyword">open</span></span> Proven›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print</span> <span class="main">=</span> writeln <span class="comment1">(* Should not add newline but only used for testing (see XXX label) *)</span>›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"format_simple.sml"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_margin</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_string</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">print</span> <span class="entity">x</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">open_box</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">close_box</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_space</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">print</span> <span class="inner_quoted">" "</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_break</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">open_hbox</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_newline</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">print</span> <span class="inner_quoted">"\n"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_int</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">print</span> <span class="main">(</span>Int.toString <span class="entity">n</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">open_hvbox</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"lib.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Misc library functions to set up a nice environment.                      *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">str_ord</span> <span class="entity">s1</span> <span class="entity">s2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> String.compare<span class="main">(</span><span class="entity">s1</span><span class="main">,</span><span class="entity">s2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
      EQUAL <span class="main">=&gt;</span> <span class="inner_numeral">0</span>    <span class="main">|</span> GREATER <span class="main">=&gt;</span> <span class="inner_numeral">1</span>    <span class="main">|</span> LESS  <span class="main">=&gt;</span> <span class="inner_numeral">~1</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sip_ord</span> <span class="main">(</span><span class="entity">f1</span><span class="main">,</span><span class="entity">a1</span><span class="main">)</span> <span class="main">(</span><span class="entity">f2</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">str_ord</span> <span class="entity">f1</span> <span class="entity">f2</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="inner_numeral">0</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">a1</span>&gt;<span class="entity">a2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">~1</span>
    <span class="main">|</span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">n</span>
<span class="main">;</span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> lxor
<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> land

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">to_int_fun</span> <span class="entity">f</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">a</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">b</span> <span class="main">=&gt;</span> Word.toIntX <span class="main">(</span><span class="entity">f</span> <span class="main">(</span><span class="main">(</span>Word.fromInt <span class="entity">a</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Word.fromInt <span class="entity">b</span><span class="main">)</span> <span class="main">)</span> <span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">a</span> <span class="entity">lxor</span> <span class="entity">b</span> <span class="main">=</span> <span class="entity">to_int_fun</span> Word.xorb <span class="entity">a</span> <span class="entity">b</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">a</span> <span class="entity">land</span> <span class="entity">b</span> <span class="main">=</span> <span class="entity">to_int_fun</span> Word.andb <span class="entity">a</span> <span class="entity">b</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list_hash</span> <span class="entity">elem_hash</span> <span class="entity">l</span><span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hash_code</span> <span class="entity">sval</span> <span class="entity">l</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
         <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">sval</span>
        <span class="main">|</span> <span class="entity">e</span>::<span class="entity">l'</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">e_hash</span> <span class="main">=</span> Word.fromInt <span class="main">(</span><span class="entity">elem_hash</span> <span class="entity">e</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">hash_code</span> <span class="main">(</span>Word.+<span class="main">(</span>Word.*<span class="main">(</span><span class="entity">sval</span><span class="main">,</span><span class="inner_numeral">0wx31</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">e_hash</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">l'</span>
          <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
  Word.toIntX<span class="main">(</span><span class="entity">hash_code</span> <span class="inner_numeral">0wx0</span> <span class="entity">l</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">str_hash</span> <span class="entity">str</span> <span class="main">=</span> <span class="entity">list_hash</span> Char.ord <span class="main">(</span>String.explode <span class="entity">str</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fst</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">x</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">snd</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="entity">y</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Misc library functions to set up a nice environment.                      *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">identity</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* A useful idiom for "non contradictory" etc.                               *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">non</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">=</span> not<span class="main">(</span><span class="entity">p</span> <span class="entity">x</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Kind of assertion checking.                                               *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span><span class="main">(</span><span class="entity">x</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"check"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Repetition of a function.                                                 *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">funpow</span> <span class="entity">n</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt; <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">x</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">funpow</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">can</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">;</span> true<span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">repeat</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">repeat</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Handy list operations.                                                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> --
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">m</span> <span class="entity">--</span> <span class="entity">n</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">m</span> &gt; <span class="entity">n</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">m</span>::<span class="main">(</span><span class="main">(</span><span class="entity">m</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">--</span> <span class="entity">n</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map2</span> <span class="entity">f</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="entity">h1</span>::<span class="entity">t1</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">h2</span>::<span class="entity">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">h</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">h1</span> <span class="entity">h2</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">h</span>::<span class="main">(</span><span class="entity">map2</span> <span class="entity">f</span> <span class="entity">t1</span> <span class="entity">t2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"map2: length mismatch"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">itlist</span> <span class="entity">f</span> <span class="entity">l</span> <span class="entity">b</span> <span class="main">=</span> List.foldr <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">b</span> <span class="entity">l</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">end_itlist</span> <span class="entity">f</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">[</span><span class="main">]</span>     <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"end_itlist"</span>
      <span class="main">|</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span>    <span class="main">=&gt;</span> <span class="entity">x</span>
      <span class="main">|</span> <span class="main">(</span><span class="entity">h</span>::<span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">h</span> <span class="main">(</span><span class="entity">end_itlist</span> <span class="entity">f</span> <span class="entity">t</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">itlist2</span> <span class="entity">f</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="entity">b</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">b</span>
  <span class="main">|</span> <span class="main">(</span><span class="entity">h1</span>::<span class="entity">t1</span><span class="main">,</span><span class="entity">h2</span>::<span class="entity">t2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">h1</span> <span class="entity">h2</span> <span class="main">(</span><span class="entity">itlist2</span> <span class="entity">f</span> <span class="entity">t1</span> <span class="entity">t2</span> <span class="entity">b</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"itlist2"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">|</span> <span class="main">(</span><span class="entity">h1</span>::<span class="entity">t1</span><span class="main">,</span><span class="entity">h2</span>::<span class="entity">t2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">h1</span><span class="main">,</span><span class="entity">h2</span><span class="main">)</span>::<span class="main">(</span><span class="entity">zip</span> <span class="entity">t1</span> <span class="entity">t2</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"zip"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">chop_list</span> <span class="entity">n</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">m</span><span class="main">,</span><span class="entity">l'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">chop_list</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="entity">l</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span>hd <span class="entity">l</span><span class="main">)</span>::<span class="entity">m</span><span class="main">,</span><span class="entity">l'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"chop_list"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">index</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ind</span> <span class="entity">n</span> <span class="entity">l</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"index"</span>
    <span class="main">|</span> <span class="main">(</span><span class="entity">h</span>::<span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">h</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">ind</span> <span class="main">(</span><span class="entity">n</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">t</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">ind</span> <span class="inner_numeral">0</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unzip</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span>::<span class="entity">t</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">xs</span><span class="main">,</span><span class="entity">ys</span><span class="main">)</span> <span class="main">=</span> <span class="entity">unzip</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">,</span><span class="entity">y</span>::<span class="entity">ys</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Association lists.                                                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assoc</span> <span class="entity">a</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span>::<span class="entity">t</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">a</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">assoc</span> <span class="entity">a</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"find"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Merging of sorted lists (maintaining repetitions).                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> <span class="entity">ord</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l1</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">l2</span>
  <span class="main">|</span> <span class="entity">h1</span>::<span class="entity">t1</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l2</span> <span class="keyword2"><span class="keyword">of</span></span>
                <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">l1</span>
              <span class="main">|</span> <span class="entity">h2</span>::<span class="entity">t2</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ord</span> <span class="entity">h1</span> <span class="entity">h2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">h1</span>::<span class="main">(</span><span class="entity">merge</span> <span class="entity">ord</span> <span class="entity">t1</span> <span class="entity">l2</span><span class="main">)</span>
                          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">h2</span>::<span class="main">(</span><span class="entity">merge</span> <span class="entity">ord</span> <span class="entity">l1</span> <span class="entity">t2</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Bottom-up mergesort.                                                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sort</span> <span class="entity">ord</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mergepairs</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="main">[</span><span class="entity">s</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">s</span>
      <span class="main">|</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mergepairs</span> <span class="main">[</span><span class="main">]</span> <span class="entity">l</span>
      <span class="main">|</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="main">[</span><span class="entity">s1</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mergepairs</span> <span class="main">(</span><span class="entity">s1</span>::<span class="entity">l</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">|</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="main">(</span><span class="entity">s1</span>::<span class="entity">s2</span>::<span class="entity">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mergepairs</span> <span class="main">(</span><span class="main">(</span><span class="entity">merge</span> <span class="entity">ord</span> <span class="entity">s1</span> <span class="entity">s2</span><span class="main">)</span>::<span class="entity">l</span><span class="main">)</span> <span class="entity">ss</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">mergepairs</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span>List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Common measure predicates to use with "sort".                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">increasing</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">)</span> &lt; <span class="main">(</span><span class="entity">f</span> <span class="entity">y</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decreasing</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">)</span> &gt; <span class="main">(</span><span class="entity">f</span> <span class="entity">y</span><span class="main">)</span> <span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Eliminate repetitions of adjacent elements, with and without counting.    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">uniq</span> <span class="entity">l</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="entity">x</span> :: <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">y</span> :: <span class="entity">ys</span> <span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> <span class="entity">uniq</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">t'</span>
            <span class="keyword2"><span class="keyword">else</span></span>
                <span class="entity">x</span> :: <span class="entity">t'</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">l</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tryfind</span> <span class="entity">f</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"tryfind"</span>
    <span class="main">|</span> <span class="main">(</span><span class="entity">h</span>::<span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="main">(</span><span class="entity">f</span> <span class="entity">h</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">tryfind</span> <span class="entity">f</span> <span class="entity">t</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Set operations on ordered lists.                                          *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">setify</span> <span class="entity">ord</span> <span class="entity">l</span><span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">canonical</span> <span class="entity">lis</span> <span class="main">=</span>
     <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">lis</span> <span class="keyword2"><span class="keyword">of</span></span>
       <span class="entity">x</span>::<span class="main">(</span><span class="entity">rest</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">y</span>::<span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">y</span> &lt; <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">canonical</span> <span class="entity">rest</span>
     <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> true <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">canonical</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">l</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">uniq</span> <span class="main">(</span><span class="entity">sort</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">y</span> &lt;= <span class="inner_numeral">0</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">union</span> <span class="entity">ord</span> <span class="entity">s1</span> <span class="entity">s2</span><span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">union</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">l2</span>
      <span class="main">|</span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">l1</span>
      <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="entity">l1</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">h1</span>::<span class="entity">t1</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">l2</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">h2</span>::<span class="entity">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">h1</span> <span class="main">=</span> <span class="entity">h2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">h1</span>::<span class="main">(</span><span class="entity">union</span> <span class="entity">t1</span> <span class="entity">t2</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ord</span> <span class="entity">h1</span> <span class="entity">h2</span> <span class="main">=</span> <span class="inner_numeral">~1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">h1</span>::<span class="main">(</span><span class="entity">union</span> <span class="entity">t1</span> <span class="entity">l2</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">h2</span>::<span class="main">(</span><span class="entity">union</span> <span class="entity">l1</span> <span class="entity">t2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">union</span> <span class="main">(</span><span class="entity">setify</span> <span class="entity">ord</span> <span class="entity">s1</span><span class="main">)</span> <span class="main">(</span><span class="entity">setify</span> <span class="entity">ord</span> <span class="entity">s2</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">union_str</span> <span class="entity">s1</span> <span class="entity">s2</span> <span class="main">=</span> <span class="entity">union</span> <span class="entity">str_ord</span> <span class="entity">s1</span> <span class="entity">s2</span><span class="main">;</span>
 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">union_sip</span> <span class="entity">p1</span> <span class="entity">p2</span> <span class="main">=</span> <span class="entity">union</span> <span class="entity">sip_ord</span> <span class="entity">p1</span> <span class="entity">p2</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subtract</span> <span class="entity">ord</span> <span class="entity">s1</span> <span class="entity">s2</span><span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subtract</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">|</span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">l1</span>
      <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="entity">l1</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">h1</span>::<span class="entity">t1</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">l2</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">h2</span>::<span class="entity">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">h1</span> <span class="main">=</span> <span class="entity">h2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">subtract</span> <span class="entity">t1</span> <span class="entity">t2</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ord</span> <span class="entity">h1</span> <span class="entity">h2</span> <span class="main">=</span> <span class="inner_numeral">~1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">h1</span>::<span class="main">(</span><span class="entity">subtract</span> <span class="entity">t1</span> <span class="entity">l2</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">subtract</span> <span class="entity">l1</span> <span class="entity">t2</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">subtract</span> <span class="main">(</span><span class="entity">setify</span> <span class="entity">ord</span> <span class="entity">s1</span><span class="main">)</span> <span class="main">(</span><span class="entity">setify</span> <span class="entity">ord</span> <span class="entity">s2</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subtract_str</span> <span class="entity">s1</span> <span class="entity">s2</span> <span class="main">=</span> <span class="entity">subtract</span> <span class="entity">str_ord</span> <span class="entity">s1</span> <span class="entity">s2</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert</span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">union</span> <span class="entity">ord</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="entity">s</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert_str</span> <span class="entity">x</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">insert</span> <span class="entity">str_ord</span> <span class="entity">x</span> <span class="entity">s</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Union of a family of sets.                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unions</span> <span class="entity">ord</span> <span class="entity">s</span> <span class="main">=</span>
   <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">concat</span> <span class="entity">a</span> <span class="entity">b</span> <span class="main">=</span> <span class="entity">a</span> @ <span class="entity">b</span> <span class="keyword2"><span class="keyword">in</span></span>
   <span class="entity">setify</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">itlist</span> <span class="entity">concat</span> <span class="entity">s</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unions_str</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">unions</span> <span class="entity">str_ord</span> <span class="entity">s</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* List membership. This does *not* assume the list is a set.                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mem</span> <span class="entity">x</span> <span class="entity">lis</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">lis</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> false
    <span class="main">|</span> <span class="entity">hd</span> :: <span class="entity">tl</span> <span class="main">=&gt;</span> <span class="entity">hd</span> <span class="main">=</span> <span class="entity">x</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">mem</span> <span class="entity">x</span> <span class="entity">tl</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Timing; useful for documentation but not logically necessary.             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">time</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">timer</span> <span class="main">=</span> Timer.startRealTimer<span class="main">(</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">x</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">time</span> <span class="main">=</span> Timer.checkRealTimer <span class="entity">timer</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>
    <span class="comment1">(* XXX print_string ("CPU time (user): " ^ (Real.toString (Time.toReal time)));
    print_newline(); *)</span>
    <span class="entity">result</span>
    <span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Polymorphic finite partial functions via Patricia trees.                  *)</span>
<span class="comment1">(*                                                                           *)</span>
<span class="comment1">(* The point of this strange representation is that it is canonical (equal   *)</span>
<span class="comment1">(* functions have the same encoding) yet reasonably efficient on average.    *)</span>
<span class="comment1">(*                                                                           *)</span>
<span class="comment1">(* Idea due to Diego Olivier Fernandez Pons (OCaml list, 2003/11/10).        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="main">(</span>'a<span class="main">,</span>'b<span class="main">)</span><span class="entity">func</span> <span class="main">=</span>
   <span class="entity">Empty</span>
 <span class="main">|</span> <span class="entity">Leaf</span> <span class="keyword2"><span class="keyword">of</span></span> int * <span class="main">(</span>'a*'b<span class="main">)</span>list
 <span class="main">|</span> <span class="entity">Branch</span> <span class="keyword2"><span class="keyword">of</span></span> int * int * <span class="main">(</span>'a<span class="main">,</span>'b<span class="main">)</span>func * <span class="main">(</span>'a<span class="main">,</span>'b<span class="main">)</span>func<span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Undefined function.                                                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">undefined</span> <span class="main">=</span> <span class="entity">Empty</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* In case of equality comparison worries, better use this.                  *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_undefined</span> <span class="entity">f</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="entity">Empty</span> <span class="main">=&gt;</span> true
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Operation analogous to "map" for lists.                                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_list</span> <span class="entity">f</span> <span class="entity">l</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
        <span class="main">|</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span>::<span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">f</span><span class="main">(</span><span class="entity">y</span><span class="main">)</span><span class="main">)</span>::<span class="main">(</span><span class="entity">map_list</span> <span class="entity">f</span> <span class="entity">t</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mapf</span> <span class="entity">f</span> <span class="entity">t</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">Empty</span>
        <span class="main">|</span> <span class="entity">Leaf</span><span class="main">(</span><span class="entity">h</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Leaf</span><span class="main">(</span><span class="entity">h</span><span class="main">,</span><span class="entity">map_list</span> <span class="entity">f</span> <span class="entity">l</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">mapf</span> <span class="entity">f</span> <span class="entity">l</span><span class="main">,</span><span class="entity">mapf</span> <span class="entity">f</span> <span class="entity">r</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Application.                                                              *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">applyd</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="entity">d</span> <span class="entity">x</span><span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_listd</span> <span class="entity">l</span> <span class="entity">d</span> <span class="entity">x</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span>::<span class="entity">t</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">a</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">a</span> &gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">apply_listd</span> <span class="entity">t</span> <span class="entity">d</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">d</span> <span class="entity">x</span>
        <span class="main">|</span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">d</span> <span class="entity">x</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> <span class="entity">hash</span> <span class="entity">x</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">look</span> <span class="entity">t</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="entity">Leaf</span><span class="main">(</span><span class="entity">h</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">h</span> <span class="main">=</span> <span class="entity">k</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="entity">apply_listd</span> <span class="entity">l</span> <span class="entity">d</span> <span class="entity">x</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">d</span> <span class="entity">x</span>
        <span class="main">|</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">k</span> <span class="entity">lxor</span> <span class="entity">p</span><span class="main">)</span> <span class="entity">land</span> <span class="main">(</span><span class="entity">b</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="entity">look</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="entity">b</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">r</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">d</span> <span class="entity">x</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">d</span> <span class="entity">x</span>
  <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">look</span> <span class="entity">f</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">applyd</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"apply"</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_str</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">apply</span> <span class="entity">str_ord</span> <span class="entity">str_hash</span> <span class="entity">f</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tryapplyd</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">d</span> <span class="main">=</span> <span class="entity">applyd</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">d</span><span class="main">)</span> <span class="entity">a</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tryapplyd_str</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">d</span> <span class="main">=</span> <span class="entity">tryapplyd</span> <span class="entity">str_ord</span> <span class="entity">str_hash</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">d</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tryapplyl</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">tryapplyd</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">defined</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span><span class="entity">apply</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">f</span> <span class="entity">x</span><span class="main">;</span> true<span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">defined_str</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">defined</span> <span class="entity">str_ord</span> <span class="entity">str_hash</span> <span class="entity">f</span> <span class="entity">x</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Undefinition.                                                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">undefine_list</span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">l</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span><span class="entity">ab</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">)</span>::<span class="entity">t</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">a</span> <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">t</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">l</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> <span class="entity">undefine_list</span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">ab</span>::<span class="entity">t'</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">undefine</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="entity">x</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> <span class="entity">hash</span> <span class="entity">x</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">und</span> <span class="entity">t</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="entity">Leaf</span><span class="main">(</span><span class="entity">h</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">h</span><span class="main">=</span><span class="entity">k</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
                <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l'</span> <span class="main">=</span> <span class="entity">undefine_list</span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">in</span></span>
                <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l'</span> <span class="main">=</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">t</span>
                <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l'</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Empty</span>
                <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">Leaf</span><span class="main">(</span><span class="entity">h</span><span class="main">,</span><span class="entity">l'</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span>
              <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">t</span>
          <span class="main">|</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="main">(</span><span class="entity">b</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
                <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="entity">b</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
                  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l'</span> <span class="main">=</span> <span class="entity">und</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l'</span> <span class="main">=</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">t</span>
                  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l'</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l'</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">end</span></span>
                <span class="keyword2"><span class="keyword">else</span></span>
                  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r'</span> <span class="main">=</span> <span class="entity">und</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">r'</span> <span class="main">=</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">t</span>
                  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">r'</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">l</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r'</span><span class="main">)</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">end</span></span>
              <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">t</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">und</span>
    <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">undefine_str</span> <span class="entity">x</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">undefine</span> <span class="entity">str_ord</span> <span class="entity">str_hash</span> <span class="entity">x</span> <span class="entity">t</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Redefinition and combination.                                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> |-&gt;

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">newbranch</span> <span class="entity">p1</span> <span class="entity">t1</span> <span class="entity">p2</span> <span class="entity">t2</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">zp</span> <span class="main">=</span> <span class="entity">p1</span> <span class="entity">lxor</span> <span class="entity">p2</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">b</span> <span class="main">=</span> <span class="entity">zp</span> <span class="entity">land</span> <span class="main">(</span>~<span class="entity">zp</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">p1</span> <span class="entity">land</span> <span class="main">(</span><span class="entity">b</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p1</span> <span class="entity">land</span> <span class="entity">b</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">t2</span><span class="main">,</span><span class="entity">t1</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">define_list</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">xy</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">(</span><span class="entity">ab</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">)</span>::<span class="entity">t</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">ord</span> <span class="entity">x</span> <span class="entity">a</span> <span class="keyword2"><span class="keyword">in</span></span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">xy</span>::<span class="entity">t</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">xy</span>::<span class="entity">l</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">ab</span>::<span class="main">(</span><span class="entity">define_list</span> <span class="entity">ord</span> <span class="entity">xy</span> <span class="entity">t</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">xy</span><span class="main">]</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">combine_list</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">l2</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">l1</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="entity">xy1</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">y1</span><span class="main">)</span><span class="main">)</span>::<span class="entity">t1</span><span class="main">,</span><span class="main">(</span><span class="entity">xy2</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">y2</span><span class="main">)</span><span class="main">)</span>::<span class="entity">t2</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">ord</span> <span class="entity">x1</span> <span class="entity">x2</span> <span class="keyword2"><span class="keyword">in</span></span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="entity">xy1</span>::<span class="main">(</span><span class="entity">combine_list</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">t1</span> <span class="entity">l2</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c</span> &gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="entity">xy2</span>::<span class="main">(</span><span class="entity">combine_list</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">l1</span> <span class="entity">t2</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span>
                <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">op'</span> <span class="entity">y1</span> <span class="entity">y2</span>
                    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">combine_list</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">t1</span> <span class="entity">t2</span> <span class="keyword2"><span class="keyword">in</span></span>
                <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">z</span><span class="main">(</span><span class="entity">y</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span>::<span class="entity">l</span>
                <span class="keyword2"><span class="keyword">end</span></span>
              <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|-&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">t</span> <span class="entity">ord</span> <span class="entity">hash</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> <span class="entity">hash</span> <span class="entity">x</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">upd</span> <span class="entity">t</span> <span class="main">=</span>
              <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
                <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">Leaf</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
              <span class="main">|</span> <span class="entity">Leaf</span><span class="main">(</span><span class="entity">h</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
                   <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">h</span> <span class="main">=</span> <span class="entity">k</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Leaf</span><span class="main">(</span><span class="entity">h</span><span class="main">,</span><span class="entity">define_list</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
                   <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">newbranch</span> <span class="entity">h</span> <span class="entity">t</span> <span class="entity">k</span> <span class="main">(</span><span class="entity">Leaf</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
              <span class="main">|</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span>
                  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="main">(</span><span class="entity">b</span> - <span class="inner_numeral">1</span><span class="main">)</span> &lt;&gt; <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">newbranch</span> <span class="entity">p</span> <span class="entity">t</span> <span class="entity">k</span> <span class="main">(</span><span class="entity">Leaf</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="entity">b</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">upd</span> <span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">upd</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">upd</span> <span class="entity">t</span>
        <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">t1</span> <span class="entity">t2</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">(</span><span class="entity">Empty</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">t2</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">Empty</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">t1</span>
        <span class="main">|</span> <span class="main">(</span><span class="entity">Leaf</span><span class="main">(</span><span class="entity">h1</span><span class="main">,</span><span class="entity">l1</span><span class="main">)</span><span class="main">,</span><span class="entity">Leaf</span><span class="main">(</span><span class="entity">h2</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">h1</span> <span class="main">=</span> <span class="entity">h2</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">combine_list</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">l1</span> <span class="entity">l2</span> <span class="keyword2"><span class="keyword">in</span></span>
                <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Empty</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">Leaf</span><span class="main">(</span><span class="entity">h1</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">newbranch</span> <span class="entity">h1</span> <span class="entity">t1</span> <span class="entity">h2</span> <span class="entity">t2</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="entity">lf</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Leaf</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">lis</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">br</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="main">(</span><span class="entity">b</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="entity">b</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">lf</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
                     <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">|</span> <span class="entity">l'</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l'</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">else</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">lf</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">of</span></span>
                     <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">l</span> <span class="main">|</span> <span class="entity">r'</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r'</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span>
                <span class="entity">newbranch</span> <span class="entity">k</span> <span class="entity">lf</span> <span class="entity">p</span> <span class="entity">br</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="entity">br</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">lf</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Leaf</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">lis</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="main">(</span><span class="entity">b</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="entity">land</span> <span class="entity">b</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">l</span> <span class="entity">lf</span> <span class="keyword2"><span class="keyword">of</span></span>
                    <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">|</span> <span class="entity">l'</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l'</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">else</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">r</span> <span class="entity">lf</span> <span class="keyword2"><span class="keyword">of</span></span>
                     <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">l</span> <span class="main">|</span> <span class="entity">r'</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r'</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span>
                <span class="entity">newbranch</span> <span class="entity">p</span> <span class="entity">br</span> <span class="entity">k</span> <span class="entity">lf</span>
        <span class="main">|</span> <span class="main">(</span><span class="entity">Branch</span><span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">b1</span><span class="main">,</span><span class="entity">l1</span><span class="main">,</span><span class="entity">r1</span><span class="main">)</span><span class="main">,</span><span class="entity">Branch</span><span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">b2</span><span class="main">,</span><span class="entity">l2</span><span class="main">,</span><span class="entity">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b1</span> &lt; <span class="entity">b2</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p2</span> <span class="entity">land</span> <span class="main">(</span><span class="entity">b1</span> - <span class="inner_numeral">1</span><span class="main">)</span> &lt;&gt; <span class="entity">p1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">newbranch</span> <span class="entity">p1</span> <span class="entity">t1</span> <span class="entity">p2</span> <span class="entity">t2</span>
                <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p2</span> <span class="entity">land</span> <span class="entity">b1</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">l1</span> <span class="entity">t2</span> <span class="keyword2"><span class="keyword">of</span></span>
                     <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">r1</span> <span class="main">|</span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">b1</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r1</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">else</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">r1</span> <span class="entity">t2</span> <span class="keyword2"><span class="keyword">of</span></span>
                     <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">l1</span> <span class="main">|</span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">b1</span><span class="main">,</span><span class="entity">l1</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b2</span> &lt; <span class="entity">b1</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p1</span> <span class="entity">land</span> <span class="main">(</span><span class="entity">b2</span> - <span class="inner_numeral">1</span><span class="main">)</span> &lt;&gt; <span class="entity">p2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">newbranch</span> <span class="entity">p1</span> <span class="entity">t1</span> <span class="entity">p2</span> <span class="entity">t2</span>
                <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p1</span> <span class="entity">land</span> <span class="entity">b2</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">t1</span> <span class="entity">l2</span> <span class="keyword2"><span class="keyword">of</span></span>
                     <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">r2</span> <span class="main">|</span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">b2</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r2</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">else</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">t1</span> <span class="entity">r2</span> <span class="keyword2"><span class="keyword">of</span></span>
                     <span class="entity">Empty</span> <span class="main">=&gt;</span> <span class="entity">l2</span> <span class="main">|</span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">b2</span><span class="main">,</span><span class="entity">l2</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p1</span> <span class="main">=</span> <span class="entity">p2</span> <span class="keyword2"><span class="keyword">then</span></span>
               <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">l1</span> <span class="entity">l2</span><span class="main">,</span><span class="entity">combine</span> <span class="entity">ord</span> <span class="entity">op'</span> <span class="entity">z</span> <span class="entity">r1</span> <span class="entity">r2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
                  <span class="main">(</span><span class="entity">Empty</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">|</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">Empty</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">l</span> <span class="main">|</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Branch</span><span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">b1</span><span class="main">,</span><span class="entity">l</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span>
                <span class="entity">newbranch</span> <span class="entity">p1</span> <span class="entity">t1</span> <span class="entity">p2</span> <span class="entity">t2</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="main">;</span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> |--&gt; <span class="comment1">(* For strings *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|--&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|-&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">t</span> <span class="entity">str_ord</span> <span class="entity">str_hash</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Special case of point function.                                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> |=&gt;

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">x</span> <span class="entity">|=&gt;</span> <span class="entity">y</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|-&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">undefined</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> |==&gt; <span class="comment1">(* For strings *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">x</span> <span class="entity">|==&gt;</span> <span class="entity">y</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|=&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">str_ord</span> <span class="entity">str_hash</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"intro.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Simple algebraic expression example from the introductory chapter.        *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Lexical analysis.                                                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">matches</span> <span class="entity">s</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">chars</span> <span class="main">=</span> String.explode <span class="entity">s</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">mem</span> <span class="entity">c</span> <span class="entity">chars</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">space</span> <span class="main">=</span> <span class="entity">matches</span> <span class="inner_quoted">" \t\n\r"</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">punctuation</span> <span class="main">=</span> <span class="entity">matches</span> <span class="inner_quoted">"()[]{},"</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">symbolic</span> <span class="main">=</span> <span class="entity">matches</span> <span class="inner_quoted">"~`!@#$%^&amp;*-+=|\\:;&lt;&gt;.?/"</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">numeric</span> <span class="main">=</span> <span class="entity">matches</span> <span class="inner_quoted">"0123456789"</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alphanumeric</span> <span class="main">=</span> <span class="entity">matches</span>
  <span class="inner_quoted">"abcdefghijklmnopqrstuvwxyz_'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lexwhile</span> <span class="entity">prop</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">inp</span> &lt;&gt; <span class="main">[</span><span class="main">]</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">prop</span> <span class="main">(</span>List.hd <span class="entity">inp</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
     <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">tok</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lexwhile</span> <span class="entity">prop</span> <span class="main">(</span>List.tl <span class="entity">inp</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
     <span class="main">(</span><span class="main">(</span>str <span class="main">(</span>List.hd <span class="entity">inp</span><span class="main">)</span><span class="main">)</span>^<span class="entity">tok</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">else</span></span>
     <span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span><span class="entity">inp</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lex</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">snd</span><span class="main">(</span><span class="entity">lexwhile</span> <span class="entity">space</span> <span class="entity">inp</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">c</span>::<span class="entity">cs</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">alphanumeric</span><span class="main">(</span><span class="entity">c</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">alphanumeric</span>
                        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">symbolic</span><span class="main">(</span><span class="entity">c</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">symbolic</span>
                        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> false
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">toktl</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lexwhile</span> <span class="entity">prop</span> <span class="entity">cs</span> <span class="keyword2"><span class="keyword">in</span></span>
             <span class="main">(</span><span class="main">(</span>str <span class="entity">c</span><span class="main">)</span>^<span class="entity">toktl</span><span class="main">)</span>::<span class="entity">lex</span> <span class="entity">rest</span>
             <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Generic function to impose lexing and exhaustion checking on a parser.    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make_parser</span> <span class="entity">pfn</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">expr</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pfn</span> <span class="main">(</span><span class="entity">lex</span><span class="main">(</span>String.explode <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">rest</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">expr</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Unparsed input"</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"formulas.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Polymorphic type of formulas with parser and printer.                     *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fm_ord</span> <span class="entity">at_ord</span> <span class="entity">fm1</span> <span class="entity">fm2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">fm1</span><span class="main">,</span><span class="entity">fm2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span>Falsity<span class="main">,</span>Falsity<span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">0</span>
    <span class="main">|</span> <span class="main">(</span>Falsity<span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>  <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>Falsity<span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>Truth<span class="main">,</span>Truth<span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">0</span>
    <span class="main">|</span> <span class="main">(</span>Truth<span class="main">,</span><span class="main">_</span><span class="main">)</span>  <span class="main">=&gt;</span>  <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>Truth<span class="main">)</span>  <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>Atom <span class="entity">a</span><span class="main">,</span> Atom <span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">at_ord</span> <span class="entity">a</span> <span class="entity">b</span>
    <span class="main">|</span> <span class="main">(</span>Atom<span class="main">(</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>Atom<span class="main">(</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>Not <span class="entity">a</span><span class="main">,</span>Not <span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fm_ord</span> <span class="entity">at_ord</span> <span class="entity">a</span> <span class="entity">b</span>
    <span class="main">|</span> <span class="main">(</span>Not<span class="main">(</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>Not<span class="main">(</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>And<span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span><span class="main">,</span>And<span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fm_pair_ord</span> <span class="entity">at_ord</span> <span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span> <span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>And<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>  <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>And<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>Or<span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span><span class="main">,</span>Or<span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fm_pair_ord</span> <span class="entity">at_ord</span> <span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span> <span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Or<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>  <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>Or<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fm_pair_ord</span> <span class="entity">at_ord</span> <span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span> <span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Imp<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>  <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>Imp<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>Iff<span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span><span class="main">,</span>Iff<span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fm_pair_ord</span> <span class="entity">at_ord</span> <span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span> <span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Iff<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>  <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>Iff<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>Forall<span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span><span class="main">,</span>Forall<span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fm_quant_ord</span> <span class="entity">at_ord</span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span> <span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Forall <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> Forall <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>

    <span class="main">|</span> <span class="main">(</span>Exists<span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span><span class="main">,</span>Exists<span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fm_quant_ord</span> <span class="entity">at_ord</span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span> <span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">fm_pair_ord</span> <span class="entity">at_ord</span> <span class="main">(</span><span class="entity">a1</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span> <span class="main">(</span><span class="entity">b1</span><span class="main">,</span><span class="entity">b2</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm_ord</span> <span class="entity">at_ord</span> <span class="entity">a1</span> <span class="entity">b1</span> <span class="keyword2"><span class="keyword">of</span></span>
     <span class="inner_numeral">0</span> <span class="main">=&gt;</span> <span class="entity">fm_ord</span> <span class="entity">at_ord</span> <span class="entity">a2</span> <span class="entity">b2</span>
    <span class="main">|</span><span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">n</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">fm_quant_ord</span> <span class="entity">at_ord</span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span> <span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">str_ord</span> <span class="entity">x1</span> <span class="entity">x2</span> <span class="keyword2"><span class="keyword">of</span></span>
     <span class="inner_numeral">0</span> <span class="main">=&gt;</span> <span class="entity">fm_ord</span> <span class="entity">at_ord</span> <span class="entity">a</span> <span class="entity">b</span>
    <span class="main">|</span><span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">n</span>
<span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* General parsing of iterated infixes.                                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_ginfix</span> <span class="entity">opsym</span> <span class="entity">opupdate</span> <span class="entity">sof</span> <span class="entity">subparser</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">e1</span><span class="main">,</span><span class="entity">inp1</span><span class="main">)</span> <span class="main">=</span> <span class="entity">subparser</span> <span class="entity">inp</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">inp1</span> &lt;&gt; <span class="main">[</span><span class="main">]</span> <span class="keyword1"><span class="keyword">andalso</span></span> List.hd <span class="entity">inp1</span> <span class="main">=</span> <span class="entity">opsym</span> <span class="keyword2"><span class="keyword">then</span></span>
     <span class="entity">parse_ginfix</span> <span class="entity">opsym</span> <span class="entity">opupdate</span> <span class="main">(</span><span class="entity">opupdate</span> <span class="entity">sof</span> <span class="entity">e1</span><span class="main">)</span> <span class="entity">subparser</span> <span class="main">(</span>List.tl <span class="entity">inp1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">sof</span> <span class="entity">e1</span><span class="main">,</span><span class="entity">inp1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_left_infix</span> <span class="entity">opsym</span> <span class="entity">opcon</span> <span class="main">=</span>
  <span class="entity">parse_ginfix</span> <span class="entity">opsym</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">e1</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">e2</span> <span class="main">=&gt;</span> <span class="entity">opcon</span><span class="main">(</span><span class="entity">f</span> <span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_right_infix</span> <span class="entity">opsym</span> <span class="entity">opcon</span> <span class="main">=</span>
  <span class="entity">parse_ginfix</span> <span class="entity">opsym</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">e1</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">e2</span> <span class="main">=&gt;</span> <span class="entity">f</span><span class="main">(</span><span class="entity">opcon</span><span class="main">(</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_list</span> <span class="entity">opsym</span> <span class="main">=</span>
  <span class="entity">parse_ginfix</span> <span class="entity">opsym</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">e1</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">e2</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">e1</span><span class="main">)</span>@<span class="main">[</span><span class="entity">e2</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Other general parsing combinators.                                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">papply</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">ast</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">ast</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">nextin</span> <span class="entity">inp</span> <span class="entity">tok</span> <span class="main">=</span> <span class="entity">inp</span> &lt;&gt; <span class="main">[</span><span class="main">]</span> <span class="keyword1"><span class="keyword">andalso</span></span> List.hd <span class="entity">inp</span> <span class="main">=</span> <span class="entity">tok</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_bracketed</span> <span class="entity">subparser</span> <span class="entity">cbra</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span><span class="main">(</span><span class="entity">ast</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span> <span class="main">=</span> <span class="entity">subparser</span> <span class="entity">inp</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">nextin</span> <span class="entity">rest</span> <span class="entity">cbra</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">ast</span><span class="main">,</span>List.tl <span class="entity">rest</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Closing bracket expected"</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Parsing of formulas, parametrized by atom parser "pfn".                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_atomic_formula</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="entity">vs</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">inp</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"formula expected"</span>
  <span class="main">|</span> <span class="inner_quoted">"false"</span>::<span class="entity">rest</span> <span class="main">=&gt;</span> <span class="main">(</span>Falsity<span class="main">,</span><span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">"true"</span>::<span class="entity">rest</span> <span class="main">=&gt;</span> <span class="main">(</span>Truth<span class="main">,</span><span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">"("</span>::<span class="entity">rest</span> <span class="main">=&gt;</span> <span class="main">(</span> <span class="main">(</span><span class="entity">ifn</span> <span class="entity">vs</span> <span class="entity">inp</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span>
                  <span class="entity">parse_bracketed</span> <span class="main">(</span><span class="entity">parse_formula</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="entity">vs</span><span class="main">)</span> <span class="inner_quoted">")"</span> <span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">"~"</span>::<span class="entity">rest</span> <span class="main">=&gt;</span> <span class="entity">papply</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> Not <span class="entity">p</span><span class="main">)</span>
                        <span class="main">(</span><span class="entity">parse_atomic_formula</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="entity">vs</span> <span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">"forall"</span>::<span class="entity">x</span>::<span class="entity">rest</span> <span class="main">=&gt;</span>
        <span class="entity">parse_quant</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">vs</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">rest</span>
  <span class="main">|</span> <span class="inner_quoted">"exists"</span>::<span class="entity">x</span>::<span class="entity">rest</span> <span class="main">=&gt;</span>
        <span class="entity">parse_quant</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">vs</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">rest</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">afn</span> <span class="entity">vs</span> <span class="entity">inp</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_quant</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="entity">vs</span> <span class="entity">qcon</span> <span class="entity">x</span> <span class="entity">inp</span> <span class="main">=</span>
   <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">inp</span> <span class="keyword2"><span class="keyword">of</span></span>
     <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Body of quantified term expected"</span>
   <span class="main">|</span> <span class="entity">y</span>::<span class="entity">rest</span> <span class="main">=&gt;</span>
        <span class="entity">papply</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">fm</span> <span class="main">=&gt;</span> <span class="entity">qcon</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">fm</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">y</span> <span class="main">=</span> <span class="inner_quoted">"."</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">parse_formula</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="entity">vs</span> <span class="entity">rest</span>
                <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">parse_quant</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="main">(</span><span class="entity">y</span>::<span class="entity">vs</span><span class="main">)</span> <span class="entity">qcon</span> <span class="entity">y</span> <span class="entity">rest</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_formula</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="entity">vs</span> <span class="entity">inp</span> <span class="main">=</span>
   <span class="entity">parse_right_infix</span> <span class="inner_quoted">"&lt;=&gt;"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> Iff<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="entity">parse_right_infix</span> <span class="inner_quoted">"==&gt;"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span><span class="entity">parse_right_infix</span> <span class="inner_quoted">"\\/"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> Or<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="entity">parse_right_infix</span> <span class="inner_quoted">"/\\"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="entity">parse_atomic_formula</span> <span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">afn</span><span class="main">)</span> <span class="entity">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">inp</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Printing of formulas, parametrized by atom printer.                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bracket</span> <span class="entity">p</span> <span class="entity">n</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> <span class="main">(</span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">print_string</span> <span class="inner_quoted">"("</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="entity">open_box</span> <span class="entity">n</span><span class="main">;</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">y</span><span class="main">;</span> <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">print_string</span> <span class="inner_quoted">")"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_quant</span> <span class="entity">fm</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
      Forall <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">(</span>Forall <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_quant</span> <span class="main">(</span>Forall <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="main">(</span><span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> Exists <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">(</span>Exists <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_quant</span> <span class="main">(</span>Exists <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="main">(</span><span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> Forall <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>
    <span class="main">|</span> Exists <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">fm</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_formula_aux</span> <span class="entity">pfn</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_formula</span> <span class="entity">pr</span> <span class="entity">fm</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
          Falsity <span class="main">=&gt;</span>
            <span class="entity">print_string</span> <span class="inner_quoted">"false"</span>
        <span class="main">|</span> Truth <span class="main">=&gt;</span>
            <span class="entity">print_string</span> <span class="inner_quoted">"true"</span>
        <span class="main">|</span> Atom <span class="entity">pargs</span> <span class="main">=&gt;</span>
            <span class="entity">pfn</span> <span class="entity">pr</span> <span class="entity">pargs</span>
        <span class="main">|</span> Not <span class="entity">p</span> <span class="main">=&gt;</span>
            <span class="entity">bracket</span> <span class="main">(</span><span class="entity">pr</span> &gt; <span class="inner_numeral">10</span><span class="main">)</span> <span class="inner_numeral">1</span> <span class="main">(</span><span class="entity">print_prefix</span> <span class="inner_numeral">10</span><span class="main">)</span> <span class="inner_quoted">"~"</span> <span class="entity">p</span>
        <span class="main">|</span> And <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="entity">bracket</span> <span class="main">(</span><span class="entity">pr</span> &gt; <span class="inner_numeral">8</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">print_infix</span> <span class="inner_numeral">8</span> <span class="inner_quoted">"/\\"</span><span class="main">)</span> <span class="entity">p</span> <span class="entity">q</span>
        <span class="main">|</span> Or <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="entity">bracket</span> <span class="main">(</span><span class="entity">pr</span> &gt; <span class="inner_numeral">6</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">print_infix</span> <span class="inner_numeral">6</span> <span class="inner_quoted">"\\/"</span><span class="main">)</span> <span class="entity">p</span> <span class="entity">q</span>
        <span class="main">|</span> Imp <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="entity">bracket</span> <span class="main">(</span><span class="entity">pr</span> &gt; <span class="inner_numeral">4</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">print_infix</span> <span class="inner_numeral">4</span> <span class="inner_quoted">"==&gt;"</span><span class="main">)</span> <span class="entity">p</span> <span class="entity">q</span>
        <span class="main">|</span> Iff <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="entity">bracket</span> <span class="main">(</span><span class="entity">pr</span> &gt; <span class="inner_numeral">2</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">print_infix</span> <span class="inner_numeral">2</span> <span class="inner_quoted">"&lt;=&gt;"</span><span class="main">)</span> <span class="entity">p</span> <span class="entity">q</span>
        <span class="main">|</span> Forall <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="entity">bracket</span> <span class="main">(</span><span class="entity">pr</span> &gt; <span class="inner_numeral">0</span><span class="main">)</span> <span class="inner_numeral">2</span> <span class="entity">print_qnt</span> <span class="inner_quoted">"forall"</span> <span class="main">(</span><span class="entity">strip_quant</span> <span class="entity">fm</span><span class="main">)</span>
        <span class="main">|</span> Exists <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="entity">bracket</span> <span class="main">(</span><span class="entity">pr</span> &gt; <span class="inner_numeral">0</span><span class="main">)</span> <span class="inner_numeral">2</span> <span class="entity">print_qnt</span> <span class="inner_quoted">"exists"</span> <span class="main">(</span><span class="entity">strip_quant</span> <span class="entity">fm</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">print_qnt</span> <span class="entity">qname</span> <span class="main">(</span><span class="entity">bvs</span><span class="main">,</span> <span class="entity">bod</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="entity">print_string</span> <span class="entity">qname</span><span class="main">;</span>
        List.app <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">v</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">print_string</span> <span class="inner_quoted">" "</span><span class="main">;</span> <span class="entity">print_string</span> <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="entity">bvs</span><span class="main">;</span>
        <span class="entity">print_string</span> <span class="inner_quoted">"."</span><span class="main">;</span> <span class="entity">print_space</span><span class="main">(</span><span class="main">)</span><span class="main">;</span> <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">;</span>
        <span class="entity">print_formula</span> <span class="inner_numeral">0</span> <span class="entity">bod</span><span class="main">;</span>
        <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span>
    <span class="main">)</span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">print_prefix</span> <span class="entity">newpr</span> <span class="entity">sym</span> <span class="entity">p</span> <span class="main">=</span> <span class="main">(</span>
        <span class="entity">print_string</span> <span class="entity">sym</span> <span class="main">;</span> <span class="entity">print_formula</span> <span class="main">(</span><span class="entity">newpr</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">p</span>
    <span class="main">)</span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">print_infix</span> <span class="entity">newpr</span> <span class="entity">sym</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span> <span class="main">(</span>
        <span class="entity">print_formula</span> <span class="main">(</span><span class="entity">newpr</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">p</span> <span class="main">;</span>
        <span class="entity">print_string</span> <span class="main">(</span><span class="inner_quoted">" "</span>^<span class="entity">sym</span><span class="main">)</span><span class="main">;</span> <span class="entity">print_space</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
        <span class="entity">print_formula</span> <span class="entity">newpr</span> <span class="entity">q</span>
    <span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">print_formula</span> <span class="inner_numeral">0</span>
    <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_formula</span> <span class="entity">pfn</span> <span class="entity">fm</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_formula_aux</span> <span class="entity">pfn</span> <span class="entity">fm</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_qformula_aux</span> <span class="entity">pfn</span> <span class="entity">fm</span> <span class="main">=</span> <span class="main">(</span>
  <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">;</span> <span class="entity">print_string</span> <span class="inner_quoted">"&lt;!"</span><span class="main">;</span>
  <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">;</span> <span class="entity">print_formula_aux</span> <span class="entity">pfn</span> <span class="entity">fm</span><span class="main">;</span> <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
  <span class="entity">print_string</span> <span class="inner_quoted">"!&gt;"</span><span class="main">;</span> <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span>
<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_qformula</span> <span class="entity">pfn</span> <span class="entity">fm</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_qformula_aux</span> <span class="entity">pfn</span> <span class="entity">fm</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_and</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span> And <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_or</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span> Or <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_imp</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span> Imp <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_iff</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span> Iff <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_forall</span> <span class="entity">x</span> <span class="entity">p</span> <span class="main">=</span> Forall <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_exists</span> <span class="entity">x</span> <span class="entity">p</span> <span class="main">=</span> Exists <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Destructors.                                                              *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_iff</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span> Iff<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_iff"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_and</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span> And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_and"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">conjuncts</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span> And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">conjuncts</span> <span class="entity">p</span> @ <span class="entity">conjuncts</span> <span class="entity">q</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">fm</span><span class="main">]</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_or</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span> Or<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_or"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">disjuncts</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span> Or<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">disjuncts</span> <span class="entity">p</span> @ <span class="entity">disjuncts</span> <span class="entity">q</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">fm</span><span class="main">]</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_imp</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span> Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_imp"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">antecedent</span> <span class="entity">fm</span> <span class="main">=</span> <span class="entity">fst</span> <span class="main">(</span><span class="entity">dest_imp</span> <span class="entity">fm</span><span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">consequent</span> <span class="entity">fm</span> <span class="main">=</span> <span class="entity">snd</span> <span class="main">(</span><span class="entity">dest_imp</span> <span class="entity">fm</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Apply a function to the atoms, otherwise keeping structure.               *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Atom <span class="entity">a</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">a</span>
  <span class="main">|</span> Not<span class="main">(</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> Not<span class="main">(</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">p</span><span class="main">)</span>
  <span class="main">|</span> And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> And<span class="main">(</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">p</span><span class="main">,</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">q</span><span class="main">)</span>
  <span class="main">|</span> Or<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> Or<span class="main">(</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">p</span><span class="main">,</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">q</span><span class="main">)</span>
  <span class="main">|</span> Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> Imp<span class="main">(</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">p</span><span class="main">,</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">q</span><span class="main">)</span>
  <span class="main">|</span> Iff<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> Iff<span class="main">(</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">p</span><span class="main">,</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">q</span><span class="main">)</span>
  <span class="main">|</span> Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">p</span><span class="main">)</span>
  <span class="main">|</span> Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">onatoms</span> <span class="entity">f</span> <span class="entity">p</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">fm</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Formula analog of list iterator "itlist".                                 *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">fm</span> <span class="entity">b</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Atom<span class="main">(</span><span class="entity">a</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">b</span>
  <span class="main">|</span> Not<span class="main">(</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">p</span> <span class="entity">b</span>
  <span class="main">|</span> And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">q</span> <span class="entity">b</span><span class="main">)</span>
  <span class="main">|</span> Or<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span>  <span class="main">=&gt;</span> <span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">q</span> <span class="entity">b</span><span class="main">)</span>
  <span class="main">|</span> Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">q</span> <span class="entity">b</span><span class="main">)</span>
  <span class="main">|</span> Iff<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">q</span> <span class="entity">b</span><span class="main">)</span>
  <span class="main">|</span> Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">p</span> <span class="entity">b</span>
  <span class="main">|</span> Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">overatoms</span> <span class="entity">f</span> <span class="entity">p</span> <span class="entity">b</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">b</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Special case of a union of the results of a function over the atoms.      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">atom_union</span> <span class="entity">ord</span> <span class="entity">f</span> <span class="entity">fm</span> <span class="main">=</span> <span class="entity">setify</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">overatoms</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">h</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">f</span><span class="main">(</span><span class="entity">h</span><span class="main">)</span>@<span class="entity">t</span><span class="main">)</span> <span class="entity">fm</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">atom_union_sip</span> <span class="entity">f</span> <span class="entity">fm</span> <span class="main">=</span> <span class="entity">atom_union</span> <span class="entity">sip_ord</span> <span class="entity">f</span> <span class="entity">fm</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"prop.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Basic stuff for propositional logic: datatype, parsing and printing.      *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Disjunctive normal form (DNF) via truth tables.                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list_conj</span> <span class="entity">l</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> Truth <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">end_itlist</span> <span class="entity">mk_and</span> <span class="entity">l</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"fol.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Basic stuff for first order logic.                                        *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Terms.                                                                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">t_ord</span> <span class="entity">t1</span> <span class="entity">t2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span>Var <span class="entity">x1</span><span class="main">,</span> Var <span class="entity">x2</span> <span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">str_ord</span> <span class="entity">x1</span> <span class="entity">x2</span>
    <span class="main">|</span> <span class="main">(</span>Var <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> Var <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>
    <span class="main">|</span> <span class="main">(</span>Fn<span class="main">(</span><span class="entity">f1</span><span class="main">,</span><span class="entity">tl1</span><span class="main">)</span><span class="main">,</span>Fn<span class="main">(</span><span class="entity">f2</span><span class="main">,</span><span class="entity">tl2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
       <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">str_ord</span> <span class="entity">f1</span> <span class="entity">f2</span> <span class="keyword2"><span class="keyword">of</span></span>
         <span class="inner_numeral">0</span> <span class="main">=&gt;</span> <span class="entity">tl_ord</span> <span class="entity">tl1</span> <span class="entity">tl2</span>
        <span class="main">|</span><span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">n</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">tl_ord</span> <span class="entity">tl1</span> <span class="entity">tl2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">tl1</span><span class="main">,</span><span class="entity">tl2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">0</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>
    <span class="main">|</span> <span class="main">(</span><span class="entity">t1</span>::<span class="entity">tl1'</span><span class="main">,</span><span class="entity">t2</span>::<span class="entity">tl2'</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t_ord</span> <span class="entity">t1</span> <span class="entity">t2</span> <span class="keyword2"><span class="keyword">of</span></span>
         <span class="inner_numeral">0</span> <span class="main">=&gt;</span> <span class="entity">tl_ord</span> <span class="entity">tl1'</span> <span class="entity">tl2'</span>
       <span class="main">|</span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">n</span>
<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">t_hash</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
      Var <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">str_hash</span> <span class="entity">x</span>
    <span class="main">|</span> Fn <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">tl</span><span class="main">)</span> <span class="main">=&gt;</span> Word.toIntX<span class="main">(</span>Word.+<span class="main">(</span>Word.*<span class="main">(</span><span class="inner_numeral">0wx31</span><span class="main">,</span>Word.fromInt<span class="main">(</span><span class="entity">str_hash</span> <span class="entity">f</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                                      Word.fromInt<span class="main">(</span><span class="entity">list_hash</span> <span class="entity">t_hash</span> <span class="entity">tl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">;</span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> |---&gt; <span class="comment1">(* For terms *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|---&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|-&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">t</span> <span class="entity">t_ord</span> <span class="entity">t_hash</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">6</span> |===&gt; <span class="comment1">(* For terms *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">x</span> <span class="entity">|===&gt;</span> <span class="entity">y</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|=&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">t_ord</span> <span class="entity">t_hash</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_t</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">apply</span> <span class="entity">t_ord</span> <span class="entity">t_hash</span> <span class="entity">f</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Abbreviation for FOL formula.                                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fol_ord</span> <span class="main">(</span><span class="entity">r1</span> <span class="keyword1"><span class="keyword">as</span></span> Rl<span class="main">(</span><span class="entity">s1</span><span class="main">,</span><span class="entity">tl1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">r2</span> <span class="keyword1"><span class="keyword">as</span></span> Rl<span class="main">(</span><span class="entity">s2</span><span class="main">,</span><span class="entity">tl2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">str_ord</span> <span class="entity">s1</span> <span class="entity">s2</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="inner_numeral">0</span> <span class="main">=&gt;</span> <span class="entity">tl_ord</span> <span class="entity">tl1</span> <span class="entity">tl2</span>
    <span class="main">|</span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">n</span>
<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">folfm_ord</span> <span class="entity">fm1</span> <span class="entity">fm2</span> <span class="main">=</span> <span class="entity">fm_ord</span> <span class="entity">fol_ord</span> <span class="entity">fm1</span> <span class="entity">fm2</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">union_folfm</span> <span class="entity">s1</span> <span class="entity">s2</span> <span class="main">=</span> <span class="entity">union</span> <span class="entity">folfm_ord</span> <span class="entity">s1</span> <span class="entity">s2</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ftp_ord</span> <span class="main">(</span><span class="entity">fm1</span><span class="main">,</span><span class="entity">t1</span><span class="main">)</span> <span class="main">(</span><span class="entity">fm2</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">folfm_ord</span> <span class="entity">fm1</span> <span class="entity">fm2</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="inner_numeral">0</span> <span class="main">=&gt;</span> <span class="entity">t_ord</span> <span class="entity">t1</span> <span class="entity">t2</span>
    <span class="main">|</span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">n</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">setify_ftp</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">setify</span> <span class="entity">ftp_ord</span> <span class="entity">s</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Special case of applying a subfunction to the top *terms*.                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">onformula</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">onatoms</span><span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span>Rl<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p</span><span class="main">,</span>List.map <span class="entity">f</span> <span class="entity">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Parsing of terms.                                                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_const_name</span> <span class="entity">s</span> <span class="main">=</span> List.all <span class="entity">numeric</span> <span class="main">(</span>String.explode <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">s</span> <span class="main">=</span> <span class="inner_quoted">"nil"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_atomic_term</span> <span class="entity">vs</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">inp</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"term expected"</span>
  <span class="main">|</span> <span class="inner_quoted">"("</span>::<span class="entity">rest</span> <span class="main">=&gt;</span> <span class="entity">parse_bracketed</span> <span class="main">(</span><span class="entity">parse_term</span> <span class="entity">vs</span><span class="main">)</span> <span class="inner_quoted">")"</span> <span class="entity">rest</span>
  <span class="main">|</span> <span class="inner_quoted">"-"</span>::<span class="entity">rest</span> <span class="main">=&gt;</span> <span class="entity">papply</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="inner_quoted">"-"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">parse_atomic_term</span> <span class="entity">vs</span> <span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">f</span>::<span class="inner_quoted">"("</span>::<span class="inner_quoted">")"</span>::<span class="entity">rest</span> <span class="main">=&gt;</span> <span class="main">(</span>Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">f</span>::<span class="inner_quoted">"("</span>::<span class="entity">rest</span> <span class="main">=&gt;</span>
      <span class="entity">papply</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">args</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="entity">parse_bracketed</span> <span class="main">(</span><span class="entity">parse_list</span> <span class="inner_quoted">","</span> <span class="main">(</span><span class="entity">parse_term</span> <span class="entity">vs</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">")"</span> <span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">a</span>::<span class="entity">rest</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_const_name</span> <span class="entity">a</span> <span class="keyword1"><span class="keyword">andalso</span></span> not<span class="main">(</span><span class="entity">mem</span> <span class="entity">a</span> <span class="entity">vs</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> Fn<span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> Var <span class="entity">a</span><span class="main">)</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_term</span> <span class="entity">vs</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="entity">parse_right_infix</span> <span class="inner_quoted">"::"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="inner_quoted">"::"</span><span class="main">,</span><span class="main">[</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">parse_right_infix</span> <span class="inner_quoted">"+"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="inner_quoted">"+"</span><span class="main">,</span><span class="main">[</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="entity">parse_left_infix</span> <span class="inner_quoted">"-"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="inner_quoted">"-"</span><span class="main">,</span><span class="main">[</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="entity">parse_right_infix</span> <span class="inner_quoted">"*"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="inner_quoted">"*"</span><span class="main">,</span><span class="main">[</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="entity">parse_left_infix</span> <span class="inner_quoted">"/"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="inner_quoted">"/"</span><span class="main">,</span><span class="main">[</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="entity">parse_left_infix</span> <span class="inner_quoted">"^"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="inner_quoted">"^"</span><span class="main">,</span><span class="main">[</span><span class="entity">e1</span><span class="main">,</span><span class="entity">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span><span class="entity">parse_atomic_term</span> <span class="entity">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">inp</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parset</span> <span class="main">=</span> <span class="entity">make_parser</span> <span class="main">(</span><span class="entity">parse_term</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Parsing of formulas.                                                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_infix_atom</span> <span class="entity">vs</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">tm</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span> <span class="main">=</span> <span class="entity">parse_term</span> <span class="entity">vs</span> <span class="entity">inp</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> List.exists <span class="main">(</span><span class="entity">nextin</span> <span class="entity">rest</span><span class="main">)</span> <span class="main">[</span><span class="inner_quoted">"="</span><span class="main">,</span> <span class="inner_quoted">"&lt;"</span><span class="main">,</span> <span class="inner_quoted">"&lt;="</span><span class="main">,</span> <span class="inner_quoted">"&gt;"</span><span class="main">,</span> <span class="inner_quoted">"&gt;="</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">papply</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tm'</span> <span class="main">=&gt;</span> Atom<span class="main">(</span>Rl<span class="main">(</span>List.hd <span class="entity">rest</span><span class="main">,</span><span class="main">[</span><span class="entity">tm</span><span class="main">,</span><span class="entity">tm'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span><span class="entity">parse_term</span> <span class="entity">vs</span> <span class="main">(</span>List.tl <span class="entity">rest</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">""</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_atom</span> <span class="entity">vs</span> <span class="entity">inp</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">parse_infix_atom</span> <span class="entity">vs</span> <span class="entity">inp</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">inp</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="entity">p</span>::<span class="inner_quoted">"("</span>::<span class="inner_quoted">")"</span>::<span class="entity">rest</span> <span class="main">=&gt;</span> <span class="main">(</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">p</span>::<span class="inner_quoted">"("</span>::<span class="entity">rest</span> <span class="main">=&gt;</span>
      <span class="entity">papply</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">args</span> <span class="main">=&gt;</span> Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="entity">parse_bracketed</span> <span class="main">(</span><span class="entity">parse_list</span> <span class="inner_quoted">","</span> <span class="main">(</span><span class="entity">parse_term</span> <span class="entity">vs</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">")"</span> <span class="entity">rest</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">p</span>::<span class="entity">rest</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> &lt;&gt; <span class="inner_quoted">"("</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">rest</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"parse_atom"</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"parse_atom"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse</span> <span class="main">=</span> <span class="entity">make_parser</span>
  <span class="main">(</span><span class="entity">parse_formula</span> <span class="main">(</span><span class="entity">parse_infix_atom</span><span class="main">,</span><span class="entity">parse_atom</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Set up parsing of quotations.                                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">default_parser</span> <span class="main">=</span> <span class="entity">parse</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">default_parser_end</span> <span class="main">=</span> <span class="entity">!&gt;</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">&lt;!</span> <span class="entity">s</span> <span class="entity">!&gt;</span> <span class="main">=</span> <span class="entity">default_parser</span> <span class="entity">s</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">secondary_parser</span> <span class="main">=</span> <span class="entity">parset</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">secondary_parser_end</span> <span class="main">=</span> <span class="entity">|!&gt;</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">&lt;!|</span> <span class="entity">s</span> <span class="entity">|!&gt;</span> <span class="main">=</span> <span class="entity">secondary_parser</span> <span class="entity">s</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Printing of terms.                                                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_term_aux</span> <span class="entity">prec</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Var <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">print_string</span> <span class="entity">x</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="inner_quoted">"^"</span><span class="main">,</span><span class="main">[</span><span class="entity">tm1</span><span class="main">,</span><span class="entity">tm2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">print_infix_term_aux</span> true <span class="entity">prec</span> <span class="inner_numeral">24</span> <span class="inner_quoted">"^"</span> <span class="entity">tm1</span> <span class="entity">tm2</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="inner_quoted">"/"</span><span class="main">,</span><span class="main">[</span><span class="entity">tm1</span><span class="main">,</span><span class="entity">tm2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">print_infix_term_aux</span> true <span class="entity">prec</span> <span class="inner_numeral">22</span> <span class="inner_quoted">" /"</span> <span class="entity">tm1</span> <span class="entity">tm2</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="inner_quoted">"*"</span><span class="main">,</span><span class="main">[</span><span class="entity">tm1</span><span class="main">,</span><span class="entity">tm2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">print_infix_term_aux</span> false <span class="entity">prec</span> <span class="inner_numeral">20</span> <span class="inner_quoted">" *"</span> <span class="entity">tm1</span> <span class="entity">tm2</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="inner_quoted">"-"</span><span class="main">,</span><span class="main">[</span><span class="entity">tm1</span><span class="main">,</span><span class="entity">tm2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">print_infix_term_aux</span> true <span class="entity">prec</span> <span class="inner_numeral">18</span> <span class="inner_quoted">" -"</span> <span class="entity">tm1</span> <span class="entity">tm2</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="inner_quoted">"+"</span><span class="main">,</span><span class="main">[</span><span class="entity">tm1</span><span class="main">,</span><span class="entity">tm2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">print_infix_term_aux</span> false <span class="entity">prec</span> <span class="inner_numeral">16</span> <span class="inner_quoted">" +"</span> <span class="entity">tm1</span> <span class="entity">tm2</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="inner_quoted">"::"</span><span class="main">,</span><span class="main">[</span><span class="entity">tm1</span><span class="main">,</span><span class="entity">tm2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">print_infix_term_aux</span> false <span class="entity">prec</span> <span class="inner_numeral">14</span> <span class="inner_quoted">"::"</span> <span class="entity">tm1</span> <span class="entity">tm2</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">print_fargs_aux</span> <span class="entity">f</span> <span class="entity">args</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">print_fargs_aux</span> <span class="entity">f</span> <span class="entity">args</span> <span class="main">=</span> <span class="main">(</span>
  <span class="entity">print_string</span> <span class="entity">f</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">args</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span>
   <span class="main">(</span><span class="entity">print_string</span> <span class="inner_quoted">"("</span><span class="main">;</span>
    <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">;</span>
    <span class="entity">print_term_aux</span> <span class="inner_numeral">0</span> <span class="main">(</span>List.hd <span class="entity">args</span><span class="main">)</span><span class="main">;</span> <span class="entity">print_break</span> <span class="inner_numeral">0</span> <span class="inner_numeral">0</span><span class="main">;</span>
    List.app <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">print_string</span> <span class="inner_quoted">","</span><span class="main">;</span> <span class="entity">print_break</span> <span class="inner_numeral">0</span> <span class="inner_numeral">0</span> <span class="main">;</span> <span class="entity">print_term_aux</span> <span class="inner_numeral">0</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>List.tl <span class="entity">args</span><span class="main">)</span><span class="main">;</span>
    <span class="entity">close_box</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
    <span class="entity">print_string</span> <span class="inner_quoted">")"</span><span class="main">)</span>
<span class="main">)</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">print_infix_term_aux</span> <span class="entity">isleft</span> <span class="entity">oldprec</span> <span class="entity">newprec</span> <span class="entity">sym</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">oldprec</span> &gt; <span class="entity">newprec</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">print_string</span> <span class="inner_quoted">"("</span><span class="main">;</span> <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
  <span class="entity">print_term_aux</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isleft</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">newprec</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">newprec</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">p</span><span class="main">;</span>
  <span class="entity">print_string</span> <span class="entity">sym</span><span class="main">;</span>
  <span class="entity">print_break</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> String.substring <span class="main">(</span><span class="entity">sym</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">" "</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="inner_numeral">0</span><span class="main">;</span>
  <span class="entity">print_term_aux</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isleft</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">newprec</span>+<span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">newprec</span><span class="main">)</span> <span class="entity">q</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">oldprec</span> &gt; <span class="entity">newprec</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">close_box</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span> <span class="entity">print_string</span> <span class="inner_quoted">")"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_term</span> <span class="entity">prec</span> <span class="entity">fm</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_term_aux</span> <span class="entity">prec</span> <span class="entity">fm</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">print_fargs</span> <span class="entity">f</span> <span class="entity">args</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_fargs_aux</span> <span class="entity">f</span> <span class="entity">args</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">print_infix_term</span> <span class="entity">isleft</span> <span class="entity">oldprec</span> <span class="entity">newprec</span> <span class="entity">sym</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_infix_term_aux</span> <span class="entity">isleft</span> <span class="entity">oldprec</span> <span class="entity">newprec</span> <span class="entity">sym</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">printert_aux</span> <span class="entity">tm</span> <span class="main">=</span> <span class="main">(</span>
  <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">;</span> <span class="entity">print_string</span> <span class="inner_quoted">"&lt;!|"</span><span class="main">;</span>
  <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">;</span> <span class="entity">print_term_aux</span> <span class="inner_numeral">0</span> <span class="entity">tm</span><span class="main">;</span> <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
  <span class="entity">print_string</span> <span class="inner_quoted">"|!&gt;"</span><span class="main">;</span> <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span>
<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">printert</span> <span class="entity">tm</span> <span class="main">=</span> <span class="main">(</span><span class="entity">printert_aux</span> <span class="entity">tm</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Printing of formulas.                                                     *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_atom_aux</span> <span class="entity">prec</span> <span class="main">(</span>Rl <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mem</span> <span class="entity">p</span> <span class="main">[</span><span class="inner_quoted">"="</span><span class="main">,</span> <span class="inner_quoted">"&lt;"</span><span class="main">,</span> <span class="inner_quoted">"&lt;="</span><span class="main">,</span> <span class="inner_quoted">"&gt;"</span><span class="main">,</span> <span class="inner_quoted">"&gt;="</span><span class="main">]</span> <span class="keyword1"><span class="keyword">andalso</span></span> List.length <span class="entity">args</span> <span class="main">=</span> <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">print_infix_term_aux</span> false <span class="inner_numeral">12</span> <span class="inner_numeral">12</span> <span class="main">(</span><span class="inner_quoted">" "</span> ^ <span class="entity">p</span><span class="main">)</span> <span class="main">(</span>List.nth <span class="main">(</span><span class="entity">args</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>List.nth <span class="main">(</span><span class="entity">args</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span>
        <span class="entity">print_fargs_aux</span> <span class="entity">p</span> <span class="entity">args</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_atom</span> <span class="entity">prec</span> <span class="entity">rpa</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_atom_aux</span> <span class="entity">prec</span> <span class="entity">rpa</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print_fol_formula_aux</span> <span class="main">=</span> <span class="entity">print_qformula_aux</span> <span class="entity">print_atom_aux</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_fol_formula</span> <span class="entity">f</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_fol_formula_aux</span> <span class="entity">f</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Free variables in terms and formulas.                                     *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fvt</span> <span class="entity">tm</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">tm</span> <span class="keyword2"><span class="keyword">of</span></span>
      Var <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span>
    <span class="main">|</span> Fn <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">unions_str</span> <span class="main">(</span>List.map <span class="entity">fvt</span> <span class="entity">args</span><span class="main">)</span>
<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">var</span> <span class="entity">fm</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
      Falsity <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
    <span class="main">|</span> Truth <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
    <span class="main">|</span> Atom <span class="main">(</span>Rl <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">unions</span> <span class="entity">str_ord</span> <span class="main">(</span>List.map <span class="entity">fvt</span> <span class="entity">args</span><span class="main">)</span>
    <span class="main">|</span> Not <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">var</span> <span class="entity">p</span>
    <span class="main">|</span> And <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_str</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Or  <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_str</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Imp <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_str</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Iff <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_str</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Forall <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">insert_str</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">p</span><span class="main">)</span>
    <span class="main">|</span> Exists <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">insert_str</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">p</span><span class="main">)</span>
<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fv</span> <span class="entity">fm</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
      Falsity <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
    <span class="main">|</span> Truth <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
    <span class="main">|</span> Atom <span class="main">(</span>Rl <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">unions_str</span> <span class="main">(</span>List.map <span class="entity">fvt</span> <span class="entity">args</span><span class="main">)</span>
    <span class="main">|</span> Not <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">fv</span> <span class="entity">p</span>
    <span class="main">|</span> And <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Or  <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Imp <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Iff <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Forall <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">subtract_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span>
    <span class="main">|</span> Exists <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">subtract_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span>
<span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Substitution within terms.                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tsubst</span> <span class="entity">sfn</span> <span class="entity">tm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">tm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Var <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">tryapplyd_str</span> <span class="entity">sfn</span> <span class="entity">x</span> <span class="entity">tm</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span>List.map <span class="main">(</span><span class="entity">tsubst</span> <span class="entity">sfn</span><span class="main">)</span> <span class="entity">args</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">variant</span> <span class="entity">x</span> <span class="entity">vars</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mem</span> <span class="entity">x</span> <span class="entity">vars</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">variant</span> <span class="main">(</span><span class="entity">x</span>^<span class="inner_quoted">"'"</span><span class="main">)</span> <span class="entity">vars</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">x</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Substitution in formulas, with variable renaming.                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">fm</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
      Falsity <span class="main">=&gt;</span> Falsity
    <span class="main">|</span> Truth <span class="main">=&gt;</span> Truth
    <span class="main">|</span> Atom <span class="main">(</span>Rl <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        Atom <span class="main">(</span>Rl <span class="main">(</span><span class="entity">p</span><span class="main">,</span> List.map <span class="main">(</span><span class="entity">tsubst</span> <span class="entity">subfn</span><span class="main">)</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Not <span class="entity">p</span> <span class="main">=&gt;</span>
        Not <span class="main">(</span><span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">p</span><span class="main">)</span>
    <span class="main">|</span> And <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
        And <span class="main">(</span><span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">p</span><span class="main">,</span> <span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Or <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
        Or  <span class="main">(</span><span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">p</span><span class="main">,</span> <span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Imp <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
        Imp <span class="main">(</span><span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">p</span><span class="main">,</span> <span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Iff <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
        Iff <span class="main">(</span><span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">p</span><span class="main">,</span> <span class="entity">subst</span> <span class="entity">subfn</span> <span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> Forall <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">substq</span> <span class="entity">subfn</span> <span class="entity">mk_forall</span> <span class="entity">x</span> <span class="entity">p</span>
    <span class="main">|</span> Exists <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">substq</span> <span class="entity">subfn</span> <span class="entity">mk_exists</span> <span class="entity">x</span> <span class="entity">p</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substq</span> <span class="entity">subfn</span> <span class="entity">quant</span> <span class="entity">x</span> <span class="entity">p</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x'</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">if</span></span> List.exists <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">mem</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">fvt</span> <span class="main">(</span><span class="entity">tryapplyd_str</span> <span class="entity">subfn</span> <span class="entity">y</span> <span class="main">(</span>Var <span class="entity">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">(</span><span class="entity">subtract_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">variant</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">fv</span> <span class="main">(</span><span class="entity">subst</span> <span class="main">(</span><span class="entity">undefine_str</span> <span class="entity">x</span> <span class="entity">subfn</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">x</span>
    <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">quant</span> <span class="entity">x'</span> <span class="main">(</span><span class="entity">subst</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span> <span class="entity">|--&gt;</span> Var <span class="entity">x'</span><span class="main">)</span> <span class="entity">subfn</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"skolem.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Prenex and Skolem normal forms.                                           *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Get the functions in a term and formula.                                  *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">funcs</span> <span class="entity">tm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">tm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Var <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">itlist</span> <span class="main">(</span><span class="entity">union_sip</span> o <span class="entity">funcs</span><span class="main">)</span> <span class="entity">args</span> <span class="main">[</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span>List.length <span class="entity">args</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">functions</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="entity">atom_union_sip</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span>Rl<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">itlist</span> <span class="main">(</span><span class="entity">union_sip</span> o <span class="entity">funcs</span><span class="main">)</span> <span class="entity">a</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="entity">fm</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"unif.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Unification for first order terms.                                        *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">istriv</span> <span class="entity">env</span> <span class="entity">x</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
    Var <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">x</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">defined_str</span> <span class="entity">env</span> <span class="entity">y</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">istriv</span> <span class="entity">env</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">apply_str</span> <span class="entity">env</span> <span class="entity">y</span><span class="main">)</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> List.exists <span class="main">(</span><span class="entity">istriv</span> <span class="entity">env</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">args</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"cyclic"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Main unification procedure                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unify</span> <span class="entity">env</span> <span class="entity">eqs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">eqs</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">env</span>
  <span class="main">|</span> <span class="main">(</span>Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">fargs</span><span class="main">)</span><span class="main">,</span>Fn<span class="main">(</span><span class="entity">g</span><span class="main">,</span><span class="entity">gargs</span><span class="main">)</span><span class="main">)</span>::<span class="entity">oth</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">g</span> <span class="keyword1"><span class="keyword">andalso</span></span> length <span class="entity">fargs</span> <span class="main">=</span> length <span class="entity">gargs</span>
        <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">unify</span> <span class="entity">env</span> <span class="main">(</span><span class="entity">zip</span> <span class="entity">fargs</span> <span class="entity">gargs</span> @ <span class="entity">oth</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"impossible unification"</span>
  <span class="main">|</span> <span class="main">(</span>Var <span class="entity">x</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span>::<span class="entity">oth</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">defined_str</span> <span class="entity">env</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">unify</span> <span class="entity">env</span> <span class="main">(</span><span class="main">(</span><span class="entity">apply_str</span> <span class="entity">env</span> <span class="entity">x</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span>::<span class="entity">oth</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">unify</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">istriv</span> <span class="entity">env</span> <span class="entity">x</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">env</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">x</span><span class="entity">|--&gt;</span><span class="entity">t</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span> <span class="entity">oth</span>
  <span class="main">|</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span>Var <span class="entity">x</span><span class="main">)</span>::<span class="entity">oth</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">defined_str</span> <span class="entity">env</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">unify</span> <span class="entity">env</span> <span class="main">(</span><span class="main">(</span><span class="entity">apply_str</span> <span class="entity">env</span> <span class="entity">x</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span>::<span class="entity">oth</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">unify</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">istriv</span> <span class="entity">env</span> <span class="entity">x</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">env</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">x</span><span class="entity">|--&gt;</span><span class="entity">t</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span> <span class="entity">oth</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Solve to obtain a single instantiation.                                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve</span> <span class="entity">env</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">env'</span> <span class="main">=</span> <span class="entity">mapf</span> <span class="main">(</span><span class="entity">tsubst</span> <span class="entity">env</span><span class="main">)</span> <span class="entity">env</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">env'</span> <span class="main">=</span> <span class="entity">env</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">env</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">solve</span> <span class="entity">env'</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Unification reaching a final solved form (often this isn't needed).       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fullunify</span> <span class="entity">eqs</span> <span class="main">=</span> <span class="entity">solve</span> <span class="main">(</span><span class="entity">unify</span> <span class="entity">undefined</span> <span class="entity">eqs</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unify_and_apply</span> <span class="entity">eqs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">fullunify</span> <span class="entity">eqs</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">tsubst</span> <span class="entity">i</span> <span class="entity">t1</span><span class="main">,</span><span class="entity">tsubst</span> <span class="entity">i</span> <span class="entity">t2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  map <span class="entity">apply</span> <span class="entity">eqs</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"tableaux.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Tableaux, seen as an optimized version of a Prawitz-like procedure.       *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">deepen</span> <span class="entity">f</span> <span class="entity">n</span> <span class="main">=</span>
  <span class="main">(</span><span class="comment1">(* XXX print_string "Searching with depth limit ";
      print_int n; print_newline(); *)</span> <span class="entity">f</span> <span class="entity">n</span>
  <span class="main">)</span>
  <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">deepen</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">n</span> + <span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"resolution.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Resolution.                                                               *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Matching of terms and literals.                                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">term_match</span> <span class="entity">env</span> <span class="entity">eqs</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">eqs</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">env</span>
    <span class="main">|</span> <span class="main">(</span>Fn <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">fa</span><span class="main">)</span><span class="main">,</span> Fn<span class="main">(</span><span class="entity">g</span><span class="main">,</span> <span class="entity">ga</span><span class="main">)</span><span class="main">)</span> :: <span class="entity">oth</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">f</span> <span class="main">=</span> <span class="entity">g</span> <span class="keyword1"><span class="keyword">andalso</span></span> List.length <span class="entity">fa</span> <span class="main">=</span> List.length <span class="entity">ga</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">term_match</span> <span class="entity">env</span> <span class="main">(</span><span class="entity">zip</span> <span class="entity">fa</span> <span class="entity">ga</span> @ <span class="entity">oth</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"term_match"</span>
    <span class="main">|</span> <span class="main">(</span>Var <span class="entity">x</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> :: <span class="entity">oth</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">defined_str</span> <span class="entity">env</span> <span class="entity">x</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">term_match</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span> <span class="entity">|--&gt;</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span> <span class="entity">oth</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">apply_str</span> <span class="entity">env</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">term_match</span> <span class="entity">env</span> <span class="entity">oth</span>
        <span class="keyword2"><span class="keyword">else</span></span>
            <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"term_match"</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span>
        <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"term_match"</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"equal.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* First order logic with equality.                                          *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_eq</span> <span class="entity">s</span> <span class="entity">t</span> <span class="main">=</span> Atom<span class="main">(</span>Rl<span class="main">(</span><span class="inner_quoted">"="</span><span class="main">,</span><span class="main">[</span><span class="entity">s</span><span class="main">,</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_eq</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Atom<span class="main">(</span>Rl<span class="main">(</span><span class="inner_quoted">"="</span><span class="main">,</span><span class="main">[</span><span class="entity">s</span><span class="main">,</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_eq: not an equation"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lhs</span> <span class="entity">eq</span> <span class="main">=</span> <span class="entity">fst</span> <span class="main">(</span><span class="entity">dest_eq</span> <span class="entity">eq</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">rhs</span> <span class="entity">eq</span> <span class="main">=</span> <span class="entity">snd</span> <span class="main">(</span><span class="entity">dest_eq</span> <span class="entity">eq</span><span class="main">)</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"order.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Term orderings.                                                           *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">termsize</span> <span class="entity">tm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">tm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Var <span class="entity">x</span> <span class="main">=&gt;</span> <span class="inner_numeral">1</span>
  <span class="main">|</span> Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">itlist</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">termsize</span> <span class="entity">t</span> + <span class="entity">n</span><span class="main">)</span> <span class="entity">args</span> <span class="inner_numeral">1</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"eqelim.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Equality elimination including Brand transformation and relatives.        *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Replacement (substitution for non-variable) in term and literal.          *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">replacet</span> <span class="entity">rfn</span> <span class="entity">tm</span> <span class="main">=</span>
  <span class="entity">apply_t</span> <span class="entity">rfn</span> <span class="entity">tm</span>
  <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">tm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> Fn<span class="main">(</span><span class="entity">f</span><span class="main">,</span>List.map <span class="main">(</span><span class="entity">replacet</span> <span class="entity">rfn</span><span class="main">)</span> <span class="entity">args</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">tm</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"lcf.sml"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_thm_aux</span> <span class="entity">th</span> <span class="main">=</span> <span class="main">(</span>
    <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">;</span>
    <span class="entity">print_string</span> <span class="inner_quoted">"|-"</span><span class="main">;</span> <span class="entity">print_space</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
    <span class="entity">open_box</span> <span class="inner_numeral">0</span><span class="main">;</span> <span class="entity">print_formula_aux</span> <span class="entity">print_atom_aux</span> <span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span><span class="main">;</span> <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
    <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_thm</span> <span class="entity">th</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_thm_aux</span> <span class="entity">th</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"lcfprop.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Propositional reasoning by derived rules atop the LCF core.               *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- p ==&gt; p                                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_refl</span> <span class="entity">p</span> <span class="main">=</span>
  modusponens <span class="main">(</span>modusponens <span class="main">(</span>axiom_distribimp <span class="entity">p</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span>
                           <span class="main">(</span>axiom_addimp <span class="entity">p</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>axiom_addimp <span class="entity">p</span> <span class="entity">p</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                 |- p ==&gt; p ==&gt; q                                          *)</span>
<span class="comment1">(*               -------------------- imp_unduplicate                        *)</span>
<span class="comment1">(*                 |- p ==&gt; q                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_unduplicate</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">pq</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">q</span> <span class="main">=</span> <span class="entity">consequent</span> <span class="entity">pq</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span>modusponens <span class="main">(</span>axiom_distribimp <span class="entity">p</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="entity">th</span><span class="main">)</span> <span class="main">(</span><span class="entity">imp_refl</span> <span class="entity">p</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Some handy syntax operations.                                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">negatef</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Falsity<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">p</span>
  <span class="main">|</span> <span class="entity">p</span> <span class="main">=&gt;</span> Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">negativef</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Falsity<span class="main">)</span> <span class="main">=&gt;</span> true
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                           |- q                                            *)</span>
<span class="comment1">(*         ------------------------------------------------ add_assum (p)    *)</span>
<span class="comment1">(*                         |- p ==&gt; q                                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_assum</span> <span class="entity">p</span> <span class="entity">th</span> <span class="main">=</span> modusponens <span class="main">(</span>axiom_addimp <span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span> <span class="entity">th</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                   |- q ==&gt; r                                              *)</span>
<span class="comment1">(*         --------------------------------------- imp_add_assum p           *)</span>
<span class="comment1">(*           |- (p ==&gt; q) ==&gt; (p ==&gt; r)                                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_add_assum</span> <span class="entity">p</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span>axiom_distribimp <span class="entity">p</span> <span class="entity">q</span> <span class="entity">r</span><span class="main">)</span> <span class="main">(</span><span class="entity">add_assum</span> <span class="entity">p</span> <span class="entity">th</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*            |- p ==&gt; q              |- q ==&gt; r                             *)</span>
<span class="comment1">(*         ----------------------------------------- imp_trans               *)</span>
<span class="comment1">(*                 |- p ==&gt; r                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_trans</span> <span class="entity">th1</span> <span class="entity">th2</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">antecedent</span><span class="main">(</span>concl <span class="entity">th1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span><span class="entity">imp_add_assum</span> <span class="entity">p</span> <span class="entity">th2</span><span class="main">)</span> <span class="entity">th1</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                 |- p ==&gt; r                                                *)</span>
<span class="comment1">(*         -------------------------- imp_insert q                           *)</span>
<span class="comment1">(*              |- p ==&gt; q ==&gt; r                                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_insert</span> <span class="entity">q</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span>axiom_addimp <span class="entity">r</span> <span class="entity">q</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                 |- p ==&gt; q ==&gt; r                                          *)</span>
<span class="comment1">(*              ---------------------- imp_swap                              *)</span>
<span class="comment1">(*                 |- q ==&gt; p ==&gt; r                                          *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_swap</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">qr</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span> <span class="entity">qr</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="main">(</span>axiom_addimp <span class="entity">q</span> <span class="entity">p</span><span class="main">)</span>
            <span class="main">(</span>modusponens <span class="main">(</span>axiom_distribimp <span class="entity">p</span> <span class="entity">q</span> <span class="entity">r</span><span class="main">)</span> <span class="entity">th</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- (q ==&gt; r) ==&gt; (p ==&gt; q) ==&gt; (p ==&gt; r)                                  *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_trans_th</span> <span class="entity">p</span> <span class="entity">q</span> <span class="entity">r</span> <span class="main">=</span>
   <span class="entity">imp_trans</span> <span class="main">(</span>axiom_addimp <span class="main">(</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span>
             <span class="main">(</span>axiom_distribimp <span class="entity">p</span> <span class="entity">q</span> <span class="entity">r</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                 |- p ==&gt; q                                                *)</span>
<span class="comment1">(*         ------------------------------- imp_add_concl r                   *)</span>
<span class="comment1">(*          |- (q ==&gt; r) ==&gt; (p ==&gt; r)                                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_add_concl</span> <span class="entity">r</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span><span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans_th</span> <span class="entity">p</span> <span class="entity">q</span> <span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- (p ==&gt; q ==&gt; r) ==&gt; (q ==&gt; p ==&gt; r)                                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_swap_th</span> <span class="entity">p</span> <span class="entity">q</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="entity">imp_trans</span> <span class="main">(</span>axiom_distribimp <span class="entity">p</span> <span class="entity">q</span> <span class="entity">r</span><span class="main">)</span>
            <span class="main">(</span><span class="entity">imp_add_concl</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>axiom_addimp <span class="entity">q</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*  |- (p ==&gt; q ==&gt; r) ==&gt; (s ==&gt; t ==&gt; u)                                   *)</span>
<span class="comment1">(* -----------------------------------------                                 *)</span>
<span class="comment1">(*  |- (q ==&gt; p ==&gt; r) ==&gt; (t ==&gt; s ==&gt; u)                                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_swap2</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> concl <span class="entity">th</span> <span class="keyword2"><span class="keyword">of</span></span>
    Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">s</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">imp_swap_th</span> <span class="entity">q</span> <span class="entity">p</span> <span class="entity">r</span><span class="main">)</span> <span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span><span class="entity">imp_swap_th</span> <span class="entity">s</span> <span class="entity">t</span> <span class="entity">u</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"imp_swap2"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* If |- p ==&gt; q ==&gt; r and |- p ==&gt; q then |- p ==&gt; r.                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">right_mp</span> <span class="entity">ith</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="entity">imp_unduplicate</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span><span class="entity">imp_swap</span> <span class="entity">ith</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                 |- p &lt;=&gt; q                                                *)</span>
<span class="comment1">(*                ------------ iff_imp1                                      *)</span>
<span class="comment1">(*                 |- p ==&gt; q                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iff_imp1</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_iff</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span>axiom_iffimp1 <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="entity">th</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                 |- p &lt;=&gt; q                                                *)</span>
<span class="comment1">(*                ------------ iff_imp2                                      *)</span>
<span class="comment1">(*                 |- q ==&gt; p                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iff_imp2</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_iff</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span>axiom_iffimp2 <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="entity">th</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         |- p ==&gt; q      |- q ==&gt; p                                        *)</span>
<span class="comment1">(*        ---------------------------- imp_antisym                           *)</span>
<span class="comment1">(*              |- p &lt;=&gt; q                                                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_antisym</span> <span class="entity">th1</span> <span class="entity">th2</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span>modusponens <span class="main">(</span>axiom_impiff <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="entity">th1</span><span class="main">)</span> <span class="entity">th2</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         |- p ==&gt; (q ==&gt; false) ==&gt; false                                  *)</span>
<span class="comment1">(*       ----------------------------------- right_doubleneg                 *)</span>
<span class="comment1">(*               |- p ==&gt; q                                                  *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">right_doubleneg</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> concl <span class="entity">th</span> <span class="keyword2"><span class="keyword">of</span></span>
    Imp<span class="main">(</span><span class="main">_</span><span class="main">,</span>Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span>axiom_doubleneg <span class="entity">p</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"right_doubleneg"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                                                                           *)</span>
<span class="comment1">(*         ------------------------------------------- ex_falso (p)          *)</span>
<span class="comment1">(*                 |- false ==&gt; p                                            *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ex_falso</span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">right_doubleneg</span><span class="main">(</span>axiom_addimp Falsity <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*  |- p ==&gt; q ==&gt; r        |- r ==&gt; s                                       *)</span>
<span class="comment1">(* ------------------------------------ imp_trans2                           *)</span>
<span class="comment1">(*      |- p ==&gt; q ==&gt; s                                                     *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_trans2</span> <span class="entity">th1</span> <span class="entity">th2</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> concl <span class="entity">th1</span>
      <span class="keyword1"><span class="keyword">val</span></span> Imp<span class="main">(</span><span class="entity">r'</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="main">=</span> concl <span class="entity">th2</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">imp_add_assum</span> <span class="entity">p</span> <span class="main">(</span>modusponens <span class="main">(</span><span class="entity">imp_trans_th</span> <span class="entity">q</span> <span class="entity">r</span> <span class="entity">s</span><span class="main">)</span> <span class="entity">th2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="entity">th</span> <span class="entity">th1</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         |- p ==&gt; q1   ...   |- p ==&gt; qn   |- q1 ==&gt; ... ==&gt; qn ==&gt; r      *)</span>
<span class="comment1">(*        --------------------------------------------------------------     *)</span>
<span class="comment1">(*                             |- p ==&gt; r                                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_trans_chain</span> <span class="entity">ths</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="entity">itlist</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">a</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">b</span> <span class="main">=&gt;</span> <span class="entity">imp_unduplicate</span> <span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">imp_swap</span> <span class="entity">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>List.rev<span class="main">(</span>List.tl <span class="entity">ths</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">imp_trans</span> <span class="main">(</span>List.hd <span class="entity">ths</span><span class="main">)</span> <span class="entity">th</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- (q ==&gt; false) ==&gt; p ==&gt; (p ==&gt; q) ==&gt; false                            *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_truefalse</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
  <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">imp_trans_th</span> <span class="entity">p</span> <span class="entity">q</span> Falsity<span class="main">)</span> <span class="main">(</span><span class="entity">imp_swap_th</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span> Falsity<span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*  |- (p' ==&gt; p) ==&gt; (q ==&gt; q') ==&gt; (p ==&gt; q) ==&gt; (p' ==&gt; q')               *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_mono_th</span> <span class="entity">p</span> <span class="entity">p'</span> <span class="entity">q</span> <span class="entity">q'</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">imp_trans_th</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p'</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p'</span><span class="main">,</span><span class="entity">q'</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">imp_trans_th</span> <span class="entity">p'</span> <span class="entity">q</span> <span class="entity">q'</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th3</span> <span class="main">=</span> <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans_th</span> <span class="entity">p'</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="entity">th3</span> <span class="main">(</span><span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th2</span> <span class="entity">th1</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- true                                                                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">truth</span> <span class="main">=</span> modusponens <span class="main">(</span><span class="entity">iff_imp2</span> axiom_true<span class="main">)</span> <span class="main">(</span><span class="entity">imp_refl</span> Falsity<span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         |- p ==&gt; q                                                        *)</span>
<span class="comment1">(*      ----------------- contrapos                                          *)</span>
<span class="comment1">(*         |- ~q ==&gt; ~p                                                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">contrapos</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">iff_imp1</span><span class="main">(</span>axiom_not <span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">imp_add_concl</span> Falsity <span class="entity">th</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span><span class="entity">iff_imp2</span><span class="main">(</span>axiom_not <span class="entity">p</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- p /\ q ==&gt; p                                                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">and_left</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">imp_add_assum</span> <span class="entity">p</span> <span class="main">(</span>axiom_addimp Falsity <span class="entity">q</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">right_doubleneg</span><span class="main">(</span><span class="entity">imp_add_concl</span> Falsity <span class="entity">th1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">iff_imp1</span><span class="main">(</span>axiom_and <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="entity">th2</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- p /\ q ==&gt; q                                                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">and_right</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> axiom_addimp <span class="main">(</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span> <span class="entity">p</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">right_doubleneg</span><span class="main">(</span><span class="entity">imp_add_concl</span> Falsity <span class="entity">th1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">iff_imp1</span><span class="main">(</span>axiom_and <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="entity">th2</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- p1 /\ ... /\ pn ==&gt; pi for each 1 &lt;= i &lt;= n (input term right assoc)   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">conjths</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_and</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="entity">and_left</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span>::List.map <span class="main">(</span><span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">and_right</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">conjths</span> <span class="entity">q</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">imp_refl</span> <span class="entity">fm</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- p ==&gt; q ==&gt; p /\ q                                                     *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">and_pair</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">iff_imp2</span><span class="main">(</span>axiom_and <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">imp_swap_th</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">q</span> Falsity
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th3</span> <span class="main">=</span> <span class="entity">imp_add_assum</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">imp_trans2</span> <span class="entity">th2</span> <span class="entity">th1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="entity">th3</span> <span class="main">(</span><span class="entity">imp_swap</span> <span class="main">(</span><span class="entity">imp_refl</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* If |- p /\ q ==&gt; r then |- p ==&gt; q ==&gt; r                                  *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">shunt</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_and</span><span class="main">(</span><span class="entity">antecedent</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span><span class="entity">itlist</span> <span class="entity">imp_add_assum</span> <span class="main">[</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">]</span> <span class="entity">th</span><span class="main">)</span> <span class="main">(</span><span class="entity">and_pair</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* If |- p ==&gt; q ==&gt; r then |- p /\ q ==&gt; r                                  *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unshunt</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">qr</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span> <span class="entity">qr</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans_chain</span> <span class="main">[</span><span class="entity">and_left</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">,</span> <span class="entity">and_right</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">]</span> <span class="entity">th</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Produce |- (p &lt;=&gt; q) &lt;=&gt; (p ==&gt; q) /\ (q ==&gt; p)                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iff_def</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span> <span class="comment1">(* Not in the book *)</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">and_pair</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">imp_trans_chain</span> <span class="main">[</span>axiom_iffimp1 <span class="entity">p</span> <span class="entity">q</span><span class="main">,</span> axiom_iffimp2 <span class="entity">p</span> <span class="entity">q</span><span class="main">]</span> <span class="entity">th1</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_antisym</span> <span class="entity">th2</span> <span class="main">(</span><span class="entity">unshunt</span> <span class="main">(</span>axiom_impiff <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iff_def</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">and_pair</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thl</span> <span class="main">=</span> <span class="main">[</span>axiom_iffimp1 <span class="entity">p</span> <span class="entity">q</span><span class="main">,</span> axiom_iffimp2 <span class="entity">p</span> <span class="entity">q</span><span class="main">]</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_antisym</span> <span class="main">(</span><span class="entity">imp_trans_chain</span> <span class="entity">thl</span> <span class="entity">th</span><span class="main">)</span> <span class="main">(</span><span class="entity">unshunt</span> <span class="main">(</span>axiom_impiff <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Produce "expansion" theorem for defined connectives.                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">expand_connective</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Truth <span class="main">=&gt;</span> axiom_true
  <span class="main">|</span> Not <span class="entity">p</span> <span class="main">=&gt;</span> axiom_not <span class="entity">p</span>
  <span class="main">|</span> And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> axiom_and <span class="entity">p</span> <span class="entity">q</span>
  <span class="main">|</span> Or<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> axiom_or <span class="entity">p</span> <span class="entity">q</span>
  <span class="main">|</span> Iff<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">iff_def</span> <span class="entity">p</span> <span class="entity">q</span>
  <span class="main">|</span> Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> axiom_exists <span class="entity">x</span> <span class="entity">p</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"expand_connective"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eliminate_connective</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> not<span class="main">(</span><span class="entity">negativef</span> <span class="entity">fm</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">iff_imp1</span><span class="main">(</span><span class="entity">expand_connective</span> <span class="entity">fm</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">imp_add_concl</span> Falsity <span class="main">(</span><span class="entity">iff_imp2</span><span class="main">(</span><span class="entity">expand_connective</span><span class="main">(</span><span class="entity">negatef</span> <span class="entity">fm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                                                                           *)</span>
<span class="comment1">(*   ------------------------------------------------- imp_false_conseqs     *)</span>
<span class="comment1">(*      [|- ((p ==&gt; q) ==&gt; false) ==&gt; (q ==&gt; false);                         *)</span>
<span class="comment1">(*       |- ((p ==&gt; q) ==&gt; false) ==&gt; p]                                     *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_false_conseqs</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
 <span class="main">[</span><span class="entity">right_doubleneg</span><span class="main">(</span><span class="entity">imp_add_concl</span> Falsity <span class="main">(</span><span class="entity">imp_add_assum</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">ex_falso</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="entity">imp_add_concl</span> Falsity <span class="main">(</span><span class="entity">imp_insert</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">imp_refl</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         |- p ==&gt; (q ==&gt; false) ==&gt; r                                      *)</span>
<span class="comment1">(*        ------------------------------------ imp_false_rule                *)</span>
<span class="comment1">(*             |- ((p ==&gt; q) ==&gt; false) ==&gt; r                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_false_rule</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span> <span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans_chain</span> <span class="main">(</span><span class="entity">imp_false_conseqs</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">funpow</span> <span class="inner_numeral">2</span> <span class="entity">antecedent</span> <span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         |- (p ==&gt; false) ==&gt; r          |- q ==&gt; r                        *)</span>
<span class="comment1">(*       ---------------------------------------------- imp_true_rule        *)</span>
<span class="comment1">(*                      |- (p ==&gt; q) ==&gt; r                                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_true_rule</span> <span class="entity">th1</span> <span class="entity">th2</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">funpow</span> <span class="inner_numeral">2</span> <span class="entity">antecedent</span> <span class="main">(</span>concl <span class="entity">th1</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">q</span> <span class="main">=</span> <span class="entity">antecedent</span><span class="main">(</span>concl <span class="entity">th2</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th3</span> <span class="main">=</span> <span class="entity">right_doubleneg</span><span class="main">(</span><span class="entity">imp_add_concl</span> Falsity <span class="entity">th1</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th4</span> <span class="main">=</span> <span class="entity">imp_add_concl</span> Falsity <span class="entity">th2</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th5</span> <span class="main">=</span> <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_truefalse</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th6</span> <span class="main">=</span> <span class="entity">imp_add_concl</span> Falsity <span class="main">(</span><span class="entity">imp_trans_chain</span> <span class="main">[</span><span class="entity">th3</span><span class="main">,</span> <span class="entity">th4</span><span class="main">]</span> <span class="entity">th5</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th7</span> <span class="main">=</span> <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_refl</span><span class="main">(</span>Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">right_doubleneg</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th7</span> <span class="entity">th6</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                                 *                                         *)</span>
<span class="comment1">(*                 -------------------------------------- imp_contr          *)</span>
<span class="comment1">(*                        |- p ==&gt; -p ==&gt; q                                  *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_contr</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">negativef</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">imp_add_assum</span> <span class="main">(</span><span class="entity">negatef</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">ex_falso</span> <span class="entity">q</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">imp_swap</span> <span class="main">(</span><span class="entity">imp_add_assum</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">ex_falso</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                                                                           *)</span>
<span class="comment1">(* --------------------------------------------- imp_front (this antecedent) *)</span>
<span class="comment1">(*  |- (p0 ==&gt; p1 ==&gt; ... ==&gt; pn ==&gt; q)                                      *)</span>
<span class="comment1">(*     ==&gt; pn ==&gt; p0 ==&gt; p1 ==&gt; .. p(n-1) ==&gt; q                              *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_front_th</span> <span class="entity">n</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">imp_refl</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">qr</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span> <span class="entity">fm</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">imp_add_assum</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">imp_front_th</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">qr</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">q'</span><span class="main">,</span><span class="entity">r'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span><span class="entity">funpow</span> <span class="inner_numeral">2</span> <span class="entity">consequent</span><span class="main">(</span>concl <span class="entity">th1</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="entity">th1</span> <span class="main">(</span><span class="entity">imp_swap_th</span> <span class="entity">p</span> <span class="entity">q'</span> <span class="entity">r'</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*           |- p0 ==&gt; p1 ==&gt; ... ==&gt; pn ==&gt; q                               *)</span>
<span class="comment1">(*         ------------------------------------------ imp_front n            *)</span>
<span class="comment1">(*           |- pn ==&gt; p0 ==&gt; p1 ==&gt; .. p(n-1) ==&gt; q                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_front</span> <span class="entity">n</span> <span class="entity">th</span> <span class="main">=</span> modusponens <span class="main">(</span><span class="entity">imp_front_th</span> <span class="entity">n</span> <span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Propositional tableaux procedure.                                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_false</span> Falsity <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_false</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_true</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">p</span> <span class="main">=</span> <span class="entity">q</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">is_true</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_conj</span> <span class="main">(</span>Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_conj</span> <span class="main">_</span> <span class="main">=</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_conj</span> <span class="entity">fm</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span>Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_conj"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_disj</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">q</span> &lt;&gt; Falsity<span class="main">)</span>
  <span class="main">|</span> <span class="entity">is_disj</span> <span class="main">_</span> <span class="main">=</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_disj</span> <span class="entity">fm</span> <span class="main">=</span> <span class="entity">dest_imp</span> <span class="entity">fm</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_prop_lit</span> <span class="entity">p</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">of</span></span>
     Atom<span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true
   <span class="main">|</span> Forall<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true
   <span class="main">|</span> Imp<span class="main">(</span>Atom<span class="main">(</span><span class="main">_</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span> <span class="main">=&gt;</span> true
   <span class="main">|</span> Imp<span class="main">(</span>Forall<span class="main">(</span><span class="main">_</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span> <span class="main">=&gt;</span> true
   <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false <span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lcfptab</span> <span class="entity">fms</span> <span class="entity">lits</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fms</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">[</span><span class="main">]</span>     <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"lcfptab: no contradiction"</span>
    <span class="main">|</span> <span class="entity">fm</span>::<span class="entity">fl</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="entity">ex_falso</span> <span class="main">(</span><span class="entity">itlist</span> <span class="entity">mk_imp</span> <span class="main">(</span><span class="entity">fl</span> @ <span class="entity">lits</span><span class="main">)</span> Falsity<span class="main">)</span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_true</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="entity">add_assum</span> <span class="entity">fm</span> <span class="main">(</span><span class="entity">lcfptab</span> <span class="entity">fl</span> <span class="entity">lits</span><span class="main">)</span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_conj</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">=</span><span class="entity">dest_conj</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">imp_false_rule</span><span class="main">(</span><span class="entity">lcfptab</span> <span class="main">(</span><span class="entity">p</span>::Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span>Falsity<span class="main">)</span>::<span class="entity">fl</span><span class="main">)</span> <span class="entity">lits</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_disj</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">=</span><span class="entity">dest_disj</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">imp_true_rule</span> <span class="main">(</span><span class="entity">lcfptab</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Falsity<span class="main">)</span>::<span class="entity">fl</span><span class="main">)</span> <span class="entity">lits</span><span class="main">)</span> <span class="main">(</span><span class="entity">lcfptab</span> <span class="main">(</span><span class="entity">q</span>::<span class="entity">fl</span><span class="main">)</span> <span class="entity">lits</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_prop_lit</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mem</span> <span class="main">(</span><span class="entity">negatef</span> <span class="entity">fm</span><span class="main">)</span> <span class="entity">lits</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">chop_list</span> <span class="main">(</span><span class="entity">index</span> <span class="main">(</span><span class="entity">negatef</span> <span class="entity">fm</span><span class="main">)</span> <span class="entity">lits</span><span class="main">)</span> <span class="entity">lits</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">imp_contr</span> <span class="entity">fm</span> <span class="main">(</span><span class="entity">itlist</span> <span class="entity">mk_imp</span> <span class="main">(</span>List.tl <span class="entity">l2</span><span class="main">)</span> Falsity <span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
              <span class="entity">itlist</span> <span class="entity">imp_insert</span> <span class="main">(</span><span class="entity">fl</span> @ <span class="entity">l1</span><span class="main">)</span> <span class="entity">th</span>
              <span class="keyword2"><span class="keyword">end</span></span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">imp_front</span> <span class="main">(</span>List.length <span class="entity">fl</span><span class="main">)</span> <span class="main">(</span><span class="entity">lcfptab</span> <span class="entity">fl</span> <span class="main">(</span><span class="entity">fm</span>::<span class="entity">lits</span><span class="main">)</span><span class="main">)</span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span> <span class="comment1">(* is nonprimitive *)</span>
           <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">eliminate_connective</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">in</span></span>
           <span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span><span class="entity">lcfptab</span> <span class="main">(</span><span class="entity">consequent</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span>::<span class="entity">fl</span><span class="main">)</span> <span class="entity">lits</span><span class="main">)</span>
           <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span>
<span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* In particular, this gives a tautology prover.                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lcftaut</span> <span class="entity">p</span> <span class="main">=</span>
  modusponens <span class="main">(</span>axiom_doubleneg <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">lcfptab</span> <span class="main">[</span><span class="entity">negatef</span> <span class="entity">p</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"folderived.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* First-order derived rules in the LCF setup.                               *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                         ******                                            *)</span>
<span class="comment1">(*         ------------------------------------------ eq_sym                 *)</span>
<span class="comment1">(*                      |- s = t ==&gt; t = s                                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eq_sym</span> <span class="entity">s</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rth</span> <span class="main">=</span> axiom_eqrefl <span class="entity">s</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">funpow</span> <span class="inner_numeral">2</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">th</span> <span class="main">=&gt;</span> <span class="main">(</span>modusponens <span class="main">(</span><span class="entity">imp_swap</span> <span class="entity">th</span><span class="main">)</span> <span class="entity">rth</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>axiom_predcong <span class="inner_quoted">"="</span> <span class="main">[</span><span class="entity">s</span><span class="main">,</span> <span class="entity">s</span><span class="main">]</span> <span class="main">[</span><span class="entity">t</span><span class="main">,</span> <span class="entity">s</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- s = t ==&gt; t = u ==&gt; s = u.                                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eq_trans</span> <span class="entity">s</span> <span class="entity">t</span> <span class="entity">u</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> axiom_predcong <span class="inner_quoted">"="</span> <span class="main">[</span><span class="entity">t</span><span class="main">,</span> <span class="entity">u</span><span class="main">]</span> <span class="main">[</span><span class="entity">s</span><span class="main">,</span> <span class="entity">u</span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> modusponens <span class="main">(</span><span class="entity">imp_swap</span> <span class="entity">th1</span><span class="main">)</span> <span class="main">(</span>axiom_eqrefl <span class="entity">u</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">eq_sym</span> <span class="entity">s</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">th2</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         ---------------------------- icongruence                          *)</span>
<span class="comment1">(*          |- s = t ==&gt; tm[s] = tm[t]                                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">icongruence</span> <span class="entity">s</span> <span class="entity">t</span> <span class="entity">stm</span> <span class="entity">ttm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">stm</span> <span class="main">=</span> <span class="entity">ttm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">add_assum</span> <span class="main">(</span><span class="entity">mk_eq</span> <span class="entity">s</span> <span class="entity">t</span><span class="main">)</span> <span class="main">(</span>axiom_eqrefl <span class="entity">stm</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">stm</span> <span class="main">=</span> <span class="entity">s</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">ttm</span> <span class="main">=</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">imp_refl</span> <span class="main">(</span><span class="entity">mk_eq</span> <span class="entity">s</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">stm</span><span class="main">,</span><span class="entity">ttm</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
   <span class="main">(</span>Fn<span class="main">(</span><span class="entity">fs</span><span class="main">,</span><span class="entity">sa</span><span class="main">)</span><span class="main">,</span>Fn<span class="main">(</span><span class="entity">ft</span><span class="main">,</span><span class="entity">ta</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">fs</span> <span class="main">=</span> <span class="entity">ft</span> <span class="keyword1"><span class="keyword">andalso</span></span> length <span class="entity">sa</span> <span class="main">=</span> length <span class="entity">ta</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ths</span> <span class="main">=</span> <span class="entity">map2</span> <span class="main">(</span><span class="entity">icongruence</span> <span class="entity">s</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">sa</span> <span class="entity">ta</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> List.map <span class="main">(</span><span class="entity">consequent</span> o concl<span class="main">)</span> <span class="entity">ths</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">imp_trans_chain</span> <span class="entity">ths</span> <span class="main">(</span>axiom_funcong <span class="entity">fs</span> <span class="main">(</span>List.map <span class="entity">lhs</span> <span class="entity">ts</span><span class="main">)</span> <span class="main">(</span>List.map <span class="entity">rhs</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"icongruence: not congruent"</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"icongruence: not congruent"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- (forall x. p ==&gt; q(x)) ==&gt; p ==&gt; (forall x. q(x))                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_right_th</span> <span class="entity">x</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
  <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="main">(</span>axiom_impall <span class="entity">x</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">imp_swap</span><span class="main">(</span>axiom_allimp <span class="entity">x</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                       |- p ==&gt; q                                          *)</span>
<span class="comment1">(*         ------------------------------------- genimp "x"                  *)</span>
<span class="comment1">(*           |- (forall x. p) ==&gt; (forall x. q)                              *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">genimp</span> <span class="entity">x</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span>axiom_allimp <span class="entity">x</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="main">(</span>gen <span class="entity">x</span> <span class="entity">th</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* If |- p ==&gt; q[x] then |- p ==&gt; forall x. q[x]                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_right</span> <span class="entity">x</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span><span class="entity">gen_right_th</span> <span class="entity">x</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="main">(</span>gen <span class="entity">x</span> <span class="entity">th</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* |- (forall x. p(x) ==&gt; q) ==&gt; (exists x. p(x)) ==&gt; q                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exists_left_th</span> <span class="entity">x</span> <span class="entity">p</span> <span class="entity">q</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span>  <span class="entity">p'</span> <span class="main">=</span> Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Falsity<span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span>  <span class="entity">q'</span> <span class="main">=</span> Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span>Falsity<span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">genimp</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans_th</span> <span class="entity">p</span> <span class="entity">q</span> Falsity<span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">imp_trans</span> <span class="entity">th1</span> <span class="main">(</span><span class="entity">gen_right_th</span> <span class="entity">x</span> <span class="entity">q'</span> <span class="entity">p'</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th3</span> <span class="main">=</span> <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans_th</span> <span class="entity">q'</span> <span class="main">(</span>Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p'</span><span class="main">)</span><span class="main">)</span> Falsity<span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th4</span> <span class="main">=</span> <span class="entity">imp_trans2</span> <span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th2</span> <span class="entity">th3</span><span class="main">)</span> <span class="main">(</span>axiom_doubleneg <span class="entity">q</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th5</span> <span class="main">=</span> <span class="entity">imp_add_concl</span> Falsity <span class="main">(</span><span class="entity">genimp</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">iff_imp2</span> <span class="main">(</span>axiom_not <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th6</span> <span class="main">=</span> <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">iff_imp1</span> <span class="main">(</span>axiom_not <span class="main">(</span>Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span>Not <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">th5</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th7</span> <span class="main">=</span> <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">iff_imp1</span><span class="main">(</span>axiom_exists <span class="entity">x</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="entity">th6</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th7</span> <span class="main">(</span><span class="entity">imp_swap</span> <span class="entity">th4</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* If |- p(x) ==&gt; q then |- (exists x. p(x)) ==&gt; q                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exists_left</span> <span class="entity">x</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span><span class="entity">exists_left_th</span> <span class="entity">x</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="main">(</span>gen <span class="entity">x</span> <span class="entity">th</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*    |- x = t ==&gt; p ==&gt; q    [x not in t and not free in q]                 *)</span>
<span class="comment1">(*  --------------------------------------------------------------- subspec  *)</span>
<span class="comment1">(*                 |- (forall x. p) ==&gt; q                                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subspec</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> concl <span class="entity">th</span> <span class="keyword2"><span class="keyword">of</span></span>
    Imp<span class="main">(</span><span class="entity">e</span> <span class="keyword1"><span class="keyword">as</span></span> Atom<span class="main">(</span>Rl<span class="main">(</span><span class="inner_quoted">"="</span><span class="main">,</span><span class="main">[</span>Var <span class="entity">x</span><span class="main">,</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">genimp</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">imp_swap</span> <span class="entity">th</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">(</span><span class="entity">exists_left_th</span> <span class="entity">x</span> <span class="entity">e</span> <span class="entity">q</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        modusponens <span class="main">(</span><span class="entity">imp_swap</span> <span class="entity">th1</span><span class="main">)</span> <span class="main">(</span>axiom_existseq <span class="entity">x</span> <span class="entity">t</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"subspec: wrong sort of theorem"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*    |- x = y ==&gt; p[x] ==&gt; q[y]  [x not in FV(q); y not in FV(p) or x == y] *)</span>
<span class="comment1">(*  --------------------------------------------------------- subalpha       *)</span>
<span class="comment1">(*                 |- (forall x. p) ==&gt; (forall y. q)                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subalpha</span> <span class="entity">th</span> <span class="main">=</span>
   <span class="keyword2"><span class="keyword">case</span></span> concl <span class="entity">th</span> <span class="keyword2"><span class="keyword">of</span></span>
    Imp<span class="main">(</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="inner_quoted">"="</span><span class="main">,</span><span class="main">[</span>Var <span class="entity">x</span><span class="main">,</span>Var <span class="entity">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">genimp</span> <span class="entity">x</span> <span class="main">(</span>modusponens <span class="entity">th</span> <span class="main">(</span>axiom_eqrefl<span class="main">(</span>Var <span class="entity">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">gen_right</span> <span class="entity">y</span> <span class="main">(</span><span class="entity">subspec</span> <span class="entity">th</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"subalpha: wrong sort of theorem"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         ---------------------------------- isubst                         *)</span>
<span class="comment1">(*            |- s = t ==&gt; p[s] ==&gt; p[t]                                     *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">isubst</span> <span class="entity">s</span> <span class="entity">t</span> <span class="entity">sfm</span> <span class="entity">tfm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">sfm</span> <span class="main">=</span> <span class="entity">tfm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">add_assum</span> <span class="main">(</span><span class="entity">mk_eq</span> <span class="entity">s</span> <span class="entity">t</span><span class="main">)</span> <span class="main">(</span><span class="entity">imp_refl</span> <span class="entity">tfm</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">sfm</span><span class="main">,</span><span class="entity">tfm</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">sa</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p'</span><span class="main">,</span><span class="entity">ta</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">p'</span> <span class="keyword1"><span class="keyword">andalso</span></span> List.length <span class="entity">sa</span> <span class="main">=</span> List.length <span class="entity">ta</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ths</span> <span class="main">=</span> <span class="entity">map2</span> <span class="main">(</span><span class="entity">icongruence</span> <span class="entity">s</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">sa</span> <span class="entity">ta</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ls</span><span class="main">,</span><span class="entity">rs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">unzip</span> <span class="main">(</span>List.map <span class="main">(</span><span class="entity">dest_eq</span> o <span class="entity">consequent</span> o concl<span class="main">)</span> <span class="entity">ths</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">imp_trans_chain</span> <span class="entity">ths</span> <span class="main">(</span>axiom_predcong <span class="entity">p</span> <span class="entity">ls</span> <span class="entity">rs</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span>
            <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"isubst"</span>
  <span class="main">|</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">sp</span><span class="main">,</span><span class="entity">sq</span><span class="main">)</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">tp</span><span class="main">,</span><span class="entity">tq</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">eq_sym</span> <span class="entity">s</span> <span class="entity">t</span><span class="main">)</span> <span class="main">(</span><span class="entity">isubst</span> <span class="entity">t</span> <span class="entity">s</span> <span class="entity">tp</span> <span class="entity">sp</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">isubst</span> <span class="entity">s</span> <span class="entity">t</span> <span class="entity">sq</span> <span class="entity">tq</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">imp_trans_chain</span> <span class="main">[</span><span class="entity">th1</span><span class="main">,</span> <span class="entity">th2</span><span class="main">]</span> <span class="main">(</span><span class="entity">imp_mono_th</span> <span class="entity">sp</span> <span class="entity">tp</span> <span class="entity">sq</span> <span class="entity">tq</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="main">(</span>Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">,</span>Forall<span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">gen_right</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">isubst</span> <span class="entity">s</span> <span class="entity">t</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>axiom_allimp <span class="entity">x</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">z</span> <span class="main">=</span> Var<span class="main">(</span><span class="entity">variant</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">unions_str</span> <span class="main">[</span><span class="entity">fv</span> <span class="entity">p</span><span class="main">,</span> <span class="entity">fv</span> <span class="entity">q</span><span class="main">,</span> <span class="entity">fvt</span> <span class="entity">s</span><span class="main">,</span> <span class="entity">fvt</span> <span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">isubst</span> <span class="main">(</span>Var <span class="entity">x</span><span class="main">)</span> <span class="entity">z</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">subst</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|==&gt;</span> <span class="entity">z</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">isubst</span> <span class="entity">z</span> <span class="main">(</span>Var <span class="entity">y</span><span class="main">)</span> <span class="main">(</span><span class="entity">subst</span> <span class="main">(</span><span class="entity">y</span> <span class="entity">|==&gt;</span> <span class="entity">z</span><span class="main">)</span> <span class="entity">q</span><span class="main">)</span> <span class="entity">q</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th3</span> <span class="main">=</span> <span class="entity">subalpha</span> <span class="entity">th1</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th4</span> <span class="main">=</span> <span class="entity">subalpha</span> <span class="entity">th2</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th5</span> <span class="main">=</span> <span class="entity">isubst</span> <span class="entity">s</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">consequent</span><span class="main">(</span>concl <span class="entity">th3</span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span><span class="entity">antecedent</span><span class="main">(</span>concl <span class="entity">th4</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">imp_swap</span> <span class="main">(</span><span class="entity">imp_trans2</span> <span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th3</span> <span class="main">(</span><span class="entity">imp_swap</span> <span class="entity">th5</span><span class="main">)</span><span class="main">)</span> <span class="entity">th4</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sth</span> <span class="main">=</span> <span class="entity">iff_imp1</span><span class="main">(</span><span class="entity">expand_connective</span> <span class="entity">sfm</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tth</span> <span class="main">=</span> <span class="entity">iff_imp2</span><span class="main">(</span><span class="entity">expand_connective</span> <span class="entity">tfm</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">isubst</span> <span class="entity">s</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">consequent</span><span class="main">(</span>concl <span class="entity">sth</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span><span class="entity">antecedent</span><span class="main">(</span>concl <span class="entity">tth</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">sth</span> <span class="main">(</span><span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans2</span> <span class="entity">th1</span> <span class="entity">tth</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                                                                           *)</span>
<span class="comment1">(* -------------------------------------------- alpha "z" &lt;!forall x. p[x]!&gt; *)</span>
<span class="comment1">(*   |- (forall x. p[x]) ==&gt; (forall z. p'[z])                               *)</span>
<span class="comment1">(*                                                                           *)</span>
<span class="comment1">(* [Restriction that z is not free in the initial p[x].]                     *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">alpha</span> <span class="entity">z</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p'</span> <span class="main">=</span> <span class="entity">subst</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|==&gt;</span> Var <span class="entity">z</span><span class="main">)</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">in</span></span>
                   <span class="entity">subalpha</span><span class="main">(</span><span class="entity">isubst</span> <span class="main">(</span>Var <span class="entity">x</span><span class="main">)</span> <span class="main">(</span>Var <span class="entity">z</span><span class="main">)</span> <span class="entity">p</span> <span class="entity">p'</span><span class="main">)</span>
                   <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"alpha: not a universal formula"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*                                                                           *)</span>
<span class="comment1">(* -------------------------------- ispec t &lt;!forall x. p[x]!&gt;               *)</span>
<span class="comment1">(*   |- (forall x. p[x]) ==&gt; p'[t]                                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ispec</span> <span class="entity">t</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mem</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">fvt</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">alpha</span> <span class="main">(</span><span class="entity">variant</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">union_str</span> <span class="main">(</span><span class="entity">fvt</span> <span class="entity">t</span><span class="main">)</span> <span class="main">(</span><span class="entity">var</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span><span class="entity">ispec</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">consequent</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">subspec</span><span class="main">(</span><span class="entity">isubst</span> <span class="main">(</span>Var <span class="entity">x</span><span class="main">)</span> <span class="entity">t</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">subst</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|==&gt;</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"ispec: non-universal formula"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Specialization rule.                                                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">spec</span> <span class="entity">t</span> <span class="entity">th</span> <span class="main">=</span> modusponens <span class="main">(</span><span class="entity">ispec</span> <span class="entity">t</span> <span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"lcffol.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* First order tableau procedure using LCF setup.                            *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Unification of complementary literals.                                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unify_complementsf</span> <span class="entity">env</span> <span class="main">=</span>
  <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">a1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>Imp<span class="main">(</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">unify</span> <span class="entity">env</span> <span class="main">[</span><span class="main">(</span>Fn<span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">a1</span><span class="main">)</span><span class="main">,</span>Fn<span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
   <span class="main">|</span> <span class="main">(</span>Imp<span class="main">(</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">a1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">,</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">unify</span> <span class="entity">env</span> <span class="main">[</span><span class="main">(</span>Fn<span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">a1</span><span class="main">)</span><span class="main">,</span>Fn<span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">a2</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
   <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"unify_complementsf"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*    |- (q ==&gt; f) ==&gt; ... ==&gt; (q ==&gt; p) ==&gt; r                               *)</span>
<span class="comment1">(* --------------------------------------------- use_laterimp &lt;!q ==&gt; p!&gt;    *)</span>
<span class="comment1">(*    |- (p ==&gt; f) ==&gt; ... ==&gt; (q ==&gt; p) ==&gt; r                               *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">use_laterimp</span> <span class="entity">i</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Imp<span class="main">(</span><span class="main">_</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">i'</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">fm</span><span class="main">,</span><span class="entity">i'</span><span class="main">=</span><span class="entity">i</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">(</span>Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">q'</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">i'</span> <span class="keyword1"><span class="keyword">as</span></span> Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>true<span class="main">)</span> <span class="main">=&gt;</span>
             <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> axiom_distribimp <span class="entity">i</span> <span class="main">(</span>Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans_th</span> <span class="entity">q</span> <span class="entity">p</span> <span class="entity">s</span><span class="main">)</span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th3</span> <span class="main">=</span> <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_trans_th</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
             <span class="entity">imp_swap2</span><span class="main">(</span>modusponens <span class="entity">th1</span> <span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th2</span> <span class="entity">th3</span><span class="main">)</span><span class="main">)</span>
             <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">qs</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
             <span class="entity">imp_swap2</span><span class="main">(</span><span class="entity">imp_add_assum</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">use_laterimp</span> <span class="entity">i</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">qs</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>
<span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* The "closure" inference rules.                                            *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_false_rule'</span> <span class="entity">th</span> <span class="entity">es</span> <span class="main">=</span> <span class="entity">imp_false_rule</span><span class="main">(</span><span class="entity">th</span> <span class="entity">es</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_true_rule'</span> <span class="entity">th1</span> <span class="entity">th2</span> <span class="entity">es</span> <span class="main">=</span> <span class="entity">imp_true_rule</span> <span class="main">(</span><span class="entity">th1</span> <span class="entity">es</span><span class="main">)</span> <span class="main">(</span><span class="entity">th2</span> <span class="entity">es</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_front'</span> <span class="entity">n</span> <span class="entity">thp</span> <span class="entity">es</span> <span class="main">=</span> <span class="entity">imp_front</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">thp</span> <span class="entity">es</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_assum'</span> <span class="entity">fm</span> <span class="entity">thp</span> <span class="main">(</span><span class="entity">es</span> <span class="keyword1"><span class="keyword">as</span></span><span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">add_assum</span> <span class="main">(</span><span class="entity">onformula</span> <span class="entity">e</span> <span class="entity">fm</span><span class="main">)</span> <span class="main">(</span><span class="entity">thp</span> <span class="entity">es</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eliminate_connective'</span> <span class="entity">fm</span> <span class="entity">thp</span> <span class="main">(</span><span class="entity">es</span> <span class="keyword1"><span class="keyword">as</span></span><span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">eliminate_connective</span> <span class="main">(</span><span class="entity">onformula</span> <span class="entity">e</span> <span class="entity">fm</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">thp</span> <span class="entity">es</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">spec'</span> <span class="entity">y</span> <span class="entity">fm</span> <span class="entity">n</span> <span class="entity">thp</span> <span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">imp_front</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">thp</span><span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_unduplicate</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">ispec</span> <span class="main">(</span><span class="entity">e</span> <span class="entity">y</span><span class="main">)</span> <span class="main">(</span><span class="entity">onformula</span> <span class="entity">e</span> <span class="entity">fm</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ex_falso'</span> <span class="entity">fms</span> <span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">ex_falso</span> <span class="main">(</span><span class="entity">itlist</span> <span class="main">(</span><span class="entity">mk_imp</span> o <span class="entity">onformula</span> <span class="entity">e</span><span class="main">)</span> <span class="entity">fms</span> <span class="entity">s</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">complits'</span> <span class="main">(</span><span class="entity">p</span>::<span class="entity">fl</span><span class="main">,</span><span class="entity">lits</span><span class="main">)</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">p'</span>::<span class="entity">l2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">chop_list</span> <span class="entity">i</span> <span class="entity">lits</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">itlist</span> <span class="main">(</span><span class="entity">imp_insert</span> o <span class="entity">onformula</span> <span class="entity">e</span><span class="main">)</span> <span class="main">(</span><span class="entity">fl</span> @ <span class="entity">l1</span><span class="main">)</span>
         <span class="main">(</span><span class="entity">imp_contr</span> <span class="main">(</span><span class="entity">onformula</span> <span class="entity">e</span> <span class="entity">p</span><span class="main">)</span>
                    <span class="main">(</span><span class="entity">itlist</span> <span class="main">(</span><span class="entity">mk_imp</span> o <span class="entity">onformula</span> <span class="entity">e</span><span class="main">)</span> <span class="entity">l2</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">deskol'</span> <span class="main">(</span><span class="entity">skh</span><span class="main">:</span>fol fm<span class="main">)</span> <span class="entity">thp</span> <span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">thp</span> <span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  modusponens <span class="main">(</span><span class="entity">use_laterimp</span> <span class="main">(</span><span class="entity">onformula</span> <span class="entity">e</span> <span class="entity">skh</span><span class="main">)</span> <span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Main refutation function.                                                 *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_lit</span> <span class="main">(</span>Atom<span class="main">(</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_lit</span> <span class="main">(</span>Imp<span class="main">(</span>Atom<span class="main">(</span><span class="main">_</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_lit</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_uni</span> <span class="main">(</span>Forall<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_uni</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_uni</span> <span class="main">(</span>Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_exi</span> <span class="main">(</span>Imp<span class="main">(</span>Forall<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_exi</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_exi</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">yp</span> <span class="keyword1"><span class="keyword">as</span></span> Forall<span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">p</span><span class="main">,</span><span class="entity">yp</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span><span class="entity">fms</span><span class="main">,</span><span class="entity">lits</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span> <span class="entity">cont</span> <span class="main">(</span><span class="entity">esk</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span><span class="entity">sks</span><span class="main">,</span><span class="entity">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"lcftab: no proof"</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fms</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">[</span><span class="main">]</span>     <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"lcftab: No contradiction"</span>
    <span class="main">|</span> <span class="entity">fm</span>::<span class="entity">fl</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="entity">cont</span> <span class="main">(</span><span class="entity">ex_falso'</span> <span class="main">(</span><span class="entity">fl</span> @ <span class="entity">lits</span><span class="main">)</span><span class="main">)</span> <span class="entity">esk</span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_true</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span><span class="entity">fl</span><span class="main">,</span><span class="entity">lits</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">cont</span> o <span class="entity">add_assum'</span> <span class="entity">fm</span><span class="main">)</span> <span class="entity">esk</span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_conj</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">=</span><span class="entity">dest_conj</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span><span class="entity">p</span>::Imp<span class="main">(</span><span class="entity">q</span><span class="main">,</span>Falsity<span class="main">)</span>::<span class="entity">fl</span><span class="main">,</span><span class="entity">lits</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">cont</span> o <span class="entity">imp_false_rule'</span><span class="main">)</span> <span class="entity">esk</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_disj</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">=</span><span class="entity">dest_disj</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span>Falsity<span class="main">)</span>::<span class="entity">fl</span><span class="main">,</span><span class="entity">lits</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">th</span> <span class="main">=&gt;</span> <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span><span class="entity">q</span>::<span class="entity">fl</span><span class="main">,</span><span class="entity">lits</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span>
                                                                <span class="main">(</span><span class="entity">cont</span> o <span class="entity">imp_true_rule'</span> <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="entity">esk</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_lit</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="main">(</span><span class="entity">tryfind</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p'</span> <span class="main">=&gt;</span> <span class="main">(</span>
                <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">env'</span> <span class="main">=</span> <span class="entity">unify_complementsf</span> <span class="entity">env</span> <span class="main">(</span><span class="entity">fm</span><span class="main">,</span> <span class="entity">p'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
                <span class="entity">cont</span> <span class="main">(</span><span class="entity">complits'</span> <span class="main">(</span><span class="entity">fms</span><span class="main">,</span> <span class="entity">lits</span><span class="main">)</span> <span class="main">(</span><span class="entity">index</span> <span class="entity">p'</span> <span class="entity">lits</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">env'</span><span class="main">,</span> <span class="entity">sks</span><span class="main">,</span> <span class="entity">k</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span> <span class="entity">lits</span><span class="main">)</span>
            <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span>
                <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span><span class="entity">fl</span><span class="main">,</span><span class="entity">fm</span>::<span class="entity">lits</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">cont</span> o <span class="entity">imp_front'</span> <span class="main">(</span>List.length <span class="entity">fl</span><span class="main">)</span><span class="main">)</span> <span class="entity">esk</span>
            <span class="main">)</span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_uni</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_uni</span> <span class="entity">fm</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">y</span> <span class="main">=</span> Var<span class="main">(</span><span class="inner_quoted">"X_"</span>^<span class="main">(</span>Int.toString <span class="entity">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span><span class="main">(</span><span class="entity">subst</span> <span class="main">(</span><span class="entity">x</span> <span class="entity">|==&gt;</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span>::<span class="entity">fl</span>@<span class="main">[</span><span class="entity">fm</span><span class="main">]</span><span class="main">,</span><span class="entity">lits</span><span class="main">,</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span>
                    <span class="main">(</span><span class="entity">cont</span> o <span class="entity">spec'</span> <span class="entity">y</span> <span class="entity">fm</span> <span class="main">(</span>List.length <span class="entity">fms</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span><span class="entity">sks</span><span class="main">,</span><span class="entity">k</span>+<span class="inner_numeral">1</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_exi</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">p</span><span class="main">,</span><span class="entity">yp</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_exi</span> <span class="entity">fm</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fx</span> <span class="main">=</span> <span class="entity">skofun</span> <span class="entity">yp</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p'</span> <span class="main">=</span> <span class="entity">subst</span><span class="main">(</span><span class="entity">y</span> <span class="entity">|==&gt;</span> <span class="entity">fx</span><span class="main">)</span> <span class="entity">p</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">skh</span> <span class="main">=</span> Imp<span class="main">(</span><span class="entity">p'</span><span class="main">,</span>Forall<span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sks'</span> <span class="main">=</span> <span class="main">(</span>Forall<span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">,</span><span class="entity">fx</span><span class="main">)</span>::<span class="entity">sks</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p'</span><span class="main">,</span>Falsity<span class="main">)</span>::<span class="entity">fl</span><span class="main">,</span><span class="entity">lits</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">cont</span> o <span class="entity">deskol'</span> <span class="entity">skh</span><span class="main">)</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span><span class="entity">sks'</span><span class="main">,</span><span class="entity">k</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span> <span class="comment1">(* is nonprimitive *)</span>
           <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fm'</span> <span class="main">=</span> <span class="entity">consequent</span><span class="main">(</span>concl<span class="main">(</span><span class="entity">eliminate_connective</span> <span class="entity">fm</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
           <span class="entity">lcftab</span> <span class="entity">skofun</span> <span class="main">(</span><span class="entity">fm'</span>::<span class="entity">fl</span><span class="main">,</span><span class="entity">lits</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">cont</span> o <span class="entity">eliminate_connective'</span> <span class="entity">fm</span><span class="main">)</span> <span class="entity">esk</span>
           <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span>
<span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Identify quantified subformulas; true = exists, false = forall. This is   *)</span>
<span class="comment1">(* taking into account the effective parity.                                 *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">of</span></span>
    Not<span class="main">(</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">quantforms</span> <span class="main">(</span>not <span class="entity">e</span><span class="main">)</span> <span class="entity">p</span>
  <span class="main">|</span> And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">union_folfm</span> <span class="main">(</span><span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">q</span><span class="main">)</span>
  <span class="main">|</span> Or<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span>  <span class="main">=&gt;</span> <span class="entity">union_folfm</span> <span class="main">(</span><span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">q</span><span class="main">)</span>
  <span class="main">|</span> Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">quantforms</span> <span class="entity">e</span> <span class="main">(</span>Or<span class="main">(</span>Not <span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Iff<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">quantforms</span> <span class="entity">e</span> <span class="main">(</span>Or<span class="main">(</span>And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">,</span>And<span class="main">(</span>Not <span class="entity">p</span><span class="main">,</span>Not <span class="entity">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">e</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">fm</span>::<span class="main">(</span><span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">p</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">p</span>
  <span class="main">|</span> Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">e</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">fm</span>::<span class="main">(</span><span class="entity">quantforms</span> <span class="entity">e</span> <span class="entity">p</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Now create some Skolem functions.                                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">skolemfuns</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fns</span> <span class="main">=</span> List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">pr</span> <span class="main">=&gt;</span> <span class="entity">fst</span> <span class="entity">pr</span><span class="main">)</span> <span class="main">(</span><span class="entity">functions</span> <span class="entity">fm</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">skts</span> <span class="main">=</span> List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span>Not <span class="entity">p</span><span class="main">)</span> <span class="main">|</span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">p</span><span class="main">)</span>
                 <span class="main">(</span><span class="entity">quantforms</span> true <span class="entity">fm</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">skofun</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">ap</span> <span class="keyword1"><span class="keyword">as</span></span> Forall<span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">v</span> <span class="main">=&gt;</span> Var <span class="entity">v</span><span class="main">)</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">ap</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">(</span><span class="entity">ap</span><span class="main">,</span>Fn<span class="main">(</span><span class="entity">variant</span><span class="main">(</span><span class="inner_quoted">"f"</span>^<span class="inner_quoted">"_"</span>^Int.toString <span class="entity">i</span><span class="main">)</span> <span class="entity">fns</span><span class="main">,</span><span class="entity">vars</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">map2</span> <span class="entity">skofun</span> <span class="main">(</span><span class="inner_numeral">1</span><span class="entity">--</span>length <span class="entity">skts</span><span class="main">)</span> <span class="entity">skts</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Matching.                                                                 *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">form_match</span> <span class="main">(</span><span class="entity">fp</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">f1</span><span class="main">,</span><span class="entity">f2</span><span class="main">)</span><span class="main">)</span> <span class="entity">env</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fp</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span>Falsity<span class="main">,</span>Falsity<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">env</span>
  <span class="main">|</span> <span class="main">(</span>Truth<span class="main">,</span>Truth<span class="main">)</span>     <span class="main">=&gt;</span> <span class="entity">env</span>
  <span class="main">|</span> <span class="main">(</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">pa</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>Atom<span class="main">(</span>Rl<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">qa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">term_match</span> <span class="entity">env</span> <span class="main">[</span><span class="main">(</span>Fn<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">pa</span><span class="main">)</span><span class="main">,</span>Fn<span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">qa</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
  <span class="main">|</span> <span class="main">(</span>Not<span class="main">(</span><span class="entity">p1</span><span class="main">)</span><span class="main">,</span>Not<span class="main">(</span><span class="entity">p2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">form_match</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">p2</span><span class="main">)</span> <span class="entity">env</span>
  <span class="main">|</span> <span class="main">(</span>And<span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">q1</span><span class="main">)</span><span class="main">,</span>And<span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">q2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">form_match</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">p2</span><span class="main">)</span> <span class="main">(</span><span class="entity">form_match</span> <span class="main">(</span><span class="entity">q1</span><span class="main">,</span><span class="entity">q2</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Or<span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">q1</span><span class="main">)</span><span class="main">,</span>Or<span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">q2</span><span class="main">)</span><span class="main">)</span>   <span class="main">=&gt;</span> <span class="entity">form_match</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">p2</span><span class="main">)</span> <span class="main">(</span><span class="entity">form_match</span> <span class="main">(</span><span class="entity">q1</span><span class="main">,</span><span class="entity">q2</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Imp<span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">q1</span><span class="main">)</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">q2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">form_match</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">p2</span><span class="main">)</span> <span class="main">(</span><span class="entity">form_match</span> <span class="main">(</span><span class="entity">q1</span><span class="main">,</span><span class="entity">q2</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Iff<span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">q1</span><span class="main">)</span><span class="main">,</span>Iff<span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">q2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">form_match</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span><span class="entity">p2</span><span class="main">)</span> <span class="main">(</span><span class="entity">form_match</span> <span class="main">(</span><span class="entity">q1</span><span class="main">,</span><span class="entity">q2</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Forall<span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">p1</span><span class="main">)</span><span class="main">,</span>Forall<span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">p2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">x1</span><span class="main">=</span><span class="entity">x2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">z</span> <span class="main">=</span> <span class="entity">variant</span> <span class="entity">x1</span> <span class="main">(</span><span class="entity">union_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p1</span><span class="main">)</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p2</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst_fn</span> <span class="main">=</span> <span class="entity">subst</span> <span class="main">(</span><span class="entity">x1</span> <span class="entity">|==&gt;</span> Var <span class="entity">z</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">undefine_str</span> <span class="entity">z</span> <span class="main">(</span><span class="entity">form_match</span> <span class="main">(</span><span class="entity">inst_fn</span> <span class="entity">p1</span><span class="main">,</span><span class="entity">inst_fn</span> <span class="entity">p2</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"form_match"</span>
  <span class="main">|</span> <span class="main">(</span>Exists<span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">p1</span><span class="main">)</span><span class="main">,</span>Exists<span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">p2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">x1</span><span class="main">=</span><span class="entity">x2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">z</span> <span class="main">=</span> <span class="entity">variant</span> <span class="entity">x1</span> <span class="main">(</span><span class="entity">union_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p1</span><span class="main">)</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">p2</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst_fn</span> <span class="main">=</span> <span class="entity">subst</span> <span class="main">(</span><span class="entity">x1</span> <span class="entity">|==&gt;</span> Var <span class="entity">z</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">undefine_str</span> <span class="entity">z</span> <span class="main">(</span><span class="entity">form_match</span> <span class="main">(</span><span class="entity">inst_fn</span> <span class="entity">p1</span><span class="main">,</span><span class="entity">inst_fn</span> <span class="entity">p2</span><span class="main">)</span> <span class="entity">env</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"form_match"</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"form_match"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* With the current approach to picking Skolem functions.                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lcfrefute</span> <span class="entity">fm</span> <span class="entity">n</span> <span class="entity">cont</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sl</span> <span class="main">=</span> <span class="entity">skolemfuns</span> <span class="entity">fm</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_skolem</span> <span class="entity">fm</span> <span class="main">=</span>
           <span class="entity">tryfind</span><span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">tsubst</span><span class="main">(</span><span class="entity">form_match</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">fm</span><span class="main">)</span> <span class="entity">undefined</span><span class="main">)</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">sl</span>
  <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">lcftab</span> <span class="entity">find_skolem</span> <span class="main">(</span><span class="main">[</span><span class="entity">fm</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span> <span class="entity">cont</span> <span class="main">(</span><span class="entity">undefined</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_skol</span> <span class="main">(</span>Forall<span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">,</span><span class="entity">fx</span><span class="main">)</span> <span class="entity">q</span> <span class="main">=</span>
  Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">subst</span> <span class="main">(</span><span class="entity">y</span> <span class="entity">|==&gt;</span> <span class="entity">fx</span><span class="main">)</span> <span class="entity">p</span><span class="main">,</span>Forall<span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">simpcont</span> <span class="entity">thp</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span><span class="entity">sks</span><span class="main">,</span><span class="entity">k</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ifn</span> <span class="main">=</span> <span class="entity">tsubst</span><span class="main">(</span><span class="entity">solve</span> <span class="entity">env</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">thp</span><span class="main">(</span><span class="entity">ifn</span><span class="main">,</span><span class="entity">onformula</span> <span class="entity">ifn</span> <span class="main">(</span><span class="entity">itlist</span> <span class="entity">mk_skol</span> <span class="entity">sks</span> Falsity<span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(*         |- (p(v) ==&gt; forall x. p(x)) ==&gt; q                                *)</span>
<span class="comment1">(*       -------------------------------------- elim_skolemvar               *)</span>
<span class="comment1">(*                   |- q                                                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elim_skolemvar</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> concl <span class="entity">th</span> <span class="keyword2"><span class="keyword">of</span></span>
    Imp<span class="main">(</span>Imp<span class="main">(</span><span class="entity">pv</span><span class="main">,</span><span class="main">(</span><span class="entity">apx</span> <span class="keyword1"><span class="keyword">as</span></span> Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">px</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">[</span><span class="entity">th1</span><span class="main">,</span><span class="entity">th2</span><span class="main">]</span> <span class="main">=</span> List.map <span class="main">(</span><span class="entity">imp_trans</span><span class="main">(</span><span class="entity">imp_add_concl</span> Falsity <span class="entity">th</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">(</span><span class="entity">imp_false_conseqs</span> <span class="entity">pv</span> <span class="entity">apx</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">v</span> <span class="main">=</span> hd<span class="main">(</span><span class="entity">subtract_str</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">pv</span><span class="main">)</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">apx</span><span class="main">)</span> @ <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th3</span> <span class="main">=</span> <span class="entity">gen_right</span> <span class="entity">v</span> <span class="entity">th1</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th4</span> <span class="main">=</span> <span class="entity">imp_trans</span> <span class="entity">th3</span> <span class="main">(</span><span class="entity">alpha</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">consequent</span><span class="main">(</span>concl <span class="entity">th3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        modusponens <span class="main">(</span>axiom_doubleneg <span class="entity">q</span><span class="main">)</span> <span class="main">(</span><span class="entity">right_mp</span> <span class="entity">th2</span> <span class="entity">th4</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"elim_skolemvar"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Top continuation with careful sorting and variable replacement.           *)</span>
<span class="comment1">(* Also need to delete post-instantiation duplicates! This shows up more     *)</span>
<span class="comment1">(* often now that we have adequate sharing.                                  *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">deskolcont</span> <span class="entity">thp</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span><span class="entity">sks</span><span class="main">,</span><span class="entity">k</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ifn</span> <span class="main">=</span> <span class="entity">tsubst</span><span class="main">(</span><span class="entity">solve</span> <span class="entity">env</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">isk</span> <span class="main">=</span> <span class="entity">setify_ftp</span><span class="main">(</span>List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">onformula</span> <span class="entity">ifn</span> <span class="entity">p</span><span class="main">,</span><span class="entity">ifn</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="entity">sks</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ssk</span> <span class="main">=</span> <span class="entity">sort</span> <span class="main">(</span><span class="entity">decreasing</span> <span class="main">(</span><span class="entity">termsize</span> o <span class="entity">snd</span><span class="main">)</span><span class="main">)</span> <span class="entity">isk</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vs</span>  <span class="main">=</span> List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> Var<span class="main">(</span><span class="inner_quoted">"Y_"</span>^Int.toString <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="inner_numeral">1</span><span class="entity">--</span>List.length <span class="entity">ssk</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vfn</span> <span class="main">=</span> <span class="entity">replacet</span><span class="main">(</span><span class="entity">itlist2</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">v</span> <span class="main">=&gt;</span> <span class="entity">t</span> <span class="entity">|---&gt;</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">ssk</span> <span class="entity">vs</span> <span class="entity">undefined</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span>  <span class="main">=</span> <span class="entity">thp</span><span class="main">(</span><span class="entity">vfn</span> o <span class="entity">ifn</span><span class="main">,</span><span class="entity">onformula</span> <span class="entity">vfn</span> <span class="main">(</span><span class="entity">itlist</span> <span class="entity">mk_skol</span> <span class="entity">ssk</span> Falsity<span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">repeat</span> <span class="main">(</span><span class="entity">elim_skolemvar</span> o <span class="entity">imp_swap</span><span class="main">)</span> <span class="entity">th</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Overall first-order prover.                                               *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lcffol</span> <span class="entity">fm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fvs</span> <span class="main">=</span> <span class="entity">fv</span> <span class="entity">fm</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fm'</span> <span class="main">=</span> Imp<span class="main">(</span><span class="entity">itlist</span> <span class="entity">mk_forall</span> <span class="entity">fvs</span> <span class="entity">fm</span><span class="main">,</span>Falsity<span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">deepen</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">lcfrefute</span> <span class="entity">fm'</span> <span class="entity">n</span> <span class="entity">deskolcont</span><span class="main">)</span> <span class="inner_numeral">0</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th2</span> <span class="main">=</span> modusponens <span class="main">(</span>axiom_doubleneg <span class="main">(</span><span class="entity">negatef</span> <span class="entity">fm'</span><span class="main">)</span><span class="main">)</span> <span class="entity">th1</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">itlist</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">v</span> <span class="main">=&gt;</span> <span class="entity">spec</span><span class="main">(</span>Var <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="entity">fvs</span><span class="main">)</span> <span class="entity">th2</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="inner_quoted">"tactics.sml"</span><span class="main">;</span>

<span class="comment1">(* ========================================================================= *)</span>
<span class="comment1">(* Goals, LCF-like tactics and Mizar-like proofs.                            *)</span>
<span class="comment1">(* ========================================================================= *)</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">goals</span> <span class="main">=</span>
  <span class="entity">Goals</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="main">(</span>string * fol fm<span class="main">)</span> list * fol fm<span class="main">)</span>list *
           <span class="main">(</span>thm list <span class="main">-&gt;</span> thm<span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Printer for goals (just shows first goal plus total number).              *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print_goal_aux</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_hyp</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">fm</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="entity">open_hbox</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
        <span class="entity">print_string</span> <span class="main">(</span><span class="entity">l</span>^<span class="inner_quoted">":"</span><span class="main">)</span><span class="main">;</span>
        <span class="entity">print_space</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
        <span class="entity">print_formula_aux</span> <span class="entity">print_atom_aux</span> <span class="entity">fm</span><span class="main">;</span>
        <span class="entity">print_newline</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
        <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span>
    <span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">Goals</span> <span class="main">(</span><span class="entity">gls</span><span class="main">,</span> <span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">gls</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span>
            <span class="entity">print_string</span> <span class="inner_quoted">"No subgoals"</span>
        <span class="main">|</span> <span class="main">(</span><span class="entity">asl</span><span class="main">,</span> <span class="entity">w</span><span class="main">)</span> :: <span class="entity">ogls</span> <span class="main">=&gt;</span><span class="main">(</span>
            <span class="entity">print_newline</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ogls</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="entity">print_string</span> <span class="inner_quoted">"1 subgoal:"</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>
                <span class="entity">print_int</span> <span class="main">(</span>List.length <span class="entity">gls</span><span class="main">)</span><span class="main">;</span>
                <span class="entity">print_string</span> <span class="inner_quoted">" subgoals starting with"</span>
            <span class="main">)</span>
            <span class="main">;</span>
            <span class="entity">print_newline</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
            List.app <span class="entity">print_hyp</span> <span class="main">(</span>List.rev <span class="entity">asl</span><span class="main">)</span><span class="main">;</span>
            <span class="entity">print_string</span> <span class="inner_quoted">"---&gt; "</span><span class="main">;</span>
            <span class="entity">open_hvbox</span> <span class="inner_numeral">0</span><span class="main">;</span> <span class="entity">print_formula_aux</span> <span class="entity">print_atom_aux</span> <span class="entity">w</span><span class="main">;</span> <span class="entity">close_box</span><span class="main">(</span><span class="main">)</span><span class="main">;</span>
            <span class="entity">print_newline</span> <span class="main">(</span><span class="main">)</span>
          <span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_goal</span> <span class="entity">g</span> <span class="main">=</span> <span class="main">(</span><span class="entity">print_goal_aux</span> <span class="entity">g</span><span class="main">;</span> <span class="entity">print_flush</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Setting up goals and terminating them in a theorem.                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_goal</span> <span class="entity">p</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">chk</span> <span class="entity">th</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> concl <span class="entity">th</span> <span class="main">=</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">th</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"wrong theorem"</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="entity">th</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">chk</span><span class="main">(</span>modusponens <span class="entity">th</span> <span class="entity">truth</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_thm</span> <span class="entity">gls</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">gls</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="entity">Goals</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">jfn</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"extract_thm: unsolved goals"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac_proof</span> <span class="entity">g</span> <span class="entity">prf</span> <span class="main">=</span> <span class="entity">extract_thm</span><span class="main">(</span><span class="entity">itlist</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">f</span><span class="main">)</span> <span class="main">(</span>List.rev <span class="entity">prf</span><span class="main">)</span> <span class="entity">g</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove</span> <span class="entity">p</span> <span class="entity">prf</span> <span class="main">=</span> <span class="entity">tac_proof</span> <span class="main">(</span><span class="entity">set_goal</span> <span class="entity">p</span><span class="main">)</span> <span class="entity">prf</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Conjunction introduction tactic.                                          *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">conj_intro_tac</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span>And<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">jfn'</span> <span class="main">(</span><span class="entity">thp</span>::<span class="entity">thq</span>::<span class="entity">ths</span><span class="main">)</span> <span class="main">=</span>
    <span class="entity">jfn</span><span class="main">(</span><span class="entity">imp_trans_chain</span> <span class="main">[</span><span class="entity">thp</span><span class="main">,</span> <span class="entity">thq</span><span class="main">]</span> <span class="main">(</span><span class="entity">and_pair</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span>::<span class="entity">ths</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>::<span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn'</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Handy idiom for tactic that does not split subgoals.                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="entity">tfn</span> <span class="main">(</span><span class="entity">th</span>::<span class="entity">oths</span><span class="main">)</span> <span class="main">=</span> <span class="entity">jfn</span><span class="main">(</span><span class="entity">tfn</span> <span class="entity">th</span> :: <span class="entity">oths</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Version of gen_right with a bound variable change.                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_right_alpha</span> <span class="entity">y</span> <span class="entity">x</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">gen_right</span> <span class="entity">y</span> <span class="entity">th</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_trans</span> <span class="entity">th1</span> <span class="main">(</span><span class="entity">alpha</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">consequent</span><span class="main">(</span>concl <span class="entity">th1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Universal introduction.                                                   *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">forall_intro_tac</span> <span class="entity">y</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="main">(</span><span class="entity">fm</span> <span class="keyword1"><span class="keyword">as</span></span> Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mem</span> <span class="entity">y</span> <span class="main">(</span><span class="entity">fv</span> <span class="entity">fm</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> List.exists <span class="main">(</span><span class="entity">mem</span> <span class="entity">y</span> o <span class="entity">fv</span> o <span class="entity">snd</span><span class="main">)</span> <span class="entity">asl</span>
  <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"fix: variable already free in goal"</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">subst</span><span class="main">(</span><span class="entity">x</span> <span class="entity">|==&gt;</span> Var <span class="entity">y</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span>
        <span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="main">(</span><span class="entity">gen_right_alpha</span> <span class="entity">y</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Another inference rule: |- P[t] ==&gt; exists x. P[x]                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">right_exists</span> <span class="entity">x</span> <span class="entity">t</span> <span class="entity">p</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">contrapos</span><span class="main">(</span><span class="entity">ispec</span> <span class="entity">t</span> <span class="main">(</span>Forall<span class="main">(</span><span class="entity">x</span><span class="main">,</span>Not <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> Not<span class="main">(</span>Not <span class="entity">p'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">antecedent</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">end_itlist</span> <span class="entity">imp_trans</span>
   <span class="main">[</span><span class="entity">imp_contr</span> <span class="entity">p'</span> Falsity<span class="main">,</span> <span class="entity">imp_add_concl</span> Falsity <span class="main">(</span><span class="entity">iff_imp1</span> <span class="main">(</span>axiom_not <span class="entity">p'</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="entity">iff_imp2</span><span class="main">(</span>axiom_not <span class="main">(</span>Not <span class="entity">p'</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span><span class="main">,</span> <span class="entity">iff_imp2</span><span class="main">(</span>axiom_exists <span class="entity">x</span> <span class="entity">p</span><span class="main">)</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Existential introduction.                                                 *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exists_intro_tac</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span>Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">subst</span><span class="main">(</span><span class="entity">x</span> <span class="entity">|==&gt;</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">p</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span>
        <span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">th</span> <span class="main">=&gt;</span> <span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span><span class="entity">right_exists</span> <span class="entity">x</span> <span class="entity">t</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Implication introduction tactic.                                          *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_intro_tac</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">jmod</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">asl</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">add_assum</span> Truth <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">imp_swap</span> o <span class="entity">shunt</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>::<span class="entity">asl</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="entity">jmod</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Append contextual hypothesis to unconditional theorem.                    *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assumptate</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="entity">add_assum</span> <span class="main">(</span><span class="entity">list_conj</span> <span class="main">(</span>map <span class="entity">snd</span> <span class="entity">asl</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Get the first assumption (quicker than head of assumps result).           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">firstassum</span> <span class="entity">asl</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">snd</span><span class="main">(</span>hd <span class="entity">asl</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">q</span> <span class="main">=</span> <span class="entity">list_conj</span><span class="main">(</span>List.map <span class="entity">snd</span> <span class="main">(</span>List.tl <span class="entity">asl</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> tl <span class="entity">asl</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">imp_refl</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">and_left</span> <span class="entity">p</span> <span class="entity">q</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Import "external" theorem.                                                *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">using</span> <span class="entity">ths</span> <span class="entity">p</span> <span class="entity">g</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ths'</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">th</span> <span class="main">=&gt;</span> <span class="entity">itlist</span> gen <span class="main">(</span><span class="entity">fv</span><span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="entity">th</span><span class="main">)</span> <span class="entity">ths</span> <span class="keyword2"><span class="keyword">in</span></span>
  List.map <span class="main">(</span><span class="entity">assumptate</span> <span class="entity">g</span><span class="main">)</span> <span class="entity">ths'</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Turn assumptions p1,...,pn into theorems |- p1 /\ ... /\ pn ==&gt; pi        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assumps</span> <span class="entity">asl</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">asl</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="main">[</span><span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">imp_refl</span> <span class="entity">p</span><span class="main">)</span><span class="main">]</span>
  <span class="main">|</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>::<span class="entity">lps</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ths</span> <span class="main">=</span> <span class="entity">assumps</span> <span class="entity">lps</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">q</span> <span class="main">=</span> <span class="entity">antecedent</span><span class="main">(</span>concl<span class="main">(</span><span class="entity">snd</span><span class="main">(</span>List.hd <span class="entity">ths</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rth</span> <span class="main">=</span> <span class="entity">and_right</span> <span class="entity">p</span> <span class="entity">q</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">and_left</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span>::List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">th</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">imp_trans</span> <span class="entity">rth</span> <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="entity">ths</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Produce canonical theorem from list of theorems or assumption labels.     *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">by</span> <span class="entity">hyps</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ths</span> <span class="main">=</span> <span class="entity">assumps</span> <span class="entity">asl</span> <span class="keyword2"><span class="keyword">in</span></span>
  List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">assoc</span> <span class="entity">s</span> <span class="entity">ths</span><span class="main">)</span> <span class="entity">hyps</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Main automatic justification step.                                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">singleton</span> <span class="main">[</span><span class="main">_</span><span class="main">]</span> <span class="main">=</span> true
    <span class="main">|</span> <span class="entity">singleton</span> <span class="main">_</span> <span class="main">=</span> false
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">justify</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">p</span> <span class="entity">g</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ths</span> <span class="main">=</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">p</span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">singleton</span> <span class="entity">ths</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">consequent</span><span class="main">(</span>concl <span class="main">(</span>List.hd <span class="entity">ths</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>
      List.hd <span class="entity">ths</span>
    <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">lcffol</span><span class="main">(</span><span class="entity">itlist</span> <span class="main">(</span><span class="entity">mk_imp</span> o <span class="entity">consequent</span> o concl<span class="main">)</span> <span class="entity">ths</span> <span class="entity">p</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">ths</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">assumptate</span> <span class="entity">g</span> <span class="entity">th</span>
      <span class="main">|</span> <span class="main">_</span>  <span class="main">=&gt;</span> <span class="entity">imp_trans_chain</span> <span class="entity">ths</span> <span class="entity">th</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Nested subproof.                                                          *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">proof</span> <span class="entity">tacs</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">[</span><span class="entity">tac_proof</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="entity">th</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="entity">tacs</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Trivial justification, producing no hypotheses.                           *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">at</span> <span class="entity">once</span> <span class="entity">p</span> <span class="entity">gl</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">once</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Hence an automated terminal tactic.                                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">auto_tac</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="main">(</span><span class="entity">g</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">justify</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">w</span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="entity">gls</span><span class="main">,</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ths</span> <span class="main">=&gt;</span> <span class="entity">jfn</span><span class="main">(</span><span class="entity">th</span>::<span class="entity">ths</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* A "lemma" tactic.                                                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lemma_tac</span> <span class="entity">s</span> <span class="entity">p</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="main">(</span><span class="entity">g</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tr</span> <span class="main">=</span> <span class="entity">imp_trans</span><span class="main">(</span><span class="entity">justify</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">p</span> <span class="entity">g</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mfn</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">asl</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">tr</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">imp_unduplicate</span> o <span class="entity">tr</span> o <span class="entity">shunt</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>::<span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="entity">mfn</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Elimination tactic for existential quantification.                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exists_elim_tac</span> <span class="entity">l</span> <span class="entity">fm</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="main">(</span><span class="entity">g</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=</span> <span class="entity">fm</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> List.exists <span class="main">(</span><span class="entity">mem</span> <span class="entity">x</span> o <span class="entity">fv</span><span class="main">)</span> <span class="main">(</span><span class="entity">w</span>::List.map <span class="entity">snd</span> <span class="entity">asl</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"exists_elim_tac: variable free in assumptions"</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">justify</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="main">(</span>Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="entity">g</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">jfn'</span> <span class="entity">pth</span> <span class="main">=</span> <span class="entity">imp_unduplicate</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span><span class="entity">exists_left</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">shunt</span> <span class="entity">pth</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>::<span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="entity">jfn'</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* If |- p ==&gt; r and |- q ==&gt; r then |- p \/ q ==&gt; r                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ante_disj</span> <span class="entity">th1</span> <span class="entity">th2</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th1</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">q</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_imp</span><span class="main">(</span>concl <span class="entity">th2</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ths</span> <span class="main">=</span> map <span class="entity">contrapos</span> <span class="main">[</span><span class="entity">th1</span><span class="main">,</span> <span class="entity">th2</span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th3</span> <span class="main">=</span> <span class="entity">imp_trans_chain</span> <span class="entity">ths</span> <span class="main">(</span><span class="entity">and_pair</span> <span class="main">(</span>Not <span class="entity">p</span><span class="main">)</span> <span class="main">(</span>Not <span class="entity">q</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th4</span> <span class="main">=</span> <span class="entity">contrapos</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">iff_imp2</span><span class="main">(</span>axiom_not <span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="entity">th3</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th5</span> <span class="main">=</span> <span class="entity">imp_trans</span> <span class="main">(</span><span class="entity">iff_imp1</span><span class="main">(</span>axiom_or <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="entity">th4</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">right_doubleneg</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">th5</span> <span class="main">(</span><span class="entity">iff_imp1</span><span class="main">(</span>axiom_not<span class="main">(</span>Imp<span class="main">(</span><span class="entity">r</span><span class="main">,</span>Falsity<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Elimination tactic for disjunction.                                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">disj_elim_tac</span> <span class="entity">l</span> <span class="entity">fm</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="main">(</span><span class="entity">g</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span> <span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">justify</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">fm</span> <span class="entity">g</span>
      <span class="keyword1"><span class="keyword">val</span></span> Or<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">fm</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">jfn'</span> <span class="main">(</span><span class="entity">pth</span>::<span class="entity">qth</span>::<span class="entity">ths</span><span class="main">)</span> <span class="main">=</span>
         <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">imp_trans</span> <span class="entity">th</span> <span class="main">(</span><span class="entity">ante_disj</span> <span class="main">(</span><span class="entity">shunt</span> <span class="entity">pth</span><span class="main">)</span> <span class="main">(</span><span class="entity">shunt</span> <span class="entity">qth</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
         <span class="entity">jfn</span><span class="main">(</span><span class="entity">imp_unduplicate</span> <span class="entity">th1</span>::<span class="entity">ths</span><span class="main">)</span>
         <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>::<span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="main">(</span><span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span>::<span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn'</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Declarative proof.                                                        *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">multishunt</span> <span class="entity">i</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th1</span> <span class="main">=</span> <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">funpow</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">imp_swap</span> o <span class="entity">shunt</span><span class="main">)</span> <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">imp_swap</span><span class="main">(</span><span class="entity">funpow</span> <span class="main">(</span><span class="entity">i</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="entity">unshunt</span> o <span class="entity">imp_front</span> <span class="inner_numeral">2</span><span class="main">)</span> <span class="entity">th1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assume</span> <span class="entity">lps</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span>Imp<span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">end_itlist</span> <span class="entity">mk_and</span> <span class="main">(</span>map <span class="entity">snd</span> <span class="entity">lps</span><span class="main">)</span> &lt;&gt; <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"assume"</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">jfn'</span> <span class="entity">th</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">asl</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">add_assum</span> Truth <span class="entity">th</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">multishunt</span> <span class="main">(</span>length <span class="entity">lps</span><span class="main">)</span> <span class="entity">th</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">lps</span>@<span class="entity">asl</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="entity">jfn'</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">note</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lemma_tac</span> <span class="entity">l</span> <span class="entity">p</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">have</span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">note</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">so</span> <span class="entity">tac</span> <span class="entity">arg</span> <span class="entity">byfn</span> <span class="main">=</span>
  <span class="entity">tac</span> <span class="entity">arg</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">hyps</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">gl</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
                     <span class="entity">firstassum</span> <span class="entity">asl</span> :: <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">p</span> <span class="entity">gl</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fix</span> <span class="main">=</span> <span class="entity">forall_intro_tac</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">consider</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=</span> <span class="entity">exists_elim_tac</span> <span class="inner_quoted">""</span> <span class="main">(</span>Exists<span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">take</span> <span class="entity">tm</span> <span class="entity">gls</span> <span class="main">=</span> <span class="entity">exists_intro_tac</span> <span class="entity">tm</span> <span class="entity">gls</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cases</span> <span class="entity">fm</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">disj_elim_tac</span> <span class="inner_quoted">""</span> <span class="entity">fm</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">g</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Thesis modification.                                                      *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">conclude</span> <span class="entity">p</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="main">(</span><span class="entity">gl</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">justify</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">p</span> <span class="entity">gl</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">w</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span>Truth<span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p'</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_and</span> <span class="entity">w</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p'</span> &lt;&gt; <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"conclude: bad conclusion"</span> <span class="keyword2"><span class="keyword">else</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mfn</span> <span class="entity">th'</span> <span class="main">=</span> <span class="entity">imp_trans_chain</span> <span class="main">[</span><span class="entity">th</span><span class="main">,</span> <span class="entity">th'</span><span class="main">]</span> <span class="main">(</span><span class="entity">and_pair</span> <span class="entity">p</span> <span class="entity">q</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">q</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jmodify</span> <span class="entity">jfn</span> <span class="entity">mfn</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* A useful shorthand for solving the whole goal.                            *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="main">(</span><span class="entity">gl</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">conclude</span> <span class="entity">w</span> <span class="entity">byfn</span> <span class="entity">hyps</span> <span class="entity">gl</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thesis</span> <span class="main">=</span> <span class="inner_quoted">""</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Termination.                                                              *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">qed</span> <span class="main">(</span><span class="entity">gl</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">w</span> <span class="main">=</span> Truth <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="entity">gls</span><span class="main">,</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ths</span> <span class="main">=&gt;</span> <span class="entity">jfn</span><span class="main">(</span><span class="entity">assumptate</span> <span class="entity">gl</span> <span class="entity">truth</span> :: <span class="entity">ths</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"qed: non-trivial goal"</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* A simple example.                                                         *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ewd954</span> <span class="main">=</span> <span class="entity">prove</span>
 <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(forall x y. x &lt;= y &lt;=&gt; x * y = x) /\\ "</span> ^
   <span class="inner_quoted">"(forall x y. f(x * y) = f(x) * f(y)) "</span> ^
   <span class="inner_quoted">"==&gt; forall x y. x &lt;= y ==&gt; f(x) &lt;= f(y)"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
 <span class="main">[</span><span class="entity">note</span><span class="main">(</span><span class="inner_quoted">"eq_sym"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x y. x = y ==&gt; y = x"</span><span class="entity">!&gt;</span><span class="main">)</span>
    <span class="entity">using</span> <span class="main">[</span><span class="entity">eq_sym</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"x"</span><span class="entity">|!&gt;</span><span class="main">)</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"y"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">note</span><span class="main">(</span><span class="inner_quoted">"eq_trans"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x y z. x = y /\\ y = z ==&gt; x = z"</span><span class="entity">!&gt;</span><span class="main">)</span>
    <span class="entity">using</span> <span class="main">[</span><span class="entity">eq_trans</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"x"</span><span class="entity">|!&gt;</span><span class="main">)</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"y"</span><span class="entity">|!&gt;</span><span class="main">)</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"z"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">note</span><span class="main">(</span><span class="inner_quoted">"eq_cong"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x y. x = y ==&gt; f(x) = f(y)"</span><span class="entity">!&gt;</span><span class="main">)</span>
    <span class="entity">using</span> <span class="main">[</span>axiom_funcong <span class="inner_quoted">"f"</span> <span class="main">[</span><span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"x"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"y"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"le"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x y. x &lt;= y &lt;=&gt; x * y = x"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">,</span>
          <span class="main">(</span><span class="inner_quoted">"hom"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x y. f(x * y) = f(x) * f(y)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">fix</span> <span class="inner_quoted">"x"</span><span class="main">,</span> <span class="entity">fix</span> <span class="inner_quoted">"y"</span><span class="main">,</span>
  <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"xy"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"x &lt;= y"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"x * y = x"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"le"</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"f(x * y) = f(x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"eq_cong"</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"f(x) = f(x * y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"eq_sym"</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"f(x) = f(x) * f(y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"eq_trans"</span><span class="main">,</span> <span class="inner_quoted">"hom"</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"f(x) * f(y) = f(x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"eq_sym"</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">so</span> <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"f(x) &lt;= f(y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"le"</span><span class="main">]</span><span class="main">,</span>
  <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* More examples not in the main text.                                       *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="entity">prove</span>
 <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(exists x. p(x)) ==&gt; (forall x. p(x) ==&gt; p(f(x))) "</span> ^
   <span class="inner_quoted">"==&gt; exists y. p(f(f(f(f(y)))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span><span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. p(x)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"C"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(f(f(f(x)))))"</span><span class="entity">!&gt;</span><span class="main">)</span>
   <span class="entity">proof</span>
    <span class="main">[</span><span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(f(x)))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
     <span class="entity">so</span> <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(f(f(f(x)))))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
     <span class="entity">qed</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">consider</span> <span class="main">(</span><span class="inner_quoted">"a"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"a"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
   <span class="entity">so</span> <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(f(f(f(f(a)))))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"C"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Alternative formulation with lemma construct.                             *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lemma</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">gl</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span><span class="entity">jfn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>::<span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>::<span class="entity">asl</span><span class="main">,</span><span class="entity">w</span><span class="main">)</span>::<span class="entity">gls</span><span class="main">,</span>
        <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">thp</span>::<span class="entity">thw</span>::<span class="entity">oths</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="entity">jfn</span><span class="main">(</span><span class="entity">imp_unduplicate</span><span class="main">(</span><span class="entity">imp_trans</span> <span class="entity">thp</span> <span class="main">(</span><span class="entity">shunt</span> <span class="entity">thw</span><span class="main">)</span><span class="main">)</span> :: <span class="entity">oths</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
<span class="entity">prove</span>
 <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(exists x. p(x)) ==&gt; (forall x. p(x) ==&gt; p(f(x))) "</span> ^
   <span class="inner_quoted">"==&gt; exists y. p(f(f(f(f(y)))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span><span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. p(x)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">lemma</span> <span class="main">(</span><span class="inner_quoted">"C"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(f(f(f(x)))))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">,</span>
     <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(f(x)))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
     <span class="entity">so</span> <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(f(f(f(x)))))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
     <span class="entity">qed</span><span class="main">,</span>
   <span class="entity">consider</span> <span class="main">(</span><span class="inner_quoted">"a"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"a"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
   <span class="entity">so</span> <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(f(f(f(f(a)))))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"C"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">qed</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* ------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Examples.                                                                 *)</span>
<span class="comment1">(* ------------------------------------------------------------------------- *)</span>

<span class="entity">prove</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"p(a) ==&gt; (forall x. p(x) ==&gt; p(f(x))) "</span> ^
        <span class="inner_quoted">"==&gt; exists y. p(y) /\\ p(f(y))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="main">[</span><span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
       <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span>
 <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(exists x. p(x)) ==&gt; (forall x. p(x) ==&gt; p(f(x))) "</span> ^
   <span class="inner_quoted">"==&gt; exists y. p(f(f(f(f(y)))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span><span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. p(x)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"C"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(f(f(f(x)))))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
    <span class="main">[</span><span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(f(x)))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
     <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
     <span class="entity">qed</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">consider</span> <span class="main">(</span><span class="inner_quoted">"a"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"a"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
   <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"C"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"forall a. p(a) ==&gt; (forall x. p(x) ==&gt; p(f(x))) "</span> ^
                  <span class="inner_quoted">"==&gt; exists y. p(y) /\\ p(f(y))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="main">[</span><span class="entity">fix</span> <span class="inner_quoted">"c"</span><span class="main">,</span>
       <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"c"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
       <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"C"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c) ==&gt; p(f(c))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"C"</span><span class="main">,</span> <span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"p(c) ==&gt; (forall x. p(x) ==&gt; p(f(x))) "</span> ^
                  <span class="inner_quoted">"==&gt; exists y. p(y) /\\ p(f(y))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="main">[</span><span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"c"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
       <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">,</span> <span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"forall a. p(a) ==&gt; (forall x. p(x) ==&gt; p(f(x))) "</span> ^
                  <span class="inner_quoted">"==&gt; exists y. p(y) /\\ p(f(y))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="main">[</span><span class="entity">fix</span> <span class="inner_quoted">"c"</span><span class="main">,</span>
       <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"c"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
       <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"C"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c) ==&gt; p(f(c))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"C"</span><span class="main">,</span> <span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"forall a. p(a) ==&gt; (forall x. p(x) ==&gt; p(f(x))) "</span> ^
                  <span class="inner_quoted">"==&gt; exists y. p(y) /\\ p(f(y))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="main">[</span><span class="entity">fix</span> <span class="inner_quoted">"c"</span><span class="main">,</span>
       <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"c"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
       <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"D"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"C"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(c) ==&gt; p(f(c))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"C"</span><span class="main">,</span> <span class="inner_quoted">"A"</span><span class="main">,</span> <span class="inner_quoted">"D"</span><span class="main">]</span><span class="main">,</span>
       <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(p(a) \\/ p(b)) ==&gt; q ==&gt; exists y. p(y)"</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span><span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a) \\/ p(b)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"q"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">cases</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a) \\/ p(b)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
     <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"a"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
     <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
     <span class="entity">qed</span><span class="main">,</span>

     <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"b"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
     <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
     <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span>
  <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(p(a) \\/ p(b)) /\\ (forall x. p(x) ==&gt; p(f(x))) ==&gt; exists y. p(f(y))"</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span><span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"base"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a) \\/ p(b)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">,</span>
           <span class="main">(</span><span class="inner_quoted">"Step"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">cases</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a) \\/ p(b)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"base"</span><span class="main">]</span><span class="main">,</span>
     <span class="entity">so</span> <span class="entity">note</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
     <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"X"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a) ==&gt; p(f(a))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"Step"</span><span class="main">]</span><span class="main">,</span>
     <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"a"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
     <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">,</span> <span class="inner_quoted">"X"</span><span class="main">]</span><span class="main">,</span>
     <span class="entity">qed</span><span class="main">,</span>

     <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"b"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
     <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"Step"</span><span class="main">]</span><span class="main">,</span>
     <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span>
 <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. p(x)) ==&gt; (forall x. p(x) ==&gt; p(f(x))) ==&gt; exists y. p(f(y))"</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span><span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. p(x)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; p(f(x))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">consider</span> <span class="main">(</span><span class="inner_quoted">"a"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">so</span> <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"concl"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(f(a))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">take</span> <span class="main">(</span><span class="entity">&lt;!|</span><span class="inner_quoted">"a"</span><span class="entity">|!&gt;</span><span class="main">)</span><span class="main">,</span>
   <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"concl"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

<span class="entity">prove</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(forall x. p(x) ==&gt; q(x)) ==&gt; (forall x. q(x) ==&gt; p(x)) "</span> ^
       <span class="inner_quoted">"==&gt; (p(a) &lt;=&gt; q(a))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span><span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. p(x) ==&gt; q(x)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x. q(x) ==&gt; p(x)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"von"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"p(a) ==&gt; q(a)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"bis"</span><span class="main">,</span><span class="entity">&lt;!</span><span class="inner_quoted">"q(a) ==&gt; p(a)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"von"</span><span class="main">,</span> <span class="inner_quoted">"bis"</span><span class="main">]</span><span class="main">,</span>
   <span class="entity">qed</span><span class="main">]</span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Main Examples›</span></span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Hoare's Exercise ewd1062_1 &amp; ewd1062_2 (Harrison has only a proof with tactics) *)</span>

<span class="entity">prove</span>
  <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(forall x. x &lt;= x) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y z. x &lt;= y /\\ y &lt;= z ==&gt; x &lt;= z) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y. f(x) &lt;= y &lt;=&gt; x &lt;= g(y)) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x y. x &lt;= y ==&gt; f(x) &lt;= f(y)) /\\ "</span> ^
          <span class="inner_quoted">"(forall x y. x &lt;= y ==&gt; g(x) &lt;= g(y))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span>
    <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(forall x. x &lt;= x) /\\ "</span> ^
             <span class="inner_quoted">"(forall x y z. x &lt;= y /\\ y &lt;= z ==&gt; x &lt;= z) /\\ "</span> ^
             <span class="inner_quoted">"(forall x y. f(x) &lt;= y &lt;=&gt; x &lt;= g(y))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
    <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(forall x y. x &lt;= y ==&gt; f(x) &lt;= f(y)) /\\ "</span> ^
                 <span class="inner_quoted">"(forall x y. x &lt;= y ==&gt; g(x) &lt;= g(y))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
    <span class="main">[</span>
      <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(forall x y. x &lt;= y ==&gt; f(x) &lt;= f(y))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
      <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(forall x y. x &lt;= y ==&gt; g(x) &lt;= g(y))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
      <span class="entity">qed</span>
    <span class="main">]</span><span class="main">,</span>
    <span class="entity">qed</span>
  <span class="main">]</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p43 (Harrison has it in a comment but the proof seems not to finish) *)</span>

<span class="entity">prove</span>
  <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(forall x y. Q(x,y) &lt;=&gt; forall z. P(z,x) &lt;=&gt; P(z,y)) ==&gt; forall x y. Q(x,y) &lt;=&gt; Q(y,x)"</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="main">[</span>
    <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="inner_quoted">"forall x y. Q(x,y) &lt;=&gt; forall z. P(z,x) &lt;=&gt; P(z,y)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
    <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall x y. Q(x,y) &lt;=&gt; Q(y,x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
    <span class="main">[</span>
      <span class="entity">fix</span> <span class="inner_quoted">"x"</span><span class="main">,</span> <span class="entity">fix</span> <span class="inner_quoted">"y"</span><span class="main">,</span>
      <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"Q(x,y) &lt;=&gt; Q(y,x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
      <span class="main">[</span>
        <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(Q(x,y) ==&gt; Q(y,x)) /\\ (Q(y,x) ==&gt; Q(x,y))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
        <span class="main">[</span>
          <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"Q(x,y) ==&gt; Q(y,x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
          <span class="main">[</span>
            <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="inner_quoted">"Q(x,y)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
            <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall z. P(z,x) &lt;=&gt; P(z,y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
            <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall z. P(z,y) &lt;=&gt; P(z,x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
            <span class="entity">so</span> <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"Q(y,x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
            <span class="entity">qed</span>
          <span class="main">]</span><span class="main">,</span>
          <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"Q(y,x) ==&gt; Q(x,y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
          <span class="main">[</span>
            <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="inner_quoted">"Q(y,x)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
            <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall z. P(z,y) &lt;=&gt; P(z,x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
            <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"forall z. P(z,x) &lt;=&gt; P(z,y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
            <span class="entity">so</span> <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"Q(x,y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
            <span class="entity">qed</span>
          <span class="main">]</span><span class="main">,</span>
          <span class="entity">qed</span>
        <span class="main">]</span><span class="main">,</span>
        <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
        <span class="entity">qed</span>
      <span class="main">]</span><span class="main">,</span>
      <span class="entity">qed</span>
    <span class="main">]</span><span class="main">,</span>
    <span class="entity">qed</span>
  <span class="main">]</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p46 (Harrison does not have it) *)</span>

  <span class="entity">prove</span>
    <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(forall x. P(x) /\\ (forall y. P(y) /\\ H(y,x) ==&gt; G(y)) ==&gt; G(x)) /\\ "</span> ^
          <span class="inner_quoted">"((exists x. P(x) /\\ ~G(x)) ==&gt; "</span> ^
            <span class="inner_quoted">"(exists x. P(x) /\\ ~G(x) /\\ (forall y. P(y) /\\ ~G(y) ==&gt; J(x,y)))) /\\ "</span> ^
          <span class="inner_quoted">"(forall x y. P(x) /\\ P(y) /\\ H(x,y) ==&gt; ~J(y,x)) ==&gt; "</span> ^
          <span class="inner_quoted">"(forall x. P(x) ==&gt; G(x))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
    <span class="main">[</span>
      <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(forall x. P(x) /\\ (forall y. P(y) /\\ H(y,x) ==&gt; G(y)) ==&gt; G(x)) /\\ "</span> ^
          <span class="inner_quoted">"((exists x. P(x) /\\ ~G(x)) ==&gt; "</span> ^
            <span class="inner_quoted">"(exists x. P(x) /\\ ~G(x) /\\ (forall y. P(y) /\\ ~G(y) ==&gt; J(x,y)))) /\\ "</span> ^
          <span class="inner_quoted">"(forall x y. P(x) /\\ P(y) /\\ H(x,y) ==&gt; ~J(y,x))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
      <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(forall x. P(x) ==&gt; G(x))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
      <span class="main">[</span>
        <span class="entity">fix</span> <span class="inner_quoted">"x"</span><span class="main">,</span>
        <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"P(x) ==&gt; G(x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">proof</span>
        <span class="main">[</span>
          <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="inner_quoted">"P(x)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">conclude</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"G(x)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span> <span class="entity">qed</span>
        <span class="main">]</span><span class="main">,</span> <span class="entity">qed</span>
      <span class="main">]</span><span class="main">,</span> <span class="entity">qed</span>
    <span class="main">]</span>

›</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Other Examples›</span></span>

<span class="comment1">(* For Pelletier's Problem 34 aka Andrews's Challenge *)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">by_mp</span> <span class="main">(</span><span class="entity">ab</span><span class="main">,</span> <span class="entity">a</span><span class="main">)</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">Goals</span><span class="main">(</span><span class="main">(</span><span class="entity">asl</span><span class="main">,</span><span class="main">_</span><span class="main">)</span>::<span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ths</span> <span class="main">=</span> <span class="entity">assumps</span> <span class="entity">asl</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">right_mp</span> <span class="main">(</span><span class="entity">assoc</span> <span class="entity">ab</span> <span class="entity">ths</span><span class="main">)</span> <span class="main">(</span><span class="entity">assoc</span> <span class="entity">a</span> <span class="entity">ths</span><span class="main">)</span>
    <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"by_mp: unapplicable assumptions"</span>
  <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">consequent</span> <span class="main">(</span>concl <span class="entity">th</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="entity">th</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"by_mp: wrong conclusion"</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">by_mp</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Match by_mp"</span>
<span class="main">;</span>

›</span>

<span class="comment1">(* Function auto as a basic declarative proof *)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">auto</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">prove</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="entity">s</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="main">[</span><span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span> <span class="entity">qed</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">auto</span> <span class="inner_quoted">"A ==&gt; A"</span>›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">auto</span> <span class="inner_quoted">"exists x. D(x) ==&gt; forall x. D(x)"</span>›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">auto</span> <span class="inner_quoted">"(forall x. ~R(x) ==&gt; R(f(x))) ==&gt; exists x. R(x) /\\ R(f(f(x)))"</span>›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Harrison p58 (as mentioned in the errata it is not Pelletier p58) *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"forall x. exists v w. forall y z. P(x) /\\ Q(y) ==&gt; (P(v) \\/ R(w)) /\\ (R(z) ==&gt; Q(v))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p1 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"p ==&gt; q &lt;=&gt; ~q ==&gt; ~p"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p2 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"~ ~p &lt;=&gt; p"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p3 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"~(p ==&gt; q) ==&gt; q ==&gt; p"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p4 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"~p ==&gt; q &lt;=&gt; ~q ==&gt; p"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p5 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(p \\/ q ==&gt; p \\/ r) ==&gt; p \\/ (q ==&gt; r)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p6 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"p \\/ ~p"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p7 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"p \\/ ~ ~ ~p"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p8 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"((p ==&gt; q) ==&gt; p) ==&gt; p"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p9 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(p \\/ q) /\\ (~p \\/ q) /\\ (p \\/ ~q) ==&gt; ~(~q \\/ ~q)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p10 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(q ==&gt; r) /\\ (r ==&gt; p /\\ q) /\\ (p ==&gt; q /\\ r) ==&gt; (p &lt;=&gt; q)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p11 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"p &lt;=&gt; p"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p12 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"((p &lt;=&gt; q) &lt;=&gt; r) &lt;=&gt; (p &lt;=&gt; (q &lt;=&gt; r))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p13 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"p \\/ q /\\ r &lt;=&gt; (p \\/ q) /\\ (p \\/ r)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p14 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(p &lt;=&gt; q) &lt;=&gt; (q \\/ ~p) /\\ (~q \\/ p)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p15 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"p ==&gt; q &lt;=&gt; ~p \\/ q"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p16 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(p ==&gt; q) \\/ (q ==&gt; p)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p17 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"p /\\ (q ==&gt; r) ==&gt; s &lt;=&gt; (~p \\/ q \\/ s) /\\ (~p \\/ ~r \\/ s)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p18 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"exists y. forall x. P(y) ==&gt; P(x)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p19 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"exists x. forall y z. (P(y) ==&gt; Q(z)) ==&gt; P(x) ==&gt; Q(x)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p20 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x y. exists z. forall w. P(x) /\\ Q(y) ==&gt; R(z) /\\ U(w)) "</span> ^
      <span class="inner_quoted">"==&gt; (exists x y. P(x) /\\ Q(y)) ==&gt; (exists z. R(z))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p21 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(exists x. P ==&gt; Q(x)) /\\ (exists x. Q(x) ==&gt; P) ==&gt; (exists x. P &lt;=&gt; Q(x))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p22 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(forall x. P &lt;=&gt; Q(x)) ==&gt; (P &lt;=&gt; (forall x. Q(x)))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p23 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(forall x. P \\/ Q(x)) &lt;=&gt; P \\/ (forall x. Q(x))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p24 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"~(exists x. U(x) /\\ Q(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. P(x) ==&gt; Q(x) \\/ R(x)) /\\ "</span> ^
      <span class="inner_quoted">"~(exists x. P(x) ==&gt; (exists x. Q(x))) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. Q(x) /\\ R(x) ==&gt; U(x)) "</span> ^
      <span class="inner_quoted">"==&gt; (exists x. P(x) /\\ R(x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p25 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(exists x. P(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. U(x) ==&gt; ~G(x) /\\ R(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. P(x) ==&gt; G(x) /\\ U(x)) /\\ "</span> ^
      <span class="inner_quoted">"((forall x. P(x) ==&gt; Q(x)) \\/ (exists x. Q(x) /\\ P(x))) "</span> ^
      <span class="inner_quoted">"==&gt; (exists x. Q(x) /\\ P(x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p26 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"((exists x. P(x)) &lt;=&gt; (exists x. Q(x))) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y. P(x) /\\ Q(y) ==&gt; (R(x) &lt;=&gt; U(y))) "</span> ^
      <span class="inner_quoted">"==&gt; ((forall x. P(x) ==&gt; R(x)) &lt;=&gt; (forall x. Q(x) ==&gt; U(x)))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p27 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(exists x. P(x) /\\ ~Q(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. P(x) ==&gt; R(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. U(x) /\\ V(x) ==&gt; P(x)) /\\ "</span> ^
      <span class="inner_quoted">"(exists x. R(x) /\\ ~Q(x)) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x. V(x) ==&gt; ~R(x)) ==&gt; (forall x. U(x) ==&gt; ~V(x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p28 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. P(x) ==&gt; (forall x. Q(x))) /\\ "</span> ^
      <span class="inner_quoted">"((forall x. Q(x) \\/ R(x)) ==&gt; (exists x. Q(x) /\\ R(x))) /\\ "</span> ^
      <span class="inner_quoted">"((exists x. R(x)) ==&gt; (forall x. L(x) ==&gt; M(x))) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x. P(x) /\\ L(x) ==&gt; M(x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p29 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(exists x. P(x)) /\\ (exists x. G(x)) ==&gt; "</span> ^
      <span class="inner_quoted">"((forall x. P(x) ==&gt; H(x)) /\\ (forall x. G(x) ==&gt; J(x)) "</span> ^
      <span class="inner_quoted">"&lt;=&gt; (forall x y. P(x) /\\ G(y) ==&gt; H(x) /\\ J(y)))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p30 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. P(x) \\/ G(x) ==&gt; ~H(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. (G(x) ==&gt; ~U(x)) ==&gt; P(x) /\\ H(x)) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x. U(x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p31 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"~(exists x. P(x) /\\ (G(x) \\/ H(x))) /\\ "</span> ^
      <span class="inner_quoted">"(exists x. Q(x) /\\ P(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. ~H(x) ==&gt; J(x)) "</span> ^
      <span class="inner_quoted">"==&gt; (exists x. Q(x) /\\ J(x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p32 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. P(x) /\\ (G(x) \\/ H(x)) ==&gt; Q(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. Q(x) /\\ H(x) ==&gt; J(x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. R(x) ==&gt; H(x)) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x. P(x) /\\ R(x) ==&gt; J(x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p33 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. P(a) /\\ (P(x) ==&gt; P(b)) ==&gt; P(c)) "</span> ^
      <span class="inner_quoted">"&lt;=&gt; (forall x. P(a) ==&gt; P(x) \\/ P(c)) /\\ (P(a) ==&gt; P(b) ==&gt; P(c))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p34 *)</span>

<span class="entity">prove</span>
<span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) &lt;=&gt;"</span>
^   <span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
<span class="main">[</span>

  <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"directions"</span><span class="main">,</span>
  <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) ==&gt;"</span>
^    <span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y))))) /\\"</span>
^    <span class="inner_quoted">"(((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))) ==&gt;"</span>
^    <span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="entity">proof</span>
  <span class="main">[</span>
    <span class="entity">conclude</span>
    <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) ==&gt;"</span>
^       <span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
    <span class="entity">proof</span>
    <span class="main">[</span>
      <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span>
      <span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>

      <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"ant"</span><span class="main">,</span>
      <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) ==&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))) /\\"</span>
^        <span class="inner_quoted">"(((exists x. P(x)) &lt;=&gt; (forall y. P(y))) ==&gt; ((exists x. forall y. Q(x) &lt;=&gt; Q(y))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="entity">proof</span>
      <span class="main">[</span>

        <span class="entity">conclude</span>
        <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. forall y. Q(x) &lt;=&gt; Q(y)) ==&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span>
        <span class="entity">proof</span>
        <span class="main">[</span>
          <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="inner_quoted">"exists x. forall y. Q(x) &lt;=&gt; Q(y)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. Q(x)) &lt;=&gt; (forall y. Q(y))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. forall y. P(x) &lt;=&gt; P(y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
          <span class="entity">qed</span>
        <span class="main">]</span><span class="main">,</span>

        <span class="entity">conclude</span>
        <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"((exists x. P(x)) &lt;=&gt; (forall y. P(y))) ==&gt; (exists x. forall y. Q(x) &lt;=&gt; Q(y))"</span><span class="entity">!&gt;</span><span class="main">)</span>
        <span class="entity">proof</span>
        <span class="main">[</span>
          <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span>
          <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) ==&gt;"</span>
^            <span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) ==&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
          <span class="entity">using</span> <span class="main">[</span>axiom_iffimp1
            <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. forall y. P(x) &lt;=&gt; P(y)"</span><span class="entity">!&gt;</span><span class="main">)</span>
            <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. Q(x)) &lt;=&gt; (forall y. Q(y))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"A1"</span><span class="main">,</span>
           <span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. forall y. P(x) &lt;=&gt; P(y)) ==&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span>
          <span class="entity">by_mp</span> <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span> <span class="inner_quoted">"A"</span><span class="main">)</span><span class="main">,</span>

          <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="inner_quoted">"((exists x. P(x)) &lt;=&gt; (forall y. P(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. forall y. P(x) &lt;=&gt; P(y))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A1"</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
          <span class="entity">qed</span>
        <span class="main">]</span><span class="main">,</span>
        <span class="entity">qed</span>
      <span class="main">]</span><span class="main">,</span>

      <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span>
      <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) ==&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))) /\\"</span>
^        <span class="inner_quoted">"(((exists x. P(x)) &lt;=&gt; (forall y. P(y))) ==&gt; ((exists x. forall y. Q(x) &lt;=&gt; Q(y)))) ==&gt;"</span>
^        <span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="entity">using</span> <span class="main">[</span><span class="entity">unshunt</span> <span class="main">(</span>axiom_impiff
        <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. forall y. Q(x) &lt;=&gt; Q(y)"</span><span class="entity">!&gt;</span><span class="main">)</span>
        <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. P(x)) &lt;=&gt; (forall y. P(y))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>

      <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by_mp</span> <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span> <span class="inner_quoted">"ant"</span><span class="main">)</span><span class="main">,</span>
      <span class="entity">qed</span>
    <span class="main">]</span><span class="main">,</span>

    <span class="entity">conclude</span>
    <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))) ==&gt;"</span>
^       <span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
    <span class="entity">proof</span>
    <span class="main">[</span>
      <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span>
       <span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>

      <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"ant"</span><span class="main">,</span>
      <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) ==&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) /\\"</span>
^        <span class="inner_quoted">"(((exists x. Q(x)) &lt;=&gt; (forall y. Q(y))) ==&gt; (exists x. forall y. P(x) &lt;=&gt; P(y)))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="entity">proof</span>
      <span class="main">[</span>

        <span class="entity">conclude</span>
        <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. forall y. P(x) &lt;=&gt; P(y)) ==&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span>
        <span class="entity">proof</span>
        <span class="main">[</span>
          <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="inner_quoted">"exists x. forall y. P(x) &lt;=&gt; P(y)"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. P(x)) &lt;=&gt; (forall y. P(y))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. forall y. Q(x) &lt;=&gt; Q(y)"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A"</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
          <span class="entity">qed</span>
        <span class="main">]</span><span class="main">,</span>

        <span class="entity">conclude</span>
        <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"((exists x. Q(x)) &lt;=&gt; (forall y. Q(y))) ==&gt; (exists x. forall y. P(x) &lt;=&gt; P(y))"</span><span class="entity">!&gt;</span><span class="main">)</span>
        <span class="entity">proof</span>
        <span class="main">[</span>
          <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span>
          <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))) ==&gt;"</span>
^            <span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) ==&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
          <span class="entity">using</span> <span class="main">[</span>axiom_iffimp1
            <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. forall y. Q(x) &lt;=&gt; Q(y)"</span><span class="entity">!&gt;</span><span class="main">)</span>
            <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. P(x)) &lt;=&gt; (forall y. P(y))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"A1"</span><span class="main">,</span>
          <span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. forall y. Q(x) &lt;=&gt; Q(y)) ==&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span>
          <span class="entity">by_mp</span> <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span> <span class="inner_quoted">"A"</span><span class="main">)</span><span class="main">,</span>

          <span class="entity">assume</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. Q(x)) &lt;=&gt; (forall y. Q(y))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. forall y. Q(x) &lt;=&gt; Q(y))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">have</span> <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"((exists x. P(x)) &lt;=&gt; (forall y. P(y)))"</span><span class="entity">!&gt;</span><span class="main">)</span> <span class="entity">by</span> <span class="main">[</span><span class="inner_quoted">"A1"</span><span class="main">]</span><span class="main">,</span>
          <span class="entity">so</span> <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">at</span> <span class="entity">once</span><span class="main">,</span>
          <span class="entity">qed</span>
        <span class="main">]</span><span class="main">,</span>
        <span class="entity">qed</span>
      <span class="main">]</span><span class="main">,</span>

      <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span>
      <span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) ==&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) /\\"</span>
^        <span class="inner_quoted">"(((exists x. Q(x)) &lt;=&gt; (forall y. Q(y))) ==&gt; (exists x. forall y. P(x) &lt;=&gt; P(y))) ==&gt;"</span>
^        <span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y))))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
      <span class="entity">using</span> <span class="main">[</span><span class="entity">unshunt</span> <span class="main">(</span>axiom_impiff
        <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"exists x. forall y. P(x) &lt;=&gt; P(y)"</span><span class="entity">!&gt;</span><span class="main">)</span>
        <span class="main">(</span><span class="entity">&lt;!</span><span class="inner_quoted">"(exists x. Q(x)) &lt;=&gt; (forall y. Q(y))"</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>

      <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by_mp</span> <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span> <span class="inner_quoted">"ant"</span><span class="main">)</span><span class="main">,</span>
      <span class="entity">qed</span>
    <span class="main">]</span><span class="main">,</span>
    <span class="entity">qed</span>
  <span class="main">]</span><span class="main">,</span>

  <span class="entity">note</span> <span class="main">(</span><span class="inner_quoted">"impiff"</span><span class="main">,</span>
  <span class="entity">&lt;!</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">"(((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) ==&gt;"</span>
^     <span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y))))) /\\"</span>
^     <span class="inner_quoted">"(((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))) ==&gt;"</span>
^     <span class="inner_quoted">"((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y))))) ==&gt;"</span>
^     <span class="inner_quoted">"(((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) &lt;=&gt;"</span>
^     <span class="inner_quoted">"((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))))"</span><span class="main">)</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
  <span class="entity">using</span> <span class="main">[</span><span class="entity">unshunt</span> <span class="main">(</span>axiom_impiff
    <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; ((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">&lt;!</span><span class="main">(</span><span class="inner_quoted">"(exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; ((exists x. P(x)) &lt;=&gt; (forall y. P(y)))"</span><span class="main">)</span><span class="entity">!&gt;</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>

  <span class="entity">our</span> <span class="entity">thesis</span> <span class="entity">by_mp</span> <span class="main">(</span><span class="inner_quoted">"impiff"</span><span class="main">,</span> <span class="inner_quoted">"directions"</span><span class="main">)</span><span class="main">,</span>
  <span class="entity">qed</span>
<span class="main">]</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p35 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"exists x y. P(x,y) ==&gt; (forall x y. P(x,y))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p36 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. exists y. P(x,y)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. exists y. G(x,y)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y. P(x,y) \\/ G(x,y) ==&gt; (forall z. P(y,z) \\/ G(y,z) ==&gt; H(x,z))) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x. exists y. H(x,y))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p37 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall z. "</span> ^
        <span class="inner_quoted">"exists w. forall x. exists y. (P(x,z) ==&gt; P(y,w)) /\\ P(y,z) /\\ "</span> ^
        <span class="inner_quoted">"(P(y,w) ==&gt; (exists u. Q(u,w)))) /\\ "</span> ^
      <span class="inner_quoted">"(forall x z. ~P(x,z) ==&gt; (exists y. Q(y,z))) /\\ "</span> ^
      <span class="inner_quoted">"((exists x y. Q(x,y)) ==&gt; (forall x. R(x,x))) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x. exists y. R(x,y))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p38 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. "</span> ^
        <span class="inner_quoted">"P(a) /\\ (P(x) ==&gt; (exists y. P(y) /\\ R(x,y))) ==&gt; "</span> ^
        <span class="inner_quoted">"(exists z w. P(z) /\\ R(x,w) /\\ R(w,z))) &lt;=&gt; "</span> ^
      <span class="inner_quoted">"(forall x. "</span> ^
        <span class="inner_quoted">"(~P(a) \\/ P(x) \\/ (exists z w. P(z) /\\ R(x,w) /\\ R(w,z))) /\\ "</span> ^
        <span class="inner_quoted">"(~P(a) \\/ ~(exists y. P(y) /\\ R(x,y)) \\/ "</span> ^
        <span class="inner_quoted">"(exists z w. P(z) /\\ R(x,w) /\\ R(w,z))))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p39 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"~(exists x. forall y. P(y,x) &lt;=&gt; ~P(y,y))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p40 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(exists y. forall x. P(x,y) &lt;=&gt; P(x,x)) "</span> ^
      <span class="inner_quoted">"==&gt; ~(forall x. exists y. forall z. P(z,y) &lt;=&gt; ~P(z,x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p41 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall z. exists y. forall x. P(x,y) &lt;=&gt; P(x,z) /\\ ~P(x,x)) "</span> ^
      <span class="inner_quoted">"==&gt; ~(exists z. forall x. P(x,z))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p42 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"~(exists y. forall x. P(x,y) &lt;=&gt; ~(exists z. P(x,z) /\\ P(z,x)))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p44 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. P(x) ==&gt; (exists y. G(y) /\\ H(x,y)) /\\ "</span> ^
      <span class="inner_quoted">"(exists y. G(y) /\\ ~H(x,y))) /\\ "</span> ^
      <span class="inner_quoted">"(exists x. J(x) /\\ (forall y. G(y) ==&gt; H(x,y))) ==&gt; "</span> ^
      <span class="inner_quoted">"(exists x. J(x) /\\ ~P(x))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p45 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. "</span> ^
        <span class="inner_quoted">"P(x) /\\ (forall y. G(y) /\\ H(x,y) ==&gt; J(x,y)) ==&gt; "</span> ^
             <span class="inner_quoted">"(forall y. G(y) /\\ H(x,y) ==&gt; R(y))) /\\ "</span> ^
      <span class="inner_quoted">"~(exists y. L(y) /\\ R(y)) /\\ "</span> ^
      <span class="inner_quoted">"(exists x. P(x) /\\ (forall y. H(x,y) ==&gt; "</span> ^
        <span class="inner_quoted">"L(y)) /\\ (forall y. G(y) /\\ H(x,y) ==&gt; J(x,y))) ==&gt; "</span> ^
      <span class="inner_quoted">"(exists x. P(x) /\\ ~(exists y. G(y) /\\ H(x,y)))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p55 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"lives(agatha) /\\ lives(butler) /\\ lives(charles) /\\ "</span> ^
      <span class="inner_quoted">"(killed(agatha,agatha) \\/ killed(butler,agatha) \\/ "</span> ^
       <span class="inner_quoted">"killed(charles,agatha)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y. killed(x,y) ==&gt; hates(x,y) /\\ ~richer(x,y)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. hates(agatha,x) ==&gt; ~hates(charles,x)) /\\ "</span> ^
      <span class="inner_quoted">"(hates(agatha,agatha) /\\ hates(agatha,charles)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. lives(x) /\\ ~richer(x,agatha) ==&gt; hates(butler,x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. hates(agatha,x) ==&gt; hates(butler,x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x. ~hates(x,agatha) \\/ ~hates(x,butler) \\/ ~hates(x,charles)) "</span> ^
      <span class="inner_quoted">"==&gt; killed(agatha,agatha) /\\ "</span> ^
             <span class="inner_quoted">"~killed(butler,agatha) /\\ "</span> ^
             <span class="inner_quoted">"~killed(charles,agatha)"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p57 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"P(f(a,b),f(b,c)) /\\ "</span> ^
      <span class="inner_quoted">"P(f(b,c),f(a,c)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y z. P(x,y) /\\ P(y,z) ==&gt; P(x,z)) "</span> ^
      <span class="inner_quoted">"==&gt; P(f(a,b),f(a,c))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p59 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"(forall x. P(x) &lt;=&gt; ~P(f(x))) ==&gt; (exists x. P(x) /\\ ~P(f(x)))"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* Pelletier p60 *)</span>

<span class="entity">auto</span> <span class="inner_quoted">"forall x. P(x,f(x)) &lt;=&gt; exists y. (forall z. P(z,y) ==&gt; P(z,f(x))) /\\ P(x,y)"</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* gilmore_3 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"exists x. forall y z. "</span> ^
              <span class="inner_quoted">"((F(y,z) ==&gt; (G(y) ==&gt; H(x))) ==&gt; F(x,x)) /\\ "</span> ^
              <span class="inner_quoted">"((F(z,x) ==&gt; G(x)) ==&gt; H(z)) /\\ "</span> ^
              <span class="inner_quoted">"F(x,y) "</span> ^
              <span class="inner_quoted">"==&gt; F(z,z)"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* gilmore_4 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"exists x y. forall z. "</span> ^
              <span class="inner_quoted">"(F(x,y) ==&gt; F(y,z) /\\ F(z,z)) /\\ "</span> ^
              <span class="inner_quoted">"(F(x,y) /\\ G(x,y) ==&gt; G(x,z) /\\ G(z,z))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* gilmore_5 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. exists y. F(x,y) \\/ F(y,x)) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y. F(y,x) ==&gt; F(y,y)) "</span> ^
      <span class="inner_quoted">"==&gt; exists z. F(z,z)"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* gilmore_6 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"forall x. exists y. "</span> ^
              <span class="inner_quoted">"(exists u. forall v. F(u,x) ==&gt; G(v,u) /\\ G(u,x)) "</span> ^
              <span class="inner_quoted">"==&gt; (exists u. forall v. F(u,y) ==&gt; G(v,u) /\\ G(u,y)) \\/ "</span> ^
                        <span class="inner_quoted">"(forall u v. exists w. G(v,u) \\/ H(w,y,u) ==&gt; G(u,w))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* gilmore_7 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. K(x) ==&gt; exists y. L(y) /\\ (F(x,y) ==&gt; G(x,y))) /\\ "</span> ^
      <span class="inner_quoted">"(exists z. K(z) /\\ forall u. L(u) ==&gt; F(z,u)) "</span> ^
      <span class="inner_quoted">"==&gt; exists v w. K(v) /\\ L(w) /\\ G(v,w)"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* gilmore_8 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"exists x. forall y z. "</span> ^
              <span class="inner_quoted">"((F(y,z) ==&gt; (G(y) ==&gt; (forall u. exists v. H(u,v,x)))) ==&gt; F(x,x)) /\\ "</span> ^
              <span class="inner_quoted">"((F(z,x) ==&gt; G(x)) ==&gt; (forall u. exists v. H(u,v,z))) /\\ "</span> ^
              <span class="inner_quoted">"F(x,y) "</span> ^
              <span class="inner_quoted">"==&gt; F(z,z)"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* gilmore_9 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"forall x. exists y. forall z. "</span> ^
              <span class="inner_quoted">"((forall u. exists v. F(y,u,v) /\\ G(y,u) /\\ ~H(y,x)) "</span> ^
                   <span class="inner_quoted">"==&gt; (forall u. exists v. F(x,u,v) /\\ G(z,u) /\\ ~H(x,z)) "</span> ^
                   <span class="inner_quoted">"==&gt; (forall u. exists v. F(x,u,v) /\\ G(y,u) /\\ ~H(x,y))) /\\ "</span> ^
              <span class="inner_quoted">"((forall u. exists v. F(x,u,v) /\\ G(y,u) /\\ ~H(x,y)) "</span> ^
                  <span class="inner_quoted">"==&gt; ~(forall u. exists v. F(x,u,v) /\\ G(z,u) /\\ ~H(x,z)) "</span> ^
                  <span class="inner_quoted">"==&gt; (forall u. exists v. F(y,u,v) /\\ G(y,u) /\\ ~H(y,x)) /\\ "</span> ^
                         <span class="inner_quoted">"(forall u. exists v. F(z,u,v) /\\ G(y,u) /\\ ~H(z,y)))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* davis_putnam_example *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"exists x. exists y. forall z. "</span> ^
      <span class="inner_quoted">"(F(x,y) ==&gt; (F(y,z) /\\ F(z,z))) /\\ "</span> ^
      <span class="inner_quoted">"((F(x,y) /\\ G(x,y)) ==&gt; (G(x,z) /\\ G(z,z)))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* ewd1062_1 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. x &lt;= x) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y z. x &lt;= y /\\ y &lt;= z ==&gt; x &lt;= z) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y. f(x) &lt;= y &lt;=&gt; x &lt;= g(y)) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x y. x &lt;= y ==&gt; f(x) &lt;= f(y))"</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="comment1">(* ewd1062_2 *)</span>

<span class="entity">auto</span> <span class="main">(</span><span class="inner_quoted">"(forall x. x &lt;= x) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y z. x &lt;= y /\\ y &lt;= z ==&gt; x &lt;= z) /\\ "</span> ^
      <span class="inner_quoted">"(forall x y. f(x) &lt;= y &lt;=&gt; x &lt;= g(y)) "</span> ^
      <span class="inner_quoted">"==&gt; (forall x y. x &lt;= y ==&gt; g(x) &lt;= g(y))"</span><span class="main">)</span>

›</span>

<span class="comment1">(*

Non-terminating examples

ML_val {* (* ewd1062 *)

auto ("(forall x. x &lt;= x) /\\ " ^
      "(forall x y z. x &lt;= y /\\ y &lt;= z ==&gt; x &lt;= z) /\\ " ^
      "(forall x y. f(x) &lt;= y &lt;=&gt; x &lt;= g(y)) " ^
      "==&gt; (forall x y. x &lt;= y ==&gt; f(x) &lt;= f(y)) /\\ " ^
          "(forall x y. x &lt;= y ==&gt; g(x) &lt;= g(y))")

*}

ML_val {* (* Pelletier p34 / page 178 Andrews's challenge *)

auto ("((exists x. forall y. P(x) &lt;=&gt; P(y)) &lt;=&gt; " ^
    "((exists x. Q(x)) &lt;=&gt; (forall y. Q(y)))) &lt;=&gt; " ^
   "((exists x. forall y. Q(x) &lt;=&gt; Q(y)) &lt;=&gt; " ^
    "((exists x. P(x)) &lt;=&gt; (forall y. P(y))))")

*}

ML_val {* (* Pelletier p43 *)

auto "(forall x y. Q(x,y) &lt;=&gt; forall z. P(z,x) &lt;=&gt; P(z,y)) ==&gt; forall x y. Q(x,y) &lt;=&gt; Q(y,x)"

*}

ML_val {* (* Pelletier p46 *)

auto ("(forall x. P(x) /\\ (forall y. P(y) /\\ H(y,x) ==&gt; G(y)) ==&gt; G(x)) /\\ " ^
        "((exists x. P(x) /\\ ~G(x)) ==&gt; " ^
          "(exists x. P(x) /\\ ~G(x) /\\ (forall y. P(y) /\\ ~G(y) ==&gt; J(x,y)))) /\\ " ^
        "(forall x y. P(x) /\\ P(y) /\\ H(x,y) ==&gt; ~J(y,x)) ==&gt; " ^
        "(forall x. P(x) ==&gt; G(x))")

*}

ML_val {* (* Pelletier p56 *)

auto ("(forall x. (exists y. P(y) /\\ x = f(y)) ==&gt; P(x)) &lt;=&gt; (forall x. P(x) ==&gt; P(f(x)))")

*}

ML_val {* (* Correct Pelletier p58 *)

auto "(forall x y. f(x) = g(y)) ==&gt; (forall x y. f(f(x)) = f(g(y)))"

*}

ML_val {* (* gilmore_1 *)

auto ("exists x. forall y z. " ^
        "((F(y) ==&gt; G(y)) &lt;=&gt; F(x)) /\\ " ^
        "((F(y) ==&gt; H(y)) &lt;=&gt; G(x)) /\\ " ^
        "(((F(y) ==&gt; G(y)) ==&gt; H(y)) &lt;=&gt; H(x)) " ^
          "==&gt; F(z) /\\ G(z) /\\ H(z)")

*}

ML_val {* (* gilmore_2 has a counterexample *)

auto ("exists x y. forall z. (F(x,z) &lt;=&gt; F(z,y)) /\\ (F(z,y) &lt;=&gt; F(z,z)) /\\ (F(x,y) &lt;=&gt; F(y,x)) " ^
      "==&gt; (F(x,y) &lt;=&gt; F(x,z))")

*}

*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>