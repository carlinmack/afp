<div id="Option_Binders">
<div class="head">
<h1>Theory Option_Binders</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Binders for the option type \label{sect:binders}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Option_Binders
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following functions are used as binders in the theorems that are proven.
  At all times, when a result is None, the theorem becomes vacuously true.
  The expression ``$m \rightharpoonup \alpha$'' means ``First compute $m$, if it is None then return True, otherwise pass the result to $\alpha$''.
  B2 is a short hand for sequentially doing two independent computations. The following syntax is associated to B2:
  ``$m_1 || m_2 \rightharpoonup \alpha$'' represents ``First compute $m_1$ and $m_2$, if one of them is None then return True, otherwise pass the result to $\alpha$''.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⇀</span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">a</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">B2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"B2"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> option<span class="main">,</span> <span class="tfree">'a</span> option<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">∥</span> _ <span class="keyword1">⇀</span> _<span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>


  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Some rewriting rules for the binders
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rewrite_B2_to_cases<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"B2 <span class="free">s</span> <span class="free">t</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">s</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span>Some <span class="bound">s1</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span>Some <span class="bound">t1</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">s1</span> <span class="bound">t1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> B2_def B_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> rewrite_B_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"None <span class="main">⇀</span> <span class="free">α</span> <span class="main">=</span> True"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> rewrite_B_m_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> rewrite_B2_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span>Some <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">b</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span>Some <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strict_equal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">strict_equal</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> <span class="main">(</span>Some <span class="bound">a'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="List_Theorems">
<div class="head">
<h1>Theory List_Theorems</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Theorems on lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> List_Theorems
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Returns the last n elements of list x *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lastn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lastn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> drop <span class="main">(</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="comment1">(* Returns true iff [a,b] is a sequence in list x. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_sub_seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sub_seq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">n</span> <span class="main">.</span> Suc <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">!</span><span class="bound">n</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">!</span><span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="comment1">(* Return, given a set of lists, the set with all prefixes of all the lists *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prefixes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> take <span class="bound">n</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> drop_one<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> tl <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> length_ge_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> length <span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> take_but_one<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> lastn <span class="main">(</span><span class="main">(</span>length <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> tl <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lastn_def
  <span class="keyword1"><span class="command">using</span></span> length_ge_one<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> Suc_m_minus_n<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟶</span> Suc <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> lastn_one_less<span class="main">:</span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">x</span> <span class="main">∧</span> lastn <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">y</span><span class="main">)</span> <span class="main">⟶</span> lastn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lastn_def
 <span class="keyword1"><span class="command">using</span></span> drop_Suc<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span> drop_tl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> list_sub_implies_member<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">.</span> set <span class="main">(</span><span class="bound">a</span><span class="main">#</span><span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Z</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> subset_smaller_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">.</span> set <span class="main">(</span><span class="bound">a</span><span class="main">#</span><span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Z</span> <span class="main">⟶</span> set <span class="bound">x</span> <span class="main">⊆</span> <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> second_elt_is_hd_tl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">x'</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">a</span> <span class="main">=</span> <span class="free">x</span> <span class="main">!</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> length_ge_2_implies_tl_not_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟶</span> tl <span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> length_lt_2_implies_tl_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟶</span> tl <span class="free">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>  
<span class="keyword1"><span class="command">lemma</span></span> first_second_is_sub_seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> is_sub_seq <span class="main">(</span>hd <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">!</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> hd <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_sub_seq <span class="main">(</span>hd <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">!</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_sub_seq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemma</span></span> hd_drop_is_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">x</span> <span class="main">⟹</span> hd <span class="main">(</span>drop <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">!</span><span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x</span><span class="main">)</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> def_of_hd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="free">x</span> <span class="main">⟶</span> hd <span class="free">y</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> def_of_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="free">x</span> <span class="main">⟶</span> tl <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">lemma</span></span> drop_yields_results_implies_nbound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> consecutive_is_sub_seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> lastn <span class="free">n</span> <span class="free">y</span> <span class="main">⟹</span> is_sub_seq <span class="free">a</span> <span class="free">b</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> lastn <span class="free">n</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 drop_Suc<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">y</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">y</span>"</span></span><span class="main">]</span>
       drop_tl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">y</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">y</span>"</span></span><span class="main">]</span> 
       def_of_tl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"lastn <span class="free">n</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x <span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">#</span><span class="free">x</span>"</span></span><span class="main">]</span>
       drop_yields_results_implies_nbound<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">y</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">y</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lastn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 3 1 hd_drop_is_nth<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">y</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span><span class="main">]</span> def_of_hd<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="free">y</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">#</span><span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">!</span><span class="main">(</span>length <span class="free">y</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> lastn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 3 1 hd_drop_is_nth<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="main">(</span>length <span class="free">y</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span><span class="main">]</span> def_of_hd<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">y</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span>
       drop_Suc<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">y</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">y</span>"</span></span><span class="main">]</span>
       drop_tl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">y</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">y</span>"</span></span><span class="main">]</span> 
       def_of_tl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"lastn <span class="free">n</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x <span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">#</span><span class="free">x</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">!</span>Suc <span class="main">(</span>length <span class="free">y</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lastn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 3 4 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_sub_seq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sub_seq_in_prefixes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> prefixes <span class="free">X</span><span class="main">.</span> is_sub_seq <span class="free">a</span> <span class="free">a'</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> is_sub_seq <span class="free">a</span> <span class="free">a'</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> prefixes <span class="free">X</span> <span class="main">∧</span> is_sub_seq <span class="free">a</span> <span class="free">a'</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> take <span class="skolem">n</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prefixes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> y <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_seq_index<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">!</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="free">a'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_sub_seq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sub_seq_index x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_sub_seq <span class="free">a</span> <span class="free">a'</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_sub_seq_def <span class="keyword1"><span class="command">using</span></span> nth_take <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> this x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_tl_is_subset<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>tl <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> x_is_hd_snd_tl<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>hd <span class="free">x</span><span class="main">)</span> <span class="main">#</span> <span class="free">x</span><span class="main">!</span><span class="main">1</span> <span class="main">#</span> tl<span class="main">(</span>tl <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tl_x_not_x<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> tl <span class="free">x</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> tl_hd_x_not_tl_x<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> tl <span class="main">(</span>hd <span class="free">x</span><span class="main">)</span> <span class="main">#</span> tl <span class="free">x</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tl_x_not_x <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="K">
<div class="head">
<h1>Theory K</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A generic model for separation kernels \label{sect:generic}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> K
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="List_Theorems.html">List_Theorems</a> <a href="Option_Binders.html">Option_Binders</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
{\em
  This section defines a detailed generic model of separation kernels
  called CISK (Controlled Interruptible Separation Kernel).  It
  contains a generic functional model of the behaviour of a separation kernel
  as a transition system, definitions of
  the security property and proofs that the functional model satisfies 
  security properties. It is based on Rushby's approach \cite{Rushby1992noninterference}
  for  noninterference.  For an explanation of the model, its structure and
  an overview of the proofs, we refer to the document entitled ``A New
  Theory of Intransitive Noninterference for Separation Kernels with
  Control''~\cite{Verbeek2013}.

  The structure of the model is based on locales and refinement:
  \begin{itemize}
  \item locale ``Kernel" defines a highly generic model for a kernel, with execution semantics. 
        It defines a state transition system with some extensions to the one
        used in \cite{Rushby1992noninterference}.
        The transition system defined here stores the currently active
        domain in the state, and has transitions for explicit
        context switches and interrupts and provides a notion of control.
        As each operation of the system will be split into atomic actions 
        in our model, only certain sequences of actions will correspond to a run on a
        real system. Therefore, 
        the function $run$, which applies an execution on a state and computes the resulting
        new state, is partial and defined for realistic traces only.
        Later, but not in this locale, we will define a predicate to distinguish 
        realistic traces from other traces.
        Security properties are also not part of this locale, but will
        be introduced in the locales to be described next.
  \item locale ``Separation\_Kernel" extends "Kernel" with constraints concerning non-interference.
        The theorem is only sensical for realistic traces; for unrealistic trace it will hold vacuously.
  \item locale ``Interruptible\_Separation\_Kernel" refines ``Separation\_Kernel" with interruptible action sequences.
        It defines function ``realistic\_trace'' based on these action sequences.
        Therefore, we can formulate a total run function.
  \item locale ``Controlled\_Interruptible\_Separation\_Kernel" refines ``Interruptible\_Separation\_Kernel" with abortable action sequences.
        It refines function ``control'' which now uses a generic predicate ``aborting'' and a generic function ``set\_error\_code''
        to manage aborting of action sequences.
  \end{itemize}
  }
›</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹K (Kernel)›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The model makes use of the following types:
\begin{description}
\item['state\_t] A state  contains information about the resources of the system, 
                 as well as which domain is currently active.
We decided that a state does \emph{not} need to include a program stack, as in this model the actions that are executed are modelled separately. 
\item['dom\_t] A domain is an entity executing actions and making calls to the kernel. 
               This type represents the names of all domains.
               Later on, we define security policies in terms of domains. 
\item['action\_t] Actions of type 'action\_t represent atomic instructions that are executed by the kernel.
As kernel actions are assumed to be atomic, we assume that after each kernel action an interrupt point can occur.
\item['action\_t execution] An execution of some domain is the code or the program that is executed by the domain.
One call from a domain to the kernel will typically trigger a succession of one or more kernel actions.
Therefore, an execution is represented as a list of \emph{sequences} of kernel actions.
Non-kernel actions are not take into account. 
\item['output\_t] Given the current state and an action an output can be computed deterministically.
\item[time\_t] Time is modelled using natural numbers. Each atomic kernel action can be executed within one time unit.
\end{description}
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'action_t</span><span class="main">)</span> execution <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> list list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> time_t <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Function \emph{kstep} (for kernel step) computes the next state based on the current state $s$ and a given action $a$.
  It may assume that it makes sense to perform this action, i.e., that any precondition that is necessary for execution of action $a$ in state $s$ is met.
  If not, it may return any result. This precondition is represented by generic predicate \emph{kprecondition} (for kernel precondition).
  Only realistic traces are considered. Predicate \emph{realistic\_execution} decides whether a given execution is realistic.
  
  Function \emph{current} returns given the state the domain that is currently executing actions. The model assumes a single-core setting, i.e., at all times only one domain is active.
  Interrupt behavior is modelled using functions \emph{interrupt} and \emph{cswitch} (for context switch) that dictate respectively  when interrupts occur and how interrupts occur.
  Interrupts are solely time-based, meaning that there is an at beforehand fixed schedule dictating which domain is active at which time.
  
  Finally, we add function \emph{control}.
  This function represents control of the kernel over the execution as performed by the domains.
  Given the current state $s$, the currently active domain $d$ and the execution $\alpha$ of that domain,
  it returns three objects.
  First, it returns the next action that domain $d$ will perform. Commonly, this is the next action in execution $\alpha$. It may also return None, indicating that no action is done.
  Secondly, it returns the updated execution. When executing action $a$, typically, this action will be removed from the current execution (i.e., updating the program stack).
  Thirdly, it can update the state to set, e.g., error codes.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Kernel <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">kstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">output_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'output_t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state_t</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">current</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">=&gt;</span> <span class="tfree">'dom_t</span>"</span></span> <span class="comment1">(* "Returns the currently active domain"*)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cswitch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span> <span class="comment1">(* "Switches the current domain" *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">interrupt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> bool"</span></span> <span class="comment1">(* "Returns t iff an interrupt occurs in the given state at the given time"*)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">kprecondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">(* "Returns t if an precondition holds that relates the current action to the state" *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">realistic_execution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> execution <span class="main">⇒</span> bool"</span></span> <span class="comment1">(* "In this locale, this function is completely unconstrained." *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">control</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution <span class="main">⇒</span>
                              <span class="main">(</span><span class="main">(</span><span class="tfree">'action_t</span> option<span class="main">)</span> <span class="main">×</span> <span class="tfree">'action_t</span> execution <span class="main">×</span> <span class="tfree">'state_t</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">kinvolved</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Execution semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Short hand notations for using function control.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_action</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">next_action</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> fst <span class="main">(</span><span class="free">control</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_execs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">next_execs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="main">(</span>fun_upd <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="free">control</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>  <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_state</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">next_state</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="free">control</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>  <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A thread is empty iff either it has no further action sequences to execute, or when the current action sequence is finished and there are no further action sequences to execute.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">thread_empty</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> execution <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">thread_empty</span> <span class="free"><span class="bound"><span class="entity">exec</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">exec</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">exec</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Wrappers for function kstep and kprecondition that deal with the case where the given action is None.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">|</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">kstep</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">precondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> option <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">precondition</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⇀</span> <span class="free">kprecondition</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">involved</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">involved</span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">kinvolved</span> <span class="bound">a</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Execution semantics are defined as follows: a run consists of consecutively running sequences of actions.
  These sequences are interruptable.
  Run first checks whether an interrupt occurs.
  When this happens, function cswitch may switch the context.
  Otherwise, function control is used to determine the next action $a$, which also yields a new state $s'$.
  Action $a$ is executed by executing (step $s'$ $a$).
  The current execution of the current domain is updated. 
  
  Note that run is a partial function, i.e., it computes results only when at all times the preconditions hold.
  Such runs are the realistic ones. For other runs, we do not need to -- and cannot -- prove security.
  All the theorems are formulated in such a way that they hold vacuously for unrealistic runs.
›</span></span> 
<span class="keyword1"><span class="command">function</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> <span class="tfree">'state_t</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'state_t</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> None <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> thread_empty<span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>thread_empty<span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>precondition <span class="main">(</span>next_state <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span> <span class="main">(</span>next_action <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>thread_empty<span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> precondition <span class="main">(</span>next_state <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span> <span class="main">(</span>next_action <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">run</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span>  <span class="main">(</span>next_action <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> not0_implies_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.exhaust prod_cases3<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SK">
<div class="head">
<h1>Theory SK</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹SK (Separation Kernel) \label{sec:sep_kernel}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SK
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="K.html">K</a>
<span class="keyword2"><span class="keyword">begin</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Locale Kernel is now refined to a generic model of a separation kernel.
  The security policy is represented using function \emph{ia}.
  Function \emph{vpeq} is adopted from Rushby and is an equivalence relation represeting whether two states are equivalent from the point of view of the given domain.   
  
  We assume constraints similar to Rushby, i.e., weak step consistency, locally respects, and output consistency.
  Additional assumptions are:
  \begin{description}
  \item[Step Atomicity] Each atomic kernel step can be executed within one time slot. Therefore, the domain that is currently active does not change by executing one action.
  \item[Time-based Interrupts] As interrupts occur according to a prefixed time-based schedule, the domain that is active after a call of switch depends on the currently active domain only (cswitch\_consistency).
  Also, cswitch can \emph{only} change which domain is currently active (cswitch\_consistency).
  \item[Control Consistency] States that are equivalent yield the same control. That is, the next action and the updated execution depend on the currently active domain only (next\_action\_consistent, next\_execs\_consistent),
  the state as updated by the control function remains in vpeq (next\_state\_consistent, locally\_respects\_next\_state).
  Finally, function control cannot change which domain is active (current\_next\_state).
  \end{description}
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">actions_in_execution</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> execution <span class="main">⇒</span> <span class="tfree">'action_t</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">actions_in_execution</span> <span class="free"><span class="bound"><span class="entity">exec</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">aseq</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">exec</span></span></span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="bound">aseq</span> <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">locale</span></span> Separation_Kernel <span class="main">=</span> Kernel <span class="quoted"><span class="free">kstep</span></span> <span class="quoted"><span class="free">output_f</span></span> <span class="quoted"><span class="free">s0</span></span> <span class="quoted"><span class="free">current</span></span> <span class="quoted"><span class="free">cswitch</span></span> <span class="quoted"><span class="free">interrupt</span></span> <span class="quoted"><span class="free">kprecondition</span></span> <span class="quoted"><span class="free">realistic_execution</span></span> <span class="quoted"><span class="free">control</span></span> <span class="quoted"><span class="free">kinvolved</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">kstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">output_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'output_t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state_t</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">current</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">=&gt;</span> <span class="tfree">'dom_t</span>"</span></span> <span class="comment1">― ‹Returns the currently active domain›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cswitch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span> <span class="comment1">― ‹Switches the current domain›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">interrupt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns t iff an interrupt occurs in the given state at the given time›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">kprecondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns t if an precondition holds that relates the current action to the state›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">realistic_execution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> execution <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹In this locale, this function is completely unconstrained.›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">control</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'action_t</span> option<span class="main">)</span> <span class="main">×</span> <span class="tfree">'action_t</span> execution <span class="main">×</span> <span class="tfree">'state_t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">kinvolved</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> set"</span></span>  
<span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ifp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vpeq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> vpeq_transitive<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vpeq_symmetric<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">u</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">b</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vpeq_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">u</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifp_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">u</span> <span class="bound">u</span>"</span></span>     
    <span class="keyword2"><span class="keyword">and</span></span> weakly_step_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">kprecondition</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">kprecondition</span> <span class="bound">t</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span>  <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> locally_respects<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">.</span> <span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span>  <span class="main">∧</span> <span class="free">kprecondition</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> output_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">output_f</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">output_f</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_atomicity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">current</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cswitch_independent_of_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cswitch_consistency<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> next_action_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> next_action <span class="bound">s</span> <span class="bound">execs</span> <span class="main">=</span> next_action <span class="bound">t</span> <span class="bound">execs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> next_execs_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> fst <span class="main">(</span>snd <span class="main">(</span><span class="free">control</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span><span class="free">control</span> <span class="bound">t</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> next_state_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">(</span>next_state <span class="bound">t</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> current_next_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">current</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> locally_respects_next_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">u</span> <span class="bound">execs</span><span class="main">.</span> <span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> involved_ifp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">(</span>involved <span class="bound">a</span><span class="main">)</span> <span class="main">.</span> <span class="free">kprecondition</span> <span class="bound">s</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">ifp</span> <span class="bound">d</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span>"</span></span>    
    <span class="keyword2"><span class="keyword">and</span></span> next_action_from_execs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="main">.</span> next_action <span class="bound">s</span> <span class="bound">execs</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> actions_in_execution <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> next_execs_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">execs</span> <span class="bound">u</span> <span class="main">.</span> actions_in_execution <span class="main">(</span>next_execs <span class="bound">s</span> <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⊆</span> actions_in_execution <span class="main">(</span><span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Note that there are no proof obligations on function ``interrupt''.
  Its typing enforces the assumptions that switching is based on time and not on state.
  This assumption is sufficient for these proofs, i.e., no further assumptions are required.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Security for non-interfering domains›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define security for domains that are completely non-interfering.
  That is, for all domains $u$ and $v$ such that $v$ may not interfere in any way with domain $u$, we prove that the behavior of domain $u$ is independent of the actions performed by $v$.
  In other words, the output of domain $u$ in some run is at all times equivalent to the output of domain $u$ when the actions of domain $v$ are replaced by some other set actions.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A domain is unrelated to $u$ if and only if the security policy dictates that there is no path from the domain to $u$.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">unrelated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">unrelated</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To formulate the new theorem to prove, we redefine purging: all domains that may not influence domain u are replaced by arbitrary action sequences.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">purge</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">purge</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">d</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> unrelated <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span>
                                <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">alpha</span> <span class="main">.</span> <span class="free">realistic_execution</span> <span class="bound">alpha</span><span class="main">)</span>
                              <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="bound">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A normal run from initial state $s0$ ending in state $s\_f$ is equivalent to a run purged for domain $(\mbox{current} s\_f)$.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NI_unrelated</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NI_unrelated</span>
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs</span> <span class="bound">a</span> <span class="bound">n</span> <span class="main">.</span> run <span class="bound">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="bound">execs</span> <span class="main">⇀</span>
                   <span class="main">(</span><span class="main">λ</span> <span class="bound">s_f</span> <span class="main">.</span> run <span class="bound">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>purge <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span>
                                  <span class="main">(</span><span class="main">λ</span> <span class="bound">s_f2</span> <span class="main">.</span> <span class="free">output_f</span> <span class="bound">s_f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="bound">s_f2</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s_f</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s_f2</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following properties are proven inductive over states $s$ and $t$:
\begin{enumerate}
\item Invariably, states $s$ and $t$ are equivalent for any domain $v$ that may influence the purged domain $u$.
This is more general than proving that ``vpeq u s t'' is inductive. The reason we need to prove equivalence
over all domains $v$ is so that we can use \emph{weak} step consistency.
\item Invariably, states $s$ and $t$ have the same active domain.\
\end{enumerate}
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">equivalent_states</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> option  <span class="main">⇒</span> <span class="tfree">'state_t</span> option <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">equivalent_states</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∥</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Rushby's view partitioning is redefined.
  Two states that are initially $u$-equivalent are $u$-equivalent after performing respectively a realistic run and a realistic purged run.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">view_partitioned</span><span class="main">::</span><span class="quoted">bool</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">view_partitioned</span>
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs</span> <span class="bound">ms</span> <span class="bound">mt</span> <span class="bound">n</span> <span class="bound">u</span> <span class="main">.</span> equivalent_states <span class="bound">ms</span> <span class="bound">mt</span> <span class="bound">u</span>  <span class="main">⟶</span>
        <span class="main">(</span>run <span class="bound">n</span> <span class="bound">ms</span> <span class="bound">execs</span> <span class="main">∥</span>
         run <span class="bound">n</span> <span class="bound">mt</span> <span class="main">(</span>purge <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⇀</span>
         <span class="main">(</span><span class="main">λ</span> <span class="bound">rs</span> <span class="bound">rt</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">rs</span> <span class="bound">rt</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">rt</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We formulate a version of predicate view\_partitioned that is on one hand more general, but on the other hand easier to prove inductive over function run. 
  Instead of reasoning over execs and (purge execs u), we reason over any two executions execs1 and execs2 for which the following relation holds:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">purged_relation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">purged_relation</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">execs1</span></span></span> <span class="free"><span class="bound"><span class="entity">execs2</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">execs1</span></span></span> <span class="bound">d</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">execs2</span></span></span> <span class="bound">d</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  The inductive version of view partitioning says that runs on two states that are $u$-equivalent and on two executions that are purged\_related yield $u$-equivalent states.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">view_partitioned_ind</span><span class="main">::</span><span class="quoted">bool</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">view_partitioned_ind</span>
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs1</span> <span class="bound">execs2</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">n</span> <span class="bound">u</span> <span class="main">.</span> equivalent_states <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">∧</span> purged_relation <span class="bound">u</span> <span class="bound">execs1</span> <span class="bound">execs2</span> <span class="main">⟶</span> equivalent_states <span class="main">(</span>run <span class="bound">n</span> <span class="bound">s</span> <span class="bound">execs1</span><span class="main">)</span> <span class="main">(</span>run <span class="bound">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span> <span class="bound">u</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A proof that when state $t$ performs a step but state $s$ not, the states remain equivalent for any domain $v$ that may interfere with $u$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> vpeq_s_nt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_ifp_curr_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">t</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="free">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> ifp_v_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="skolem">v</span> <span class="free">u</span>"</span></span>
    
    <span class="keyword1"><span class="command">from</span></span> ifp_v_u not_ifp_curr_u <span class="keyword1"><span class="command">have</span></span> unrelated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rtranclp_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> this current_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span><span class="main">]</span>
         locally_respects<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="free">t</span> <span class="free">execs2</span>"</span></span><span class="main">]</span> vpeq_reflexive
         prec_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>next_state <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="free">t</span> <span class="free">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> unrelated this locally_respects_next_state vpeq_transitive <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">t</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> ifp_v_u <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> vpeq_symmetric <span class="keyword2"><span class="keyword">and</span></span> vpeq_transitive <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A proof that when state $s$ performs a step but state $t$ not, the states remain equivalent for any domain $v$ that may interfere with $u$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> vpeq_ns_t<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_ifp_curr_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> ifp_v_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="skolem">v</span> <span class="free">u</span>"</span></span>
    
    <span class="keyword1"><span class="command">from</span></span> ifp_v_u <span class="keyword2"><span class="keyword">and</span></span> not_ifp_curr_u <span class="keyword1"><span class="command">have</span></span> unrelated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rtranclp_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> this current_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span><span class="main">]</span> vpeq_reflexive
         unrelated locally_respects<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="free">s</span> <span class="free">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span>"</span></span><span class="main">]</span> prec_s
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="free">s</span> <span class="free">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> unrelated this locally_respects_next_state vpeq_transitive <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> ifp_v_u <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> vpeq_symmetric <span class="keyword2"><span class="keyword">and</span></span> vpeq_transitive <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A proof that when both states $s$ and $t$ perform a step, the states remain equivalent for any domain $v$ that may interfere with $u$.
  It assumes that the current domain \emph{can} interact with $u$ (the domain for which is purged).
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> vpeq_ns_nt_ifp_u<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="free">s</span> <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="free">s</span> <span class="main">=</span> <span class="free">current</span> <span class="free">t'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="free">a</span> <span class="main">∧</span> precondition <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span> <span class="main">⟹</span>  <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> precs<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">∧</span> precondition <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ifp_curr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_curr_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ifp_curr precs
    next_state_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t'</span></span><span class="main">]</span> vpeq_curr_s_t vpeq_s_t
    current_next_state current_s_t weakly_step_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x3<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="free">s</span> <span class="free">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="free">t'</span> <span class="free">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="skolem">a</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
      
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A proof that when both states $s$ and $t$ perform a step, the states remain equivalent for any domain $v$ that may interfere with $u$.
  It assumes that the current domain \emph{cannot} interact with $u$ (the domain for which is purged).
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> vpeq_ns_nt_not_ifp_u<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> purged_a_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"purged_relation <span class="free">u</span> <span class="free">execs</span> <span class="free">execs2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="free">s</span> <span class="main">=</span> <span class="free">current</span> <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="free">s</span> <span class="free">t'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span> <span class="main">∧</span> precondition <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_ifp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> prec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">a'</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> ifp_v_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="skolem">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> not_ifp <span class="keyword2"><span class="keyword">and</span></span> purged_a_a2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> purged_relation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> ifp_v_u <span class="keyword1"><span class="command">have</span></span> not_ifp_curr_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rtranclp_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> this current_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">execs</span></span><span class="main">]</span> prec_s vpeq_reflexive
       locally_respects<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="free">s</span> <span class="free">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="free">s</span> <span class="free">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> not_ifp_curr_v this locally_respects_next_state vpeq_transitive
      <span class="keyword1"><span class="command">have</span></span> vpeq_s_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> not_ifp_curr_v current_s_t current_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">execs2</span></span><span class="main">]</span> prec_t
       locally_respects<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="free">t'</span> <span class="free">execs2</span>"</span></span><span class="main">]</span> vpeq_reflexive
       <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="free">t'</span> <span class="free">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> not_ifp_curr_v current_s_t current_next_state <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="free">t'</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rtranclp_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 0 1 locally_respects_next_state vpeq_transitive 
       <span class="keyword1"><span class="command">have</span></span> vpeq_t_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">t'</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> vpeq_s_ns <span class="keyword2"><span class="keyword">and</span></span> vpeq_t_nt <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> ifp_v_u <span class="keyword2"><span class="keyword">and</span></span> vpeq_symmetric <span class="keyword2"><span class="keyword">and</span></span> vpeq_transitive
      <span class="keyword1"><span class="command">have</span></span> vpeq_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">t'</span> <span class="free">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A run with a purged list of actions appears identical to a run without purging, when starting from two states that appear identical.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> unwinding_implies_view_partitioned_ind<span class="main">:</span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">view_partitioned_ind</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">execs2</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">n</span> <span class="skolem">u</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="main">∧</span> purged_relation <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span> <span class="main">⟶</span> equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">execs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">execs2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> run.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> interrupt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs2</span><span class="main">.</span>
           equivalent_states <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">∧</span> purged_relation <span class="bound">u</span> <span class="skolem">execs</span> <span class="bound">execs2</span> <span class="main">⟶</span>
           equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs</span>
      <span class="keyword3"><span class="command">assume</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">rs</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rt</span>
      <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span> <span class="main">=</span> Some <span class="skolem">rt</span>"</span></span>
      
      <span class="keyword3"><span class="command">assume</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> purged_a_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"purged_relation <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span>"</span></span>

      <span class="comment1">― ‹The following terminology is used: states rs and rt (for: run-s and run-t) are the states after a run.
         States ns and nt (for: next-s and next-t) are the states after one step.›</span>
      <span class="comment1">― ‹We prove two properties: the states rs and rt have equal active domains (current-rs-rt) and are vpeq for all domains v that may influence u (vpeq-rs-rt).
          Both are proven using the IH.
          To use the IH, we have to prove that the properties hold for the next step (in this case, a context switch).
          Statement current-ns-nt states that after one step states ns and nt have the same active domain.
          Statement vpeq-ns-nt states that after one step states ns and nt are vpeq for all domains v that may influence u (vpeq-rs-rt).›</span>
      <span class="keyword1"><span class="command">from</span></span> current_s_t cswitch_independent_of_state
        <span class="keyword1"><span class="command">have</span></span> current_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> cswitch_consistency vpeq_s_t
        <span class="keyword1"><span class="command">have</span></span> vpeq_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> current_ns_nt vpeq_ns_nt interrupt_s vpeq_reflexive purged_a_a2 current_s_t IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> current_rs_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">rt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> current_ns_nt vpeq_ns_nt ia interrupt_s vpeq_reflexive purged_a_a2 IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> vpeq_rs_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">rs</span> <span class="skolem">rt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">from</span></span> current_rs_rt <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>Some <span class="skolem">rs</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">rt</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs2</span><span class="main">.</span> equivalent_states <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">∧</span> purged_relation <span class="bound">u</span> <span class="skolem">execs</span> <span class="bound">execs2</span> <span class="main">⟶</span> equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs</span>
      <span class="keyword3"><span class="command">assume</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">rs</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rt</span>
      <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span> <span class="main">=</span> Some <span class="skolem">rt</span>"</span></span>
    
      <span class="keyword3"><span class="command">assume</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> purged_a_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"purged_relation <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span>"</span></span>
      
      <span class="comment1">― ‹The following terminology is used: states rs and rt (for: run-s and run-t) are the states after a run.
         States ns and nt (for: next-s and next-t) are the states after one step.›</span>
      <span class="comment1">― ‹We prove two properties: the states rs and rt have equal active domains (current-rs-rt) and are vpeq for all domains v that may influence u (vpeq-rs-rt).
          Both are proven using the IH.
          To use the IH, we have to prove that the properties hold for the next step (in this case, nothing happens in s as the thread is empty).
          Statement current-ns-nt states that after one step states ns and nt have the same active domain.
          Statement $vpeq\_ns\_nt$ states that after one step states ns and nt are vpeq for all domains v that may influence u (vpeq-rs-rt).›</span>
          
      <span class="keyword1"><span class="command">from</span></span> ifp_reflexive <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_s_t_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> thread_empty_s <span class="keyword2"><span class="keyword">and</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> current_s_t <span class="keyword1"><span class="command">have</span></span> purged_a_na2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> purged_relation <span class="skolem">u</span> <span class="skolem">execs</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> next_execs_def<span class="main"><span class="keyword3">,</span></span><span class="operator">unfold</span> purged_relation_def<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> step_atomicity current_next_state current_s_t <span class="keyword1"><span class="command">have</span></span> current_s_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> step_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

      <span class="comment1">― ‹The proof is by case distinction. If the current thread is empty in state t as well (case t-empty), then nothing happens and the proof is trivial.
          Otherwise (case t-not-empty), since the current thread has different executions in states s and t, we now show that it cannot influence u (statement not-ifp-curr-t).
          If in state t the precondition holds (case t-prec), locally respects shows that the states remain vpeq.
          Otherwise, (case t-not-prec), everything holds vacuously.›</span>
      <span class="keyword1"><span class="command">have</span></span> current_rs_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">rt</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_empty t_not_empty<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> t_empty
        <span class="keyword1"><span class="command">from</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> current_s_t IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>        
        <span class="keyword1"><span class="command">from</span></span> this not_interrupt t_empty thread_empty_s
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> t_not_empty
        <span class="keyword1"><span class="command">from</span></span> t_not_empty current_next_state <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t_u <span class="keyword2"><span class="keyword">and</span></span> thread_empty_s <span class="keyword2"><span class="keyword">and</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> current_s_t
          <span class="keyword1"><span class="command">have</span></span> not_ifp_curr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> purged_relation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_prec t_not_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> t_prec
          <span class="keyword1"><span class="command">from</span></span> locally_respects_next_state current_next_state t_prec not_ifp_curr_t vpeq_s_t locally_respects vpeq_s_nt 
            <span class="keyword1"><span class="command">have</span></span> vpeq_s_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> vpeq_s_nt purged_a_na2 this current_s_nt not_ifp_curr_t current_next_state
                IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> t_not_empty t_prec vpeq_s_nt this thread_empty_s not_interrupt 
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> t_not_prec
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rt t_not_empty not_interrupt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">rs</span> <span class="skolem">rt</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_empty t_not_empty<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> t_empty
            <span class="keyword1"><span class="command">from</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> current_s_t IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>        
            <span class="keyword1"><span class="command">from</span></span> ia this not_interrupt t_empty thread_empty_s
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> t_not_empty
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_prec t_not_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> t_prec
              <span class="keyword1"><span class="command">from</span></span> t_not_empty current_next_state <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t_u <span class="keyword2"><span class="keyword">and</span></span> thread_empty_s <span class="keyword2"><span class="keyword">and</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> current_s_t
                <span class="keyword1"><span class="command">have</span></span> not_ifp_curr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> purged_relation_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> t_prec current_next_state locally_respects_next_state this <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> locally_respects <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_nt
                <span class="keyword1"><span class="command">have</span></span> vpeq_s_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> purged_a_na2 this current_s_nt not_ifp_curr_t current_next_state
                   IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> ia t_not_empty t_prec vpeq_s_nt this thread_empty_s not_interrupt 
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> t_not_prec
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rt t_not_empty not_interrupt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">from</span></span> current_rs_rt <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>Some <span class="skolem">rs</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">rt</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_not_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹Whenever the precondition does not hold, the entire theorem flattens to True and everything holds vacuously.›</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> not_interrupt thread_not_empty_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_not_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs2</span><span class="main">.</span>
           equivalent_states <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">∧</span>
           purged_relation <span class="bound">u</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="bound">execs2</span> <span class="main">⟶</span>
           equivalent_states
            <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs</span>
      <span class="keyword3"><span class="command">assume</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">rs</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rt</span>
      <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span> <span class="main">=</span> Some <span class="skolem">rt</span>"</span></span>
      
      <span class="keyword3"><span class="command">assume</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> purged_a_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"purged_relation <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span>"</span></span>

      <span class="comment1">― ‹The following terminology is used: states rs and rt (for: run-s and run-t) are the states after a run.
         States ns and nt (for: next-s and next-t) are the states after one step.›</span>
      <span class="comment1">― ‹We prove two properties: the states rs and rt have equal active domains (current-rs-rt) and are vpeq for all domains v that may influence u (vpeq-rs-rt).
          Both are proven using the IH.
          To use the IH, we have to prove that the properties hold for the next step (in this case, state s executes an action).
          Statement current-ns-nt states that after one step states ns and nt have the same active domain.
          Statement vpeq-ns-nt states that after one step states ns and nt are vpeq for all domains v that may influence u (vpeq-rs-rt).›</span>
          
      <span class="comment1">― ‹Some lemma's used in the remainder of this case.›</span>
      <span class="keyword1"><span class="command">from</span></span> ifp_reflexive <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_s_t_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> step_atomicity <span class="keyword2"><span class="keyword">and</span></span> current_s_t current_next_state
        <span class="keyword1"><span class="command">have</span></span> current_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> step_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_curr_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> prec_s involved_ifp<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main">]</span> vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_involved<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="skolem">s</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> current_next_state
        <span class="keyword1"><span class="command">unfolding</span></span> involved_def precondition_def B_def
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> current_s_t next_execs_consistent vpeq_curr_s_t vpeq_involved
        <span class="keyword1"><span class="command">have</span></span> next_execs_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> next_execs <span class="skolem">t'</span> <span class="skolem">execs</span> <span class="main">=</span> next_execs <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> current_s_t purged_a_a2  thread_not_empty_s next_action_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span> vpeq_curr_s_t vpeq_involved
        <span class="keyword1"><span class="command">have</span></span> next_action_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> next_action <span class="skolem">t'</span> <span class="skolem">execs2</span> <span class="main">=</span> next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> next_action_def<span class="main"><span class="keyword3">,</span></span><span class="operator">unfold</span> purged_relation_def<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> purged_a_a2 current_s_t next_execs_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span>"</span></span><span class="main">]</span>
           vpeq_curr_s_t vpeq_involved
        <span class="keyword1"><span class="command">have</span></span> purged_na_na2<span class="main">:</span> <span class="quoted"><span class="quoted">"purged_relation <span class="skolem">u</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def purged_relation_def
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> purged_relation_def <span class="keyword2"><span class="keyword">and</span></span> thread_not_empty_s <span class="keyword2"><span class="keyword">and</span></span> current_s_t <span class="keyword1"><span class="command">have</span></span> thread_not_empty_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> step_atomicity current_s_t current_next_state <span class="keyword1"><span class="command">have</span></span> current_ns_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> step_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> step_atomicity <span class="keyword2"><span class="keyword">and</span></span> current_s_t <span class="keyword1"><span class="command">have</span></span> current_s_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span>step <span class="skolem">t'</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> step_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>      
      <span class="keyword1"><span class="command">from</span></span> purged_a_a2 <span class="keyword1"><span class="command">have</span></span> purged_na_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> purged_relation <span class="skolem">u</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">execs2</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> next_execs_def<span class="main"><span class="keyword3">,</span></span><span class="operator">unfold</span> purged_relation_def<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

      <span class="comment1">― ‹The proof is by case distinction. If the current domain can interact with u (case curr-ifp-u), then either in state t the precondition holds (case t-prec) or not.
          If it holds, then lemma vpeq-ns-nt-ifp-u applies. Otherwise, the proof is trivial as the theorem holds vacuously.
          If the domain cannot interact with u, (case curr-not-ifp-u), then lemma vpeq-ns-nt-not-ifp-u applies.›</span>
      <span class="keyword1"><span class="command">have</span></span> current_rs_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">rt</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> curr_ifp_u curr_not_ifp_u<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> curr_ifp_u
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> prec_t prec_not_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> prec_t
          <span class="keyword1"><span class="command">have</span></span> thread_not_empty_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thread_not_empty_t curr_ifp_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span>
            current_ns_nt next_execs_t next_action_s_t purged_a_a2
            curr_ifp_u prec_t prec_s vpeq_ns_nt_ifp_u<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span><span class="main">]</span> vpeq_s_t current_s_t
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> purged_relation_def next_state_def 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> this
            IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 
            current_ns_nt purged_na_na2
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>
                                    <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> prec_t thread_not_empty_t prec_s <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword2"><span class="keyword">and</span></span> not_interrupt <span class="keyword2"><span class="keyword">and</span></span> thread_not_empty_s <span class="keyword2"><span class="keyword">and</span></span> next_action_s_t
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> prec_not_t
          <span class="keyword1"><span class="command">from</span></span> curr_ifp_u prec_not_t thread_not_empty_t not_interrupt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> curr_not_ifp_u
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_empty t_not_empty<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> t_not_empty
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_prec t_not_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> t_prec
            <span class="keyword1"><span class="command">from</span></span> curr_not_ifp_u t_prec IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
                 current_ns_nt next_execs_t purged_na_na2 vpeq_ns_nt_not_ifp_u current_s_t vpeq_s_t prec_s purged_a_a2
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>
                                     <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
            <span class="keyword1"><span class="command">from</span></span> this t_prec curr_not_ifp_u t_not_empty prec_s not_interrupt thread_not_empty_s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> t_not_prec
            <span class="keyword1"><span class="command">from</span></span> t_not_prec t_not_empty not_interrupt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> t_empty
          <span class="keyword1"><span class="command">from</span></span> curr_not_ifp_u <span class="keyword2"><span class="keyword">and</span></span> prec_s <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> locally_respects <span class="keyword2"><span class="keyword">and</span></span> vpeq_ns_t current_next_state locally_respects_next_state
            <span class="keyword1"><span class="command">have</span></span> vpeq_ns_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> curr_not_ifp_u IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> current_ns_t <span class="keyword2"><span class="keyword">and</span></span> next_execs_t <span class="keyword2"><span class="keyword">and</span></span> purged_na_a <span class="keyword2"><span class="keyword">and</span></span> vpeq_ns_t <span class="keyword2"><span class="keyword">and</span></span> this
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> 
                                  <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span>  <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> this not_interrupt thread_not_empty_s t_empty prec_s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">rs</span> <span class="skolem">rt</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span><span class="main">^**</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> curr_ifp_u curr_not_ifp_u<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> curr_ifp_u
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_prec t_not_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> t_prec
            <span class="keyword1"><span class="command">have</span></span> thread_not_empty_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thread_not_empty_t curr_ifp_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span>
              current_ns_nt next_execs_t next_action_s_t purged_a_a2
              curr_ifp_u t_prec  prec_s vpeq_ns_nt_ifp_u<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span><span class="main">]</span> vpeq_s_t current_s_t
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> purged_relation_def next_state_def 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> this
              IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 
              current_ns_nt purged_na_na2
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>
                                      <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> ia curr_ifp_u t_prec thread_not_empty_t prec_s <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword2"><span class="keyword">and</span></span> not_interrupt <span class="keyword2"><span class="keyword">and</span></span> thread_not_empty_s <span class="keyword2"><span class="keyword">and</span></span> next_action_s_t
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> t_not_prec
            <span class="keyword1"><span class="command">from</span></span> curr_ifp_u t_not_prec thread_not_empty_t not_interrupt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> curr_not_ifp_u
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_empty t_not_empty<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> t_not_empty
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> t_prec t_not_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> t_prec
              <span class="keyword1"><span class="command">from</span></span> curr_not_ifp_u t_prec IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
                   current_ns_nt next_execs_t purged_na_na2 vpeq_ns_nt_not_ifp_u current_s_t vpeq_s_t prec_s purged_a_a2
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>
                                       <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
              <span class="keyword1"><span class="command">from</span></span> ia this t_prec curr_not_ifp_u t_not_empty prec_s not_interrupt thread_not_empty_s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> t_not_prec
              <span class="keyword1"><span class="command">from</span></span> t_not_prec t_not_empty not_interrupt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> t_empty
            <span class="keyword1"><span class="command">from</span></span> curr_not_ifp_u prec_s <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> locally_respects <span class="keyword2"><span class="keyword">and</span></span> vpeq_ns_t current_next_state locally_respects_next_state
              <span class="keyword1"><span class="command">have</span></span> vpeq_ns_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> curr_not_ifp_u IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> current_ns_t <span class="keyword2"><span class="keyword">and</span></span> next_execs_t <span class="keyword2"><span class="keyword">and</span></span> purged_na_a <span class="keyword2"><span class="keyword">and</span></span> vpeq_ns_t <span class="keyword2"><span class="keyword">and</span></span> this
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> 
                                    <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span>  <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> ia this not_interrupt thread_not_empty_s t_empty prec_s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">from</span></span> current_rs_rt <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>Some <span class="skolem">rs</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">rt</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> view_partitioned_ind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  From the previous lemma, we can prove that the system is view partitioned.
  The previous lemma was inductive, this lemma just instantiates the previous lemma replacing s and t by the initial state.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> unwinding_implies_view_partitioned<span class="main">:</span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">view_partitioned</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> unwinding_implies_view_partitioned_ind <span class="keyword1"><span class="command">have</span></span> view_partitioned_inductive<span class="main">:</span> <span class="quoted"><span class="quoted">"view_partitioned_ind"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">have</span></span> purged_relation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">execs</span> <span class="main">.</span> purged_relation <span class="bound">u</span> <span class="bound">execs</span> <span class="main">(</span>purge <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> purged_relation_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> purge_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">n</span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"equivalent_states <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this view_partitioned_inductive purged_relation
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">t</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> view_partitioned_ind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this ifp_reflexive
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="main">∥</span> run <span class="skolem">n</span> <span class="skolem">t</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span><span class="bound">rs</span> <span class="bound">rt</span><span class="main">.</span> <span class="free">vpeq</span> <span class="skolem">u</span> <span class="bound">rs</span> <span class="bound">rt</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">rt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_into_rtranclp <span class="keyword1"><span class="command">unfolding</span></span> B_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="skolem">t</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> view_partitioned_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Domains that many not interfere with each other, do not interfere with each other.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> unwinding_implies_NI_unrelated<span class="main">:</span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">NI_unrelated</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">a</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">from</span></span> unwinding_implies_view_partitioned
      <span class="keyword1"><span class="command">have</span></span> vp<span class="main">:</span> <span class="quoted">view_partitioned</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> vp <span class="keyword2"><span class="keyword">and</span></span> vpeq_reflexive
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">.</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> 
                      <span class="main">∥</span> run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="bound">u</span><span class="main">)</span> 
                          <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span><span class="bound">rs</span> <span class="bound">rt</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">rs</span> <span class="bound">rt</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">rt</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> view_partitioned_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s_f</span><span class="main">.</span> run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s_f2</span><span class="main">.</span> <span class="free">output_f</span> <span class="bound">s_f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="bound">s_f2</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s_f</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s_f2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">rs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">from</span></span> Some this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">rt</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">rs</span>›</span></span> Some 1<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">rs</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> vpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">rs</span><span class="main">)</span> <span class="skolem">rs</span> <span class="skolem">rt</span> <span class="main">∧</span> <span class="free">current</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">rt</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this output_consistent <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">output_f</span> <span class="skolem">rs</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="skolem">rt</span> <span class="skolem">a</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this vpeq <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">rs</span>›</span></span> Some
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> NI_unrelated_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  




<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Security for indirectly interfering domains›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Consider the following security policy over three domains $A$, $B$ and $C$: $A \leadsto B \leadsto C$,
but $A \not\leadsto C$.
The semantics of this policy is that $A$ may communicate with $C$, but \emph{only} via $B$. No direct communication from $A$ to $C$ is allowed.
We formalize these semantics as follows:
without intermediate domain $B$, domain $A$ cannot flow information to $C$.
In other words, from the point of view of domain $C$ the run where domain $B$ is inactive must be equivalent to the run where domain $B$ is inactive and domain $A$ is replaced by an attacker.
Domain $C$ must be independent of domain $A$, when domain $B$ is inactive.

The aim of this subsection is to formalize the semantics where $A$ can write to $C$ via $B$ \emph{only}.
We define to two ipurge functions. The first purges all domains $d$ that are \emph{intermediary} for some other domain $v$.
An intermediary for $u$ is defined as a domain $d$ for which there exists an information flow from some domain $v$ to $u$ via $d$, but no direct information flow from $v$ to $u$ is allowed.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">intermediary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intermediary</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span><span class="main">^**</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∧</span> <span class="free">ifp</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="main">¬</span><span class="free">ifp</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">remove_gateway_communications</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution <span class="main">⇒</span> <span class="tfree">'action_t</span> execution"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">remove_gateway_communications</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_gateway_communications</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">aseq</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">exec</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span> <span class="main">.</span> intermediary <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> involved <span class="main">(</span>Some <span class="bound">a</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">aseq</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">remove_gateway_communications</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">exec</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipurge_l</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipurge_l</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">d</span> <span class="main">.</span> <span class="keyword1">if</span> intermediary <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span>
                              <span class="main">[]</span>
                            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span>
                              remove_gateway_communications <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>
                            <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="bound">d</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The second ipurge removes both the intermediaries and the \emph{indirect sources}.
An indirect source for $u$ is defined as a domain that may indirectly flow information to $u$, but not directly.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ind_source</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ind_source</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="free">ifp</span><span class="main">^**</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="main">¬</span><span class="free">ifp</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipurge_r</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipurge_r</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">d</span> <span class="main">.</span> <span class="keyword1">if</span> intermediary <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span>
                              <span class="main">[]</span>
                            <span class="keyword1">else</span> <span class="keyword1">if</span> ind_source <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span>
                              <span class="keyword1">SOME</span> <span class="bound">alpha</span> <span class="main">.</span> <span class="free">realistic_execution</span> <span class="bound">alpha</span>
                            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span>
                              remove_gateway_communications <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>
                            <span class="keyword1">else</span>
                              <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="bound">d</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
For a system with an intransitive policy to be called secure for domain $u$ any indirect source may not flow information towards $u$ when the intermediaries are purged out.
This definition of security allows the information flow $A \leadsto B \leadsto C$, but prohibits $A \leadsto C$.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NI_indirect_sources</span> <span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NI_indirect_sources</span> 
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs</span> <span class="bound">a</span> <span class="bound">n</span><span class="main">.</span> run <span class="bound">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="bound">execs</span> <span class="main">⇀</span>
                   <span class="main">(</span><span class="main">λ</span> <span class="bound">s_f</span> <span class="main">.</span> <span class="main">(</span>run <span class="bound">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">∥</span>
                             run <span class="bound">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_r <span class="bound">execs</span>  <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span>
                                 <span class="main">(</span><span class="main">λ</span> <span class="bound">s_l</span> <span class="bound">s_r</span> <span class="main">.</span> <span class="free">output_f</span> <span class="bound">s_l</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="bound">s_r</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This definition concerns indirect sources only. It does not enforce that an \emph{unrelated} domain may not flow information to $u$.
This is expressed by ``secure''.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This allows us to define security over intransitive policies.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isecure</span><span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isecure</span> <span class="main">≡</span> NI_indirect_sources  <span class="main">∧</span> NI_unrelated"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">iequivalent_states</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> option  <span class="main">⇒</span> <span class="tfree">'state_t</span> option <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iequivalent_states</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∥</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">does_not_communicate_with_gateway</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">does_not_communicate_with_gateway</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> actions_in_execution <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> intermediary <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∉</span> involved <span class="main">(</span>Some <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iview_partitioned</span><span class="main">::</span><span class="quoted">bool</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iview_partitioned</span>
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs</span> <span class="bound">ms</span> <span class="bound">mt</span> <span class="bound">n</span> <span class="bound">u</span> <span class="main">.</span> iequivalent_states <span class="bound">ms</span> <span class="bound">mt</span> <span class="bound">u</span>  <span class="main">⟶</span>
        <span class="main">(</span>run <span class="bound">n</span> <span class="bound">ms</span> <span class="main">(</span>ipurge_l <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∥</span>
         run <span class="bound">n</span> <span class="bound">mt</span> <span class="main">(</span>ipurge_r <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⇀</span>
         <span class="main">(</span><span class="main">λ</span> <span class="bound">rs</span> <span class="bound">rt</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">rs</span> <span class="bound">rt</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">rt</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipurged_relation1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ipurged_relation1</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">execs1</span></span></span> <span class="free"><span class="bound"><span class="entity">execs2</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">.</span> <span class="main">(</span><span class="free">ifp</span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">execs1</span></span></span> <span class="bound">d</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">execs2</span></span></span> <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>intermediary <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">execs1</span></span></span> <span class="bound">d</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Proof that if the current is not an intermediary for u, then all domains involved in the next action are vpeq.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> vpeq_involved_domains<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> ifp_curr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_intermediary_curr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> no_gateway_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"does_not_communicate_with_gateway <span class="free">u</span> <span class="free">execs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="free">s</span> <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="free">s</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> involved<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">from</span></span> this prec_s involved_ifp<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="free">s</span> <span class="free">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_action <span class="free">s</span> <span class="free">execs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> ifp_v_curr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="skolem">v</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> current_next_state
    <span class="keyword1"><span class="command">unfolding</span></span> involved_def precondition_def B_def
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="free">s</span> <span class="free">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">s</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="skolem">v</span> <span class="free">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="skolem">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this vpeq_s_t
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">s</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_intermediary_v<span class="main">:</span> <span class="quoted"><span class="quoted">"intermediary <span class="skolem">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ifp_curr not_intermediary_curr ifp_v_curr not_intermediary_v <span class="keyword1"><span class="command">have</span></span> curr_is_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="free">s</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rtranclp_trans r_into_rtranclp
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intermediary_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> curr_is_u next_action_from_execs<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">execs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span><span class="main">]</span> not_intermediary_v involved
         no_gateway_comm<span class="main">[</span><span class="operator">unfolded</span> does_not_communicate_with_gateway_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="main">(</span>next_action <span class="free">s</span> <span class="free">execs</span><span class="main">)</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">unfolding</span></span> involved_def B_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="free">s</span> <span class="free">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">s</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> intermediary_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ifp</span> <span class="skolem">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ifp_curr not_intermediary_curr ifp_v_curr intermediary_v
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">s</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="free">s</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Proof that purging removes communications of the gateway to domain u.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ipurge_l_removes_gateway_communications<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"does_not_communicate_with_gateway <span class="free">u</span> <span class="main">(</span>ipurge_l <span class="free">execs</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aseq</span> <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">a</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aseq</span> <span class="main">∈</span> set <span class="main">(</span>remove_gateway_communications <span class="skolem">u</span> <span class="main">(</span><span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">aseq</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"intermediary <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> involved <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'action_t</span></span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aseq</span> <span class="skolem">u</span> <span class="skolem">exec</span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aseq</span> <span class="main">∈</span> set <span class="main">(</span>remove_gateway_communications <span class="skolem">u</span> <span class="skolem">exec</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">aseq</span> <span class="main">∧</span> intermediary <span class="skolem">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="skolem">v</span> <span class="main">∉</span> involved <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">exec</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 3 this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span> 
<span class="keyword1"><span class="command">from</span></span> this
<span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> does_not_communicate_with_gateway_def ipurge_l_def actions_in_execution_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Proof of view partitioning. The lemma is structured exactly as lemma unwinding\_implies\_view\_partitioned\_ind and uses the same convention for naming.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> iunwinding_implies_view_partitioned1<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">iview_partitioned</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"does_not_communicate_with_gateway <span class="skolem">u</span> <span class="skolem">execs</span> <span class="main">∧</span> iequivalent_states <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="main">∧</span> ipurged_relation1 <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span> <span class="main">⟶</span> iequivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">execs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">execs2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> run.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> interrupt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs2</span><span class="main">.</span> does_not_communicate_with_gateway <span class="bound">u</span> <span class="skolem">execs</span> <span class="main">∧</span>
           iequivalent_states <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">∧</span> ipurged_relation1 <span class="bound">u</span> <span class="skolem">execs</span> <span class="bound">execs2</span> <span class="main">⟶</span>
           iequivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state_t</span></span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs</span>
      <span class="keyword3"><span class="command">assume</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">rs</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rt</span>
      <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span> <span class="main">=</span> Some <span class="skolem">rt</span>"</span></span>
      
      <span class="keyword3"><span class="command">assume</span></span> no_gateway_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"does_not_communicate_with_gateway <span class="skolem">u</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> purged_a_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurged_relation1 <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span>"</span></span>
      
      <span class="keyword1"><span class="command">from</span></span> current_s_t cswitch_independent_of_state
        <span class="keyword1"><span class="command">have</span></span> current_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> cswitch_consistency vpeq_s_t
        <span class="keyword1"><span class="command">have</span></span> vpeq_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> no_gateway_comm current_ns_nt vpeq_ns_nt interrupt_s vpeq_reflexive current_s_t purged_a_a2 IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> current_rs_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">rt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="skolem">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> no_gateway_comm interrupt_s current_ns_nt vpeq_ns_nt vpeq_reflexive ia current_s_t purged_a_a2 IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">rs</span> <span class="skolem">rt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">from</span></span> current_rs_rt <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="main">(</span>Some <span class="skolem">rs</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">rt</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>      
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs2</span><span class="main">.</span> does_not_communicate_with_gateway <span class="bound">u</span> <span class="skolem">execs</span> <span class="main">∧</span> iequivalent_states <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">∧</span> ipurged_relation1 <span class="bound">u</span> <span class="skolem">execs</span> <span class="bound">execs2</span> <span class="main">⟶</span> iequivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>                                     
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs</span>
      <span class="keyword3"><span class="command">assume</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">rs</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rt</span>
      <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span> <span class="main">=</span> Some <span class="skolem">rt</span>"</span></span>
         
      <span class="keyword3"><span class="command">assume</span></span> no_gateway_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"does_not_communicate_with_gateway <span class="skolem">u</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> purged_a_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurged_relation1 <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span>"</span></span>
      
      <span class="keyword1"><span class="command">from</span></span> ifp_reflexive vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_u_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> step_atomicity current_next_state current_s_t <span class="keyword1"><span class="command">have</span></span> current_s_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> step_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_curr_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> vpeq_s_t <span class="keyword2"><span class="keyword">and</span></span> current_s_t IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span> no_gateway_comm
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this not_interrupt True thread_empty_s
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> prec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> not_prec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> not_interrupt False not_prec_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        
        <span class="keyword1"><span class="command">from</span></span> False purged_a_a2 thread_empty_s current_s_t
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"ind_source <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∨</span> unrelated <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ipurged_relation1_def intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
          <span class="keyword3"><span class="command">assume</span></span> ifp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> v_not_intermediary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>intermediary <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>                    
          
          <span class="keyword1"><span class="command">from</span></span> 1 ifp_v v_not_intermediary <span class="keyword1"><span class="command">have</span></span> not_ifp_curr_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> not_ifp_curr_v prec_t locally_respects<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span><span class="main">]</span>
               current_next_state  vpeq_reflexive
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> this vpeq_transitive not_ifp_curr_v locally_respects_next_state
            <span class="keyword1"><span class="command">have</span></span> vpeq_t_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">t'</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> vpeq_s_t ifp_v v_not_intermediary vpeq_t_nt vpeq_transitive vpeq_symmetric vpeq_reflexive 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">hence</span></span> vpeq_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> False purged_a_a2 current_s_t thread_empty_s <span class="keyword1"><span class="command">have</span></span> purged_a_na2<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurged_relation1 <span class="skolem">u</span> <span class="skolem">execs</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ipurged_relation1_def next_execs_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> vpeq_ns_nt no_gateway_comm
          <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> current_s_nt purged_a_na2 
          <span class="keyword1"><span class="command">have</span></span> eq_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span>
                                             <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> prec_t  eq_ns_nt not_interrupt False thread_empty_s 
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t rs rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>      
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_not_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> not_interrupt thread_not_empty_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_not_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs2</span><span class="main">.</span> does_not_communicate_with_gateway <span class="bound">u</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">∧</span>
           iequivalent_states <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">∧</span>
           ipurged_relation1 <span class="bound">u</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="bound">execs2</span> <span class="main">⟶</span>
           iequivalent_states
            <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs</span>
      <span class="keyword3"><span class="command">assume</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">rs</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rt</span>
      <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span> <span class="main">=</span> Some <span class="skolem">rt</span>"</span></span>
      
      <span class="keyword3"><span class="command">assume</span></span> no_gateway_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"does_not_communicate_with_gateway <span class="skolem">u</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> purged_a_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurged_relation1 <span class="skolem">u</span> <span class="skolem">execs</span> <span class="skolem">execs2</span>"</span></span>
      
      <span class="keyword1"><span class="command">from</span></span> ifp_reflexive vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_u_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> step_atomicity <span class="keyword2"><span class="keyword">and</span></span> current_s_t current_next_state
        <span class="keyword1"><span class="command">have</span></span> current_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> step_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>        
      <span class="keyword1"><span class="command">from</span></span> step_atomicity current_next_state current_s_t <span class="keyword1"><span class="command">have</span></span> current_ns_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> step_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>      
      <span class="keyword1"><span class="command">from</span></span> vpeq_s_t <span class="keyword1"><span class="command">have</span></span> vpeq_curr_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
      <span class="keyword1"><span class="command">from</span></span> current_s_t purged_a_a2
        <span class="keyword1"><span class="command">have</span></span> eq_execs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurged_relation1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> vpeq_involved_domains no_gateway_comm vpeq_s_t vpeq_involved_domains prec_s
        <span class="keyword1"><span class="command">have</span></span> vpeq_involved<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="skolem">s</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> current_s_t next_execs_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span><span class="main">]</span> vpeq_curr_s_t vpeq_involved
        <span class="keyword1"><span class="command">have</span></span> next_execs_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> next_execs <span class="skolem">t'</span> <span class="skolem">execs</span> <span class="main">=</span> next_execs <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_execs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> current_s_t <span class="keyword2"><span class="keyword">and</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> thread_not_empty_s next_action_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span> vpeq_curr_s_t vpeq_involved
        <span class="keyword1"><span class="command">have</span></span> next_action_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> next_action <span class="skolem">t'</span> <span class="skolem">execs2</span> <span class="main">=</span> next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> next_action_def<span class="main"><span class="keyword3">,</span></span><span class="operator">unfold</span> ipurged_relation1_def<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> thread_not_empty_s <span class="keyword2"><span class="keyword">and</span></span> current_s_t
        <span class="keyword1"><span class="command">have</span></span> thread_not_empty_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ipurged_relation1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> vpeq_ns_nt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="main">.</span> precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟹</span>  <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
        <span class="keyword3"><span class="command">assume</span></span> precs<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">∧</span> precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ifp_curr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> ifp_curr precs
          next_state_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span> vpeq_curr_s_t vpeq_s_t
          current_next_state current_s_t weakly_step_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x3<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="skolem">t'</span> <span class="skolem">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="skolem">a</span>"</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> no_gateway_comm_na<span class="main">:</span> <span class="quoted"><span class="quoted">"does_not_communicate_with_gateway <span class="skolem">u</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> actions_in_execution <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> this no_gateway_comm<span class="main">[</span><span class="operator">unfolded</span> does_not_communicate_with_gateway_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
               next_execs_subset<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x0<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∉</span> involved <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span>  actions_in_execution_def
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> does_not_communicate_with_gateway_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>      
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> T F<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> T
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> T2 F2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> F2
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> T3 F3<span class="main"><span class="main">]</span></span><span class="main">)</span>        
          <span class="keyword3"><span class="command">case</span></span> T3
            <span class="keyword1"><span class="command">from</span></span> T purged_a_a2 current_s_t
              next_execs_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span> vpeq_curr_s_t vpeq_involved
              <span class="keyword1"><span class="command">have</span></span> purged_na_na2<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurged_relation1 <span class="skolem">u</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> ipurged_relation1_def next_execs_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
            <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
              purged_na_na2 current_ns_nt vpeq_ns_nt_1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span><span class="main">]</span> T T3 prec_s
              next_action_s_t  eq_execs current_s_t no_gateway_comm_na
              <span class="keyword1"><span class="command">have</span></span> eq_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>
                                                 <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> next_state_def                                                 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> this not_interrupt thread_not_empty_s prec_s F2 T3
              <span class="keyword1"><span class="command">have</span></span> current_rs_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">rt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
              <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="skolem">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> this eq_ns_nt not_interrupt thread_not_empty_s prec_s F2 T3
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">rs</span> <span class="skolem">rt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> current_rs_rt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> F3
            <span class="keyword1"><span class="command">from</span></span> F3 F2 not_interrupt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>        
        <span class="keyword3"><span class="command">case</span></span> T2
          <span class="keyword1"><span class="command">from</span></span> T2 T purged_a_a2 thread_not_empty_s current_s_t prec_s next_action_s_t vpeq_u_s_t 
            <span class="keyword1"><span class="command">have</span></span> ind_source<span class="main">:</span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">unfolding</span></span>  ipurged_relation1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> F
        <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"ind_source <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∨</span> unrelated <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∨</span> intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> purged_a_a2 <span class="keyword2"><span class="keyword">and</span></span> thread_not_empty_s
          <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>intermediary <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ipurged_relation1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>  <span class="keyword1">then</span> <span class="skolem">t'</span> <span class="keyword1">else</span> step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?na2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">execs2</span> <span class="keyword1">else</span> next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> prec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> thread_not_empty_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> not_prec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">execs2</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> not_interrupt thread_not_empty_t not_prec_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> this  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> rt <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
          <span class="keyword3"><span class="command">assume</span></span> ifp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> v_not_intermediary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>intermediary <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>                    
          
          <span class="keyword1"><span class="command">have</span></span> not_ifp_curr_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">assume</span></span> ifp_curr_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ind_source <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">from</span></span> this ifp_curr_v ifp_v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intermediary <span class="skolem">v</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">from</span></span> this v_not_intermediary <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> unrelated<span class="main">:</span> <span class="quoted"><span class="quoted">"unrelated <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">from</span></span> this ifp_v ifp_curr_v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> rtranclp_trans r_into_rtranclp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">from</span></span> this current_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span><span class="main">]</span> prec_s
             locally_respects<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main">]</span> vpeq_reflexive
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> not_ifp_curr_v this locally_respects_next_state vpeq_transitive
            <span class="keyword1"><span class="command">have</span></span> vpeq_s_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">s</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> not_ifp_curr_v current_s_t current_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span> prec_t
             locally_respects<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main">]</span>
             F vpeq_reflexive
             <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> thread_empty <span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>              
             <span class="keyword1"><span class="command">unfolding</span></span> step_def precondition_def B_def
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
           <span class="keyword1"><span class="command">from</span></span> 0 not_ifp_curr_v current_s_t locally_respects_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs2</span>"</span></span><span class="main">]</span>
             vpeq_transitive 
             <span class="keyword1"><span class="command">have</span></span> vpeq_t_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> thread_empty <span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">t'</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">from</span></span> this vpeq_reflexive
            <span class="keyword1"><span class="command">have</span></span> vpeq_t_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">t'</span> <span class="var">?nt</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> vpeq_s_t ifp_v v_not_intermediary
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">from</span></span> this vpeq_s_ns vpeq_t_nt vpeq_transitive vpeq_symmetric vpeq_reflexive
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="var">?nt</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">hence</span></span> vpeq_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">v</span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">v</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="var">?nt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> vpeq_s_t 2 F purged_a_a2 current_s_t thread_not_empty_s <span class="keyword1"><span class="command">have</span></span> purged_na_na2<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurged_relation1 <span class="skolem">u</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="var">?na2</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ipurged_relation1_def next_execs_def intermediary_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> current_ns_nt current_ns_t current_next_state <span class="keyword1"><span class="command">have</span></span> current_ns_nt<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="var">?nt</span>"</span></span>
             <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> prec_s vpeq_ns_nt no_gateway_comm_na
            <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="var">?nt</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?na2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
            <span class="keyword2"><span class="keyword">and</span></span> current_ns_nt purged_na_na2
            <span class="keyword1"><span class="command">have</span></span> eq_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>
                                               <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="var">?nt</span><span class="main">)</span> <span class="var">?na2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                             
          <span class="keyword1"><span class="command">from</span></span> this not_interrupt thread_not_empty_s prec_t prec_s
            <span class="keyword1"><span class="command">have</span></span> current_rs_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">rt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"thread_empty <span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
            <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="skolem">v</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="skolem">v</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> this eq_ns_nt not_interrupt thread_not_empty_s prec_s prec_t
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">v</span> <span class="skolem">rs</span> <span class="skolem">rt</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">from</span></span> current_rs_rt <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rs rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">hence</span></span> iview_partitioned_inductive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">execs</span> <span class="bound">execs2</span> <span class="bound">n</span><span class="main">.</span> does_not_communicate_with_gateway <span class="bound">u</span> <span class="bound">execs</span> <span class="main">∧</span> iequivalent_states <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">∧</span> ipurged_relation1 <span class="bound">u</span> <span class="bound">execs</span> <span class="bound">execs2</span> <span class="main">⟶</span> iequivalent_states <span class="main">(</span>run <span class="bound">n</span> <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="bound">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span> <span class="bound">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">have</span></span> ipurged_relation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">execs</span> <span class="main">.</span> ipurged_relation1 <span class="bound">u</span> <span class="main">(</span>ipurge_l <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>ipurge_r <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> ipurged_relation1_def<span class="main"><span class="keyword3">,</span></span><span class="operator">unfold</span> ipurge_l_def<span class="main"><span class="keyword3">,</span></span><span class="operator">unfold</span> ipurge_r_def<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">n</span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ifp_reflexive 
    <span class="keyword1"><span class="command">have</span></span> dir_source<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">u</span> <span class="bound">u</span> <span class="main">∧</span> <span class="main">¬</span>intermediary <span class="bound">u</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> intermediary_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">from</span></span> ipurge_l_removes_gateway_communications
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"does_not_communicate_with_gateway <span class="skolem">u</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1 this iview_partitioned_inductive ipurged_relation
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iequivalent_states <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">t</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this dir_source
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∥</span> run <span class="skolem">n</span> <span class="skolem">t</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span><span class="bound">rs</span> <span class="bound">rt</span><span class="main">.</span> <span class="free">vpeq</span> <span class="skolem">u</span> <span class="bound">rs</span> <span class="bound">rt</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">rt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_into_rtranclp <span class="keyword1"><span class="command">unfolding</span></span> B_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="skolem">t</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> iview_partitioned_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Returns True iff and only if the two states have the same active domain, \emph{or} if one of the states is None.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mcurrents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> option <span class="main">⇒</span> <span class="tfree">'state_t</span> option <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mcurrents</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">∥</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Proof that switching/interrupts are purely time-based and happen independent of the actions done by the domains.
  As all theorems in this locale, it holds vacuously whenever one of the states is None, i.e., whenver at some point a precondition does not hold.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> current_independent_of_domain_actions<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"mcurrents <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="free">n</span> <span class="free">s</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="free">n</span> <span class="free">t</span> <span class="free">execs2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">execs2</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">⟶</span> mcurrents <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">execs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">execs2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> run.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> current_s_t <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">execs2</span><span class="main">.</span> mcurrents <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span> mcurrents <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> t curr cswitch_independent_of_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">have</span></span> current_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>      
      <span class="keyword1"><span class="command">from</span></span> current_ns_nt IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> mcurrents_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> mcurrents_ns_nt interrupt t
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def B2_def B_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def B2_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>    
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">execs2</span><span class="main">.</span> mcurrents <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span> mcurrents <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> thread_empty_t<span class="main">:</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> t curr not_interrupt thread_empty_s this IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="skolem">t'</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> not_prec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> t this not_interrupt
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rewrite_B2_cases<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> step_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_atomicity curr t current_next_state <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def
          <span class="keyword1"><span class="command">unfolding</span></span> step_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> t step_t curr not_interrupt thread_empty_s this IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def B2_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_not_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> not_interrupt_s thread_not_empty_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_not_empty_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">execs2</span><span class="main">.</span>
           mcurrents <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span>
           mcurrents <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">n</span> <span class="bound">t</span> <span class="bound">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> thread_empty_t<span class="main">:</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_atomicity curr t current_next_state <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def
          <span class="keyword1"><span class="command">unfolding</span></span> step_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> t curr not_interrupt thread_not_empty_s prec_s thread_empty_t this IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="skolem">t'</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> not_prec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> t this not_interrupt
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def B2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> step_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs2</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> precondition <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_atomicity curr t current_next_state <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def
          <span class="keyword1"><span class="command">unfolding</span></span> step_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> current_next_state t step_t curr not_interrupt thread_not_empty_s prec_s this IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_execs <span class="skolem">t'</span> <span class="skolem">execs2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">t'</span> <span class="skolem">execs2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mcurrents <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">execs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def B2_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> current_s_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> unwinding_implies_NI_indirect_sources<span class="main">:</span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">NI_indirect_sources</span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">a</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">from</span></span> iunwinding_implies_view_partitioned1
      <span class="keyword1"><span class="command">have</span></span> vp<span class="main">:</span> <span class="quoted">iview_partitioned</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> vp <span class="keyword2"><span class="keyword">and</span></span> vpeq_reflexive
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">.</span> run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∥</span> run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="bound">u</span><span class="main">)</span>  <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span><span class="bound">rs</span> <span class="bound">rt</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">rs</span> <span class="bound">rt</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">rs</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">rt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> iview_partitioned_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s_f</span><span class="main">.</span> run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span>  <span class="main">∥</span>
                                           run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span>
                                           <span class="main">(</span><span class="main">λ</span><span class="bound">s_l</span> <span class="bound">s_r</span><span class="main">.</span> <span class="free">output_f</span> <span class="bound">s_l</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="bound">s_r</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s_f</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">from</span></span> Some this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s_ipurge_l</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">s_f</span>›</span></span> Some this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s_ipurge_r</span><span class="main">)</span>
           <span class="keyword1"><span class="command">from</span></span> cswitch_independent_of_state
                <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">s_f</span>›</span></span> <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">s_ipurge_l</span>›</span></span>
                current_independent_of_domain_actions<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="free">s0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="free">s0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> execs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?execs2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
             <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s_ipurge_l</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">s_f</span>"</span></span> 
             <span class="keyword1"><span class="command">unfolding</span></span> mcurrents_def B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">s_f</span>›</span></span>  <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">s_ipurge_l</span>›</span></span>
                Some 1<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s_f</span>"</span></span><span class="main">]</span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span> <span class="skolem">s_ipurge_l</span> <span class="skolem">s_ipurge_r</span> <span class="main">∧</span> <span class="free">current</span> <span class="skolem">s_ipurge_l</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">s_ipurge_r</span>"</span></span>
             <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">output_f</span> <span class="skolem">s_ipurge_l</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="skolem">s_ipurge_r</span> <span class="skolem">a</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> output_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">s_f</span>›</span></span>  <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">s_ipurge_l</span>›</span></span>
                this Some
             <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> NI_indirect_sources_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 


<span class="keyword1"><span class="command">theorem</span></span> unwinding_implies_isecure<span class="main">:</span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">isecure</span>
<span class="keyword1"><span class="command">using</span></span> unwinding_implies_NI_indirect_sources  unwinding_implies_NI_unrelated <span class="keyword1"><span class="command">unfolding</span></span> isecure_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="ISK">
<div class="head">
<h1>Theory ISK</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ISK (Interruptible Separation Kernel)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> ISK
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SK.html">SK</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

At this point, the precondition linking action to state is generic and highly unconstrained.
We refine the previous locale by given generic functions ``precondition'' and ``realistic\_trace'' a definiton.
This yields a total run function, instead of the partial one of locale Separation\_Kernel.

This definition is based on a set of valid action sequences AS\_set.
Consider for example the following action sequence:
\[\gamma = [COPY\_INIT,COPY\_CHECK,COPY\_COPY]\]
If action sequence $\gamma$ is a member of AS\_set, this means that the attack surface contains an action COPY, which consists of three consecutive atomic kernel actions.
Interrupts can occur anywhere between these atomic actions.

Given a set of valid action sequences such as $\gamma$, generic function precondition can be defined. 
It now consists of 1.) a generic invariant and 2.) more refined preconditions for the current action.

These preconditions need to be proven inductive only according to action sequences.
Assume, e.g., that $\gamma \in \mbox{AS\_set}$ and that $d$ is the currently active domain in state $s$.
The following constraints are assumed and must therefore be proven for the instantiation:
     \begin{itemize}
       \item ``AS\_precondition s d COPY\_INIT''\\ since COPY\_INIT is the start of an action sequence.
      \item ``AS\_precondition (step s COPY\_INIT) d COPY\_CHECK''\\ since (COPY\_INIT, COPY\_CHECK) is a sub sequence.
      \item ``AS\_precondition (step s COPY\_CHECK) d COPY\_COPY''\\ since (COPY\_CHECK, COPY\_COPY) is a sub sequence.
     \end{itemize}      
    Additionally, the precondition for domain $d$ must be consistent when a context switch occurs, or when ever some other domain $d'$ performs an action.
       
    Locale Interruptible\_Separation\_Kernel refines locale Separation\_Kernel in two ways.
    First, there is a definition of realistic executions.
    A realistic trace consists of action sequences from AS\_set.
 
    Secondly, the generic <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">control</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function has been refined by additional assumptions.
    It is now assumed that control conforms to one of four possibilities:
    \begin{enumerate}
    \item The execution of the currently active domain is empty and the control function returns no action.
    \item The currently active domain is executing the action sequence at the head of the execution. It returns the next kernel action of this sequence and updates the execution accordingly.
    \item The action sequence is delayed.
    \item The action sequence that is at the head of the execution is skipped and the execution is updated accordingly.
    \end{enumerate}    
    As for the state update, this is still completely unconstrained and generic as long as it respects the generic invariant and the precondition.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Interruptible_Separation_Kernel <span class="main">=</span> Separation_Kernel <span class="quoted"><span class="free">kstep</span></span> <span class="quoted"><span class="free">output_f</span></span> <span class="quoted"><span class="free">s0</span></span> <span class="quoted"><span class="free">current</span></span> <span class="quoted"><span class="free">cswitch</span></span> <span class="quoted"><span class="free">interrupt</span></span> <span class="quoted"><span class="free">kprecondition</span></span> <span class="quoted"><span class="free">realistic_execution</span></span> <span class="quoted"><span class="free">control</span></span> <span class="quoted"><span class="free">kinvolved</span></span> <span class="quoted"><span class="free">ifp</span></span> <span class="quoted"><span class="free">vpeq</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">kstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">output_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'output_t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state_t</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">current</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">=&gt;</span> <span class="tfree">'dom_t</span>"</span></span> <span class="comment1">― ‹Returns the currently active domain›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cswitch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span> <span class="comment1">― ‹Switches the current domain›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">interrupt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns t iff an interrupt occurs in the given state at the given time›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">kprecondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns t if an precondition holds that relates the current action to the state›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">realistic_execution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> execution <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹In this locale, this function is completely unconstrained.›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">control</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'action_t</span> option<span class="main">)</span> <span class="main">×</span> <span class="tfree">'action_t</span> execution <span class="main">×</span> <span class="tfree">'state_t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">kinvolved</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ifp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vpeq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> bool"</span></span>
<span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AS_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'action_t</span> list<span class="main">)</span> set"</span></span> <span class="comment1">― ‹Returns a set of valid action sequences, i.e., the attack surface›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">AS_precondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aborting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">waiting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> empty_in_AS_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">AS_set</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> invariant_s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">s0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> invariant_after_cswitch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">n</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> precondition_after_cswitch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AS_prec_first_action<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseq</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">aseq</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> <span class="bound">aseq</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="main">(</span>hd <span class="bound">aseq</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AS_prec_after_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">aseq</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">.</span> is_sub_seq <span class="bound">a</span> <span class="bound">a'</span> <span class="bound">aseq</span><span class="main">)</span> <span class="main">∧</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">aborting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">waiting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AS_prec_dom_independent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> spec_of_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="comment1">(* The refinement: functions precondition and realistic trace now have a definition. Control has been refined to four cases. *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> kprecondition_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">kprecondition</span> <span class="free">s</span> <span class="free">a</span> <span class="main">≡</span> <span class="free">invariant</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="free">s</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> realistic_execution_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">realistic_execution</span> <span class="free">aseq</span> <span class="main">≡</span> set <span class="free">aseq</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> control_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="free">control</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span>
                                 <span class="main">(</span>thread_empty <span class="bound">aseqs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="comment1">― ‹Nothing happens›</span>
                                 <span class="main">(</span><span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">aborting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">waiting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>tl <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>tl <span class="bound">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="comment1">― ‹Execute the first action of the current action sequence›</span>
                                 <span class="main">(</span><span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">waiting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">aseqs</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="comment1">― ‹Nothing happens, waiting to execute the next action›</span>
                                 <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span>tl <span class="bound">aseqs</span><span class="main">)</span>"</span></span> <span class="comment1">(* The current action sequence is skipped *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> next_action_after_cswitch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">n</span> <span class="bound">d</span> <span class="bound">aseqs</span> <span class="main">.</span> fst <span class="main">(</span><span class="free">control</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">control</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> next_action_after_next_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="bound">d</span>  <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">⟶</span>  fst <span class="main">(</span><span class="free">control</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None <span class="main">∨</span> fst <span class="main">(</span><span class="free">control</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">control</span> <span class="bound">s</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> next_action_after_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">d</span> <span class="bound">aseqs</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">control</span> <span class="main">(</span>step <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">control</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> next_state_precondition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">execs</span><span class="main">.</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> next_state_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> spec_of_waiting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">waiting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now formulate a total run function, since based on the new assumptions the case where the precondition does not hold, will never occur.
›</span></span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">run_total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">run_total</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run_total</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free">run_total</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> thread_empty<span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run_total</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free">run_total</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>thread_empty<span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">run_total</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free">run_total</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span> <span class="main">(</span>next_action <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> not0_implies_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The major part of the proofs in this locale consist of proving that function run\_total is equivalent to function run, i.e., that the precondition does always hold.
  This assumes that the executions are \emph{realistic}.
  This means that the execution of each domain contains action sequences that are from AS\_set.
  This ensures, e.g, that a COPY\_CHECK is always preceded by a COPY\_INIT.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">realistic_executions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">realistic_executions</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">.</span> <span class="free">realistic_execution</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Lemma run\_total\_equals\_run is proven by doing induction.
  It is however not inductive and can therefore not be proven directly: a realistic execution is not necessarily realistic after performing one action.
  We generalize to do induction.
  Predicate realistic\_executions\_ind is the inductive version of realistic\_executions. All action sequences in the tail of the executions must be complete action sequences (i.e., they must be from AS\_set).
  The first action sequence, however, is being executed and is therefore not necessarily an action sequence from AS\_set, but it is \emph{the last part}
  of some action sequence from AS\_set.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">realistic_AS_partial</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">realistic_AS_partial</span> <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">n</span> <span class="bound">aseq'</span> <span class="main">.</span>  <span class="bound">n</span> <span class="main">≤</span> length <span class="bound">aseq'</span> <span class="main">∧</span> <span class="bound">aseq'</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">=</span> lastn <span class="bound">n</span> <span class="bound">aseq'</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">realistic_executions_ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">realistic_executions_ind</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="bound">d</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">aseq</span><span class="main">#</span><span class="bound">aseqs</span><span class="main">)</span> <span class="main">⇒</span> realistic_AS_partial <span class="bound">aseq</span> <span class="main">∧</span> set <span class="bound">aseqs</span> <span class="main">⊆</span> <span class="free">AS_set</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We need to know that invariably, the precondition holds.
  As this precondition consists of 1.) a generic invariant and 2.) more refined preconditions for the current action, we have to know that these two are invariably true.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">precondition_ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">precondition_ind</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">≡</span> <span class="free">invariant</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">.</span> fst<span class="main">(</span><span class="free">control</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span> <span class="free">AS_precondition</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Proof that ``execution is realistic" is inductive, i.e., 
  assuming the current execution is realistic, the execution returned by the control mechanism is realistic.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> next_execution_is_realistic_partial<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> na_def<span class="main">:</span> <span class="quoted"><span class="quoted">"next_execs <span class="free">s</span> <span class="free">execs</span> <span class="free">d</span> <span class="main">=</span> <span class="free">aseq</span> <span class="main">#</span> <span class="free">aseqs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d_is_curr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="free">current</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> realistic<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions_ind <span class="free">execs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thread_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="free">execs</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"realistic_AS_partial <span class="free">aseq</span> <span class="main">∧</span> set <span class="free">aseqs</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">control</span> <span class="free">s</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">execs</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">assume</span></span> c_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?c</span> <span class="keyword1">in</span>
              <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">from</span></span> na_def d_is_curr c_empty
   <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> realistic_executions_ind_def next_execs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ct</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?execs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tl <span class="main">(</span>hd <span class="var">?ct</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>tl <span class="var">?ct</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="var">?ct</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> hd_thread_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="free">execs</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> c_executing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?c</span> <span class="keyword1">in</span>
                            <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?a'</span><span class="main">,</span> <span class="var">?execs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> na_def c_executing d_is_curr
    <span class="keyword1"><span class="command">have</span></span> as_defs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aseq</span> <span class="main">=</span> tl <span class="main">(</span>hd <span class="var">?ct</span><span class="main">)</span> <span class="main">∧</span> <span class="free">aseqs</span> <span class="main">=</span> tl <span class="var">?ct</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>                                        
  <span class="keyword1"><span class="command">from</span></span> realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span><span class="main">]</span> d_is_curr
    <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>tl <span class="var">?execs'</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def realistic_AS_partial_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="free">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> d_is_curr thread_not_empty hd_thread_not_empty realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">aseq'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_aseq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">aseq'</span> <span class="main">∧</span> <span class="skolem">aseq'</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> hd <span class="var">?ct</span> <span class="main">=</span> lastn <span class="skolem">n</span> <span class="skolem">aseq'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> realistic_AS_partial_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="free">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this hd_thread_not_empty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lastn_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this n_aseq' lastn_one_less<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">aseq'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"hd <span class="main">(</span>hd <span class="var">?ct</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tl <span class="main">(</span>hd <span class="var">?ct</span><span class="main">)</span>"</span></span><span class="main">]</span> hd_thread_not_empty
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> length <span class="skolem">aseq'</span> <span class="main">∧</span> <span class="skolem">aseq'</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> tl <span class="main">(</span>hd <span class="var">?ct</span><span class="main">)</span> <span class="main">=</span> lastn <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">aseq'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this as_defs subset <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> realistic_AS_partial_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ct</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?execs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ct</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="var">?ct</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> c_waiting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?c</span> <span class="keyword1">in</span>
                            <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?a'</span><span class="main">,</span> <span class="var">?execs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> na_def c_waiting d_is_curr
    <span class="keyword1"><span class="command">have</span></span> as_defs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aseq</span> <span class="main">=</span> hd <span class="var">?execs'</span> <span class="main">∧</span> <span class="free">aseqs</span> <span class="main">=</span> tl <span class="var">?execs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>                                        
  <span class="keyword1"><span class="command">from</span></span> realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span><span class="main">]</span> d_is_curr set_tl_is_subset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?execs'</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>tl <span class="var">?execs'</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def realistic_AS_partial_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="free">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> na_def c_waiting d_is_curr
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?execs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span><span class="main">]</span> d_is_curr thread_not_empty
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">aseq'</span></span> <span class="keyword2"><span class="keyword">where</span></span> witness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">aseq'</span> <span class="main">∧</span> <span class="skolem">aseq'</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> hd<span class="main">(</span><span class="free">execs</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> lastn <span class="skolem">n</span> <span class="skolem">aseq'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> realistic_AS_partial_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="free">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> d_is_curr this subset as_defs <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> realistic_AS_partial_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>            
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ct</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?execs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tl <span class="var">?ct</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"None"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> c_aborting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?c</span> <span class="keyword1">in</span>
                            <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?a'</span><span class="main">,</span> <span class="var">?execs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> na_def c_aborting d_is_curr
    <span class="keyword1"><span class="command">have</span></span> as_defs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aseq</span> <span class="main">=</span> hd <span class="var">?execs'</span> <span class="main">∧</span> <span class="free">aseqs</span> <span class="main">=</span> tl <span class="var">?execs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>                                        
  <span class="keyword1"><span class="command">from</span></span> realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span><span class="main">]</span> d_is_curr set_tl_is_subset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?execs'</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>tl <span class="var">?execs'</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def realistic_AS_partial_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="free">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> na_def c_aborting d_is_curr
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?execs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> empty_in_AS_set this
    realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span><span class="main">]</span> d_is_curr
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>hd <span class="var">?execs'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>hd <span class="var">?execs'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>hd <span class="var">?execs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> hd <span class="var">?execs'</span> <span class="main">=</span> lastn <span class="main">(</span>length <span class="main">(</span>hd <span class="var">?execs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hd <span class="var">?execs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lastn_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this subset as_defs <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> realistic_AS_partial_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span>
<span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="main">(</span><span class="free">current</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">]</span>
        d_is_curr thread_not_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
            
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The lemma that proves that the total run function is equivalent to the partial run function, i.e., that in this refinement the case of the run function where the precondition is False will never occur.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> run_total_equals_run<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> realistic_exec<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions <span class="free">execs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">s</span>"</span></span>      
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="free">n</span> <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span> <span class="free">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="free">n</span> <span class="free">s</span> <span class="free">execs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">ms</span> <span class="skolem">s</span> <span class="skolem">execs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_equal <span class="skolem">ms</span> <span class="skolem">s</span> <span class="main">∧</span> realistic_executions_ind <span class="skolem">execs</span> <span class="main">∧</span> precondition_ind <span class="skolem">s</span> <span class="skolem">execs</span> <span class="main">⟶</span> strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="skolem">ms</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">ms</span></span> <span class="quoted"><span class="skolem">execs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> run.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">sa</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">sa</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">sa</span><span class="main">.</span> strict_equal <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">sa</span> <span class="main">∧</span> realistic_executions_ind <span class="skolem">execs</span> <span class="main">∧</span> precondition_ind <span class="bound">sa</span> <span class="skolem">execs</span> <span class="main">⟶</span>
             strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="bound">sa</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> equal_s_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">sa</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> realistic<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions_ind <span class="skolem">execs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> inv_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition_ind <span class="skolem">sa</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> inv_nsa<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition_ind <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">control</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">execs</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">d</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> next_action_after_cswitch inv_sa<span class="main">[</span><span class="operator">unfolded</span> precondition_ind_def<span class="main">,</span><span class="operator">THEN</span> conjunct2<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span>
                  precondition_after_cswitch 
            <span class="keyword1"><span class="command">unfolding</span></span> Let_def B_def precondition_ind_def 
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">control</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">execs</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_sa invariant_after_cswitch <span class="keyword1"><span class="command">unfolding</span></span> precondition_ind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>          
      <span class="keyword1"><span class="command">from</span></span> equal_s_sa realistic inv_nsa inv_sa IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sa<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">sa</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> equal_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this interrupt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">sa</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">sa</span><span class="main">.</span> strict_equal <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="bound">sa</span> <span class="main">∧</span> realistic_executions_ind <span class="skolem">execs</span> <span class="main">∧</span> precondition_ind <span class="bound">sa</span> <span class="skolem">execs</span> <span class="main">⟶</span> strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="bound">sa</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> current_s_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">sa</span> <span class="main">⟶</span> <span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">sa</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> equal_s_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">sa</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> realistic<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions_ind <span class="skolem">execs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> inv_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition_ind <span class="skolem">sa</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> equal_s_sa realistic inv_sa IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sa<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">sa</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> equal_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="skolem">sa</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this current_s_sa thread_empty not_interrupt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">sa</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_prec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹In locale ISK, the precondition can be proven to hold at all times. This case cannot happen, and we can prove False.›</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> equal_s_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">sa</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> realistic<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions_ind <span class="skolem">execs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> inv_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition_ind <span class="skolem">sa</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> equal_s_sa <span class="keyword1"><span class="command">have</span></span> s_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">sa</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> inv_sa <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"next_action <span class="skolem">sa</span> <span class="skolem">execs</span> <span class="main">⇀</span> <span class="free">AS_precondition</span> <span class="skolem">sa</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">sa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> precondition_ind_def B_def next_action_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">sa</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this next_state_precondition
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">sa</span> <span class="skolem">execs</span> <span class="main">⇀</span> <span class="free">AS_precondition</span> <span class="main">(</span>next_state <span class="skolem">sa</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">sa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> precondition_ind_def B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">sa</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> inv_sa this s_sa next_state_invariant current_next_state
        <span class="keyword1"><span class="command">have</span></span> prec_s<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> precondition_ind_def kprecondition_def precondition_def B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">sa</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this not_prec <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">n</span> <span class="skolem">execs</span> <span class="skolem">s</span> <span class="skolem">sa</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not_interrupt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> thread_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>thread_empty<span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">sa</span><span class="main">.</span> strict_equal <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">sa</span> <span class="main">∧</span>
             realistic_executions_ind <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">∧</span> precondition_ind <span class="bound">sa</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">⟶</span>
             strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="bound">sa</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> current_s_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">sa</span> <span class="main">⟶</span> <span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">sa</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>            
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> equal_s_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>Some <span class="skolem">s</span><span class="main">)</span> <span class="skolem">sa</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> realistic<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions_ind <span class="skolem">execs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> inv_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition_ind <span class="skolem">sa</span> <span class="skolem">execs</span>"</span></span>
     
      <span class="keyword1"><span class="command">from</span></span> equal_s_sa <span class="keyword1"><span class="command">have</span></span> s_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">sa</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="var">?a</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?na</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"next_execs <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">control</span> <span class="skolem">s</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> equal_ns_nsa<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>Some <span class="var">?ns</span><span class="main">)</span> <span class="var">?ns</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> inv_sa equal_s_sa <span class="keyword1"><span class="command">have</span></span> inv_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def precondition_ind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="comment1">― ‹Two things are proven inductive. First, the assumptions that the execution is realistic (statement realistic-na). This proof uses lemma next-execution-is-realistic-partial.
          Secondly, the precondition: if the precondition holds for the current action, then it holds for the next action (statement invariant-na).›</span>
      <span class="keyword1"><span class="command">have</span></span> realistic_na<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions_ind <span class="var">?na</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="var">?na</span> <span class="skolem">d</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="bound">aseq</span> <span class="main">#</span> <span class="bound">aseqs</span> <span class="main">⇒</span> realistic_AS_partial <span class="bound">aseq</span> <span class="main">∧</span> set <span class="bound">aseqs</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rename_tac</span> aseq aseqs<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aseq</span> <span class="skolem">aseqs</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next_execs <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">aseq</span> <span class="main">#</span> <span class="skolem">aseqs</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> False this realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"realistic_AS_partial <span class="skolem">aseq</span> <span class="main">∧</span> set <span class="skolem">aseqs</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aseq</span> <span class="skolem">aseqs</span>
            <span class="keyword3"><span class="command">assume</span></span> na_def<span class="main">:</span> <span class="quoted"><span class="quoted">"next_execs <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">aseq</span> <span class="main">#</span> <span class="skolem">aseqs</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> next_execution_is_realistic_partial na_def True realistic thread_not_empty
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"realistic_AS_partial <span class="skolem">aseq</span> <span class="main">∧</span> set <span class="skolem">aseqs</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> realistic_executions_ind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> invariant_na<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition_ind <span class="var">?ns</span> <span class="var">?na</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> spec_of_invariant inv_sa next_state_invariant s_sa <span class="keyword1"><span class="command">have</span></span> inv_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="var">?ns</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> precondition_ind_def step_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">sa</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> fst <span class="main">(</span><span class="free">control</span> <span class="var">?ns</span> <span class="bound">d</span> <span class="main">(</span><span class="var">?na</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span> <span class="free">AS_precondition</span> <span class="var">?ns</span> <span class="bound">d</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
          <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">control</span> <span class="var">?ns</span> <span class="skolem">d</span> <span class="main">(</span><span class="var">?na</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> snd_action_not_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a'</span> <span class="main">≠</span> None"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">AS_precondition</span> <span class="var">?ns</span> <span class="skolem">d</span> <span class="main">(</span>the <span class="var">?a'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
                <span class="comment1">― ‹Assuming that the current domain executes some action a, and assuming that the action a' after that is not None (statement snd-action-not-none),
                    we prove that the precondition is inductive, i.e., it will hold for a'.
                    Two cases arise: either action a is delayed (case waiting) or not (case executing).›</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span>case_split<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> waiting executing<span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> executing <span class="comment1">― ‹The kernel is executing two consecutive actions a and a'. We show that [a,a'] is a subsequence in some action in AS-set.
                                   The PO's ensure that the precondition is inductive.›</span> 
                  <span class="keyword1"><span class="command">from</span></span> executing True Some control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                    <span class="keyword1"><span class="command">have</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> hd <span class="main">(</span>hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?na</span> <span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span>tl <span class="main">(</span>hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>tl <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> next_action_def next_execs_def Let_def
                    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">from</span></span> a_def True snd_action_not_none control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ns</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                    second_elt_is_hd_tl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"hd<span class="main">(</span>tl<span class="main">(</span>hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tl <span class="main">(</span>tl<span class="main">(</span>hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
                    <span class="keyword1"><span class="command">have</span></span> na_def<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="var">?a'</span> <span class="main">=</span> <span class="main">(</span>hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="main">1</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def
                    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>                    
                  <span class="keyword1"><span class="command">from</span></span> Some realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> True thread_not_empty
                    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">aseq'</span></span> <span class="keyword2"><span class="keyword">where</span></span> witness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">aseq'</span> <span class="main">∧</span> <span class="skolem">aseq'</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> hd<span class="main">(</span><span class="skolem">execs</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> lastn <span class="skolem">n</span> <span class="skolem">aseq'</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> realistic_AS_partial_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">from</span></span> True executing length_lt_2_implies_tl_empty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
                    Some control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                    snd_action_not_none control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ns</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                    <span class="keyword1"><span class="command">have</span></span> in_action_sequence<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> next_action_def next_execs_def
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> this witness consecutive_is_sub_seq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="var">?a'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">aseq'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tl <span class="main">(</span>tl <span class="main">(</span>hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 
                    a_def na_def True in_action_sequence
                    x_is_hd_snd_tl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
                    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">aseq'</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">.</span> is_sub_seq <span class="skolem">a</span> <span class="main">(</span>the <span class="var">?a'</span><span class="main">)</span> <span class="bound">aseq'</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">from</span></span> True Some inv_sa<span class="main">[</span><span class="operator">unfolded</span> precondition_ind_def<span class="main">,</span><span class="operator">THEN</span> conjunct2<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span>"</span></span><span class="main">]</span> s_sa 
                    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AS_precondition</span> <span class="skolem">s</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def next_action_def B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> executing True Some control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                    <span class="keyword1"><span class="command">have</span></span> not_aborting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">aborting</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>the <span class="var">?a</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> next_action_def next_state_def next_execs_def
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> executing True Some control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                    <span class="keyword1"><span class="command">have</span></span> not_waiting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">waiting</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>the <span class="var">?a</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> next_action_def next_state_def next_execs_def
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>                  
                  <span class="keyword1"><span class="command">from</span></span> True this
                    1 2 inv_s
                    sub_seq_in_prefixes<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">AS_set</span></span><span class="main">]</span> Some next_state_invariant
                    current_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span><span class="main">]</span>
                    AS_prec_after_step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="var">?a'</span>"</span></span><span class="main">]</span>
                    next_state_precondition not_aborting not_waiting 
                    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> step_def
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> waiting <span class="comment1">― ‹The kernel is delaying action a. Thus the action after a, which is a', is equal to a.›</span>
                    <span class="keyword1"><span class="command">from</span></span> tl_hd_x_not_tl_x<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span> True waiting control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span> Some
                      <span class="keyword1"><span class="command">have</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> next_state <span class="skolem">s</span> <span class="skolem">execs</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="free">waiting</span> <span class="skolem">s</span> <span class="skolem">d</span> <span class="main">(</span>the <span class="var">?a</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">unfolding</span></span> next_action_def next_execs_def next_state_def
                      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> Some waiting a_def True snd_action_not_none control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ns</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                      <span class="keyword1"><span class="command">have</span></span> na_def<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="var">?a'</span> <span class="main">=</span> hd <span class="main">(</span>hd <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">unfolding</span></span> next_action_def next_execs_def
                      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> spec_of_waiting a_def True
                      <span class="keyword1"><span class="command">have</span></span> no_step<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">s</span> <span class="var">?a</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> step_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> no_step Some True a_def 
                          inv_sa<span class="main">[</span><span class="operator">unfolded</span> precondition_ind_def<span class="main">,</span><span class="operator">THEN</span> conjunct2<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span>"</span></span><span class="main">]</span> s_sa
                      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AS_precondition</span> <span class="skolem">s</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>the <span class="var">?a'</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">unfolding</span></span> next_action_def B_def 
                      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> a_def na_def this True Some no_step
                      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                      <span class="keyword1"><span class="command">unfolding</span></span> step_def
                      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> None
                <span class="comment1">― ‹Assuming that the current domain does not execute an action, and assuming that the action a' after that is not None (statement snd-action-not-none),
                    we prove that the precondition is inductive, i.e., it will hold for a'.
                    This holds, since the control mechanism will ensure that action a' is the start of a new action sequence in AS-set.›</span>              
                <span class="keyword1"><span class="command">from</span></span> None True snd_action_not_none control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ns</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                     control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">have</span></span> na_def<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="var">?a'</span> <span class="main">=</span> hd <span class="main">(</span>hd <span class="main">(</span>tl <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?na</span> <span class="skolem">d</span> <span class="main">=</span> tl <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> next_action_def next_execs_def
                  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> True None snd_action_not_none control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ns</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
                     this
                  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="main">(</span>tl <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">from</span></span> this realistic<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_ind_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> True thread_not_empty
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>tl <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AS_set</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> True snd_action_not_none this
                  inv_ns this na_def 1
                  AS_prec_first_action<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ns</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"hd <span class="main">(</span>tl <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ns</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">]</span>
                    thread_not_empty True snd_action_not_none
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> equal_na_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?na</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">execs</span> <span class="skolem">d</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> next_execs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> this False current_next_state next_action_after_step
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a'</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">control</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> next_action_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> inv_sa<span class="main">[</span><span class="operator">unfolded</span> precondition_ind_def<span class="main">,</span><span class="operator">THEN</span> conjunct2<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> s_sa equal_na_a  this
                 next_action_after_next_state<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span><span class="main">]</span>
                 snd_action_not_none False
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">AS_precondition</span> <span class="skolem">s</span> <span class="skolem">d</span> <span class="main">(</span>the <span class="var">?a'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> precondition_ind_def next_action_def B_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">control</span> <span class="skolem">sa</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">execs</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> equal_na_a False this next_state_precondition current_next_state
              AS_prec_dom_independent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x3<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"next_state <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="var">?a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="var">?a'</span>"</span></span><span class="main">]</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">unfolding</span></span> step_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">control</span> <span class="var">?ns</span> <span class="skolem">d</span> <span class="main">(</span><span class="var">?na</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span> <span class="free">AS_precondition</span> <span class="var">?ns</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">control</span> <span class="var">?ns</span> <span class="skolem">d</span> <span class="main">(</span><span class="var">?na</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> this inv_ns <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> precondition_ind_def B_def Let_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> equal_ns_nsa realistic_na invariant_na s_sa IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sa<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ns</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> equal_ns_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="var">?ns</span><span class="main">)</span> <span class="var">?na</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="main">(</span>step <span class="main">(</span>next_state <span class="skolem">sa</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_action <span class="skolem">sa</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>next_execs <span class="skolem">sa</span> <span class="skolem">execs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this current_s_sa thread_not_empty not_interrupt prec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">hence</span></span> thm_inductive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">m</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="bound">n</span> <span class="main">.</span> strict_equal <span class="bound">m</span> <span class="bound">s</span> <span class="main">∧</span> realistic_executions_ind <span class="bound">execs</span> <span class="main">∧</span> precondition_ind <span class="bound">s</span> <span class="bound">execs</span> <span class="main">⟶</span> strict_equal <span class="main">(</span>run <span class="bound">n</span> <span class="bound">m</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="bound">n</span> <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions_ind <span class="free">execs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">execs</span> <span class="skolem">d</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="bound">aseq</span> <span class="main">#</span> <span class="bound">aseqs</span> <span class="main">⇒</span> realistic_AS_partial <span class="bound">aseq</span> <span class="main">∧</span> set <span class="bound">aseqs</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="skolem">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">aseq</span> <span class="skolem">aseqs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons realistic_exec<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">aseq</span> <span class="main">≤</span> length <span class="skolem">aseq</span> <span class="main">∧</span> <span class="skolem">aseq</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> <span class="skolem">aseq</span> <span class="main">=</span> lastn <span class="main">(</span>length <span class="skolem">aseq</span><span class="main">)</span> <span class="skolem">aseq</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lastn_def realistic_execution_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_AS_partial <span class="skolem">aseq</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> realistic_AS_partial_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Cons realistic_exec<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">aseqs</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> realistic_execution_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Cons 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> realistic_executions_ind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>   
<span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"precondition_ind <span class="free">s</span> <span class="free">execs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">control</span> <span class="free">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="free">execs</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
      <span class="keyword1"><span class="command">from</span></span> not_empty realistic_exec<span class="main">[</span><span class="operator">unfolded</span> realistic_executions_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> current_aseq_is_realistic<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="free">execs</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AS_set</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> realistic_execution_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="skolem">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> not_empty current_aseq_is_realistic invariant AS_prec_first_action<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="free">execs</span> <span class="skolem">d</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">AS_precondition</span> <span class="free">s</span> <span class="skolem">d</span> <span class="main">(</span>the <span class="main">(</span>fst <span class="main">(</span><span class="free">control</span> <span class="free">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="free">execs</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> control_spec<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">execs</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">control</span> <span class="free">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="free">execs</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">⇀</span> <span class="free">AS_precondition</span> <span class="free">s</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">" fst <span class="main">(</span><span class="free">control</span> <span class="free">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="free">execs</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this invariant <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> precondition_ind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">from</span></span> thm_inductive 1 2 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Theorem unwinding\_implies\_isecure gives security for all realistic executions.
  For unrealistic executions, it holds vacuously and therefore does not tell us anything.
  In order to prove security for this refinement (i.e., for function run\_total), we have to prove that purging yields realistic runs.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> realistic_purge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">execs</span> <span class="bound">d</span> <span class="main">.</span> realistic_executions <span class="bound">execs</span> <span class="main">⟶</span> realistic_executions <span class="main">(</span>purge <span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"realistic_executions <span class="skolem">execs</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"realistic_executions <span class="main">(</span>purge <span class="skolem">execs</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> someI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">realistic_execution</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> realistic_executions_def purge_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_gateway_comm_subset<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove_gateway_communications <span class="free">d</span> <span class="free">exec</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">exec</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">exec</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> realistic_ipurge_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">execs</span> <span class="bound">d</span> <span class="main">.</span> realistic_executions <span class="bound">execs</span> <span class="main">⟶</span> realistic_executions <span class="main">(</span>ipurge_l <span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions <span class="skolem">execs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> empty_in_AS_set remove_gateway_comm_subset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> exec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"realistic_executions <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> realistic_execution_def realistic_executions_def ipurge_l_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> realistic_ipurge_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">execs</span> <span class="bound">d</span> <span class="main">.</span> realistic_executions <span class="bound">execs</span> <span class="main">⟶</span> realistic_executions <span class="main">(</span>ipurge_r <span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions <span class="skolem">execs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> empty_in_AS_set remove_gateway_comm_subset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> exec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"realistic_executions <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> someI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">realistic_execution</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">execs</span> <span class="skolem">d</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> realistic_execution_def realistic_executions_def ipurge_r_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now have sufficient lemma's to prove security for run\_total.
  The definition of security is similar to that in Section~\ref{sec:sep_kernel}.
  It now assumes that the executions are realistic and concerns function run\_total instead of function run.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NI_unrelated_total</span><span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NI_unrelated_total</span>
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs</span> <span class="bound">a</span> <span class="bound">n</span> <span class="main">.</span> realistic_executions <span class="bound">execs</span> <span class="main">⟶</span>
                     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s_f</span> <span class="main">=</span> run_total <span class="bound">n</span> <span class="free">s0</span> <span class="bound">execs</span> <span class="keyword1">in</span>
                       <span class="free">output_f</span> <span class="bound">s_f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="main">(</span>run_total <span class="bound">n</span> <span class="free">s0</span> <span class="main">(</span>purge <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span>
                        <span class="main">∧</span> <span class="free">current</span> <span class="bound">s_f</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span>run_total <span class="bound">n</span> <span class="free">s0</span> <span class="main">(</span>purge <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NI_indirect_sources_total</span><span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NI_indirect_sources_total</span>
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs</span> <span class="bound">a</span> <span class="bound">n</span><span class="main">.</span> realistic_executions <span class="bound">execs</span> <span class="main">⟶</span>
                    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s_f</span> <span class="main">=</span> run_total <span class="bound">n</span> <span class="free">s0</span> <span class="bound">execs</span> <span class="keyword1">in</span>
                      <span class="free">output_f</span> <span class="main">(</span>run_total <span class="bound">n</span> <span class="free">s0</span> <span class="main">(</span>ipurge_l <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span>
                      <span class="free">output_f</span> <span class="main">(</span>run_total <span class="bound">n</span> <span class="free">s0</span> <span class="main">(</span>ipurge_r <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isecure_total</span><span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isecure_total</span> <span class="main">≡</span> NI_unrelated_total <span class="main">∧</span> NI_indirect_sources_total"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> unwinding_implies_isecure_total<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">isecure_total</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> unwinding_implies_isecure <span class="keyword1"><span class="command">have</span></span> secure_partial<span class="main">:</span> <span class="quoted"><span class="quoted">"NI_unrelated"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> isecure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> unwinding_implies_isecure <span class="keyword1"><span class="command">have</span></span> isecure1_partial<span class="main">:</span> <span class="quoted"><span class="quoted">"NI_indirect_sources"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> isecure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> NI_unrelated_total<span class="main">:</span> <span class="quoted">NI_unrelated_total</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">a</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> realistic<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions <span class="skolem">execs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> invariant_s0 realistic run_total_equals_run<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> execs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s_f</span> <span class="main">=</span> run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="skolem">execs</span> <span class="keyword1">in</span> <span class="free">output_f</span> <span class="bound">s_f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s_f</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> NI_unrelated_total_def strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s_f</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> realistic_purge invariant_s0 realistic run_total_equals_run<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> execs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"purge <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>purge <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">from</span></span> 2 None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> NI_unrelated_total_def strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s_f2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">s_f</span>›</span></span> Some 1 2  secure_partial<span class="main">[</span><span class="operator">unfolded</span> NI_unrelated_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span><span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def NI_unrelated_def
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def B_def B2_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> NI_unrelated_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> NI_indirect_sources_total<span class="main">:</span> <span class="quoted">NI_indirect_sources_total</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">execs</span> <span class="skolem">a</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> realistic<span class="main">:</span> <span class="quoted"><span class="quoted">"realistic_executions <span class="skolem">execs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> invariant_s0 realistic run_total_equals_run<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> execs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s_f</span> <span class="main">=</span> run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="skolem">execs</span> <span class="keyword1">in</span> <span class="free">output_f</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> NI_unrelated_total_def strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s_f</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> realistic_ipurge_l invariant_s0 realistic run_total_equals_run<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> execs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> realistic_ipurge_r invariant_s0 realistic run_total_equals_run<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> execs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ipurge_r <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_equal <span class="main">(</span>run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_total <span class="skolem">n</span> <span class="free">s0</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">from</span></span> 2 None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> NI_unrelated_total_def strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s_ipurge_l</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_r <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">from</span></span> 3 None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> NI_unrelated_total_def strict_equal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">s_ipurge_r</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">s_f</span>›</span></span> <span class="quoted"><span class="quoted">‹run <span class="skolem">n</span> <span class="main">(</span>Some <span class="free">s0</span><span class="main">)</span> <span class="main">(</span>ipurge_l <span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s_f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">s_ipurge_l</span>›</span></span>
                  Some 1 2 3 isecure1_partial<span class="main">[</span><span class="operator">unfolded</span> NI_indirect_sources_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">execs</span></span><span class="main">]</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> strict_equal_def NI_unrelated_def
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def B_def B2_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> NI_indirect_sources_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> NI_unrelated_total NI_indirect_sources_total <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> isecure_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CISK">
<div class="head">
<h1>Theory CISK</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹CISK (Controlled Interruptible Separation Kernel)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CISK
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="ISK.html">ISK</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This section presents a generic model of a Controlled Interruptible Separation Kernel (CISK).
  It formulates security, i.e., intransitive noninterference.
  For a presentation of this model, see Section 2 of~\cite{Verbeek2013}.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  First, a locale is defined that defines all generic functions and all proof obligations (see Section 2.3 of ~\cite{Verbeek2013}).
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> Controllable_Interruptible_Separation_Kernel <span class="main">=</span> <span class="comment1">― ‹CISK›</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">kstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span> <span class="comment1">― ‹Executes one atomic kernel action›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">output_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'output_t</span>"</span></span> <span class="comment1">― ‹Returns the observable behavior›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span>"</span></span> <span class="comment1">― ‹The initial state›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">current</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">=&gt;</span> <span class="tfree">'dom_t</span>"</span></span> <span class="comment1">― ‹Returns the currently active domain›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cswitch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span> <span class="comment1">― ‹Performs a context switch›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">interrupt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns t iff an interrupt occurs in the given state at the given time›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">kinvolved</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> set"</span></span> <span class="comment1">― ‹Returns the set of domains that are involved in the given action›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ifp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹The security policy.›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vpeq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹View partitioning equivalence›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">AS_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'action_t</span> list<span class="main">)</span> set"</span></span> <span class="comment1">― ‹Returns a set of valid action sequences, i.e., the attack surface›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns an inductive state-invariant›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">AS_precondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns the preconditions under which the given action can be executed.›</span>  
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aborting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns true iff the action is aborted.›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">waiting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Returns true iff execution of the given action is delayed.›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set_error_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span> <span class="comment1">― ‹Sets an error code when actions are aborted.›</span>
<span class="keyword2"><span class="keyword">assumes</span></span> vpeq_transitive<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vpeq_symmetric<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">u</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">b</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vpeq_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">u</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifp_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">u</span> <span class="bound">u</span>"</span></span>     
    <span class="keyword2"><span class="keyword">and</span></span> weakly_step_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">invariant</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">t</span> <span class="main">(</span><span class="free">current</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span>  <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> locally_respects<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">.</span> <span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span>  <span class="main">∧</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> output_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">output_f</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">output_f</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_atomicity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">current</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cswitch_independent_of_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cswitch_consistency<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> empty_in_AS_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">AS_set</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> invariant_s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">s0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> invariant_after_cswitch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">n</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> precondition_after_cswitch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AS_prec_first_action<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseq</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">aseq</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> <span class="bound">aseq</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="main">(</span>hd <span class="bound">aseq</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AS_prec_after_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">aseq</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">.</span> is_sub_seq <span class="bound">a</span> <span class="bound">a'</span> <span class="bound">aseq</span><span class="main">)</span> <span class="main">∧</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">aborting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">waiting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span><span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AS_prec_dom_independent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> spec_of_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aborting_switch_independent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span> <span class="bound">s</span> <span class="main">.</span> <span class="free">aborting</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">aborting</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aborting_error_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a'</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> <span class="free">aborting</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">aborting</span> <span class="main">(</span><span class="free">set_error_code</span> <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aborting_after_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">d</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">⟶</span> <span class="free">aborting</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">d</span> <span class="main">=</span> <span class="free">aborting</span> <span class="bound">s</span> <span class="bound">d</span>"</span></span> <span class="comment1">(* TODO: I think this PO can be removed *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> aborting_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">aborting</span> <span class="bound">s</span> <span class="bound">u</span> <span class="main">=</span> <span class="free">aborting</span> <span class="bound">t</span> <span class="bound">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> waiting_switch_independent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span> <span class="bound">s</span> <span class="main">.</span> <span class="free">waiting</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">waiting</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> waiting_error_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a'</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> <span class="free">waiting</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">waiting</span> <span class="main">(</span><span class="free">set_error_code</span> <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> waiting_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> <span class="free">kinvolved</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">waiting</span> <span class="bound">s</span> <span class="bound">u</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">waiting</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> spec_of_waiting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">waiting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> set_error_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span><span class="free">set_error_code</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">set_error_code</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> set_error_locally_respects<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">u</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span><span class="free">set_error_code</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> current_set_error_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">current</span> <span class="main">(</span><span class="free">set_error_code</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> precondition_after_set_error_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">aborting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">set_error_code</span> <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> invariant_after_set_error_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">set_error_code</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> involved_ifp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">(</span><span class="free">kinvolved</span> <span class="bound">a</span><span class="main">)</span> <span class="main">.</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">ifp</span> <span class="bound">d</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span>"</span></span>  
<span class="keyword2"><span class="keyword">begin</span></span>  

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Execution semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Control is based on generic functions \emph{aborting}, \emph{waiting} and \emph{set\_error\_code}.
  Function \emph{aborting} decides whether a certain action is aborting, given its domain and the state.
  If so, then function set\_error\_code will be used to update the state, possibly communicating to other domains that an action has been aborted.
  Function \emph{waiting} can delay the execution of an action.
  This behavior is implemented in function CISK\_control.
›</span></span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">CISK_control</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'action_t</span> option <span class="main">×</span> <span class="tfree">'action_t</span> execution <span class="main">×</span> <span class="tfree">'state_t</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CISK_control</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">[]</span>                <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="comment1">― ‹The thread is empty›</span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CISK_control</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">#</span><span class="main">[]</span><span class="main">)</span>           <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="comment1">― ‹The current action sequence has been finished and the thread has no next action sequences to execute›</span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CISK_control</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">execs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span><span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">execs'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="comment1">― ‹The current action sequence has been finished. Skip to the next sequence›</span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CISK_control</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">execs'</span></span></span><span class="main">)</span>   <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">aborting</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> 
                                                  <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">execs'</span></span></span><span class="main">,</span><span class="free">set_error_code</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>
                                               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">waiting</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span>
                                                  <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">execs'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
                                               <span class="keyword1">else</span>
                                                  <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">execs'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹Executing an action sequence›</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Function \emph{run} defines the execution semantics.
  This function is presented in ~\cite{Verbeek2013} by pseudo code (see Algorithm 1).
  Before defining the run function, we define accessor functions for the control mechanism.
  Functions next\_action, next\_execs and next\_state correspond to ``control.a'', ``control.x'' and ``control.s'' in ~\cite{Verbeek2013}.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_action</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">next_action</span> <span class="main">≡</span> Kernel.next_action <span class="free">current</span> CISK_control"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_execs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">next_execs</span>  <span class="main">≡</span> Kernel.next_execs <span class="free">current</span> CISK_control"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_state</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">next_state</span>  <span class="main">≡</span> Kernel.next_state <span class="free">current</span> CISK_control"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A thread is empty iff either it has no further action sequences to execute, or when the current action sequence is finished and there are no further action sequences to execute.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">thread_empty</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'action_t</span> execution <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">thread_empty</span> <span class="free"><span class="bound"><span class="entity">exec</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">exec</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">exec</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  The following function defines the execution semantics of CISK, using function CISK\_control.
›</span></span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time_t <span class="main">⇒</span> <span class="tfree">'state_t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'state_t</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">cswitch</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> thread_empty<span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">interrupt</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>thread_empty<span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">run</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">control_a</span> <span class="main">=</span> next_action <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">;</span>
                                 <span class="bound">control_s</span> <span class="main">=</span> next_state <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span><span class="main">;</span>
                                 <span class="bound">control_x</span> <span class="main">=</span> next_execs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="keyword1">in</span>
                             <span class="keyword1">case</span> <span class="bound">control_a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">control_s</span> <span class="bound">control_x</span>
                                         <span class="main">|</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">control_s</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">control_x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> not0_implies_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Formulations of security›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  The definitions of security as presented in Section 2.2 of~\cite{Verbeek2013}.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">kprecondition</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">kprecondition</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="free">invariant</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">current</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">realistic_execution</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">realistic_execution</span> <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">≡</span> set <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">realistic_executions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'dom_t</span> <span class="main">⇒</span> <span class="tfree">'action_t</span> execution<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">realistic_executions</span> <span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">d</span><span class="main">.</span> realistic_execution <span class="main">(</span><span class="free"><span class="bound"><span class="entity">execs</span></span></span> <span class="bound">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">involved</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">involved</span> <span class="main">≡</span> Kernel.involved <span class="free">kinvolved</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">≡</span> Kernel.step <span class="free">kstep</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">purge</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">purge</span> <span class="main">≡</span> Separation_Kernel.purge realistic_execution <span class="free">ifp</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ipurge_l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ipurge_l</span> <span class="main">≡</span> Separation_Kernel.ipurge_l <span class="free">kinvolved</span> <span class="free">ifp</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ipurge_r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ipurge_r</span> <span class="main">≡</span> Separation_Kernel.ipurge_r realistic_execution <span class="free">kinvolved</span> <span class="free">ifp</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NI_unrelated</span><span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NI_unrelated</span>
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs</span> <span class="bound">a</span> <span class="bound">n</span> <span class="main">.</span> realistic_executions <span class="bound">execs</span> <span class="main">⟶</span>
                      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s_f</span> <span class="main">=</span> run <span class="bound">n</span> <span class="free">s0</span> <span class="bound">execs</span> <span class="keyword1">in</span>
                         <span class="free">output_f</span> <span class="bound">s_f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">output_f</span> <span class="main">(</span>run <span class="bound">n</span> <span class="free">s0</span> <span class="main">(</span>purge <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NI_indirect_sources</span><span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NI_indirect_sources</span>
  <span class="main">≡</span> <span class="main">∀</span> <span class="bound">execs</span> <span class="bound">a</span> <span class="bound">n</span><span class="main">.</span> realistic_executions <span class="bound">execs</span> <span class="main">⟶</span>
                    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s_f</span> <span class="main">=</span> run <span class="bound">n</span> <span class="free">s0</span> <span class="bound">execs</span> <span class="keyword1">in</span>
                      <span class="free">output_f</span> <span class="main">(</span>run <span class="bound">n</span> <span class="free">s0</span> <span class="main">(</span>ipurge_l <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span>
                      <span class="free">output_f</span> <span class="main">(</span>run <span class="bound">n</span> <span class="free">s0</span> <span class="main">(</span>ipurge_r <span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isecure</span><span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isecure</span> <span class="main">≡</span> NI_unrelated <span class="main">∧</span> NI_indirect_sources"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  The final theorem is unwinding\_implies\_isecure\_CISK.
  This theorem shows that any interpretation of locale CISK is secure.

  To prove this theorem, the refinement framework is used.
  CISK is a refinement of ISK, as the only idfference is the control function.
  In ISK, this function is a generic function called \emph{control}, in CISK it is interpreted in function \emph{CISK\_control}.
  It is proven that function \emph{CISK\_control} satisfies all the proof obligations concerning generic function \emph{control}.
  In other words, \emph{CISK\_control} is proven to be an interpretation of control.
  Therefore, all theorems on run\_total apply to the run function of CISK as well.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_action_consistent<span class="main">:</span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span>  involved <span class="main">(</span>next_action <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span>  <span class="main">⟶</span> next_action <span class="bound">s</span> <span class="bound">execs</span> <span class="main">=</span> next_action <span class="bound">t</span> <span class="bound">execs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">execs</span>
  <span class="keyword3"><span class="command">assume</span></span> vpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> vpeq_involved<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span>  involved <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> aborting_consistent current_s_t vpeq
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">aborting</span> <span class="skolem">t</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">aborting</span> <span class="skolem">s</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> current_s_t this waiting_consistent vpeq_involved
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span> <span class="main">=</span> next_action <span class="skolem">t</span> <span class="skolem">execs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_action_def 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_execs_consistent<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> fst <span class="main">(</span>snd <span class="main">(</span>CISK_control <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>CISK_control <span class="bound">t</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">execs</span>
  <span class="keyword3"><span class="command">assume</span></span> vpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> vpeq_involved<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> aborting_consistent current_s_t vpeq
     <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aborting</span> <span class="skolem">t</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">aborting</span> <span class="skolem">s</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1 vpeq current_s_t vpeq_involved waiting_consistent<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x3<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x2<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"the <span class="main">(</span>next_action <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>CISK_control <span class="skolem">s</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>CISK_control <span class="skolem">t</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_action_def Kernel.involved_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_state_consistent<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">(</span>next_state <span class="bound">t</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">execs</span>
  <span class="keyword3"><span class="command">assume</span></span> vpeq_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> current_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> vpeq_s_t current_s_t
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">u</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">(</span>next_state <span class="skolem">t</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_state_def
    <span class="keyword1"><span class="command">using</span></span> aborting_consistent set_error_consistent
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> current_next_state<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="main">.</span> <span class="free">current</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">execs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_state_def
    <span class="keyword1"><span class="command">using</span></span> current_set_error_code
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> locally_respects_next_state<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">u</span> <span class="bound">execs</span><span class="main">.</span> <span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">execs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_state_def
    <span class="keyword1"><span class="command">using</span></span> vpeq_reflexive set_error_locally_respects
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CISK_control_spec<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">.</span>
       <span class="keyword1">case</span> CISK_control <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span> <span class="keyword1">of</span>
       <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span>
         thread_empty <span class="bound">aseqs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∨</span>
         <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">aborting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">waiting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> tl <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span> <span class="main">#</span> tl <span class="bound">aseqs</span><span class="main">)</span> <span class="main">∨</span>
         <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">waiting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">aseqs</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> tl <span class="bound">aseqs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">d</span> <span class="skolem">aseqs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> CISK_control <span class="skolem">s</span> <span class="skolem">d</span> <span class="skolem">aseqs</span> <span class="keyword1">of</span>
       <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span>
         thread_empty <span class="skolem">aseqs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∨</span>
         <span class="skolem">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="skolem">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">aborting</span> <span class="bound">s'</span> <span class="skolem">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">waiting</span> <span class="bound">s'</span> <span class="skolem">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="skolem">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> tl <span class="main">(</span>hd <span class="skolem">aseqs</span><span class="main">)</span> <span class="main">#</span> tl <span class="skolem">aseqs</span><span class="main">)</span> <span class="main">∨</span>
         <span class="skolem">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="skolem">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">waiting</span> <span class="bound">s'</span> <span class="skolem">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="skolem">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">aseqs</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> tl <span class="skolem">aseqs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">aseqs</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_action_after_cswitch<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">n</span> <span class="bound">d</span> <span class="bound">aseqs</span> <span class="main">.</span> fst <span class="main">(</span>CISK_control <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">n</span> <span class="skolem">d</span> <span class="skolem">aseqs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>CISK_control <span class="main">(</span><span class="free">cswitch</span> <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">d</span> <span class="skolem">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="skolem">s</span> <span class="skolem">d</span> <span class="skolem">aseqs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> aborting_switch_independent waiting_switch_independent
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">aseqs</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> next_action_after_next_state<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="bound">d</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">⟶</span> fst <span class="main">(</span>CISK_control <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None <span class="main">∨</span> fst <span class="main">(</span>CISK_control <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="bound">s</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">d</span> <span class="skolem">aseqs</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>CISK_control <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">d</span> <span class="skolem">aseqs</span><span class="main">)</span> <span class="main">=</span> None <span class="main">∨</span> fst <span class="main">(</span>CISK_control <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">d</span> <span class="skolem">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="skolem">s</span> <span class="skolem">d</span> <span class="skolem">aseqs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">aseqs</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">sa</span> <span class="skolem">da</span> <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">execs'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_state_def
          <span class="keyword1"><span class="command">using</span></span> aborting_error_update waiting_error_update 1
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span><span class="free">current</span> <span class="skolem">sa</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">sa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_action_after_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">d</span> <span class="bound">aseqs</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">⟶</span> fst <span class="main">(</span>CISK_control <span class="main">(</span>step <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">d</span> <span class="skolem">aseqs</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">current</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this aborting_after_step 
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>CISK_control <span class="main">(</span>step <span class="skolem">s</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">d</span> <span class="skolem">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="skolem">s</span> <span class="skolem">d</span> <span class="skolem">aseqs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.step_def 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">aseqs</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_state_precondition<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">execs</span><span class="main">.</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">d</span> <span class="skolem">execs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">AS_precondition</span> <span class="skolem">s</span> <span class="skolem">d</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">AS_precondition</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span> <span class="skolem">d</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_state_def
    <span class="keyword1"><span class="command">using</span></span> precondition_after_set_error_code
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_state_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">execs</span><span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">execs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="main">(</span>next_state <span class="skolem">s</span> <span class="skolem">execs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_state_def
    <span class="keyword1"><span class="command">using</span></span> invariant_after_set_error_code
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_action_from_execs<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="main">.</span> next_action <span class="bound">s</span> <span class="bound">execs</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> actions_in_execution <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">execs</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> actions_in_execution <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_action_def actions_in_execution_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> actions_in_execution <span class="main">(</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> B_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"next_action <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_execs_subset<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">execs</span> <span class="bound">u</span> <span class="main">.</span> actions_in_execution <span class="main">(</span>next_execs <span class="bound">s</span> <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⊆</span> actions_in_execution <span class="main">(</span><span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">u</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"actions_in_execution <span class="main">(</span>next_execs <span class="skolem">s</span> <span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> actions_in_execution <span class="main">(</span><span class="skolem">execs</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.next_execs_def actions_in_execution_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="skolem">execs</span> <span class="main">(</span><span class="free">current</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CISK_control.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> unwinding_implies_isecure_CISK<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">isecure</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> int<span class="main">:</span> Interruptible_Separation_Kernel <span class="quoted"><span class="free">kstep</span></span> <span class="quoted"><span class="free">output_f</span></span> <span class="quoted"><span class="free">s0</span></span> <span class="quoted"><span class="free">current</span></span> <span class="quoted"><span class="free">cswitch</span></span> <span class="quoted"><span class="free">interrupt</span></span> <span class="quoted">kprecondition</span> <span class="quoted">realistic_execution</span> <span class="quoted">CISK_control</span> <span class="quoted"><span class="free">kinvolved</span></span> <span class="quoted"><span class="free">ifp</span></span> <span class="quoted"><span class="free">vpeq</span></span> <span class="quoted"><span class="free">AS_set</span></span> <span class="quoted"><span class="free">invariant</span></span> <span class="quoted"><span class="free">AS_precondition</span></span> <span class="quoted"><span class="free">aborting</span></span> <span class="quoted"><span class="free">waiting</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">u</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vpeq_transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">u</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">b</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vpeq_symmetric <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">u</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">a</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vpeq_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="free">ifp</span> <span class="bound">u</span> <span class="bound">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ifp_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span><span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> kprecondition <span class="bound">s</span> <span class="bound">a</span> <span class="main">∧</span> kprecondition <span class="bound">t</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span>  <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> weakly_step_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">.</span> <span class="main">¬</span><span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span>  <span class="main">∧</span> kprecondition <span class="bound">s</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> locally_respects <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">output_f</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">output_f</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> output_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>        
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">current</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_atomicity <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>        
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cswitch_independent_of_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>                                                    
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cswitch_consistency <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">execs</span><span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> next_action <span class="bound">s</span> <span class="bound">execs</span> <span class="main">=</span> next_action <span class="bound">t</span> <span class="bound">execs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_action_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">execs</span><span class="main">.</span>
        <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="main">(</span>next_action <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">.</span> <span class="free">vpeq</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span>
        fst <span class="main">(</span>snd <span class="main">(</span>CISK_control <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>CISK_control <span class="bound">t</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_execs_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">execs</span><span class="main">.</span> <span class="free">vpeq</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">(</span>next_state <span class="bound">t</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_state_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">s</span> <span class="bound">execs</span><span class="main">.</span> <span class="free">current</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="main">=</span> <span class="free">current</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> current_next_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">u</span> <span class="bound">execs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">ifp</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">vpeq</span> <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> locally_respects_next_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">AS_set</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> empty_in_AS_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">n</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> invariant_after_cswitch <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> precondition_after_cswitch <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">s0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> invariant_s0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseq</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">aseq</span> <span class="main">∈</span> <span class="free">AS_set</span> <span class="main">∧</span> <span class="bound">aseq</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="main">(</span>hd <span class="bound">aseq</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AS_prec_first_action <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">aseq</span><span class="main">∈</span><span class="free">AS_set</span><span class="main">.</span> is_sub_seq <span class="bound">a</span> <span class="bound">a'</span> <span class="bound">aseq</span><span class="main">)</span> <span class="main">∧</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">aborting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">waiting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span>
             <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AS_prec_after_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AS_prec_dom_independent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> spec_of_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> kprecondition <span class="bound">s</span> <span class="bound">a</span> <span class="main">≡</span> kprecondition <span class="bound">s</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>         
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">aseq</span><span class="main">.</span> realistic_execution <span class="bound">aseq</span> <span class="main">≡</span> set <span class="bound">aseq</span> <span class="main">⊆</span> <span class="free">AS_set</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> realistic_execution_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> involved <span class="bound">a</span><span class="main">.</span> kprecondition <span class="bound">s</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">ifp</span> <span class="bound">d</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> involved_ifp <span class="keyword1"><span class="command">unfolding</span></span> Kernel.involved_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">execs</span><span class="main">.</span> next_action <span class="bound">s</span> <span class="bound">execs</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> actions_in_execution <span class="main">(</span><span class="bound">execs</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_action_from_execs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">execs</span> <span class="bound">u</span><span class="main">.</span> actions_in_execution <span class="main">(</span>next_execs <span class="bound">s</span> <span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⊆</span> actions_in_execution <span class="main">(</span><span class="bound">execs</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_execs_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>        
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">.</span>
       <span class="keyword1">case</span> CISK_control <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span> <span class="keyword1">of</span>
       <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span>
         thread_empty <span class="bound">aseqs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∨</span>
         <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">aborting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">waiting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> tl <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span> <span class="main">#</span> tl <span class="bound">aseqs</span><span class="main">)</span> <span class="main">∨</span>
         <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">aseqs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">waiting</span> <span class="bound">s'</span> <span class="bound">d</span> <span class="main">(</span>the <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="main">(</span>hd <span class="bound">aseqs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">aseqs</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aseqs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> tl <span class="bound">aseqs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> CISK_control_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">n</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">.</span> fst <span class="main">(</span>CISK_control <span class="main">(</span><span class="free">cswitch</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_action_after_cswitch <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">execs</span> <span class="bound">d</span><span class="main">.</span>
       <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">⟶</span>
       fst <span class="main">(</span>CISK_control <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None <span class="main">∨</span> fst <span class="main">(</span>CISK_control <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="bound">s</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">execs</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_action_after_next_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">.</span> <span class="free">current</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">⟶</span> fst <span class="main">(</span>CISK_control <span class="main">(</span>step <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>CISK_control <span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseqs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_action_after_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">execs</span><span class="main">.</span> <span class="free">AS_precondition</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">AS_precondition</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_state_precondition <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">execs</span><span class="main">.</span> <span class="free">invariant</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">invariant</span> <span class="main">(</span>next_state <span class="bound">s</span> <span class="bound">execs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> next_state_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="free">waiting</span> <span class="bound">s</span> <span class="main">(</span><span class="free">current</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">kstep</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> spec_of_waiting <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">note</span></span> interpreted <span class="main">=</span> int.Interruptible_Separation_Kernel_axioms
  <span class="keyword1"><span class="command">note</span></span> run_total_induct <span class="main">=</span> Interruptible_Separation_Kernel.run_total.induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">kstep</span></span> <span class="quoted"><span class="free">output_f</span></span> <span class="quoted"><span class="free">s0</span></span> <span class="quoted"><span class="free">current</span></span> <span class="quoted"><span class="free">cswitch</span></span> <span class="quoted">kprecondition</span> <span class="quoted">realistic_execution</span>
                                                                             <span class="quoted">CISK_control</span> <span class="quoted"><span class="free">kinvolved</span></span> <span class="quoted"><span class="free">ifp</span></span> <span class="quoted"><span class="free">vpeq</span></span> <span class="quoted"><span class="free">AS_set</span></span> <span class="quoted"><span class="free">invariant</span></span> <span class="quoted"><span class="free">AS_precondition</span></span> <span class="quoted"><span class="free">aborting</span></span> <span class="quoted"><span class="free">waiting</span></span> <span class="main">_</span> <span class="quoted"><span class="free">interrupt</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> run_equals_run_total<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="main">.</span> run <span class="bound">n</span> <span class="bound">s</span> <span class="bound">execs</span> <span class="main">≡</span> Interruptible_Separation_Kernel.run_total <span class="free">kstep</span> <span class="free">current</span> <span class="free">cswitch</span> <span class="free">interrupt</span> CISK_control <span class="bound">n</span> <span class="bound">s</span> <span class="bound">execs</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span> <span class="main">≡</span> Interruptible_Separation_Kernel.run_total <span class="free">kstep</span> <span class="free">current</span> <span class="free">cswitch</span> <span class="free">interrupt</span> CISK_control <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">execs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> interpreted int.step_def
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">execs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> run_total_induct<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
     <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> interpreted
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"Interruptible_Separation_Kernel.isecure_total <span class="free">kstep</span> <span class="free">output_f</span> <span class="free">s0</span> <span class="free">current</span> <span class="free">cswitch</span> <span class="free">interrupt</span> realistic_execution CISK_control <span class="free">kinvolved</span> <span class="free">ifp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int.unwinding_implies_isecure_total<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 0 run_equals_run_total
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"NI_unrelated"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> realistic_executions_def int.isecure_total_def int.realistic_executions_def int.NI_unrelated_total_def NI_unrelated_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 0 run_equals_run_total
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"NI_indirect_sources"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> realistic_executions_def int.NI_indirect_sources_total_def int.isecure_total_def int.realistic_executions_def NI_indirect_sources_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> isecure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Step_configuration">
<div class="head">
<h1>Theory Step_configuration</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Instantiation by a separation kernel with concrete actions \label{sect:instantiation}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Step_configuration
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
{\em In the previous section, no concrete actions for the step function were given.
The foremost point we want to make by this instantiation is to show 
that we can instantiate the CISK model of the previous section with 
an implementation that, for the step function, as actions, provides
events and interprocess communication (IPC). 
System call invocations that can be interrupted at 
certain interrupt points are split 
into several atomic steps.
A communication interface of events and IPC is less
``trivial'' than it may seem it at a first glance, for example the 
L4 microkernel API {\em only} provided IPC as communication primitive~\cite{Liedtke1995}. 
In particular, the concrete actions illustrate how an application
of the CISK framework can be used to separate policy enforcement from other 
computations unrelated to policy enforcement.

Our separation kernel instantiation also has a notion of {\em partitions}.
A {\em partition} is a logical unit that serves to encapsulate a group of 
CISK threads by, amongst others, enforcing a static
per-partition access control policy to system resources.
In the following instantiation, while the subjects of the step function 
are individual threads, the information flow policy
$ifp$ is defined at the granularity of partitions, which is 
realistic for many separation kernel implementations.

Lastly, 
as a limited manipulation of an access control policy is often needed,
we also provide an invariant for having a dynamic access 
control policy whose maximal closure is bounded by the 
static per-partition access control policy. That the 
dynamic access control policy is a subset of a static
access control policy is expressed by the invariant 
sp\_subset. A use case for this is when you have statically configured
access to files by subjects, but whether a file can 
be read/written also depends on whether the file has been
dynamically opened or not. 
The instantiation provides infrastructure for such an 
invariant on the relation of a dynamic policy to 
a static policy, and shows how the invariant is 
maintained, without modeling any API for an open/close operation.}
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of a separation kernel configuration›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Type definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The separation kernel partitions are considered to be the ``subjects" of the 
    information flow policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ifp</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. A file provider is a partition that, via 
    a file API (read/write), provides files to other partitions.
    The configuration statically defines which partitions can act as a file provider 
    and also the access rights (right/write) of other partitions to the files 
    provided by the file provider. 
    Some separation kernels include a management for address spaces (tasks), that may be hierachically structured. Such a task hierarchy is not part of this model.›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> partition_id_t
<span class="keyword1"><span class="command">typedecl</span></span> thread_id_t

<span class="keyword1"><span class="command">typedecl</span></span> page_t <span class="comment1">― ‹physical address of a memory page›</span>
<span class="keyword1"><span class="command">typedecl</span></span> filep_t <span class="comment1">― ‹name of file provider›</span>

<span class="keyword1"><span class="command">datatype</span></span> obj_id_t <span class="main">=</span>
   PAGE <span class="quoted">page_t</span>
 <span class="main">|</span> FILEP <span class="quoted">filep_t</span> 

<span class="keyword1"><span class="command">datatype</span></span> mode_t <span class="main">=</span>
   READ <span class="comment1">― ‹The subject has right to read from the memory page, from the files served by a file provider.›</span>
 <span class="main">|</span> WRITE <span class="comment1">― ‹The subject has right to write to the memory page, from the files served by a file provider.›</span>
 <span class="main">|</span> PROVIDE <span class="comment1">― ‹The subject has right serve as the file provider. This mode is not used for memory pages or ports.›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Configuration›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The information flow policy is implicitly specified by the configuration. The configuration does not contain
  the communication rights between partitions (subjects). However, the rights can be 
  derived from the configuration. For example, if two partitions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can
  access a file <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can communicate. See below.›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  configured_subj_obj <span class="main">::</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> obj_id_t <span class="main">⇒</span> mode_t <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Each user thread belongs to a partition. The relation is fixed
  at system startup. The configuration specifies how many threads a partition can create,
  but this limit is not part of the model.›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  partition <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> partition_id_t"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Step_policies">
<div class="head">
<h1>Theory Step_policies</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Formulation of a subject-subject communication policy and an information flow 
policy, and showing both can be derived from subject-object configuration data›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Step_policies
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Step_configuration.html">Step_configuration</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Specification\label{sect:policy_specification}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to use CISK, we need an information flow policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ifp</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  relation. 
  We also express a static subject-subject <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sp_spec_subj_obj</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and subject-object <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sp_spec_subj_subj</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> access control policy
  for the implementation of the model. The following locale summarizes
  all properties we need.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> policy_axioms <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sp_spec_subj_obj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> obj_id_t <span class="main">⇒</span> mode_t <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sp_spec_subj_subj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ifp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> sp_spec_file_provider<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">f</span> <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">.</span>
     <span class="free">sp_spec_subj_obj</span> <span class="bound">p1</span> <span class="main">(</span>FILEP <span class="bound">f</span><span class="main">)</span> <span class="bound">m1</span> <span class="main">∧</span>
     <span class="free">sp_spec_subj_obj</span> <span class="bound">p2</span> <span class="main">(</span>FILEP <span class="bound">f</span><span class="main">)</span> <span class="bound">m2</span> <span class="main">⟶</span> <span class="free">sp_spec_subj_subj</span> <span class="bound">p1</span> <span class="bound">p2</span>"</span></span>

  <span class="keyword2"><span class="keyword">and</span></span> sp_spec_no_wronly_pages<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">sp_spec_subj_obj</span> <span class="bound">p</span> <span class="main">(</span>PAGE <span class="bound">x</span><span class="main">)</span> WRITE <span class="main">⟶</span> <span class="free">sp_spec_subj_obj</span> <span class="bound">p</span> <span class="main">(</span>PAGE <span class="bound">x</span><span class="main">)</span> READ"</span></span>

  <span class="keyword2"><span class="keyword">and</span></span> ifp_reflexive<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> <span class="free">ifp</span> <span class="bound">p</span> <span class="bound">p</span>"</span></span>

  <span class="keyword2"><span class="keyword">and</span></span> ifp_compatible_with_sp_spec<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">sp_spec_subj_subj</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">ifp</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">ifp</span> <span class="bound">b</span> <span class="bound">a</span>"</span></span>

  <span class="keyword2"><span class="keyword">and</span></span> ifp_compatible_with_ipc<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="free">sp_spec_subj_subj</span> <span class="bound">a</span> <span class="bound">b</span>
                  <span class="main">∧</span> <span class="free">sp_spec_subj_obj</span> <span class="bound">b</span> <span class="main">(</span>PAGE <span class="bound">x</span><span class="main">)</span> WRITE  <span class="main">∧</span> <span class="free">sp_spec_subj_obj</span> <span class="bound">c</span> <span class="main">(</span>PAGE <span class="bound">x</span><span class="main">)</span> READ<span class="main">)</span>
                 <span class="main">⟶</span> <span class="free">ifp</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span> <span class="comment1">(* empty *)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Derivation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The configuration data only consists of a subject-object policy. 
We derive the subject-subject policy and the information flow policy from the configuration data and prove that properties we specified in Section~\ref{sect:policy_specification} are satisfied.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> abstract_policy_derivation <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">configuration_subj_obj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> obj_id_t <span class="main">⇒</span> mode_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sp_spec_subj_obj</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
    <span class="free">configuration_subj_obj</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> PAGE <span class="bound">y</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> READ <span class="main">∧</span> <span class="free">configuration_subj_obj</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> WRITE<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sp_spec_subj_subj</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span>
    <span class="main">∃</span> <span class="bound">f</span> <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">.</span> sp_spec_subj_obj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>FILEP <span class="bound">f</span><span class="main">)</span> <span class="bound">m1</span> <span class="main">∧</span> sp_spec_subj_obj <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>FILEP <span class="bound">f</span><span class="main">)</span> <span class="bound">m2</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span>
     sp_spec_subj_subj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>
   <span class="main">∨</span> sp_spec_subj_subj <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>
   <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c</span> <span class="bound">y</span> <span class="main">.</span> sp_spec_subj_subj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">c</span>
            <span class="main">∧</span> sp_spec_subj_obj <span class="bound">c</span> <span class="main">(</span>PAGE <span class="bound">y</span><span class="main">)</span> WRITE
            <span class="main">∧</span> sp_spec_subj_obj <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>PAGE <span class="bound">y</span><span class="main">)</span> READ<span class="main">)</span>
   <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Show that the policies specified in Section~\ref{sect:policy_specification} can be derived from the configuration and their definitions.›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> correct<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"policy_axioms sp_spec_subj_obj sp_spec_subj_subj ifp"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> sp_spec_file_provider<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">f</span> <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">.</span>
           sp_spec_subj_obj <span class="bound">p1</span> <span class="main">(</span>FILEP <span class="bound">f</span><span class="main">)</span> <span class="bound">m1</span> <span class="main">∧</span>
           sp_spec_subj_obj <span class="bound">p2</span> <span class="main">(</span>FILEP <span class="bound">f</span><span class="main">)</span> <span class="bound">m2</span> <span class="main">⟶</span> sp_spec_subj_subj <span class="bound">p1</span> <span class="bound">p2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sp_spec_subj_subj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> sp_spec_no_wronly_pages<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="bound">x</span> <span class="main">.</span> sp_spec_subj_obj <span class="bound">p</span> <span class="main">(</span>PAGE <span class="bound">x</span><span class="main">)</span> WRITE <span class="main">⟶</span> sp_spec_subj_obj <span class="bound">p</span> <span class="main">(</span>PAGE <span class="bound">x</span><span class="main">)</span> READ"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sp_spec_subj_obj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> ifp_reflexive<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> ifp <span class="bound">p</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ifp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> ifp_compatible_with_sp_spec<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> sp_spec_subj_subj <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> ifp <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> ifp <span class="bound">b</span> <span class="bound">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ifp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> ifp_compatible_with_ipc<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">(</span>sp_spec_subj_subj <span class="bound">a</span> <span class="bound">b</span>
                  <span class="main">∧</span> sp_spec_subj_obj <span class="bound">b</span> <span class="main">(</span>PAGE <span class="bound">x</span><span class="main">)</span> WRITE  <span class="main">∧</span> sp_spec_subj_obj <span class="bound">c</span> <span class="main">(</span>PAGE <span class="bound">x</span><span class="main">)</span> READ<span class="main">)</span>
                 <span class="main">⟶</span> ifp <span class="bound">a</span> <span class="bound">c</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ifp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> sp_subj_subj_t <span class="main">=</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> partition_id_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> sp_subj_obj_t <span class="main">=</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> obj_id_t <span class="main">⇒</span> mode_t <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Policy<span class="main">:</span> abstract_policy_derivation <span class="quoted"><span class="quoted">"configured_subj_obj"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> Policy_properties<span class="main">:</span> policy_axioms <span class="quoted">Policy.sp_spec_subj_obj</span> <span class="quoted">Policy.sp_spec_subj_subj</span> <span class="quoted">Policy.ifp</span>
  <span class="keyword1"><span class="command">using</span></span> Policy.correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> example_how_to_use_properties_in_proofs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> Policy.ifp <span class="bound">p</span> <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Policy_properties.ifp_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Step">
<div class="head">
<h1>Theory Step</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Separation kernel state and atomic step function›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Step
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Step_policies.html">Step_policies</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Interrupt points›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To model concurrency, each system call is split into several atomic steps,
        while allowing interrupts between the steps. The state of a thread is
        represented by an ``interrupt point" (which corresponds to the value of the program counter
        saved by the system when a thread is interrupted).›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ipc_direction_t <span class="main">=</span> SEND <span class="main">|</span> RECV
<span class="keyword1"><span class="command">datatype</span></span> ipc_stage_t <span class="main">=</span> PREP <span class="main">|</span> WAIT <span class="main">|</span> BUF <span class="quoted">page_t</span>

<span class="keyword1"><span class="command">datatype</span></span> ev_consume_t <span class="main">=</span> EV_CONSUME_ALL <span class="main">|</span> EV_CONSUME_ONE
<span class="keyword1"><span class="command">datatype</span></span> ev_wait_stage_t <span class="main">=</span> EV_PREP <span class="main">|</span> EV_WAIT <span class="main">|</span> EV_FINISH
<span class="keyword1"><span class="command">datatype</span></span> ev_signal_stage_t <span class="main">=</span> EV_SIGNAL_PREP <span class="main">|</span> EV_SIGNAL_FINISH

<span class="keyword1"><span class="command">datatype</span></span> int_point_t <span class="main">=</span>
   SK_IPC <span class="quoted">ipc_direction_t</span> <span class="quoted">ipc_stage_t</span> <span class="quoted">thread_id_t</span> <span class="quoted">page_t</span> <span class="comment1">― ‹The thread is executing a sending / receiving IPC.›</span>
 <span class="main">|</span> SK_EV_WAIT <span class="quoted">ev_wait_stage_t</span> <span class="quoted">ev_consume_t</span> <span class="comment1">― ‹The thread is waiting for an event.›</span>
 <span class="main">|</span> SK_EV_SIGNAL <span class="quoted">ev_signal_stage_t</span> <span class="quoted">thread_id_t</span> <span class="comment1">― ‹The thread is sending an event.›</span>
 <span class="main">|</span> NONE <span class="comment1">― ‹The thread is not executing any system call.›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹System state›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> obj_t <span class="comment1">― ‹value of an object›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Each thread belongs to a partition. The relation is fixed (in this instantiation of a separation kernel).›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  partition <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> partition_id_t"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state contains the dynamic policy (the communication rights in the current state
  of the system, for example).›</span></span>

<span class="keyword1"><span class="command">record</span></span> thread_t <span class="main">=</span>
  <span class="comment1">(* 
  id :: thread_id_t           -- {* thread identifier *}
  int_point :: int_point_t    -- {* interrupt point *}*)</span>
  ev_counter <span class="main">::</span> <span class="quoted">nat</span>           <span class="comment1">― ‹event counter›</span>
  
<span class="keyword1"><span class="command">record</span></span> state_t <span class="main">=</span>  
  sp_impl_subj_subj <span class="main">::</span> <span class="quoted">sp_subj_subj_t</span>    <span class="comment1">― ‹current subject-subject policy›</span>
  sp_impl_subj_obj <span class="main">::</span> <span class="quoted">sp_subj_obj_t</span>      <span class="comment1">― ‹current subject-object policy›</span>
  current <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t"</span></span>               <span class="comment1">― ‹current thread›</span>
  obj <span class="main">::</span> <span class="quoted"><span class="quoted">"obj_id_t <span class="main">⇒</span> obj_t"</span></span>             <span class="comment1">― ‹values of all objects›</span>
  thread <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> thread_t"</span></span>    <span class="comment1">― ‹internal state of threads›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Later (Section~\ref{sect:step_invariants}), the system invariant <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sp_subset</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be used to ensure that the dynamic policies (sp\_impl\_...)
are a subset of the corresponding static policies (sp\_spec\_...).›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Atomic step›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Helper functions}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Set new value for an object.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_object_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"obj_id_t <span class="main">⇒</span> obj_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_object_value</span> <span class="free"><span class="bound"><span class="entity">obj_id</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span> obj <span class="main">:=</span> fun_upd <span class="main">(</span>obj <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">obj_id</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Return a representation of the opposite direction of IPC communication.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opposite_ipc_direction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ipc_direction_t <span class="main">⇒</span> ipc_direction_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opposite_ipc_direction</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="keyword1">of</span> SEND <span class="main">⇒</span> RECV <span class="main">|</span> RECV <span class="main">⇒</span> SEND"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Add an access right from one partition to an object. In this model, not 
available from the API, but shows how dynamic changes of access rights could be implemented.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_access_right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">=&gt;</span> obj_id_t <span class="main">=&gt;</span> mode_t <span class="main">=&gt;</span> state_t <span class="main">=&gt;</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_access_right</span> <span class="free"><span class="bound"><span class="entity">part_id</span></span></span> <span class="free"><span class="bound"><span class="entity">obj_id</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
    <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span> sp_impl_subj_obj <span class="main">:=</span> <span class="main">λ</span> <span class="bound">q</span> <span class="bound">q'</span> <span class="bound">q''</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">part_id</span></span></span> <span class="main">=</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">obj_id</span></span></span> <span class="main">=</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="bound">q''</span><span class="main">)</span> 
     <span class="main">∨</span> sp_impl_subj_obj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">q</span> <span class="bound">q'</span> <span class="bound">q''</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Add a communication right from one partition to another. In this model, not
available from the API.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_comm_right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> partition_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_comm_right</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
    <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span> sp_impl_subj_subj <span class="main">:=</span> <span class="main">λ</span> <span class="bound">q</span> <span class="bound">q'</span> <span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">=</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">∨</span> sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">q</span> <span class="bound">q'</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Model of IPC system call}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We model IPC with the following simplifications:

\begin{enumerate}
\item The model contains the system calls for sending 
      an IPC (SEND) and receiving an IPC (RECV), often implementations
      have a richer API (e.g. combining SEND and RECV in one invocation). 
\item We model only a copying (``BUF") mode, not a memory-mapping mode.
\item The model always copies one page per syscall.
\end{enumerate}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipc_precondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> ipc_direction_t <span class="main">⇒</span> thread_id_t <span class="main">⇒</span> page_t <span class="main">⇒</span> state_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipc_precondition</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span> <span class="free"><span class="bound"><span class="entity">page</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">sender</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="keyword1">of</span> SEND <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="main">|</span> RECV <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">receiver</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="keyword1">of</span> SEND <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span> <span class="main">|</span> RECV <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">local_access_mode</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="keyword1">of</span> SEND <span class="main">⇒</span> READ <span class="main">|</span> RECV <span class="main">⇒</span> WRITE<span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>partition <span class="bound">sender</span><span class="main">)</span> <span class="main">(</span>partition <span class="bound">receiver</span><span class="main">)</span>
      <span class="main">∧</span> sp_impl_subj_obj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>partition <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free"><span class="bound"><span class="entity">page</span></span></span><span class="main">)</span> <span class="bound">local_access_mode</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atomic_step_ipc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> ipc_direction_t <span class="main">⇒</span> ipc_stage_t <span class="main">⇒</span> thread_id_t <span class="main">⇒</span> page_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic_step_ipc</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">stage</span></span></span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span> <span class="free"><span class="bound"><span class="entity">page</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">stage</span></span></span> <span class="keyword1">of</span>
      PREP <span class="main">⇒</span>
         <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">|</span> WAIT <span class="main">⇒</span>
         <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">|</span> BUF <span class="bound">page'</span> <span class="main">⇒</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="keyword1">of</span>
          SEND <span class="main">⇒</span>
             <span class="main">(</span>set_object_value <span class="main">(</span>PAGE <span class="bound">page'</span><span class="main">)</span> <span class="main">(</span>obj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>PAGE <span class="free"><span class="bound"><span class="entity">page</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
        <span class="main">|</span> RECV <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Model of event syscalls}›</span></span>

<span class="comment1">(*The maximum allowed event counter*)</span>
<span class="comment1">(* outcommented, as currently not used consts EV_CTR_MAX :: nat *)</span>

<span class="comment1">(* Needs to be adapted, if wildcards for masks are defined *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ev_signal_precondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> thread_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">ev_signal_precondition</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
    <span class="main">(</span>sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>partition <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">)</span> <span class="main">(</span>partition <span class="free"><span class="bound"><span class="entity">partner</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Assumes error checks have been successful:
   tid is in the event mask of the partner and
   communication rights between tid an partner have been granted *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atomic_step_ev_signal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> thread_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">atomic_step_ev_signal</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span> thread <span class="main">:=</span> fun_upd <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span> <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span> <span class="main">⦇</span> ev_counter <span class="main">:=</span> Suc <span class="main">(</span>ev_counter <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">partner</span></span></span><span class="main">)</span> <span class="main">)</span> <span class="main">⦈</span> <span class="main">)</span>   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atomic_step_ev_wait_one</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">atomic_step_ev_wait_one</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span> thread <span class="main">:=</span> fun_upd <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="main">⦇</span> ev_counter <span class="main">:=</span> <span class="main">(</span>ev_counter <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">)</span>   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atomic_step_ev_wait_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">atomic_step_ev_wait_all</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span>  <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span> thread <span class="main">:=</span> fun_upd <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="main">⦇</span> ev_counter <span class="main">:=</span> <span class="main">0</span> <span class="main">⦈</span> <span class="main">)</span>   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Instantiation of CISK aborting and waiting}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this instantiation of CISK, the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">aborting</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function is used to indicate security policy enforcement.
  An IPC call aborts in its <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">PREP</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stage if the precondition for the calling thread does 
  not hold. An event signal call aborts in its <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EV_SIGNAL_PREP</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stage if the 
  precondition for the calling thread does not hold. 
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">aborting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state_t <span class="main">⇒</span> thread_id_t <span class="main">⇒</span> int_point_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">aborting</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> SK_IPC <span class="bound">dir</span> PREP <span class="bound">partner</span> <span class="bound">page</span> <span class="main">⇒</span>
                            <span class="main">¬</span>ipc_precondition <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
                           <span class="main">|</span> SK_EV_SIGNAL EV_SIGNAL_PREP <span class="bound">partner</span> <span class="main">⇒</span>
                            <span class="main">¬</span>ev_signal_precondition <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="bound">partner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
                           <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">waiting</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function is used to indicate synchronization.
  An IPC call waits in its <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">WAIT</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stage while the precondition for the partner thread does not hold.
  An EV\_WAIT call waits until the event counter is not zero.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">waiting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state_t <span class="main">⇒</span> thread_id_t <span class="main">⇒</span> int_point_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">waiting</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> SK_IPC <span class="bound">dir</span> WAIT <span class="bound">partner</span> <span class="bound">page</span> <span class="main">⇒</span> 
                                   <span class="main">¬</span>ipc_precondition <span class="bound">partner</span> <span class="main">(</span>opposite_ipc_direction <span class="bound">dir</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">page'</span> <span class="main">.</span> True<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
                   <span class="main">|</span> SK_EV_WAIT EV_PREP <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
                   <span class="main">|</span> SK_EV_WAIT EV_WAIT <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> ev_counter <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>
                   <span class="main">|</span> SK_EV_WAIT EV_FINISH <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
                   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{The atomic step function.}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">atomic_step</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the arguments to an interrupt point are
 not taken from the thread state -- the argument given to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">atomic_step</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> could have an 
 arbitrary value.
 So, seen in isolation, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">atomic_step</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> allows more transitions than actually occur in the 
 separation kernel. However, the CISK framework (1) restricts the atomic step function by
 the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">waiting</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">aborting</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> functions as well (2) the set of realistic traces as
 attack sequences <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">rAS_set</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (Section~\ref{sect:separation_kernel_model}). 
 An additional condition is that (3) the dynamic policy used in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">aborting</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
 is a subset of the static policy. This is ensured by the invariant <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sp_subset</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atomic_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state_t <span class="main">⇒</span> int_point_t <span class="main">⇒</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic_step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ipt</span></span></span> <span class="main">≡</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ipt</span></span></span> <span class="keyword1">of</span>
      SK_IPC <span class="bound">dir</span> <span class="bound">stage</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="main">⇒</span>
        atomic_step_ipc <span class="main">(</span>current <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">dir</span> <span class="bound">stage</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">|</span>  SK_EV_WAIT EV_PREP <span class="bound">consume</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">|</span>  SK_EV_WAIT EV_WAIT <span class="bound">consume</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">|</span>  SK_EV_WAIT EV_FINISH <span class="bound">consume</span> <span class="main">⇒</span>
      <span class="keyword1">case</span> <span class="bound">consume</span> <span class="keyword1">of</span>
          EV_CONSUME_ONE <span class="main">⇒</span> atomic_step_ev_wait_one <span class="main">(</span>current <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>   
        <span class="main">|</span> EV_CONSUME_ALL <span class="main">⇒</span> atomic_step_ev_wait_all <span class="main">(</span>current <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>  
    <span class="main">|</span> SK_EV_SIGNAL EV_SIGNAL_PREP <span class="bound">partner</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">|</span> SK_EV_SIGNAL EV_SIGNAL_FINISH <span class="bound">partner</span> <span class="main">⇒</span>
      atomic_step_ev_signal <span class="main">(</span>current <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">partner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">|</span> NONE <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Step_invariants">
<div class="head">
<h1>Theory Step_invariants</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preconditions and invariants for the atomic step \label{sect:step_invariants}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Step_invariants
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Step.html">Step</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The dynamic/implementation policies have to be compatible with the static configuration.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sp_subset</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">.</span> sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">⟶</span> Policy.sp_spec_subj_subj <span class="bound">p1</span> <span class="bound">p2</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">m</span><span class="main">.</span> sp_impl_subj_obj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">m</span> <span class="main">⟶</span> Policy.sp_spec_subj_obj <span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following predicate expresses the precondition for the atomic step. The precondition depends on the type of the atomic action.›</span></span>
<span class="comment1">(*
[SK_IPC dir PREP partner page,SK_IPC dir WAIT partner page,SK_IPC dir (BUF page') partner page]
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atomic_step_precondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state_t <span class="main">⇒</span> thread_id_t <span class="main">⇒</span> int_point_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic_step_precondition</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="free"><span class="bound"><span class="entity">ipt</span></span></span> <span class="main">≡</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ipt</span></span></span> <span class="keyword1">of</span>
       SK_IPC <span class="bound">dir</span> WAIT <span class="bound">partner</span> <span class="bound">page</span> <span class="main">⇒</span>
         <span class="comment1">― ‹the thread managed it past PREP stage›</span>
         ipc_precondition <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="main">|</span> SK_IPC <span class="bound">dir</span> <span class="main">(</span>BUF <span class="bound">page'</span><span class="main">)</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="main">⇒</span>
         <span class="comment1">― ‹both the calling thread and its communication partner managed it past PREP and WAIT stages›</span>
         ipc_precondition <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
         <span class="main">∧</span> ipc_precondition <span class="bound">partner</span> <span class="main">(</span>opposite_ipc_direction <span class="bound">dir</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="bound">page'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="main">|</span> SK_EV_SIGNAL EV_SIGNAL_FINISH <span class="bound">partner</span> <span class="main">⇒</span>
        ev_signal_precondition <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="bound">partner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> 
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span>
         <span class="comment1">― ‹No precondition for other interrupt points.›</span>
         True"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant to be preserved by the atomic step function. The invariant is independent from the type of the atomic action.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atomic_step_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic_step_invariant</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
     sp_subset <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Atomic steps of SK\_IPC preserve invariants›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> set_object_value_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span> <span class="main">=</span> atomic_step_invariant <span class="main">(</span>set_object_value <span class="free">ob</span> <span class="free">va</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def atomic_step_precondition_def ipc_precondition_def
      sp_subset_def set_object_value_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_thread_value_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span> <span class="main">=</span> atomic_step_invariant <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> thread <span class="main">:=</span> <span class="free">thrst</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def atomic_step_precondition_def ipc_precondition_def
      sp_subset_def set_object_value_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atomic_ipc_preserves_invariants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">state_t</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">tid</span> <span class="main">::</span> <span class="quoted">thread_id_t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="main">(</span>atomic_step_ipc <span class="free">tid</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">stage</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> PREP
      <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def atomic_step_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> WAIT
      <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def atomic_step_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> BUF
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms BUF set_object_value_invariant
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ipc_direction_t.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atomic_ev_wait_one_preserves_invariants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">state_t</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">tid</span> <span class="main">::</span> <span class="quoted">thread_id_t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="main">(</span>atomic_step_ev_wait_one <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ev_wait_one_def atomic_step_invariant_def sp_subset_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atomic_ev_wait_all_preserves_invariants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">state_t</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">tid</span> <span class="main">::</span> <span class="quoted">thread_id_t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="main">(</span>atomic_step_ev_wait_all <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ev_wait_all_def atomic_step_invariant_def sp_subset_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atomic_ev_signal_preserves_invariants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">state_t</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">tid</span> <span class="main">::</span> <span class="quoted">thread_id_t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="main">(</span>atomic_step_ev_signal <span class="free">tid</span>  <span class="free">partner</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ev_signal_def atomic_step_invariant_def sp_subset_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Summary theorems on atomic step invariants›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we are ready to show that an atomic step from the current interrupt point
        in any thread preserves invariants.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> atomic_step_preserves_invariants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">state_t</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">tid</span> <span class="main">::</span> <span class="quoted">thread_id_t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="main">(</span>atomic_step <span class="free">s</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> SK_IPC 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def
    <span class="keyword1"><span class="command">using</span></span> assms atomic_ipc_preserves_invariants
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SK_EV_WAIT <span class="skolem">ev_wait_stage</span> <span class="skolem">consume</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">consume</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> EV_CONSUME_ALL
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def
      <span class="keyword1"><span class="command">using</span></span> SK_EV_WAIT assms atomic_ev_wait_all_preserves_invariants
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ev_wait_stage_t.splits<span class="main">)</span>
     <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> EV_CONSUME_ONE
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def
      <span class="keyword1"><span class="command">using</span></span> SK_EV_WAIT assms atomic_ev_wait_one_preserves_invariants
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ev_wait_stage_t.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> SK_EV_SIGNAL
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def
   <span class="keyword1"><span class="command">using</span></span> assms atomic_ev_signal_preserves_invariants  
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ev_signal_stage_t.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> NONE
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def
   <span class="keyword1"><span class="command">using</span></span> assms
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, the invariants do not depend on the current thread. That is, 
the context switch preserves the invariants, and an atomic step that is 
not a context switch does not change the current thread.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> cswitch_preserves_invariants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">state_t</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">new_current</span> <span class="main">::</span> <span class="quoted">thread_id_t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> current <span class="main">:=</span> <span class="free">new_current</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⦇</span> current <span class="main">:=</span> <span class="free">new_current</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_subset <span class="free">s</span> <span class="main">=</span> sp_subset <span class="var">?s1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sp_subset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> atomic_step_does_not_change_current_thread<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"current <span class="main">(</span>atomic_step <span class="free">s</span> <span class="free">ipt</span><span class="main">)</span> <span class="main">=</span> current <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def
          <span class="keyword2"><span class="keyword">and</span></span> atomic_step_ipc_def
          <span class="keyword2"><span class="keyword">and</span></span> set_object_value_def Let_def
          <span class="keyword2"><span class="keyword">and</span></span> atomic_step_ev_wait_one_def atomic_step_ev_wait_all_def
          <span class="keyword2"><span class="keyword">and</span></span> atomic_step_ev_signal_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits 
                        ev_consume_t.splits ev_wait_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Step_vpeq">
<div class="head">
<h1>Theory Step_vpeq</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The view-partitioning equivalence relation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Step_vpeq
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Step.html">Step</a> <a href="Step_invariants.html">Step_invariants</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The view consists of
 \begin{enumerate}
 \item View of object values.
 \item View of subject-subject dynamic policy. The threads can discover the policy
       at runtime, e.g. by calling ipc() and observing success or failure.
 \item View of subject-object dynamic policy. The threads can discover the policy
       at runtime, e.g. by calling open() and observing success or failure.
 \end{enumerate}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vpeq_obj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vpeq_obj</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">obj_id</span> <span class="main">.</span> Policy.sp_spec_subj_obj <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">obj_id</span> READ <span class="main">⟶</span> <span class="main">(</span>obj <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">obj_id</span> <span class="main">=</span> <span class="main">(</span>obj <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="bound">obj_id</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vpeq_subj_subj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vpeq_subj_subj</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span>Policy.sp_spec_subj_subj <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">v</span> <span class="main">⟶</span> sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">v</span> <span class="main">=</span> sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">v</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span>Policy.sp_spec_subj_subj <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vpeq_subj_obj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vpeq_subj_obj</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>    
   <span class="main">∀</span> <span class="bound">ob</span> <span class="bound">m</span> <span class="bound">p1</span> <span class="main">.</span>
     <span class="main">(</span>Policy.sp_spec_subj_obj <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">ob</span> <span class="bound">m</span> <span class="main">⟶</span> sp_impl_subj_obj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">ob</span> <span class="bound">m</span> <span class="main">=</span> sp_impl_subj_obj <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">ob</span> <span class="bound">m</span><span class="main">)</span> 
   <span class="main">∧</span> <span class="main">(</span>Policy.sp_spec_subj_obj <span class="bound">p1</span> <span class="bound">ob</span> PROVIDE <span class="main">∧</span> <span class="main">(</span>Policy.sp_spec_subj_obj <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">ob</span> READ <span class="main">∨</span> Policy.sp_spec_subj_obj <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">ob</span> WRITE<span class="main">)</span> <span class="main">⟶</span>
         sp_impl_subj_obj <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p1</span> <span class="bound">ob</span> PROVIDE <span class="main">=</span> sp_impl_subj_obj <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">p1</span> <span class="bound">ob</span> PROVIDE<span class="main">)</span>"</span></span>
   

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vpeq_local</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">vpeq_local</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span> <span class="bound">tid</span> <span class="main">.</span> <span class="main">(</span>partition <span class="bound">tid</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">tid</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>thread <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">tid</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vpeq</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
   vpeq_obj <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> vpeq_subj_subj <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> vpeq_subj_obj <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> vpeq_local <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Elementary properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vpeq_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> vpeq_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vpeq_sym <span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> vpeq <span class="free">u</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vpeq_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">;</span> vpeq <span class="free">u</span> <span class="free">s2</span> <span class="free">s3</span> <span class="main">⟧</span> <span class="main">⟹</span> vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s3</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_obj_def vpeq_subj_subj_def vpeq_subj_obj_def vpeq_local_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary equivalence relation.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> set_object_value_ign<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> Policy.sp_spec_subj_obj <span class="free">u</span> <span class="free">x</span> READ"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>set_object_value <span class="free">x</span> <span class="free">y</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_obj_def vpeq_subj_subj_def vpeq_subj_obj_def set_object_value_def 
              vpeq_local_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Context-switch and fetch operations are also consistent with vpeq
        and locally respect everything.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> cswitch_consistency_and_respect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted">partition_id_t</span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">state_t</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">new_current</span> <span class="main">::</span> <span class="quoted">thread_id_t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> current <span class="main">:=</span> <span class="free">new_current</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_obj_def vpeq_subj_subj_def vpeq_subj_obj_def vpeq_local_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Step_vpeq_locally_respects">
<div class="head">
<h1>Theory Step_vpeq_locally_respects</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Atomic step locally respects the information flow policy›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Step_vpeq_locally_respects
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Step.html">Step</a> <a href="Step_invariants.html">Step_invariants</a> <a href="Step_vpeq.html">Step_vpeq</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The notion of locally respects is common usage. We augment it by assuming that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">atomic_step_invariant</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds (see~\cite{Verbeek2013}).›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locally respects of atomic step functions›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ipc_respects_policy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Policy.ifp <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="free">tid</span> <span class="main">(</span>SK_IPC <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">pag</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ipt_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ipt</span> <span class="main">=</span> SK_IPC <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ipc <span class="free">tid</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">stage</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> PREP
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def
    <span class="keyword1"><span class="command">using</span></span> vpeq_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> WAIT
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def
    <span class="keyword1"><span class="command">using</span></span> vpeq_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>BUF <span class="skolem">mypage</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> RECV
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def
     <span class="keyword1"><span class="command">using</span></span> vpeq_refl BUF <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> SEND
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Policy.sp_spec_subj_subj <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>partition <span class="free">partner</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Policy.sp_spec_subj_obj <span class="main">(</span>partition <span class="free">partner</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="skolem">mypage</span><span class="main">)</span> WRITE"</span></span>
        <span class="keyword1"><span class="command">using</span></span> BUF SEND inv prec ipt_case
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def sp_subset_def
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_precondition_def ipc_precondition_def opposite_ipc_direction_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Policy.sp_spec_subj_obj <span class="free">u</span> <span class="main">(</span>PAGE <span class="skolem">mypage</span><span class="main">)</span> READ"</span></span>
        <span class="keyword1"><span class="command">using</span></span> no Policy_properties.ifp_compatible_with_ipc
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> BUF SEND assms
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def set_object_value_def
        <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_obj_def vpeq_subj_obj_def vpeq_subj_subj_def vpeq_local_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ev_signal_respects_policy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Policy.ifp <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="free">tid</span> <span class="main">(</span>SK_EV_SIGNAL EV_SIGNAL_FINISH <span class="free">partner</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ipt_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ipt</span> <span class="main">=</span> SK_EV_SIGNAL EV_SIGNAL_FINISH <span class="free">partner</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_signal <span class="free">tid</span> <span class="free">partner</span> <span class="free">s</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv no <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sp_impl_subj_subj <span class="free">s</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">u</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> Policy.ifp_def atomic_step_invariant_def sp_subset_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> prec <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>partition <span class="free">partner</span><span class="main">)</span> <span class="main">≠</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_precondition_def ev_signal_precondition_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ev_signal_stage_t.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_local <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_signal <span class="free">tid</span> <span class="free">partner</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_local_def atomic_step_ev_signal_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_obj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_signal <span class="free">tid</span> <span class="free">partner</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_obj_def atomic_step_ev_signal_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_subj_subj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_signal <span class="free">tid</span> <span class="free">partner</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_subj_subj_def atomic_step_ev_signal_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_subj_obj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_signal <span class="free">tid</span> <span class="free">partner</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_subj_obj_def atomic_step_ev_signal_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 2 3 4 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def 
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ev_wait_all_respects_policy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Policy.ifp <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="free">tid</span> <span class="free">ipt</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ipt_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ipt</span> <span class="main">=</span> SK_EV_WAIT <span class="free">ev_wait_stage</span> EV_CONSUME_ALL"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_all <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">≠</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Policy.ifp_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_local <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_all <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_local_def atomic_step_ev_wait_all_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_obj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_all <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_obj_def atomic_step_ev_wait_all_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_subj_subj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_all <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_subj_subj_def atomic_step_ev_wait_all_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_subj_obj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_all <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_subj_obj_def atomic_step_ev_wait_all_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 2 3 4 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def 
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ev_wait_one_respects_policy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Policy.ifp <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="free">tid</span> <span class="free">ipt</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ipt_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ipt</span> <span class="main">=</span> SK_EV_WAIT <span class="free">ev_wait_stage</span> EV_CONSUME_ONE"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_one <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">≠</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Policy.ifp_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_local <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_one <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_local_def atomic_step_ev_wait_one_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_obj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_one <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_obj_def atomic_step_ev_wait_one_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_subj_subj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_one <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_subj_subj_def atomic_step_ev_wait_one_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"vpeq_subj_obj <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step_ev_wait_one <span class="free">tid</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_subj_obj_def atomic_step_ev_wait_one_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 2 3 4 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def 
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Summary theorems on view-partitioning locally respects›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Atomic step locally respects the information flow policy (ifp). The policy ifp is not necessarily the same
  as sp\_spec\_subj\_subj.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> atomic_step_respects_policy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Policy.ifp <span class="main">(</span>partition <span class="main">(</span>current <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>atomic_step <span class="free">s</span> <span class="free">ipt</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ipc_respects_policy vpeq_refl
                ev_signal_respects_policy ev_wait_one_respects_policy
                ev_wait_all_respects_policy
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ev_consume_t.splits ev_wait_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Step_vpeq_weakly_step_consistent">
<div class="head">
<h1>Theory Step_vpeq_weakly_step_consistent</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak step consistency›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Step_vpeq_weakly_step_consistent
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Step.html">Step</a> <a href="Step_invariants.html">Step_invariants</a> <a href="Step_vpeq.html">Step_vpeq</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The notion of weak step consistency is common usage. We augment it by assuming that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">atomic_step_invariant</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds (see~\cite{Verbeek2013}).›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Weak step consistency of auxiliary functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipc_precondition_weakly_step_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_tid<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipc_precondition <span class="free">tid</span> <span class="free">dir</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s1</span> <span class="main">=</span> ipc_precondition <span class="free">tid</span> <span class="free">dir</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sender</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">dir</span> <span class="keyword1">of</span> SEND <span class="main">⇒</span> <span class="free">tid</span> <span class="main">|</span> RECV <span class="main">⇒</span> <span class="free">partner</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?receiver</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">dir</span> <span class="keyword1">of</span> SEND <span class="main">⇒</span> <span class="free">partner</span> <span class="main">|</span> RECV <span class="main">⇒</span> <span class="free">tid</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?local_access_mode</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">dir</span> <span class="keyword1">of</span> SEND <span class="main">⇒</span> READ <span class="main">|</span> RECV <span class="main">⇒</span> WRITE"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sp_impl_subj_subj <span class="free">s1</span> <span class="main">(</span>partition <span class="var">?sender</span><span class="main">)</span> <span class="main">(</span>partition <span class="var">?receiver</span><span class="main">)</span>
             <span class="main">=</span> sp_impl_subj_subj <span class="free">s2</span> <span class="main">(</span>partition <span class="var">?sender</span><span class="main">)</span> <span class="main">(</span>partition <span class="var">?receiver</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sp_impl_subj_obj <span class="free">s1</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free">page</span><span class="main">)</span> <span class="var">?local_access_mode</span>
         <span class="main">=</span> sp_impl_subj_obj <span class="free">s2</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free">page</span><span class="main">)</span> <span class="var">?local_access_mode</span>"</span></span>
 
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Policy.sp_spec_subj_subj <span class="main">(</span>partition <span class="var">?sender</span><span class="main">)</span> <span class="main">(</span>partition <span class="var">?receiver</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> eq_tid <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_subj_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ipc_direction_t.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_subset <span class="free">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sp_subset <span class="free">s2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inv1 inv2 <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def sp_subset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sp_impl_subj_subj <span class="free">s1</span> <span class="main">(</span>partition <span class="var">?sender</span><span class="main">)</span> <span class="main">(</span>partition <span class="var">?receiver</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sp_impl_subj_subj <span class="free">s2</span> <span class="main">(</span>partition <span class="var">?sender</span><span class="main">)</span> <span class="main">(</span>partition <span class="var">?receiver</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> sp_subset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Policy.sp_spec_subj_obj <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free">page</span><span class="main">)</span> <span class="var">?local_access_mode</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> eq_tid <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_obj_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ipc_direction_t.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_subset <span class="free">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sp_subset <span class="free">s2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inv1 inv2 <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def sp_subset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sp_impl_subj_obj <span class="free">s1</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free">page</span><span class="main">)</span> <span class="var">?local_access_mode</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sp_impl_subj_obj <span class="free">s2</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free">page</span><span class="main">)</span> <span class="var">?local_access_mode</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> sp_subset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A B <span class="keyword1"><span class="command">unfolding</span></span> ipc_precondition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ev_signal_precondition_weakly_step_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_tid<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ev_signal_precondition <span class="free">tid</span> <span class="free">partner</span> <span class="free">s1</span> <span class="main">=</span> ev_signal_precondition <span class="free">tid</span> <span class="free">partner</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sp_impl_subj_subj <span class="free">s1</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>partition <span class="free">partner</span><span class="main">)</span>
             <span class="main">=</span> sp_impl_subj_subj <span class="free">s2</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>partition <span class="free">partner</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Policy.sp_spec_subj_subj <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>partition <span class="free">partner</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> eq_tid <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_subj_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ipc_direction_t.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_subset <span class="free">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sp_subset <span class="free">s2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inv1 inv2 <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def sp_subset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sp_impl_subj_subj <span class="free">s1</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>partition <span class="free">partner</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sp_impl_subj_subj <span class="free">s2</span> <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>partition <span class="free">partner</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> sp_subset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> ev_signal_precondition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> set_object_value_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="main">(</span>set_object_value <span class="free">x</span> <span class="free">y</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>set_object_value <span class="free">x</span> <span class="free">y</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set_object_value <span class="free">x</span> <span class="free">y</span> <span class="free">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set_object_value <span class="free">x</span> <span class="free">y</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> E1<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq_obj <span class="free">u</span> <span class="var">?s1'</span> <span class="var">?s2'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
        <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Policy.sp_spec_subj_obj <span class="free">u</span> <span class="skolem">x'</span> READ"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"obj <span class="var">?s1'</span> <span class="skolem">x'</span> <span class="main">=</span> obj <span class="var">?s2'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"obj <span class="var">?s1'</span> <span class="skolem">x'</span> <span class="main">=</span> obj <span class="var">?s2'</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_object_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"obj <span class="var">?s1'</span> <span class="skolem">x'</span> <span class="main">=</span> obj <span class="free">s1</span> <span class="skolem">x'</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"obj <span class="var">?s2'</span> <span class="skolem">x'</span> <span class="main">=</span> obj <span class="free">s2</span> <span class="skolem">x'</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> set_object_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"obj <span class="free">s1</span> <span class="skolem">x'</span> <span class="main">=</span> obj <span class="free">s2</span> <span class="skolem">x'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 1 eq_obs <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_obj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> 2 3 4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"obj <span class="var">?s1'</span> <span class="skolem">x'</span> <span class="main">=</span> obj <span class="var">?s2'</span> <span class="skolem">x'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"vpeq_obj <span class="free">u</span> <span class="var">?s1'</span> <span class="var">?s2'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vpeq_obj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> E4<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq_subj_subj <span class="free">u</span> <span class="var">?s1'</span> <span class="var">?s2'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_impl_subj_subj <span class="var">?s1'</span> <span class="main">=</span> sp_impl_subj_subj <span class="free">s1</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sp_impl_subj_subj <span class="var">?s2'</span> <span class="main">=</span> sp_impl_subj_subj <span class="free">s2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_object_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"vpeq_subj_subj <span class="free">u</span> <span class="var">?s1'</span> <span class="var">?s2'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_obs <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_subj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> E5<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq_subj_obj <span class="free">u</span> <span class="var">?s1'</span> <span class="var">?s2'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_impl_subj_obj <span class="var">?s1'</span> <span class="main">=</span> sp_impl_subj_obj <span class="free">s1</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sp_impl_subj_obj <span class="var">?s2'</span> <span class="main">=</span> sp_impl_subj_obj <span class="free">s2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_object_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"vpeq_subj_obj <span class="free">u</span> <span class="var">?s1'</span> <span class="var">?s2'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_obs <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_obj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> eq_obs <span class="keyword1"><span class="command">have</span></span> E6<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq_local <span class="free">u</span> <span class="var">?s1'</span> <span class="var">?s2'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_local_def set_object_value_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> E1 E4 E5 E6
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Weak step consistency of atomic step functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipc_weakly_step_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq_act<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec1<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="free">tid</span> <span class="free">ipt</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec2<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="free">tid</span> <span class="free">ipt</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ipt_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ipt</span> <span class="main">=</span> SK_IPC <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span>
                <span class="main">(</span>atomic_step_ipc <span class="free">tid</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s1</span><span class="main">)</span>
                <span class="main">(</span>atomic_step_ipc <span class="free">tid</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">mypage</span> <span class="main">.</span> <span class="main">⟦</span> <span class="free">dir</span> <span class="main">=</span> SEND<span class="main">;</span> <span class="free">stage</span> <span class="main">=</span> BUF <span class="bound">mypage</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mypage</span>
      <span class="keyword3"><span class="command">assume</span></span> dir_send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> SEND"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> stage_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stage</span> <span class="main">=</span> BUF <span class="skolem">mypage</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Policy.sp_spec_subj_obj <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free">page</span><span class="main">)</span> READ"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inv1 prec1 dir_send stage_buf ipt_case
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def sp_subset_def
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_precondition_def ipc_precondition_def opposite_ipc_direction_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"obj <span class="free">s1</span> <span class="main">(</span>PAGE <span class="free">page</span><span class="main">)</span> <span class="main">=</span> obj <span class="free">s2</span> <span class="main">(</span>PAGE <span class="free">page</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_act <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_obj_def vpeq_local_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span>
                <span class="main">(</span>atomic_step_ipc <span class="free">tid</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s1</span><span class="main">)</span>
                <span class="main">(</span>atomic_step_ipc <span class="free">tid</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dir_send stage_buf eq_obs set_object_value_consistent
        <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_obs <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">stage</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">dir</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ev_wait_one_weakly_step_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq_act<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec1<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="main">(</span>current <span class="free">s1</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec2<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="main">(</span>current <span class="free">s1</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span>
                <span class="main">(</span>atomic_step_ev_wait_one <span class="free">tid</span>  <span class="free">s1</span><span class="main">)</span>
                <span class="main">(</span>atomic_step_ev_wait_one <span class="free">tid</span>  <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_subj_def vpeq_obj_def vpeq_subj_obj_def vpeq_local_def
              atomic_step_ev_wait_one_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="keyword1"><span class="command">lemma</span></span> ev_wait_all_weakly_step_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq_act<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec1<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="main">(</span>current <span class="free">s1</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec2<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="main">(</span>current <span class="free">s1</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span>
                <span class="main">(</span>atomic_step_ev_wait_all <span class="free">tid</span>  <span class="free">s1</span><span class="main">)</span>
                <span class="main">(</span>atomic_step_ev_wait_all <span class="free">tid</span>  <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_subj_def vpeq_obj_def vpeq_subj_obj_def vpeq_local_def
              atomic_step_ev_wait_all_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   

<span class="keyword1"><span class="command">lemma</span></span> ev_signal_weakly_step_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq_act<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="free">tid</span><span class="main">)</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec1<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="main">(</span>current <span class="free">s1</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec2<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="main">(</span>current <span class="free">s1</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span>
                <span class="main">(</span>atomic_step_ev_signal <span class="free">tid</span> <span class="free">partner</span> <span class="free">s1</span><span class="main">)</span>
                <span class="main">(</span>atomic_step_ev_signal <span class="free">tid</span> <span class="free">partner</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_subj_def vpeq_obj_def vpeq_subj_obj_def vpeq_local_def
              atomic_step_ev_signal_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The use of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">extend_f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is to provide infrastructure to support use in dynamic policies, currently not used.›</span></span>
 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>partition_id_t <span class="main">⇒</span> partition_id_t <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>partition_id_t <span class="main">⇒</span> partition_id_t <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>partition_id_t <span class="main">⇒</span> partition_id_t <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extend_f</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">p1</span> <span class="bound">p2</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend_subj_subj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>partition_id_t <span class="main">⇒</span> partition_id_t <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> state_t <span class="main">⇒</span> state_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extend_subj_subj</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span> sp_impl_subj_subj <span class="main">:=</span> extend_f <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>sp_impl_subj_subj <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> extend_subj_subj_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partition_id_t <span class="main">⇒</span> partition_id_t <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sp_impl_subj_subj <span class="free">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sp_impl_subj_subj <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> Policy.sp_spec_subj_subj <span class="free">u</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="var">?g1</span> <span class="free">u</span> <span class="bound">v</span> <span class="main">=</span> <span class="var">?g2</span> <span class="free">u</span> <span class="bound">v</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> Policy.sp_spec_subj_subj <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> <span class="var">?g1</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">=</span> <span class="var">?g2</span> <span class="bound">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_subj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> Policy.sp_spec_subj_subj <span class="free">u</span> <span class="bound">v</span> <span class="main">⟶</span> extend_f <span class="free">f</span> <span class="var">?g1</span> <span class="free">u</span> <span class="bound">v</span> <span class="main">=</span> extend_f <span class="free">f</span> <span class="var">?g2</span> <span class="free">u</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> Policy.sp_spec_subj_subj <span class="bound">v</span> <span class="free">u</span> <span class="main">⟶</span> extend_f <span class="free">f</span> <span class="var">?g1</span> <span class="bound">v</span> <span class="free">u</span> <span class="main">=</span> extend_f <span class="free">f</span> <span class="var">?g2</span> <span class="bound">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> extend_f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq_subj_subj <span class="free">u</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vpeq_subj_subj_def extend_subj_subj_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq_obj <span class="free">u</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_obj_def extend_subj_subj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq_subj_obj <span class="free">u</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_subj_obj_def extend_subj_subj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
 <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq_local <span class="free">u</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>extend_subj_subj <span class="free">f</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def vpeq_local_def extend_subj_subj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 3 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> vpeq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Summary theorems on view-partitioning weak step consistency›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The atomic step is weakly step consistent with view partitioning.
 Here, the ``weakness'' is that we assume that the two states are vp-equivalent
 not only w.r.t. the observer domain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but also w.r.t. the caller
 domain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"partition <span class="free"><span class="free">tid</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> atomic_step_weakly_step_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq_act<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="main">(</span>current <span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span>   <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec1<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s1</span> <span class="main">(</span>current <span class="free">s1</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec2<span class="main">:</span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s2</span> <span class="main">(</span>current <span class="free">s2</span><span class="main">)</span> <span class="free">ipt</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq_curr<span class="main">:</span> <span class="quoted"><span class="quoted">"current <span class="free">s1</span> <span class="main">=</span> current <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vpeq <span class="free">u</span> <span class="main">(</span>atomic_step <span class="free">s1</span> <span class="free">ipt</span><span class="main">)</span> <span class="main">(</span>atomic_step <span class="free">s2</span> <span class="free">ipt</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 
          ipc_weakly_step_consistent
          ev_wait_all_weakly_step_consistent
          ev_wait_one_weakly_step_consistent
          ev_signal_weakly_step_consistent
          vpeq_refl
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ipt</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ev_consume_t.splits ev_wait_stage_t.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ev_signal_stage_t.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Separation_kernel_model">
<div class="head">
<h1>Theory Separation_kernel_model</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Separation kernel model \label{sect:separation_kernel_model}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Separation_kernel_model
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Step.html">../../step/Step</a>"</span>
          <span class="quoted">"<a href="Step_invariants.html">../../step/Step_invariants</a>"</span>
          <span class="quoted">"<a href="Step_vpeq.html">../../step/Step_vpeq</a>"</span>
          <span class="quoted">"<a href="Step_vpeq_locally_respects.html">../../step/Step_vpeq_locally_respects</a>"</span>
          <span class="quoted">"<a href="Step_vpeq_weakly_step_consistent.html">../../step/Step_vpeq_weakly_step_consistent</a>"</span>
          <a href="CISK.html">CISK</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
 First (Section~\ref{sect:initial_state}) we instantiate the CISK generic model.
 Functions that instantiate a generic function of the CISK model are prefixed with an `r',
 `r' standing for ``Rushby';, as CISK is derived originally from a model
  by Rushby~\cite{Verbeek2013}.
 For example, `rifp' is the instantiation of the generic `ifp'.
 
 Later (Section~\ref{sect:discharging}) all CISK proof obligations are discharged, e.g., 
 weak step consistency, output consistency, etc. These will be used in 
 Section~\ref{sect:link_to_CISK}.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Initial state of separation kernel model\label{sect:initial_state}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We assume that the initial state of threads and memory is given.
  The initial state of threads is arbitrary, but the threads are not
  executing the system call. The purpose of the following definitions
  is to obtain the initial state without potentially dangerous axioms.
  The only axioms we admit without proof are formulated using the
  ``consts'' syntax and thus safe.›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  initial_current <span class="main">::</span> <span class="quoted"><span class="quoted">"thread_id_t"</span></span>
  initial_obj <span class="main">::</span> <span class="quoted"><span class="quoted">"obj_id_t <span class="main">⇒</span> obj_t"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">s0</span> <span class="main">::</span> <span class="quoted">state_t</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0</span> <span class="main">≡</span> <span class="main">⦇</span> sp_impl_subj_subj <span class="main">=</span> Policy.sp_spec_subj_subj<span class="main">,</span>
          sp_impl_subj_obj <span class="main">=</span> Policy.sp_spec_subj_obj<span class="main">,</span>
          current <span class="main">=</span> initial_current<span class="main">,</span>
          obj <span class="main">=</span> initial_obj<span class="main">,</span>
          thread <span class="main">=</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main">.</span> <span class="main">(|</span> ev_counter <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span> 
          <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> initial_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant s0"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_subset s0"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sp_subset_def s0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Types for instantiation of the generic model›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To simplify formulations, we include the state invariant
 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the state data type. The 
 initial state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">s0</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> serves at witness that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">rstate_t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
 is non-empty.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> rstate_t <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">s</span> <span class="main">.</span> atomic_step_invariant <span class="bound">s</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> initial_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state_t <span class="main">⇒</span> rstate_t"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">abs</span> <span class="main">=</span> Abs_rstate_t"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rstate_t <span class="main">⇒</span> state_t"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↓</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rep</span> <span class="main">=</span> Rep_rstate_t"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rstate_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="main">(</span><span class="main">↓</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rep_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_rstate_t mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rstate_down_up<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">↑</span><span class="main">↓</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rep_def abs_def <span class="keyword1"><span class="command">using</span></span> Rep_rstate_t_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rstate_up_down<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">↓</span><span class="main">↑</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Abs_rstate_t_inverse <span class="keyword1"><span class="command">unfolding</span></span> rep_def abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A CISK action is identified with an interrupt point.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> raction_t <span class="main">=</span> <span class="quoted">int_point_t</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rcurrent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rstate_t <span class="main">⇒</span> thread_id_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rcurrent</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> current <span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rstate_t <span class="main">⇒</span> raction_t <span class="main">⇒</span> rstate_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rstep</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">↑</span><span class="main">(</span>atomic_step <span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Each CISK domain is identified with a thread id.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rdom_t <span class="main">=</span> <span class="quoted"><span class="quoted">"thread_id_t"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The output function returns the contents of all memory accessible
  to the subject. The action argument of the output function is ignored.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> visible_obj_t <span class="main">=</span> VALUE <span class="quoted">obj_t</span> <span class="main">|</span> EXCEPTION
<span class="keyword1"><span class="command">type_synonym</span></span> routput_t <span class="main">=</span> <span class="quoted"><span class="quoted">"page_t <span class="main">⇒</span> visible_obj_t"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">routput_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rstate_t <span class="main">⇒</span> raction_t <span class="main">⇒</span> routput_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">routput_f</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> sp_impl_subj_obj <span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>partition <span class="main">(</span>rcurrent <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> READ <span class="keyword1">then</span>
      VALUE <span class="main">(</span>obj <span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>PAGE <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span>
      EXCEPTION"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The precondition for the generic model. Note that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">atomic_step_invariant</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  is already part of the state.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rprecondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rstate_t <span class="main">⇒</span> rdom_t <span class="main">⇒</span> raction_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rprecondition</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> atomic_step_precondition <span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rinvariant</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rinvariant</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> True"</span></span> <span class="comment1">― ‹The invariant is already in the state type.›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Translate view-partitioning and interaction-allowed relations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rvpeq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rdom_t <span class="main">⇒</span> rstate_t <span class="main">⇒</span> rstate_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rvpeq</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> vpeq <span class="main">(</span>partition <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rifp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rdom_t <span class="main">⇒</span> rdom_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rifp</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Policy.ifp <span class="main">(</span>partition <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span>partition <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Context Switches›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rcswitch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> rstate_t <span class="main">⇒</span> rstate_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rcswitch</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">↑</span><span class="main">(</span><span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⦇</span> current <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">t</span> <span class="main">.</span> True<span class="main">)</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">subsubsection</span></span>  <span class="quoted"><span class="plain_text">‹Possible action sequences›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
An <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SK_IPC</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> consists of three atomic actions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">PREP</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">WAIT</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">BUF</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the same parameters. 
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_SK_IPC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"raction_t list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_SK_IPC</span> <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="main">.</span>
                    <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">=</span> <span class="main">[</span>SK_IPC <span class="bound">dir</span> PREP <span class="bound">partner</span> <span class="bound">page</span><span class="main">,</span>SK_IPC <span class="bound">dir</span> WAIT <span class="bound">partner</span> <span class="bound">page</span><span class="main">,</span>SK_IPC <span class="bound">dir</span> <span class="main">(</span>BUF <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">page'</span> <span class="main">.</span> True<span class="main">)</span><span class="main">)</span> <span class="bound">partner</span> <span class="bound">page</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
An <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SK_EV_WAIT</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> consists of three atomic actions, one for each of the stages <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EV_PREP</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EV_WAIT</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EV_FINISH</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
with the same parameters. 
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_SK_EV_WAIT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"raction_t list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_SK_EV_WAIT</span> <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">consume</span> <span class="main">.</span>
                     <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">=</span> <span class="main">[</span>SK_EV_WAIT EV_PREP <span class="bound">consume</span> <span class="main">,</span> 
                             SK_EV_WAIT EV_WAIT <span class="bound">consume</span> <span class="main">,</span> 
                             SK_EV_WAIT EV_FINISH <span class="bound">consume</span> <span class="main">]</span>"</span></span>
                    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
An <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SK_EV_SIGNAL</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> consists of two atomic actions, one for each of the stages <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EV_SIGNAL_PREP</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EV_SIGNAL_FINISH</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the same parameters. 
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_SK_EV_SIGNAL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"raction_t list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_SK_EV_SIGNAL</span> <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">partner</span> <span class="main">.</span>
                     <span class="free"><span class="bound"><span class="entity">aseq</span></span></span> <span class="main">=</span> <span class="main">[</span>SK_EV_SIGNAL EV_SIGNAL_PREP <span class="bound">partner</span><span class="main">,</span> 
                             SK_EV_SIGNAL EV_SIGNAL_FINISH <span class="bound">partner</span><span class="main">]</span>"</span></span>
                    

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The complete attack surface consists of IPC calls, events, and noops.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rAS_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"raction_t list set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rAS_set</span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">aseq</span> <span class="main">.</span> is_SK_IPC <span class="bound">aseq</span> <span class="main">∨</span> is_SK_EV_WAIT <span class="bound">aseq</span> <span class="main">∨</span> is_SK_EV_SIGNAL <span class="bound">aseq</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Control›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When are actions aborting, and when are actions waiting.
  We do not currently use the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">set_error_code</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function yet.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">raborting</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">raborting</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> aborting <span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rwaiting</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rwaiting</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> waiting <span class="main">(</span><span class="main">↓</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rset_error_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rstate_t <span class="main">⇒</span> raction_t <span class="main">⇒</span> rstate_t"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rset_error_code</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Returns the set of threads that are involved in a certain action.
  For example, for an IPC call, the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">WAIT</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stage synchronizes with the partner.
  This partner is involved in that action.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rkinvolved</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_point_t <span class="main">⇒</span> rdom_t set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rkinvolved</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> SK_IPC <span class="bound">dir</span> WAIT <span class="bound">partner</span> <span class="bound">page</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">partner</span><span class="main">}</span>
   <span class="main">|</span> SK_EV_SIGNAL EV_SIGNAL_FINISH <span class="bound">partner</span> <span class="main">=&gt;</span> <span class="main">{</span><span class="bound">partner</span><span class="main">}</span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rinvolved</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_point_t option <span class="main">⇒</span> rdom_t set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rinvolved</span> <span class="main">≡</span> Kernel.involved rkinvolved"</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Discharging the proof obligations\label{sect:discharging}›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inst_vpeq_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> rvpeq_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"rvpeq <span class="free">u</span> <span class="free">s</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rvpeq_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"rvpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> rvpeq <span class="free">u</span> <span class="free">s2</span> <span class="free">s1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rvpeq_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> rvpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s2</span><span class="main">;</span> rvpeq <span class="free">u</span> <span class="free">s2</span> <span class="free">s3</span> <span class="main">⟧</span> <span class="main">⟹</span> rvpeq <span class="free">u</span> <span class="free">s1</span> <span class="free">s3</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rvpeq_def <span class="keyword1"><span class="command">using</span></span> vpeq_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inst_ifp_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">.</span> rifp <span class="bound">u</span> <span class="bound">u</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rifp_def <span class="keyword1"><span class="command">using</span></span> Policy_properties.ifp_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>    
    
<span class="comment1">(* Original definition 
  definition step_atomicity::bool where "step_atomicity 
  ≡ ∀ s a . current (step s a) = current s"    
*)</span>  
<span class="keyword1"><span class="command">lemma</span></span> inst_step_atomicity <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> rcurrent <span class="main">(</span>rstep <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> rcurrent <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rstep_def rcurrent_def
<span class="keyword1"><span class="command">using</span></span> atomic_step_does_not_change_current_thread rstate_up_down rstate_invariant atomic_step_preserves_invariants
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Original definition 
definition weakly_step_consistent::bool where "weakly_step_consistent 
  ≡ ∀ s t u a. 
    vpeq u s t ∧ vpeq (current s) s t 
  ∧ current s = current t 
  ∧ precondition s a ∧ precondition t a 
  ⟶ 
  vpeq u (step s a) (step t a)"
*)</span>


<span class="keyword1"><span class="command">lemma</span></span> inst_weakly_step_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rvpeq <span class="free">u</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rvpeq <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rcurrent <span class="free">s</span> <span class="main">=</span> rcurrent <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">t</span> <span class="main">(</span>rcurrent <span class="free">t</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rvpeq <span class="free">u</span> <span class="main">(</span>rstep <span class="free">s</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>rstep <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms atomic_step_weakly_step_consistent rstate_invariant atomic_step_preserves_invariants
<span class="keyword1"><span class="command">unfolding</span></span> rcurrent_def rstep_def rvpeq_def rprecondition_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="comment1">(* Original definition 

definition locally_respects::bool where "locally_respects 
  ≡ ∀ a s u. 
    ¬ifp (current s) u  
  ∧ precondition s a 
  ⟶ 
  vpeq u s (step s a)"
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> inst_local_respect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_ifp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>rifp <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rvpeq <span class="free">u</span> <span class="free">s</span> <span class="main">(</span>rstep <span class="free">s</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms atomic_step_respects_policy rstate_invariant atomic_step_preserves_invariants
<span class="keyword1"><span class="command">unfolding</span></span> rifp_def rprecondition_def rvpeq_def rstep_def rcurrent_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*

definition output_consistent::bool where "output_consistent 
  ≡ ∀ a s t. 
   vpeq (current s) s t 
 ∧ current s = current t 
 ⟶ 
 (output_f s a) = (output_f t a)"
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> inst_output_consistency<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rvpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"rvpeq <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     current_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"rcurrent <span class="free">s</span> <span class="main">=</span> rcurrent <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"routput_f <span class="free">s</span> <span class="free">a</span> <span class="main">=</span> routput_f <span class="free">t</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> rvpeq <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> rcurrent <span class="bound">s</span> <span class="main">=</span> rcurrent <span class="bound">t</span> <span class="main">⟶</span> routput_f <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> routput_f <span class="bound">t</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">raction_t</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">rstate_t</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">page_t</span>
        <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"rvpeq <span class="main">(</span>rcurrent <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"rcurrent <span class="skolem">s</span> <span class="main">=</span> rcurrent <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?part</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"partition <span class="main">(</span>rcurrent <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"routput_f <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> routput_f <span class="skolem">t</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Policy.sp_spec_subj_obj <span class="var">?part</span> <span class="main">(</span>PAGE <span class="skolem">p</span><span class="main">)</span> READ"</span></span>
                 <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> case_split <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Allowed Denied<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> Allowed
              <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"obj <span class="main">(</span><span class="main">↓</span><span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> obj <span class="main">(</span><span class="main">↓</span><span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>PAGE <span class="skolem">p</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> 1 Allowed <span class="keyword1"><span class="command">unfolding</span></span> rvpeq_def vpeq_def vpeq_obj_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_impl_subj_obj <span class="main">(</span><span class="main">↓</span><span class="skolem">s</span><span class="main">)</span> <span class="var">?part</span> <span class="main">(</span>PAGE <span class="skolem">p</span><span class="main">)</span> READ <span class="main">=</span> sp_impl_subj_obj <span class="main">(</span><span class="main">↓</span><span class="skolem">t</span><span class="main">)</span> <span class="var">?part</span> <span class="main">(</span>PAGE <span class="skolem">p</span><span class="main">)</span> READ"</span></span>
                <span class="keyword1"><span class="command">using</span></span> 1 2 Allowed <span class="keyword1"><span class="command">unfolding</span></span> rvpeq_def vpeq_def vpeq_subj_obj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"routput_f <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> routput_f <span class="skolem">t</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> routput_f_def <span class="keyword1"><span class="command">using</span></span> 2 5 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> Denied
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sp_impl_subj_obj <span class="main">(</span><span class="main">↓</span><span class="skolem">s</span><span class="main">)</span> <span class="var">?part</span> <span class="main">(</span>PAGE <span class="skolem">p</span><span class="main">)</span> READ <span class="main">=</span> False"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sp_impl_subj_obj <span class="main">(</span><span class="main">↓</span><span class="skolem">t</span><span class="main">)</span> <span class="var">?part</span> <span class="main">(</span>PAGE <span class="skolem">p</span><span class="main">)</span> READ <span class="main">=</span> False"</span></span>
                <span class="keyword1"><span class="command">using</span></span> rstate_invariant <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_invariant_def sp_subset_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"routput_f <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> routput_f <span class="skolem">t</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> routput_f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> rvpeq <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> rcurrent <span class="bound">s</span> <span class="main">=</span> rcurrent <span class="bound">t</span> <span class="main">⟶</span> routput_f <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> routput_f <span class="bound">t</span> <span class="bound">a</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
definition cswitch_independent_of_state::bool where "cswitch_independent_of_state
  ≡ ∀ n s t . current s = current t ⟶ current (cswitch n s) = current (cswitch n t)"
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> inst_cswitch_independent_of_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rcurrent <span class="free">s</span> <span class="main">=</span> rcurrent <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rcurrent <span class="main">(</span>rcswitch <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> rcurrent <span class="main">(</span>rcswitch <span class="free">n</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> rstate_invariant cswitch_preserves_invariants <span class="keyword1"><span class="command">unfolding</span></span> rcurrent_def rcswitch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*
definition cswitch_consistency::bool where "cswitch_consistency
  ≡ ∀ u s t n . vpeq u s t ⟶ vpeq u (cswitch n s) (cswitch n t)"
  *)</span>
<span class="keyword1"><span class="command">lemma</span></span> inst_cswitch_consistency<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rvpeq <span class="free">u</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rvpeq <span class="free">u</span> <span class="main">(</span>rcswitch <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>rcswitch <span class="free">n</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="main">↓</span><span class="free">s</span><span class="main">)</span> <span class="main">↓</span><span class="main">(</span>rcswitch <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rstate_invariant cswitch_consistency_and_respect cswitch_preserves_invariants
  <span class="keyword1"><span class="command">unfolding</span></span> rcswitch_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"vpeq <span class="main">(</span>partition <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="main">↓</span><span class="free">t</span><span class="main">)</span> <span class="main">↓</span><span class="main">(</span>rcswitch <span class="free">n</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rstate_invariant cswitch_consistency_and_respect cswitch_preserves_invariants
  <span class="keyword1"><span class="command">unfolding</span></span> rcswitch_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rvpeq_def <span class="keyword1"><span class="command">using</span></span> vpeq_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
For the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">PREP</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stage (the first stage of the IPC action sequence) the precondition is True.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prec_first_IPC_action<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_SK_IPC <span class="free">aseq</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">s</span> <span class="free">d</span> <span class="main">(</span>hd <span class="free">aseq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> is_SK_IPC_def rprecondition_def atomic_step_precondition_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
For the the first stage of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EV_WAIT</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> action sequence the precondition is True.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prec_first_EV_WAIT_action<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_SK_EV_WAIT <span class="free">aseq</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">s</span> <span class="free">d</span> <span class="main">(</span>hd <span class="free">aseq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> is_SK_EV_WAIT_def rprecondition_def atomic_step_precondition_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
For the first stage of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">EV_SIGNAL</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> action sequence the precondition is True.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prec_first_EV_SIGNAL_action<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_SK_EV_SIGNAL <span class="free">aseq</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">s</span> <span class="free">d</span> <span class="main">(</span>hd <span class="free">aseq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> is_SK_EV_SIGNAL_def rprecondition_def atomic_step_precondition_def
          ev_signal_precondition_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
When not waiting or aborting, the precondition is ``1-step inductive'', that is at all times
the precondition holds initially (for the first step of an action sequence) and after doing 
one step.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prec_after_IPC_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> n_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">aseq</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IPC<span class="main">:</span> <span class="quoted"><span class="quoted">"is_SK_IPC <span class="free">aseq</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_aborting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>raborting <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_waiting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>rwaiting <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rprecondition <span class="main">(</span>rstep <span class="free">s</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> Suc <span class="free">n</span><span class="main">)</span>"</span></span>    
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dir</span> <span class="skolem">partner</span> <span class="skolem">page</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?page'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">page'</span> <span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> IPC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aseq</span> <span class="main">=</span> <span class="main">[</span>SK_IPC <span class="skolem">dir</span> PREP <span class="skolem">partner</span> <span class="skolem">page</span><span class="main">,</span>SK_IPC <span class="skolem">dir</span> WAIT <span class="skolem">partner</span> <span class="skolem">page</span><span class="main">,</span>SK_IPC <span class="skolem">dir</span> <span class="main">(</span>BUF <span class="var">?page'</span><span class="main">)</span> <span class="skolem">partner</span> <span class="skolem">page</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">=</span><span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 0 IPC prec not_aborting
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rprecondition_def atomic_step_precondition_def rstep_def rcurrent_def atomic_step_def atomic_step_ipc_def aborting_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">=</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 IPC prec not_waiting
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rprecondition_def atomic_step_precondition_def rstep_def rcurrent_def atomic_step_def atomic_step_ipc_def waiting_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> IPC 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">aseq</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> n_bound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> IPC
  <span class="keyword1"><span class="command">unfolding</span></span> is_SK_IPC_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
When not waiting or aborting, the precondition is 1-step inductive.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prec_after_EV_WAIT_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> n_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">aseq</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IPC<span class="main">:</span> <span class="quoted"><span class="quoted">"is_SK_EV_WAIT <span class="free">aseq</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_aborting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>raborting <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_waiting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>rwaiting <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rprecondition <span class="main">(</span>rstep <span class="free">s</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> Suc <span class="free">n</span><span class="main">)</span>"</span></span>    
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">consume</span>

  <span class="keyword3"><span class="command">assume</span></span> WAIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aseq</span> <span class="main">=</span> <span class="main">[</span>SK_EV_WAIT EV_PREP <span class="skolem">consume</span><span class="main">,</span>
                        SK_EV_WAIT EV_WAIT <span class="skolem">consume</span><span class="main">,</span>
                        SK_EV_WAIT EV_FINISH <span class="skolem">consume</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">=</span><span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 0 WAIT prec not_aborting
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rprecondition_def atomic_step_precondition_def 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">=</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 WAIT prec not_waiting
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rprecondition_def atomic_step_precondition_def 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> WAIT
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">aseq</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> n_bound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> is_SK_EV_WAIT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
When not waiting or aborting, the precondition is 1-step inductive.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prec_after_EV_SIGNAL_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"rprecondition <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> n_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">aseq</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> SIGNAL<span class="main">:</span> <span class="quoted"><span class="quoted">"is_SK_EV_SIGNAL <span class="free">aseq</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_aborting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>raborting <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_waiting<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>rwaiting <span class="free">s</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rprecondition <span class="main">(</span>rstep <span class="free">s</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rcurrent <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">aseq</span> <span class="main">!</span> Suc <span class="free">n</span><span class="main">)</span>"</span></span>    
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">partner</span>
    <span class="keyword3"><span class="command">assume</span></span> SIGNAL1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aseq</span> <span class="main">=</span> <span class="main">[</span>SK_EV_SIGNAL EV_SIGNAL_PREP <span class="skolem">partner</span><span class="main">,</span>
                            SK_EV_SIGNAL EV_SIGNAL_FINISH <span class="skolem">partner</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">=</span><span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 0 SIGNAL1 prec not_aborting 
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rprecondition_def atomic_step_precondition_def ev_signal_precondition_def
                aborting_def rstep_def atomic_step_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> SIGNAL1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">aseq</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> n_bound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> is_SK_EV_SIGNAL_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> on_set_object_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_impl_subj_subj <span class="main">(</span>set_object_value <span class="free">ob</span> <span class="free">val</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> sp_impl_subj_subj <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sp_impl_subj_obj <span class="main">(</span>set_object_value <span class="free">ob</span> <span class="free">val</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> sp_impl_subj_obj <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_object_value_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> prec_IPC_dom_independent<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"current <span class="free">s</span> <span class="main">≠</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="free">d</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="main">(</span>atomic_step_ipc <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s</span><span class="main">)</span> <span class="free">d</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms on_set_object_value
<span class="keyword1"><span class="command">unfolding</span></span> atomic_step_precondition_def atomic_step_ipc_def ipc_precondition_def
          ev_signal_precondition_def set_object_value_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits
                   ev_consume_t.splits ev_wait_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prec_ev_signal_dom_independent<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"current <span class="free">s</span> <span class="main">≠</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="free">d</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="main">(</span>atomic_step_ev_signal <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">partner</span> <span class="free">s</span><span class="main">)</span> <span class="free">d</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms on_set_object_value
<span class="keyword1"><span class="command">unfolding</span></span> atomic_step_precondition_def atomic_step_ev_signal_def ipc_precondition_def
          ev_signal_precondition_def set_object_value_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits
                   ev_consume_t.splits ev_wait_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prec_ev_wait_one_dom_independent<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"current <span class="free">s</span> <span class="main">≠</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="free">d</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="main">(</span>atomic_step_ev_wait_one <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">d</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms on_set_object_value
<span class="keyword1"><span class="command">unfolding</span></span> atomic_step_precondition_def atomic_step_ev_wait_one_def ipc_precondition_def
          ev_signal_precondition_def set_object_value_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits
                   ev_consume_t.splits ev_wait_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prec_ev_wait_all_dom_independent<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"current <span class="free">s</span> <span class="main">≠</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="free">s</span> <span class="free">d</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atomic_step_precondition <span class="main">(</span>atomic_step_ev_wait_all <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">d</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms on_set_object_value
<span class="keyword1"><span class="command">unfolding</span></span> atomic_step_precondition_def atomic_step_ev_wait_all_def ipc_precondition_def
          ev_signal_precondition_def set_object_value_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits
                   ev_consume_t.splits ev_wait_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prec_dom_independent<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="main">.</span> rcurrent <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> rprecondition <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> rprecondition <span class="main">(</span>rstep <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> atomic_step_preserves_invariants 
rstate_invariant prec_IPC_dom_independent prec_ev_signal_dom_independent
prec_ev_wait_all_dom_independent prec_ev_wait_one_dom_independent
<span class="keyword1"><span class="command">unfolding</span></span> rcurrent_def rprecondition_def rstep_def atomic_step_def 
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits  ev_consume_t.splits ev_wait_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ipc_precondition_after_cswitch<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipc_precondition <span class="free">d</span> <span class="free">dir</span> <span class="free">partner</span> <span class="free">page</span> <span class="main">(</span><span class="main">(</span><span class="main">↓</span> <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>current <span class="main">:=</span> <span class="free">new_current</span><span class="main">⦈</span><span class="main">)</span> 
          <span class="main">=</span> ipc_precondition <span class="free">d</span> <span class="free">dir</span> <span class="free">partner</span> <span class="free">page</span> <span class="main">(</span><span class="main">↓</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ipc_precondition_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ipc_direction_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> precondition_after_cswitch<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> rprecondition <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> rprecondition <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> cswitch_preserves_invariants rstate_invariant
<span class="keyword1"><span class="command">unfolding</span></span> rprecondition_def rcswitch_def atomic_step_precondition_def
          ev_signal_precondition_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits  ev_signal_stage_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> aborting_switch_independent<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span><span class="main">.</span> raborting <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> raborting <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tid</span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"raborting <span class="main">(</span>rcswitch <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">tid</span> <span class="skolem">a</span> <span class="main">=</span> raborting <span class="skolem">s</span> <span class="skolem">tid</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rstate_invariant cswitch_preserves_invariants ev_signal_precondition_weakly_step_consistent
            cswitch_consistency_and_respect
      <span class="keyword1"><span class="command">unfolding</span></span> aborting_def rcswitch_def 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits
                         ev_wait_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raborting <span class="main">(</span>rcswitch <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> raborting <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemma</span></span> waiting_switch_independent<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span><span class="main">.</span> rwaiting <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> rwaiting <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tid</span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwaiting <span class="main">(</span>rcswitch <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">tid</span> <span class="skolem">a</span> <span class="main">=</span> rwaiting <span class="skolem">s</span> <span class="skolem">tid</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rstate_invariant cswitch_preserves_invariants
      <span class="keyword1"><span class="command">unfolding</span></span> waiting_def rcswitch_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ev_wait_stage_t.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rwaiting <span class="main">(</span>rcswitch <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> rwaiting <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aborting_after_IPC_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">≠</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"aborting <span class="main">(</span>atomic_step_ipc <span class="free">d1</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s</span><span class="main">)</span> <span class="free">d2</span> <span class="free">a</span> <span class="main">=</span> aborting <span class="free">s</span> <span class="free">d2</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def aborting_def set_object_value_def ipc_precondition_def
          ev_signal_precondition_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits
                   ev_signal_stage_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> waiting_after_IPC_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">≠</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"waiting <span class="main">(</span>atomic_step_ipc <span class="free">d1</span> <span class="free">dir</span> <span class="free">stage</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s</span><span class="main">)</span> <span class="free">d2</span> <span class="free">a</span> <span class="main">=</span> waiting <span class="free">s</span> <span class="free">d2</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> atomic_step_ipc_def waiting_def set_object_value_def ipc_precondition_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits
                   ev_wait_stage_t.splits<span class="main">)</span>
<span class="comment1">(*
lemma raborting_after_step:
shows "∀s a d. rcurrent s ≠ d ⟶ raborting (rstep s a) d = raborting s d"
proof-
{
  fix s a d
  assume not_curr: "rcurrent s ≠ d"
  {
    fix a
    have "raborting (rstep s a) d = raborting s d"
      using not_curr aborting_after_IPC_step
            rstate_invariant atomic_ipc_preserves_invariants
      unfolding rcurrent_def  rstep_def atomic_step_def
      by(auto split: int_point_t.splits)
  }
  hence "raborting (rstep s a) d = raborting s d" by auto
}
thus ?thesis by auto
qed
*)</span>
<span class="comment1">(*
lemma rwaiting_after_step:
shows "∀s a d. rcurrent s ≠ d ⟶ rwaiting (rstep s a) d = rwaiting s d"
proof-
{
  fix s a d
  assume not_curr: "rcurrent s ≠ d"
  {
    fix a
    have "rwaiting (rstep s a) d = rwaiting s d"
      using not_curr waiting_after_IPC_step
            rstate_invariant atomic_ipc_preserves_invariants
      unfolding rcurrent_def  rstep_def atomic_step_def
      by(auto split: int_point_t.splits)
  }
  hence "rwaiting (rstep s a) d = rwaiting s d" by auto
}
thus ?thesis by auto
qed
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> raborting_consistent<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> raborting <span class="bound">s</span> <span class="bound">u</span> <span class="main">=</span> raborting <span class="bound">t</span> <span class="bound">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> 
  <span class="keyword3"><span class="command">assume</span></span> vpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"rvpeq <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">from</span></span> vpeq ipc_precondition_weakly_step_consistent rstate_invariant
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">tid</span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="main">.</span> ipc_precondition <span class="skolem">u</span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="main">(</span><span class="main">↓</span><span class="skolem">s</span><span class="main">)</span> 
                                    <span class="main">=</span> ipc_precondition <span class="skolem">u</span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="main">(</span><span class="main">↓</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rvpeq_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> vpeq rstate_invariant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"raborting <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="main">=</span> raborting <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> aborting_def rvpeq_def vpeq_def vpeq_local_def ev_signal_precondition_def
               vpeq_subj_subj_def atomic_step_invariant_def sp_subset_def rep_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raborting <span class="skolem">s</span> <span class="skolem">u</span> <span class="main">=</span> raborting <span class="skolem">t</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aborting_dom_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rcurrent <span class="free">s</span> <span class="main">≠</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raborting <span class="main">(</span>rstep <span class="free">s</span> <span class="free">a</span><span class="main">)</span> <span class="free">d</span> <span class="free">a'</span> <span class="main">=</span> raborting <span class="free">s</span> <span class="free">d</span> <span class="free">a'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">tid</span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="bound">s</span> <span class="main">.</span> ipc_precondition <span class="bound">tid</span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="bound">s</span> <span class="main">=</span> ipc_precondition <span class="bound">tid</span> <span class="bound">dir</span> <span class="bound">partner</span> <span class="bound">page</span> <span class="main">(</span>atomic_step <span class="bound">s</span> <span class="free">a</span><span class="main">)</span>
                                   <span class="main">∧</span> ev_signal_precondition <span class="bound">tid</span> <span class="bound">partner</span>  <span class="bound">s</span> <span class="main">=</span> ev_signal_precondition <span class="bound">tid</span> <span class="bound">partner</span> <span class="main">(</span>atomic_step <span class="bound">s</span> <span class="free">a</span><span class="main">)</span>
       "</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tid</span> <span class="skolem">dir</span> <span class="skolem">partner</span> <span class="skolem">page</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"atomic_step <span class="skolem">s</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">.</span> sp_impl_subj_subj <span class="skolem">s</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">=</span> sp_impl_subj_subj <span class="var">?s</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>
       <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="bound">x</span> <span class="bound">m</span> <span class="main">.</span> sp_impl_subj_obj <span class="skolem">s</span> <span class="bound">p</span> <span class="bound">x</span> <span class="bound">m</span> <span class="main">=</span> sp_impl_subj_obj <span class="var">?s</span> <span class="bound">p</span> <span class="bound">x</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> atomic_step_def atomic_step_ipc_def
               atomic_step_ev_wait_all_def atomic_step_ev_wait_one_def
               atomic_step_ev_signal_def set_object_value_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ipc_direction_t.splits
          ev_wait_stage_t.splits ev_consume_t.splits  ev_signal_stage_t.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipc_precondition <span class="skolem">tid</span> <span class="skolem">dir</span> <span class="skolem">partner</span> <span class="skolem">page</span> <span class="skolem">s</span> <span class="main">=</span> ipc_precondition <span class="skolem">tid</span> <span class="skolem">dir</span> <span class="skolem">partner</span> <span class="skolem">page</span> <span class="main">(</span>atomic_step <span class="skolem">s</span> <span class="free">a</span><span class="main">)</span>
         <span class="main">∧</span> ev_signal_precondition <span class="skolem">tid</span> <span class="skolem">partner</span>  <span class="skolem">s</span> <span class="main">=</span> ev_signal_precondition <span class="skolem">tid</span> <span class="skolem">partner</span> <span class="main">(</span>atomic_step <span class="skolem">s</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ipc_precondition_def ev_signal_precondition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="main">(</span><span class="main">↓</span><span class="main">(</span><span class="main">↑</span><span class="main">(</span>atomic_step <span class="main">(</span><span class="main">↓</span><span class="free">s</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> atomic_step <span class="main">(</span><span class="main">↓</span><span class="free">s</span><span class="main">)</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rstate_invariant atomic_step_preserves_invariants rstate_up_down <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aborting_def rstep_def ev_signal_precondition_def
              
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ev_wait_stage_t.splits
                        ev_signal_stage_t.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipc_precondition_of_partner_consistent<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> vpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> rkinvolved <span class="main">(</span>SK_IPC <span class="free">dir</span> WAIT <span class="free">partner</span> <span class="free">page</span><span class="main">)</span> <span class="main">.</span> rvpeq <span class="bound">d</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipc_precondition <span class="free">partner</span> <span class="free">dir'</span> <span class="free">u</span> <span class="free">page'</span> <span class="main">(</span><span class="main">↓</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>  ipc_precondition <span class="free">partner</span> <span class="free">dir'</span> <span class="free">u</span> <span class="free">page'</span> <span class="main">↓</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms ipc_precondition_weakly_step_consistent rstate_invariant
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rvpeq_def rkinvolved_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> ev_signal_precondition_of_partner_consistent<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> vpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> rkinvolved <span class="main">(</span>SK_EV_SIGNAL EV_SIGNAL_FINISH <span class="free">partner</span><span class="main">)</span> <span class="main">.</span> rvpeq <span class="bound">d</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ev_signal_precondition <span class="free">partner</span> <span class="free">u</span> <span class="main">(</span><span class="main">↓</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>  ev_signal_precondition <span class="free">partner</span> <span class="free">u</span> <span class="main">(</span><span class="main">↓</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms ev_signal_precondition_weakly_step_consistent rstate_invariant
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> rvpeq_def rkinvolved_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 
 
<span class="keyword1"><span class="command">lemma</span></span> waiting_consistent<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span> <span class="main">.</span> rvpeq <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> rkinvolved <span class="bound">a</span> <span class="main">.</span> rvpeq <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> 
        <span class="main">∧</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span>
        <span class="main">⟶</span> rwaiting <span class="bound">s</span> <span class="bound">u</span> <span class="bound">a</span> <span class="main">=</span> rwaiting <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> vpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"rvpeq <span class="main">(</span>rcurrent <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> vpeq_involved<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> rkinvolved <span class="skolem">a</span> <span class="main">.</span> rvpeq <span class="bound">d</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> vpeq_u<span class="main">:</span> <span class="quoted"><span class="quoted">"rvpeq <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwaiting <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="main">=</span> rwaiting <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> SK_IPC
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rwaiting <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="main">=</span> rwaiting <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ipc_precondition_of_partner_consistent vpeq_involved
      <span class="keyword1"><span class="command">unfolding</span></span> waiting_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ipc_stage_t.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> SK_EV_WAIT
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rwaiting <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="main">=</span> rwaiting <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ev_signal_precondition_of_partner_consistent
        vpeq_involved vpeq vpeq_u
        <span class="keyword1"><span class="command">unfolding</span></span> waiting_def rkinvolved_def ev_signal_precondition_def
                  rvpeq_def vpeq_def vpeq_local_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ipc_stage_t.splits ev_wait_stage_t.splits ev_consume_t.splits<span class="main">)</span>      
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> waiting_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> waiting_def<span class="main">)</span> 
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipc_precondition_ensures_ifp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipc_precondition <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">dir</span> <span class="free">partner</span> <span class="free">page</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rifp <span class="free">partner</span> <span class="main">(</span>current <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">.</span> Policy.sp_spec_subj_subj <span class="main">(</span>partition <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span>partition <span class="bound">t2</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sp</span> <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">partner</span> <span class="main">∨</span> <span class="var">?sp</span> <span class="free">partner</span> <span class="main">(</span>current <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ipc_precondition_def atomic_step_invariant_def sp_subset_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rifp_def <span class="keyword1"><span class="command">using</span></span> Policy_properties.ifp_compatible_with_sp_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ev_signal_precondition_ensures_ifp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ev_signal_precondition <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">partner</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atomic_step_invariant <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rifp <span class="free">partner</span> <span class="main">(</span>current <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">.</span> Policy.sp_spec_subj_subj <span class="main">(</span>partition <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span>partition <span class="bound">t2</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sp</span> <span class="main">(</span>current <span class="free">s</span><span class="main">)</span> <span class="free">partner</span> <span class="main">∨</span> <span class="var">?sp</span> <span class="free">partner</span> <span class="main">(</span>current <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ev_signal_precondition_def atomic_step_invariant_def sp_subset_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rifp_def <span class="keyword1"><span class="command">using</span></span> Policy_properties.ifp_compatible_with_sp_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> involved_ifp<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> rkinvolved <span class="bound">a</span> <span class="main">.</span> rprecondition <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> rifp <span class="bound">d</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> d_involved<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> rkinvolved <span class="skolem">a</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> prec<span class="main">:</span> <span class="quoted"><span class="quoted">"rprecondition <span class="skolem">s</span> <span class="main">(</span>rcurrent <span class="skolem">s</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> d_involved prec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rifp <span class="skolem">d</span> <span class="main">(</span>rcurrent <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ipc_precondition_ensures_ifp ev_signal_precondition_ensures_ifp rstate_invariant
    <span class="keyword1"><span class="command">unfolding</span></span> rkinvolved_def rprecondition_def atomic_step_precondition_def rcurrent_def Kernel.involved_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ev_signal_stage_t.splits<span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_of_waiting_ev<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> rwaiting <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>SK_EV_WAIT EV_FINISH EV_CONSUME_ALL<span class="main">)</span> 
               <span class="main">⟶</span> rstep <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> waiting_def
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_of_waiting_ev_w<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> rwaiting <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>SK_EV_WAIT EV_WAIT EV_CONSUME_ALL<span class="main">)</span> 
               <span class="main">⟶</span> rstep <span class="bound">s</span> <span class="main">(</span>SK_EV_WAIT EV_WAIT EV_CONSUME_ALL<span class="main">)</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> rstep_def atomic_step_def
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ev_wait_stage_t.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_of_waiting<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> rwaiting <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> rstep <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> waiting_def rstep_def atomic_step_def atomic_step_ipc_def
          atomic_step_ev_signal_def atomic_step_ev_wait_all_def
          atomic_step_ev_wait_one_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> int_point_t.splits ipc_stage_t.splits ev_wait_stage_t.splits<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Link_separation_kernel_model_to_CISK">
<div class="head">
<h1>Theory Link_separation_kernel_model_to_CISK</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Link implementation to CISK: the specific separation kernel is an interpretation of the generic model.\label{sect:link_to_CISK}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Link_separation_kernel_model_to_CISK
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Separation_kernel_model.html">Separation_kernel_model</a>         
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that the separation kernel instantiation satisfies the 
specification of CISK.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> CISK_proof_obligations_satisfied<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Controllable_Interruptible_Separation_Kernel
      rstep
      routput_f
      <span class="main">(</span><span class="main">↑</span>s0<span class="main">)</span>
      rcurrent
      rcswitch
      rkinvolved
      rifp
      rvpeq
      rAS_set
      rinvariant
      rprecondition
      raborting
      rwaiting
      rset_error_code"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="comment1">― ‹show that rvpeq is equivalence relation›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span>rvpeq <span class="bound">u</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> rvpeq <span class="bound">u</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> rvpeq <span class="bound">u</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">u</span><span class="main">.</span> rvpeq <span class="bound">u</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> rvpeq <span class="bound">u</span> <span class="bound">b</span> <span class="bound">a</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">u</span><span class="main">.</span> rvpeq <span class="bound">u</span> <span class="bound">a</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_vpeq_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="comment1">― ‹show output consistency›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> rvpeq <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> rcurrent <span class="bound">s</span> <span class="main">=</span> rcurrent <span class="bound">t</span> <span class="main">⟶</span> routput_f <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> routput_f <span class="bound">t</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_output_consistency <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="comment1">― ‹show reflexivity of ifp›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">.</span> rifp <span class="bound">u</span> <span class="bound">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_ifp_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="comment1">― ‹show step consistency›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span><span class="main">.</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> rvpeq <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> True <span class="main">∧</span> rprecondition <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> True <span class="main">∧</span> rprecondition <span class="bound">t</span> <span class="main">(</span>rcurrent <span class="bound">t</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> rcurrent <span class="bound">s</span> <span class="main">=</span> rcurrent <span class="bound">t</span> <span class="main">⟶</span>
              rvpeq <span class="bound">u</span> <span class="main">(</span>rstep <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>rstep <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_weakly_step_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹show step atomicity›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">.</span> rcurrent <span class="main">(</span>rstep <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> rcurrent <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_step_atomicity <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">a</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">.</span> <span class="main">¬</span> rifp <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span> <span class="main">∧</span> True <span class="main">∧</span> rprecondition <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span>rstep <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_local_respect <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹show cswitch is independent of state›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> rcurrent <span class="bound">s</span> <span class="main">=</span> rcurrent <span class="bound">t</span> <span class="main">⟶</span> rcurrent <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> rcurrent <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_cswitch_independent_of_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="comment1">― ‹show cswitch consistency›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> rvpeq <span class="bound">u</span> <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_cswitch_consistency <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="comment1">― ‹Show the empt action sequence is in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">AS_set</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> rAS_set"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rAS_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹The invariant for the initial state, already encoded in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">rstate_t</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"True"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹Step function of the invariant, already encoded in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">rstate_t</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">n</span><span class="main">.</span> True <span class="main">⟶</span> True"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹The precondition does not change with a context switch›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> rprecondition <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> rprecondition <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> precondition_after_cswitch <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹The precondition holds for the first action of each action sequence›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">aseq</span><span class="main">.</span> True <span class="main">∧</span> <span class="bound">aseq</span> <span class="main">∈</span> rAS_set <span class="main">∧</span> <span class="bound">aseq</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> rprecondition <span class="bound">s</span> <span class="bound">d</span> <span class="main">(</span>hd <span class="bound">aseq</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prec_first_IPC_action prec_first_EV_WAIT_action prec_first_EV_SIGNAL_action
    <span class="keyword1"><span class="command">unfolding</span></span> rAS_set_def is_sub_seq_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹The precondition holds for the next action in an action sequence, assuming the sequence is not aborted or delayed›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">aseq</span><span class="main">∈</span>rAS_set<span class="main">.</span> is_sub_seq <span class="bound">a</span> <span class="bound">a'</span> <span class="bound">aseq</span><span class="main">)</span> <span class="main">∧</span> True <span class="main">∧</span> rprecondition <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">¬</span> raborting <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">¬</span> rwaiting <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span>
             rprecondition <span class="main">(</span>rstep <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prec_after_IPC_step prec_after_EV_SIGNAL_step prec_after_EV_WAIT_step
    <span class="keyword1"><span class="command">unfolding</span></span> rAS_set_def is_sub_seq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹Steps of other domains do not influence the precondition›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> rcurrent <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> rprecondition <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> rprecondition <span class="main">(</span>rstep <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prec_dom_independent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹The invariant›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> True <span class="main">⟶</span> True"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹Aborting does not depend on a context switch›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span><span class="main">.</span> raborting <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> raborting <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aborting_switch_independent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹Aborting does not depend on actions of other domains›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span> <span class="bound">d</span><span class="main">.</span> rcurrent <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">⟶</span> raborting <span class="main">(</span>rstep <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">d</span> <span class="main">=</span> raborting <span class="bound">s</span> <span class="bound">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aborting_dom_independent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹Aborting is consistent›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> raborting <span class="bound">s</span> <span class="bound">u</span> <span class="main">=</span> raborting <span class="bound">t</span> <span class="bound">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raborting_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹Waiting does not depend on a context switch›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span><span class="main">.</span> rwaiting <span class="main">(</span>rcswitch <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> rwaiting <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> waiting_switch_independent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹Waiting is consistent›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span><span class="main">.</span> rvpeq <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> rkinvolved <span class="bound">a</span> <span class="main">.</span> rvpeq <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> 
         <span class="main">∧</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span>  
         <span class="main">⟶</span> rwaiting <span class="bound">s</span> <span class="bound">u</span> <span class="bound">a</span> <span class="main">=</span> rwaiting <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Kernel.involved_def
    <span class="keyword1"><span class="command">using</span></span> waiting_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹Domains that are involved in an action may influence the domain of the action›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> rkinvolved <span class="bound">a</span><span class="main">.</span> rprecondition <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> rifp <span class="bound">d</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> involved_ifp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹An action that is waiting does not change the state›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> rwaiting <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> rstep <span class="bound">s</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spec_of_waiting <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹Proof obligations for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">set_error_code</span></span><span class="antiquote">}</span></span>. Right now, they are all trivial›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">a'</span> <span class="bound">a</span><span class="main">.</span> rcurrent <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> raborting <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> raborting <span class="main">(</span>rset_error_code <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rset_error_code_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span> <span class="bound">a</span><span class="main">.</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟶</span> rvpeq <span class="bound">u</span> <span class="main">(</span>rset_error_code <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>rset_error_code <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rset_error_code_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">u</span> <span class="bound">a</span><span class="main">.</span> <span class="main">¬</span> rifp <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">u</span> <span class="main">⟶</span> rvpeq <span class="bound">u</span> <span class="bound">s</span> <span class="main">(</span>rset_error_code <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rset_error_code_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span> <span class="bound">u</span><span class="main">.</span> rvpeq <span class="bound">u</span> <span class="bound">a</span> <span class="bound">a</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> rcurrent <span class="main">(</span>rset_error_code <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> rcurrent <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rset_error_code_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> rprecondition <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">∧</span> raborting <span class="bound">s</span> <span class="main">(</span>rcurrent <span class="bound">s</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">⟶</span> rprecondition <span class="main">(</span>rset_error_code <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rset_error_code_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">d</span> <span class="bound">a'</span> <span class="bound">a</span><span class="main">.</span> rcurrent <span class="bound">s</span> <span class="main">≠</span> <span class="bound">d</span> <span class="main">∧</span> rwaiting <span class="bound">s</span> <span class="bound">d</span> <span class="bound">a</span> <span class="main">⟶</span> rwaiting <span class="main">(</span>rset_error_code <span class="bound">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">d</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rset_error_code_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can instantiate CISK with some initial state, interrupt function, etc.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Inst<span class="main">:</span>
  Controllable_Interruptible_Separation_Kernel
    <span class="quoted">rstep</span>           <span class="comment1">― ‹step function, without program stack›</span>
    <span class="quoted">routput_f</span>       <span class="comment1">― ‹output function›</span>
    <span class="quoted"><span class="quoted">"<span class="main">↑</span>s0"</span></span>           <span class="comment1">― ‹initial state›</span>
    <span class="quoted">rcurrent</span>        <span class="comment1">― ‹returns the currently active domain›</span>
    <span class="quoted">rcswitch</span>        <span class="comment1">― ‹switches the currently active domain›</span>
    <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="numeral">42</span>"</span></span>     <span class="comment1">― ‹interrupt function (yet unspecified)›</span>
    <span class="quoted">rkinvolved</span>      <span class="comment1">― ‹returns a set of threads involved in the give action›</span>
    <span class="quoted">rifp</span>            <span class="comment1">― ‹information flow policy›</span>
    <span class="quoted">rvpeq</span>           <span class="comment1">― ‹view partitioning›</span>
    <span class="quoted">rAS_set</span>         <span class="comment1">― ‹the set of valid action sequences›</span>
    <span class="quoted">rinvariant</span>      <span class="comment1">― ‹the state invariant›</span>
    <span class="quoted">rprecondition</span>   <span class="comment1">― ‹the precondition for doing an action›</span>
    <span class="quoted">raborting</span>       <span class="comment1">― ‹condition under which an action is aborted›</span>
    <span class="quoted">rwaiting</span>        <span class="comment1">― ‹condition under which an action is delayed›</span>
    <span class="quoted">rset_error_code</span> <span class="comment1">― ‹updates the state. Has no meaning in the current model.›</span>
<span class="keyword1"><span class="command">using</span></span> CISK_proof_obligations_satisfied <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main theorem: the instantiation implements the information flow policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ifp</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> risecure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Inst.isecure"</span></span>
<span class="keyword1"><span class="command">using</span></span> Inst.unwinding_implies_isecure_CISK
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>