<div id="FingerTree">
<div class="head">
<h1>Theory FingerTree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"2-3 Finger Trees"</span></span> 

<span class="keyword1"><span class="command">theory</span></span> FingerTree
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We implement and prove correct 2-3 finger trees as described by Ralf Hinze 
  and Ross Paterson\cite{HiPa06}.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory is organized as follows: 
  Section~\ref{sec:datatype} contains the finger-tree datatype, its invariant
  and its abstraction function to lists.
  The Section~\ref{sec:operations} contains the operations 
  on finger trees and their correctness lemmas.
  Section~\ref{sec:hide_invar} contains a finger tree datatype with implicit
  invariant, and, finally, Section~\ref{sec:doc} contains a documentation
  of the implemented operations.
›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Technical Issues}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As Isabelle lacks proper support of namespaces, we
  try to simulate namespaces by locales.

  The problem is, that we define lots of internal functions that
  should not be exposed to the user at all.
  Moreover, we define some functions with names equal to names
  from Isabelle's standard library. These names make perfect sense
  in the context of FingerTrees, however, they shall not be exposed 
  to anyone using this theory indirectly, hiding the standard library
  names there.

  Our approach puts all functions and lemmas inside the locale 
  {\em FingerTree\_loc},
  and then interprets this locale with the prefix {\em FingerTree}.
  This makes all definitions visible outside the locale, with
  qualified names. Inside the locale, however, one can use unqualified names.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Datatype definition"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\label{sec:datatype}›</span></span>
<span class="keyword1"><span class="command">locale</span></span> FingerTreeStruc_loc

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Nodes: Non empty 2-3 trees, with all elements stored within the leafs plus a 
  cached annotation 
›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">=</span> Tip <span class="tfree"><span class="quoted"><span class="tfree">'e</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span>
  Node2 <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="main">|</span> 
  Node3 <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Digit: one to four ordered Nodes›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">=</span> One <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="main">|</span>
   Two <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="main">|</span>
   Three <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="main">|</span>
   Four <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹FingerTreeStruc: 
    The empty tree, a single node or some nodes and a deeper tree›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">=</span> 
  Empty <span class="main">|</span>
  Single <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node"</span></span> <span class="main">|</span>
  Deep <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Invariant"</span></span>

<span class="keyword1"><span class="command">context</span></span> FingerTreeStruc_loc
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Auxiliary functions}\ \\›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Readout the cached annotation of a node›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gmn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gmn</span> <span class="main">(</span>Tip <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gmn</span> <span class="main">(</span>Node2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gmn</span> <span class="main">(</span>Node3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The annotation of a digit is computed on the fly›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Digit <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gmd</span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> gmn <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gmd</span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gmd</span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gmd</span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Readout the cached annotation of a finger tree›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gmft</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gmft</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gmft</span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">nd</span></span></span><span class="main">)</span> <span class="main">=</span> gmn <span class="free"><span class="bound"><span class="entity">nd</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gmft</span> <span class="main">(</span>Deep <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Depth and cached annotations have to be correct›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_leveln_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_node</span> <span class="main">0</span> <span class="main">(</span>Tip <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_node</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Node2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">⟷</span> 
    <span class="free">is_leveln_node</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">∧</span> <span class="free">is_leveln_node</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_node</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Node3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span><span class="main">)</span> <span class="main">⟷</span> 
    <span class="free">is_leveln_node</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">∧</span> <span class="free">is_leveln_node</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">∧</span> <span class="free">is_leveln_node</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_node</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_leveln_digit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_digit</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">⟷</span> is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_digit</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">⟷</span> is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">∧</span> 
    is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_digit</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span><span class="main">)</span> <span class="main">⟷</span> is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">∧</span> 
    is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">∧</span> is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_digit</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span> <span class="free"><span class="bound"><span class="entity">n4</span></span></span><span class="main">)</span> <span class="main">⟷</span> is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">∧</span> 
    is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">∧</span> is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span> <span class="main">∧</span> is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n4</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_leveln_ftree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_ftree</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> Empty <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_ftree</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">nd</span></span></span><span class="main">)</span> <span class="main">⟷</span> is_leveln_node <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">nd</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leveln_ftree</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> is_leveln_digit <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> 
    is_leveln_digit <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">is_leveln_ftree</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_measured_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_node</span> <span class="main">(</span>Tip <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_node</span> <span class="main">(</span>Node2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">is_measured_node</span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free">is_measured_node</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_node</span> <span class="main">(</span>Node3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">is_measured_node</span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free">is_measured_node</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">is_measured_node</span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">n3</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_measured_digit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Digit <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_digit</span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> is_measured_node <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_digit</span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_digit</span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_digit</span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_measured_ftree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_ftree</span> Empty <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_ftree</span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>is_measured_node <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_measured_ftree</span> <span class="main">(</span>Deep <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span>is_measured_digit <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free">is_measured_ftree</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>is_measured_digit <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>gmd <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmft <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Structural invariant for finger trees"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ft_invar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> is_leveln_ftree <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> is_measured_ftree <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Abstraction to Lists"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nodeToList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nodeToList</span> <span class="main">(</span>Tip <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nodeToList</span> <span class="main">(</span>Node2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nodeToList</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">nodeToList</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nodeToList</span> <span class="main">(</span>Node3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="free">nodeToList</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">nodeToList</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">nodeToList</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">digitToList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToList</span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> nodeToList <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToList</span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToList</span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToList</span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"List representation of a finger tree"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">toList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">toList</span> Empty <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">toList</span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> nodeToList <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">toList</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>digitToList <span class="free"><span class="bound"><span class="entity">pr</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">toList</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>digitToList <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-nodeToList_empty"><span class="command">lemma</span></span> nodeToList_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"nodeToList <span class="free">nd</span> <span class="main">≠</span> Nil"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">nd</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="FingerTree-digitToList_empty"><span class="command">lemma</span></span> digitToList_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"digitToList <span class="free">d</span> <span class="main">≠</span> Nil"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToList_empty<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>
<span class="keyword1" id="FingerTree-gmn_correct"><span class="command">lemma</span></span> gmn_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_measured_node <span class="free">nd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gmn <span class="free">nd</span> <span class="main">=</span> sum_list <span class="main">(</span>map snd <span class="main">(</span>nodeToList <span class="free">nd</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">nd</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1" id="FingerTree-gmd_correct"><span class="command">lemma</span></span> gmd_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gmd <span class="free">d</span> <span class="main">=</span> sum_list <span class="main">(</span>map snd <span class="main">(</span>digitToList <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmn_correct add.assoc<span class="main">)</span>

<span class="keyword1" id="FingerTree-gmft_correct"><span class="command">lemma</span></span> gmft_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="free">t</span> 
  <span class="main">⟹</span> <span class="main">(</span>gmft <span class="free">t</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map snd <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ft_invar_def gmd_correct gmn_correct add.assoc<span class="main">)</span>
<span class="keyword1" id="FingerTree-gmft_correct2"><span class="command">lemma</span></span> gmft_correct2<span class="main">:</span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span>gmft <span class="free">t</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map snd <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ft_invar_def gmft_correct<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\label{sec:operations}›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Empty tree›</span></span>
<span class="keyword1" id="FingerTree-Empty_correct"><span class="command">lemma</span></span> Empty_correct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"toList Empty <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"ft_invar Empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ft_invar_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Exactly the empty finger tree represents the empty list›</span></span>
<span class="keyword1" id="FingerTree-toList_empty"><span class="command">lemma</span></span> toList_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> Empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToList_empty digitToList_empty<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Annotation›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Sum of annotations of all elements of a finger tree"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">annot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">annot</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> gmft <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="FingerTree-annot_correct"><span class="command">lemma</span></span> annot_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span> <span class="main">⟹</span> annot <span class="free">t</span> <span class="main">=</span> sum_list <span class="main">(</span>map snd <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gmft_correct
  <span class="keyword1"><span class="command">unfolding</span></span> annot_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmft_correct2<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Appending›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary functions to fill in the annotations›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deep</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Digit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deep</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span> <span class="main">=</span> Deep <span class="main">(</span><span class="main">(</span>gmd <span class="free"><span class="bound"><span class="entity">pr</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmft <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmd <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">node2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node2</span> <span class="free"><span class="bound"><span class="entity">nd1</span></span></span> <span class="free"><span class="bound"><span class="entity">nd2</span></span></span> <span class="main">=</span> Node2 <span class="main">(</span><span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">nd1</span></span></span><span class="main">)</span><span class="main">+</span><span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">nd2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nd1</span></span></span> <span class="free"><span class="bound"><span class="entity">nd2</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">node3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node3</span> <span class="free"><span class="bound"><span class="entity">nd1</span></span></span> <span class="free"><span class="bound"><span class="entity">nd2</span></span></span> <span class="free"><span class="bound"><span class="entity">nd3</span></span></span> <span class="main">=</span> Node3 <span class="main">(</span><span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">nd1</span></span></span><span class="main">)</span><span class="main">+</span><span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">nd2</span></span></span><span class="main">)</span><span class="main">+</span><span class="main">(</span>gmn <span class="free"><span class="bound"><span class="entity">nd3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nd1</span></span></span> <span class="free"><span class="bound"><span class="entity">nd2</span></span></span> <span class="free"><span class="bound"><span class="entity">nd3</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Append a node at the left end"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nlcons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span>  
<span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">― ‹Recursively we append a node, if the digit is full we push down a node3›</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlcons</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Empty <span class="main">=</span> Single <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlcons</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> deep <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> Empty <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlcons</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> deep <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlcons</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> deep <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlcons</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> deep <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlcons</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> 
    <span class="main">=</span> deep <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nlcons</span> <span class="main">(</span>node3 <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Append a node at the right end"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nrcons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹Recursively we append a node, if the digit is full we push down a node3›</span>
  <span class="quoted"><span class="quoted">"<span class="free">nrcons</span> Empty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> Single <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nrcons</span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> deep <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> Empty <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nrcons</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Two  <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nrcons</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nrcons</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nrcons</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> 
    <span class="main">=</span> deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="main">(</span><span class="free">nrcons</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>node3 <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-nlcons_invlevel"><span class="command">lemma</span></span> nlcons_invlevel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_leveln_ftree <span class="free">n</span> <span class="free">t</span><span class="main">;</span> is_leveln_node <span class="free">n</span> <span class="free">nd</span><span class="main">⟧</span> 
  <span class="main">⟹</span> is_leveln_ftree <span class="free">n</span> <span class="main">(</span>nlcons <span class="free">nd</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nlcons.induct<span class="main">)</span> 
<span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def node3_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-nlcons_invmeas"><span class="command">lemma</span></span> nlcons_invmeas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_measured_ftree <span class="free">t</span><span class="main">;</span> is_measured_node <span class="free">nd</span><span class="main">⟧</span> 
  <span class="main">⟹</span> is_measured_ftree <span class="main">(</span>nlcons <span class="free">nd</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nlcons.induct<span class="main">)</span> 
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def node3_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> nlcons_inv <span class="main">=</span> nlcons_invlevel nlcons_invmeas

<span class="keyword1" id="FingerTree-nlcons_list"><span class="command">lemma</span></span> nlcons_list<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>nlcons <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nodeToList <span class="free">a</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nlcons.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def toList_def node3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="FingerTree-nrcons_invlevel"><span class="command">lemma</span></span> nrcons_invlevel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_leveln_ftree <span class="free">n</span> <span class="free">t</span><span class="main">;</span> is_leveln_node <span class="free">n</span> <span class="free">nd</span><span class="main">⟧</span> 
  <span class="main">⟹</span> is_leveln_ftree <span class="free">n</span> <span class="main">(</span>nrcons <span class="free">t</span> <span class="free">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nrcons.induct<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def node3_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="FingerTree-nrcons_invmeas"><span class="command">lemma</span></span> nrcons_invmeas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_measured_ftree <span class="free">t</span><span class="main">;</span> is_measured_node <span class="free">nd</span><span class="main">⟧</span> 
  <span class="main">⟹</span> is_measured_ftree <span class="main">(</span>nrcons <span class="free">t</span> <span class="free">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nrcons.induct<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def node3_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nrcons_inv <span class="main">=</span> nrcons_invlevel nrcons_invmeas

<span class="keyword1" id="FingerTree-nrcons_list"><span class="command">lemma</span></span> nrcons_list<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>nrcons <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nrcons.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def toList_def node3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Append an element at the left end"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lcons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊲</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> nlcons <span class="main">(</span>Tip <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="FingerTree-lcons_correct"><span class="command">lemma</span></span> lcons_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span><span class="free">a</span> <span class="main">⊲</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span><span class="free">a</span> <span class="main">⊲</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> ft_invar_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcons_def nlcons_list nlcons_invlevel nlcons_invmeas<span class="main">)</span>

<span class="keyword1" id="FingerTree-lcons_inv"><span class="command">lemma</span></span> lcons_inv<span class="main">:</span><span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span> <span class="main">⟹</span> ft_invar <span class="main">(</span><span class="free">a</span> <span class="main">⊲</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lcons_correct<span class="main">)</span>

<span class="keyword1" id="FingerTree-lcons_list"><span class="command">lemma</span></span> lcons_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span><span class="free">a</span> <span class="main">⊲</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcons_def nlcons_list<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Append an element at the right end"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rcons</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊳</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⊳</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> nrcons <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>Tip <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-rcons_correct"><span class="command">lemma</span></span> rcons_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span><span class="free">t</span> <span class="main">⊳</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span><span class="free">t</span> <span class="main">⊳</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nrcons_inv ft_invar_def rcons_def nrcons_list<span class="main">)</span>

<span class="keyword1" id="FingerTree-rcons_inv"><span class="command">lemma</span></span> rcons_inv<span class="main">:</span><span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span> <span class="main">⟹</span> ft_invar <span class="main">(</span><span class="free">t</span> <span class="main">⊳</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rcons_correct<span class="main">)</span>

<span class="keyword1" id="FingerTree-rcons_list"><span class="command">lemma</span></span> rcons_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span><span class="free">t</span> <span class="main">⊳</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nrcons_list rcons_def<span class="main">)</span> 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Convert list to tree›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">toTree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">toTree</span> <span class="main">[]</span> <span class="main">=</span> Empty"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">toTree</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊲</span> <span class="main">(</span><span class="free">toTree</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-toTree_correct"><span class="command">lemma</span></span> toTree_correct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span>toTree <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>toTree <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ft_invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toTree_def lcons_list lcons_inv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toTree_def lcons_list lcons_inv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Note that this lemma is a completeness statement of our implementation, 
  as it can be read as:
  ,,All lists of elements have a valid representation as a finger tree.''
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Detaching leftmost/rightmost element›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">digitToTree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Digit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToTree</span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Single <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToTree</span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> deep <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> Empty <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToTree</span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> deep <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> Empty <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToTree</span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> deep <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> Empty <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nodeToDigit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nodeToDigit</span> <span class="main">(</span>Tip <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> One <span class="main">(</span>Tip <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nodeToDigit</span> <span class="main">(</span>Node2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nodeToDigit</span> <span class="main">(</span>Node3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nlistToDigit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nlistToDigit</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">=</span> One <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlistToDigit</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> <span class="main">=</span> Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlistToDigit</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span> <span class="main">=</span> Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlistToDigit</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">]</span> <span class="main">=</span> Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">digitToNlist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToNlist</span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToNlist</span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> "</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToNlist</span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">digitToNlist</span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary function to unwrap a Node element›</span></span> 
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">n_unwrap</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">n_unwrap</span> <span class="main">(</span>Tip <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">n_unwrap</span> <span class="main">(</span>Node2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">n_unwrap</span> <span class="main">(</span>Node3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> ViewnRes <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc<span class="main">)</span> option"</span></span>
<span class="keyword1" id="FingerTree-viewnres_cases"><span class="command">lemma</span></span> viewnres_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> ViewnRes"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>Nil<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">=</span>None"</span></span> <span class="main">|</span>
          <span class="main">(</span>Cons<span class="main">)</span> <span class="free">a</span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">=</span>Some <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="FingerTree-viewnres_split"><span class="command">lemma</span></span> viewnres_split<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>case_option <span class="free">f1</span> <span class="main">(</span>case_prod <span class="free">f2</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">=</span> None <span class="main">⟶</span> <span class="free">P</span> <span class="free">f1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">f2</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Detach the leftmost node. Return <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span> on empty finger tree.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">viewLn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> ViewnRes"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">viewLn</span> Empty <span class="main">=</span> None"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viewLn</span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Empty<span class="main">)</span>"</span></span><span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">viewLn</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span>deep <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viewLn</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span>deep <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viewLn</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span>deep <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viewLn</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">viewLn</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span>digitToTree <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
      Some <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">m2</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span>deep <span class="main">(</span>nodeToDigit <span class="bound">b</span><span class="main">)</span> <span class="bound">m2</span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Detach the rightmost node. Return <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span> on empty finger tree.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">viewRn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> ViewnRes"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">viewRn</span> Empty <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viewRn</span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Empty<span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">viewRn</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="main">(</span>deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viewRn</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">(</span>deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viewRn</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> <span class="main">(</span>deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viewRn</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">viewRn</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span>digitToTree <span class="free"><span class="bound"><span class="entity">pr</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">|</span>
      Some <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">m2</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span>deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="bound">m2</span> <span class="main">(</span>nodeToDigit <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* TODO: Head, last geht auch in O(1) !!! *)</span>

<span class="keyword1" id="FingerTree-digitToTree_inv"><span class="command">lemma</span></span> 
  digitToTree_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">d</span> <span class="main">⟹</span> is_leveln_ftree <span class="free">n</span> <span class="main">(</span>digitToTree <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_measured_digit <span class="free">d</span> <span class="main">⟹</span> is_measured_ftree <span class="main">(</span>digitToTree <span class="free">d</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="FingerTree-digitToTree_list"><span class="command">lemma</span></span> digitToTree_list<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>digitToTree <span class="free">d</span><span class="main">)</span> <span class="main">=</span> digitToList <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-nodeToDigit_inv"><span class="command">lemma</span></span> nodeToDigit_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_leveln_node <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">nd</span> <span class="main">⟹</span> is_leveln_digit <span class="free">n</span> <span class="main">(</span>nodeToDigit <span class="free">nd</span><span class="main">)</span> "</span></span> 
  <span class="quoted"><span class="quoted">"is_measured_node <span class="free">nd</span> <span class="main">⟹</span> is_measured_digit <span class="main">(</span>nodeToDigit <span class="free">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">nd</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">nd</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="FingerTree-nodeToDigit_list"><span class="command">lemma</span></span> nodeToDigit_list<span class="main">:</span> <span class="quoted"><span class="quoted">"digitToList <span class="main">(</span>nodeToDigit <span class="free">nd</span><span class="main">)</span> <span class="main">=</span> nodeToList <span class="free">nd</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">nd</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1" id="FingerTree-viewLn_empty"><span class="command">lemma</span></span> viewLn_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty <span class="main">⟷</span> <span class="main">(</span>viewLn <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Single <span class="skolem">Node</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deep <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viewLn <span class="skolem">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-viewLn_inv"><span class="command">lemma</span></span> viewLn_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  is_measured_ftree <span class="free">t</span><span class="main">;</span> is_leveln_ftree <span class="free">n</span> <span class="free">t</span><span class="main">;</span> viewLn <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">nd</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> is_measured_ftree <span class="free">s</span> <span class="main">∧</span> is_measured_node <span class="free">nd</span> <span class="main">∧</span> 
        is_leveln_ftree <span class="free">n</span> <span class="free">s</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="free">nd</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> viewLn.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewLn_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ux</span> <span class="skolem">a</span> <span class="skolem">m</span> <span class="skolem">sf</span> <span class="skolem">n</span> <span class="skolem">nd</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> av<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">nd</span> <span class="bound">s</span><span class="main">.</span>
           <span class="main">⟦</span>is_measured_ftree <span class="skolem">m</span><span class="main">;</span> is_leveln_ftree <span class="bound">n</span> <span class="skolem">m</span><span class="main">;</span> viewLn <span class="skolem">m</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">nd</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span>
           <span class="main">⟹</span> is_measured_ftree <span class="bound">s</span> <span class="main">∧</span>
              is_measured_node <span class="bound">nd</span> <span class="main">∧</span> is_leveln_ftree <span class="bound">n</span> <span class="bound">s</span> <span class="main">∧</span> is_leveln_node <span class="bound">n</span> <span class="bound">nd</span> "</span></span>
         <span class="quoted"><span class="quoted">" is_measured_ftree <span class="main">(</span>Deep <span class="skolem">ux</span> <span class="main">(</span>One <span class="skolem">a</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">sf</span><span class="main">)</span> "</span></span>
         <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="main">(</span>Deep <span class="skolem">ux</span> <span class="main">(</span>One <span class="skolem">a</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">sf</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"viewLn <span class="main">(</span>Deep <span class="skolem">ux</span> <span class="main">(</span>One <span class="skolem">a</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">sf</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">nd</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">s</span> <span class="main">∧</span>
          is_measured_node <span class="skolem">nd</span> <span class="main">∧</span> is_leveln_ftree <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viewLn <span class="skolem">m</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> viewnres_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> av<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> digitToTree <span class="skolem">sf</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> v1 av<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">s</span> <span class="main">∧</span>
       is_measured_node <span class="skolem">nd</span> <span class="main">∧</span> is_leveln_ftree <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToTree_inv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">m2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> av<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>deep <span class="main">(</span>nodeToDigit <span class="skolem">b</span><span class="main">)</span> <span class="skolem">m2</span> <span class="skolem">sf</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">note</span></span> myiv <span class="main">=</span> av<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">m2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> v2 av<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m</span> <span class="main">∧</span> is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> bv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m2</span> <span class="main">∧</span>
   is_measured_node <span class="skolem">b</span> <span class="main">∧</span> is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m2</span> <span class="main">∧</span> is_leveln_node <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> myiv Cons
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> av<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> v2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">s</span> <span class="main">∧</span>
          is_measured_node <span class="skolem">nd</span> <span class="main">∧</span> is_leveln_ftree <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def nodeToDigit_inv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-viewLn_list"><span class="command">lemma</span></span> viewLn_list<span class="main">:</span> <span class="quoted"><span class="quoted">" viewLn <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">nd</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> 
  <span class="main">⟹</span> toList <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>nodeToList <span class="free">nd</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> viewLn.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> a m sf nd s
    <span class="keyword1"><span class="command">using</span></span> prems
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viewLn <span class="skolem">m</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> viewnres_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">hence</span></span> av<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> viewLn_empty<span class="main">)</span>  
    <span class="keyword1"><span class="command">from</span></span> av prems
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nodeToList <span class="skolem">a</span> <span class="main">@</span> toList <span class="skolem">m</span> <span class="main">@</span> digitToList <span class="skolem">sf</span> <span class="main">=</span> nodeToList <span class="skolem">nd</span> <span class="main">@</span> toList <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToTree_list<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>        
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">m2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> bv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>deep <span class="main">(</span>nodeToDigit <span class="skolem">b</span><span class="main">)</span> <span class="skolem">m2</span> <span class="skolem">sf</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons prems
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nodeToList <span class="skolem">a</span> <span class="main">@</span> toList <span class="skolem">m</span> <span class="main">@</span> digitToList <span class="skolem">sf</span> <span class="main">=</span> nodeToList <span class="skolem">nd</span> <span class="main">@</span> toList <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def nodeToDigit_list<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="FingerTree-viewRn_empty"><span class="command">lemma</span></span> viewRn_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty <span class="main">⟷</span> <span class="main">(</span>viewRn <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Single <span class="skolem">Node</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deep <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viewRn <span class="skolem">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-viewRn_inv"><span class="command">lemma</span></span> viewRn_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  is_measured_ftree <span class="free">t</span><span class="main">;</span> is_leveln_ftree <span class="free">n</span> <span class="free">t</span><span class="main">;</span> viewRn <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">nd</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> is_measured_ftree <span class="free">s</span> <span class="main">∧</span> is_measured_node <span class="free">nd</span> <span class="main">∧</span> 
       is_leveln_ftree <span class="free">n</span> <span class="free">s</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="free">nd</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> viewRn.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewRn_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ux</span> <span class="skolem">a</span> <span class="skolem">m</span> <span class="quoted">"<span class="skolem">pr</span>"</span> <span class="skolem">n</span> <span class="skolem">nd</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> av<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">nd</span> <span class="bound">s</span><span class="main">.</span>
           <span class="main">⟦</span>is_measured_ftree <span class="skolem">m</span><span class="main">;</span> is_leveln_ftree <span class="bound">n</span> <span class="skolem">m</span><span class="main">;</span> viewRn <span class="skolem">m</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">nd</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span>
           <span class="main">⟹</span> is_measured_ftree <span class="bound">s</span> <span class="main">∧</span>
              is_measured_node <span class="bound">nd</span> <span class="main">∧</span> is_leveln_ftree <span class="bound">n</span> <span class="bound">s</span> <span class="main">∧</span> is_leveln_node <span class="bound">n</span> <span class="bound">nd</span> "</span></span>
         <span class="quoted"><span class="quoted">" is_measured_ftree <span class="main">(</span>Deep <span class="skolem">ux</span> <span class="skolem">pr</span> <span class="skolem">m</span> <span class="main">(</span>One <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> "</span></span>
         <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="main">(</span>Deep <span class="skolem">ux</span> <span class="skolem">pr</span> <span class="skolem">m</span> <span class="main">(</span>One <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"viewRn <span class="main">(</span>Deep <span class="skolem">ux</span> <span class="skolem">pr</span> <span class="skolem">m</span> <span class="main">(</span>One <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">nd</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">s</span> <span class="main">∧</span>
          is_measured_node <span class="skolem">nd</span> <span class="main">∧</span> is_leveln_ftree <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viewRn <span class="skolem">m</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> viewnres_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> av<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> digitToTree <span class="skolem">pr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> v1 av<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">s</span> <span class="main">∧</span>
       is_measured_node <span class="skolem">nd</span> <span class="main">∧</span> is_leveln_ftree <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToTree_inv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">m2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> av<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>deep <span class="skolem">pr</span> <span class="skolem">m2</span> <span class="main">(</span>nodeToDigit <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">note</span></span> myiv <span class="main">=</span> av<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">m2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> v2 av<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m</span> <span class="main">∧</span> is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> bv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m2</span> <span class="main">∧</span>
   is_measured_node <span class="skolem">b</span> <span class="main">∧</span> is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m2</span> <span class="main">∧</span> is_leveln_node <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> myiv Cons
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> av<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> v2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">s</span> <span class="main">∧</span>
          is_measured_node <span class="skolem">nd</span> <span class="main">∧</span> is_leveln_ftree <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def nodeToDigit_inv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-viewRn_list"><span class="command">lemma</span></span> viewRn_list<span class="main">:</span> <span class="quoted"><span class="quoted">"viewRn <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">nd</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> 
  <span class="main">⟹</span> toList <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">s</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> viewRn.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> pr m a nd s
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viewRn <span class="skolem">m</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> viewnres_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">from</span></span> Nil <span class="keyword1"><span class="command">have</span></span> av<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> viewRn_empty<span class="main">)</span>  
    <span class="keyword1"><span class="command">from</span></span> av prems
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"digitToList <span class="skolem">pr</span> <span class="main">@</span> toList <span class="skolem">m</span> <span class="main">@</span> nodeToList <span class="skolem">a</span> <span class="main">=</span> toList <span class="skolem">s</span> <span class="main">@</span> nodeToList <span class="skolem">nd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToTree_list<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>        
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">m2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> bv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>deep <span class="skolem">pr</span> <span class="skolem">m2</span> <span class="main">(</span>nodeToDigit <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons prems
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"digitToList <span class="skolem">pr</span> <span class="main">@</span> toList <span class="skolem">m</span> <span class="main">@</span> nodeToList <span class="skolem">a</span> <span class="main">=</span> toList <span class="skolem">s</span> <span class="main">@</span> nodeToList <span class="skolem">nd</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def nodeToDigit_list<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> viewres <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc<span class="main">)</span> option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Detach the leftmost element. Return <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span> on empty finger tree.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">viewL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> viewres"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">"<span class="free">viewL</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> viewLn <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> 
  None <span class="main">⇒</span> None <span class="main">|</span>
  <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span>n_unwrap <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-viewL_correct"><span class="command">lemma</span></span> viewL_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">=</span>Empty <span class="main">⟹</span> viewL <span class="free">t</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">≠</span>Empty <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> viewL <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> ft_invar <span class="bound">s</span> 
                        <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">#</span> toList <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span>Empty"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"viewL <span class="free">t</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewL_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty"</span></span>
  <span class="keyword1"><span class="command">from</span></span> INV <span class="keyword1"><span class="command">have</span></span> INV'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">0</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ft_invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> NE <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"viewLn <span class="free">t</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewLn_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> vn<span class="main">:</span> <span class="quoted"><span class="quoted">"viewLn <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">nd</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viewLn <span class="free">t</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"viewL <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewL_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> INV' vn <span class="keyword1"><span class="command">have</span></span> 
    v2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">s</span> <span class="main">∧</span> is_leveln_ftree <span class="main">0</span> <span class="skolem">s</span> 
         <span class="main">∧</span> is_leveln_node <span class="main">0</span> <span class="skolem">nd</span> <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
        <span class="quoted"><span class="quoted">"toList <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>nodeToList <span class="skolem">nd</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewLn_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">nd</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span> viewLn_list<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v1 vn <span class="keyword1"><span class="command">have</span></span> v3<span class="main">:</span> <span class="quoted"><span class="quoted">"nodeToList <span class="skolem">nd</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewL_def <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">nd</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> v1 v2
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> viewL <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> ft_invar <span class="bound">s</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">#</span> toList <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ft_invar_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-viewL_correct_empty"><span class="command">lemma</span></span> viewL_correct_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"viewL Empty <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewL_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-viewL_correct_nonEmpty"><span class="command">lemma</span></span> viewL_correct_nonEmpty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"viewL <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"toList <span class="free">t</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> toList <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms viewL_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Detach the rightmost element. Return <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span> on empty finger tree.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">viewR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> viewres"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">viewR</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> viewRn <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> 
    None <span class="main">⇒</span> None <span class="main">|</span>
    <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span>n_unwrap <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-viewR_correct"><span class="command">lemma</span></span> viewR_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">=</span> Empty <span class="main">⟹</span> viewR <span class="free">t</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">≠</span> Empty <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> viewR <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> ft_invar <span class="bound">s</span> 
                          <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> toList <span class="bound">s</span> <span class="main">@</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span>Empty"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"viewR <span class="free">t</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewR_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty"</span></span>
  <span class="keyword1"><span class="command">from</span></span> INV <span class="keyword1"><span class="command">have</span></span> INV'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">0</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> ft_invar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> NE <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"viewRn <span class="free">t</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewRn_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> vn<span class="main">:</span> <span class="quoted"><span class="quoted">"viewRn <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">nd</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viewRn <span class="free">t</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"viewR <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewR_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> INV' vn <span class="keyword1"><span class="command">have</span></span> 
    v2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">s</span> <span class="main">∧</span> is_leveln_ftree <span class="main">0</span> <span class="skolem">s</span> 
         <span class="main">∧</span> is_leveln_node <span class="main">0</span> <span class="skolem">nd</span> <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
        <span class="quoted"><span class="quoted">"toList <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>toList <span class="skolem">s</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="skolem">nd</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewRn_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">nd</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span> viewRn_list<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v1 vn <span class="keyword1"><span class="command">have</span></span> v3<span class="main">:</span> <span class="quoted"><span class="quoted">"nodeToList <span class="skolem">nd</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewR_def <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">nd</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> v1 v2
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> viewR <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> ft_invar <span class="bound">s</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> toList <span class="bound">s</span> <span class="main">@</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ft_invar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="FingerTree-viewR_correct_empty"><span class="command">lemma</span></span> viewR_correct_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"viewR Empty <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> viewR_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FingerTree-viewR_correct_nonEmpty"><span class="command">lemma</span></span> viewR_correct_nonEmpty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"viewR <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">s</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> toList <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms viewR_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finger trees viewed as a double-ended queue. The head and tail functions
  here are only
  defined for non-empty queues, while the view-functions were also defined for
  empty finger trees.›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Check for emptiness"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isEmpty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">isEmpty</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Empty<span class="main">)</span>"</span></span>
<span class="keyword1" id="FingerTree-isEmpty_correct"><span class="command">lemma</span></span> isEmpty_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"isEmpty <span class="free">t</span> <span class="main">⟷</span> toList <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isEmpty_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_empty<span class="main">)</span>
<span class="comment1">― ‹Avoid comparison with <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"(=)"</span><span class="antiquote">}</span></span>, and thus unnecessary equality-class
    parameter on element types in generated code›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isEmpty <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isEmpty_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Leftmost element"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">head</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">head</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> viewL <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="FingerTree-head_correct"><span class="command">lemma</span></span> head_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"head <span class="free">t</span> <span class="main">=</span> hd <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms viewL_correct 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    v1<span class="main">:</span><span class="quoted"><span class="quoted">"viewL <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> ft_invar <span class="skolem">s</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> toList <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">t</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> head_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> v2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"All but the leftmost element"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tail</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tail</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> viewL <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="FingerTree-tail_correct"><span class="command">lemma</span></span> tail_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>tail <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span>tail <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms viewL_correct 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    v1<span class="main">:</span><span class="quoted"><span class="quoted">"viewL <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> ft_invar <span class="skolem">s</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> toList <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"tail <span class="free">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span> <span class="main">=</span> toList <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> v1 v2 <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"toList <span class="main">(</span>tail <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span>tail <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Rightmost element"</span></span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">headR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">headR</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> viewR <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="FingerTree-headR_correct"><span class="command">lemma</span></span> headR_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"headR <span class="free">t</span> <span class="main">=</span> last <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms viewR_correct 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    v1<span class="main">:</span><span class="quoted"><span class="quoted">"viewR <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> ft_invar <span class="skolem">s</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> toList <span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"headR <span class="free">t</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> headR_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"All but the rightmost element"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tailR</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tailR</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> viewR <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="FingerTree-tailR_correct"><span class="command">lemma</span></span> tailR_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>tailR <span class="free">t</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span>tailR <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms viewR_correct 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    v1<span class="main">:</span><span class="quoted"><span class="quoted">"viewR <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> ft_invar <span class="skolem">s</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> toList <span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"tailR <span class="free">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tailR_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>tailR <span class="free">t</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span>tailR <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Concatenation›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lconsNlist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node list 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lconsNlist</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lconsNlist</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> nlcons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">lconsNlist</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rconsNlist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rconsNlist</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[]</span>  <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rconsNlist</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="free">rconsNlist</span> <span class="main">(</span>nrcons <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node list  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span>node2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span>node3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span>node2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> node2 <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>node3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">nodes</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Recursively we concatenate two FingerTreeStrucs while we keep the 
  inner Nodes in a list›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">app3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">app3</span> Empty <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> lconsNlist <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">app3</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> Empty <span class="main">=</span> rconsNlist <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">app3</span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> nlcons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lconsNlist <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">app3</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> nrcons <span class="main">(</span>rconsNlist <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">app3</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr1</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">sf1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr2</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">sf2</span></span></span><span class="main">)</span> <span class="main">=</span>
    deep <span class="free"><span class="bound"><span class="entity">pr1</span></span></span> <span class="main">(</span><span class="free">app3</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> 
      <span class="main">(</span>nodes <span class="main">(</span><span class="main">(</span>digitToNlist <span class="free"><span class="bound"><span class="entity">sf1</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">@</span> <span class="main">(</span>digitToNlist <span class="free"><span class="bound"><span class="entity">pr2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sf2</span></span></span>"</span></span>

<span class="keyword1" id="FingerTree-lconsNlist_inv"><span class="command">lemma</span></span> lconsNlist_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span>is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="main">(</span>lconsNlist <span class="free">xs</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> is_measured_ftree <span class="main">(</span>lconsNlist <span class="free">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlcons_invlevel nlcons_invmeas<span class="main">)</span>

<span class="keyword1" id="FingerTree-rconsNlist_inv"><span class="command">lemma</span></span> rconsNlist_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span>is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="main">(</span>rconsNlist <span class="free">t</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> is_measured_ftree <span class="main">(</span>rconsNlist <span class="free">t</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nrcons_invlevel nrcons_invmeas<span class="main">)</span>

<span class="keyword1" id="FingerTree-nodes_inv"><span class="command">lemma</span></span> nodes_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>nodes <span class="free">ts</span><span class="main">)</span><span class="main">.</span> is_leveln_node <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nodes.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node2_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node3_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node2_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">v</span> <span class="skolem">vb</span> <span class="skolem">vc</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node3_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">[]</span><span class="main">.</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span><span class="main">;</span> <span class="numeral">2</span> <span class="main">≤</span> length <span class="main">[]</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>nodes <span class="main">[]</span><span class="main">)</span><span class="main">.</span> is_leveln_node <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span>  <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">⟦</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">[</span><span class="bound">v</span><span class="main">]</span><span class="main">.</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span><span class="main">;</span> <span class="numeral">2</span> <span class="main">≤</span> length <span class="main">[</span><span class="bound">v</span><span class="main">]</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>nodes <span class="main">[</span><span class="bound">v</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> is_leveln_node <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-nodes_inv2"><span class="command">lemma</span></span> nodes_inv2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">sf1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="free">sf1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">pr2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="free">pr2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>nodes <span class="main">(</span>digitToNlist <span class="free">sf1</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">@</span> digitToNlist <span class="free">pr2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                is_leveln_node <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>digitToNlist <span class="free">sf1</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">@</span> digitToNlist <span class="free">pr2</span><span class="main">)</span><span class="main">.</span> 
                 is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToNlist_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sf1</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>digitToNlist <span class="free">sf1</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">@</span> digitToNlist <span class="free">pr2</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sf1</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> v1 nodes_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"digitToNlist <span class="free">sf1</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">@</span> digitToNlist <span class="free">pr2</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-app3_inv"><span class="command">lemma</span></span> app3_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span>is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="main">(</span>app3 <span class="free">t1</span> <span class="free">xs</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∧</span> is_measured_ftree <span class="main">(</span>app3 <span class="free">t1</span> <span class="free">xs</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> app3.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span> <span class="skolem">t</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lconsNlist_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_1"</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rconsNlist_inv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_2"</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconsNlist_inv rconsNlist_inv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_1"</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconsNlist_inv nlcons_invlevel nlcons_invmeas <span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_2"</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> app3.simps<span class="main">)</span> 
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconsNlist_inv nlcons_invlevel nlcons_invmeas<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> app3.simps<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rconsNlist_inv nrcons_invlevel nrcons_invmeas<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">uu</span> <span class="skolem">pr1</span> <span class="skolem">m1</span> <span class="skolem">sf1</span> <span class="skolem">ts</span> <span class="skolem">uv</span> <span class="skolem">pr2</span> <span class="skolem">m2</span> <span class="skolem">sf2</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m1</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leveln_ftree_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> v3<span class="main">:</span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m1</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> v4<span class="main">:</span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_measured_ftree_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> v5<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">sf1</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">sf1</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">pr2</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">pr2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span> <span class="main">∧</span> is_measured_node <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leveln_ftree_def is_measured_ftree_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> v6 <span class="main">=</span> nodes_inv2<span class="main">[</span><span class="operator">OF</span> v5<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> v7 <span class="main">=</span> <span class="quoted">"5.hyps"</span><span class="main">[</span><span class="operator">OF</span> v1 v2 v3 v4 v6<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> v8<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">sf2</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">sf2</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">pr1</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">pr1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leveln_ftree_def is_measured_ftree_def<span class="main">)</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> v7 v8
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leveln_ftree_def is_measured_ftree_def deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nlistToList</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> Node<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nlistToList</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nlistToList</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nodeToList <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">nlistToList</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-nodes_list"><span class="command">lemma</span></span> nodes_list<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> nlistToList <span class="main">(</span>nodes <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> nlistToList <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nodes.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node2_def node3_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-nlistToList_app"><span class="command">lemma</span></span> nlistToList_app<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nlistToList <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nlistToList <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nlistToList <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="FingerTree-nlistListLCons"><span class="command">lemma</span></span> nlistListLCons<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>lconsNlist <span class="free">xs</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nlistToList <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlcons_list<span class="main">)</span>
 
<span class="keyword1" id="FingerTree-nlistListRCons"><span class="command">lemma</span></span> nlistListRCons<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>rconsNlist <span class="free">t</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nlistToList <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nrcons_list<span class="main">)</span>

<span class="keyword1" id="FingerTree-app3_list_lem1"><span class="command">lemma</span></span> app3_list_lem1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nlistToList <span class="main">(</span>nodes <span class="main">(</span>digitToNlist <span class="free">sf1</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">@</span> digitToNlist <span class="free">pr2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       digitToList <span class="free">sf1</span> <span class="main">@</span> nlistToList <span class="free">ts</span> <span class="main">@</span> digitToList <span class="free">pr2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>digitToNlist <span class="free">sf1</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">@</span> digitToNlist <span class="free">pr2</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sf1</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp_all</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nlistToList <span class="main">(</span>digitToNlist <span class="free">sf1</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">@</span> digitToNlist <span class="free">pr2</span><span class="main">)</span><span class="main">)</span> 
       <span class="main">=</span> <span class="main">(</span>digitToList <span class="free">sf1</span> <span class="main">@</span> nlistToList <span class="free">ts</span> <span class="main">@</span> digitToList <span class="free">pr2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sf1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToList_app<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pr2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> nodes_list<span class="main">[</span><span class="operator">OF</span> len1<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="FingerTree-app3_list"><span class="command">lemma</span></span> app3_list<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>app3 <span class="free">t1</span> <span class="free">xs</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">t1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nlistToList <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> app3.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistListLCons nlistListRCons nlcons_list nrcons_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app3_list_lem1 deep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">app</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc 
       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> app3 <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1" id="FingerTree-app_correct"><span class="command">lemma</span></span> app_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">t2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>app <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">t1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="free">t2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span>app <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app3_inv app3_list ft_invar_def app_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-app_inv"><span class="command">lemma</span></span> app_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ft_invar <span class="free">t1</span><span class="main">;</span>ft_invar <span class="free">t2</span><span class="main">⟧</span> <span class="main">⟹</span> ft_invar <span class="main">(</span>app <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app3_inv ft_invar_def app_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-app_list"><span class="command">lemma</span></span> app_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>app <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">t1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app3_list app_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Splitting"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> SplitDigit <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list  <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> SplitTree  <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary functions to create a correct finger tree 
    even if the left or right digit is empty›</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deepL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deepL</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>viewLn <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> digitToTree <span class="free"><span class="bound"><span class="entity">sf</span></span></span> <span class="main">|</span>
                                 <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> deep <span class="main">(</span>nodeToDigit <span class="bound">a</span><span class="main">)</span> <span class="bound">m2</span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">deepL</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span> <span class="main">=</span> deep <span class="main">(</span>nlistToDigit <span class="free"><span class="bound"><span class="entity">pr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deepR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Digit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deepR</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>viewRn <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> digitToTree <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="main">|</span>
                                 <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="bound">m2</span> <span class="main">(</span>nodeToDigit <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">deepR</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span> <span class="main">=</span> deep <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>nlistToDigit <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Splitting a list of nodes›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">splitNlist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>monoid_add <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node list 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> SplitDigit"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">splitNlist</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>   <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">splitNlist</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i2</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> gmn <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i2</span><span class="main">)</span> 
        <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> 
        <span class="keyword1">else</span> 
         <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">splitNlist</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i2</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="bound">l</span><span class="main">)</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Splitting a digit by converting it into a list of nodes›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">splitDigit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>monoid_add <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> SplitDigit"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">splitDigit</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> splitNlist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>digitToNlist <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span> 

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Creating a finger tree from list of nodes›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nlistToTree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node list 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">nlistToTree</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> lconsNlist <span class="free"><span class="bound"><span class="entity">xs</span></span></span> Empty"</span></span>

    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Recursive splitting into a left and right tree and a center node›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nsplitTree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>monoid_add <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> SplitTree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nsplitTree</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> Empty <span class="main">=</span> <span class="main">(</span>Empty<span class="main">,</span> Tip undefined undefined<span class="main">,</span> Empty<span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Making the function total›</span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nsplitTree</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">ea</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Empty<span class="main">,</span><span class="free"><span class="bound"><span class="entity">ea</span></span></span><span class="main">,</span>Empty<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nsplitTree</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">let</span> 
       <span class="bound">vpr</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> gmd <span class="free"><span class="bound"><span class="entity">pr</span></span></span><span class="main">)</span><span class="main">;</span> 
       <span class="bound">vm</span> <span class="main">=</span> <span class="main">(</span><span class="bound">vpr</span> <span class="main">+</span> gmft <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> 
      <span class="keyword1">in</span> 
        <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">vpr</span><span class="main">)</span> <span class="keyword1">then</span> 
          <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>splitDigit <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
            <span class="main">(</span>nlistToTree <span class="bound">l</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span>deepL <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span><span class="main">)</span> 
        <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">vm</span><span class="main">)</span> <span class="keyword1">then</span> 
          <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">ml</span><span class="main">,</span><span class="bound">xs</span><span class="main">,</span><span class="bound">mr</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nsplitTree</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">vpr</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">;</span> 
            <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>splitDigit <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="bound">vpr</span> <span class="main">+</span> gmft <span class="bound">ml</span><span class="main">)</span> <span class="main">(</span>nodeToDigit <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
              <span class="main">(</span>deepR <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="bound">ml</span> <span class="bound">l</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span>deepL <span class="bound">r</span> <span class="bound">mr</span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> 
          <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>splitDigit <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">vm</span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
            <span class="main">(</span>deepR <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">l</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span>nlistToTree <span class="bound">r</span><span class="main">)</span><span class="main">)</span>    
      <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="FingerTree-nlistToTree_inv"><span class="command">lemma</span></span> nlistToTree_inv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">nl</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">⟹</span> is_measured_ftree <span class="main">(</span>nlistToTree <span class="free">nl</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">nl</span><span class="main">.</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">⟹</span> is_leveln_ftree <span class="free">n</span> <span class="main">(</span>nlistToTree <span class="free">nl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> nlistToTree_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">nl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlcons_invmeas<span class="main">)</span>
     <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">nl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlcons_invlevel<span class="main">)</span>

<span class="keyword1" id="FingerTree-nlistToTree_list"><span class="command">lemma</span></span> nlistToTree_list<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>nlistToTree <span class="free">nl</span><span class="main">)</span> <span class="main">=</span> nlistToList <span class="free">nl</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToTree_def nlistListLCons<span class="main">)</span>

<span class="keyword1" id="FingerTree-deepL_inv"><span class="command">lemma</span></span> deepL_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">∧</span> is_measured_ftree <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">sf</span> <span class="main">∧</span> is_measured_digit <span class="free">sf</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">pr</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">pr</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="main">(</span>deepL <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span> <span class="main">∧</span> is_measured_ftree <span class="main">(</span>deepL <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">pr</span>"</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">sf</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> deepL.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> viewnres_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToTree_inv deep_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">sf</span> <span class="skolem">Node</span> <span class="skolem">FingerTreeStruc</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m</span>"</span></span> 
         <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="skolem">sf</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">sf</span>"</span></span> 
         <span class="quoted"><span class="quoted">"viewLn <span class="skolem">m</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Node</span><span class="main">,</span> <span class="skolem">FingerTreeStruc</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="main">(</span>nodeToDigit <span class="skolem">Node</span><span class="main">)</span> 
        <span class="main">∧</span> is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">FingerTreeStruc</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewLn_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="skolem">Node</span></span> <span class="quoted"><span class="skolem">FingerTreeStruc</span></span><span class="main"><span class="main">]</span></span> nodeToDigit_inv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">sf</span> <span class="skolem">Node</span> <span class="skolem">FingerTreeStruc</span>
  <span class="keyword3"><span class="command">assume</span></span> assms1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m</span>"</span></span> 
    <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="skolem">sf</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">sf</span>"</span></span> 
    <span class="quoted"><span class="quoted">"viewLn <span class="skolem">m</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Node</span><span class="main">,</span> <span class="skolem">FingerTreeStruc</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="main">(</span>nodeToDigit <span class="skolem">Node</span><span class="main">)</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">FingerTreeStruc</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> viewLn_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="skolem">Node</span></span> <span class="quoted"><span class="skolem">FingerTreeStruc</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">Node</span> <span class="main">∧</span> is_leveln_node <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">Node</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewLn_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="skolem">Node</span></span> <span class="quoted"><span class="skolem">FingerTreeStruc</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="main">(</span>nodeToDigit <span class="skolem">Node</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToDigit_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">va</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">v</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="main">(</span><span class="skolem">v</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> Node<span class="main">)</span> <span class="main">∧</span>
    length  <span class="main">(</span><span class="skolem">va</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> Node list<span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">va</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> length <span class="skolem">va</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="main">(</span>nlistToDigit <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">va</span><span class="main">)</span><span class="main">)</span> 
       <span class="main">∧</span> is_measured_digit <span class="main">(</span>nlistToDigit <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">va</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">#</span><span class="skolem">va</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nlistToDigit.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*corollary deepL_inv':
  assumes "is_leveln_ftree (Suc n) m" "is_measured_ftree m"
  and "is_leveln_digit n sf" "is_measured_digit sf"
  and "∀ x ∈ set pr. (is_measured_node x ∧ is_leveln_node n x)" "length pr ≤ 4"
  shows  "is_leveln_ftree n (deepL pr m sf)" "is_measured_ftree (deepL pr m sf)"
  using assms deepL_inv by blast+
*)</span>
            
<span class="keyword1" id="FingerTree-nlistToDigit_list"><span class="command">lemma</span></span> nlistToDigit_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">∧</span> length <span class="free">xs</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digitToList<span class="main">(</span>nlistToDigit <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> nlistToList <span class="free">xs</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nlistToDigit.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="FingerTree-deepL_list"><span class="command">lemma</span></span> deepL_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">∧</span> is_measured_ftree <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">sf</span> <span class="main">∧</span> is_measured_digit <span class="free">sf</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">pr</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">pr</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>deepL <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span> <span class="main">=</span> nlistToList <span class="free">pr</span> <span class="main">@</span> toList <span class="free">m</span> <span class="main">@</span> digitToList <span class="free">sf</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">pr</span>"</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">sf</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> deepL.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">m</span> <span class="skolem">sf</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> viewnres_split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"viewLn <span class="skolem">m</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> viewLn_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"toList <span class="skolem">m</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>digitToTree <span class="skolem">sf</span><span class="main">)</span> <span class="main">=</span> toList <span class="skolem">m</span> <span class="main">@</span> digitToList <span class="skolem">sf</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>digitToTree_list<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"viewLn <span class="skolem">m</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">nd</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nodeToList <span class="skolem">nd</span> <span class="main">@</span> toList <span class="skolem">t</span> <span class="main">=</span> toList <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> viewLn_list<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"digitToList <span class="main">(</span>nodeToDigit <span class="skolem">nd</span><span class="main">)</span> <span class="main">@</span> toList <span class="skolem">t</span> <span class="main">=</span> toList <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToDigit_list<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">va</span> <span class="skolem">m</span> <span class="skolem">sf</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> deepL.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToDigit_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="FingerTree-deepR_inv"><span class="command">lemma</span></span> deepR_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">∧</span> is_measured_ftree <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">pr</span> <span class="main">∧</span> is_measured_digit <span class="free">pr</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">sf</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">sf</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="free">n</span> <span class="main">(</span>deepR <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span> <span class="main">∧</span> is_measured_ftree <span class="main">(</span>deepR <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">pr</span>"</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">sf</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> deepR.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> viewnres_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToTree_inv deep_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="quoted">"<span class="skolem">pr</span>"</span> <span class="skolem">Node</span> <span class="skolem">FingerTreeStruc</span>  
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m</span>"</span></span> 
         <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="skolem">pr</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">pr</span>"</span></span>
         <span class="quoted"><span class="quoted">"viewRn <span class="skolem">m</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Node</span><span class="main">,</span> <span class="skolem">FingerTreeStruc</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="main">(</span>nodeToDigit <span class="skolem">Node</span><span class="main">)</span> 
    <span class="main">∧</span> is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">FingerTreeStruc</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewRn_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="skolem">Node</span></span> <span class="quoted"><span class="skolem">FingerTreeStruc</span></span><span class="main"><span class="main">]</span></span> nodeToDigit_inv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="quoted">"<span class="skolem">pr</span>"</span> <span class="skolem">Node</span> <span class="skolem">FingerTreeStruc</span>
  <span class="keyword3"><span class="command">assume</span></span> assms1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m</span>"</span></span> 
    <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="skolem">pr</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">pr</span>"</span></span> 
    <span class="quoted"><span class="quoted">"viewRn <span class="skolem">m</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Node</span><span class="main">,</span> <span class="skolem">FingerTreeStruc</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">FingerTreeStruc</span> <span class="main">∧</span> is_measured_digit <span class="main">(</span>nodeToDigit <span class="skolem">Node</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> viewRn_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="skolem">Node</span></span> <span class="quoted"><span class="skolem">FingerTreeStruc</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">Node</span> <span class="main">∧</span> is_leveln_node <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">Node</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewRn_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="skolem">Node</span></span> <span class="quoted"><span class="skolem">FingerTreeStruc</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="main">(</span>nodeToDigit <span class="skolem">Node</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToDigit_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">va</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">v</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="main">(</span><span class="skolem">v</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> Node<span class="main">)</span> <span class="main">∧</span>
    length  <span class="main">(</span><span class="skolem">va</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> Node list<span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">va</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span> <span class="main">∧</span> length <span class="skolem">va</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="main">(</span>nlistToDigit <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">va</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
        is_measured_digit <span class="main">(</span>nlistToDigit <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">va</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">#</span><span class="skolem">va</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nlistToDigit.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
           

<span class="keyword1" id="FingerTree-deepR_list"><span class="command">lemma</span></span> deepR_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">∧</span> is_measured_ftree <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">pr</span> <span class="main">∧</span> is_measured_digit <span class="free">pr</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">sf</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">sf</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>deepR <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span> <span class="main">=</span> digitToList <span class="free">pr</span> <span class="main">@</span> toList <span class="free">m</span> <span class="main">@</span> nlistToList <span class="free">sf</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">pr</span>"</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">sf</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> deepR.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="quoted">"<span class="skolem">pr</span>"</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> viewnres_split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"viewRn <span class="skolem">m</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> viewRn_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"toList <span class="skolem">m</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>digitToTree <span class="skolem">pr</span><span class="main">)</span> <span class="main">=</span> digitToList <span class="skolem">pr</span> <span class="main">@</span> toList <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>digitToTree_list<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"viewRn <span class="skolem">m</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">nd</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> 
           <span class="quoted"><span class="quoted">"is_measured_ftree <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"toList <span class="skolem">t</span> <span class="main">@</span> nodeToList <span class="skolem">nd</span> <span class="main">=</span> toList <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> viewRn_list<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"toList <span class="skolem">t</span> <span class="main">@</span> digitToList <span class="main">(</span>nodeToDigit <span class="skolem">nd</span><span class="main">)</span> <span class="main">=</span> toList <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToDigit_list<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="quoted">"<span class="skolem">pr</span>"</span> <span class="skolem">m</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> deepR.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deep_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToDigit_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gmnl</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">gmnl</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">gmnl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> gmn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free">gmnl</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="FingerTree-gmnl_correct"><span class="command">lemma</span></span> gmnl_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> is_measured_node <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"gmnl <span class="free">xs</span> <span class="main">=</span> sum_list <span class="main">(</span>map snd <span class="main">(</span>nlistToList <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc gmn_correct<span class="main">)</span>

<span class="keyword1" id="FingerTree-splitNlist_correct"><span class="command">lemma</span></span> splitNlist_correct<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="main">⟦</span>
  <span class="main">⋀</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span><span class="main">;</span>
  <span class="main">¬</span> <span class="free">p</span> <span class="free">i</span><span class="main">;</span>
  <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> gmnl <span class="main">(</span><span class="free">nl</span> <span class="main">::</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Node list<span class="main">)</span><span class="main">)</span><span class="main">;</span>
  splitNlist <span class="free">p</span> <span class="free">i</span> <span class="free">nl</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span>  
  <span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmnl <span class="free">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmnl <span class="free">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free">n</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="free">nl</span> <span class="main">=</span> <span class="free">l</span> <span class="main">@</span> <span class="free">n</span> <span class="main">#</span> <span class="free">r</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">nl</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splitNlist.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">va</span> <span class="skolem">l</span> <span class="skolem">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IV <span class="main">=</span> this 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> IV <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> IV2 <span class="main">=</span> this IV  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        v1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splitNlist <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmn <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">va</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">n1</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splitNlist <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmn <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">va</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> miv <span class="main">=</span> IV2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmn <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">n1</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> v2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmn <span class="skolem">a</span> <span class="main">+</span> gmnl <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">va</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> IV2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> miv2 <span class="main">=</span>  miv<span class="main">[</span><span class="operator">OF</span> _ IV2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IV2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> IV2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>  v2 v1<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> IV2 v1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> miv2 <span class="keyword1"><span class="command">have</span></span> 
        v4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmn <span class="skolem">a</span> <span class="main">+</span> gmnl <span class="skolem">l1</span><span class="main">)</span> <span class="main">∧</span> 
             <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmn <span class="skolem">a</span> <span class="main">+</span> gmnl <span class="skolem">l1</span> <span class="main">+</span> gmn <span class="skolem">n1</span><span class="main">)</span> <span class="main">∧</span> 
             <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">va</span> <span class="main">=</span> <span class="skolem">l1</span> <span class="main">@</span> <span class="skolem">n1</span> <span class="main">#</span> <span class="skolem">r1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> v2 v3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-digitToNlist_inv"><span class="command">lemma</span></span> digitToNlist_inv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_measured_digit <span class="free">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>digitToNlist <span class="free">d</span><span class="main">)</span><span class="main">.</span> is_measured_node <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>digitToNlist <span class="free">d</span><span class="main">)</span><span class="main">.</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword1" id="FingerTree-gmnl_gmd"><span class="command">lemma</span></span> gmnl_gmd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_measured_digit <span class="free">d</span> <span class="main">⟹</span> gmnl <span class="main">(</span>digitToNlist <span class="free">d</span><span class="main">)</span> <span class="main">=</span> gmd <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
  
<span class="keyword1" id="FingerTree-gmn_gmd"><span class="command">lemma</span></span> gmn_gmd<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_measured_node <span class="free">nd</span> <span class="main">⟹</span> gmd <span class="main">(</span>nodeToDigit <span class="free">nd</span><span class="main">)</span> <span class="main">=</span> gmn <span class="free">nd</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToDigit_inv nodeToDigit_list gmn_correct gmd_correct<span class="main">)</span>

<span class="keyword1" id="FingerTree-splitDigit_inv"><span class="command">lemma</span></span> splitDigit_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  <span class="main">⋀</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span><span class="main">;</span>
  <span class="main">¬</span> <span class="free">p</span> <span class="free">i</span><span class="main">;</span>
  is_measured_digit <span class="free">d</span><span class="main">;</span>
  is_leveln_digit <span class="free">n</span> <span class="free">d</span><span class="main">;</span>
  <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> gmd <span class="main">(</span><span class="free">d</span> <span class="main">::</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> Digit<span class="main">)</span><span class="main">)</span><span class="main">;</span>
  splitDigit <span class="free">p</span> <span class="free">i</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">nd</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span>  
  <span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmnl <span class="free">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmnl <span class="free">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free">nd</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">r</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="main">(</span>is_measured_node <span class="free">nd</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="free">nd</span> <span class="main">)</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">d</span> <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">nd</span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"is_measured_digit <span class="skolem">d</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">nd</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmnl <span class="main">(</span>digitToNlist <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmnl_gmd<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> snc <span class="main">=</span> splitNlist_correct <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"digitToNlist <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">nd</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"splitNlist <span class="skolem">p</span> <span class="skolem">i</span> <span class="main">(</span>digitToNlist <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">nd</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitDigit_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> snc1 <span class="main">=</span> snc<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> v1 v2<span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmnl <span class="skolem">l</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmnl <span class="skolem">l</span> <span class="main">+</span> gmn <span class="skolem">nd</span><span class="main">)</span> <span class="main">∧</span> 
             digitToNlist <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">@</span> <span class="skolem">nd</span> <span class="main">#</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
    v4<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>digitToNlist <span class="skolem">d</span><span class="main">)</span><span class="main">.</span> is_measured_node <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">" <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>digitToNlist <span class="skolem">d</span><span class="main">)</span><span class="main">.</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToNlist_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v3 <span class="keyword1"><span class="command">have</span></span> v5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">l</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">r</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">nd</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> v3 v5 <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmnl <span class="skolem">l</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmnl <span class="skolem">l</span> <span class="main">+</span> gmn <span class="skolem">nd</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">r</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> 
    is_measured_node <span class="skolem">nd</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="FingerTree-splitDigit_inv'"><span class="command">lemma</span></span> splitDigit_inv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  splitDigit <span class="free">p</span> <span class="free">i</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">nd</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">;</span>
  is_measured_digit <span class="free">d</span><span class="main">;</span>
  is_leveln_digit <span class="free">n</span> <span class="free">d</span>
  <span class="main">⟧</span> <span class="main">⟹</span>  
  <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">r</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="main">(</span>is_measured_node <span class="free">nd</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="free">nd</span> <span class="main">)</span>
  "</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> splitDigit_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="FingerTree-splitDigit_list"><span class="command">lemma</span></span> splitDigit_list<span class="main">:</span> <span class="quoted"><span class="quoted">"splitDigit <span class="free">p</span> <span class="free">i</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span>digitToList <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nlistToList <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free">n</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nlistToList <span class="free">r</span><span class="main">)</span>
  <span class="main">∧</span> length <span class="free">l</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">∧</span> length <span class="free">r</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> splitDigit_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="FingerTree-gmnl_gmft"><span class="command">lemma</span></span> gmnl_gmft<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">nl</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">⟹</span> 
  gmft <span class="main">(</span>nlistToTree <span class="free">nl</span><span class="main">)</span> <span class="main">=</span> gmnl <span class="free">nl</span>"</span></span>  
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmnl_correct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">nl</span></span><span class="main"><span class="main">]</span></span> nlistToTree_list<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">nl</span></span><span class="main"><span class="main">]</span></span>  
                   nlistToTree_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nl</span></span></span></span><span class="main"><span class="main">]</span></span>  gmft_correct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nlistToTree <span class="free">nl</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="FingerTree-gmftR_gmnl"><span class="command">lemma</span></span> gmftR_gmnl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">∧</span> is_measured_ftree <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="free">n</span> <span class="free">pr</span> <span class="main">∧</span> is_measured_digit <span class="free">pr</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">sf</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="free">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">sf</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gmft <span class="main">(</span>deepR <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span> <span class="main">=</span> gmd <span class="free">pr</span> <span class="main">+</span> gmft <span class="free">m</span> <span class="main">+</span> gmnl <span class="free">sf</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 
    v1<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>deepR <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span> <span class="main">=</span> digitToList <span class="free">pr</span> <span class="main">@</span> toList <span class="free">m</span> <span class="main">@</span> nlistToList <span class="free">sf</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deepR_list<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms  <span class="keyword1"><span class="command">have</span></span> 
    v2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_measured_ftree <span class="main">(</span>deepR <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deepR_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v1 <span class="keyword1"><span class="command">have</span></span> 
    v3<span class="main">:</span> <span class="quoted"><span class="quoted">"gmft <span class="main">(</span>deepR <span class="free">pr</span> <span class="free">m</span> <span class="free">sf</span><span class="main">)</span> <span class="main">=</span> 
        sum_list <span class="main">(</span>map snd <span class="main">(</span>digitToList <span class="free">pr</span> <span class="main">@</span> toList <span class="free">m</span> <span class="main">@</span> nlistToList <span class="free">sf</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmft_correct<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 
    v4<span class="main">:</span><span class="quoted"><span class="quoted">"gmd <span class="free">pr</span> <span class="main">+</span> gmft <span class="free">m</span> <span class="main">+</span> gmnl <span class="free">sf</span> <span class="main">=</span> 
        sum_list <span class="main">(</span>map snd <span class="main">(</span>digitToList <span class="free">pr</span> <span class="main">@</span> toList <span class="free">m</span> <span class="main">@</span> nlistToList <span class="free">sf</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmd_correct gmft_correct gmnl_correct assms add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-nsplitTree_invpres"><span class="command">lemma</span></span> nsplitTree_invpres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  is_leveln_ftree <span class="free">n</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc<span class="main">)</span><span class="main">;</span>
  is_measured_ftree <span class="free">s</span><span class="main">;</span>  
  <span class="main">¬</span> <span class="free">p</span> <span class="free">i</span><span class="main">;</span> 
  <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmft <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span>nsplitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">nd</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">⟧</span> 
  <span class="main">⟹</span> 
  is_leveln_ftree <span class="free">n</span> <span class="free">l</span>
  <span class="main">∧</span>
  is_measured_ftree <span class="free">l</span>
  <span class="main">∧</span>
  is_leveln_ftree <span class="free">n</span> <span class="free">r</span>
  <span class="main">∧</span>
  is_measured_ftree <span class="free">r</span>
  <span class="main">∧</span>
  is_leveln_node <span class="free">n</span> <span class="free">nd</span>
  <span class="main">∧</span>
  is_measured_node <span class="free">nd</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nsplitTree.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">uu</span> <span class="quoted">"<span class="skolem">pr</span>"</span> <span class="skolem">m</span> <span class="skolem">sf</span> <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">nd</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        l1xr1<span class="main">:</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">pr</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">pr</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True 3 <span class="keyword1"><span class="command">have</span></span> 
        v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> nlistToTree <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> deepL <span class="skolem">r1</span> <span class="skolem">m</span> <span class="skolem">sf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> l1xr1 <span class="keyword1"><span class="command">have</span></span> 
        v2<span class="main">:</span> <span class="quoted"><span class="quoted">"digitToList <span class="skolem">pr</span> <span class="main">=</span> nlistToList <span class="skolem">l1</span> <span class="main">@</span> nodeToList <span class="skolem">x</span> <span class="main">@</span> nlistToList <span class="skolem">r1</span>"</span></span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">l1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitDigit_list<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
        pr_m_sf_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">pr</span> <span class="main">∧</span> is_measured_digit <span class="skolem">pr</span>"</span></span>
        <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">m</span>"</span></span>
        <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">sf</span> <span class="main">∧</span> is_measured_digit <span class="skolem">sf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> pr_m_sf_inv<span class="main">(</span>1<span class="main">)</span> True l1xr1  
        splitDigit_inv'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pr</span>"</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r1</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
        l1_x_r1_inv<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">l1</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">r1</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv v1 v2<span class="main">(</span>3<span class="main">)</span> pr_m_sf_inv <span class="keyword1"><span class="command">have</span></span>
        ziel3<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">l</span> <span class="main">∧</span>
        is_leveln_ftree <span class="skolem">n</span> <span class="skolem">r</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">r</span> <span class="main">∧</span> 
        is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span> <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToTree_inv deepL_inv<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> case1 <span class="main">=</span> this <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> case1 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          l1xr1<span class="main">:</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span><span class="main">)</span> <span class="skolem">sf</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span><span class="main">)</span> <span class="skolem">sf</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> case1 False 3 <span class="keyword1"><span class="command">have</span></span> 
          v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> deepR <span class="skolem">pr</span> <span class="skolem">m</span> <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> nlistToTree <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> l1xr1 <span class="keyword1"><span class="command">have</span></span> 
          v2<span class="main">:</span> <span class="quoted"><span class="quoted">"digitToList <span class="skolem">sf</span> <span class="main">=</span> nlistToList <span class="skolem">l1</span> <span class="main">@</span> nodeToList <span class="skolem">x</span> <span class="main">@</span> nlistToList <span class="skolem">r1</span>"</span></span>
          <span class="quoted"><span class="quoted">"length <span class="skolem">l1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitDigit_list<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
          pr_m_sf_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">pr</span> <span class="main">∧</span> is_measured_digit <span class="skolem">pr</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">m</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">sf</span> <span class="main">∧</span> is_measured_digit <span class="skolem">sf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> 
          v7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span> <span class="main">+</span> gmd <span class="skolem">sf</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> pr_m_sf_inv 3<span class="main">(</span>4<span class="main">)</span> pr_m_sf_inv<span class="main">(</span>3<span class="main">)</span> case1 False l1xr1  
             splitDigit_inv'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="skolem">sf</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r1</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> l1_x_r1_inv<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">l1</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">r1</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv v1 v2<span class="main">(</span>2<span class="main">)</span> pr_m_sf_inv <span class="keyword1"><span class="command">have</span></span>
          ziel3<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">l</span> <span class="main">∧</span>
          is_leveln_ftree <span class="skolem">n</span> <span class="skolem">r</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">r</span> <span class="main">∧</span> 
          is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span> <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToTree_inv deepR_inv<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> ziel3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> case1 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          l1_x_r1 <span class="main">:</span><span class="quoted"><span class="quoted">"nsplitTree <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nsplitTree <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span><span class="main">)</span> <span class="skolem">m</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
          pr_m_sf_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">pr</span> <span class="main">∧</span> is_measured_digit <span class="skolem">pr</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">m</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">sf</span> <span class="main">∧</span> is_measured_digit <span class="skolem">sf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">with</span></span> True case1 
          <span class="quoted">"3.hyps"</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span> 
          3<span class="main">(</span>6<span class="main">)</span> l1_x_r1 
        <span class="keyword1"><span class="command">have</span></span> l1_x_r1_inv<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">l1</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">l1</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">r1</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">r1</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_node <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> is_measured_node <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> l2_x2_r2<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span><span class="main">)</span> <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">,</span><span class="skolem">x2</span><span class="main">,</span><span class="skolem">r2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span><span class="main">)</span> <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv <span class="keyword1"><span class="command">have</span></span>
          ndx_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
          is_measured_digit <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToDigit_inv gmn_gmd<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> spdi <span class="main">=</span> splitDigit_inv'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span>"</span></span> 
                                      <span class="quoted"><span class="quoted">"nodeToDigit <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quoted"><span class="skolem">x2</span></span> <span class="quoted"><span class="skolem">r2</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> ndx_inv l1_x_r1_inv<span class="main">(</span>1<span class="main">)</span> l2_x2_r2 3<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
          l2_x2_r2_inv<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">l2</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">r2</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">x2</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">x2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spdi<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> spdl <span class="main">=</span>  splitDigit_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span>"</span></span> 
                                        <span class="quoted"><span class="quoted">"nodeToDigit <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quoted"><span class="skolem">x2</span></span> <span class="quoted"><span class="skolem">r2</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> l2_x2_r2 <span class="keyword1"><span class="command">have</span></span>
          l2_x2_r2_list<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"digitToList <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
            nlistToList <span class="skolem">l2</span> <span class="main">@</span> nodeToList <span class="skolem">x2</span> <span class="main">@</span> nlistToList <span class="skolem">r2</span>"</span></span>
          <span class="quoted"><span class="quoted">"length <span class="skolem">l2</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">∧</span> length <span class="skolem">r2</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spdl<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> case1 True 3<span class="main">(</span>6<span class="main">)</span> l1_x_r1 l2_x2_r2 <span class="keyword1"><span class="command">have</span></span> 
          l_nd_r<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> deepR <span class="skolem">pr</span> <span class="skolem">l1</span> <span class="skolem">l2</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">x2</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> deepL <span class="skolem">r2</span> <span class="skolem">r1</span> <span class="skolem">sf</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> dr1 <span class="main">=</span> deepR_inv<span class="main">[</span><span class="operator">OF</span> l1_x_r1_inv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pr_m_sf_inv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> dr1 l2_x2_r2_inv l2_x2_r2_list<span class="main">(</span>2<span class="main">)</span> l_nd_r <span class="keyword1"><span class="command">have</span></span> 
          l_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">note</span></span> dl1 <span class="main">=</span> deepL_inv<span class="main">[</span><span class="operator">OF</span> l1_x_r1_inv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pr_m_sf_inv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> dl1 l2_x2_r2_inv l2_x2_r2_list<span class="main">(</span>2<span class="main">)</span> l_nd_r <span class="keyword1"><span class="command">have</span></span> 
          r_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="skolem">r</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> l2_x2_r2_inv l_nd_r <span class="keyword1"><span class="command">have</span></span>
          nd_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span> <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> l_inv r_inv nd_inv
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-nsplitTree_correct"><span class="command">lemma</span></span> nsplitTree_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  is_leveln_ftree <span class="free">n</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc<span class="main">)</span><span class="main">;</span>
  is_measured_ftree <span class="free">s</span><span class="main">;</span>  
  <span class="main">⋀</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span><span class="main">;</span>
  <span class="main">¬</span> <span class="free">p</span> <span class="free">i</span><span class="main">;</span> 
  <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmft <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span>nsplitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">nd</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>toList <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="free">nd</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="free">r</span><span class="main">)</span> 
  <span class="main">∧</span>
  <span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmft <span class="free">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmft <span class="free">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="free">nd</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  is_leveln_ftree <span class="free">n</span> <span class="free">l</span>
  <span class="main">∧</span>
  is_measured_ftree <span class="free">l</span>
  <span class="main">∧</span>
  is_leveln_ftree <span class="free">n</span> <span class="free">r</span>
  <span class="main">∧</span>
  is_measured_ftree <span class="free">r</span>
  <span class="main">∧</span>
  is_leveln_node <span class="free">n</span> <span class="free">nd</span>
  <span class="main">∧</span>
  is_measured_node <span class="free">nd</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">nd</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nsplitTree.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">uu</span> <span class="quoted">"<span class="skolem">pr</span>"</span> <span class="skolem">m</span> <span class="skolem">sf</span> <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">nd</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        l1xr1<span class="main">:</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">pr</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">pr</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True 3<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
        v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> nlistToTree <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> deepL <span class="skolem">r1</span> <span class="skolem">m</span> <span class="skolem">sf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> l1xr1 <span class="keyword1"><span class="command">have</span></span> 
        v2<span class="main">:</span> <span class="quoted"><span class="quoted">"digitToList <span class="skolem">pr</span> <span class="main">=</span> nlistToList <span class="skolem">l1</span> <span class="main">@</span> nodeToList <span class="skolem">x</span> <span class="main">@</span> nlistToList <span class="skolem">r1</span>"</span></span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">l1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitDigit_list<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
        pr_m_sf_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">pr</span> <span class="main">∧</span> is_measured_digit <span class="skolem">pr</span>"</span></span>
        <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">m</span>"</span></span>
        <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">sf</span> <span class="main">∧</span> is_measured_digit <span class="skolem">sf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> pr_m_sf_inv<span class="main">(</span>1<span class="main">)</span> True l1xr1  
        splitDigit_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pr</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
        l1_x_r1_inv<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span>gmnl <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span>gmnl <span class="skolem">l1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">l1</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">r1</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> v2 v1 l1_x_r1_inv<span class="main">(</span>4<span class="main">)</span> pr_m_sf_inv <span class="keyword1"><span class="command">have</span></span>             
        ziel1<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>Deep <span class="skolem">uu</span> <span class="skolem">pr</span> <span class="skolem">m</span> <span class="skolem">sf</span><span class="main">)</span> <span class="main">=</span> toList <span class="skolem">l</span> <span class="main">@</span> nodeToList <span class="skolem">nd</span> <span class="main">@</span> toList <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToTree_list deepL_list<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv<span class="main">(</span>3<span class="main">)</span> v1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
        v3<span class="main">:</span> <span class="quoted"><span class="quoted">"gmft <span class="skolem">l</span> <span class="main">=</span> gmnl <span class="skolem">l1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmnl_gmft<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> l1_x_r1_inv<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> v1 <span class="keyword1"><span class="command">have</span></span>
        ziel2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmft <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmft <span class="skolem">l</span> <span class="main">+</span> gmn <span class="skolem">nd</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> v1 v2<span class="main">(</span>3<span class="main">)</span> pr_m_sf_inv <span class="keyword1"><span class="command">have</span></span>
        ziel3<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">l</span> <span class="main">∧</span>
        is_leveln_ftree <span class="skolem">n</span> <span class="skolem">r</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">r</span> <span class="main">∧</span> 
        is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span> <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToTree_inv deepL_inv<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ziel1 ziel2 ziel3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> case1 <span class="main">=</span> this <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> case1 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          l1xr1<span class="main">:</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span><span class="main">)</span> <span class="skolem">sf</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span><span class="main">)</span> <span class="skolem">sf</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> case1 False 3<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
          v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> deepR <span class="skolem">pr</span> <span class="skolem">m</span> <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> nlistToTree <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> l1xr1 <span class="keyword1"><span class="command">have</span></span> 
          v2<span class="main">:</span> <span class="quoted"><span class="quoted">"digitToList <span class="skolem">sf</span> <span class="main">=</span> nlistToList <span class="skolem">l1</span> <span class="main">@</span> nodeToList <span class="skolem">x</span> <span class="main">@</span> nlistToList <span class="skolem">r1</span>"</span></span>
          <span class="quoted"><span class="quoted">"length <span class="skolem">l1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitDigit_list<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
          pr_m_sf_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">pr</span> <span class="main">∧</span> is_measured_digit <span class="skolem">pr</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">m</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">sf</span> <span class="main">∧</span> is_measured_digit <span class="skolem">sf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
          v7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span> <span class="main">+</span> gmd <span class="skolem">sf</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> pr_m_sf_inv 3<span class="main">(</span>4<span class="main">)</span> pr_m_sf_inv<span class="main">(</span>3<span class="main">)</span> case1 False l1xr1  
             splitDigit_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="skolem">sf</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> l1_x_r1_inv<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span> <span class="main">+</span> gmnl <span class="skolem">l1</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span> <span class="main">+</span> gmnl <span class="skolem">l1</span> <span class="main">+</span> gmn <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">l1</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">r1</span><span class="main">.</span> <span class="main">(</span>is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> v2 v1 l1_x_r1_inv<span class="main">(</span>3<span class="main">)</span> pr_m_sf_inv <span class="keyword1"><span class="command">have</span></span>             
          ziel1<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>Deep <span class="skolem">uu</span> <span class="skolem">pr</span> <span class="skolem">m</span> <span class="skolem">sf</span><span class="main">)</span> <span class="main">=</span> toList <span class="skolem">l</span> <span class="main">@</span> nodeToList <span class="skolem">nd</span> <span class="main">@</span> toList <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToTree_list deepR_list<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv<span class="main">(</span>4<span class="main">)</span> v1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
          v3<span class="main">:</span> <span class="quoted"><span class="quoted">"gmft <span class="skolem">r</span> <span class="main">=</span> gmnl <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmnl_gmft<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> l1_x_r1_inv<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> pr_m_sf_inv v1 v2 <span class="keyword1"><span class="command">have</span></span>
          ziel2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmft <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmft <span class="skolem">l</span> <span class="main">+</span> gmn <span class="skolem">nd</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmftR_gmnl add.assoc<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> v1 v2<span class="main">(</span>2<span class="main">)</span> pr_m_sf_inv <span class="keyword1"><span class="command">have</span></span>
          ziel3<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">l</span> <span class="main">∧</span>
          is_leveln_ftree <span class="skolem">n</span> <span class="skolem">r</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">r</span> <span class="main">∧</span> 
          is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span> <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nlistToTree_inv deepR_inv<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> ziel1 ziel2 ziel3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> case1 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          l1_x_r1 <span class="main">:</span><span class="quoted"><span class="quoted">"nsplitTree <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nsplitTree <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span><span class="main">)</span> <span class="skolem">m</span>"</span></span><span class="main">)</span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
          pr_m_sf_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">pr</span> <span class="main">∧</span> is_measured_digit <span class="skolem">pr</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">m</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="skolem">sf</span> <span class="main">∧</span> is_measured_digit <span class="skolem">sf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">with</span></span> True case1 
          <span class="quoted">"3.hyps"</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span> 
          3<span class="main">(</span>4<span class="main">)</span> l1_x_r1 
        <span class="keyword1"><span class="command">have</span></span> l1_x_r1_inv<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span> <span class="main">+</span> gmn <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">l1</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">l1</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">r1</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">r1</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_leveln_node <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> is_measured_node <span class="skolem">x</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> l1_x_r1_list<span class="main">:</span>
          <span class="quoted"><span class="quoted">"toList <span class="skolem">m</span> <span class="main">=</span> toList <span class="skolem">l1</span> <span class="main">@</span> nodeToList <span class="skolem">x</span> <span class="main">@</span> toList <span class="skolem">r1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> l2_x2_r2<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span><span class="main">)</span> <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">,</span><span class="skolem">x2</span><span class="main">,</span><span class="skolem">r2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splitDigit <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span><span class="main">)</span> <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
          ndx_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_digit <span class="skolem">n</span> <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
          is_measured_digit <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span> <span class="main">+</span> gmd <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToDigit_inv gmn_gmd<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> spdi <span class="main">=</span> splitDigit_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span>"</span></span> 
                                      <span class="quoted"><span class="quoted">"nodeToDigit <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quoted"><span class="skolem">x2</span></span> <span class="quoted"><span class="skolem">r2</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> ndx_inv l1_x_r1_inv<span class="main">(</span>1<span class="main">)</span> l2_x2_r2 3<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
          l2_x2_r2_inv<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span> <span class="main">+</span> gmnl <span class="skolem">l2</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span> <span class="main">+</span> gmnl <span class="skolem">l2</span> <span class="main">+</span> gmn <span class="skolem">x2</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">l2</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">r2</span><span class="main">.</span> is_measured_node <span class="bound">x</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="bound">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_measured_node <span class="skolem">x2</span> <span class="main">∧</span> is_leveln_node <span class="skolem">n</span> <span class="skolem">x2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spdi<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> spdl <span class="main">=</span>  splitDigit_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> gmd <span class="skolem">pr</span> <span class="main">+</span> gmft <span class="skolem">l1</span>"</span></span> 
                                        <span class="quoted"><span class="quoted">"nodeToDigit <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quoted"><span class="skolem">x2</span></span> <span class="quoted"><span class="skolem">r2</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> l2_x2_r2 <span class="keyword1"><span class="command">have</span></span>
          l2_x2_r2_list<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"digitToList <span class="main">(</span>nodeToDigit <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
            nlistToList <span class="skolem">l2</span> <span class="main">@</span> nodeToList <span class="skolem">x2</span> <span class="main">@</span> nlistToList <span class="skolem">r2</span>"</span></span>
          <span class="quoted"><span class="quoted">"length <span class="skolem">l2</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">∧</span> length <span class="skolem">r2</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spdl<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> case1 True 3<span class="main">(</span>7<span class="main">)</span> l1_x_r1 l2_x2_r2 <span class="keyword1"><span class="command">have</span></span> 
          l_nd_r<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> deepR <span class="skolem">pr</span> <span class="skolem">l1</span> <span class="skolem">l2</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">x2</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> deepL <span class="skolem">r2</span> <span class="skolem">r1</span> <span class="skolem">sf</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> dr1 <span class="main">=</span> deepR_inv<span class="main">[</span><span class="operator">OF</span> l1_x_r1_inv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> pr_m_sf_inv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> dr1 l2_x2_r2_inv<span class="main">(</span>3<span class="main">)</span> l2_x2_r2_list<span class="main">(</span>2<span class="main">)</span> l_nd_r <span class="keyword1"><span class="command">have</span></span> 
          l_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">note</span></span> dl1 <span class="main">=</span> deepL_inv<span class="main">[</span><span class="operator">OF</span> l1_x_r1_inv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> pr_m_sf_inv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> dl1 l2_x2_r2_inv<span class="main">(</span>4<span class="main">)</span> l2_x2_r2_list<span class="main">(</span>2<span class="main">)</span> l_nd_r <span class="keyword1"><span class="command">have</span></span> 
          r_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="skolem">n</span> <span class="skolem">r</span> <span class="main">∧</span> is_measured_ftree <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> l2_x2_r2_inv l_nd_r <span class="keyword1"><span class="command">have</span></span>
          nd_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leveln_node <span class="skolem">n</span> <span class="skolem">nd</span> <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> l_nd_r<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> l2_x2_r2_inv<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> 
             l1_x_r1_inv<span class="main">(</span>3<span class="main">)</span> l2_x2_r2_list<span class="main">(</span>2<span class="main">)</span> pr_m_sf_inv<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> split_point<span class="main">:</span>
          <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmft <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> gmft <span class="skolem">l</span> <span class="main">+</span> gmn <span class="skolem">nd</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmftR_gmnl add.assoc<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> l2_x2_r2_list <span class="keyword1"><span class="command">have</span></span> x_list<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"nodeToList <span class="skolem">x</span> <span class="main">=</span> nlistToList <span class="skolem">l2</span> <span class="main">@</span> nodeToList <span class="skolem">x2</span> <span class="main">@</span> nlistToList <span class="skolem">r2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToDigit_list<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv<span class="main">(</span>3<span class="main">)</span> pr_m_sf_inv<span class="main">(</span>1<span class="main">)</span> 
             l2_x2_r2_inv<span class="main">(</span>3<span class="main">)</span> l2_x2_r2_list<span class="main">(</span>2<span class="main">)</span> l_nd_r<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> l_list<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="skolem">l</span> <span class="main">=</span> digitToList <span class="skolem">pr</span> <span class="main">@</span> toList <span class="skolem">l1</span> <span class="main">@</span> nlistToList <span class="skolem">l2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deepR_list<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> l1_x_r1_inv<span class="main">(</span>4<span class="main">)</span> pr_m_sf_inv<span class="main">(</span>3<span class="main">)</span> l2_x2_r2_inv<span class="main">(</span>4<span class="main">)</span> 
             l2_x2_r2_list<span class="main">(</span>2<span class="main">)</span> l_nd_r<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> r_list<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="skolem">r</span> <span class="main">=</span> nlistToList <span class="skolem">r2</span> <span class="main">@</span> toList <span class="skolem">r1</span> <span class="main">@</span> digitToList <span class="skolem">sf</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deepL_list<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> x_list l1_x_r1_list l_list r_list l_nd_r
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>Deep <span class="skolem">uu</span> <span class="skolem">pr</span> <span class="skolem">m</span> <span class="skolem">sf</span><span class="main">)</span> <span class="main">=</span> toList <span class="skolem">l</span> <span class="main">@</span> nodeToList <span class="skolem">nd</span> <span class="main">@</span> toList <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> split_point l_inv r_inv nd_inv
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A predicate on the elements of a monoid is called {\em monotone},
  iff, when it holds for some value $a$, it also holds for all values $a+b$:
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Split a finger tree by a monotone predicate on the annotations, using
    a given initial value. Intuitively, the elements are summed up from left to 
    right, and the split is done when the predicate first holds for the sum.
    The predicate must not hold for the initial value of the summation, and must
    hold for the sum of all elements.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">splitTree</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>monoid_add <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">splitTree</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> nsplitTree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span>n_unwrap <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-splitTree_invpres"><span class="command">lemma</span></span> splitTree_invpres<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span><span class="free">s</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init_ff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_tt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fmt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">nd</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    l1_nd_r1<span class="main">:</span> <span class="quoted"><span class="quoted">"nsplitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">nd</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nsplitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> 
    l0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="skolem">l1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> n_unwrap <span class="skolem">nd</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitTree_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> nsp <span class="main">=</span> nsplitTree_invpres<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">nd</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> gmft <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  ft_invar_def annot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms l1_nd_r1 l0 <span class="keyword1"><span class="command">have</span></span> 
    v1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">0</span> <span class="free">l</span> <span class="main">∧</span> is_measured_ftree <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">0</span> <span class="free">r</span> <span class="main">∧</span> is_measured_ftree <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_leveln_node <span class="main">0</span> <span class="skolem">nd</span>  <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nsp ft_invar_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ft_invar_def annot_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="FingerTree-splitTree_correct"><span class="command">lemma</span></span> splitTree_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span><span class="free">s</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">p</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">p</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init_ff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_tt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fmt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>toList <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>toList <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ft_invar <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">nd</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    l1_nd_r1<span class="main">:</span> <span class="quoted"><span class="quoted">"nsplitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">nd</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nsplitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> 
    l0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="skolem">l1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> n_unwrap <span class="skolem">nd</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitTree_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> nsp <span class="main">=</span> nsplitTree_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">nd</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> gmft <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  ft_invar_def annot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms l1_nd_r1 l0 <span class="keyword1"><span class="command">have</span></span> 
    v1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>toList <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>nodeToList <span class="skolem">nd</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>toList <span class="free">r</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmft <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span>gmft <span class="free">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gmn <span class="skolem">nd</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">0</span> <span class="free">l</span> <span class="main">∧</span> is_measured_ftree <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_leveln_ftree <span class="main">0</span> <span class="free">r</span> <span class="main">∧</span> is_measured_ftree <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_leveln_node <span class="main">0</span> <span class="skolem">nd</span>  <span class="main">∧</span> is_measured_node <span class="skolem">nd</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nsp ft_invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v1<span class="main">(</span>6<span class="main">)</span> l0<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
    ndea<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> Tip <span class="free">e</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">nd</span></span><span class="main">)</span>  <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> nd_list_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"nodeToList <span class="skolem">nd</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="quoted"><span class="quoted">"gmn <span class="skolem">nd</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>  
  <span class="keyword1"><span class="command">with</span></span> v1 <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>toList <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>toList <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ft_invar <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ft_invar_def annot_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-splitTree_correctE"><span class="command">lemma</span></span> splitTree_correctE<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"ft_invar <span class="main">(</span><span class="free">s</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">p</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">p</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init_ff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_tt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="free">e</span> <span class="free">a</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>toList <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>toList <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"ft_invar <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ft_invar <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> fmt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> splitTree_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span></span></span></span></span><span class="main">,</span> <span class="operator">OF</span> assms fmt<span class="main">]</span> fmt
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Folding›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">foldl_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Tip <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Node2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">foldl_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">foldl_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Node3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="free">foldl_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">foldl_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">foldl_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">foldl_digit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl_digit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">=</span> foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl_digit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">=</span> foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl_digit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span><span class="main">)</span> <span class="main">=</span> 
    foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl_digit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span> <span class="free"><span class="bound"><span class="entity">n4</span></span></span><span class="main">)</span> <span class="main">=</span> 
    foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n4</span></span></span>"</span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">foldr_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Node <span class="main">⇒</span> <span class="tfree">'s</span>  <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Tip <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> "</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Node2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free">foldr_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">foldr_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Node3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> 
    <span class="main">=</span> <span class="free">foldr_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">foldr_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">foldr_node</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">foldr_digit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr_digit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr_digit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">(</span>foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr_digit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
    foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">(</span>foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">(</span>foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr_digit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span> <span class="free"><span class="bound"><span class="entity">n4</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
    foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">(</span>foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">(</span>foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span> <span class="main">(</span>foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n4</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-foldl_node_correct"><span class="command">lemma</span></span> foldl_node_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"foldl_node <span class="free">f</span> <span class="free">σ</span> <span class="free">nd</span> <span class="main">=</span> List.foldl <span class="free">f</span> <span class="free">σ</span> <span class="main">(</span>nodeToList <span class="free">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">nd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToList_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-foldl_digit_correct"><span class="command">lemma</span></span> foldl_digit_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_digit <span class="free">f</span> <span class="free">σ</span> <span class="free">d</span> <span class="main">=</span> List.foldl <span class="free">f</span> <span class="free">σ</span> <span class="main">(</span>digitToList <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToList_def foldl_node_correct<span class="main">)</span>
  
<span class="keyword1" id="FingerTree-foldr_node_correct"><span class="command">lemma</span></span> foldr_node_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"foldr_node <span class="free">f</span> <span class="free">nd</span> <span class="free">σ</span> <span class="main">=</span> List.foldr <span class="free">f</span> <span class="main">(</span>nodeToList <span class="free">nd</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">nd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToList_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-foldr_digit_correct"><span class="command">lemma</span></span> foldr_digit_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr_digit <span class="free">f</span> <span class="free">d</span> <span class="free">σ</span> <span class="main">=</span> List.foldr <span class="free">f</span> <span class="main">(</span>digitToList <span class="free">d</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToList_def foldr_node_correct<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Fold from left"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">foldl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> Empty <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">nd</span></span></span><span class="main">)</span> <span class="main">=</span> foldl_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">nd</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    foldl_digit <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>foldl_digit <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span>"</span></span>

<span class="keyword1" id="FingerTree-foldl_correct"><span class="command">lemma</span></span> foldl_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl <span class="free">f</span> <span class="free">σ</span> <span class="free">t</span> <span class="main">=</span> List.foldl <span class="free">f</span> <span class="free">σ</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def foldl_node_correct foldl_digit_correct<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Fold from right"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">foldr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> Empty <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">nd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> foldr_node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">nd</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> 
    <span class="main">=</span> foldr_digit <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">(</span><span class="free">foldr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span>foldr_digit <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FingerTree-foldr_correct"><span class="command">lemma</span></span> foldr_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr <span class="free">f</span> <span class="free">t</span> <span class="free">σ</span> <span class="main">=</span> List.foldr <span class="free">f</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def foldr_node_correct foldr_digit_correct<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Number of elements"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">count_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> Node <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_node</span> <span class="main">(</span>Tip <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">count_node</span> <span class="main">(</span>Node2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_node</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free">count_node</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">count_node</span> <span class="main">(</span>Node3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_node</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free">count_node</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> <span class="free">count_node</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">count_digit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Digit <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_digit</span> <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> count_node <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">count_digit</span> <span class="main">(</span>Two <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> count_node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> count_node <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">count_digit</span> <span class="main">(</span>Three <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> count_node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> count_node <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> count_node <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">count_digit</span> <span class="main">(</span>Four <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> 
    <span class="main">=</span> count_node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> count_node <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> count_node <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> count_node <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="keyword1" id="FingerTree-count_node_correct"><span class="command">lemma</span></span> count_node_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"count_node <span class="free">n</span> <span class="main">=</span> length <span class="main">(</span>nodeToList <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodeToList_def count_node_def<span class="main">)</span>

<span class="keyword1" id="FingerTree-count_digit_correct"><span class="command">lemma</span></span> count_digit_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"count_digit <span class="free">d</span> <span class="main">=</span> length <span class="main">(</span>digitToList <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> digitToList_def count_digit_def count_node_correct<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">count</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">count</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">count</span> <span class="main">(</span>Single <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> count_node <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">count</span> <span class="main">(</span>Deep <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">sf</span></span></span><span class="main">)</span> <span class="main">=</span> count_digit <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="main">+</span> <span class="free">count</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> count_digit <span class="free"><span class="bound"><span class="entity">sf</span></span></span>"</span></span>

<span class="keyword1" id="FingerTree-count_correct"><span class="command">lemma</span></span> count_correct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"count <span class="free">t</span> <span class="main">=</span> length <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_def count_def 
                   count_digit_correct count_node_correct<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Expose finger tree functions as qualified names.
  Generate code equations *)</span>
<span class="keyword1"><span class="command">interpretation</span></span> FingerTreeStruc<span class="main">:</span> FingerTreeStruc_loc <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">(* Hide the concrete syntax *)</span>
<span class="keyword1"><span class="command">no_notation</span></span> FingerTreeStruc.lcons <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊲</span>"</span> 65<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> FingerTreeStruc.rcons <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊳</span>"</span> 65<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Hiding the invariant"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\label{sec:hide_invar}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we define the datatype of all FingerTrees that fulfill their
  invariant, and define the operations to work on this datatype.
  The advantage is, that the correctness lemmas do no longer contain 
  explicit invariant predicates, what makes them more handy to use.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Datatype"</span></span>
<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> FingerTree <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc<span class="main">.</span> FingerTreeStruc.ft_invar <span class="bound">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Empty <span class="main">∈</span> <span class="var">?FingerTree</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FingerTree-Rep_FingerTree_invar"><span class="command">lemma</span></span> Rep_FingerTree_invar<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FingerTreeStruc.ft_invar <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Rep_FingerTree <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"FingerTreeStruc.ft_invar <span class="free">t</span> <span class="main">⟹</span> Rep_FingerTree <span class="main">(</span>Abs_FingerTree <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_FingerTree_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstype</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_FingerTree <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_FingerTree_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> viewres <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">r</span><span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc<span class="main">)</span> option <span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> FingerTreeStruc.ft_invar <span class="bound">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">None</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstype</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_viewres <span class="main">(</span>Rep_viewres <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_viewres_inverse<span class="main">)</span>

<span class="keyword1" id="FingerTree-Abs_viewres_inverse_None"><span class="command">lemma</span></span> Abs_viewres_inverse_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Rep_viewres <span class="main">(</span>Abs_viewres None<span class="main">)</span> <span class="main">=</span> None"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_viewres_inverse<span class="main">)</span>

<span class="keyword1" id="FingerTree-Abs_viewres_inverse_Some"><span class="command">lemma</span></span> Abs_viewres_inverse_Some<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"FingerTreeStruc.ft_invar <span class="free">t</span> <span class="main">⟹</span> 
    Rep_viewres <span class="main">(</span>Abs_viewres <span class="main">(</span>Some <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_viewres_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extract_viewres_isNone</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> Rep_viewres <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extract_viewres_a</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> 
    <span class="keyword1">case</span> <span class="main">(</span>Rep_viewres <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_viewres_t</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> 
  <span class="keyword1">case</span> <span class="main">(</span>Rep_viewres <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Abs_FingerTree Empty 
                        <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> Abs_FingerTree <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>extract_viewres_t <span class="free">r</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>Rep_viewres <span class="free">r</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Empty <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split option.split_asm 
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_viewres_t_def Abs_viewres_inverse_Some<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_viewres</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> 
    <span class="keyword1">if</span> extract_viewres_isNone <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> None 
    <span class="keyword1">else</span> Some <span class="main">(</span>extract_viewres_a <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> extract_viewres_t <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> splitres <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> FingerTreeStruc <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> FingerTreeStruc<span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">.</span>
        FingerTreeStruc.ft_invar <span class="bound">l</span> <span class="main">∧</span> FingerTreeStruc.ft_invar <span class="bound">r</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>Empty<span class="main">,</span>undefined<span class="main">,</span>Empty<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstype</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_splitres <span class="main">(</span>Rep_splitres <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_splitres_inverse<span class="main">)</span>

<span class="keyword1" id="FingerTree-Abs_splitres_inverse"><span class="command">lemma</span></span> Abs_splitres_inverse<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"FingerTreeStruc.ft_invar <span class="free">r</span> <span class="main">⟹</span> FingerTreeStruc.ft_invar <span class="free">s</span> <span class="main">⟹</span> 
      Rep_splitres <span class="main">(</span>Abs_splitres <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_splitres_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extract_splitres_a</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> <span class="keyword1">case</span> <span class="main">(</span>Rep_splitres <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_splitres_l</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> <span class="keyword1">case</span> <span class="main">(</span>Rep_splitres <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> 
    Abs_FingerTree <span class="bound">l</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>extract_splitres_l <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> 
    <span class="main">(</span>Rep_splitres <span class="free">r</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split option.split_asm 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_splitres_l_def Abs_splitres_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_splitres_r</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> <span class="keyword1">case</span> <span class="main">(</span>Rep_splitres <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> 
    Abs_FingerTree <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>extract_splitres_r <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> 
  <span class="main">(</span>Rep_splitres <span class="free">r</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split option.split_asm 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_splitres_r_def Abs_splitres_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_splitres</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> 
  <span class="main">(</span>extract_splitres_l <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span>
  extract_splitres_a <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span>
  extract_splitres_r <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Definition of Operations"</span></span>
<span class="keyword1"><span class="command">locale</span></span> FingerTree_loc
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">toList</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> FingerTreeStruc.toList <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">==</span> Abs_FingerTree FingerTreeStruc.Empty"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_FingerTree empty <span class="main">=</span> FingerTreeStruc.Empty"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>

  <span class="keyword1" id="FingerTree-empty_rep"><span class="command">lemma</span></span> empty_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span>empty <span class="main">⟷</span> Rep_FingerTree <span class="free">t</span> <span class="main">=</span> Empty"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Rep_FingerTree_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">annot</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> FingerTreeStruc.annot <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toTree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> Abs_FingerTree <span class="main">(</span>FingerTreeStruc.toTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>toTree <span class="free">t</span><span class="main">)</span> <span class="main">=</span> FingerTreeStruc.toTree <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toTree_def<span class="main">)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lcons</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> 
    Abs_FingerTree <span class="main">(</span>FingerTreeStruc.lcons <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>lcons <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>FingerTreeStruc.lcons <span class="free">a</span> <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcons_def FingerTreeStruc.lcons_correct<span class="main">)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rcons</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">==</span> 
    Abs_FingerTree <span class="main">(</span>FingerTreeStruc.rcons <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>rcons <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>FingerTreeStruc.rcons <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rcons_def FingerTreeStruc.rcons_correct<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">viewL_aux</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> 
    Abs_viewres <span class="main">(</span>FingerTreeStruc.viewL <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">viewL</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> extract_viewres <span class="main">(</span>viewL_aux <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Rep_viewres <span class="main">(</span>viewL_aux <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>FingerTreeStruc.viewL <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FingerTreeStruc.viewL <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewL_aux_def <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="free">t</span> <span class="main">=</span> Empty"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> FingerTreeStruc.viewL_correct_nonEmpty
                 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="free">t</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_viewres_inverse_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">viewR_aux</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> 
    Abs_viewres <span class="main">(</span>FingerTreeStruc.viewR <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">viewR</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> extract_viewres <span class="main">(</span>viewR_aux <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Rep_viewres <span class="main">(</span>viewR_aux <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>FingerTreeStruc.viewR <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FingerTreeStruc.viewR <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viewR_aux_def <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="free">t</span> <span class="main">=</span> Empty"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> FingerTreeStruc.viewR_correct_nonEmpty
                <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="free">t</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_viewres_inverse_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">isEmpty</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> FingerTreeStruc.isEmpty <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">head</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> FingerTreeStruc.head <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tail</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">=</span>empty <span class="keyword1">then</span> 
      empty 
    <span class="keyword1">else</span> 
      Abs_FingerTree <span class="main">(</span>FingerTreeStruc.tail <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹Make function total, to allow abstraction›</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>tail <span class="free">t</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>FingerTreeStruc.isEmpty <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> Empty 
     <span class="keyword1">else</span> FingerTreeStruc.tail <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tail_def FingerTreeStruc.tail_correct FingerTreeStruc.isEmpty_def empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">headR</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> FingerTreeStruc.headR <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tailR</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">=</span>empty <span class="keyword1">then</span> 
      empty 
    <span class="keyword1">else</span> 
      Abs_FingerTree <span class="main">(</span>FingerTreeStruc.tailR <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>tailR <span class="free">t</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>FingerTreeStruc.isEmpty <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> Empty 
    <span class="keyword1">else</span> FingerTreeStruc.tailR <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tailR_def FingerTreeStruc.tailR_correct FingerTreeStruc.isEmpty_def empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Abs_FingerTree <span class="main">(</span>
    FingerTreeStruc.app <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Rep_FingerTree <span class="main">(</span>app <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> 
      FingerTreeStruc.app <span class="main">(</span>Rep_FingerTree <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_def FingerTreeStruc.app_correct<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">splitTree_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span>annot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
    Abs_splitres <span class="main">(</span>FingerTreeStruc.splitTree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span>
    Abs_splitres <span class="main">(</span>Empty<span class="main">,</span>undefined<span class="main">,</span>Empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">splitTree</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> extract_splitres <span class="main">(</span>splitTree_aux <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Rep_splitres <span class="main">(</span>splitTree_aux <span class="free">p</span> <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">¬</span><span class="free">p</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span>annot <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="main">(</span>FingerTreeStruc.splitTree <span class="free">p</span> <span class="free">i</span> <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span>Empty<span class="main">,</span>undefined<span class="main">,</span>Empty<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FingerTreeStruc.splitTree_invpres<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Rep_FingerTree <span class="free"><span class="free">t</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitTree_aux_def annot_def Abs_splitres_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"FingerTreeStruc.splitTree <span class="free">p</span> <span class="free">i</span> <span class="main">(</span>Rep_FingerTree <span class="free">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_FingerTree_inverse Abs_splitres_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">foldl</span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> FingerTreeStruc.foldl <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">foldr</span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">foldr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">==</span> FingerTreeStruc.foldr <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">count</span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">count</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> FingerTreeStruc.count <span class="main">(</span>Rep_FingerTree <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Correctness statements"</span></span>
  <span class="keyword1" id="FingerTree-empty_correct"><span class="command">lemma</span></span> empty_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">t</span><span class="main">=</span>empty"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.toList_empty<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-toList_of_empty"><span class="command">lemma</span></span> toList_of_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toList empty <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def empty_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.toList_empty<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-annot_correct"><span class="command">lemma</span></span> annot_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"annot <span class="free">t</span> <span class="main">=</span> sum_list <span class="main">(</span>map snd <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def annot_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.annot_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-toTree_correct"><span class="command">lemma</span></span> toTree_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>toTree <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def toTree_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.toTree_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-lcons_correct"><span class="command">lemma</span></span> lcons_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>lcons <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">#</span>toList <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def lcons_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.lcons_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-rcons_correct"><span class="command">lemma</span></span> rcons_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>rcons <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> toList <span class="free">t</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def rcons_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.rcons_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-viewL_correct"><span class="command">lemma</span></span> viewL_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> empty <span class="main">⟹</span> viewL <span class="free">t</span> <span class="main">=</span> None"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> empty <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> viewL <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> <span class="bound">a</span><span class="main">#</span>toList <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def viewL_def viewL_aux_def 
      extract_viewres_def extract_viewres_isNone_def 
      extract_viewres_a_def
      extract_viewres_t_def
      empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.viewL_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> FingerTreeStruc.viewL_correct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Rep_FingerTree_invar<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_viewres_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-viewL_empty"><span class="command">lemma</span></span> viewL_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"viewL empty <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> viewL_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="FingerTree-viewL_nonEmpty"><span class="command">lemma</span></span> viewL_nonEmpty<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≠</span>empty"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"viewL <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"toList <span class="free">t</span> <span class="main">=</span> <span class="free">a</span><span class="main">#</span>toList <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms viewL_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="FingerTree-viewR_correct"><span class="command">lemma</span></span> viewR_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> empty <span class="main">⟹</span> viewR <span class="free">t</span> <span class="main">=</span> None"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> empty <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> viewR <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> toList <span class="free">t</span> <span class="main">=</span> toList <span class="bound">s</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def viewR_def viewR_aux_def 
      extract_viewres_def extract_viewres_isNone_def 
      extract_viewres_a_def
      extract_viewres_t_def
      empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.viewR_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> FingerTreeStruc.viewR_correct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Rep_FingerTree_invar<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_viewres_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-viewR_empty"><span class="command">lemma</span></span> viewR_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"viewR empty <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> viewR_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="FingerTree-viewR_nonEmpty"><span class="command">lemma</span></span> viewR_nonEmpty<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≠</span>empty"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"viewR <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"toList <span class="free">t</span> <span class="main">=</span> toList <span class="free">s</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms viewR_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="FingerTree-isEmpty_correct"><span class="command">lemma</span></span> isEmpty_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"isEmpty <span class="free">t</span> <span class="main">⟷</span> <span class="free">t</span><span class="main">=</span>empty"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def isEmpty_def empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.isEmpty_correct FingerTreeStruc.toList_empty<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-head_correct"><span class="command">lemma</span></span> head_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≠</span>empty <span class="main">⟹</span> head <span class="free">t</span> <span class="main">=</span> hd <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def head_def empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.head_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-tail_correct"><span class="command">lemma</span></span> tail_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≠</span>empty <span class="main">⟹</span> toList <span class="main">(</span>tail <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def tail_def empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.tail_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-headR_correct"><span class="command">lemma</span></span> headR_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≠</span>empty <span class="main">⟹</span> headR <span class="free">t</span> <span class="main">=</span> last <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def headR_def empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.headR_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-tailR_correct"><span class="command">lemma</span></span> tailR_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≠</span>empty <span class="main">⟹</span> toList <span class="main">(</span>tailR <span class="free">t</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def tailR_def empty_rep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.tailR_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1" id="FingerTree-app_correct"><span class="command">lemma</span></span> app_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="main">(</span>app <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> toList <span class="free">s</span> <span class="main">@</span> toList <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def app_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.app_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-splitTree_correct"><span class="command">lemma</span></span> splitTree_correct<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">p</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">p</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> init_ff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> sum_tt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> fmt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>toList <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>toList <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>
      FingerTreeStruc.splitTree_correctE<span class="main"><span class="main">[</span></span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Rep_FingerTree <span class="free"><span class="free">s</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">OF</span> _ mono init_ff sum_tt<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> annot_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span>
      <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fmt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def splitTree_aux_def splitTree_def annot_def 
      extract_splitres_def extract_splitres_l_def 
      extract_splitres_a_def extract_splitres_r_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm prod.split_asm 
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_ff sum_tt<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> annot_def<span class="main"><span class="main">]</span></span> Abs_splitres_inverse<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>
      FingerTreeStruc.splitTree_correctE<span class="main"><span class="main">[</span></span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Rep_FingerTree <span class="free"><span class="free">s</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">OF</span> _ mono init_ff sum_tt<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> annot_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span>
      <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fmt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def splitTree_aux_def splitTree_def annot_def 
      extract_splitres_def extract_splitres_l_def 
      extract_splitres_a_def extract_splitres_r_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm prod.split_asm 
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_ff sum_tt<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> annot_def<span class="main"><span class="main">]</span></span> Abs_splitres_inverse<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>
      FingerTreeStruc.splitTree_correctE<span class="main"><span class="main">[</span></span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Rep_FingerTree <span class="free"><span class="free">s</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">OF</span> _ mono init_ff sum_tt<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> annot_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span>
      <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fmt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def splitTree_aux_def splitTree_def annot_def 
      extract_splitres_def extract_splitres_l_def 
      extract_splitres_a_def extract_splitres_r_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm prod.split_asm 
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_ff sum_tt<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> annot_def<span class="main"><span class="main">]</span></span> Abs_splitres_inverse<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-splitTree_correctE"><span class="command">lemma</span></span> splitTree_correctE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">p</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">p</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> init_ff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> sum_tt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="free">e</span> <span class="free">a</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>toList <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>toList <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>toList <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> annot <span class="free">l</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> fmt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splitTree <span class="free">p</span> <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> splitTree_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span><span class="main">,</span> <span class="operator">OF</span> assms fmt<span class="main">]</span> fmt
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="FingerTree-foldl_correct"><span class="command">lemma</span></span> foldl_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="free">f</span> <span class="free">σ</span> <span class="free">t</span> <span class="main">=</span> List.foldl <span class="free">f</span> <span class="free">σ</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def foldl_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.foldl_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-foldr_correct"><span class="command">lemma</span></span> foldr_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"foldr <span class="free">f</span> <span class="free">t</span> <span class="free">σ</span> <span class="main">=</span> List.foldr <span class="free">f</span> <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def foldr_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.foldr_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="FingerTree-count_correct"><span class="command">lemma</span></span> count_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="free">t</span> <span class="main">=</span> length <span class="main">(</span>toList <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> toList_def count_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FingerTreeStruc.count_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> FingerTree<span class="main">:</span> FingerTree_loc <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\clearpage›</span></span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Interface Documentation"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\label{sec:doc}›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    In this section, we list all supported operations on finger trees,
    along with a short plaintext documentation and their correctness statements.
›</span></span>

<span class="comment1">(*#DOC
  fun [no_spec] FingerTree.toList
    Convert to list ($O(n)$)

  fun FingerTree.empty
    The empty finger tree ($O(1)$)

  fun FingerTree.annot
    Return sum of all annotations ($O(1)$)

  fun FingerTree.toTree
    Convert list to finger tree ($O(n\log(n))$)

  fun FingerTree.lcons
    Append element at the left end ($O(\log(n))$, $O(1)$ amortized)

  fun FingerTree.rcons
    Append element at the right end ($O(\log(n))$, $O(1)$ amortized)

  fun FingerTree.viewL
    Detach leftmost element ($O(\log(n))$, $O(1)$ amortized)

  fun FingerTree.viewR
    Detach rightmost element ($O(\log(n))$, $O(1)$ amortized)

  fun FingerTree.isEmpty
    Check whether tree is empty ($O(1)$)

  fun FingerTree.head
    Get leftmost element of non-empty tree ($O(\log(n))$)

  fun FingerTree.tail
    Get all but leftmost element of non-empty tree ($O(\log(n))$)

  fun FingerTree.headR
    Get rightmost element of non-empty tree ($O(\log(n))$)

  fun FingerTree.tailR
    Get all but rightmost element of non-empty tree ($O(\log(n))$)

  fun FingerTree.app
    Concatenate two finger trees ($O(\log(m+n))$)

  fun [long_type] FingerTree.splitTree
    Split tree by a monotone predicate. ($O(\log(n))$)

    A predicate $p$ over the annotations is called monotone, iff, for all 
    annotations
    $a,b$ with $p(a)$, we have already $p(a+b)$.

    Splitting is done by specifying a monotone predicate $p$ that does not hold
    for the initial value $i$ of the summation, but holds for $i$ plus the sum
    of all annotations. The tree is then split at the position where $p$ starts to
    hold for the sum of all elements up to that position.

  fun [long_type] FingerTree.foldl
    Fold with function from left

  fun [long_type] FingerTree.foldr
    Fold with function from right

  fun FingerTree.count
    Return the number of elements

*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.toList"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\                                               
        Convert to list ($O(n)$)\\                                                               


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.empty"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        The empty finger tree ($O(1)$)\\         
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.empty_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.empty_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>   


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.annot"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Return sum of all annotations ($O(1)$)\\ 
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.annot_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.annot_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>   


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.toTree"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Convert list to finger tree ($O(n\log(n))$)\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.toTree_correct›</span></span></span></span>:  
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.toTree_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>     


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.lcons"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Append element at the left end ($O(\log(n))$, $O(1)$ amortized)\\                                                            
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.lcons_correct›</span></span></span></span>:                                                                                   
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.lcons_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>                                                                                      
                                                                                                                     
                                                                                                                     
    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.rcons"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\                                                                    
        Append element at the right end ($O(\log(n))$, $O(1)$ amortized)\\                                           
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.rcons_correct›</span></span></span></span>:                                                                   
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.rcons_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>                                                                      
                                                                                                                     
                                                                                                                     
    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.viewL"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\                                                                    
        Detach leftmost element ($O(\log(n))$, $O(1)$ amortized)\\                                                   
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.viewL_correct›</span></span></span></span>:                                                                   
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.viewL_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>                                                                      
                                                                                                                     

    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.viewR"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Detach rightmost element ($O(\log(n))$, $O(1)$ amortized)\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.viewR_correct›</span></span></span></span>:                 
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.viewR_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>                    


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.isEmpty"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Check whether tree is empty ($O(1)$)\\     
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.isEmpty_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.isEmpty_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>   


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.head"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Get leftmost element of non-empty tree ($O(\log(n))$)\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.head_correct›</span></span></span></span>:              
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.head_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>                 


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.tail"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Get all but leftmost element of non-empty tree ($O(\log(n))$)\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.tail_correct›</span></span></span></span>:                      
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.tail_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>                         


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.headR"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Get rightmost element of non-empty tree ($O(\log(n))$)\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.headR_correct›</span></span></span></span>:              
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.headR_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>                 


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.tailR"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Get all but rightmost element of non-empty tree ($O(\log(n))$)\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.tailR_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.tailR_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.app"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Concatenate two finger trees ($O(\log(m+n))$)\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.app_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.app_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"FingerTree.splitTree"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> [display] <span class="quoted"><span class="quoted">"FingerTree.splitTree"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
        Split tree by a monotone predicate. ($O(\log(n))$)

    A predicate $p$ over the annotations is called monotone, iff, for all
    annotations
    $a,b$ with $p(a)$, we have already $p(a+b)$.

    Splitting is done by specifying a monotone predicate $p$ that does not hold
    for the initial value $i$ of the summation, but holds for $i$ plus the sum
    of all annotations. The tree is then split at the position where $p$ starts to
    hold for the sum of all elements up to that position.\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.splitTree_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.splitTree_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"FingerTree.foldl"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> [display] <span class="quoted"><span class="quoted">"FingerTree.foldl"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
        Fold with function from left\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.foldl_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.foldl_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"FingerTree.foldr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> [display] <span class="quoted"><span class="quoted">"FingerTree.foldr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
        Fold with function from right\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.foldr_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.foldr_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>


    \underline{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"FingerTree.count"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}\\
        Return the number of elements\\
    {\bf Spec} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FingerTree.count_correct›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] "FingerTree.count_correct"<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Test">
<div class="head">
<h1>Theory Test</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Test
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span> <a href="FingerTree.html">FingerTree</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Test code generation, to early detect problems with code generator.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_toList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_toList</span> <span class="main">==</span> FingerTree.toList"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_toTree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_toTree</span> <span class="main">==</span> FingerTree.toTree"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_empty</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">==</span> FingerTree.empty"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_annot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_annot</span> <span class="main">==</span> FingerTree.annot"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_lcons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_lcons</span> <span class="main">==</span> FingerTree.lcons"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_rcons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_rcons</span> <span class="main">==</span> FingerTree.rcons"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_viewL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_viewL</span> <span class="main">==</span> FingerTree.viewL"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_viewR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_viewR</span> <span class="main">==</span> FingerTree.viewR"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_isEmpty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_isEmpty</span> <span class="main">==</span> FingerTree.isEmpty"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_head</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_head</span> <span class="main">==</span> FingerTree.head"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_tail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_tail</span> <span class="main">==</span> FingerTree.tail"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_headR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_headR</span> <span class="main">==</span> FingerTree.headR"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_tailR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_tailR</span> <span class="main">==</span> FingerTree.tailR"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_app</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_app</span> <span class="main">==</span> FingerTree.app"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_splitTree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_splitTree</span> <span class="main">==</span> FingerTree.splitTree"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_foldl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_foldl</span> <span class="main">==</span> FingerTree.foldl"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_foldr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_foldr</span> <span class="main">==</span> FingerTree.foldr"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fti_count</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span>nat<span class="main">)</span> FingerTree <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fti_count</span> <span class="main">==</span> FingerTree.count"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> 
  <span class="quoted"><span class="quoted">fti_toList</span></span>
  <span class="quoted"><span class="quoted">fti_toTree</span></span>
  <span class="quoted"><span class="quoted">fti_empty</span></span>
  <span class="quoted"><span class="quoted">fti_annot</span></span>
  <span class="quoted"><span class="quoted">fti_lcons</span></span>
  <span class="quoted"><span class="quoted">fti_rcons</span></span>
  <span class="quoted"><span class="quoted">fti_viewL</span></span>
  <span class="quoted"><span class="quoted">fti_viewR</span></span>
  <span class="quoted"><span class="quoted">fti_isEmpty</span></span>
  <span class="quoted"><span class="quoted">fti_head</span></span>
  <span class="quoted"><span class="quoted">fti_tail</span></span>
  <span class="quoted"><span class="quoted">fti_headR</span></span>
  <span class="quoted"><span class="quoted">fti_tailR</span></span>
  <span class="quoted"><span class="quoted">fti_app</span></span>
  <span class="quoted"><span class="quoted">fti_splitTree</span></span>
  <span class="quoted"><span class="quoted">fti_foldl</span></span>
  <span class="quoted"><span class="quoted">fti_foldr</span></span>
  <span class="quoted"><span class="quoted">fti_count</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> Haskell
  <span class="keyword2"><span class="keyword">in</span></span> OCaml
  <span class="keyword2"><span class="keyword">in</span></span> SML

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t1</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_toTree</span><span class="antiquote">}</span></span></span>
    <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"a"</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"b"</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"c"</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">3</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t2</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_toTree</span><span class="antiquote">}</span></span></span>
    <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"d"</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"e"</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"f"</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">3</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t3</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_app</span><span class="antiquote">}</span></span></span> <span class="entity">t1</span> <span class="entity">t2</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t3</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_app</span><span class="antiquote">}</span></span></span> <span class="entity">t3</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_empty</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t4</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_lcons</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="inner_quoted">"g"</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">7</span><span class="main">)</span> <span class="entity">t3</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t4</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_rcons</span><span class="antiquote">}</span></span></span> <span class="entity">t3</span> <span class="main">(</span><span class="inner_quoted">"g"</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">7</span><span class="main">)</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_toList</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_annot</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_viewL</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_viewR</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_head</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_tail</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_headR</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_tailR</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_count</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_isEmpty</span><span class="antiquote">}</span></span></span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_isEmpty</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_empty</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">tl</span><span class="main">,</span><span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">tr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_splitTree</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">a</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">integer_of_nat</span><span class="antiquote">}</span></span></span> <span class="entity">a</span> &gt;= <span class="inner_numeral">10</span><span class="main">)</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_toList</span><span class="antiquote">}</span></span></span> <span class="entity">tl</span><span class="main">;</span> <span class="entity">e</span><span class="main">;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_toList</span><span class="antiquote">}</span></span></span> <span class="entity">tr</span><span class="main">;</span>

  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_foldl</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">a</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">s</span> + <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">integer_of_nat</span><span class="antiquote">}</span></span></span> <span class="entity">a</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="entity">t4</span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fti_foldr</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">a</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span> + <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">integer_of_nat</span><span class="antiquote">}</span></span></span> <span class="entity">a</span><span class="main">)</span> <span class="entity">t4</span> <span class="inner_numeral">0</span><span class="main">;</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>